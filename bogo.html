<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>實名制登記與繳費系統</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 10px;
      }

      .container {
          max-width: 500px;
          margin: 0 auto;
          background: white;
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.2);
          overflow: hidden;
      }

      .header {
          background: linear-gradient(135deg, #4CAF50, #45a049);
          color: white;
          padding: 20px;
          text-align: center;
      }

      .header h1 {
          font-size: 24px;
          margin-bottom: 5px;
      }

      .header p {
          opacity: 0.9;
          font-size: 14px;
      }

      .content {
          padding: 20px;
      }

      .status-bar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #f8f9fa;
          padding: 10px 15px
          border-radius: 8px;
          margin-bottom: 20px;
          font-size: 12px;
      }

      .status-item {
          display: flex;
          align-items: center;
          gap: 5px;
      }

      .status-indicator {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background: #dc3545;
      }

      .status-indicator.success {
          background: #28a745;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #333;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
          width: 100%;
          padding: 12px;
          border: 2px solid #e9ecef;
          border-radius: 8px;
          font-size: 16px;
          transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
          outline: none;
          border-color: #4CAF50;
      }

      .btn {
          width: 100%;
          padding: 15px;
          background: linear-gradient(135deg, #4CAF50, #45a049);
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          margin-bottom: 10px;
      }

      .btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
      }

      .btn:disabled {
          background: #ccc;
          cursor: not-allowed;
          transform: none;
          box-shadow: none;
      }

      .btn-secondary {
          background: linear-gradient(135deg, #6c757d, #5a6268);
      }

      .btn-secondary:hover {
          box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
      }

      .upload-area {
          border: 2px dashed #ddd;
          border-radius: 8px;
          padding: 40px 20px;
          text-align: center;
          cursor: pointer;
          transition: all 0.3s;
          background: #fafafa;
      }

      .upload-area:hover {
          border-color: #4CAF50;
          background: #f0f8f0;
      }

      .upload-area.dragover {
          border-color: #4CAF50;
          background: #e8f5e8;
      }

      .upload-icon {
          font-size: 48px;
          margin-bottom: 10px;
      }

      .upload-area p {
          margin: 10px 0 5px 0;
          font-weight: 600;
          color: #333;
      }

      .upload-area small {
          color: #666;
          font-size: 12px;
      }

      .section {
          display: none;
          animation: fadeIn 0.5s ease-in;
      }

      .section.active {
          display: block;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .order-card {
          background: #f8f9fa;
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 15px;
          border-left: 4px solid #4CAF50;
      }

      .order-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
      }

      .order-id {
          font-weight: 600;
          color: #333;
      }

      .order-status {
          background: #4CAF50;
          color: white;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 12px;
      }

      .order-details {
          font-size: 14px;
          color: #666;
          line-height: 1.5;
      }

      .total-amount {
          background: #e3f2fd;
          padding: 15px;
          border-radius: 8px;
          text-align: center;
          margin: 20px 0;
      }

      .total-amount h3 {
          color: #1976d2;
          margin-bottom: 5px;
      }

      .total-amount .amount {
          font-size: 24px;
          font-weight: bold;
          color: #d32f2f;
      }

      .alert {
          padding: 12px 15px;
          border-radius: 8px;
          margin-bottom: 20px;
          font-size: 14px;
      }

      .alert-success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }

      .alert-error {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }

      .alert-info {
          background: #d1ecf1;
          color: #0c5460;
          border: 1px solid #bee5eb;
      }

      .loading {
          text-align: center;
          padding: 40px;
      }

      .loading::after {
          content: '';
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid #4CAF50;
          border-radius: 50%;
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .debug-info {
          background: #f8f9fa;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          padding: 15px;
          margin-top: 20px;
          font-family: monospace;
          font-size: 12px;
          max-height: 200px;
          overflow-y: auto;
      }

      .maintenance-mode {
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          background: #f5f5f5;
      }

      .maintenance-card {
          text-align: center;
          padding: 40px;
          background: white;
          border-radius: 10px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          max-width: 400px;
      }

      .maintenance-icon {
          font-size: 48px;
          margin-bottom: 20px;
      }

      .hidden {
          display: none !important;
      }

      @media (max-width: 480px) {
          .container {
              margin: 0;
              border-radius: 0;
              min-height: 100vh;
          }
          
          .content {
              padding: 15px;
          }
          
          .form-group input,
          .form-group select,
          .form-group textarea {
              font-size: 16px; /* 防止 iOS 縮放 */
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>🎫 實名制登記系統</h1>
          <p>請完成實名制登記後查看訂單</p>
      </div>

      <!-- 狀態列 -->
      <div class="content">
          <div class="status-bar">
              <div class="status-item">
                  <div class="status-indicator" id="apiIndicator"></div>
                  <span id="apiStatus">連線檢查中...</span>
              </div>
              <div class="status-item">
                  <div class="status-indicator" id="liffIndicator"></div>
                  <span id="liffStatus">LIFF 初始化中...</span>
              </div>
          </div>

          <!-- LIFF 環境資訊 -->
          <div id="liffInfo" class="alert alert-info hidden">
              <strong>LIFF 環境資訊：</strong>
              <div id="liffDetails"></div>
          </div>

          <!-- 載入中 -->
          <div id="loadingSection" class="section active">
              <div class="loading">
                  <p>系統初始化中，請稍候...</p>
              </div>
          </div>

          <!-- 實名制登記表單 -->
          <div id="registrationSection" class="section">
              <div class="alert alert-info">
                  <strong>📝 實名制登記</strong><br>
                  請填寫真實資料以完成登記，登記後即可查看您的訂單資訊。
              </div>

              <form id="registrationForm">
                  <div class="form-group">
                      <label for="lineName">LINE 顯示名稱</label>
                      <input type="text" id="lineName" readonly>
                  </div>

                  <div class="form-group">
                      <label for="realName">真實姓名 *</label>
                      <input type="text" id="realName" placeholder="請輸入真實姓名" required>
                  </div>

                  <div class="form-group">
                      <label for="idNumber">身分證字號 *</label>
                      <input type="text" id="idNumber" placeholder="例：A123456789" required maxlength="10">
                  </div>

                  <div class="form-group">
                      <label for="phoneNumber">手機號碼 *</label>
                      <input type="tel" id="phoneNumber" placeholder="例：0912345678" required maxlength="10">
                  </div>

                  <button type="submit" class="btn" id="registerBtn">
                      完成實名制登記
                  </button>
              </form>
          </div>

          <!-- 訂單列表 -->
          <div id="ordersSection" class="section">
              <div class="alert alert-success">
                  <strong>✅ 已完成實名制登記</strong><br>
                  <span id="userInfo"></span>
              </div>

              <div id="ordersContainer">
                  <!-- 訂單將動態載入到這裡 -->
              </div>

              <div class="total-amount">
                  <h3>總應繳金額</h3>
                  <div class="amount" id="totalAmount">NT$ 0</div>
              </div>

              <button class="btn" id="proceedToPaymentBtn">
                  前往繳費
              </button>

              <button class="btn btn-secondary" id="refreshOrdersBtn">
                  重新整理訂單
              </button>
          </div>

          <!-- 繳費證明上傳 -->
          <div id="paymentSection" class="section">
              <div class="alert alert-info">
                  <strong>💳 上傳繳費證明</strong><br>
                  請選擇繳費方式並上傳相關證明文件。
              </div>

              <form id="paymentForm">
                  <div class="form-group">
                      <label for="paymentMethod">繳費方式 *</label>
                      <select id="paymentMethod" required>
                          <option value="">請選擇繳費方式</option>
                          <!-- 選項將從系統設定動態載入 -->
                      </select>
                  </div>

                  <div class="form-group">
                      <label>上傳繳費證明</label>
                      <div class="upload-area" onclick="document.getElementById('paymentProof').click()">
                          <div class="upload-icon">📷</div>
                          <p>點擊上傳繳費證明照片</p>
                          <small>支援 JPG、PNG、PDF 格式，檔案大小限制 5MB</small>
                      </div>
                      <input type="file" id="paymentProof" accept="image/*,.pdf" style="display: none;" onchange="handleFileUpload(this)">
                  </div>

                  <div class="form-group" id="noteFieldGroup">
                      <label for="paymentNote">備註（選填）</label>
                      <textarea id="paymentNote" rows="3" placeholder="如有特殊說明請在此填寫..."></textarea>
                  </div>

                  <button type="button" class="btn" id="submitPaymentBtn" onclick="submitPayment()">
                      提交繳費證明
                  </button>

                  <button type="button" class="btn btn-secondary" id="backToOrdersBtn">
                      返回訂單列表
                  </button>
              </form>
          </div>

          <!-- 除錯資訊 -->
          <div id="debugInfo" class="debug-info hidden">
              <strong>🐛 除錯資訊：</strong>
              <div id="debugContent"></div>
          </div>
      </div>
  </div>

  <script>
      // ==================== 全域設定 ====================
      const CONFIG = {
          LIFF_ID: '1657285806-2bmkYWkN', // 請替換為您的 LIFF ID
          API_BASE_URL: 'https://script.google.com/macros/s/AKfycbx6bwe_nhDs27HFfj9O1AahWu_AL1RgzUMHt8tENXALHGmdCuHwUe3TvHurp0Mr9NrW/exec', // 請替換為您的 GAS 網址
          DEBUG_MODE: true, // 除錯模式，正式環境請設為 false
          DEMO_MODE: false // 示範模式，使用本地資料
      };

      // ==================== 全域變數 ====================
      let liffProfile = null;
      let systemConfig = null;
      let currentOrderSummary = null;
      let debugLogs = [];

      // ==================== 工具函數 ====================

      // 除錯日誌
      function debugLog(message, data = null) {
          const timestamp = new Date().toLocaleTimeString();
          const logEntry = `[${timestamp}] ${message}`;
          
          if (data) {
              console.log(logEntry, data);
              debugLogs.push({ timestamp, message, data });
          } else {
              console.log(logEntry);
              debugLogs.push({ timestamp, message });
          }
          
          updateDebugDisplay();
      }

      // 更新除錯顯示
      function updateDebugDisplay() {
          if (!CONFIG.DEBUG_MODE) return;
          
          const debugContent = document.getElementById('debugContent');
          if (debugContent) {
              const recentLogs = debugLogs.slice(-10); // 只顯示最近 10 條
              debugContent.innerHTML = recentLogs.map(log => {
                  let logText = `${log.timestamp} - ${log.message}`;
                  if (log.data) {
                      logText += `\n${JSON.stringify(log.data, null, 2)}`;
                  }
                  return logText;
              }).join('\n\n');
          }
      }

      // 顯示/隱藏區域
      function showSection(sectionId) {
          document.querySelectorAll('.section').forEach(section => {
              section.classList.remove('active');
          });
          document.getElementById(sectionId).classList.add('active');
          debugLog(`顯示區域: ${sectionId}`);
      }

      // 顯示成功訊息
      function showSuccess(message) {
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert alert-success';
          alertDiv.innerHTML = `<strong>✅ 成功！</strong><br>${message}`;
          
          const content = document.querySelector('.content');
          content.insertBefore(alertDiv, content.firstChild);
          
          setTimeout(() => {
              alertDiv.remove();
          }, 5000);
      }

      // 顯示錯誤訊息
      function showError(message) {
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert alert-error';
          alertDiv.innerHTML = `<strong>❌ 錯誤！</strong><br>${message}`;
          
          const content = document.querySelector('.content');
          content.insertBefore(alertDiv, content.firstChild);
          
          setTimeout(() => {
              alertDiv.remove();
          }, 8000);
      }

      // ==================== API 呼叫函數 ====================

      // 呼叫後端 API
      async function callAPI(action, data = {}) {
          try {
              debugLog(`API 呼叫: ${action}`, data);
              
              if (CONFIG.DEMO_MODE) {
                  return getDemoData(action, data);
              }
              
              const params = new URLSearchParams({
                  action: action,
                  data: JSON.stringify(data),
                  callback: 'handleAPIResponse',
                  _: Date.now()
              });
              
              return new Promise((resolve, reject) => {
                  window.handleAPIResponse = (response) => {
                      debugLog(`API 回應: ${action}`, response);
                      resolve(response);
                      delete window.handleAPIResponse;
                  };
                  
                  const script = document.createElement('script');
                  script.src = `${CONFIG.API_BASE_URL}?${params}`;
                  script.onerror = () => {
                      reject(new Error('API 呼叫失敗'));
                      delete window.handleAPIResponse;
                  };
                  
                  document.head.appendChild(script);
                  
                  setTimeout(() => {
                      document.head.removeChild(script);
                  }, 1000);
                  
                  setTimeout(() => {
                      if (window.handleAPIResponse) {
                          reject(new Error('API 呼叫逾時'));
                          delete window.handleAPIResponse;
                      }
                  }, 10000);
              });
              
          } catch (error) {
              debugLog(`API 呼叫失敗: ${action}`, error);
              throw error;
          }
      }

      // 示範資料（開發測試用）
      function getDemoData(action, data) {
          debugLog(`使用示範資料: ${action}`, data);
          
          switch (action) {
              case 'test':
                  return { success: true, message: 'API 連線測試成功（示範模式）' };
                  
              case 'get-config':
                  return {
                      success: true,
                      config: {
                          basic: {
                              'API連線狀態顯示': true,
                              '除錯資訊顯示': true,
                              'LIFF環境資訊顯示': true,
                              '繳費證明上傳': '必須',
                              '備註欄位顯示': true,
                              '系統維護模式': false,
                              '最大檔案大小MB': 5,
                              '允許檔案格式': ['jpg', 'png', 'pdf']
                          },
                          paymentMethods: [
                              { code: 'bank_transfer', name: '銀行轉帳', enabled: true },
                              { code: 'cash', name: '現金繳費', enabled: true },
                              { code: 'atm', name: 'ATM轉帳', enabled: true }
                          ],
                          messages: {
                              welcome_message: '歡迎使用本系統！',
                              upload_success: '繳費證明上傳成功！',
                              upload_error: '上傳失敗，請檢查檔案格式',
                              registration_success: '實名制登記完成！'
                          }
                      }
                  };
                  
              case 'check-registration':
                  return {
                      success: true,
                      registered: false
                  };
                  
              case 'register':
                  return {
                      success: true,
                      message: '實名制登記完成（示範模式）',
                      userData: {
                          lineName: data.lineName,
                          realName: data.realName,
                          idNumber: data.idNumber,
                          phoneNumber: data.phoneNumber,
                          registrationTime: new Date(),
                          status: '已登記'
                      }
                  };
                  
              case 'orders':
                  return {
                      success: true,
                      orders: [
                          {
                              orderId: 'ORDER001',
                              lineName: data.lineName,
                              realName: '示範用戶',
                              productName: '示範商品A',
                              quantity: 2,
                              unitPrice: 500,
                              totalPrice: 1000,
                              status: '待付款',
                              createdAt: new Date(),
                              note: '示範訂單'
                          },
                          {
                              orderId: 'ORDER002',
                              lineName: data.lineName,
                              realName: '示範用戶',
                              productName: '示範商品B',
                              quantity: 1,
                              unitPrice: 800,
                              totalPrice: 800,
                              status: '待付款',
                              createdAt: new Date(),
                              note: ''
                          }
                      ],
                      totalAmount: 1800,
                      userData: {
                          lineName: data.lineName,
                          realName: '示範用戶',
                          status: '已登記'
                      }
                  };
                  
              case 'submit-payment':
                  return {
                      success: true,
                      message: '繳費證明提交成功（示範模式）'
                  };
                  
              default:
                  return { success: false, message: '未知的示範操作' };
          }
      }

      // ==================== 系統設定管理 ====================

      // 載入系統設定
      async function loadSystemConfig() {
          try {
              debugLog('載入系統設定');
              
              const result = await callAPI('get-config', {});
              
              if (result.success) {
                  systemConfig = result.config;
                  debugLog('系統設定載入成功', systemConfig);
                  
                  // 套用系統設定
                  applySystemConfig();
                  
                  return true;
              } else {
                  debugLog('載入系統設定失敗', result);
                  // 使用預設設定
                  systemConfig = getDefaultFrontendConfig();
                  applySystemConfig();
                  return false;
              }
          } catch (error) {
              debugLog('載入系統設定失敗', error);
              console.error('載入系統設定失敗:', error);
              
              // 使用預設設定
              systemConfig = getDefaultFrontendConfig();
              applySystemConfig();
              return false;
          }
      }

      // 預設前端設定
      function getDefaultFrontendConfig() {
          return {
              basic: {
                  'API連線狀態顯示': true,
                  '除錯資訊顯示': false,
                  'LIFF環境資訊顯示': false,
                  '繳費證明上傳': '必須',
                  '備註欄位顯示': true,
                  '系統維護模式': false,
                  '最大檔案大小MB': 5,
                  '允許檔案格式': ['jpg', 'png', 'pdf']
              },
              paymentMethods: [
                  { code: 'bank_transfer', name: '銀行轉帳', enabled: true },
                  { code: 'cash', name: '現金繳費', enabled: true }
              ],
              messages: {
                  welcome_message: '歡迎使用本系統！',
                  upload_success: '繳費證明上傳成功！',
                  upload_error: '上傳失敗，請檢查檔案格式',
                  registration_success: '實名制登記完成！'
              }
          };
      }

      // 套用系統設定
      function applySystemConfig() {
          if (!systemConfig) return;
          
          const config = systemConfig.basic;
          
          // 控制 API 連線狀態顯示
          const statusBar = document.querySelector('.status-bar');
          if (statusBar) {
              statusBar.style.display = config['API連線狀態顯示'] ? 'flex' : 'none';
          }
          
          // 控制除錯資訊顯示
          CONFIG.DEBUG_MODE = config['除錯資訊顯示'];
          const debugInfo = document.getElementById('debugInfo');
          if (debugInfo) {
              debugInfo.classList.toggle('hidden', !CONFIG.DEBUG_MODE);
          }
          
          // 控制 LIFF 環境資訊顯示
          const liffInfo = document.getElementById('liffInfo');
          if (liffInfo) {
              liffInfo.classList.toggle('hidden', !config['LIFF環境資訊顯示']);
          }
          
          // 檢查系統維護模式
          if (config['系統維護模式']) {
              showMaintenanceMode();
              return;
          }
          
          // 更新繳費方式選項
          updatePaymentMethods();
          
          // 更新檔案上傳設定
          updateFileUploadSettings();
          
          // 更新備註欄位顯示
          updateNoteFieldVisibility();
          
          debugLog('系統設定已套用', config);
      }

      // 顯示維護模式
      function showMaintenanceMode() {
          const message = systemConfig.messages.maintenance_message || '系統維護中，請稍後再試';
          
          document.body.innerHTML = `
              <div class="maintenance-mode">
                  <div class="maintenance-card">
                      <div class="maintenance-icon">🔧</div>
                      <h2 style="color: #333; margin-bottom: 10px;">系統維護中</h2>
                      <p style="color: #666;">${message}</p>
                  </div>
              </div>
          `;
      }

      // 更新繳費方式選項
      function updatePaymentMethods() {
          const paymentMethodSelect = document.getElementById('paymentMethod');
          if (!paymentMethodSelect || !systemConfig.paymentMethods) return;
          
          // 保留第一個選項（請選擇）
          const firstOption = paymentMethodSelect.firstElementChild;
          paymentMethodSelect.innerHTML = '';
          paymentMethodSelect.appendChild(firstOption);
          
          // 新增系統設定的繳費方式
          systemConfig.paymentMethods.forEach(method => {
              const option = document.createElement('option');
              option.value = method.code;
              option.textContent = method.name;
              paymentMethodSelect.appendChild(option);
          });
          
          debugLog('繳費方式選項已更新', systemConfig.paymentMethods);
      }

      // 更新檔案上傳設定
      function updateFileUploadSettings() {
          const config = systemConfig.basic;
          const paymentProofInput = document.getElementById('paymentProof');
          const uploadArea = document.querySelector('.upload-area');
          
          if (!paymentProofInput || !uploadArea) return;
          
          // 設定是否必須上傳
          const isRequired = config['繳費證明上傳'] === '必須';
          
          if (!isRequired) {
              // 如果不是必須，更新標籤文字
              const uploadText = uploadArea.querySelector('p');
              if (uploadText) {
                  uploadText.textContent = '點擊上傳繳費證明照片（選填）';
              }
          }
          
          // 設定允許的檔案格式
          const allowedFormats = config['允許檔案格式'];
          if (allowedFormats && Array.isArray(allowedFormats)) {
              const acceptString = allowedFormats.map(format => {
                  if (format === 'jpg') return 'image/jpeg';
                  if (format === 'png') return 'image/png';
                  if (format === 'pdf') return 'application/pdf';
                  return `image/${format}`;
              }).join(',');
              
              paymentProofInput.setAttribute('accept', acceptString);
              
              // 更新提示文字
              const uploadText = uploadArea.querySelector('small');
              if (uploadText) {
                  uploadText.textContent = `支援 ${allowedFormats.join(', ').toUpperCase()} 格式，檔案大小限制 ${config['最大檔案大小MB'] || 5}MB`;
              }
          }
          
          // 設定檔案大小限制
          const maxSizeMB = config['最大檔案大小MB'] || 5;
          paymentProofInput.setAttribute('data-max-size', maxSizeMB * 1024 * 1024);
          
          debugLog('檔案上傳設定已更新', {
              required: isRequired,
              formats: allowedFormats,
              maxSize: maxSizeMB
          });
      }

      // 更新備註欄位顯示
      function updateNoteFieldVisibility() {
          const noteFieldGroup = document.getElementById('noteFieldGroup');
          
          if (noteFieldGroup) {
              const showNote = systemConfig.basic['備註欄位顯示'];
              noteFieldGroup.style.display = showNote ? 'block' : 'none';
          }
      }

      // ==================== LIFF 相關函數 ====================

      // 初始化 LIFF
      async function initializeLiff() {
          try {
              debugLog('開始初始化 LIFF');
              
              // 先載入系統設定
              await loadSystemConfig();
              
              // 檢查系統維護模式
              if (systemConfig?.basic?.['系統維護模式']) {
                  return; // 維護模式下不繼續初始化
              }
              
              // 更新 LIFF 狀態
              updateLiffStatus('初始化中...', false);
              
              if (typeof liff === 'undefined') {
                  throw new Error('LIFF SDK 未載入');
              }
              
              await liff.init({ liffId: CONFIG.LIFF_ID });
              debugLog('LIFF 初始化成功');
              
              // 檢查登入狀態
              if (liff.isLoggedIn()) {
                  debugLog('用戶已登入 LINE');
                  
                  // 取得用戶資料
                  liffProfile = await liff.getProfile();
                  debugLog('取得用戶資料', liffProfile);
                  
                  // 顯示 LIFF 環境資訊
                  displayLiffInfo();
                  
                  // 填入 LINE 名稱
                  document.getElementById('lineName').value = liffProfile.displayName;
                  
                  // 檢查用戶登記狀態
                  await checkRegistrationStatus();
                  
                  updateLiffStatus('已連線', true);
              } else {
                  debugLog('用戶未登入，導向登入頁面');
                  liff.login();
              }
              
          } catch (error) {
              debugLog('LIFF 初始化失敗', error);
              console.error('LIFF 初始化失敗:', error);
              updateLiffStatus('連線失敗', false);
              showError('系統初始化失敗，請重新整理頁面');
              
              // 如果是開發模式，使用示範資料
              if (CONFIG.DEMO_MODE) {
                  liffProfile = { displayName: '示範用戶', userId: 'demo123' };
                  document.getElementById('lineName').value = liffProfile.displayName;
                  await checkRegistrationStatus();
              }
          }
      }

      // 顯示 LIFF 環境資訊
      function displayLiffInfo() {
          if (!systemConfig?.basic?.['LIFF環境資訊顯示']) return;
          
          const liffDetails = document.getElementById('liffDetails');
          if (liffDetails && liffProfile) {
              liffDetails.innerHTML = `
                  <div>用戶ID: ${liffProfile.userId}</div>
                  <div>顯示名稱: ${liffProfile.displayName}</div>
                  <div>環境: ${liff.getOS()}</div>
                  <div>版本: ${liff.getVersion()}</div>
              `;
              document.getElementById('liffInfo').classList.remove('hidden');
          }
      }

      // 更新 LIFF 狀態
      function updateLiffStatus(message, success) {
          const liffIndicator = document.getElementById('liffIndicator');
          const liffStatus = document.getElementById('liffStatus');
          
          if (liffIndicator && liffStatus) {
              liffIndicator.className = `status-indicator ${success ? 'success' : ''}`;
              liffStatus.textContent = message;
          }
      }

      // ==================== API 狀態檢查 ====================

      // 檢查 API 連線狀態
      async function checkAPIStatus() {
          try {
              debugLog('檢查 API 連線狀態');
              updateAPIStatus('檢查中...', false);
              
              const result = await callAPI('test');
              
              if (result.success) {
                  debugLog('API 連線正常', result);
                  updateAPIStatus('連線正常', true);
                  return true;
              } else {
                  debugLog('API 連線異常', result);
                  updateAPIStatus('連線異常', false);
                  return false;
              }
          } catch (error) {
              debugLog('API 連線檢查失敗', error);
              updateAPIStatus('連線失敗', false);
              return false;
          }
      }

      // 更新 API 狀態
      function updateAPIStatus(message, success) {
          const apiIndicator = document.getElementById('apiIndicator');
          const apiStatus = document.getElementById('apiStatus');
          
          if (apiIndicator && apiStatus) {
              apiIndicator.className = `status-indicator ${success ? 'success' : ''}`;
              apiStatus.textContent = message;
          }
      }

      // ==================== 用戶登記相關函數 ====================

      // 檢查用戶登記狀態
      async function checkRegistrationStatus() {
          try {
              debugLog('檢查用戶登記狀態');
              
              if (!liffProfile) {
                  showError('無法取得用戶資料');
                  return;
              }
              
              const result = await callAPI('check-registration', {
                  lineName: liffProfile.displayName
              });
              
              if (result.success) {
                  if (result.registered) {
                      debugLog('用戶已完成登記', result.userData);
                      // 載入訂單資料
                      await loadUserOrders();
                  } else {
                      debugLog('用戶尚未登記');
                      showSection('registrationSection');
                  }
              } else {
                  debugLog('檢查登記狀態失敗', result);
                  showError(result.message || '檢查登記狀態失敗');
              }
              
          } catch (error) {
              debugLog('檢查登記狀態失敗', error);
              console.error('檢查登記狀態失敗:', error);
              showError('檢查登記狀態失敗，請稍後再試');
          }
      }

      // 處理登記表單提交
      async function handleRegistration(event) {
          event.preventDefault();
          
          try {
              debugLog('處理用戶登記');
              
              const formData = {
                  lineName: document.getElementById('lineName').value,
                  realName: document.getElementById('realName').value,
                  idNumber: document.getElementById('idNumber').value.toUpperCase(),
                  phoneNumber: document.getElementById('phoneNumber').value
              };
              
              // 前端驗證
              if (!formData.realName || !formData.idNumber || !formData.phoneNumber) {
                  showError('請填寫所有必要欄位');
                  return;
              }
              
              // 身分證字號格式驗證
              const idPattern = /^[A-Z][12]\d{8}$/;
              if (!idPattern.test(formData.idNumber)) {
                  showError('身分證字號格式不正確');
                  return;
              }
              
              // 電話號碼格式驗證
              const phonePattern = /^09\d{8}$/;
              if (!phonePattern.test(formData.phoneNumber)) {
                  showError('電話號碼格式不正確（請輸入09開頭的手機號碼）');
                  return;
              }
              
              // 顯示載入狀態
              const submitBtn = document.getElementById('registerBtn');
              const originalText = submitBtn.textContent;
              submitBtn.textContent = '登記中...';
              submitBtn.disabled = true;
              
              const result = await callAPI('register', formData);
              
              if (result.success) {
                  debugLog('用戶登記成功', result);
                  const successMessage = systemConfig?.messages?.registration_success || '實名制登記完成！';
                  showSuccess(successMessage);
                  
                  // 載入訂單資料
                  setTimeout(async () => {
                      await loadUserOrders();
                  }, 1500);
              } else {
                  debugLog('用戶登記失敗', result);
                  showError(result.message || '登記失敗，請稍後再試');
                  submitBtn.textContent = originalText;
                  submitBtn.disabled = false;
              }
              
          } catch (error) {
              debugLog('用戶登記失敗', error);
              console.error('用戶登記失敗:', error);
              showError('登記失敗，請稍後再試');
              
              const submitBtn = document.getElementById('registerBtn');
              if (submitBtn) {
                  submitBtn.textContent = '完成實名制登記';
                  submitBtn.disabled = false;
              }
          }
      }

      // ==================== 訂單相關函數 ====================

      // 載入用戶訂單
      async function loadUserOrders() {
          try {
              debugLog('載入用戶訂單');
              
              if (!liffProfile) {
                  showError('無法取得用戶資料');
                  return;
              }
              
              const result = await callAPI('orders', {
                  lineName: liffProfile.displayName
              });
              
              if (result.success) {
                  debugLog('訂單載入成功', result);
                  
                  // 顯示用戶資訊
                  const userInfo = document.getElementById('userInfo');
                  if (userInfo && result.userData) {
                      userInfo.textContent = `姓名：${result.userData.realName} | 登記時間：${new Date(result.userData.registrationTime).toLocaleString()}`;
                  }
                  
                  // 顯示訂單列表
                  displayOrders(result.orders, result.totalAmount);
                  
                  // 儲存訂單摘要供繳費使用
                  currentOrderSummary = {
                      orders: result.orders,
                      totalAmount: result.totalAmount,
                      userData: result.userData,
                      lineName: liffProfile.displayName,
                      realName: result.userData.realName,
                      orderId: result.orders.map(o => o.orderId).join(',')
                  };
                  
                  showSection('ordersSection');
              } else {
                  debugLog('載入訂單失敗', result);
                  if (result.needRegistration) {
                      showSection('registrationSection');
                  } else {
                      showError(result.message || '載入訂單失敗');
                  }
              }
              
          } catch (error) {
              debugLog('載入訂單失敗', error);
              console.error('載入訂單失敗:', error);
              showError('載入訂單失敗，請稍後再試');
          }
      }

      // 顯示訂單列表
      function displayOrders(orders, totalAmount) {
          const container = document.getElementById('ordersContainer');
          const totalAmountElement = document.getElementById('totalAmount');
          
          if (!container || !totalAmountElement) return;
          
          if (orders.length === 0) {
              container.innerHTML = `
                  <div class="alert alert-info">
                      <strong>📋 暫無訂單</strong><br>
                      目前沒有找到您的訂單資料。
                  </div>
              `;
              totalAmountElement.textContent = 'NT$ 0';
              return;
          }
          
          container.innerHTML = orders.map(order => `
              <div class="order-card">
                  <div class="order-header">
                      <div class="order-id">訂單 ${order.orderId}</div>
                      <div class="order-status">${order.status}</div>
                  </div>
                  <div class="order-details">
                      <div><strong>${order.productName}</strong></div>
                      <div>數量：${order.quantity} | 單價：NT$ ${order.unitPrice}</div>
                      <div>小計：NT$ ${order.totalPrice}</div>
                      ${order.note ? `<div>備註：${order.note}</div>` : ''}
                      <div style="font-size: 12px; color: #999; margin-top: 5px;">
                          建立時間：${new Date(order.createdAt).toLocaleString()}
                      </div>
                  </div>
              </div>
          `).join('');
          
          totalAmountElement.textContent = `NT$ ${totalAmount.toLocaleString()}`;
      }

      // ==================== 繳費相關函數 ====================

      // 處理檔案上傳
      function handleFileUpload(input) {
          const file = input.files[0];
          if (!file) return;
          
          const config = systemConfig?.basic || {};
          const maxSizeMB = config['最大檔案大小MB'] || 5;
          const maxSizeBytes = maxSizeMB * 1024 * 1024;
          const allowedFormats = config['允許檔案格式'] || ['jpg', 'png', 'pdf'];
          
          // 檢查檔案大小
          if (file.size > maxSizeBytes) {
              showError(`檔案大小超過限制（最大 ${maxSizeMB}MB）`);
              input.value = '';
              return;
          }
          
          // 檢查檔案格式
          const fileExtension = file.name.split('.').pop().toLowerCase();
          if (!allowedFormats.includes(fileExtension)) {
              showError(`不支援的檔案格式，請使用：${allowedFormats.join(', ').toUpperCase()}`);
              input.value = '';
              return;
          }
          
          debugLog('檔案驗證通過', { 
              name: file.name, 
              size: file.size, 
              type: file.type,
              extension: fileExtension
          });
          
          const uploadArea = document.querySelector('.upload-area');
          uploadArea.innerHTML = `
              <div class="upload-icon">✅</div>
              <p>已選擇: ${file.name}</p>
              <small>檔案大小: ${(file.size / 1024 / 1024).toFixed(2)} MB</small>
          `;
          uploadArea.style.background = '#d4edda';
      }

      // 提交繳費證明
      async function submitPayment() {
          debugLog('提交繳費證明');
          
          if (!currentOrderSummary) {
              showError('無法取得訂單資訊，請重新載入');
              return;
          }
          
          const paymentMethod = document.getElementById('paymentMethod').value;
          const paymentNote = document.getElementById('paymentNote').value;
          const paymentProof = document.getElementById('paymentProof').files[0];
          
          // 檢查必填欄位
          if (!paymentMethod) {
              showError('請選擇繳費方式');
              return;
          }
          
          // 檢查是否必須上傳檔案
          const isFileRequired = systemConfig?.basic?.['繳費證明上傳'] === '必須';
          
          if (isFileRequired && !paymentProof) {
              showError('請上傳繳費證明');
              return;
          }
          
          const paymentData = {
              orderId: currentOrderSummary.orderId,
              lineName: currentOrderSummary.lineName,
              realName: currentOrderSummary.realName,
              paymentAmount: currentOrderSummary.totalAmount,
              paymentMethod: paymentMethod,
              paymentNote: paymentNote,
              hasProof: !!paymentProof,
              submittedAt: new Date().toISOString()
          };
          
          try {
              // 顯示載入狀態
              const submitBtn = document.getElementById('submitPaymentBtn');
              const originalText = submitBtn.textContent;
              submitBtn.textContent = '提交中...';
              submitBtn.disabled = true;
              
              const result = await callAPI('submit-payment', paymentData);
              
              if (result.success) {
                  debugLog('繳費證明提交成功');
                  const successMessage = systemConfig?.messages?.upload_success || '繳費證明提交成功！';
                  showSuccess(successMessage);
                  
                  // 清空表單
                  document.getElementById('paymentNote').value = '';
                  document.getElementById('paymentProof').value = '';
                  document.getElementById('paymentMethod').selectedIndex = 0;
                  
                  // 重置上傳區域
                  const uploadArea = document.querySelector('.upload-area');
                  uploadArea.innerHTML = `
                      <div class="upload-icon">📷</div>
                      <p>點擊上傳繳費證明照片</p>
                      <small>支援格式請參考系統設定</small>
                  `;
                  uploadArea.style.background = '';
                  
                  submitBtn.textContent = '已提交';
                  submitBtn.disabled = true;
              } else {
                  debugLog('繳費證明提交失敗', result);
                  const errorMessage = result.message || systemConfig?.messages?.upload_error || '提交失敗，請稍後再試';
                  showError(errorMessage);
                  submitBtn.textContent = originalText;
                  submitBtn.disabled = false;
              }
          } catch (error) {
              debugLog('繳費證明提交失敗', error);
              console.error('提交繳費證明失敗:', error);
              const errorMessage = systemConfig?.messages?.upload_error || '提交失敗，請稍後再試';
              showError(errorMessage + ': ' + error.message);
              
              const submitBtn = document.getElementById('submitPaymentBtn');
              if (submitBtn) {
                  submitBtn.textContent = '提交繳費證明';
                  submitBtn.disabled = false;
              }
          }
      }

      // ==================== 事件處理 ====================

      // 頁面載入完成後初始化
      document.addEventListener('DOMContentLoaded', async function() {
          debugLog('頁面載入完成，開始初始化');
          
          // 檢查 API 連線狀態
          await checkAPIStatus();
          
          // 初始化 LIFF
          await initializeLiff();
          
          // 綁定事件處理器
          setupEventHandlers();
      });

      // 設定事件處理器
      function setupEventHandlers() {
          // 實名制登記表單
          const registrationForm = document.getElementById('registrationForm');
          if (registrationForm) {
              registrationForm.addEventListener('submit', handleRegistration);
          }
          
          // 前往繳費按鈕
          const proceedToPaymentBtn = document.getElementById('proceedToPaymentBtn');
          if (proceedToPaymentBtn) {
              proceedToPaymentBtn.addEventListener('click', () => {
                  showSection('paymentSection');
              });
          }
          
          // 重新整理訂單按鈕
          const refreshOrdersBtn = document.getElementById('refreshOrdersBtn');
          if (refreshOrdersBtn) {
              refreshOrdersBtn.addEventListener('click', loadUserOrders);
          }
          
          // 返回訂單列表按鈕
          const backToOrdersBtn = document.getElementById('backToOrdersBtn');
          if (backToOrdersBtn) {
              backToOrdersBtn.addEventListener('click', () => {
                  showSection('ordersSection');
              });
          }
          
          // 檔案拖放處理
          const uploadArea = document.querySelector('.upload-area');
          if (uploadArea) {
              uploadArea.addEventListener('dragover', (e) => {
                  e.preventDefault();
                  uploadArea.classList.add('dragover');
              });
              
              uploadArea.addEventListener('dragleave', () => {
                  uploadArea.classList.remove('dragover');
              });
              
              uploadArea.addEventListener('drop', (e) => {
                  e.preventDefault();
                  uploadArea.classList.remove('dragover');
                  
                  const files = e.dataTransfer.files;
                  if (files.length > 0) {
                      const paymentProofInput = document.getElementById('paymentProof');
                      paymentProofInput.files = files;
                      handleFileUpload(paymentProofInput);
                  }
              });
          }
          
          debugLog('事件處理器設定完成');
      }

      // ==================== 全域錯誤處理 ====================

      // 全域錯誤處理
      window.addEventListener('error', function(event) {
          debugLog('全域錯誤', {
              message: event.message,
              filename: event.filename,
              lineno: event.lineno,
              colno: event.colno,
              error: event.error
          });
          
          console.error('全域錯誤:', event.error);
      });

      // 未處理的 Promise 拒絕
      window.addEventListener('unhandledrejection', function(event) {
          debugLog('未處理的 Promise 拒絕', event.reason);
          console.error('未處理的 Promise 拒絕:', event.reason);
      });

      // 前端檢查管理員權限
    async function checkFrontendAdminPermission(requiredRole = 'viewer') {
    try {
      if (!liffProfile) {
        return { success: false, message: '請先登入 LINE' };
      }
      
      const result = await callAPI('check-admin', {
        userId: liffProfile.userId,
        requiredRole: requiredRole
      });
      
      return result;
      
    } catch (error) {
      debugLog('檢查前端管理員權限失敗', error);
      return { success: false, message: '權限檢查失敗' };
    }
    }

    // 顯示管理員面板
    async function showAdminPanel() {
    try {
      const permissionCheck = await checkFrontendAdminPermission('moderator');
      
      if (!permissionCheck.success) {
        showError(permissionCheck.message);
        return;
      }
      
      debugLog('顯示管理員面板', permissionCheck);
      
      // 建立管理員面板 HTML
      const adminPanelHTML = `
        <div id="adminPanel" class="section active">
          <div class="alert alert-info">
            <strong>🛠️ 管理員面板</strong><br>
            歡迎，${permissionCheck.adminData.name}（${permissionCheck.role}）
          </div>
          
          <div class="form-group">
            <button class="btn" onclick="showAdminList()">管理員名單</button>
            ${permissionCheck.role === 'admin' ? '<button class="btn" onclick="showAddAdminForm()">新增管理員</button>' : ''}
            <button class="btn" onclick="showUserManagement()">用戶管理</button>
            <button class="btn" onclick="showPaymentManagement()">繳費管理</button>
          </div>
          
          <div id="adminContent">
            <!-- 管理員內容將載入到這裡 -->
          </div>
          
          <button class="btn btn-secondary" onclick="backToMainSystem()">返回主系統</button>
        </div>
      `;
      
      // 插入管理員面板
      const container = document.querySelector('.content');
      container.insertAdjacentHTML('beforeend', adminPanelHTML);
      
      showSection('adminPanel');
      
    } catch (error) {
      debugLog('顯示管理員面板失敗', error);
      showError('載入管理員面板失敗');
    }
    }

    // 顯示管理員名單
    async function showAdminList() {
    try {
      const result = await callAPI('get-admin-list', {
        userId: liffProfile.userId
      });
      
      if (!result.success) {
        showError(result.message);
        return;
      }
      
      const adminContent = document.getElementById('adminContent');
      
      const adminListHTML = `
        <div class="alert alert-success">
          <strong>👥 管理員名單</strong>
        </div>
        
        <div class="admin-list">
          ${result.admins.map(admin => `
            <div class="order-card">
              <div class="order-header">
                <div class="order-id">${admin.name}</div>
                <div class="order-status">${admin.role}</div>
              </div>
              <div class="order-details">
                <div>LINE ID: ${admin.lineId}</div>
                ${result.requestUserRole === 'admin' && admin.lineId !== liffProfile.userId ? `
                  <div style="margin-top: 10px;">
                    <button class="btn" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;" 
                            onclick="changeAdminRole('${admin.lineId}', '${admin.name}')">
                      修改權限
                    </button>
                    <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #dc3545;" 
                            onclick="removeAdminConfirm('${admin.lineId}', '${admin.name}')">
                      移除
                    </button>
                  </div>
                ` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      adminContent.innerHTML = adminListHTML;
      
    } catch (error) {
      debugLog('顯示管理員名單失敗', error);
      showError('載入管理員名單失敗');
    }
    }

    // 顯示新增管理員表單
    function showAddAdminForm() {
    const adminContent = document.getElementById('adminContent');

    const addAdminFormHTML = `
      <div class="alert alert-info">
        <strong>➕ 新增管理員</strong>
      </div>
      
      <form id="addAdminForm" onsubmit="handleAddAdmin(event)">
        <div class="form-group">
          <label for="newAdminLineId">管理員 LINE ID *</label>
          <input type="text" id="newAdminLineId" placeholder="例：U1234567890abcdef" required>
          <small>請讓新管理員在 LIFF 程式中查看自己的 LINE ID</small>
        </div>
        
        <div class="form-group">
          <label for="newAdminName">管理員姓名 *</label>
          <input type="text" id="newAdminName" placeholder="請輸入姓名" required>
        </div>
        
        <div class="form-group">
          <label for="newAdminRole">權限等級 *</label>
          <select id="newAdminRole" required>
            <option value="">請選擇權限等級</option>
            <option value="admin">admin - 系統管理員</option>
            <option value="moderator">moderator - 版主</option>
            <option value="viewer">viewer - 檢視者</option>
          </select>
        </div>
        
        <button type="submit" class="btn">新增管理員</button>
      </form>
    `;

    adminContent.innerHTML = addAdminFormHTML;
    }

    // 處理新增管理員
    async function handleAddAdmin(event) {
    event.preventDefault();

    try {
      const newAdminData = {
        lineId: document.getElementById('newAdminLineId').value.trim(),
        name: document.getElementById('newAdminName').value.trim(),
        role: document.getElementById('newAdminRole').value
      };
      
      if (!newAdminData.lineId || !newAdminData.name || !newAdminData.role) {
        showError('請填寫所有必要欄位');
        return;
      }
      
      const result = await callAPI('add-admin', {
        requestUserId: liffProfile.userId,
        newAdminData: newAdminData
      });
      
      if (result.success) {
        showSuccess(result.message);
        showAdminList(); // 重新載入管理員名單
      } else {
        showError(result.message);
      }
      
    } catch (error) {
      debugLog('新增管理員失敗', error);
      showError('新增管理員失敗');
    }
    }

    // 確認移除管理員
    function removeAdminConfirm(lineId, name) {
    if (confirm(`確定要移除管理員「${name}」嗎？`)) {
      removeAdminAction(lineId);
    }
    }

    // 執行移除管理員
    async function removeAdminAction(lineId) {
    try {
      const result = await callAPI('remove-admin', {
        requestUserId: liffProfile.userId,
        targetLineId: lineId
      });
      
      if (result.success) {
        showSuccess(result.message);
        showAdminList(); // 重新載入管理員名單
      } else {
        showError(result.message);
      }
      
    } catch (error) {
      debugLog('移除管理員失敗', error);
      showError('移除管理員失敗');
    }
    }

    // 修改管理員權限
    function changeAdminRole(lineId, name) {
    const newRole = prompt(`請輸入「${name}」的新權限等級：\n\nadmin - 系統管理員\nmoderator - 版主\nviewer - 檢視者`, '');

    if (newRole && ['admin', 'moderator', 'viewer'].includes(newRole)) {
      updateAdminRoleAction(lineId, newRole);
    } else if (newRole) {
      showError('無效的權限等級');
    }
    }

    // 執行權限修改
    async function updateAdminRoleAction(lineId, newRole) {
    try {
      const result = await callAPI('update-admin-role', {
        requestUserId: liffProfile.userId,
        targetLineId: lineId,
        newRole: newRole
      });
      
      if (result.success) {
        showSuccess(result.message);
        showAdminList(); // 重新載入管理員名單
      } else {
        showError(result.message);
      }
      
    } catch (error) {
      debugLog('更新管理員權限失敗', error);
      showError('更新管理員權限失敗');
    }
    }

    // 返回主系統
    function backToMainSystem() {
    const adminPanel = document.getElementById('adminPanel');
    if (adminPanel) {
      adminPanel.remove();
    }

    // 根據用戶狀態顯示適當的區域
    if (currentOrderSummary) {
      showSection('ordersSection');
    } else {
      showSection('registrationSection');
    }
    }

  </script>
</body>
</html>
