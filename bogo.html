<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF ç¹³è²»ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #FF8C69 0%, #FF7F50 50%, #FF6347 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(255, 99, 71, 0.3);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(135deg, #FF8C69, #FF7F50);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 30px 20px;
        }

        .user-info {
            background: linear-gradient(135deg, #FFF8DC, #FFE4B5);
            border: 2px solid #FF8C69;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .user-info h2 {
            color: #D2691E;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .user-info .line-name {
            color: #FF6347;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #D2691E;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #FFE4B5;
            border-radius: 12px;
            font-size: 16px;
            background: #FFFAF0;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #FF8C69;
            box-shadow: 0 0 0 3px rgba(255, 140, 105, 0.1);
            background: white;
        }

        .form-group input.required {
            border-color: #FF6347;
            background: #FFF5F5;
        }

        .form-group input.required:focus {
            border-color: #FF4500;
            box-shadow: 0 0 0 3px rgba(255, 69, 0, 0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF8C69, #FF7F50);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 140, 105, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 140, 105, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #DEB887, #D2B48C);
            color: #8B4513;
            box-shadow: 0 4px 15px rgba(210, 180, 140, 0.4);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(210, 180, 140, 0.6);
        }

        .btn:disabled {
            background: #ccc;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .order-item {
            background: linear-gradient(135deg, #FFFAF0, #FFF8DC);
            border: 2px solid #FFE4B5;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(255, 140, 105, 0.1);
            border-left: 5px solid #FF8C69;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #FFE4B5;
        }

        .order-header h3 {
            margin: 0;
            color: #D2691E;
            font-size: 18px;
        }

        .product-info {
            margin-top: 12px;
        }

        .product-name {
            font-size: 16px;
            color: #8B4513;
            margin-bottom: 12px;
            padding: 12px;
            background: linear-gradient(135deg, #FFF8DC, #FFFAF0);
            border-radius: 8px;
            border: 1px solid #FFE4B5;
            font-weight: 600;
        }

        .order-details {
            margin: 12px 0;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #FFE4B5;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .total-row {
            background: linear-gradient(135deg, #FFE4B5, #F5DEB3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 8px;
            font-weight: bold;
            border: 2px solid #FF8C69;
        }

        .label {
            color: #D2691E;
            font-size: 14px;
            font-weight: 500;
        }

        .value {
            color: #8B4513;
            font-weight: 600;
        }

        .total-amount {
            color: #FF6347;
            font-size: 16px;
            font-weight: bold;
        }

        .order-date {
            font-size: 12px;
            color: #CD853F;
            margin-top: 12px;
            text-align: right;
        }

        .status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-paid {
            background: linear-gradient(135deg, #98FB98, #90EE90);
            color: #006400;
            border: 1px solid #32CD32;
        }

        .status-pending {
            background: linear-gradient(135deg, #FFE4B5, #F5DEB3);
            color: #FF8C00;
            border: 1px solid #FF8C69;
        }

        .order-summary {
            background: linear-gradient(135deg, #FF8C69, #FF7F50);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 6px 20px rgba(255, 140, 105, 0.3);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .total-summary {
            border-top: 2px solid rgba(255,255,255,0.3);
            margin-top: 12px;
            padding-top: 15px;
            font-size: 18px;
            font-weight: bold;
        }

        .summary-label {
            font-size: 14px;
        }

        .summary-value {
            font-weight: bold;
        }

        .payment-form {
            background: linear-gradient(135deg, #FFFAF0, #FFF8DC);
            border: 2px solid #FFE4B5;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .payment-form h3 {
            color: #D2691E;
            margin-bottom: 20px;
            text-align: center;
            font-size: 18px;
        }

        .payment-methods {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }

        .payment-method {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border: 2px solid #FFE4B5;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-method:hover {
            border-color: #FF8C69;
            background: #FFFAF0;
        }

        .payment-method.selected {
            border-color: #FF6347;
            background: linear-gradient(135deg, #FFE4B5, #F5DEB3);
        }

        .payment-method input[type="radio"] {
            margin-right: 12px;
            accent-color: #FF8C69;
        }

        .payment-method label {
            font-weight: 500;
            color: #8B4513;
            cursor: pointer;
            flex: 1;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #FFE4B5;
            border-radius: 12px;
            font-size: 14px;
            background: #FFFAF0;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        textarea:focus {
            outline: none;
            border-color: #FF8C69;
            box-shadow: 0 0 0 3px rgba(255, 140, 105, 0.1);
            background: white;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #FF8C69;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #FFE4B5;
            border-top: 3px solid #FF8C69;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success {
            background: linear-gradient(135deg, #98FB98, #90EE90);
            color: #006400;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            border: 2px solid #32CD32;
        }

        .error {
            background: linear-gradient(135deg, #FFB6C1, #FFA0B4);
            color: #8B0000;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            border: 2px solid #DC143C;
        }

        .info {
            background: linear-gradient(135deg, #E0F6FF, #B0E0E6);
            color: #4682B4;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            border: 2px solid #87CEEB;
        }

        .required-note {
            font-size: 12px;
            color: #FF6347;
            margin-top: 5px;
            font-style: italic;
        }

        .user-display {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF8C69, #FF7F50);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        @media (max-width: 480px) {
            .container {
                margin: 5px;
                border-radius: 15px;
            }
            
            .content {
                padding: 20px 15px;
            }
            
            .header {
                padding: 20px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’³ LIFF ç¹³è²»ç³»çµ±</h1>
            <div class="subtitle">å®‰å…¨ä¾¿åˆ©çš„ç·šä¸Šç¹³è²»å¹³å°</div>
        </div>

        <div class="content">
            <!-- è¼‰å…¥ä¸­ -->
            <div id="loading" class="loading show">
                <div class="spinner"></div>
                <div>ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
            </div>

            <!-- ç”¨æˆ¶è¨»å†Š/ç¢ºèªå€æ®µ -->
            <div id="userSection" class="section">
                <div class="user-info">
                    <h2>ğŸ‘‹ æ­¡è¿ä½¿ç”¨</h2>
                    <div id="userDisplay" class="user-display" style="display: none;">
                        <div id="userAvatar" class="user-avatar"></div>
                        <div>
                            <div id="lineDisplayName" class="line-name"></div>
                            <div style="font-size: 12px; color: #CD853F;">LINE ç”¨æˆ¶</div>
                        </div>
                    </div>
                </div>

                <form id="userForm">
                    <div class="form-group">
                        <label for="realName">çœŸå¯¦å§“å <span style="color: #FF6347;">*</span></label>
                        <input type="text" id="realName" name="realName" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å">
                        <div class="required-note">æ­¤è³‡è¨Šç”¨æ–¼è¨‚å–®æ ¸å°ï¼Œè«‹å‹™å¿…å¡«å¯«æ­£ç¢º</div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="confirmUserBtn">
                        âœ… ç¢ºèªè³‡æ–™
                    </button>
                </form>
            </div>

            <!-- è¨‚å–®åˆ—è¡¨å€æ®µ -->
            <div id="ordersSection" class="section">
                <div class="user-info">
                    <h2>ğŸ“‹ æˆ‘çš„è¨‚å–®</h2>
                    <div id="confirmedUserDisplay" class="user-display">
                        <div id="confirmedUserAvatar" class="user-avatar"></div>
                        <div>
                            <div id="confirmedLineName" class="line-name"></div>
                            <div id="confirmedRealName" style="font-size: 14px; color: #8B4513; font-weight: 600;"></div>
                        </div>
                    </div>
                </div>

                <div id="ordersList"></div>
                
                <button class="btn btn-secondary" onclick="showUserSection()">
                    âš™ï¸ ä¿®æ”¹å€‹äººè³‡æ–™
                </button>
            </div>

            <!-- ç¹³è²»å€æ®µ -->
            <div id="paymentSection" class="section">
                <div class="payment-form">
                    <h3>ğŸ’° æäº¤ç¹³è²»è­‰æ˜</h3>
                    
                    <div class="form-group">
                        <label>é¸æ“‡è¨‚å–®</label>
                        <select id="paymentOrderSelect" class="form-group input" style="padding: 15px; border: 2px solid #FFE4B5; border-radius: 12px; background: #FFFAF0;">
                            <option value="">è«‹é¸æ“‡è¦ç¹³è²»çš„è¨‚å–®</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ç¹³è²»æ–¹å¼</label>
                        <div class="payment-methods">
                            <div class="payment-method">
                                <input type="radio" id="bank" name="paymentMethod" value="éŠ€è¡Œè½‰å¸³">
                                <label for="bank">ğŸ¦ éŠ€è¡Œè½‰å¸³</label>
                            </div>
                            <div class="payment-method">
                                <input type="radio" id="atm" name="paymentMethod" value="ATMè½‰å¸³">
                                <label for="atm">ğŸ§ ATMè½‰å¸³</label>
                            </div>
                            <div class="payment-method">
                                <input type="radio" id="mobile" name="paymentMethod" value="è¡Œå‹•æ”¯ä»˜">
                                <label for="mobile">ğŸ“± è¡Œå‹•æ”¯ä»˜</label>
                            </div>
                            <div class="payment-method">
                                <input type="radio" id="cash" name="paymentMethod" value="ç¾é‡‘ç¹³è²»">
                                <label for="cash">ğŸ’µ ç¾é‡‘ç¹³è²»</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="paymentNote">å‚™è¨»èªªæ˜</label>
                        <textarea id="paymentNote" placeholder="è«‹è¼¸å…¥è½‰å¸³å¸³è™Ÿå¾Œ5ç¢¼ã€ç¹³è²»æ™‚é–“æˆ–å…¶ä»–ç›¸é—œè³‡è¨Š..."></textarea>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="submitPayment()">
                        ğŸ“¤ æäº¤ç¹³è²»è­‰æ˜
                    </button>
                    
                    <button type="button" class="btn btn-secondary" onclick="showOrdersSection()">
                        â¬…ï¸ è¿”å›è¨‚å–®åˆ—è¡¨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let liffData = {};
        let currentUser = {};
        let userOrders = [];

        // API è¨­å®š
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbzXUaddMAHye0yn9EIMFDYNAOzKKUWGzv1PHBw2wmLT-BeQO7PBjLwhV9e7DJMpy4v3/exec';

        // LIFF åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeLiff();
        });

        async function initializeLiff() {
            try {
                await liff.init({ liffId: '1657285806-2bmkYWkN' });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // å–å¾—ç”¨æˆ¶è³‡æ–™
                const profile = await liff.getProfile();
                liffData = {
                    userId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl,
                    statusMessage: profile.statusMessage
                };

                console.log('LIFF ç”¨æˆ¶è³‡æ–™:', liffData);

                // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
                displayUserInfo();
                
                // æª¢æŸ¥ç”¨æˆ¶è¨»å†Šç‹€æ…‹
                await checkUserRegistration();

            } catch (error) {
                console.error('LIFF åˆå§‹åŒ–éŒ¯èª¤:', error);
                document.getElementById('loading').innerHTML = 
                    '<div class="error">ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div>';
            }
        }

        function displayUserInfo() {
            // é¡¯ç¤º LINE ç”¨æˆ¶è³‡è¨Š
            document.getElementById('lineDisplayName').textContent = liffData.displayName;
            
            // è¨­å®šé ­åƒ
            const avatar = liffData.displayName.charAt(0).toUpperCase();
            document.getElementById('userAvatar').textContent = avatar;
            
            document.getElementById('userDisplay').style.display = 'flex';
        }

        async function checkUserRegistration() {
            try {
                const response = await fetch(`${API_BASE_URL}?action=check-registration&data=${encodeURIComponent(JSON.stringify({
                    userId: liffData.userId,
                    lineDisplayName: liffData.displayName
                }))}`);
                
                const result = await response.json();
                console.log('è¨»å†Šæª¢æŸ¥çµæœ:', result);

                if (result.success && result.registered) {
                    // ç”¨æˆ¶å·²è¨»å†Šï¼Œå¡«å…¥è³‡æ–™ä¸¦é¡¯ç¤ºç‚ºå¯ä¿®æ”¹
                    currentUser = result.userInfo;
                    document.getElementById('realName').value = result.userInfo.realName;
                    document.getElementById('confirmUserBtn').textContent = 'âœï¸ æ›´æ–°è³‡æ–™';
                    
                    // è‡ªå‹•è¼‰å…¥è¨‚å–®
                    await loadUserOrders();
                } else {
                    // ç”¨æˆ¶æœªè¨»å†Šï¼Œé¡¯ç¤ºå¿…å¡«æç¤º
                    document.getElementById('realName').classList.add('required');
                    document.getElementById('confirmUserBtn').textContent = 'ğŸ“ è¨»å†Šè³‡æ–™';
                }

                // éš±è—è¼‰å…¥ä¸­ï¼Œé¡¯ç¤ºç”¨æˆ¶å€æ®µ
                document.getElementById('loading').classList.remove('show');
                showUserSection();

            } catch (error) {
                console.error('æª¢æŸ¥è¨»å†Šç‹€æ…‹éŒ¯èª¤:', error);
                document.getElementById('loading').innerHTML = 
                    '<div class="error">ç„¡æ³•é€£æ¥ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š</div>';
            }
        }

        // ç”¨æˆ¶è¡¨å–®æäº¤
        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const realName = document.getElementById('realName').value.trim();
            
            if (!realName) {
                alert('è«‹è¼¸å…¥çœŸå¯¦å§“å');
                return;
            }

            try {
                document.getElementById('confirmUserBtn').disabled = true;
                document.getElementById('confirmUserBtn').textContent = 'è™•ç†ä¸­...';

                const response = await fetch(`${API_BASE_URL}?action=register&data=${encodeURIComponent(JSON.stringify({
                    userId: liffData.userId,
                    lineDisplayName: liffData.displayName,
                    realName: realName,
                    liffContext: liff.getContext(),
                    liffEnvironment: liff.getOS(),
                    timestamp: new Date().toISOString()
                }))}`);
                
                const result = await response.json();
                console.log('è¨»å†Šçµæœ:', result);

                if (result.success) {
                    currentUser = result.userInfo;
                    
                    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                    const successDiv = document.createElement('div');
                    successDiv.className = 'success';
                    successDiv.textContent = result.message;
                    document.getElementById('userForm').appendChild(successDiv);
                    
                    // 3ç§’å¾Œè¼‰å…¥è¨‚å–®
                    setTimeout(async () => {
                        await loadUserOrders();
                    }, 2000);
                    
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                console.error('ç”¨æˆ¶è¨»å†ŠéŒ¯èª¤:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = 'è¨»å†Šå¤±æ•—: ' + error.message;
                document.getElementById('userForm').appendChild(errorDiv);
            } finally {
                document.getElementById('confirmUserBtn').disabled = false;
                document.getElementById('confirmUserBtn').textContent = 'âœ… ç¢ºèªè³‡æ–™';
            }
        });

        async function loadUserOrders() {
            try {
                const response = await fetch(`${API_BASE_URL}?action=orders&data=${encodeURIComponent(JSON.stringify({
                    userId: liffData.userId
                }))}`);
                
                const result = await response.json();
                console.log('è¨‚å–®è³‡æ–™:', result);

                if (result.success) {
                    userOrders = result.orders;
                    displayOrders(result.orders);
                    populatePaymentOrderSelect(result.orders);
                    showOrdersSection();
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                console.error('è¼‰å…¥è¨‚å–®éŒ¯èª¤:', error);
                document.getElementById('ordersList').innerHTML = 
                    '<div class="error">è¼‰å…¥è¨‚å–®å¤±æ•—: ' + error.message + '</div>';
                showOrdersSection();
            }
        }

        function displayOrders(orders) {
            let html = '';
            let grandTotal = 0;
            
            if (orders.length === 0) {
                html = '<div class="info">æš«ç„¡è¨‚å–®è¨˜éŒ„ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ç¢ºèª</div>';
            } else {
                orders.forEach(order => {
                    const statusClass = order.paymentStatus === 'å·²ä»˜æ¬¾' ? 'status-paid' : 'status-pending';
                    const statusText = order.paymentStatus === 'å·²ä»˜æ¬¾' ? 'âœ… å·²ä»˜æ¬¾' : 'â³ å¾…ä»˜æ¬¾';
                    
                    html += `
                        <div class="order-item">
                            <div class="order-header">
                                <h3>ğŸ“¦ è¨‚å–® #${order.orderId}</h3>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                            
                            <div class="product-info">
                                <div class="product-name">
                                    ${order.productName}
                                </div>
                                
                                <div class="order-details">
                                    <div class="detail-row">
                                        <span class="label">å–®åƒ¹:</span>
                                        <span class="value">NT$ ${order.unitPrice.toLocaleString()}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="label">æ•¸é‡:</span>
                                        <span class="value">${order.quantity}</span>
                                    </div>
                                    <div class="detail-row total-row">
                                        <span class="label">å°è¨ˆ:</span>
                                        <span class="value total-amount">NT$ ${order.totalAmount.toLocaleString()}</span>
                                    </div>
                                </div>
                                
                                <div class="order-date">
                                    è¨‚å–®æ—¥æœŸ: ${order.orderDate}
                                </div>
                            </div>
                            
                                  ${order.paymentStatus !== 'å·²ä»˜æ¬¾' ? 
                                      `<button class="btn btn-primary" style="margin-top: 15px;" onclick="showPaymentSection('${order.orderId}')">
                                          ğŸ’³ ç«‹å³ç¹³è²»
                                      </button>` : ''
                                  }
                          </div>
                      `;
                      grandTotal += order.totalAmount;
                  });
                  
                  // ç¸½é‡‘é¡æ‘˜è¦
                  html += `
                      <div class="order-summary">
                          <div class="summary-row">
                              <span class="summary-label">è¨‚å–®ç¸½æ•¸:</span>
                              <span class="summary-value">${orders.length} ç­†</span>
                          </div>
                          <div class="summary-row total-summary">
                              <span class="summary-label">ç¸½é‡‘é¡:</span>
                              <span class="summary-value">NT$ ${grandTotal.toLocaleString()}</span>
                          </div>
                      </div>
                  `;
              }
              
              document.getElementById('ordersList').innerHTML = html;
              
              // æ›´æ–°ç¢ºèªç”¨æˆ¶é¡¯ç¤ºå€
              document.getElementById('confirmedLineName').textContent = liffData.displayName;
              document.getElementById('confirmedRealName').textContent = currentUser.realName || 'æœªè¨­å®š';
              document.getElementById('confirmedUserAvatar').textContent = liffData.displayName.charAt(0).toUpperCase();
          }

          function populatePaymentOrderSelect(orders) {
              const select = document.getElementById('paymentOrderSelect');
              select.innerHTML = '<option value="">è«‹é¸æ“‡è¦ç¹³è²»çš„è¨‚å–®</option>';
              
              orders.forEach(order => {
                  if (order.paymentStatus !== 'å·²ä»˜æ¬¾') {
                      const option = document.createElement('option');
                      option.value = order.orderId;
                      option.textContent = `${order.orderId} - ${order.productName} (NT$ ${order.totalAmount.toLocaleString()})`;
                      select.appendChild(option);
                  }
              });
          }

          // ç¹³è²»ç›¸é—œåŠŸèƒ½
          function showPaymentSection(orderId = '') {
              if (orderId) {
                  document.getElementById('paymentOrderSelect').value = orderId;
              }
              
              document.querySelectorAll('.section').forEach(section => {
                  section.classList.remove('active');
              });
              document.getElementById('paymentSection').classList.add('active');
          }

          // ç¹³è²»æ–¹å¼é¸æ“‡
          document.querySelectorAll('.payment-method').forEach(method => {
              method.addEventListener('click', function() {
                  // ç§»é™¤å…¶ä»–é¸ä¸­ç‹€æ…‹
                  document.querySelectorAll('.payment-method').forEach(m => {
                      m.classList.remove('selected');
                  });
                  
                  // è¨­å®šç•¶å‰é¸ä¸­
                  this.classList.add('selected');
                  this.querySelector('input[type="radio"]').checked = true;
              });
          });

          async function submitPayment() {
              const orderId = document.getElementById('paymentOrderSelect').value;
              const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
              const paymentNote = document.getElementById('paymentNote').value.trim();

              if (!orderId) {
                  alert('è«‹é¸æ“‡è¦ç¹³è²»çš„è¨‚å–®');
                  return;
              }

              if (!paymentMethod) {
                  alert('è«‹é¸æ“‡ç¹³è²»æ–¹å¼');
                  return;
              }

              try {
                  const submitBtn = document.querySelector('#paymentSection .btn-primary');
                  submitBtn.disabled = true;
                  submitBtn.textContent = 'æäº¤ä¸­...';

                  const response = await fetch(`${API_BASE_URL}?action=submit-payment&data=${encodeURIComponent(JSON.stringify({
                      userId: liffData.userId,
                      orderId: orderId,
                      realName: currentUser.realName,
                      paymentMethod: paymentMethod,
                      paymentNote: paymentNote,
                      liffContext: liff.getContext(),
                      timestamp: new Date().toISOString()
                  }))}`);
                  
                  const result = await response.json();
                  console.log('ç¹³è²»æäº¤çµæœ:', result);

                  if (result.success) {
                      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                      const successDiv = document.createElement('div');
                      successDiv.className = 'success';
                      successDiv.innerHTML = `
                          <strong>âœ… ç¹³è²»è­‰æ˜æäº¤æˆåŠŸï¼</strong><br>
                          æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„ç¹³è²»è³‡è¨Šï¼Œå°‡æ–¼1-2å€‹å·¥ä½œå¤©å…§å®Œæˆå¯©æ ¸ã€‚<br>
                          <small>è¨‚å–®ç·¨è™Ÿ: ${orderId}</small>
                      `;
                      
                      document.querySelector('.payment-form').insertBefore(
                          successDiv, 
                          document.querySelector('.payment-form').firstChild
                      );

                      // æ¸…ç©ºè¡¨å–®
                      document.getElementById('paymentOrderSelect').value = '';
                      document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                          radio.checked = false;
                      });
                      document.querySelectorAll('.payment-method').forEach(method => {
                          method.classList.remove('selected');
                      });
                      document.getElementById('paymentNote').value = '';

                      // 3ç§’å¾Œè¿”å›è¨‚å–®åˆ—è¡¨
                      setTimeout(() => {
                          loadUserOrders();
                      }, 3000);
                      
                  } else {
                      throw new Error(result.message);
                  }

              } catch (error) {
                  console.error('æäº¤ç¹³è²»è­‰æ˜éŒ¯èª¤:', error);
                  const errorDiv = document.createElement('div');
                  errorDiv.className = 'error';
                  errorDiv.textContent = 'æäº¤å¤±æ•—: ' + error.message;
                  document.querySelector('.payment-form').insertBefore(
                      errorDiv, 
                      document.querySelector('.payment-form').firstChild
                  );
              } finally {
                  const submitBtn = document.querySelector('#paymentSection .btn-primary');
                  submitBtn.disabled = false;
                  submitBtn.textContent = 'ğŸ“¤ æäº¤ç¹³è²»è­‰æ˜';
              }
          }

          // é é¢åˆ‡æ›åŠŸèƒ½
          function showUserSection() {
              document.querySelectorAll('.section').forEach(section => {
                  section.classList.remove('active');
              });
              document.getElementById('userSection').classList.add('active');
          }

          function showOrdersSection() {
              document.querySelectorAll('.section').forEach(section => {
                  section.classList.remove('active');
              });
              document.getElementById('ordersSection').classList.add('active');
          }

          // éŒ¯èª¤è™•ç†
          window.addEventListener('error', function(e) {
              console.error('é é¢éŒ¯èª¤:', e.error);
          });

          // é é¢é›¢é–‹å‰ç¢ºèª
          window.addEventListener('beforeunload', function(e) {
              const paymentNote = document.getElementById('paymentNote').value.trim();
              const selectedOrder = document.getElementById('paymentOrderSelect').value;
              
              if (paymentNote || selectedOrder) {
                  e.preventDefault();
                  e.returnValue = '';
              }
          });
      </script>
  </body>
  </html>
