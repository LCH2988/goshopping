// 設定 CORS
function doOptions(e) {
  return ContentService
    .createTextOutput()
    .setMimeType(ContentService.MimeType.TEXT);
}

// 處理 GET 和 POST 請求
function doGet(e) {
  const action = e.parameter.action;
  let result = { success: false, message: 'Invalid action' };
  
  switch(action) {
    case 'getProducts':
      result = getProducts();
      break;
    case 'getAccounts':
      result = getAccounts();
      break;
  }
  
  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  let result = { success: false, message: 'Invalid action' };
  
  if (data.action === 'submitReport') {
    result = submitReport(data.data);
  }
  
  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

// 獲取產品列表
function getProducts() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName('產品清單');
    const data = sheet.getDataRange().getValues();
    
    // 移除標題行並格式化數據，過濾掉空行
    const products = data.slice(1)
      .filter(row => row[0]) // 確保產品名稱不為空
      .map(row => ({
        name: row[0],
        price: row[1] || 0,
        pv: row[2] || 0
      }));
    
    return {
      success: true,
      data: products
    };
  } catch (error) {
    return {
      success: false,
      message: error.toString()
    };
  }
}

// 獲取帳號列表
function getAccounts() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName('搶購名單登記');
    const data = sheet.getRange('B3:C100').getValues(); // 只讀取編號和組別
    
    // 過濾有效資料並格式化
    const accounts = data
      .filter(row => row[0] && row[1]) // 確保編號和組別都不為空
      .map(row => ({
        account: row[0],    // 搶購登記編號
        group: row[1]       // 組別代號
      }));
    
    return {
      success: true,
      data: accounts
    };
  } catch (error) {
    return {
      success: false,
      message: error.toString()
    };
  }
}

// 提交回報
// 提交回報
function submitReport(data) {
  try {
    // 記錄收到的資料
    Logger.log('Received data:', JSON.stringify(data));
    
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName('搶購名單登記');
    
    if (!sheet) {
      return {
        success: false,
        message: '找不到指定的工作表'
      };
    }
    
    // 找到下一個空行
    const lastRow = sheet.getLastRow();
    Logger.log('Last row:', lastRow);
    
    // 準備寫入的資料（按照試算表欄位順序）
    const reportData = [
      new Date(),       // A列：時間戳記
      data.account,     // B列：搶購登記編號
      data.group,       // C列：組別代號
      data.quantity,    // D列：搶購組數
      data.userName,    // E列：搶購者
      data.price,       // F列：單價
      data.pv,         // G列：PV數
      data.productName  // H列：產品名稱
    ];
    
    Logger.log('Data to write:', reportData);
    
    // 寫入資料到新行（從A欄開始）
    sheet.getRange(lastRow + 1, 1, 1, reportData.length).setValues([reportData]);
    
    return {
      success: true,
      message: '回報成功'
    };
  } catch (error) {
    Logger.log('Error in submitReport:', error);
    return {
      success: false,
      message: error.toString()
    };
  }
}



function testSubmitReport() {
  const testData = {
    account: "TEST001",
    group: "A",
    quantity: 1,
    userName: "測試用戶",
    price: 100,
    pv: 10,
    productName: "測試產品"
  };
  
  const result = submitReport(testData);
  Logger.log(result);
}

