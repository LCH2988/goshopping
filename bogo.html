<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搶購名單管理系統</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .filter-section {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f5f5f5;
        border-radius: 5px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th, td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
      }
      th {
        background-color: #4CAF50;
        color: white;
      }
      tr:nth-child(even) {
        background-color: #f2f2f2;
      }
      .btn {
        padding: 5px 10px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        margin: 0 5px;
      }
      .confirm-btn {
        background-color: #4CAF50;
        color: white;
      }
      .edit-btn {
        background-color: #2196F3;
        color: white;
      }
      .save-btn {
        background-color: #ff9800;
        color: white;
      }
      .filter-select {
        padding: 5px;
        margin: 0 10px;
        min-width: 150px;
      }
      .confirmed {
        background-color: #dff0d8 !important;
      }
      .modified {
        background-color: #d9edf7 !important;
      }
      #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .loading-text {
        font-size: 1.2em;
        color: #4CAF50;
      }
      @media screen and (max-width: 768px) {
        .filter-section {
          display: flex;
          flex-direction: column;
          gap: 10px;
        }
        .filter-select {
          width: 100%;
          margin: 5px 0;
        }
      }
    </style>
  </head>
  <body>
    <div id="loading">
      <div class="loading-text">載入中...</div>
    </div>

    <h1>搶購名單管理系統</h1>
    
    <div class="filter-section">
      <h3>篩選條件</h3>
      <label>買手：</label>
      <select id="buyerFilter" class="filter-select" onchange="applyFilters()">
        <option value="">全部</option>
      </select>
      
      <label>帳號：</label>
      <select id="accountFilter" class="filter-select" onchange="applyFilters()">
        <option value="">全部</option>
      </select>
      
      <label>組別：</label>
      <select id="groupFilter" class="filter-select" onchange="applyFilters()">
        <option value="">全部</option>
      </select>
    </div>

    <div id="dataTable"></div>

    <script>
      const CONFIG = {
          LIFF_ID: '1657285806-2bmkYWkN',
          GAS_API_URL: 'https://script.google.com/macros/s/AKfycbyT3x5HoMVkAafcsC-LPJ4MGoM6kl6x36T12lq4prIUz60BIlRlUptZceQjvWGB8Cqq5g/exec'
      };

      // 儲存資料狀態
      let dataStatus = {};
      let lineUserId = '';
      
      // 初始化 LIFF
      async function initializeLiff() {
        try {
          await liff.init({ liffId: CONFIG.LIFF_ID });
          if (!liff.isLoggedIn()) {
            liff.login();
          } else {
            const profile = await liff.getProfile();
            lineUserId = profile.userId;
            loadData();
          }
        } catch (err) {
          console.error('LIFF 初始化失敗:', err);
          alert('LIFF 初始化失敗，請重新整理頁面');
        }
      }

      // 使用 Fetch API 呼叫 GAS
      async function fetchGAS(action, data = {}) {
        try {
          const url = `${CONFIG.GAS_API_URL}?action=${action}`;
          const response = await fetch(url, {
            method: 'POST',
            body: JSON.stringify({ ...data, lineUserId }),
          });
          return await response.json();
        } catch (err) {
          console.error('API 呼叫失敗:', err);
          alert('操作失敗，請稍後再試');
          throw err;
        }
      }
      
      // 載入資料和下拉選單選項
      async function loadData() {
        try {
          const result = await fetchGAS('getData');
          displayData(result.data);
          updateFilterOptions(result.data);
          const status = await fetchGAS('getStatus');
          dataStatus = status;
          applyStatus();
        } catch (err) {
          console.error('資料載入失敗:', err);
        } finally {
          document.getElementById('loading').style.display = 'none';
        }
      }

      // 更新篩選選項
      function updateFilterOptions(data) {
        const buyers = new Set();
        const accounts = new Set();
        const groups = new Set();
        
        data.forEach(row => {
          buyers.add(row[0]);
          accounts.add(row[1]);
          groups.add(row[2]);
        });

        updateSelect('buyerFilter', buyers);
        updateSelect('accountFilter', accounts);
        updateSelect('groupFilter', groups);
      }

      // 更新下拉選單選項
      function updateSelect(id, options) {
        const select = document.getElementById(id);
        const currentValue = select.value;
        select.innerHTML = '<option value="">全部</option>';
        
        Array.from(options)
          .filter(option => option)
          .sort()
          .forEach(option => {
            const opt = document.createElement('option');
            opt.value = option;
            opt.textContent = option;
            select.appendChild(opt);
          });
        
        select.value = currentValue;
      }

      // 顯示資料
      function displayData(data) {
        const tableDiv = document.getElementById('dataTable');
        let html = '<table><tr><th>買手</th><th>帳號</th><th>組別</th><th>組數</th><th>操作</th></tr>';
        
        data.forEach((row, index) => {
          html += `<tr id="row-${index}">
            <td>${row[0]}</td>
            <td>${row[1]}</td>
            <td>${row[2]}</td>
            <td>${row[3]}</td>
            <td>
              <button class="btn confirm-btn" onclick="confirmRow(${index})">確認</button>
              <button class="btn edit-btn" onclick="editRow(${index})">修改</button>
            </td>
          </tr>`;
        });
        
        html += '</table>';
        tableDiv.innerHTML = html;
        applyStatus();
      }

      // 套用狀態樣式
      function applyStatus() {
        for (const [rowIndex, status] of Object.entries(dataStatus)) {
          const row = document.getElementById(`row-${rowIndex}`);
          if (row) {
            if (status === 'confirmed') {
              row.classList.add('confirmed');
            } else if (status === 'modified') {
              row.classList.add('modified');
            }
          }
        }
      }

      // 篩選功能
      function applyFilters() {
        const buyer = document.getElementById('buyerFilter').value;
        const account = document.getElementById('accountFilter').value;
        const group = document.getElementById('groupFilter').value;
        
        const rows = document.getElementsByTagName('tr');
        
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          const cells = row.getElementsByTagName('td');
          
          const buyerMatch = !buyer || cells[0].textContent === buyer;
          const accountMatch = !account || cells[1].textContent === account;
          const groupMatch = !group || cells[2].textContent === group;
          
          if (buyerMatch && accountMatch && groupMatch) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        }
      }

      // 確認行
      async function confirmRow(index) {
        try {
          await fetchGAS('confirmRow', { rowIndex: index + 3 });
          const row = document.getElementById(`row-${index}`);
          row.className = 'confirmed';
          dataStatus[index] = 'confirmed';
        } catch (err) {
          console.error('確認失敗:', err);
        }
      }

      // 修改行
      function editRow(index) {
        const row = document.getElementById(`row-${index}`);
        const cells = row.getElementsByTagName('td');
        
        cells[2].innerHTML = `<input type="text" value="${cells[2].textContent}">`;
        cells[3].innerHTML = `<input type="text" value="${cells[3].textContent}">`;
        
        const btnCell = cells[4];
        btnCell.innerHTML = `<button class="btn save-btn" onclick="saveRow(${index})">儲存</button>`;
      }

      // 儲存修改
      async function saveRow(index) {
        const row = document.getElementById(`row-${index}`);
        const cells = row.getElementsByTagName('td');
        
        const newGroup = cells[2].getElementsByTagName('input')[0].value;
        const newCount = cells[3].getElementsByTagName('input')[0].value;
        
        try {
          await fetchGAS('updateData', {
            rowIndex: index + 3,
            newGroup,
            newCount
          });

          cells[2].textContent = newGroup;
          cells[3].textContent = newCount;
          
          cells[4].innerHTML = `
            <button class="btn confirm-btn" onclick="confirmRow(${index})">確認</button>
            <button class="btn edit-btn" onclick="editRow(${index})">修改</button>
          `;
          
          row.className = 'modified';
          dataStatus[index] = 'modified';
          
          const result = await fetchGAS('getData');
          updateFilterOptions(result.data);
        } catch (err) {
          console.error('儲存失敗:', err);
        }
      }

      // 頁面載入時初始化 LIFF
      window.onload = initializeLiff;
    </script>
  </body>
</html>
