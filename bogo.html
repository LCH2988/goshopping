<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¯¦ååˆ¶ç™»è¨˜èˆ‡ç¹³è²»ç³»çµ±</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 10px;
      }

      .container {
          max-width: 500px;
          margin: 0 auto;
          background: white;
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.2);
          overflow: hidden;
      }

      .header {
          background: linear-gradient(135deg, #4CAF50, #45a049);
          color: white;
          padding: 20px;
          text-align: center;
          position: relative;
      }

      .header h1 {
          font-size: 24px;
          margin-bottom: 5px;
      }

      .header p {
          opacity: 0.9;
          font-size: 14px;
      }

      /* æ–°å¢ç®¡ç†å“¡æŒ‰éˆ• */
      .admin-btn {
          position: absolute;
          top: 10px;
          right: 10px;
          background: rgba(255,255,255,0.2);
          border: 1px solid rgba(255,255,255,0.3);
          color: white;
          padding: 5px 10px;
          border-radius: 15px;
          font-size: 12px;
          cursor: pointer;
          transition: all 0.3s;
      }

      .admin-btn:hover {
          background: rgba(255,255,255,0.3);
      }

      .content {
          padding: 20px;
      }

      .status-bar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #f8f9fa;
          padding: 10px 15px;
          border-radius: 8px;
          margin-bottom: 20px;
          font-size: 12px;
      }

      .status-item {
          display: flex;
          align-items: center;
          gap: 5px;
      }

      .status-indicator {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background: #dc3545;
          animation: pulse 2s infinite;
      }

      .status-indicator.success {
          background: #28a745;
          animation: none;
      }

      @keyframes pulse {
          0% { opacity: 1; }
          50% { opacity: 0.5; }
          100% { opacity: 1; }
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #333;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
          width: 100%;
          padding: 12px;
          border: 2px solid #e9ecef;
          border-radius: 8px;
          font-size: 16px;
          transition: all 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
          outline: none;
          border-color: #4CAF50;
          box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
      }

      /* æ”¹é€²çš„æŒ‰éˆ•æ¨£å¼ */
      .btn {
          width: 100%;
          padding: 15px;
          background: linear-gradient(135deg, #4CAF50, #45a049);
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          margin-bottom: 10px;
          position: relative;
          overflow: hidden;
      }

      .btn:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
      }

      .btn:active {
          transform: translateY(0);
      }

      .btn:disabled {
          background: #ccc;
          cursor: not-allowed;
          transform: none;
          box-shadow: none;
      }

      .btn-secondary {
          background: linear-gradient(135deg, #6c757d, #5a6268);
      }

      .btn-secondary:hover:not(:disabled) {
          box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
      }

      .btn-danger {
          background: linear-gradient(135deg, #dc3545, #c82333);
      }

      .btn-danger:hover:not(:disabled) {
          box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
      }

      /* æ”¹é€²çš„ä¸Šå‚³å€åŸŸ */
      .upload-area {
          border: 2px dashed #ddd;
          border-radius: 8px;
          padding: 40px 20px;
          text-align: center;
          cursor: pointer;
          transition: all 0.3s;
          background: #fafafa;
          position: relative;
      }

      .upload-area:hover {
          border-color: #4CAF50;
          background: #f0f8f0;
      }

      .upload-area.dragover {
          border-color: #4CAF50;
          background: #e8f5e8;
          transform: scale(1.02);
      }

      .upload-area.uploading::after {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(76, 175, 80, 0.1);
          display: flex;
          align-items: center;
          justify-content: center;
      }

      .upload-icon {
          font-size: 48px;
          margin-bottom: 10px;
          transition: transform 0.3s;
      }

      .upload-area:hover .upload-icon {
          transform: scale(1.1);
      }

      .upload-area p {
          margin: 10px 0 5px 0;
          font-weight: 600;
          color: #333;
      }

      .upload-area small {
          color: #666;
          font-size: 12px;
      }

      .section {
          display: none;
          animation: fadeIn 0.5s ease-in;
      }

      .section.active {
          display: block;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
      }

      /* æ”¹é€²çš„è¨‚å–®å¡ç‰‡ */
      .order-card {
          background: #f8f9fa;
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 15px;
          border-left: 4px solid #4CAF50;
          transition: all 0.3s;
      }

      .order-card:hover {
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          transform: translateY(-1px);
      }

      .order-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
      }

      .order-id {
          font-weight: 600;
          color: #333;
      }

      .order-status {
          background: #4CAF50;
          color: white;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 12px;
      }

      .order-status.pending {
          background: #ffc107;
          color: #212529;
      }

      .order-status.completed {
          background: #28a745;
      }

      .order-status.cancelled {
          background: #dc3545;
      }

      .order-details {
          font-size: 14px;
          color: #666;
          line-height: 1.5;
      }

      .total-amount {
          background: linear-gradient(135deg, #e3f2fd, #bbdefb);
          padding: 20px;
          border-radius: 12px;
          text-align: center;
          margin: 20px 0;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      .total-amount h3 {
          color: #1976d2;
          margin-bottom: 10px;
          font-size: 18px;
      }

      .total-amount .amount {
          font-size: 28px;
          font-weight: bold;
          color: #d32f2f;
          text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      }

      /* æ”¹é€²çš„è­¦å‘Šæ¡† */
      .alert {
          padding: 15px 20px;
          border-radius: 8px;
          margin-bottom: 20px;
          font-size: 14px;
          border-left: 4px solid;
          position: relative;
      }

      .alert-success {
          background: #d4edda;
          color: #155724;
          border-left-color: #28a745;
      }

      .alert-error {
          background: #f8d7da;
          color: #721c24;
          border-left-color: #dc3545;
      }

      .alert-info {
          background: #d1ecf1;
          color: #0c5460;
          border-left-color: #17a2b8;
      }

      .alert-warning {
          background: #fff3cd;
          color: #856404;
          border-left-color: #ffc107;
      }

      /* æ–°å¢é—œé–‰æŒ‰éˆ• */
      .alert .close-btn {
          position: absolute;
          top: 10px;
          right: 15px;
          background: none;
          border: none;
          font-size: 18px;
          cursor: pointer;
          opacity: 0.7;
      }

      .alert .close-btn:hover {
          opacity: 1;
      }

      .loading {
          text-align: center;
          padding: 40px;
      }

      .loading::after {
          content: '';
          display: inline-block;
          width: 24px;
          height: 24px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid #4CAF50;
          border-radius: 50%;
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      /* æ”¹é€²çš„é™¤éŒ¯è³‡è¨Š */
      .debug-info {
          background: #f8f9fa;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          padding: 15px;
          margin-top: 20px;
          font-family: 'Courier New', monospace;
          font-size: 11px;
          max-height: 250px;
          overflow-y: auto;
          white-space: pre-wrap;
      }

      .debug-info::-webkit-scrollbar {
          width: 6px;
      }

      .debug-info::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 3px;
      }

      .debug-info::-webkit-scrollbar-thumb {
          background: #c1c1c1;
          border-radius: 3px;
      }

      .maintenance-mode {
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          background: #f5f5f5;
      }

      .maintenance-card {
          text-align: center;
          padding: 40px;
          background: white;
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.1);
          max-width: 400px;
      }

      .maintenance-icon {
          font-size: 64px;
          margin-bottom: 20px;
          animation: bounce 2s infinite;
      }

      @keyframes bounce {
          0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
          40% { transform: translateY(-10px); }
          60% { transform: translateY(-5px); }
      }

      .hidden {
          display: none !important;
      }

      /* æ–°å¢é€²åº¦æ¢ */
      .progress-bar {
          width: 100%;
          height: 4px;
          background: #e9ecef;
          border-radius: 2px;
          overflow: hidden;
          margin-bottom: 20px;
      }

      .progress-fill {
          height: 100%;
          background: linear-gradient(90deg, #4CAF50, #45a049);
          border-radius: 2px;
          transition: width 0.3s ease;
      }

      /* æ–°å¢æµ®å‹•é€šçŸ¥ */
      .toast {
          position: fixed;
          top: 20px;
          right: 20px;
          background: white;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          padding: 15px 20px;
          z-index: 1000;
          transform: translateX(400px);
          transition: transform 0.3s ease;
      }

      .toast.show {
          transform: translateX(0);
      }

      .toast.success {
          border-left: 4px solid #28a745;
      }

      .toast.error {
          border-left: 4px solid #dc3545;
      }

      .toast.info {
          border-left: 4px solid #17a2b8;
      }

      /* éŸ¿æ‡‰å¼è¨­è¨ˆæ”¹é€² */
      @media (max-width: 480px) {
          .container {
              margin: 0;
              border-radius: 0;
              min-height: 100vh;
          }
          
          .content {
              padding: 15px;
          }
          
          .form-group input,
          .form-group select,
          .form-group textarea {
              font-size: 16px; /* é˜²æ­¢ iOS ç¸®æ”¾ */
          }

          .admin-btn {
              position: static;
              margin-top: 10px;
              display: inline-block;
          }

          .total-amount .amount {
              font-size: 24px;
          }

          .upload-area {
              padding: 30px 15px;
          }

          .upload-icon {
              font-size: 36px;
          }
      }

      /* æ–°å¢ç®¡ç†å“¡é¢æ¿æ¨£å¼ */
      .admin-panel {
          background: #f8f9fa;
          border-radius: 8px;
          padding: 20px;
          margin-bottom: 20px;
      }

      .admin-tabs {
          display: flex;
          margin-bottom: 20px;
          border-bottom: 1px solid #dee2e6;
      }

      .admin-tab {
          padding: 10px 20px;
          background: none;
          border: none;
          cursor: pointer;
          border-bottom: 2px solid transparent;
          transition: all 0.3s;
      }

      .admin-tab.active {
          border-bottom-color: #4CAF50;
          color: #4CAF50;
          font-weight: 600;
      }

      .admin-tab:hover {
          background: rgba(76, 175, 80, 0.1);
      }

      .data-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 15px;
      }

      .data-table th,
      .data-table td {
          padding: 12px;
          text-align: left;
          border-bottom: 1px solid #dee2e6;
      }

      .data-table th {
          background: #f8f9fa;
          font-weight: 600;
          color: #495057;
      }

      .data-table tr:hover {
          background: #f8f9fa;
      }

      /* æ–°å¢æœå°‹æ¡†æ¨£å¼ */
      .search-box {
          position: relative;
          margin-bottom: 20px;
      }

      .search-box input {
          padding-left: 40px;
      }

      .search-box::before {
          content: 'ğŸ”';
          position: absolute;
          left: 12px;
          top: 50%;
          transform: translateY(-50%);
          z-index: 1;
      }

      /* æ–°å¢çµ±è¨ˆå¡ç‰‡ */
      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 15px;
          margin-bottom: 20px;
      }

      .stat-card {
          background: white;
          padding: 20px;
          border-radius: 8px;
          text-align: center;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          transition: transform 0.3s;
      }

      .stat-card:hover {
          transform: translateY(-2px);
      }

      .stat-number {
          font-size: 24px;
          font-weight: bold;
          color: #4CAF50;
      }

      .stat-label {
          font-size: 12px;
          color: #666;
          margin-top: 5px;
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <button class="admin-btn" onclick="checkAndShowAdminPanel()" id="adminToggle" style="display: none;">
              ğŸ› ï¸ ç®¡ç†
          </button>
          <h1>ğŸ« å¯¦ååˆ¶ç™»è¨˜ç³»çµ±</h1>
          <p>è«‹å®Œæˆå¯¦ååˆ¶ç™»è¨˜å¾ŒæŸ¥çœ‹è¨‚å–®</p>
      </div>

      <!-- ç‹€æ…‹åˆ— -->
      <div class="content">
          <div class="status-bar">
              <div class="status-item">
                  <div class="status-indicator" id="apiIndicator"></div>
                  <span id="apiStatus">é€£ç·šæª¢æŸ¥ä¸­...</span>
              </div>
              <div class="status-item">
                  <div class="status-indicator" id="liffIndicator"></div>
                  <span id="liffStatus">LIFF åˆå§‹åŒ–ä¸­...</span>
              </div>
          </div>

          <!-- é€²åº¦æ¢ -->
          <div class="progress-bar" id="progressBar" style="display: none;">
              <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
          </div>

          <!-- LIFF ç’°å¢ƒè³‡è¨Š -->
          <div id="liffInfo" class="alert alert-info hidden">
              <button class="close-btn" onclick="this.parentElement.style.display='none'">Ã—</button>
              <strong>LIFF ç’°å¢ƒè³‡è¨Šï¼š</strong>
              <div id="liffDetails"></div>
          </div>

          <!-- è¼‰å…¥ä¸­ -->
          <div id="loadingSection" class="section active">
              <div class="loading">
                  <p>ç³»çµ±åˆå§‹åŒ–ä¸­ï¼Œè«‹ç¨å€™...</p>
              </div>
          </div>

          <!-- å¯¦ååˆ¶ç™»è¨˜è¡¨å–® -->
          <div id="registrationSection" class="section">
              <div class="alert alert-info">
                  <strong>ğŸ“ å¯¦ååˆ¶ç™»è¨˜</strong><br>
                  è«‹å¡«å¯«çœŸå¯¦è³‡æ–™ä»¥å®Œæˆç™»è¨˜ï¼Œç™»è¨˜å¾Œå³å¯æŸ¥çœ‹æ‚¨çš„è¨‚å–®è³‡è¨Šã€‚
              </div>

              <form id="registrationForm">
                  <div class="form-group">
                      <label for="lineName">LINE é¡¯ç¤ºåç¨±</label>
                      <input type="text" id="lineName" readonly>
                  </div>

                  <div class="form-group">
                      <label for="realName">çœŸå¯¦å§“å *</label>
                      <input type="text" id="realName" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" required>
                  </div>

                  <div class="form-group">
                      <label for="idNumber">èº«åˆ†è­‰å­—è™Ÿ *</label>
                      <input type="text" id="idNumber" placeholder="ä¾‹ï¼šA123456789" required maxlength="10" style="text-transform: uppercase;">
                  </div>

                  <div class="form-group">
                      <label for="phoneNumber">æ‰‹æ©Ÿè™Ÿç¢¼ *</label>
                      <input type="tel" id="phoneNumber" placeholder="ä¾‹ï¼š0912345678" required maxlength="10">
                  </div>

                  <button type="submit" class="btn" id="registerBtn">
                      å®Œæˆå¯¦ååˆ¶ç™»è¨˜
                  </button>
              </form>
          </div>

          <!-- è¨‚å–®åˆ—è¡¨ -->
          <div id="ordersSection" class="section">
              <div class="alert alert-success">
                  <strong>âœ… å·²å®Œæˆå¯¦ååˆ¶ç™»è¨˜</strong><br>
                  <span id="userInfo"></span>
              </div>

              <div id="ordersContainer">
                  <!-- è¨‚å–®å°‡å‹•æ…‹è¼‰å…¥åˆ°é€™è£¡ -->
              </div>

              <div class="total-amount">
                  <h3>ç¸½æ‡‰ç¹³é‡‘é¡</h3>
                  <div class="amount" id="totalAmount">NT$ 0</div>
              </div>

              <button class="btn" id="proceedToPaymentBtn">
                  å‰å¾€ç¹³è²»
              </button>

              <button class="btn btn-secondary" id="refreshOrdersBtn">
                  ğŸ”„ é‡æ–°æ•´ç†è¨‚å–®
              </button>
          </div>

          <!-- ç¹³è²»è­‰æ˜ä¸Šå‚³ -->
          <div id="paymentSection" class="section">
              <div class="alert alert-info">
                  <strong>ğŸ’³ ä¸Šå‚³ç¹³è²»è­‰æ˜</strong><br>
                  è«‹é¸æ“‡ç¹³è²»æ–¹å¼ä¸¦ä¸Šå‚³ç›¸é—œè­‰æ˜æ–‡ä»¶ã€‚
              </div>

              <form id="paymentForm">
                  <div class="form-group">
                      <label for="paymentMethod">ç¹³è²»æ–¹å¼ *</label>
                      <select id="paymentMethod" required>
                          <option value="">è«‹é¸æ“‡ç¹³è²»æ–¹å¼</option>
                          <!-- é¸é …å°‡å¾ç³»çµ±è¨­å®šå‹•æ…‹è¼‰å…¥ -->
                      </select>
                  </div>

                  <div class="form-group">
                      <label>ä¸Šå‚³ç¹³è²»è­‰æ˜</label>
                      <div class="upload-area" onclick="document.getElementById('paymentProof').click()">
                          <div class="upload-icon">ğŸ“·</div>
                          <p>é»æ“Šä¸Šå‚³ç¹³è²»è­‰æ˜ç…§ç‰‡</p>
                          <small>æ”¯æ´ JPGã€PNGã€PDF æ ¼å¼ï¼Œæª”æ¡ˆå¤§å°é™åˆ¶ 5MB</small>
                      </div>
                      <input type="file" id="paymentProof" accept="image/*,.pdf" style="display: none;" onchange="handleFileUpload(this)">
                  </div>

                  <div class="form-group" id="noteFieldGroup">
                      <label for="paymentNote">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                      <textarea id="paymentNote" rows="3" placeholder="å¦‚æœ‰ç‰¹æ®Šèªªæ˜è«‹åœ¨æ­¤å¡«å¯«..."></textarea>
                  </div>

                  <button type="button" class="btn" id="submitPaymentBtn" onclick="submitPayment()">
                      æäº¤ç¹³è²»è­‰æ˜
                  </button>

                  <button type="button" class="btn btn-secondary" id="backToOrdersBtn">
                      â† è¿”å›è¨‚å–®åˆ—è¡¨
                  </button>
              </form>
          </div>

          <!-- ç®¡ç†å“¡é¢æ¿ -->
          <div id="adminSection" class="section">
              <div class="admin-panel">
                  <div class="alert alert-success">
                      <strong>ğŸ› ï¸ ç®¡ç†å“¡é¢æ¿</strong><br>
                      <span id="adminWelcome"></span>
                  </div>

                  <div class="admin-tabs">
                      <button class="admin-tab active" onclick="showAdminTab('dashboard')">å„€è¡¨æ¿</button>
                      <button class="admin-tab" onclick="showAdminTab('users')">ç”¨æˆ¶ç®¡ç†</button>
                      <button class="admin-tab" onclick="showAdminTab('payments')">ç¹³è²»ç®¡ç†</button>
                      <button class="admin-tab" onclick="showAdminTab('admins')">ç®¡ç†å“¡</button>
                  </div>

                  <div id="adminContent">
                      <!-- ç®¡ç†å“¡å…§å®¹å°‡è¼‰å…¥åˆ°é€™è£¡ -->
                  </div>

                  <button class="btn btn-secondary" onclick="backToMainSystem()">
                      â† è¿”å›ä¸»ç³»çµ±
                  </button>
              </div>
          </div>

          <!-- é™¤éŒ¯è³‡è¨Š -->
          <div id="debugInfo" class="debug-info hidden">
              <strong>ğŸ› é™¤éŒ¯è³‡è¨Šï¼š</strong>
              <div id="debugContent"></div>
          </div>
      </div>
  </div>

  <!-- æµ®å‹•é€šçŸ¥æ¨¡æ¿ -->
  <div id="toastTemplate" class="toast" style="display: none;">
      <div class="toast-content"></div>
  </div>

  <script>
      // ==================== å…¨åŸŸè¨­å®š ====================
      const CONFIG = {
          LIFF_ID: '1657285806-2bmkYWkN', // è«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID
          API_BASE_URL: 'https://script.google.com/macros/s/AKfycbwR7eO2Tikx7XftsmsLUZhlDW1-LZ6LA8K9o7FA118U01WO1Jz5ZBX5vSbdZ9jFDAxj/exec',
          DEBUG_MODE: true,
          DEMO_MODE: false,
          RETRY_ATTEMPTS: 3,
          RETRY_DELAY: 1000
      };

      // ==================== å…¨åŸŸè®Šæ•¸ ====================
      let liffProfile = null;
      let systemConfig = null;
      let currentOrderSummary = null;
      let debugLogs = [];
      let isAdminUser = false;
      let currentAdminTab = 'dashboard';

      // ==================== æ”¹é€²çš„å·¥å…·å‡½æ•¸ ====================

      // é¡¯ç¤ºæµ®å‹•é€šçŸ¥
      function showToast(message, type = 'info', duration = 3000) {
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          toast.innerHTML = `<div class="toast-content">${message}</div>`;
          
          document.body.appendChild(toast);
          
          // è§¸ç™¼é¡¯ç¤ºå‹•ç•«
          setTimeout(() => toast.classList.add('show'), 100);
          
          // è‡ªå‹•ç§»é™¤
          setTimeout(() => {
              toast.classList.remove('show');
              setTimeout(() => document.body.removeChild(toast), 300);
          }, duration);
      }

      // æ”¹é€²çš„é€²åº¦é¡¯ç¤º
      function showProgress(percentage) {
          const progressBar = document.getElementById('progressBar');
          const progressFill = document.getElementById('progressFill');
          
          if (percentage > 0) {
              progressBar.style.display = 'block';
              progressFill.style.width = percentage + '%';
          } else {
              progressBar.style.display = 'none';
          }
      }

      // æ”¹é€²çš„ API å‘¼å«ï¼ˆå«é‡è©¦æ©Ÿåˆ¶ï¼‰
      async function callAPIWithRetry(action, data = {}, retryCount = 0) {
          try {
              showProgress(25 + (retryCount * 25));
              
              const result = await callAPI(action, data);
              showProgress(100);
              
              setTimeout(() => showProgress(0), 500);
              return result;
              
          } catch (error) {
              if (retryCount < CONFIG.RETRY_ATTEMPTS) {
                  debugLog(`API å‘¼å«å¤±æ•—ï¼Œé‡è©¦ ${retryCount + 1}/${CONFIG.RETRY_ATTEMPTS}`, error);
                    await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * (retryCount + 1)));
                    return callAPIWithRetry(action, data, retryCount + 1);
                } else {
                    showProgress(0);
                    throw error;
                }
            }
        }

        // æ”¹é€²çš„é™¤éŒ¯æ—¥èªŒ
        function debugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            if (data) {
                console.log(logEntry, data);
                debugLogs.push({ timestamp, message, data: JSON.stringify(data, null, 2) });
            } else {
                console.log(logEntry);
                debugLogs.push({ timestamp, message });
            }
            
            updateDebugDisplay();
        }

        // æ›´æ–°é™¤éŒ¯é¡¯ç¤º
        function updateDebugDisplay() {
            if (!CONFIG.DEBUG_MODE) return;
            
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                const recentLogs = debugLogs.slice(-15);
                debugContent.textContent = recentLogs.map(log => {
                    let logText = `${log.timestamp} - ${log.message}`;
                    if (log.data) {
                        logText += `\n${log.data}`;
                    }
                    return logText;
                }).join('\n\n');
                
                // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }

        // æ”¹é€²çš„å€åŸŸé¡¯ç¤º
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                debugLog(`é¡¯ç¤ºå€åŸŸ: ${sectionId}`);
            }
        }

        // æ”¹é€²çš„æˆåŠŸ/éŒ¯èª¤è¨Šæ¯
        function showSuccess(message) {
            showToast(message, 'success', 4000);
        }

        function showError(message) {
            showToast(message, 'error', 6000);
        }

        function showInfo(message) {
            showToast(message, 'info', 3000);
        }

        // ==================== API ç›¸é—œå‡½æ•¸ ====================

        // åŸæœ‰çš„ callAPI å‡½æ•¸ä¿æŒä¸è®Š
        async function callAPI(action, data = {}) {
            try {
                debugLog(`API å‘¼å«: ${action}`, data);
                
                if (CONFIG.DEMO_MODE) {
                    return getDemoData(action, data);
                }
                
                const params = new URLSearchParams({
                    action: action,
                    data: JSON.stringify(data),
                    callback: 'handleAPIResponse',
                    _: Date.now()
                });
                
                return new Promise((resolve, reject) => {
                    window.handleAPIResponse = (response) => {
                        debugLog(`API å›æ‡‰: ${action}`, response);
                        resolve(response);
                        delete window.handleAPIResponse;
                    };
                    
                    const script = document.createElement('script');
                    script.src = `${CONFIG.API_BASE_URL}?${params}`;
                    script.onerror = () => {
                        reject(new Error('API å‘¼å«å¤±æ•—'));
                        delete window.handleAPIResponse;
                    };
                    
                    document.head.appendChild(script);
                    
                    setTimeout(() => {
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                        }
                    }, 1000);
                    
                    setTimeout(() => {
                        if (window.handleAPIResponse) {
                            reject(new Error('API å‘¼å«é€¾æ™‚'));
                            delete window.handleAPIResponse;
                        }
                    }, 15000);
                });
                
            } catch (error) {
                debugLog(`API å‘¼å«å¤±æ•—: ${action}`, error);
                throw error;
            }
        }

        // ç¤ºç¯„è³‡æ–™å‡½æ•¸ä¿æŒä¸è®Š
        function getDemoData(action, data) {
            debugLog(`ä½¿ç”¨ç¤ºç¯„è³‡æ–™: ${action}`, data);
            
            switch (action) {
                case 'test':
                    return { success: true, message: 'API é€£ç·šæ¸¬è©¦æˆåŠŸï¼ˆç¤ºç¯„æ¨¡å¼ï¼‰' };
                    
                case 'get-config':
                    return {
                        success: true,
                        config: {
                            basic: {
                                'APIé€£ç·šç‹€æ…‹é¡¯ç¤º': true,
                                'é™¤éŒ¯è³‡è¨Šé¡¯ç¤º': true,
                                'LIFFç’°å¢ƒè³‡è¨Šé¡¯ç¤º': true,
                                'ç¹³è²»è­‰æ˜ä¸Šå‚³': 'å¿…é ˆ',
                                'å‚™è¨»æ¬„ä½é¡¯ç¤º': true,
                                'ç³»çµ±ç¶­è­·æ¨¡å¼': false,
                                'æœ€å¤§æª”æ¡ˆå¤§å°MB': 5,
                                'å…è¨±æª”æ¡ˆæ ¼å¼': ['jpg', 'png', 'pdf']
                            },
                            paymentMethods: [
                                { code: 'bank_transfer', name: 'éŠ€è¡Œè½‰å¸³', enabled: true },
                                { code: 'cash', name: 'ç¾é‡‘ç¹³è²»', enabled: true },
                                { code: 'atm', name: 'ATMè½‰å¸³', enabled: true }
                            ],
                            messages: {
                                welcome_message: 'æ­¡è¿ä½¿ç”¨æœ¬ç³»çµ±ï¼',
                                upload_success: 'ç¹³è²»è­‰æ˜ä¸Šå‚³æˆåŠŸï¼',
                                upload_error: 'ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼',
                                registration_success: 'å¯¦ååˆ¶ç™»è¨˜å®Œæˆï¼'
                            }
                        }
                    };
                    
                case 'check-registration':
                    return { success: true, registered: false };
                    
                case 'register':
                    return {
                        success: true,
                        message: 'å¯¦ååˆ¶ç™»è¨˜å®Œæˆï¼ˆç¤ºç¯„æ¨¡å¼ï¼‰',
                        userData: {
                            lineName: data.lineName,
                            realName: data.realName,
                            idNumber: data.idNumber,
                            phoneNumber: data.phoneNumber,
                            registrationTime: new Date(),
                            status: 'å·²ç™»è¨˜'
                        }
                    };
                    
                case 'orders':
                    return {
                        success: true,
                        orders: [
                            {
                                orderId: 'ORDER001',
                                lineName: data.lineName,
                                realName: 'ç¤ºç¯„ç”¨æˆ¶',
                                productName: 'ç¤ºç¯„å•†å“A',
                                quantity: 2,
                                unitPrice: 500,
                                totalPrice: 1000,
                                status: 'å¾…ä»˜æ¬¾',
                                createdAt: new Date(),
                                note: 'ç¤ºç¯„è¨‚å–®'
                            }
                        ],
                        totalAmount: 1000,
                        userData: {
                            lineName: data.lineName,
                            realName: 'ç¤ºç¯„ç”¨æˆ¶',
                            status: 'å·²ç™»è¨˜'
                        }
                    };
                    
                case 'submit-payment':
                    return { success: true, message: 'ç¹³è²»è­‰æ˜æäº¤æˆåŠŸï¼ˆç¤ºç¯„æ¨¡å¼ï¼‰' };
                    
                case 'check-admin':
                    return {
                        success: true,
                        isAdmin: true,
                        role: 'admin',
                        adminData: { name: 'ç¤ºç¯„ç®¡ç†å“¡', lineId: data.userId }
                    };
                    
                default:
                    return { success: false, message: 'æœªçŸ¥çš„ç¤ºç¯„æ“ä½œ' };
            }
        }

        // ==================== ç®¡ç†å“¡åŠŸèƒ½ ====================

        // æª¢æŸ¥ä¸¦é¡¯ç¤ºç®¡ç†å“¡é¢æ¿
        async function checkAndShowAdminPanel() {
            try {
                if (!liffProfile) {
                    showError('è«‹å…ˆç™»å…¥ LINE');
                    return;
                }
                
                const result = await callAPIWithRetry('check-admin', {
                    userId: liffProfile.userId,
                    requiredRole: 'viewer'
                });
                
                if (result.success && result.isAdmin) {
                    isAdminUser = true;
                    showAdminPanel(result);
                } else {
                    showError('æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™');
                }
                
            } catch (error) {
                debugLog('æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™å¤±æ•—', error);
                showError('æ¬Šé™æª¢æŸ¥å¤±æ•—');
            }
        }

        // é¡¯ç¤ºç®¡ç†å“¡é¢æ¿
        function showAdminPanel(adminInfo) {
            const adminWelcome = document.getElementById('adminWelcome');
            if (adminWelcome) {
                adminWelcome.textContent = `æ­¡è¿ï¼Œ${adminInfo.adminData.name}ï¼ˆ${adminInfo.role}ï¼‰`;
            }
            
            showSection('adminSection');
            showAdminTab('dashboard');
        }

        // é¡¯ç¤ºç®¡ç†å“¡æ¨™ç±¤é 
        async function showAdminTab(tabName) {
            // æ›´æ–°æ¨™ç±¤ç‹€æ…‹
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`[onclick="showAdminTab('${tabName}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            currentAdminTab = tabName;
            const adminContent = document.getElementById('adminContent');
            
            try {
                switch (tabName) {
                    case 'dashboard':
                        await loadAdminDashboard();
                        break;
                    case 'users':
                        await loadUserManagement();
                        break;
                    case 'payments':
                        await loadPaymentManagement();
                        break;
                    case 'admins':
                        await loadAdminManagement();
                        break;
                }
            } catch (error) {
                debugLog(`è¼‰å…¥ç®¡ç†å“¡æ¨™ç±¤é å¤±æ•—: ${tabName}`, error);
                adminContent.innerHTML = `<div class="alert alert-error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
            }
        }

        // è¼‰å…¥ç®¡ç†å“¡å„€è¡¨æ¿
        async function loadAdminDashboard() {
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">-</div>
                        <div class="stat-label">ç¸½ç”¨æˆ¶æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalOrders">-</div>
                        <div class="stat-label">ç¸½è¨‚å–®æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingPayments">-</div>
                        <div class="stat-label">å¾…å¯©æ ¸ç¹³è²»</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalAmount">-</div>
                        <div class="stat-label">ç¸½é‡‘é¡</div>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <strong>ğŸ“Š ç³»çµ±çµ±è¨ˆ</strong><br>
                    è¼‰å…¥ä¸­...
                </div>
            `;
            
            // é€™è£¡å¯ä»¥åŠ è¼‰å¯¦éš›çš„çµ±è¨ˆè³‡æ–™
            // ç¤ºç¯„è³‡æ–™
            setTimeout(() => {
                document.getElementById('totalUsers').textContent = '128';
                document.getElementById('totalOrders').textContent = '256';
                document.getElementById('pendingPayments').textContent = '12';
                document.getElementById('totalAmount').textContent = 'NT$ 128,000';
            }, 1000);
        }

        // è¼‰å…¥ç”¨æˆ¶ç®¡ç†
        async function loadUserManagement() {
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="search-box">
                    <input type="text" placeholder="æœå°‹ç”¨æˆ¶..." onkeyup="searchUsers(this.value)">
                </div>
                
                <div class="alert alert-info">
                    <strong>ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</strong><br>
                    ç®¡ç†æ‰€æœ‰è¨»å†Šç”¨æˆ¶
                </div>
                
                <div id="usersList">è¼‰å…¥ä¸­...</div>
            `;
            
            // è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨
            setTimeout(() => {
                document.getElementById('usersList').innerHTML = `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-id">ç¤ºç¯„ç”¨æˆ¶1</div>
                            <div class="order-status">å·²ç™»è¨˜</div>
                        </div>
                        <div class="order-details">
                            <div>LINE: ç¤ºç¯„ç”¨æˆ¶1</div>
                            <div>è¨»å†Šæ™‚é–“: 2024-01-15 10:30</div>
                            <div>è¨‚å–®æ•¸: 3</div>
                        </div>
                    </div>
                `;
            }, 1000);
        }

        // è¼‰å…¥ç¹³è²»ç®¡ç†
        async function loadPaymentManagement() {
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="alert alert-warning">
                    <strong>ğŸ’³ ç¹³è²»ç®¡ç†</strong><br>
                    å¯©æ ¸ç”¨æˆ¶æäº¤çš„ç¹³è²»è­‰æ˜
                </div>
                
                <div class="admin-tabs" style="margin-top: 20px;">
                    <button class="admin-tab active" onclick="filterPayments('pending')">å¾…å¯©æ ¸</button>
                    <button class="admin-tab" onclick="filterPayments('approved')">å·²ç¢ºèª</button>
                    <button class="admin-tab" onclick="filterPayments('rejected')">å·²æ‹’çµ•</button>
                </div>
                
                <div id="paymentsList">è¼‰å…¥ä¸­...</div>
            `;
            
            // è¼‰å…¥ç¹³è²»åˆ—è¡¨
            setTimeout(() => {
                document.getElementById('paymentsList').innerHTML = `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-id">PAY001</div>
                            <div class="order-status pending">å¾…å¯©æ ¸</div>
                        </div>
                        <div class="order-details">
                            <div>ç”¨æˆ¶: ç¤ºç¯„ç”¨æˆ¶</div>
                            <div>é‡‘é¡: NT$ 1,000</div>
                            <div>æ–¹å¼: éŠ€è¡Œè½‰å¸³</div>
                            <div>æäº¤æ™‚é–“: 2024-01-15 14:20</div>
                            <div style="margin-top: 10px;">
                                <button class="btn" style="padding: 5px 15px; margin-right: 10px;" onclick="reviewPayment('PAY001', 'approved')">ç¢ºèª</button>
                                <button class="btn btn-danger" style="padding: 5px 15px;" onclick="reviewPayment('PAY001', 'rejected')">æ‹’çµ•</button>
                            </div>
                        </div>
                    </div>
                `;
            }, 1000);
        }

        // è¼‰å…¥ç®¡ç†å“¡ç®¡ç†
        async function loadAdminManagement() {
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="alert alert-success">
                    <strong>ğŸ› ï¸ ç®¡ç†å“¡ç®¡ç†</strong><br>
                    ç®¡ç†ç³»çµ±ç®¡ç†å“¡
                </div>
                
                <button class="btn" onclick="showAddAdminForm()" style="margin-bottom: 20px;">
                    â• æ–°å¢ç®¡ç†å“¡
                </button>
                
                <div id="adminsList">è¼‰å…¥ä¸­...</div>
            `;
            
            // è¼‰å…¥ç®¡ç†å“¡åˆ—è¡¨
            setTimeout(() => {
                document.getElementById('adminsList').innerHTML = `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-id">ç³»çµ±ç®¡ç†å“¡</div>
                            <div class="order-status">admin</div>
                        </div>
                        <div class="order-details">
                            <div>LINE ID: ${liffProfile?.userId || 'U1234567890'}</div>
                            <div>æ¬Šé™: ç³»çµ±ç®¡ç†å“¡</div>
                        </div>
                    </div>
                `;
            }, 1000);
        }

        // æœå°‹ç”¨æˆ¶
        function searchUsers(keyword) {
            debugLog('æœå°‹ç”¨æˆ¶', { keyword });
            // å¯¦ä½œæœå°‹é‚è¼¯
        }

        // ç¯©é¸ç¹³è²»è¨˜éŒ„
        function filterPayments(status) {
            debugLog('ç¯©é¸ç¹³è²»è¨˜éŒ„', { status });
            // å¯¦ä½œç¯©é¸é‚è¼¯
        }

        // å¯©æ ¸ç¹³è²»
        function reviewPayment(paymentId, status) {
            if (confirm(`ç¢ºå®šè¦${status === 'approved' ? 'ç¢ºèª' : 'æ‹’çµ•'}æ­¤ç¹³è²»è¨˜éŒ„å—ï¼Ÿ`)) {
                debugLog('å¯©æ ¸ç¹³è²»', { paymentId, status });
                showSuccess(`ç¹³è²»è¨˜éŒ„å·²${status === 'approved' ? 'ç¢ºèª' : 'æ‹’çµ•'}`);
                // é‡æ–°è¼‰å…¥åˆ—è¡¨
                loadPaymentManagement();
            }
        }

        // è¿”å›ä¸»ç³»çµ±
        function backToMainSystem() {
            if (currentOrderSummary) {
                showSection('ordersSection');
            } else {
                showSection('registrationSection');
            }
        }

        // ==================== åˆå§‹åŒ–å’Œäº‹ä»¶è™•ç† ====================

        // åˆå§‹åŒ– LIFF
        async function initializeLiff() {
            try {
                debugLog('é–‹å§‹åˆå§‹åŒ– LIFF');
                showProgress(10);
                
                // å…ˆè¼‰å…¥ç³»çµ±è¨­å®š
                await loadSystemConfig();
                showProgress(30);
                
                // æª¢æŸ¥ç³»çµ±ç¶­è­·æ¨¡å¼
                if (systemConfig?.basic?.['ç³»çµ±ç¶­è­·æ¨¡å¼']) {
                    showMaintenanceMode();
                    return;
                }
                
                updateLiffStatus('åˆå§‹åŒ–ä¸­...', false);
                
                if (typeof liff === 'undefined') {
                    throw new Error('LIFF SDK æœªè¼‰å…¥');
                }
                
                await liff.init({ liffId: CONFIG.LIFF_ID });
                debugLog('LIFF åˆå§‹åŒ–æˆåŠŸ');
                showProgress(60);
                
                // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                if (liff.isLoggedIn()) {
                    debugLog('ç”¨æˆ¶å·²ç™»å…¥ LINE');
                    
                    // å–å¾—ç”¨æˆ¶è³‡æ–™
                    liffProfile = await liff.getProfile();
                    debugLog('å–å¾—ç”¨æˆ¶è³‡æ–™', liffProfile);
                    showProgress(80);
                    
                    // é¡¯ç¤º LIFF ç’°å¢ƒè³‡è¨Š
                    displayLiffInfo();
                    
                    // å¡«å…¥ LINE åç¨±
                    const lineNameInput = document.getElementById('lineName');
                    if (lineNameInput) {
                        lineNameInput.value = liffProfile.displayName;
                    }
                    
                    // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
                    await checkAdminPermission();
                    
                    // æª¢æŸ¥ç”¨æˆ¶ç™»è¨˜ç‹€æ…‹
                    await checkRegistrationStatus();
                    showProgress(100);
                    
                    updateLiffStatus('å·²é€£ç·š', true);
                } else {
                    debugLog('ç”¨æˆ¶æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
                    liff.login();
                }
                
                setTimeout(() => showProgress(0), 500);
                
            } catch (error) {
                debugLog('LIFF åˆå§‹åŒ–å¤±æ•—', error);
                console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                updateLiffStatus('é€£ç·šå¤±æ•—', false);
                showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                showProgress(0);
                
                // å¦‚æœæ˜¯é–‹ç™¼æ¨¡å¼ï¼Œä½¿ç”¨ç¤ºç¯„è³‡æ–™
                if (CONFIG.DEMO_MODE) {
                    liffProfile = { displayName: 'ç¤ºç¯„ç”¨æˆ¶', userId: 'demo123' };
                    document.getElementById('lineName').value = liffProfile.displayName;
                    await checkRegistrationStatus();
                }
            }
        }

        // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
        async function checkAdminPermission() {
            try {
                if (!liffProfile) return;
                
                const result = await callAPI('check-admin', {
                    userId: liffProfile.userId,
                    requiredRole: 'viewer'
                });
                
                if (result.success && result.isAdmin) {
                    isAdminUser = true;
                    const adminToggle = document.getElementById('adminToggle');
                    if (adminToggle) {
                        adminToggle.style.display = 'block';
                    }
                    debugLog('ç”¨æˆ¶å…·æœ‰ç®¡ç†å“¡æ¬Šé™', result);
                }
                
            } catch (error) {
                debugLog('æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™æ™‚ç™¼ç”ŸéŒ¯èª¤', error);
                // ä¸å½±éŸ¿æ­£å¸¸æµç¨‹ï¼Œéœé»˜è™•ç†
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–');
            
            // æª¢æŸ¥ API é€£ç·šç‹€æ…‹
            await checkAPIStatus();
            
            // åˆå§‹åŒ– LIFF
            await initializeLiff();
            
            // ç¶å®šäº‹ä»¶è™•ç†å™¨
            setupEventHandlers();
        });

        // è¨­å®šäº‹ä»¶è™•ç†å™¨
        function setupEventHandlers() {
            // å¯¦ååˆ¶ç™»è¨˜è¡¨å–®
            const registrationForm = document.getElementById('registrationForm');
            if (registrationForm) {
                registrationForm.addEventListener('submit', handleRegistration);
            }
            
            // èº«åˆ†è­‰å­—è™Ÿè‡ªå‹•è½‰å¤§å¯«
            const idNumberInput = document.getElementById('idNumber');
            if (idNumberInput) {
                idNumberInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.toUpperCase();
                });
            }
            
            // æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼åŒ–
            const phoneNumberInput = document.getElementById('phoneNumber');
            if (phoneNumberInput) {
                phoneNumberInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 10) {
                        value = value.slice(0, 10);
                    }
                    e.target.value = value;
                });
            }
            
            // å‰å¾€ç¹³è²»æŒ‰éˆ•
            const proceedToPaymentBtn = document.getElementById('proceedToPaymentBtn');
            if (proceedToPaymentBtn) {
                proceedToPaymentBtn.addEventListener('click', () => {
                    showSection('paymentSection');
                });
            }
            
            // é‡æ–°æ•´ç†è¨‚å–®æŒ‰éˆ•
            const refreshOrdersBtn = document.getElementById('refreshOrdersBtn');
            if (refreshOrdersBtn) {
                refreshOrdersBtn.addEventListener('click', async () => {
                    refreshOrdersBtn.disabled = true;
                    refreshOrdersBtn.textContent = 'ğŸ”„ é‡æ–°æ•´ç†ä¸­...';
                    
                    try {
                        await loadUserOrders();
                        showSuccess('è¨‚å–®å·²æ›´æ–°');
                    } catch (error) {
                        showError('æ›´æ–°å¤±æ•—');
                    } finally {
                        refreshOrdersBtn.disabled = false;
                        refreshOrdersBtn.textContent = 'ğŸ”„ é‡æ–°æ•´ç†è¨‚å–®';
                    }
                });
            }
            
            // è¿”å›è¨‚å–®åˆ—è¡¨æŒ‰éˆ•
            const backToOrdersBtn = document.getElementById('backToOrdersBtn');
            if (backToOrdersBtn) {
                backToOrdersBtn.addEventListener('click', () => {
                    showSection('ordersSection');
                });
            }
            
            // æª”æ¡ˆæ‹–æ”¾è™•ç†
            setupFileUpload();
            
            debugLog('äº‹ä»¶è™•ç†å™¨è¨­å®šå®Œæˆ');
        }

        // è¨­å®šæª”æ¡ˆä¸Šå‚³åŠŸèƒ½
        function setupFileUpload() {
            const uploadArea = document.querySelector('.upload-area');
            if (!uploadArea) return;
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const paymentProofInput = document.getElementById('paymentProof');
                    if (paymentProofInput) {
                        paymentProofInput.files = files;
                        handleFileUpload(paymentProofInput);
                    }
                }
            });
        }

        // å…¶ä»–å¿…è¦å‡½æ•¸ï¼ˆä¿æŒåŸæœ‰é‚è¼¯ï¼‰
        async function loadSystemConfig() {
            // åŸæœ‰é‚è¼¯ä¿æŒä¸è®Š
            try {
                debugLog('è¼‰å…¥ç³»çµ±è¨­å®š');
                
                const result = await callAPI('get-config', {});
                
                if (result.success) {
                    systemConfig = result.config;
                    debugLog('ç³»çµ±è¨­å®šè¼‰å…¥æˆåŠŸ', systemConfig);
                    applySystemConfig();
                    return true;
                } else {
                    debugLog('è¼‰å…¥ç³»çµ±è¨­å®šå¤±æ•—', result);
                    systemConfig = getDefaultFrontendConfig();
                    applySystemConfig();
                    return false;
                }
            } catch (error) {
                debugLog('è¼‰å…¥ç³»çµ±è¨­å®šå¤±æ•—', error);
                console.error('è¼‰å…¥ç³»çµ±è¨­å®šå¤±æ•—:', error);
                systemConfig = getDefaultFrontendConfig();
                applySystemConfig();
                return false;
            }
        }

        function getDefaultFrontendConfig() {
            return {
                basic: {
                    'APIé€£ç·šç‹€æ…‹é¡¯ç¤º': true,
                    'é™¤éŒ¯è³‡è¨Šé¡¯ç¤º': false,
                    'LIFFç’°å¢ƒè³‡è¨Šé¡¯ç¤º': false,
                    'ç¹³è²»è­‰æ˜ä¸Šå‚³': 'å¿…é ˆ',
                    'å‚™è¨»æ¬„ä½é¡¯ç¤º': true,
                    'ç³»çµ±ç¶­è­·æ¨¡å¼': false,
                    'æœ€å¤§æª”æ¡ˆå¤§å°MB': 5,
                    'å…è¨±æª”æ¡ˆæ ¼å¼': ['jpg', 'png', 'pdf']
                },
                paymentMethods: [
                    { code: 'bank_transfer', name: 'éŠ€è¡Œè½‰å¸³', enabled: true },
                    { code: 'cash', name: 'ç¾é‡‘ç¹³è²»', enabled: true }
                ],
                messages: {
                    welcome_message: 'æ­¡è¿ä½¿ç”¨æœ¬ç³»çµ±ï¼',
                    upload_success: 'ç¹³è²»è­‰æ˜ä¸Šå‚³æˆåŠŸï¼',
                    upload_error: 'ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼',
                    registration_success: 'å¯¦ååˆ¶ç™»è¨˜å®Œæˆï¼'
                }
            };
        }

        function applySystemConfig() {
            if (!systemConfig) return;
            
            const config = systemConfig.basic;
            
            // æ§åˆ¶å„ç¨®é¡¯ç¤ºè¨­å®š
            const statusBar = document.querySelector('.status-bar');
            if (statusBar) {
                statusBar.style.display = config['APIé€£ç·šç‹€æ…‹é¡¯ç¤º'] ? 'flex' : 'none';
            }
            
            CONFIG.DEBUG_MODE = config['é™¤éŒ¯è³‡è¨Šé¡¯ç¤º'];
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo) {
                debugInfo.classList.toggle('hidden', !CONFIG.DEBUG_MODE);
            }
            
            const liffInfo = document.getElementById('liffInfo');
            if (liffInfo) {
                liffInfo.classList.toggle('hidden', !config['LIFFç’°å¢ƒè³‡è¨Šé¡¯ç¤º']);
            }
            
            if (config['ç³»çµ±ç¶­è­·æ¨¡å¼']) {
                showMaintenanceMode();
                return;
            }
            
            updatePaymentMethods();
            updateFileUploadSettings();
            updateNoteFieldVisibility();
            
            debugLog('ç³»çµ±è¨­å®šå·²å¥—ç”¨', config);
        }

        function showMaintenanceMode() {
            const message = systemConfig?.messages?.maintenance_message || 'ç³»çµ±ç¶­è­·ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦';
            
            document.body.innerHTML = `
                <div class="maintenance-mode">
                    <div class="maintenance-card">
                        <div class="maintenance-icon">ğŸ”§</div>
                        <h2 style="color: #333; margin-bottom: 10px;">ç³»çµ±ç¶­è­·ä¸­</h2>
                        <p style="color: #666;">${message}</p>
                    </div>
                </div>
            `;
        }

        function updatePaymentMethods() {
            const paymentMethodSelect = document.getElementById('paymentMethod');
            if (!paymentMethodSelect || !systemConfig?.paymentMethods) return;
            
            const firstOption = paymentMethodSelect.firstElementChild;
            paymentMethodSelect.innerHTML = '';
            paymentMethodSelect.appendChild(firstOption);
            
            systemConfig.paymentMethods.forEach(method => {
                const option = document.createElement('option');
                option.value = method.code;
                option.textContent = method.name;
                paymentMethodSelect.appendChild(option);
            });
            
            debugLog('ç¹³è²»æ–¹å¼é¸é …å·²æ›´æ–°', systemConfig.paymentMethods);
        }

        function updateFileUploadSettings() {
            const config = systemConfig?.basic || {};
            const paymentProofInput = document.getElementById('paymentProof');
            const uploadArea = document.querySelector('.upload-area');
            
            if (!paymentProofInput || !uploadArea) return;
            
            const             isRequired = config['ç¹³è²»è­‰æ˜ä¸Šå‚³'] === 'å¿…é ˆ';
            
            if (!isRequired) {
                const uploadText = uploadArea.querySelector('p');
                if (uploadText) {
                    uploadText.textContent = 'é»æ“Šä¸Šå‚³ç¹³è²»è­‰æ˜ç…§ç‰‡ï¼ˆé¸å¡«ï¼‰';
                }
            }
            
            const allowedFormats = config['å…è¨±æª”æ¡ˆæ ¼å¼'];
            if (allowedFormats && Array.isArray(allowedFormats)) {
                const acceptString = allowedFormats.map(format => {
                    if (format === 'jpg') return 'image/jpeg';
                    if (format === 'png') return 'image/png';
                    if (format === 'pdf') return 'application/pdf';
                    return `image/${format}`;
                }).join(',');
                
                paymentProofInput.setAttribute('accept', acceptString);
                
                const uploadText = uploadArea.querySelector('small');
                if (uploadText) {
                    uploadText.textContent = `æ”¯æ´ ${allowedFormats.join(', ').toUpperCase()} æ ¼å¼ï¼Œæª”æ¡ˆå¤§å°é™åˆ¶ ${config['æœ€å¤§æª”æ¡ˆå¤§å°MB'] || 5}MB`;
                }
            }
            
            const maxSizeMB = config['æœ€å¤§æª”æ¡ˆå¤§å°MB'] || 5;
            paymentProofInput.setAttribute('data-max-size', maxSizeMB * 1024 * 1024);
            
            debugLog('æª”æ¡ˆä¸Šå‚³è¨­å®šå·²æ›´æ–°', {
                required: isRequired,
                formats: allowedFormats,
                maxSize: maxSizeMB
            });
        }

        function updateNoteFieldVisibility() {
            const noteFieldGroup = document.getElementById('noteFieldGroup');
            if (noteFieldGroup) {
                const showNote = systemConfig?.basic?.['å‚™è¨»æ¬„ä½é¡¯ç¤º'];
                noteFieldGroup.style.display = showNote ? 'block' : 'none';
            }
        }

        function displayLiffInfo() {
            if (!systemConfig?.basic?.['LIFFç’°å¢ƒè³‡è¨Šé¡¯ç¤º']) return;
            
            const liffDetails = document.getElementById('liffDetails');
            if (liffDetails && liffProfile) {
                liffDetails.innerHTML = `
                    <div>ç”¨æˆ¶ID: ${liffProfile.userId}</div>
                    <div>é¡¯ç¤ºåç¨±: ${liffProfile.displayName}</div>
                    <div>ç’°å¢ƒ: ${liff.getOS()}</div>
                    <div>ç‰ˆæœ¬: ${liff.getVersion()}</div>
                `;
                document.getElementById('liffInfo').classList.remove('hidden');
            }
        }

        function updateLiffStatus(message, success) {
            const liffIndicator = document.getElementById('liffIndicator');
            const liffStatus = document.getElementById('liffStatus');
            
            if (liffIndicator && liffStatus) {
                liffIndicator.className = `status-indicator ${success ? 'success' : ''}`;
                liffStatus.textContent = message;
            }
        }

        async function checkAPIStatus() {
            try {
                debugLog('æª¢æŸ¥ API é€£ç·šç‹€æ…‹');
                updateAPIStatus('æª¢æŸ¥ä¸­...', false);
                
                const result = await callAPI('test');
                
                if (result.success) {
                    debugLog('API é€£ç·šæ­£å¸¸', result);
                    updateAPIStatus('é€£ç·šæ­£å¸¸', true);
                    return true;
                } else {
                    debugLog('API é€£ç·šç•°å¸¸', result);
                    updateAPIStatus('é€£ç·šç•°å¸¸', false);
                    return false;
                }
            } catch (error) {
                debugLog('API é€£ç·šæª¢æŸ¥å¤±æ•—', error);
                updateAPIStatus('é€£ç·šå¤±æ•—', false);
                return false;
            }
        }

        function updateAPIStatus(message, success) {
            const apiIndicator = document.getElementById('apiIndicator');
            const apiStatus = document.getElementById('apiStatus');
            
            if (apiIndicator && apiStatus) {
                apiIndicator.className = `status-indicator ${success ? 'success' : ''}`;
                apiStatus.textContent = message;
            }
        }

        async function checkRegistrationStatus() {
            try {
                debugLog('æª¢æŸ¥ç”¨æˆ¶ç™»è¨˜ç‹€æ…‹');
                
                if (!liffProfile) {
                    showError('ç„¡æ³•å–å¾—ç”¨æˆ¶è³‡æ–™');
                    return;
                }
                
                const result = await callAPIWithRetry('check-registration', {
                    lineName: liffProfile.displayName
                });
                
                if (result.success) {
                    if (result.registered) {
                        debugLog('ç”¨æˆ¶å·²å®Œæˆç™»è¨˜', result.userData);
                        await loadUserOrders();
                    } else {
                        debugLog('ç”¨æˆ¶å°šæœªç™»è¨˜');
                        showSection('registrationSection');
                    }
                } else {
                    debugLog('æª¢æŸ¥ç™»è¨˜ç‹€æ…‹å¤±æ•—', result);
                    showError(result.message || 'æª¢æŸ¥ç™»è¨˜ç‹€æ…‹å¤±æ•—');
                }
                
            } catch (error) {
                debugLog('æª¢æŸ¥ç™»è¨˜ç‹€æ…‹å¤±æ•—', error);
                console.error('æª¢æŸ¥ç™»è¨˜ç‹€æ…‹å¤±æ•—:', error);
                showError('æª¢æŸ¥ç™»è¨˜ç‹€æ…‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function handleRegistration(event) {
            event.preventDefault();
            
            try {
                debugLog('è™•ç†ç”¨æˆ¶ç™»è¨˜');
                
                const formData = {
                    lineName: document.getElementById('lineName').value,
                    realName: document.getElementById('realName').value,
                    idNumber: document.getElementById('idNumber').value.toUpperCase(),
                    phoneNumber: document.getElementById('phoneNumber').value
                };
                
                // å‰ç«¯é©—è­‰
                if (!formData.realName || !formData.idNumber || !formData.phoneNumber) {
                    showError('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');
                    return;
                }
                
                const idPattern = /^[A-Z][12]\d{8}$/;
                if (!idPattern.test(formData.idNumber)) {
                    showError('èº«åˆ†è­‰å­—è™Ÿæ ¼å¼ä¸æ­£ç¢º');
                    return;
                }
                
                const phonePattern = /^09\d{8}$/;
                if (!phonePattern.test(formData.phoneNumber)) {
                    showError('é›»è©±è™Ÿç¢¼æ ¼å¼ä¸æ­£ç¢ºï¼ˆè«‹è¼¸å…¥09é–‹é ­çš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼‰');
                    return;
                }
                
                const submitBtn = document.getElementById('registerBtn');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'ç™»è¨˜ä¸­...';
                submitBtn.disabled = true;
                
                const result = await callAPIWithRetry('register', formData);
                
                if (result.success) {
                    debugLog('ç”¨æˆ¶ç™»è¨˜æˆåŠŸ', result);
                    const successMessage = systemConfig?.messages?.registration_success || 'å¯¦ååˆ¶ç™»è¨˜å®Œæˆï¼';
                    showSuccess(successMessage);
                    
                    setTimeout(async () => {
                        await loadUserOrders();
                    }, 1500);
                } else {
                    debugLog('ç”¨æˆ¶ç™»è¨˜å¤±æ•—', result);
                    showError(result.message || 'ç™»è¨˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
                
            } catch (error) {
                debugLog('ç”¨æˆ¶ç™»è¨˜å¤±æ•—', error);
                console.error('ç”¨æˆ¶ç™»è¨˜å¤±æ•—:', error);
                showError('ç™»è¨˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                
                const submitBtn = document.getElementById('registerBtn');
                if (submitBtn) {
                    submitBtn.textContent = 'å®Œæˆå¯¦ååˆ¶ç™»è¨˜';
                    submitBtn.disabled = false;
                }
            }
        }

        async function loadUserOrders() {
            try {
                debugLog('è¼‰å…¥ç”¨æˆ¶è¨‚å–®');
                
                if (!liffProfile) {
                    showError('ç„¡æ³•å–å¾—ç”¨æˆ¶è³‡æ–™');
                    return;
                }
                
                const result = await callAPIWithRetry('orders', {
                    lineName: liffProfile.displayName
                });
                
                if (result.success) {
                    debugLog('è¨‚å–®è¼‰å…¥æˆåŠŸ', result);
                    
                    const userInfo = document.getElementById('userInfo');
                    if (userInfo && result.userData) {
                        userInfo.textContent = `å§“åï¼š${result.userData.realName} | ç™»è¨˜æ™‚é–“ï¼š${new Date(result.userData.registrationTime).toLocaleString()}`;
                    }
                    
                    displayOrders(result.orders, result.totalAmount);
                    
                    currentOrderSummary = {
                        orders: result.orders,
                        totalAmount: result.totalAmount,
                        userData: result.userData,
                        lineName: liffProfile.displayName,
                        realName: result.userData.realName,
                        orderId: result.orders.map(o => o.orderId).join(',')
                    };
                    
                    showSection('ordersSection');
                } else {
                    debugLog('è¼‰å…¥è¨‚å–®å¤±æ•—', result);
                    if (result.needRegistration) {
                        showSection('registrationSection');
                    } else {
                        showError(result.message || 'è¼‰å…¥è¨‚å–®å¤±æ•—');
                    }
                }
                
            } catch (error) {
                debugLog('è¼‰å…¥è¨‚å–®å¤±æ•—', error);
                console.error('è¼‰å…¥è¨‚å–®å¤±æ•—:', error);
                showError('è¼‰å…¥è¨‚å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        function displayOrders(orders, totalAmount) {
            const container = document.getElementById('ordersContainer');
            const totalAmountElement = document.getElementById('totalAmount');
            
            if (!container || !totalAmountElement) return;
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <strong>ğŸ“‹ æš«ç„¡è¨‚å–®</strong><br>
                        ç›®å‰æ²’æœ‰æ‰¾åˆ°æ‚¨çš„è¨‚å–®è³‡æ–™ã€‚
                    </div>
                `;
                totalAmountElement.textContent = 'NT$ 0';
                return;
            }
            
            container.innerHTML = orders.map(order => {
                const statusClass = order.status === 'å¾…ä»˜æ¬¾' ? 'pending' : 
                                  order.status === 'å·²å®Œæˆ' ? 'completed' : 
                                  order.status === 'å·²å–æ¶ˆ' ? 'cancelled' : '';
                
                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-id">è¨‚å–® ${order.orderId}</div>
                            <div class="order-status ${statusClass}">${order.status}</div>
                        </div>
                        <div class="order-details">
                            <div><strong>${order.productName}</strong></div>
                            <div>æ•¸é‡ï¼š${order.quantity} | å–®åƒ¹ï¼šNT$ ${order.unitPrice?.toLocaleString()}</div>
                            <div>å°è¨ˆï¼šNT$ ${order.totalPrice?.toLocaleString()}</div>
                            ${order.note ? `<div>å‚™è¨»ï¼š${order.note}</div>` : ''}
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                å»ºç«‹æ™‚é–“ï¼š${new Date(order.createdAt).toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            totalAmountElement.textContent = `NT$ ${totalAmount.toLocaleString()}`;
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            const config = systemConfig?.basic || {};
            const maxSizeMB = config['æœ€å¤§æª”æ¡ˆå¤§å°MB'] || 5;
            const maxSizeBytes = maxSizeMB * 1024 * 1024;
            const allowedFormats = config['å…è¨±æª”æ¡ˆæ ¼å¼'] || ['jpg', 'png', 'pdf'];
            
            if (file.size > maxSizeBytes) {
                showError(`æª”æ¡ˆå¤§å°è¶…éé™åˆ¶ï¼ˆæœ€å¤§ ${maxSizeMB}MBï¼‰`);
                input.value = '';
                return;
            }
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!allowedFormats.includes(fileExtension)) {
                showError(`ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼Œè«‹ä½¿ç”¨ï¼š${allowedFormats.join(', ').toUpperCase()}`);
                input.value = '';
                return;
            }
            
            debugLog('æª”æ¡ˆé©—è­‰é€šé', { 
                name: file.name, 
                size: file.size, 
                type: file.type,
                extension: fileExtension
            });
            
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.innerHTML = `
                <div class="upload-icon">âœ…</div>
                <p>å·²é¸æ“‡: ${file.name}</p>
                <small>æª”æ¡ˆå¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB</small>
            `;
            uploadArea.style.background = '#d4edda';
            uploadArea.style.borderColor = '#28a745';
            
            showSuccess('æª”æ¡ˆé¸æ“‡æˆåŠŸ');
        }

        async function submitPayment() {
            debugLog('æäº¤ç¹³è²»è­‰æ˜');
            
            if (!currentOrderSummary) {
                showError('ç„¡æ³•å–å¾—è¨‚å–®è³‡è¨Šï¼Œè«‹é‡æ–°è¼‰å…¥');
                return;
            }
            
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paymentNote = document.getElementById('paymentNote').value;
            const paymentProof = document.getElementById('paymentProof').files[0];
            
            if (!paymentMethod) {
                showError('è«‹é¸æ“‡ç¹³è²»æ–¹å¼');
                return;
            }
            
            const isFileRequired = systemConfig?.basic?.['ç¹³è²»è­‰æ˜ä¸Šå‚³'] === 'å¿…é ˆ';
            
            if (isFileRequired && !paymentProof) {
                showError('è«‹ä¸Šå‚³ç¹³è²»è­‰æ˜');
                return;
            }
            
            const paymentData = {
                orderId: currentOrderSummary.orderId,
                lineName: currentOrderSummary.lineName,
                realName: currentOrderSummary.realName,
                paymentAmount: currentOrderSummary.totalAmount,
                paymentMethod: paymentMethod,
                paymentNote: paymentNote,
                hasProof: !!paymentProof,
                submittedAt: new Date().toISOString()
            };
            
            try {
                const submitBtn = document.getElementById('submitPaymentBtn');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'æäº¤ä¸­...';
                submitBtn.disabled = true;
                
                const result = await callAPIWithRetry('submit-payment', paymentData);
                
                if (result.success) {
                    debugLog('ç¹³è²»è­‰æ˜æäº¤æˆåŠŸ');
                    const successMessage = systemConfig?.messages?.upload_success || 'ç¹³è²»è­‰æ˜æäº¤æˆåŠŸï¼';
                    showSuccess(successMessage);
                    
                    // æ¸…ç©ºè¡¨å–®
                    document.getElementById('paymentNote').value = '';
                    document.getElementById('paymentProof').value = '';
                    document.getElementById('paymentMethod').selectedIndex = 0;
                    
                    // é‡ç½®ä¸Šå‚³å€åŸŸ
                    const uploadArea = document.querySelector('.upload-area');
                    uploadArea.innerHTML = `
                        <div class="upload-icon">ğŸ“·</div>
                        <p>é»æ“Šä¸Šå‚³ç¹³è²»è­‰æ˜ç…§ç‰‡</p>
                        <small>æ”¯æ´æ ¼å¼è«‹åƒè€ƒç³»çµ±è¨­å®š</small>
                    `;
                    uploadArea.style.background = '';
                    uploadArea.style.borderColor = '';
                    
                    submitBtn.textContent = 'âœ… å·²æäº¤';
                    submitBtn.disabled = true;
                    submitBtn.classList.add('btn-secondary');
                    
                    // 3ç§’å¾Œè¿”å›è¨‚å–®åˆ—è¡¨
                    setTimeout(() => {
                        showSection('ordersSection');
                    }, 3000);
                    
                } else {
                    debugLog('ç¹³è²»è­‰æ˜æäº¤å¤±æ•—', result);
                    const errorMessage = result.message || systemConfig?.messages?.upload_error || 'æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
                    showError(errorMessage);
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                debugLog('ç¹³è²»è­‰æ˜æäº¤å¤±æ•—', error);
                console.error('æäº¤ç¹³è²»è­‰æ˜å¤±æ•—:', error);
                const errorMessage = systemConfig?.messages?.upload_error || 'æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
                showError(errorMessage + ': ' + error.message);
                
                const submitBtn = document.getElementById('submitPaymentBtn');
                if (submitBtn) {
                    submitBtn.textContent = 'æäº¤ç¹³è²»è­‰æ˜';
                    submitBtn.disabled = false;
                }
            }
        }

        // å…¨åŸŸéŒ¯èª¤è™•ç†
        window.addEventListener('error', function(event) {
            debugLog('å…¨åŸŸéŒ¯èª¤', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            });
            
            console.error('å…¨åŸŸéŒ¯èª¤:', event.error);
            showError('ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
        });

        window.addEventListener('unhandledrejection', function(event) {
            debugLog('æœªè™•ç†çš„ Promise æ‹’çµ•', event.reason);
            console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', event.reason);
            showError('ç³»çµ±è™•ç†è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤');
        });

        // æ–°å¢ä¸€äº›å¯¦ç”¨å‡½æ•¸
        function formatCurrency(amount) {
            return new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'TWD'
            }).format(amount);
        }

        function formatDate(date) {
            return new Intl.DateTimeFormat('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).format(new Date(date));
        }

        function validateIdNumber(idNumber) {
            const pattern = /^[A-Z][12]\d{8}$/;
            if (!pattern.test(idNumber)) return false;
            
            // èº«åˆ†è­‰å­—è™Ÿæª¢æŸ¥ç¢¼é©—è­‰
            const letters = 'ABCDEFGHJKLMNPQRSTUVXYWZIO';
            const weights = [1, 9, 8, 7, 6, 5, 4, 3, 2, 1, 1];
            
            let sum = letters.indexOf(idNumber[0]) + 10;
            sum = Math.floor(sum / 10) + (sum % 10) * 9;
            
            for (let i = 1; i < 10; i++) {
                sum += parseInt(idNumber[i]) * weights[i];
            }
            
            return (sum % 10) === 0;
        }

        function validatePhoneNumber(phoneNumber) {
            const pattern = /^09\d{8}$/;
            return pattern.test(phoneNumber);
        }

        // å°å‡ºä¸€äº›å‡½æ•¸ä¾›å¤–éƒ¨ä½¿ç”¨
        window.systemFunctions = {
            showToast,
            showSuccess,
            showError,
            showInfo,
            debugLog,
            formatCurrency,
            formatDate,
            validateIdNumber,
            validatePhoneNumber
        };

        // åœ¨é–‹ç™¼æ¨¡å¼ä¸‹å°å‡ºæ›´å¤šå‡½æ•¸
        if (CONFIG.DEBUG_MODE) {
            window.debugFunctions = {
                callAPI,
                loadSystemConfig,
                checkRegistrationStatus,
                loadUserOrders,
                submitPayment,
                systemConfig,
                liffProfile,
                currentOrderSummary
            };
        }

    </script>

</body>
</html>
