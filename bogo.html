<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <title>資料管理系統</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .filter-section {
        margin-bottom: 20px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 5px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #4CAF50;
        color: white;
      }
      tr:nth-child(even) {
        background-color: #f2f2f2;
      }
      .btn {
        padding: 5px 10px;
        margin: 2px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      .btn-confirm {
        background-color: #4CAF50;
        color: white;
      }
      .btn-edit {
        background-color: #2196F3;
        color: white;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
      }
    </style>
  </head>
  <body>
    <h1>資料管理系統</h1>
    
    <div class="filter-section">
      <h3>篩選條件</h3>
      <label>B欄篩選：</label>
      <input type="text" id="filterB" onkeyup="applyFilters()">
      
      <label>C欄篩選：</label>
      <input type="text" id="filterC" onkeyup="applyFilters()">
      
      <label>G欄篩選：</label>
      <input type="text" id="filterG" onkeyup="applyFilters()">
    </div>

    <table id="dataTable">
      <thead>
        <tr>
          <th>B欄</th>
          <th>C欄</th>
          <th>G欄</th>
          <th>H欄</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="tableBody">
      </tbody>
    </table>

    <div id="editModal" class="modal">
      <div class="modal-content">
        <h2>修改資料</h2>
        <input type="hidden" id="editRowIndex">
        <p>
          <label>G欄：</label>
          <input type="text" id="editG">
        </p>
        <p>
          <label>H欄：</label>
          <input type="text" id="editH">
        </p>
        <button onclick="saveEdit()" class="btn btn-confirm">儲存</button>
        <button onclick="closeModal()" class="btn">取消</button>
      </div>
    </div>

    <script>
      let allData = [];
      
      // 載入資料
      function loadData() {
        google.script.run.withSuccessHandler(function(data) {
          allData = data;
          displayData(data);
        }).getData();
      }

      // 顯示資料
      function displayData(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        data.forEach((row, index) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row[1]}</td>
            <td>${row[2]}</td>
            <td>${row[6]}</td>
            <td>${row[7]}</td>
            <td>
              <button onclick="confirmRow(${index})" class="btn btn-confirm">確認</button>
              <button onclick="editRow(${index})" class="btn btn-edit">修改</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      // 篩選功能
      function applyFilters() {
        const filterB = document.getElementById('filterB').value.toLowerCase();
        const filterC = document.getElementById('filterC').value.toLowerCase();
        const filterG = document.getElementById('filterG').value.toLowerCase();
        
        const filteredData = allData.filter(row => {
          return (!filterB || row[1].toLowerCase().includes(filterB)) &&
                 (!filterC || row[2].toLowerCase().includes(filterC)) &&
                 (!filterG || row[6].toLowerCase().includes(filterG));
        });
        
        displayData(filteredData);
      }

      // 確認按鈕功能
      function confirmRow(index) {
        const row = allData[index];
        google.script.run.withSuccessHandler(function() {
          alert('確認成功！');
        }).confirmRow(index + 3); // 加3是因為試算表從A3開始
      }

      // 開啟編輯視窗
      function editRow(index) {
        const modal = document.getElementById('editModal');
        const row = allData[index];
        
        document.getElementById('editRowIndex').value = index;
        document.getElementById('editG').value = row[6];
        document.getElementById('editH').value = row[7];
        
        modal.style.display = 'block';
      }

      // 關閉編輯視窗
      function closeModal() {
        document.getElementById('editModal').style.display = 'none';
      }

      // 儲存編輯
      function saveEdit() {
        const index = parseInt(document.getElementById('editRowIndex').value);
        const newG = document.getElementById('editG').value;
        const newH = document.getElementById('editH').value;
        
        google.script.run.withSuccessHandler(function() {
          alert('修改成功！');
          closeModal();
          loadData(); // 重新載入資料
        }).updateRow(index + 3, newG, newH);
      }

      // 初始載入
      window.onload = function() {
        loadData();
      }
    </script>
  </body>
</html>
