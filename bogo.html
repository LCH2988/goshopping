<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¯¦ååˆ¶ç™»è¨˜èˆ‡ç¹³è²»ç³»çµ±</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 10px;
      }

      .container {
          max-width: 500px;
          margin: 0 auto;
          background: white;
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.2);
          overflow: hidden;
      }

      .header {
          background: linear-gradient(135deg, #4CAF50, #45a049);
          color: white;
          padding: 20px;
          text-align: center;
      }

      .header h1 {
          font-size: 24px;
          margin-bottom: 5px;
      }

      .header p {
          opacity: 0.9;
          font-size: 14px;
      }

      .content {
          padding: 20px;
      }

      .status-bar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #f8f9fa;
          padding: 10px 15px
          border-radius: 8px;
          margin-bottom: 20px;
          font-size: 12px;
      }

      .status-item {
          display: flex;
          align-items: center;
          gap: 5px;
      }

      .status-indicator {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background: #dc3545;
      }

      .status-indicator.success {
          background: #28a745;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #333;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
          width: 100%;
          padding: 12px;
          border: 2px solid #e9ecef;
          border-radius: 8px;
          font-size: 16px;
          transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
          outline: none;
          border-color: #4CAF50;
      }

      .btn {
          width: 100%;
          padding: 15px;
          background: linear-gradient(135deg, #4CAF50, #45a049);
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          margin-bottom: 10px;
      }

      .btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
      }

      .btn:disabled {
          background: #ccc;
          cursor: not-allowed;
          transform: none;
          box-shadow: none;
      }

      .btn-secondary {
          background: linear-gradient(135deg, #6c757d, #5a6268);
      }

      .btn-secondary:hover {
          box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
      }

      .upload-area {
          border: 2px dashed #ddd;
          border-radius: 8px;
          padding: 40px 20px;
          text-align: center;
          cursor: pointer;
          transition: all 0.3s;
          background: #fafafa;
      }

      .upload-area:hover {
          border-color: #4CAF50;
          background: #f0f8f0;
      }

      .upload-area.dragover {
          border-color: #4CAF50;
          background: #e8f5e8;
      }

      .upload-icon {
          font-size: 48px;
          margin-bottom: 10px;
      }

      .upload-area p {
          margin: 10px 0 5px 0;
          font-weight: 600;
          color: #333;
      }

      .upload-area small {
          color: #666;
          font-size: 12px;
      }

      .section {
          display: none;
          animation: fadeIn 0.5s ease-in;
      }

      .section.active {
          display: block;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .order-card {
          background: #f8f9fa;
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 15px;
          border-left: 4px solid #4CAF50;
      }

      .order-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
      }

      .order-id {
          font-weight: 600;
          color: #333;
      }

      .order-status {
          background: #4CAF50;
          color: white;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 12px;
      }

      .order-details {
          font-size: 14px;
          color: #666;
          line-height: 1.5;
      }

      .total-amount {
          background: #e3f2fd;
          padding: 15px;
          border-radius: 8px;
          text-align: center;
          margin: 20px 0;
      }

      .total-amount h3 {
          color: #1976d2;
          margin-bottom: 5px;
      }

      .total-amount .amount {
          font-size: 24px;
          font-weight: bold;
          color: #d32f2f;
      }

      .alert {
          padding: 12px 15px;
          border-radius: 8px;
          margin-bottom: 20px;
          font-size: 14px;
      }

      .alert-success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }

      .alert-error {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }

      .alert-info {
          background: #d1ecf1;
          color: #0c5460;
          border: 1px solid #bee5eb;
      }

      .loading {
          text-align: center;
          padding: 40px;
      }

      .loading::after {
          content: '';
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid #4CAF50;
          border-radius: 50%;
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .debug-info {
          background: #f8f9fa;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          padding: 15px;
          margin-top: 20px;
          font-family: monospace;
          font-size: 12px;
          max-height: 200px;
          overflow-y: auto;
      }

      .maintenance-mode {
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          background: #f5f5f5;
      }

      .maintenance-card {
          text-align: center;
          padding: 40px;
          background: white;
          border-radius: 10px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          max-width: 400px;
      }

      .maintenance-icon {
          font-size: 48px;
          margin-bottom: 20px;
      }

      .hidden {
          display: none !important;
      }

      @media (max-width: 480px) {
          .container {
              margin: 0;
              border-radius: 0;
              min-height: 100vh;
          }
          
          .content {
              padding: 15px;
          }
          
          .form-group input,
          .form-group select,
          .form-group textarea {
              font-size: 16px; /* é˜²æ­¢ iOS ç¸®æ”¾ */
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>ğŸ« å¯¦ååˆ¶ç™»è¨˜ç³»çµ±</h1>
          <p>è«‹å®Œæˆå¯¦ååˆ¶ç™»è¨˜å¾ŒæŸ¥çœ‹è¨‚å–®</p>
      </div>

      <!-- ç‹€æ…‹åˆ— -->
      <div class="content">
          <div class="status-bar">
              <div class="status-item">
                  <div class="status-indicator" id="apiIndicator"></div>
                  <span id="apiStatus">é€£ç·šæª¢æŸ¥ä¸­...</span>
              </div>
              <div class="status-item">
                  <div class="status-indicator" id="liffIndicator"></div>
                  <span id="liffStatus">LIFF åˆå§‹åŒ–ä¸­...</span>
              </div>
          </div>

          <!-- LIFF ç’°å¢ƒè³‡è¨Š -->
          <div id="liffInfo" class="alert alert-info hidden">
              <strong>LIFF ç’°å¢ƒè³‡è¨Šï¼š</strong>
              <div id="liffDetails"></div>
          </div>

          <!-- è¼‰å…¥ä¸­ -->
          <div id="loadingSection" class="section active">
              <div class="loading">
                  <p>ç³»çµ±åˆå§‹åŒ–ä¸­ï¼Œè«‹ç¨å€™...</p>
              </div>
          </div>

          <!-- å¯¦ååˆ¶ç™»è¨˜è¡¨å–® -->
          <div id="registrationSection" class="section">
              <div class="alert alert-info">
                  <strong>ğŸ“ å¯¦ååˆ¶ç™»è¨˜</strong><br>
                  è«‹å¡«å¯«çœŸå¯¦è³‡æ–™ä»¥å®Œæˆç™»è¨˜ï¼Œç™»è¨˜å¾Œå³å¯æŸ¥çœ‹æ‚¨çš„è¨‚å–®è³‡è¨Šã€‚
              </div>

              <form id="registrationForm">
                  <div class="form-group">
                      <label for="lineName">LINE é¡¯ç¤ºåç¨±</label>
                      <input type="text" id="lineName" readonly>
                  </div>

                  <div class="form-group">
                      <label for="realName">çœŸå¯¦å§“å *</label>
                      <input type="text" id="realName" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" required>
                  </div>

                  <div class="form-group">
                      <label for="idNumber">èº«åˆ†è­‰å­—è™Ÿ *</label>
                      <input type="text" id="idNumber" placeholder="ä¾‹ï¼šA123456789" required maxlength="10">
                  </div>

                  <div class="form-group">
                      <label for="phoneNumber">æ‰‹æ©Ÿè™Ÿç¢¼ *</label>
                      <input type="tel" id="phoneNumber" placeholder="ä¾‹ï¼š0912345678" required maxlength="10">
                  </div>

                  <button type="submit" class="btn" id="registerBtn">
                      å®Œæˆå¯¦ååˆ¶ç™»è¨˜
                  </button>
              </form>
          </div>

          <!-- è¨‚å–®åˆ—è¡¨ -->
          <div id="ordersSection" class="section">
              <div class="alert alert-success">
                  <strong>âœ… å·²å®Œæˆå¯¦ååˆ¶ç™»è¨˜</strong><br>
                  <span id="userInfo"></span>
              </div>

              <div id="ordersContainer">
                  <!-- è¨‚å–®å°‡å‹•æ…‹è¼‰å…¥åˆ°é€™è£¡ -->
              </div>

              <div class="total-amount">
                  <h3>ç¸½æ‡‰ç¹³é‡‘é¡</h3>
                  <div class="amount" id="totalAmount">NT$ 0</div>
              </div>

              <button class="btn" id="proceedToPaymentBtn">
                  å‰å¾€ç¹³è²»
              </button>

              <button class="btn btn-secondary" id="refreshOrdersBtn">
                  é‡æ–°æ•´ç†è¨‚å–®
              </button>
          </div>

          <!-- ç¹³è²»è­‰æ˜ä¸Šå‚³ -->
          <div id="paymentSection" class="section">
              <div class="alert alert-info">
                  <strong>ğŸ’³ ä¸Šå‚³ç¹³è²»è­‰æ˜</strong><br>
                  è«‹é¸æ“‡ç¹³è²»æ–¹å¼ä¸¦ä¸Šå‚³ç›¸é—œè­‰æ˜æ–‡ä»¶ã€‚
              </div>

              <form id="paymentForm">
                  <div class="form-group">
                      <label for="paymentMethod">ç¹³è²»æ–¹å¼ *</label>
                      <select id="paymentMethod" required>
                          <option value="">è«‹é¸æ“‡ç¹³è²»æ–¹å¼</option>
                          <!-- é¸é …å°‡å¾ç³»çµ±è¨­å®šå‹•æ…‹è¼‰å…¥ -->
                      </select>
                  </div>

                  <div class="form-group">
                      <label>ä¸Šå‚³ç¹³è²»è­‰æ˜</label>
                      <div class="upload-area" onclick="document.getElementById('paymentProof').click()">
                          <div class="upload-icon">ğŸ“·</div>
                          <p>é»æ“Šä¸Šå‚³ç¹³è²»è­‰æ˜ç…§ç‰‡</p>
                          <small>æ”¯æ´ JPGã€PNGã€PDF æ ¼å¼ï¼Œæª”æ¡ˆå¤§å°é™åˆ¶ 5MB</small>
                      </div>
                      <input type="file" id="paymentProof" accept="image/*,.pdf" style="display: none;" onchange="handleFileUpload(this)">
                  </div>

                  <div class="form-group" id="noteFieldGroup">
                      <label for="paymentNote">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                      <textarea id="paymentNote" rows="3" placeholder="å¦‚æœ‰ç‰¹æ®Šèªªæ˜è«‹åœ¨æ­¤å¡«å¯«..."></textarea>
                  </div>

                  <button type="button" class="btn" id="submitPaymentBtn" onclick="submitPayment()">
                      æäº¤ç¹³è²»è­‰æ˜
                  </button>

                  <button type="button" class="btn btn-secondary" id="backToOrdersBtn">
                      è¿”å›è¨‚å–®åˆ—è¡¨
                  </button>
              </form>
          </div>

          <!-- é™¤éŒ¯è³‡è¨Š -->
          <div id="debugInfo" class="debug-info hidden">
              <strong>ğŸ› é™¤éŒ¯è³‡è¨Šï¼š</strong>
              <div id="debugContent"></div>
          </div>
      </div>
  </div>

  <script>
      // ==================== å…¨åŸŸè¨­å®š ====================
      const CONFIG = {
          LIFF_ID: '1657285806-2bmkYWkN', // è«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID
          API_BASE_URL: 'https://script.google.com/macros/s/AKfycbx6bwe_nhDs27HFfj9O1AahWu_AL1RgzUMHt8tENXALHGmdCuHwUe3TvHurp0Mr9NrW/exec', // è«‹æ›¿æ›ç‚ºæ‚¨çš„ GAS ç¶²å€
          DEBUG_MODE: true, // é™¤éŒ¯æ¨¡å¼ï¼Œæ­£å¼ç’°å¢ƒè«‹è¨­ç‚º false
          DEMO_MODE: false // ç¤ºç¯„æ¨¡å¼ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™
      };

      // ==================== å…¨åŸŸè®Šæ•¸ ====================
      let liffProfile = null;
      let systemConfig = null;
      let currentOrderSummary = null;
      let debugLogs = [];

      // ==================== å·¥å…·å‡½æ•¸ ====================

      // é™¤éŒ¯æ—¥èªŒ
      function debugLog(message, data = null) {
          const timestamp = new Date().toLocaleTimeString();
          const logEntry = `[${timestamp}] ${message}`;
          
          if (data) {
              console.log(logEntry, data);
              debugLogs.push({ timestamp, message, data });
          } else {
              console.log(logEntry);
              debugLogs.push({ timestamp, message });
          }
          
          updateDebugDisplay();
      }

      // æ›´æ–°é™¤éŒ¯é¡¯ç¤º
      function updateDebugDisplay() {
          if (!CONFIG.DEBUG_MODE) return;
          
          const debugContent = document.getElementById('debugContent');
          if (debugContent) {
              const recentLogs = debugLogs.slice(-10); // åªé¡¯ç¤ºæœ€è¿‘ 10 æ¢
              debugContent.innerHTML = recentLogs.map(log => {
                  let logText = `${log.timestamp} - ${log.message}`;
                  if (log.data) {
                      logText += `\n${JSON.stringify(log.data, null, 2)}`;
                  }
                  return logText;
              }).join('\n\n');
          }
      }

      // é¡¯ç¤º/éš±è—å€åŸŸ
      function showSection(sectionId) {
          document.querySelectorAll('.section').forEach(section => {
              section.classList.remove('active');
          });
          document.getElementById(sectionId).classList.add('active');
          debugLog(`é¡¯ç¤ºå€åŸŸ: ${sectionId}`);
      }

      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
      function showSuccess(message) {
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert alert-success';
          alertDiv.innerHTML = `<strong>âœ… æˆåŠŸï¼</strong><br>${message}`;
          
          const content = document.querySelector('.content');
          content.insertBefore(alertDiv, content.firstChild);
          
          setTimeout(() => {
              alertDiv.remove();
          }, 5000);
      }

      // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
      function showError(message) {
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert alert-error';
          alertDiv.innerHTML = `<strong>âŒ éŒ¯èª¤ï¼</strong><br>${message}`;
          
          const content = document.querySelector('.content');
          content.insertBefore(alertDiv, content.firstChild);
          
          setTimeout(() => {
              alertDiv.remove();
          }, 8000);
      }

      // ==================== API å‘¼å«å‡½æ•¸ ====================

      // å‘¼å«å¾Œç«¯ API
      async function callAPI(action, data = {}) {
          try {
              debugLog(`API å‘¼å«: ${action}`, data);
              
              if (CONFIG.DEMO_MODE) {
                  return getDemoData(action, data);
              }
              
              const params = new URLSearchParams({
                  action: action,
                  data: JSON.stringify(data),
                  callback: 'handleAPIResponse',
                  _: Date.now()
              });
              
              return new Promise((resolve, reject) => {
                  window.handleAPIResponse = (response) => {
                      debugLog(`API å›æ‡‰: ${action}`, response);
                      resolve(response);
                      delete window.handleAPIResponse;
                  };
                  
                  const script = document.createElement('script');
                  script.src = `${CONFIG.API_BASE_URL}?${params}`;
                  script.onerror = () => {
                      reject(new Error('API å‘¼å«å¤±æ•—'));
                      delete window.handleAPIResponse;
                  };
                  
                  document.head.appendChild(script);
                  
                  setTimeout(() => {
                      document.head.removeChild(script);
                  }, 1000);
                  
                  setTimeout(() => {
                      if (window.handleAPIResponse) {
                          reject(new Error('API å‘¼å«é€¾æ™‚'));
                          delete window.handleAPIResponse;
                      }
                  }, 10000);
              });
              
          } catch (error) {
              debugLog(`API å‘¼å«å¤±æ•—: ${action}`, error);
              throw error;
          }
      }

      // ç¤ºç¯„è³‡æ–™ï¼ˆé–‹ç™¼æ¸¬è©¦ç”¨ï¼‰
      function getDemoData(action, data) {
          debugLog(`ä½¿ç”¨ç¤ºç¯„è³‡æ–™: ${action}`, data);
          
          switch (action) {
              case 'test':
                  return { success: true, message: 'API é€£ç·šæ¸¬è©¦æˆåŠŸï¼ˆç¤ºç¯„æ¨¡å¼ï¼‰' };
                  
              case 'get-config':
                  return {
                      success: true,
                      config: {
                          basic: {
                              'APIé€£ç·šç‹€æ…‹é¡¯ç¤º': true,
                              'é™¤éŒ¯è³‡è¨Šé¡¯ç¤º': true,
                              'LIFFç’°å¢ƒè³‡è¨Šé¡¯ç¤º': true,
                              'ç¹³è²»è­‰æ˜ä¸Šå‚³': 'å¿…é ˆ',
                              'å‚™è¨»æ¬„ä½é¡¯ç¤º': true,
                              'ç³»çµ±ç¶­è­·æ¨¡å¼': false,
                              'æœ€å¤§æª”æ¡ˆå¤§å°MB': 5,
                              'å…è¨±æª”æ¡ˆæ ¼å¼': ['jpg', 'png', 'pdf']
                          },
                          paymentMethods: [
                              { code: 'bank_transfer', name: 'éŠ€è¡Œè½‰å¸³', enabled: true },
                              { code: 'cash', name: 'ç¾é‡‘ç¹³è²»', enabled: true },
                              { code: 'atm', name: 'ATMè½‰å¸³', enabled: true }
                          ],
                          messages: {
                              welcome_message: 'æ­¡è¿ä½¿ç”¨æœ¬ç³»çµ±ï¼',
                              upload_success: 'ç¹³è²»è­‰æ˜ä¸Šå‚³æˆåŠŸï¼',
                              upload_error: 'ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼',
                              registration_success: 'å¯¦ååˆ¶ç™»è¨˜å®Œæˆï¼'
                          }
                      }
                  };
                  
              case 'check-registration':
                  return {
                      success: true,
                      registered: false
                  };
                  
              case 'register':
                  return {
                      success: true,
                      message: 'å¯¦ååˆ¶ç™»è¨˜å®Œæˆï¼ˆç¤ºç¯„æ¨¡å¼ï¼‰',
                      userData: {
                          lineName: data.lineName,
                          realName: data.realName,
                          idNumber: data.idNumber,
                          phoneNumber: data.phoneNumber,
                          registrationTime: new Date(),
                          status: 'å·²ç™»è¨˜'
                      }
                  };
                  
              case 'orders':
                  return {
                      success: true,
                      orders: [
                          {
                              orderId: 'ORDER001',
                              lineName: data.lineName,
                              realName: 'ç¤ºç¯„ç”¨æˆ¶',
                              productName: 'ç¤ºç¯„å•†å“A',
                              quantity: 2,
                              unitPrice: 500,
                              totalPrice: 1000,
                              status: 'å¾…ä»˜æ¬¾',
                              createdAt: new Date(),
                              note: 'ç¤ºç¯„è¨‚å–®'
                          },
                          {
                              orderId: 'ORDER002',
                              lineName: data.lineName,
                              realName: 'ç¤ºç¯„ç”¨æˆ¶',
                              productName: 'ç¤ºç¯„å•†å“B',
                              quantity: 1,
                              unitPrice: 800,
                              totalPrice: 800,
                              status: 'å¾…ä»˜æ¬¾',
                              createdAt: new Date(),
                              note: ''
                          }
                      ],
                      totalAmount: 1800,
                      userData: {
                          lineName: data.lineName,
                          realName: 'ç¤ºç¯„ç”¨æˆ¶',
                          status: 'å·²ç™»è¨˜'
                      }
                  };
                  
              case 'submit-payment':
                  return {
                      success: true,
                      message: 'ç¹³è²»è­‰æ˜æäº¤æˆåŠŸï¼ˆç¤ºç¯„æ¨¡å¼ï¼‰'
                  };
                  
              default:
                  return { success: false, message: 'æœªçŸ¥çš„ç¤ºç¯„æ“ä½œ' };
          }
      }

      // ==================== ç³»çµ±è¨­å®šç®¡ç† ====================

      // è¼‰å…¥ç³»çµ±è¨­å®š
      async function loadSystemConfig() {
          try {
              debugLog('è¼‰å…¥ç³»çµ±è¨­å®š');
              
              const result = await callAPI('get-config', {});
              
              if (result.success) {
                  systemConfig = result.config;
                  debugLog('ç³»çµ±è¨­å®šè¼‰å…¥æˆåŠŸ', systemConfig);
                  
                  // å¥—ç”¨ç³»çµ±è¨­å®š
                  applySystemConfig();
                  
                  return true;
              } else {
                  debugLog('è¼‰å…¥ç³»çµ±è¨­å®šå¤±æ•—', result);
                  // ä½¿ç”¨é è¨­è¨­å®š
                  systemConfig = getDefaultFrontendConfig();
                  applySystemConfig();
                  return false;
              }
          } catch (error) {
              debugLog('è¼‰å…¥ç³»çµ±è¨­å®šå¤±æ•—', error);
              console.error('è¼‰å…¥ç³»çµ±è¨­å®šå¤±æ•—:', error);
              
              // ä½¿ç”¨é è¨­è¨­å®š
              systemConfig = getDefaultFrontendConfig();
              applySystemConfig();
              return false;
          }
      }

      // é è¨­å‰ç«¯è¨­å®š
      function getDefaultFrontendConfig() {
          return {
              basic: {
                  'APIé€£ç·šç‹€æ…‹é¡¯ç¤º': true,
                  'é™¤éŒ¯è³‡è¨Šé¡¯ç¤º': false,
                  'LIFFç’°å¢ƒè³‡è¨Šé¡¯ç¤º': false,
                  'ç¹³è²»è­‰æ˜ä¸Šå‚³': 'å¿…é ˆ',
                  'å‚™è¨»æ¬„ä½é¡¯ç¤º': true,
                  'ç³»çµ±ç¶­è­·æ¨¡å¼': false,
                  'æœ€å¤§æª”æ¡ˆå¤§å°MB': 5,
                  'å…è¨±æª”æ¡ˆæ ¼å¼': ['jpg', 'png', 'pdf']
              },
              paymentMethods: [
                  { code: 'bank_transfer', name: 'éŠ€è¡Œè½‰å¸³', enabled: true },
                  { code: 'cash', name: 'ç¾é‡‘ç¹³è²»', enabled: true }
              ],
              messages: {
                  welcome_message: 'æ­¡è¿ä½¿ç”¨æœ¬ç³»çµ±ï¼',
                  upload_success: 'ç¹³è²»è­‰æ˜ä¸Šå‚³æˆåŠŸï¼',
                  upload_error: 'ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼',
                  registration_success: 'å¯¦ååˆ¶ç™»è¨˜å®Œæˆï¼'
              }
          };
      }

      // å¥—ç”¨ç³»çµ±è¨­å®š
      function applySystemConfig() {
          if (!systemConfig) return;
          
          const config = systemConfig.basic;
          
          // æ§åˆ¶ API é€£ç·šç‹€æ…‹é¡¯ç¤º
          const statusBar = document.querySelector('.status-bar');
          if (statusBar) {
              statusBar.style.display = config['APIé€£ç·šç‹€æ…‹é¡¯ç¤º'] ? 'flex' : 'none';
          }
          
          // æ§åˆ¶é™¤éŒ¯è³‡è¨Šé¡¯ç¤º
          CONFIG.DEBUG_MODE = config['é™¤éŒ¯è³‡è¨Šé¡¯ç¤º'];
          const debugInfo = document.getElementById('debugInfo');
          if (debugInfo) {
              debugInfo.classList.toggle('hidden', !CONFIG.DEBUG_MODE);
          }
          
          // æ§åˆ¶ LIFF ç’°å¢ƒè³‡è¨Šé¡¯ç¤º
          const liffInfo = document.getElementById('liffInfo');
          if (liffInfo) {
              liffInfo.classList.toggle('hidden', !config['LIFFç’°å¢ƒè³‡è¨Šé¡¯ç¤º']);
          }
          
          // æª¢æŸ¥ç³»çµ±ç¶­è­·æ¨¡å¼
          if (config['ç³»çµ±ç¶­è­·æ¨¡å¼']) {
              showMaintenanceMode();
              return;
          }
          
          // æ›´æ–°ç¹³è²»æ–¹å¼é¸é …
          updatePaymentMethods();
          
          // æ›´æ–°æª”æ¡ˆä¸Šå‚³è¨­å®š
          updateFileUploadSettings();
          
          // æ›´æ–°å‚™è¨»æ¬„ä½é¡¯ç¤º
          updateNoteFieldVisibility();
          
          debugLog('ç³»çµ±è¨­å®šå·²å¥—ç”¨', config);
      }

      // é¡¯ç¤ºç¶­è­·æ¨¡å¼
      function showMaintenanceMode() {
          const message = systemConfig.messages.maintenance_message || 'ç³»çµ±ç¶­è­·ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦';
          
          document.body.innerHTML = `
              <div class="maintenance-mode">
                  <div class="maintenance-card">
                      <div class="maintenance-icon">ğŸ”§</div>
                      <h2 style="color: #333; margin-bottom: 10px;">ç³»çµ±ç¶­è­·ä¸­</h2>
                      <p style="color: #666;">${message}</p>
                  </div>
              </div>
          `;
      }

      // æ›´æ–°ç¹³è²»æ–¹å¼é¸é …
      function updatePaymentMethods() {
          const paymentMethodSelect = document.getElementById('paymentMethod');
          if (!paymentMethodSelect || !systemConfig.paymentMethods) return;
          
          // ä¿ç•™ç¬¬ä¸€å€‹é¸é …ï¼ˆè«‹é¸æ“‡ï¼‰
          const firstOption = paymentMethodSelect.firstElementChild;
          paymentMethodSelect.innerHTML = '';
          paymentMethodSelect.appendChild(firstOption);
          
          // æ–°å¢ç³»çµ±è¨­å®šçš„ç¹³è²»æ–¹å¼
          systemConfig.paymentMethods.forEach(method => {
              const option = document.createElement('option');
              option.value = method.code;
              option.textContent = method.name;
              paymentMethodSelect.appendChild(option);
          });
          
          debugLog('ç¹³è²»æ–¹å¼é¸é …å·²æ›´æ–°', systemConfig.paymentMethods);
      }

      // æ›´æ–°æª”æ¡ˆä¸Šå‚³è¨­å®š
      function updateFileUploadSettings() {
          const config = systemConfig.basic;
          const paymentProofInput = document.getElementById('paymentProof');
          const uploadArea = document.querySelector('.upload-area');
          
          if (!paymentProofInput || !uploadArea) return;
          
          // è¨­å®šæ˜¯å¦å¿…é ˆä¸Šå‚³
          const isRequired = config['ç¹³è²»è­‰æ˜ä¸Šå‚³'] === 'å¿…é ˆ';
          
          if (!isRequired) {
              // å¦‚æœä¸æ˜¯å¿…é ˆï¼Œæ›´æ–°æ¨™ç±¤æ–‡å­—
              const uploadText = uploadArea.querySelector('p');
              if (uploadText) {
                  uploadText.textContent = 'é»æ“Šä¸Šå‚³ç¹³è²»è­‰æ˜ç…§ç‰‡ï¼ˆé¸å¡«ï¼‰';
              }
          }
          
          // è¨­å®šå…è¨±çš„æª”æ¡ˆæ ¼å¼
          const allowedFormats = config['å…è¨±æª”æ¡ˆæ ¼å¼'];
          if (allowedFormats && Array.isArray(allowedFormats)) {
              const acceptString = allowedFormats.map(format => {
                  if (format === 'jpg') return 'image/jpeg';
                  if (format === 'png') return 'image/png';
                  if (format === 'pdf') return 'application/pdf';
                  return `image/${format}`;
              }).join(',');
              
              paymentProofInput.setAttribute('accept', acceptString);
              
              // æ›´æ–°æç¤ºæ–‡å­—
              const uploadText = uploadArea.querySelector('small');
              if (uploadText) {
                  uploadText.textContent = `æ”¯æ´ ${allowedFormats.join(', ').toUpperCase()} æ ¼å¼ï¼Œæª”æ¡ˆå¤§å°é™åˆ¶ ${config['æœ€å¤§æª”æ¡ˆå¤§å°MB'] || 5}MB`;
              }
          }
          
          // è¨­å®šæª”æ¡ˆå¤§å°é™åˆ¶
          const maxSizeMB = config['æœ€å¤§æª”æ¡ˆå¤§å°MB'] || 5;
          paymentProofInput.setAttribute('data-max-size', maxSizeMB * 1024 * 1024);
          
          debugLog('æª”æ¡ˆä¸Šå‚³è¨­å®šå·²æ›´æ–°', {
              required: isRequired,
              formats: allowedFormats,
              maxSize: maxSizeMB
          });
      }

      // æ›´æ–°å‚™è¨»æ¬„ä½é¡¯ç¤º
      function updateNoteFieldVisibility() {
          const noteFieldGroup = document.getElementById('noteFieldGroup');
          
          if (noteFieldGroup) {
              const showNote = systemConfig.basic['å‚™è¨»æ¬„ä½é¡¯ç¤º'];
              noteFieldGroup.style.display = showNote ? 'block' : 'none';
          }
      }

      // ==================== LIFF ç›¸é—œå‡½æ•¸ ====================

      // åˆå§‹åŒ– LIFF
      async function initializeLiff() {
          try {
              debugLog('é–‹å§‹åˆå§‹åŒ– LIFF');
              
              // å…ˆè¼‰å…¥ç³»çµ±è¨­å®š
              await loadSystemConfig();
              
              // æª¢æŸ¥ç³»çµ±ç¶­è­·æ¨¡å¼
              if (systemConfig?.basic?.['ç³»çµ±ç¶­è­·æ¨¡å¼']) {
                  return; // ç¶­è­·æ¨¡å¼ä¸‹ä¸ç¹¼çºŒåˆå§‹åŒ–
              }
              
              // æ›´æ–° LIFF ç‹€æ…‹
              updateLiffStatus('åˆå§‹åŒ–ä¸­...', false);
              
              if (typeof liff === 'undefined') {
                  throw new Error('LIFF SDK æœªè¼‰å…¥');
              }
              
              await liff.init({ liffId: CONFIG.LIFF_ID });
              debugLog('LIFF åˆå§‹åŒ–æˆåŠŸ');
              
              // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
              if (liff.isLoggedIn()) {
                  debugLog('ç”¨æˆ¶å·²ç™»å…¥ LINE');
                  
                  // å–å¾—ç”¨æˆ¶è³‡æ–™
                  liffProfile = await liff.getProfile();
                  debugLog('å–å¾—ç”¨æˆ¶è³‡æ–™', liffProfile);
                  
                  // é¡¯ç¤º LIFF ç’°å¢ƒè³‡è¨Š
                  displayLiffInfo();
                  
                  // å¡«å…¥ LINE åç¨±
                  document.getElementById('lineName').value = liffProfile.displayName;
                  
                  // æª¢æŸ¥ç”¨æˆ¶ç™»è¨˜ç‹€æ…‹
                  await checkRegistrationStatus();
                  
                  updateLiffStatus('å·²é€£ç·š', true);
              } else {
                  debugLog('ç”¨æˆ¶æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
                  liff.login();
              }
              
          } catch (error) {
              debugLog('LIFF åˆå§‹åŒ–å¤±æ•—', error);
              console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
              updateLiffStatus('é€£ç·šå¤±æ•—', false);
              showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
              
              // å¦‚æœæ˜¯é–‹ç™¼æ¨¡å¼ï¼Œä½¿ç”¨ç¤ºç¯„è³‡æ–™
              if (CONFIG.DEMO_MODE) {
                  liffProfile = { displayName: 'ç¤ºç¯„ç”¨æˆ¶', userId: 'demo123' };
                  document.getElementById('lineName').value = liffProfile.displayName;
                  await checkRegistrationStatus();
              }
          }
      }

      // é¡¯ç¤º LIFF ç’°å¢ƒè³‡è¨Š
      function displayLiffInfo() {
          if (!systemConfig?.basic?.['LIFFç’°å¢ƒè³‡è¨Šé¡¯ç¤º']) return;
          
          const liffDetails = document.getElementById('liffDetails');
          if (liffDetails && liffProfile) {
              liffDetails.innerHTML = `
                  <div>ç”¨æˆ¶ID: ${liffProfile.userId}</div>
                  <div>é¡¯ç¤ºåç¨±: ${liffProfile.displayName}</div>
                  <div>ç’°å¢ƒ: ${liff.getOS()}</div>
                  <div>ç‰ˆæœ¬: ${liff.getVersion()}</div>
              `;
              document.getElementById('liffInfo').classList.remove('hidden');
          }
      }

      // æ›´æ–° LIFF ç‹€æ…‹
      function updateLiffStatus(message, success) {
          const liffIndicator = document.getElementById('liffIndicator');
          const liffStatus = document.getElementById('liffStatus');
          
          if (liffIndicator && liffStatus) {
              liffIndicator.className = `status-indicator ${success ? 'success' : ''}`;
              liffStatus.textContent = message;
          }
      }

      // ==================== API ç‹€æ…‹æª¢æŸ¥ ====================

      // æª¢æŸ¥ API é€£ç·šç‹€æ…‹
      async function checkAPIStatus() {
          try {
              debugLog('æª¢æŸ¥ API é€£ç·šç‹€æ…‹');
              updateAPIStatus('æª¢æŸ¥ä¸­...', false);
              
              const result = await callAPI('test');
              
              if (result.success) {
                  debugLog('API é€£ç·šæ­£å¸¸', result);
                  updateAPIStatus('é€£ç·šæ­£å¸¸', true);
                  return true;
              } else {
                  debugLog('API é€£ç·šç•°å¸¸', result);
                  updateAPIStatus('é€£ç·šç•°å¸¸', false);
                  return false;
              }
          } catch (error) {
              debugLog('API é€£ç·šæª¢æŸ¥å¤±æ•—', error);
              updateAPIStatus('é€£ç·šå¤±æ•—', false);
              return false;
          }
      }

      // æ›´æ–° API ç‹€æ…‹
      function updateAPIStatus(message, success) {
          const apiIndicator = document.getElementById('apiIndicator');
          const apiStatus = document.getElementById('apiStatus');
          
          if (apiIndicator && apiStatus) {
              apiIndicator.className = `status-indicator ${success ? 'success' : ''}`;
              apiStatus.textContent = message;
          }
      }

      // ==================== ç”¨æˆ¶ç™»è¨˜ç›¸é—œå‡½æ•¸ ====================

      // æª¢æŸ¥ç”¨æˆ¶ç™»è¨˜ç‹€æ…‹
      async function checkRegistrationStatus() {
          try {
              debugLog('æª¢æŸ¥ç”¨æˆ¶ç™»è¨˜ç‹€æ…‹');
              
              if (!liffProfile) {
                  showError('ç„¡æ³•å–å¾—ç”¨æˆ¶è³‡æ–™');
                  return;
              }
              
              const result = await callAPI('check-registration', {
                  lineName: liffProfile.displayName
              });
              
              if (result.success) {
                  if (result.registered) {
                      debugLog('ç”¨æˆ¶å·²å®Œæˆç™»è¨˜', result.userData);
                      // è¼‰å…¥è¨‚å–®è³‡æ–™
                      await loadUserOrders();
                  } else {
                      debugLog('ç”¨æˆ¶å°šæœªç™»è¨˜');
                      showSection('registrationSection');
                  }
              } else {
                  debugLog('æª¢æŸ¥ç™»è¨˜ç‹€æ…‹å¤±æ•—', result);
                  showError(result.message || 'æª¢æŸ¥ç™»è¨˜ç‹€æ…‹å¤±æ•—');
              }
              
          } catch (error) {
              debugLog('æª¢æŸ¥ç™»è¨˜ç‹€æ…‹å¤±æ•—', error);
              console.error('æª¢æŸ¥ç™»è¨˜ç‹€æ…‹å¤±æ•—:', error);
              showError('æª¢æŸ¥ç™»è¨˜ç‹€æ…‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
      }

      // è™•ç†ç™»è¨˜è¡¨å–®æäº¤
      async function handleRegistration(event) {
          event.preventDefault();
          
          try {
              debugLog('è™•ç†ç”¨æˆ¶ç™»è¨˜');
              
              const formData = {
                  lineName: document.getElementById('lineName').value,
                  realName: document.getElementById('realName').value,
                  idNumber: document.getElementById('idNumber').value.toUpperCase(),
                  phoneNumber: document.getElementById('phoneNumber').value
              };
              
              // å‰ç«¯é©—è­‰
              if (!formData.realName || !formData.idNumber || !formData.phoneNumber) {
                  showError('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');
                  return;
              }
              
              // èº«åˆ†è­‰å­—è™Ÿæ ¼å¼é©—è­‰
              const idPattern = /^[A-Z][12]\d{8}$/;
              if (!idPattern.test(formData.idNumber)) {
                  showError('èº«åˆ†è­‰å­—è™Ÿæ ¼å¼ä¸æ­£ç¢º');
                  return;
              }
              
              // é›»è©±è™Ÿç¢¼æ ¼å¼é©—è­‰
              const phonePattern = /^09\d{8}$/;
              if (!phonePattern.test(formData.phoneNumber)) {
                  showError('é›»è©±è™Ÿç¢¼æ ¼å¼ä¸æ­£ç¢ºï¼ˆè«‹è¼¸å…¥09é–‹é ­çš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼‰');
                  return;
              }
              
              // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
              const submitBtn = document.getElementById('registerBtn');
              const originalText = submitBtn.textContent;
              submitBtn.textContent = 'ç™»è¨˜ä¸­...';
              submitBtn.disabled = true;
              
              const result = await callAPI('register', formData);
              
              if (result.success) {
                  debugLog('ç”¨æˆ¶ç™»è¨˜æˆåŠŸ', result);
                  const successMessage = systemConfig?.messages?.registration_success || 'å¯¦ååˆ¶ç™»è¨˜å®Œæˆï¼';
                  showSuccess(successMessage);
                  
                  // è¼‰å…¥è¨‚å–®è³‡æ–™
                  setTimeout(async () => {
                      await loadUserOrders();
                  }, 1500);
              } else {
                  debugLog('ç”¨æˆ¶ç™»è¨˜å¤±æ•—', result);
                  showError(result.message || 'ç™»è¨˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                  submitBtn.textContent = originalText;
                  submitBtn.disabled = false;
              }
              
          } catch (error) {
              debugLog('ç”¨æˆ¶ç™»è¨˜å¤±æ•—', error);
              console.error('ç”¨æˆ¶ç™»è¨˜å¤±æ•—:', error);
              showError('ç™»è¨˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
              
              const submitBtn = document.getElementById('registerBtn');
              if (submitBtn) {
                  submitBtn.textContent = 'å®Œæˆå¯¦ååˆ¶ç™»è¨˜';
                  submitBtn.disabled = false;
              }
          }
      }

      // ==================== è¨‚å–®ç›¸é—œå‡½æ•¸ ====================

      // è¼‰å…¥ç”¨æˆ¶è¨‚å–®
      async function loadUserOrders() {
          try {
              debugLog('è¼‰å…¥ç”¨æˆ¶è¨‚å–®');
              
              if (!liffProfile) {
                  showError('ç„¡æ³•å–å¾—ç”¨æˆ¶è³‡æ–™');
                  return;
              }
              
              const result = await callAPI('orders', {
                  lineName: liffProfile.displayName
              });
              
              if (result.success) {
                  debugLog('è¨‚å–®è¼‰å…¥æˆåŠŸ', result);
                  
                  // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
                  const userInfo = document.getElementById('userInfo');
                  if (userInfo && result.userData) {
                      userInfo.textContent = `å§“åï¼š${result.userData.realName} | ç™»è¨˜æ™‚é–“ï¼š${new Date(result.userData.registrationTime).toLocaleString()}`;
                  }
                  
                  // é¡¯ç¤ºè¨‚å–®åˆ—è¡¨
                  displayOrders(result.orders, result.totalAmount);
                  
                  // å„²å­˜è¨‚å–®æ‘˜è¦ä¾›ç¹³è²»ä½¿ç”¨
                  currentOrderSummary = {
                      orders: result.orders,
                      totalAmount: result.totalAmount,
                      userData: result.userData,
                      lineName: liffProfile.displayName,
                      realName: result.userData.realName,
                      orderId: result.orders.map(o => o.orderId).join(',')
                  };
                  
                  showSection('ordersSection');
              } else {
                  debugLog('è¼‰å…¥è¨‚å–®å¤±æ•—', result);
                  if (result.needRegistration) {
                      showSection('registrationSection');
                  } else {
                      showError(result.message || 'è¼‰å…¥è¨‚å–®å¤±æ•—');
                  }
              }
              
          } catch (error) {
              debugLog('è¼‰å…¥è¨‚å–®å¤±æ•—', error);
              console.error('è¼‰å…¥è¨‚å–®å¤±æ•—:', error);
              showError('è¼‰å…¥è¨‚å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
      }

      // é¡¯ç¤ºè¨‚å–®åˆ—è¡¨
      function displayOrders(orders, totalAmount) {
          const container = document.getElementById('ordersContainer');
          const totalAmountElement = document.getElementById('totalAmount');
          
          if (!container || !totalAmountElement) return;
          
          if (orders.length === 0) {
              container.innerHTML = `
                  <div class="alert alert-info">
                      <strong>ğŸ“‹ æš«ç„¡è¨‚å–®</strong><br>
                      ç›®å‰æ²’æœ‰æ‰¾åˆ°æ‚¨çš„è¨‚å–®è³‡æ–™ã€‚
                  </div>
              `;
              totalAmountElement.textContent = 'NT$ 0';
              return;
          }
          
          container.innerHTML = orders.map(order => `
              <div class="order-card">
                  <div class="order-header">
                      <div class="order-id">è¨‚å–® ${order.orderId}</div>
                      <div class="order-status">${order.status}</div>
                  </div>
                  <div class="order-details">
                      <div><strong>${order.productName}</strong></div>
                      <div>æ•¸é‡ï¼š${order.quantity} | å–®åƒ¹ï¼šNT$ ${order.unitPrice}</div>
                      <div>å°è¨ˆï¼šNT$ ${order.totalPrice}</div>
                      ${order.note ? `<div>å‚™è¨»ï¼š${order.note}</div>` : ''}
                      <div style="font-size: 12px; color: #999; margin-top: 5px;">
                          å»ºç«‹æ™‚é–“ï¼š${new Date(order.createdAt).toLocaleString()}
                      </div>
                  </div>
              </div>
          `).join('');
          
          totalAmountElement.textContent = `NT$ ${totalAmount.toLocaleString()}`;
      }

      // ==================== ç¹³è²»ç›¸é—œå‡½æ•¸ ====================

      // è™•ç†æª”æ¡ˆä¸Šå‚³
      function handleFileUpload(input) {
          const file = input.files[0];
          if (!file) return;
          
          const config = systemConfig?.basic || {};
          const maxSizeMB = config['æœ€å¤§æª”æ¡ˆå¤§å°MB'] || 5;
          const maxSizeBytes = maxSizeMB * 1024 * 1024;
          const allowedFormats = config['å…è¨±æª”æ¡ˆæ ¼å¼'] || ['jpg', 'png', 'pdf'];
          
          // æª¢æŸ¥æª”æ¡ˆå¤§å°
          if (file.size > maxSizeBytes) {
              showError(`æª”æ¡ˆå¤§å°è¶…éé™åˆ¶ï¼ˆæœ€å¤§ ${maxSizeMB}MBï¼‰`);
              input.value = '';
              return;
          }
          
          // æª¢æŸ¥æª”æ¡ˆæ ¼å¼
          const fileExtension = file.name.split('.').pop().toLowerCase();
          if (!allowedFormats.includes(fileExtension)) {
              showError(`ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼Œè«‹ä½¿ç”¨ï¼š${allowedFormats.join(', ').toUpperCase()}`);
              input.value = '';
              return;
          }
          
          debugLog('æª”æ¡ˆé©—è­‰é€šé', { 
              name: file.name, 
              size: file.size, 
              type: file.type,
              extension: fileExtension
          });
          
          const uploadArea = document.querySelector('.upload-area');
          uploadArea.innerHTML = `
              <div class="upload-icon">âœ…</div>
              <p>å·²é¸æ“‡: ${file.name}</p>
              <small>æª”æ¡ˆå¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB</small>
          `;
          uploadArea.style.background = '#d4edda';
      }

      // æäº¤ç¹³è²»è­‰æ˜
      async function submitPayment() {
          debugLog('æäº¤ç¹³è²»è­‰æ˜');
          
          if (!currentOrderSummary) {
              showError('ç„¡æ³•å–å¾—è¨‚å–®è³‡è¨Šï¼Œè«‹é‡æ–°è¼‰å…¥');
              return;
          }
          
          const paymentMethod = document.getElementById('paymentMethod').value;
          const paymentNote = document.getElementById('paymentNote').value;
          const paymentProof = document.getElementById('paymentProof').files[0];
          
          // æª¢æŸ¥å¿…å¡«æ¬„ä½
          if (!paymentMethod) {
              showError('è«‹é¸æ“‡ç¹³è²»æ–¹å¼');
              return;
          }
          
          // æª¢æŸ¥æ˜¯å¦å¿…é ˆä¸Šå‚³æª”æ¡ˆ
          const isFileRequired = systemConfig?.basic?.['ç¹³è²»è­‰æ˜ä¸Šå‚³'] === 'å¿…é ˆ';
          
          if (isFileRequired && !paymentProof) {
              showError('è«‹ä¸Šå‚³ç¹³è²»è­‰æ˜');
              return;
          }
          
          const paymentData = {
              orderId: currentOrderSummary.orderId,
              lineName: currentOrderSummary.lineName,
              realName: currentOrderSummary.realName,
              paymentAmount: currentOrderSummary.totalAmount,
              paymentMethod: paymentMethod,
              paymentNote: paymentNote,
              hasProof: !!paymentProof,
              submittedAt: new Date().toISOString()
          };
          
          try {
              // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
              const submitBtn = document.getElementById('submitPaymentBtn');
              const originalText = submitBtn.textContent;
              submitBtn.textContent = 'æäº¤ä¸­...';
              submitBtn.disabled = true;
              
              const result = await callAPI('submit-payment', paymentData);
              
              if (result.success) {
                  debugLog('ç¹³è²»è­‰æ˜æäº¤æˆåŠŸ');
                  const successMessage = systemConfig?.messages?.upload_success || 'ç¹³è²»è­‰æ˜æäº¤æˆåŠŸï¼';
                  showSuccess(successMessage);
                  
                  // æ¸…ç©ºè¡¨å–®
                  document.getElementById('paymentNote').value = '';
                  document.getElementById('paymentProof').value = '';
                  document.getElementById('paymentMethod').selectedIndex = 0;
                  
                  // é‡ç½®ä¸Šå‚³å€åŸŸ
                  const uploadArea = document.querySelector('.upload-area');
                  uploadArea.innerHTML = `
                      <div class="upload-icon">ğŸ“·</div>
                      <p>é»æ“Šä¸Šå‚³ç¹³è²»è­‰æ˜ç…§ç‰‡</p>
                      <small>æ”¯æ´æ ¼å¼è«‹åƒè€ƒç³»çµ±è¨­å®š</small>
                  `;
                  uploadArea.style.background = '';
                  
                  submitBtn.textContent = 'å·²æäº¤';
                  submitBtn.disabled = true;
              } else {
                  debugLog('ç¹³è²»è­‰æ˜æäº¤å¤±æ•—', result);
                  const errorMessage = result.message || systemConfig?.messages?.upload_error || 'æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
                  showError(errorMessage);
                  submitBtn.textContent = originalText;
                  submitBtn.disabled = false;
              }
          } catch (error) {
              debugLog('ç¹³è²»è­‰æ˜æäº¤å¤±æ•—', error);
              console.error('æäº¤ç¹³è²»è­‰æ˜å¤±æ•—:', error);
              const errorMessage = systemConfig?.messages?.upload_error || 'æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
              showError(errorMessage + ': ' + error.message);
              
              const submitBtn = document.getElementById('submitPaymentBtn');
              if (submitBtn) {
                  submitBtn.textContent = 'æäº¤ç¹³è²»è­‰æ˜';
                  submitBtn.disabled = false;
              }
          }
      }

      // ==================== äº‹ä»¶è™•ç† ====================

      // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', async function() {
          debugLog('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–');
          
          // æª¢æŸ¥ API é€£ç·šç‹€æ…‹
          await checkAPIStatus();
          
          // åˆå§‹åŒ– LIFF
          await initializeLiff();
          
          // ç¶å®šäº‹ä»¶è™•ç†å™¨
          setupEventHandlers();
      });

      // è¨­å®šäº‹ä»¶è™•ç†å™¨
      function setupEventHandlers() {
          // å¯¦ååˆ¶ç™»è¨˜è¡¨å–®
          const registrationForm = document.getElementById('registrationForm');
          if (registrationForm) {
              registrationForm.addEventListener('submit', handleRegistration);
          }
          
          // å‰å¾€ç¹³è²»æŒ‰éˆ•
          const proceedToPaymentBtn = document.getElementById('proceedToPaymentBtn');
          if (proceedToPaymentBtn) {
              proceedToPaymentBtn.addEventListener('click', () => {
                  showSection('paymentSection');
              });
          }
          
          // é‡æ–°æ•´ç†è¨‚å–®æŒ‰éˆ•
          const refreshOrdersBtn = document.getElementById('refreshOrdersBtn');
          if (refreshOrdersBtn) {
              refreshOrdersBtn.addEventListener('click', loadUserOrders);
          }
          
          // è¿”å›è¨‚å–®åˆ—è¡¨æŒ‰éˆ•
          const backToOrdersBtn = document.getElementById('backToOrdersBtn');
          if (backToOrdersBtn) {
              backToOrdersBtn.addEventListener('click', () => {
                  showSection('ordersSection');
              });
          }
          
          // æª”æ¡ˆæ‹–æ”¾è™•ç†
          const uploadArea = document.querySelector('.upload-area');
          if (uploadArea) {
              uploadArea.addEventListener('dragover', (e) => {
                  e.preventDefault();
                  uploadArea.classList.add('dragover');
              });
              
              uploadArea.addEventListener('dragleave', () => {
                  uploadArea.classList.remove('dragover');
              });
              
              uploadArea.addEventListener('drop', (e) => {
                  e.preventDefault();
                  uploadArea.classList.remove('dragover');
                  
                  const files = e.dataTransfer.files;
                  if (files.length > 0) {
                      const paymentProofInput = document.getElementById('paymentProof');
                      paymentProofInput.files = files;
                      handleFileUpload(paymentProofInput);
                  }
              });
          }
          
          debugLog('äº‹ä»¶è™•ç†å™¨è¨­å®šå®Œæˆ');
      }

      // ==================== å…¨åŸŸéŒ¯èª¤è™•ç† ====================

      // å…¨åŸŸéŒ¯èª¤è™•ç†
      window.addEventListener('error', function(event) {
          debugLog('å…¨åŸŸéŒ¯èª¤', {
              message: event.message,
              filename: event.filename,
              lineno: event.lineno,
              colno: event.colno,
              error: event.error
          });
          
          console.error('å…¨åŸŸéŒ¯èª¤:', event.error);
      });

      // æœªè™•ç†çš„ Promise æ‹’çµ•
      window.addEventListener('unhandledrejection', function(event) {
          debugLog('æœªè™•ç†çš„ Promise æ‹’çµ•', event.reason);
          console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', event.reason);
      });

      // å‰ç«¯æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
    async function checkFrontendAdminPermission(requiredRole = 'viewer') {
    try {
      if (!liffProfile) {
        return { success: false, message: 'è«‹å…ˆç™»å…¥ LINE' };
      }
      
      const result = await callAPI('check-admin', {
        userId: liffProfile.userId,
        requiredRole: requiredRole
      });
      
      return result;
      
    } catch (error) {
      debugLog('æª¢æŸ¥å‰ç«¯ç®¡ç†å“¡æ¬Šé™å¤±æ•—', error);
      return { success: false, message: 'æ¬Šé™æª¢æŸ¥å¤±æ•—' };
    }
    }

    // é¡¯ç¤ºç®¡ç†å“¡é¢æ¿
    async function showAdminPanel() {
    try {
      const permissionCheck = await checkFrontendAdminPermission('moderator');
      
      if (!permissionCheck.success) {
        showError(permissionCheck.message);
        return;
      }
      
      debugLog('é¡¯ç¤ºç®¡ç†å“¡é¢æ¿', permissionCheck);
      
      // å»ºç«‹ç®¡ç†å“¡é¢æ¿ HTML
      const adminPanelHTML = `
        <div id="adminPanel" class="section active">
          <div class="alert alert-info">
            <strong>ğŸ› ï¸ ç®¡ç†å“¡é¢æ¿</strong><br>
            æ­¡è¿ï¼Œ${permissionCheck.adminData.name}ï¼ˆ${permissionCheck.role}ï¼‰
          </div>
          
          <div class="form-group">
            <button class="btn" onclick="showAdminList()">ç®¡ç†å“¡åå–®</button>
            ${permissionCheck.role === 'admin' ? '<button class="btn" onclick="showAddAdminForm()">æ–°å¢ç®¡ç†å“¡</button>' : ''}
            <button class="btn" onclick="showUserManagement()">ç”¨æˆ¶ç®¡ç†</button>
            <button class="btn" onclick="showPaymentManagement()">ç¹³è²»ç®¡ç†</button>
          </div>
          
          <div id="adminContent">
            <!-- ç®¡ç†å“¡å…§å®¹å°‡è¼‰å…¥åˆ°é€™è£¡ -->
          </div>
          
          <button class="btn btn-secondary" onclick="backToMainSystem()">è¿”å›ä¸»ç³»çµ±</button>
        </div>
      `;
      
      // æ’å…¥ç®¡ç†å“¡é¢æ¿
      const container = document.querySelector('.content');
      container.insertAdjacentHTML('beforeend', adminPanelHTML);
      
      showSection('adminPanel');
      
    } catch (error) {
      debugLog('é¡¯ç¤ºç®¡ç†å“¡é¢æ¿å¤±æ•—', error);
      showError('è¼‰å…¥ç®¡ç†å“¡é¢æ¿å¤±æ•—');
    }
    }

    // é¡¯ç¤ºç®¡ç†å“¡åå–®
    async function showAdminList() {
    try {
      const result = await callAPI('get-admin-list', {
        userId: liffProfile.userId
      });
      
      if (!result.success) {
        showError(result.message);
        return;
      }
      
      const adminContent = document.getElementById('adminContent');
      
      const adminListHTML = `
        <div class="alert alert-success">
          <strong>ğŸ‘¥ ç®¡ç†å“¡åå–®</strong>
        </div>
        
        <div class="admin-list">
          ${result.admins.map(admin => `
            <div class="order-card">
              <div class="order-header">
                <div class="order-id">${admin.name}</div>
                <div class="order-status">${admin.role}</div>
              </div>
              <div class="order-details">
                <div>LINE ID: ${admin.lineId}</div>
                ${result.requestUserRole === 'admin' && admin.lineId !== liffProfile.userId ? `
                  <div style="margin-top: 10px;">
                    <button class="btn" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;" 
                            onclick="changeAdminRole('${admin.lineId}', '${admin.name}')">
                      ä¿®æ”¹æ¬Šé™
                    </button>
                    <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #dc3545;" 
                            onclick="removeAdminConfirm('${admin.lineId}', '${admin.name}')">
                      ç§»é™¤
                    </button>
                  </div>
                ` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      adminContent.innerHTML = adminListHTML;
      
    } catch (error) {
      debugLog('é¡¯ç¤ºç®¡ç†å“¡åå–®å¤±æ•—', error);
      showError('è¼‰å…¥ç®¡ç†å“¡åå–®å¤±æ•—');
    }
    }

    // é¡¯ç¤ºæ–°å¢ç®¡ç†å“¡è¡¨å–®
    function showAddAdminForm() {
    const adminContent = document.getElementById('adminContent');

    const addAdminFormHTML = `
      <div class="alert alert-info">
        <strong>â• æ–°å¢ç®¡ç†å“¡</strong>
      </div>
      
      <form id="addAdminForm" onsubmit="handleAddAdmin(event)">
        <div class="form-group">
          <label for="newAdminLineId">ç®¡ç†å“¡ LINE ID *</label>
          <input type="text" id="newAdminLineId" placeholder="ä¾‹ï¼šU1234567890abcdef" required>
          <small>è«‹è®“æ–°ç®¡ç†å“¡åœ¨ LIFF ç¨‹å¼ä¸­æŸ¥çœ‹è‡ªå·±çš„ LINE ID</small>
        </div>
        
        <div class="form-group">
          <label for="newAdminName">ç®¡ç†å“¡å§“å *</label>
          <input type="text" id="newAdminName" placeholder="è«‹è¼¸å…¥å§“å" required>
        </div>
        
        <div class="form-group">
          <label for="newAdminRole">æ¬Šé™ç­‰ç´š *</label>
          <select id="newAdminRole" required>
            <option value="">è«‹é¸æ“‡æ¬Šé™ç­‰ç´š</option>
            <option value="admin">admin - ç³»çµ±ç®¡ç†å“¡</option>
            <option value="moderator">moderator - ç‰ˆä¸»</option>
            <option value="viewer">viewer - æª¢è¦–è€…</option>
          </select>
        </div>
        
        <button type="submit" class="btn">æ–°å¢ç®¡ç†å“¡</button>
      </form>
    `;

    adminContent.innerHTML = addAdminFormHTML;
    }

    // è™•ç†æ–°å¢ç®¡ç†å“¡
    async function handleAddAdmin(event) {
    event.preventDefault();

    try {
      const newAdminData = {
        lineId: document.getElementById('newAdminLineId').value.trim(),
        name: document.getElementById('newAdminName').value.trim(),
        role: document.getElementById('newAdminRole').value
      };
      
      if (!newAdminData.lineId || !newAdminData.name || !newAdminData.role) {
        showError('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');
        return;
      }
      
      const result = await callAPI('add-admin', {
        requestUserId: liffProfile.userId,
        newAdminData: newAdminData
      });
      
      if (result.success) {
        showSuccess(result.message);
        showAdminList(); // é‡æ–°è¼‰å…¥ç®¡ç†å“¡åå–®
      } else {
        showError(result.message);
      }
      
    } catch (error) {
      debugLog('æ–°å¢ç®¡ç†å“¡å¤±æ•—', error);
      showError('æ–°å¢ç®¡ç†å“¡å¤±æ•—');
    }
    }

    // ç¢ºèªç§»é™¤ç®¡ç†å“¡
    function removeAdminConfirm(lineId, name) {
    if (confirm(`ç¢ºå®šè¦ç§»é™¤ç®¡ç†å“¡ã€Œ${name}ã€å—ï¼Ÿ`)) {
      removeAdminAction(lineId);
    }
    }

    // åŸ·è¡Œç§»é™¤ç®¡ç†å“¡
    async function removeAdminAction(lineId) {
    try {
      const result = await callAPI('remove-admin', {
        requestUserId: liffProfile.userId,
        targetLineId: lineId
      });
      
      if (result.success) {
        showSuccess(result.message);
        showAdminList(); // é‡æ–°è¼‰å…¥ç®¡ç†å“¡åå–®
      } else {
        showError(result.message);
      }
      
    } catch (error) {
      debugLog('ç§»é™¤ç®¡ç†å“¡å¤±æ•—', error);
      showError('ç§»é™¤ç®¡ç†å“¡å¤±æ•—');
    }
    }

    // ä¿®æ”¹ç®¡ç†å“¡æ¬Šé™
    function changeAdminRole(lineId, name) {
    const newRole = prompt(`è«‹è¼¸å…¥ã€Œ${name}ã€çš„æ–°æ¬Šé™ç­‰ç´šï¼š\n\nadmin - ç³»çµ±ç®¡ç†å“¡\nmoderator - ç‰ˆä¸»\nviewer - æª¢è¦–è€…`, '');

    if (newRole && ['admin', 'moderator', 'viewer'].includes(newRole)) {
      updateAdminRoleAction(lineId, newRole);
    } else if (newRole) {
      showError('ç„¡æ•ˆçš„æ¬Šé™ç­‰ç´š');
    }
    }

    // åŸ·è¡Œæ¬Šé™ä¿®æ”¹
    async function updateAdminRoleAction(lineId, newRole) {
    try {
      const result = await callAPI('update-admin-role', {
        requestUserId: liffProfile.userId,
        targetLineId: lineId,
        newRole: newRole
      });
      
      if (result.success) {
        showSuccess(result.message);
        showAdminList(); // é‡æ–°è¼‰å…¥ç®¡ç†å“¡åå–®
      } else {
        showError(result.message);
      }
      
    } catch (error) {
      debugLog('æ›´æ–°ç®¡ç†å“¡æ¬Šé™å¤±æ•—', error);
      showError('æ›´æ–°ç®¡ç†å“¡æ¬Šé™å¤±æ•—');
    }
    }

    // è¿”å›ä¸»ç³»çµ±
    function backToMainSystem() {
    const adminPanel = document.getElementById('adminPanel');
    if (adminPanel) {
      adminPanel.remove();
    }

    // æ ¹æ“šç”¨æˆ¶ç‹€æ…‹é¡¯ç¤ºé©ç•¶çš„å€åŸŸ
    if (currentOrderSummary) {
      showSection('ordersSection');
    } else {
      showSection('registrationSection');
    }
    }

  </script>
</body>
</html>
