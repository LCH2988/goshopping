<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOGO搶購回報系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .profile-image-container {
    width: 100px;
    height: 100px;
    margin: 0 auto;
    overflow: hidden;
}

.profile-image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

#errorAlert {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    min-width: 300px;
}

    </style>
</head>
<body>
    <div class="container">
        <div id="errorAlert" class="alert alert-danger d-none mt-3" role="alert"></div>
        
        <div class="card my-4">
            <div class="card-header">
                <h5 class="card-title mb-0">LINE 個人資料</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <div class="profile-image-container mb-3">
                        <img id="profileImage" src="https://placehold.co/100x100" alt="Profile Image" class="rounded-circle">
                    </div>
                    <h3 id="displayName" class="mb-2">載入中...</h3>
                    <p id="userId" class="text-muted">載入中...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      const CONFIG = {
    LIFF_ID: '1657285806-2bmkYWkN',
    GAS_URL: 'https://script.google.com/macros/s/AKfycbyQZACGk9SDIJ8X8pAhDI3-KBzbqkaCRgEDxVu10wHs3tZRHA7yoswKf_c7RhYBSqCw6w/exec'
};

class App {
    constructor() {
        this.initializeElements();
    }

    initializeElements() {
        this.profileImage = document.getElementById('profileImage');
        this.displayName = document.getElementById('displayName');
        this.userId = document.getElementById('userId');
    }

    showError(message) {
        const errorAlert = document.getElementById('errorAlert');
        errorAlert.textContent = message;
        errorAlert.classList.remove('d-none');
        setTimeout(() => {
            errorAlert.classList.add('d-none');
        }, 5000);
    }

    async initialize() {
        try {
            console.log('初始化 LIFF...');
            await this.initializeLiff();
        } catch (error) {
            console.error('初始化錯誤:', error);
            this.showError(`初始化失敗: ${error.message}`);
        }
    }

    async initializeLiff() {
        try {
            await liff.init({ liffId: CONFIG.LIFF_ID });
            
            if (!liff.isLoggedIn()) {
                console.log('用戶未登入，開始登入流程...');
                liff.login();
                return;
            }

            console.log('獲取用戶資料...');
            const profile = await liff.getProfile();
            this.updateProfile(profile);
            
            // 將資料傳送到 GAS
            await this.sendProfileToGAS(profile);
            
        } catch (error) {
            console.error('LIFF 初始化錯誤:', error);
            throw new Error(`LIFF 初始化失敗: ${error.message}`);
        }
    }

    updateProfile(profile) {
        this.profileImage.src = profile.pictureUrl;
        this.displayName.textContent = profile.displayName;
        this.userId.textContent = profile.userId;
    }

    async sendProfileToGAS(profile) {
        try {
            const response = await fetch(`${CONFIG.GAS_URL}?action=saveProfile&data=${encodeURIComponent(JSON.stringify(profile))}`);
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message);
            }
            
            console.log('資料已成功儲存到 GAS');
        } catch (error) {
            console.error('儲存資料錯誤:', error);
            this.showError(`儲存資料失敗: ${error.message}`);
        }
    }
}

// 當頁面載入完成後初始化應用
document.addEventListener('DOMContentLoaded', () => {
    const app = new App();
    app.initialize();
});

    </script>
</body>
</html>
