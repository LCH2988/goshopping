<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>訂購清單查詢系統</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      
      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #00B900, #00D300);
          min-height: 100vh;
          padding: 20px;
      }
      
      .container {
          max-width: 400px;
          margin: 0 auto;
          background: white;
          border-radius: 20px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.2);
          overflow: hidden;
      }
      
      .header {
          background: linear-gradient(45deg, #00B900, #00D300);
          color: white;
          padding: 30px 20px;
          text-align: center;
      }
      
      .header h1 {
          font-size: 24px;
          margin-bottom: 10px;
      }
      
      .content {
          padding: 30px 20px;
      }
      
      .tab-buttons {
          display: flex;
          margin-bottom: 30px;
          border-radius: 10px;
          overflow: hidden;
          background: #f5f5f5;
      }
      
      .tab-button {
          flex: 1;
          padding: 15px;
          text-align: center;
          background: #f5f5f5;
          border: none;
          cursor: pointer;
          font-size: 14px;
          transition: all 0.3s;
      }
      
      .tab-button.active {
          background: #00B900;
          color: white;
      }
      
      .tab-button:disabled {
          opacity: 0.5;
          cursor: not-allowed;
      }
      
      .tab-content {
          display: none;
      }
      
      .tab-content.active {
          display: block;
      }
      
      .form-group {
          margin-bottom: 20px;
      }
      
      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #333;
      }
      
      .form-group input, .form-group select {
          width: 100%;
          padding: 15px;
          border: 2px solid #e0e0e0;
          border-radius: 10px;
          font-size: 16px;
          transition: border-color 0.3s;
      }
      
      .form-group input:focus, .form-group select:focus {
          outline: none;
          border-color: #00B900;
      }
      
      .btn {
          width: 100%;
          padding: 15px;
          background: linear-gradient(45deg, #00B900, #00D300);
          color: white;
          border: none;
          border-radius: 10px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: transform 0.2s;
      }
      
      .btn:hover {
          transform: translateY(-2px);
      }
      
      .btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
          transform: none;
      }
      
      .order-item {
          background: #f8f9fa;
          padding: 20px;
          margin-bottom: 15px;
          border-radius: 10px;
          border-left: 4px solid #00B900;
      }
      
      .order-item h3 {
          color: #00B900;
          margin-bottom: 10px;
      }
      
      .order-detail {
          display: flex;
          justify-content: space-between;
          margin-bottom: 5px;
          font-size: 14px;
      }
      
      .total-amount {
          font-size: 18px;
          font-weight: bold;
          color: #e74c3c;
          text-align: right;
          margin-top: 10px;
      }
      
      .status-badge {
          display: inline-block;
          padding: 5px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
      }
      
      .status-pending {
          background: #fff3cd;
          color: #856404;
      }
      
      .status-paid {
          background: #d4edda;
          color: #155724;
      }
      
      .upload-area {
          border: 2px dashed #00B900;
          border-radius: 10px;
          padding: 30px;
          text-align: center;
          margin-bottom: 20px;
          cursor: pointer;
          transition: background-color 0.3s;
      }
      
      .upload-area:hover {
          background-color: #f8f9fa;
      }
      
      .upload-icon {
          font-size: 48px;
          color: #00B900;
          margin-bottom: 10px;
      }
      
      .user-info {
          background: #e8f5e8;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
          text-align: center;
      }
      
      .user-info h3 {
          color: #00B900;
          margin-bottom: 10px;
      }
      
      .loading {
          text-align: center;
          padding: 40px;
          color: #666;
      }
      
      .error {
          background: #f8d7da;
          color: #721c24;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
      }
      
      .success {
          background: #d4edda;
          color: #155724;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
      }
      
      .welcome-message {
          background: #e8f5e8;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
          margin-bottom: 20px;
      }
      
      .welcome-message h3 {
          color: #00B900;
          margin-bottom: 10px;
      }
      
      .registered-info {
          background: #d4edda;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
          margin-bottom: 20px;
      }
      
      .registered-info h3 {
          color: #155724;
          margin-bottom: 10px;
      }
      
      .lock-message {
          text-align: center;
          padding: 40px;
          color: #666;
          background: #f8f9fa;
          border-radius: 10px;
          margin: 20px 0;
      }
      
      .lock-icon {
          font-size: 48px;
          margin-bottom: 15px;
      }

      .btn-group {
          display: flex;
          gap: 10px;
      }

      .btn-group .btn {
          flex: 1;
      }

      .btn.secondary {
          background: linear-gradient(45deg, #e74c3c, #c0392b);
      }

      .debug-info {
          background: #f8f9fa;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
          font-family: monospace;
          font-size: 12px;
          border: 1px solid #dee2e6;
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>🛒 訂購管理系統</h1>
          <p>實名制登記 · 訂單查詢 · 繳費回報</p>
      </div>
      
      <div class="content">
          <!-- 除錯資訊 -->
          <div id="debugInfo" class="debug-info" style="display: none;">
              <strong>除錯資訊:</strong><br>
              <span id="debugText"></span>
          </div>

          <!-- 用戶資訊顯示 -->
          <div id="userInfo" class="user-info" style="display: none;">
              <h3>👤 會員資訊</h3>
              <p><strong>LINE 名稱:</strong> <span id="lineDisplayName"></span></p>
              <p><strong>真實姓名:</strong> <span id="realName"></span></p>
              <p><strong>註冊時間:</strong> <span id="registerTime"></span></p>
          </div>
          
          <!-- 標籤頁按鈕 -->
          <div class="tab-buttons">
              <button class="tab-button active" onclick="switchTab('register', event)">實名登記</button>
              <button class="tab-button" id="ordersTab" onclick="switchTab('orders', event)" disabled>我的訂單</button>
              <button class="tab-button" id="paymentTab" onclick="switchTab('payment', event)" disabled>繳費回報</button>
          </div>
          
          <!-- 實名制登記 -->
          <div id="register" class="tab-content active">
              <!-- 未註冊狀態 -->
              <div id="registerForm" style="display: none;">
                  <div class="welcome-message">
                      <h3>👋 歡迎使用訂購系統</h3>
                      <p>請先完成實名制登記，即可查詢訂單及進行繳費回報</p>
                  </div>
                  
                  <h2>📝 實名制登記</h2>
                  <form id="nameForm">
                      <div class="form-group">
                          <label for="realNameInput">真實姓名 *</label>
                          <input type="text" id="realNameInput" name="realName" required placeholder="請輸入您的真實姓名">
                      </div>
                      
                      <button type="submit" class="btn" id="registerSubmitBtn">完成登記</button>
                  </form>
              </div>
              
              <!-- 已註冊狀態 -->
              <div id="registeredStatus" style="display: none;">
                  <div class="registered-info">
                      <h3>✅ 實名制登記完成</h3>
                      <p>您已完成實名制登記，可以使用所有功能</p>
                  </div>
                  
                  <div class="btn-group">
                      <button class="btn" onclick="switchTab('orders', event)">查看我的訂單</button>
                      <button class="btn secondary" onclick="switchTab('payment', event)">進行繳費回報</button>
                  </div>
              </div>
          </div>
          
          <!-- 訂單查詢 -->
          <div id="orders" class="tab-content">
              <div id="ordersContent">
                  <div class="lock-message">
                      <div class="lock-icon">🔒</div>
                      <h3>請先完成實名制登記</h3>
                      <p>完成登記後即可查詢您的訂單資訊</p>
                  </div>
              </div>
          </div>
          
          <!-- 繳費回報 -->
          <div id="payment" class="tab-content">
              <div id="paymentContent">
                  <div class="lock-message">
                      <div class="lock-icon">🔒</div>
                      <h3>請先完成實名制登記</h3>
                      <p>完成登記後即可進行繳費回報</p>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <script>
      // 設定區域 - 請修改為您的實際值
      const CONFIG = {
          LIFF_ID: '2006578395-Ey6vNPBr', // 請替換為實際的 LIFF ID
          API_BASE_URL: 'https://script.google.com/macros/s/AKfycbwtps5xmvmleG1YZ5zhFyyfrRLzywlG0AiHVrWouY6tccjc2Q6-ltZzhBlngYZFqQ_t/exec', // 請替換為 GAS 部署網址
          DEBUG_MODE: true // 開啟除錯模式
      };

      let userId = null;
      let userProfile = null;
      let isRegistered = false;
      let userRegistrationData = null;

      // 除錯函數
      function debugLog(message, data = null) {
          console.log(message, data);
          if (CONFIG.DEBUG_MODE) {
              const debugDiv = document.getElementById('debugInfo');
              const debugText = document.getElementById('debugText');
              if (debugDiv && debugText) {
                  debugDiv.style.display = 'block';
                  debugText.innerHTML += `${new Date().toLocaleTimeString()}: ${message}<br>`;
                  if (data) {
                      debugText.innerHTML += `數據: ${JSON.stringify(data, null, 2)}<br>`;
                  }
                  debugText.innerHTML += '<br>';
              }
          }
      }

      // 初始化 LIFF
      window.onload = function() {
          debugLog('開始初始化 LIFF');
          initializeLiff();
      };

      async function initializeLiff() {
          try {
              debugLog('LIFF 初始化中...', { liffId: CONFIG.LIFF_ID });
              
              await liff.init({ liffId: CONFIG.LIFF_ID });
              debugLog('LIFF 初始化成功');
              
              if (liff.isLoggedIn()) {
                  debugLog('用戶已登入');
                  userProfile = await liff.getProfile();
                  userId = userProfile.userId;
                  
                  debugLog('取得用戶資料', {
                      userId: userId,
                      displayName: userProfile.displayName
                  });
                  
                  // 檢查用戶是否已註冊
                  await checkUserRegistration();
              } else {
                  debugLog('用戶未登入，導向登入頁面');
                  liff.login();
              }
          } catch (error) {
              debugLog('LIFF初始化失敗', error);
              console.error('LIFF初始化失敗:', error);
              showError('系統初始化失敗，請重新開啟: ' + error.message);
          }
      }

      // 修正的 API 呼叫函數
      async function callAPI(path, data, method = 'POST') {
          try {
              debugLog(`呼叫 API: ${path}`, data);
              
              const url = `${CONFIG.API_BASE_URL}?path=${encodeURIComponent(path)}`;
              
              const options = {
                  method: method,
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  mode: 'cors'
              };

              if (method === 'POST' && data) {
                  options.body = JSON.stringify(data);
              }

              debugLog('發送請求', { url, options });
              
              const response = await fetch(url, options);
              
              debugLog('收到回應', {
                  status: response.status,
                  statusText: response.statusText,
                  headers: Object.fromEntries(response.headers.entries())
              });
              
              if (!response.ok) {
                  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
              
              const result = await response.json();
              debugLog('API 回應結果', result);
              
              return result;
              
          } catch (error) {
              debugLog('API 呼叫失敗', error);
              console.error(`API 呼叫失敗 (${path}):`, error);
              throw error;
          }
      }

      async function checkUserRegistration() {
          try {
              debugLog('檢查用戶註冊狀態');
              
              const result = await callAPI('check-registration', {
                  userId: userId,
                  lineDisplayName: userProfile.displayName 
              });
              
              if (result.success && result.registered) {
                  debugLog('用戶已註冊');
                  isRegistered = true;
                  userRegistrationData = result.userInfo;
                  showRegisteredStatus();
                  enableAllTabs();
              } else {
                  debugLog('用戶未註冊');
                  showRegisterForm();
              }
          } catch (error) {
              debugLog('檢查註冊狀態失敗', error);
              console.error('檢查註冊狀態失敗:', error);
              showError('檢查註冊狀態失敗: ' + error.message);
              showRegisterForm(); // 發生錯誤時顯示註冊表單
          }
      }

      function showRegisterForm() {
          debugLog('顯示註冊表單');
          document.getElementById('registerForm').style.display = 'block';
          document.getElementById('registeredStatus').style.display = 'none';
      }

      function showRegisteredStatus() {
          debugLog('顯示已註冊狀態');
          document.getElementById('registerForm').style.display = 'none';
          document.getElementById('registeredStatus').style.display = 'block';
          
          // 顯示用戶資訊
          document.getElementById('lineDisplayName').textContent = userProfile.displayName;
          document.getElementById('realName').textContent = userRegistrationData.realName;
          document.getElementById('registerTime').textContent = new Date(userRegistrationData.registeredAt).toLocaleDateString('zh-TW');
          document.getElementById('userInfo').style.display = 'block';
      }

      function enableAllTabs() {
          debugLog('啟用所有標籤頁');
          document.getElementById('ordersTab').disabled = false;
          document.getElementById('paymentTab').disabled = false;
          
          // 更新訂單和繳費頁面內容
          updateOrdersContent();
          updatePaymentContent();
      }

      function updateOrdersContent() {
          document.getElementById('ordersContent').innerHTML = `
              <h2>📋 我的訂單</h2>
              <div id="ordersList">
                  <div class="loading">載入中...</div>
              </div>
              <button class="btn" onclick="loadOrders()">重新載入</button>
          `;
          loadOrders();
      }

      function updatePaymentContent() {
          document.getElementById('paymentContent').innerHTML = `
              <h2>💳 繳費回報</h2>
              
              <div class="form-group">
                  <label for="orderSelect">選擇訂單</label>
                  <select id="orderSelect">
                      <option value="">請選擇要繳費的訂單</option>
                  </select>
              </div>
              
              <div class="form-group">
                  <label>上傳繳費證明</label>
                  <div class="upload-area" onclick="document.getElementById('paymentProof').click()">
                      <div class="upload-icon">📷</div>
                      <p>點擊上傳繳費證明照片</p>
                      <small>支援 JPG, PNG 格式</small>
                  </div>
                  <input type="file" id="paymentProof" accept="image/*" style="display: none;" onchange="handleFileUpload(this)">
              </div>
              
              <div class="form-group">
                  <label for="paymentMethod">繳費方式</label>
                  <select id="paymentMethod">
                      <option value="bank_transfer">銀行轉帳</option>
                      <option value="cash">現金</option>
                      <option value="line_pay">LINE Pay</option>
                      <option value="credit_card">信用卡</option>
                  </select>
              </div>
              
              <div class="form-group">
                  <label for="paymentNote">備註</label>
                  <input type="text" id="paymentNote" placeholder="轉帳帳號後5碼或其他說明">
              </div>
              
              <button class="btn" onclick="submitPayment()">提交繳費證明</button>
          `;
          loadOrdersForPayment();
      }

      // 標籤頁切換 - 修正版本
      function switchTab(tabName, event) {
          debugLog(`切換標籤頁: ${tabName}`);
          
          // 檢查是否已註冊（除了register頁面）
          if (tabName !== 'register' && !isRegistered) {
              showError('請先完成實名制登記');
              return;
          }
          
          // 移除所有active class
          document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
          
          // 添加active class
          if (event && event.target) {
              event.target.classList.add('active');
          }
          document.getElementById(tabName).classList.add('active');
          
          // 載入對應內容
          if (tabName === 'orders' && isRegistered) {
              loadOrders();
          } else if (tabName === 'payment' && isRegistered) {
              loadOrdersForPayment();
          }
      }

      // 實名制登記 - 修正版本
      document.addEventListener('submit', async function(e) {
          if (e.target.id === 'nameForm') {
              e.preventDefault();
              
              debugLog('提交註冊表單');
              
              const formData = new FormData(e.target);
              const realName = formData.get('realName').trim();
              
              if (!realName) {
                  showError('請輸入真實姓名');
                  return;
              }
              
              const registerData = {
                  userId: userId,
                  lineDisplayName: userProfile.displayName,
                  realName: realName,
                  registeredAt: new Date().toISOString()
              };
              
              try {
                  // 顯示載入狀態
                  const submitBtn = document.getElementById('registerSubmitBtn');
                  const originalText = submitBtn.textContent;
                  submitBtn.textContent = '登記中...';
                  submitBtn.disabled = true;
                  
                  const result = await callAPI('register', registerData);
                  
                  if (result.success) {
                      debugLog('註冊成功');
                      showSuccess('實名制登記完成！');
                      isRegistered = true;
                      userRegistrationData = registerData;
                      showRegisteredStatus();
                      enableAllTabs();
                  } else {
                      debugLog('註冊失敗', result);
                      showError(result.message || '登記失敗，請稍後再試');
                      submitBtn.textContent = originalText;
                      submitBtn.disabled = false;
                  }
              } catch (error) {
                  debugLog('註冊失敗', error);
                  console.error('登記失敗:', error);
                  showError('登記失敗，請稍後再試: ' + error.message);
                  
                  const submitBtn = document.getElementById('registerSubmitBtn');
                  if (submitBtn) {
                      submitBtn.textContent = '完成登記';
                      submitBtn.disabled = false;
                  }
              }
          }
      });

      // 載入訂單
      async function loadOrders() {
          if (!isRegistered) return;
          
          debugLog('載入用戶訂單');
          document.getElementById('ordersList').innerHTML = '<div class="loading">載入中...</div>';
          
          try {
              const result = await callAPI('orders', { userId: userId });
              
              if (result.success && result.orders.length > 0) {
                  debugLog('訂單載入成功', result.orders);
                  displayOrders(result.orders);
              } else {
                  debugLog('無訂單記錄');
                  document.getElementById('ordersList').innerHTML = '<div class="error">暫無訂單記錄</div>';
              }
          } catch (error) {
              debugLog('載入訂單失敗', error);
              console.error('載入訂單失敗:', error);
              document.getElementById('ordersList').innerHTML = '<div class="error">載入失敗，請稍後再試: ' + error.message + '</div>';
          }
      }

      function displayOrders(orders) {
          let html = '';
          let totalAmount = 0;
          
          orders.forEach(order => {
              const statusClass = order.paymentStatus === '已付款' ? 'status-paid' : 'status-pending';
              const statusText = order.paymentStatus === '已付款' ? '已付款' : '待付款';
              
              html += `
                  <div class="order-item">
                      <h3>訂單 #${order.orderId}</h3>
                      <div class="order-detail">
                          <span>產品名稱:</span>
                          <span>${order.productName}</span>
                      </div>
                      <div class="order-detail">
                          <span>單價:</span>
                          <span>NT$ ${order.unitPrice.toLocaleString()}</span>
                        </div>
                        <div class="order-detail">
                            <span>數量:</span>
                            <span>${order.quantity}</span>
                        </div>
                        <div class="order-detail">
                            <span>狀態:</span>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="total-amount">
                            合計: NT$ ${order.totalAmount.toLocaleString()}
                        </div>
                    </div>
                `;
                totalAmount += order.totalAmount;
            });
            
            html += `
                <div class="order-item" style="background: #e8f5e8; border-left-color: #00B900;">
                    <div class="total-amount" style="font-size: 20px; color: #00B900;">
                        總金額: NT$ ${totalAmount.toLocaleString()}
                    </div>
                </div>
            `;
            
            document.getElementById('ordersList').innerHTML = html;
        }

        // 載入訂單供繳費選擇
        async function loadOrdersForPayment() {
            if (!isRegistered) return;
            
            debugLog('載入繳費訂單選項');
            
            try {
                const result = await callAPI('orders', { userId: userId });
                
                if (result.success && result.orders.length > 0) {
                    const select = document.getElementById('orderSelect');
                    if (select) {
                        select.innerHTML = '<option value="">請選擇要繳費的訂單</option>';
                        
                        result.orders.forEach(order => {
                            if (order.paymentStatus !== '已付款') {
                                select.innerHTML += `
                                    <option value="${order.orderId}">
                                        ${order.orderId} - ${order.productName} (NT$ ${order.totalAmount.toLocaleString()})
                                    </option>
                                `;
                            }
                        });
                    }
                }
            } catch (error) {
                debugLog('載入繳費訂單失敗', error);
                console.error('載入繳費訂單失敗:', error);
            }
        }

        // 處理檔案上傳
        function handleFileUpload(input) {
            const file = input.files[0];
            if (file) {
                debugLog('選擇檔案', { name: file.name, size: file.size, type: file.type });
                
                const uploadArea = document.querySelector('.upload-area');
                uploadArea.innerHTML = `
                    <div class="upload-icon">✅</div>
                    <p>已選擇: ${file.name}</p>
                    <small>檔案大小: ${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                `;
                uploadArea.style.background = '#d4edda';
            }
        }

        // 提交繳費證明
        async function submitPayment() {
            debugLog('提交繳費證明');
            
            const orderId = document.getElementById('orderSelect').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paymentNote = document.getElementById('paymentNote').value;
            const paymentProof = document.getElementById('paymentProof').files[0];
            
            if (!orderId) {
                showError('請選擇要繳費的訂單');
                return;
            }
            
            if (!paymentProof) {
                showError('請上傳繳費證明');
                return;
            }
            
            const paymentData = {
                userId: userId,
                orderId: orderId,
                paymentMethod: paymentMethod,
                paymentNote: paymentNote,
                realName: userRegistrationData.realName
            };
            
            try {
                const result = await callAPI('submit-payment', paymentData);
                
                if (result.success) {
                    debugLog('繳費證明提交成功');
                    showSuccess('繳費證明提交成功！我們會盡快處理您的申請。');
                    
                    // 清空表單
                    document.getElementById('orderSelect').value = '';
                    document.getElementById('paymentNote').value = '';
                    document.getElementById('paymentProof').value = '';
                    
                    // 重置上傳區域
                    const uploadArea = document.querySelector('.upload-area');
                    uploadArea.innerHTML = `
                        <div class="upload-icon">📷</div>
                        <p>點擊上傳繳費證明照片</p>
                        <small>支援 JPG, PNG 格式</small>
                    `;
                    uploadArea.style.background = '';
                    
                    // 重新載入訂單
                    loadOrdersForPayment();
                } else {
                    debugLog('繳費證明提交失敗', result);
                    showError(result.message || '提交失敗，請稍後再試');
                }
            } catch (error) {
                debugLog('繳費證明提交失敗', error);
                console.error('提交繳費證明失敗:', error);
                showError('提交失敗，請稍後再試: ' + error.message);
            }
        }

        // 顯示錯誤訊息
        function showError(message) {
            debugLog('顯示錯誤訊息', message);
            
            // 移除現有的訊息
            const existingMessages = document.querySelectorAll('.error, .success');
            existingMessages.forEach(msg => msg.remove());
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(errorDiv, content.firstChild);
            
            // 3秒後自動移除
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        // 顯示成功訊息
        function showSuccess(message) {
            debugLog('顯示成功訊息', message);
            
            // 移除現有的訊息
            const existingMessages = document.querySelectorAll('.error, .success');
            existingMessages.forEach(msg => msg.remove());
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(successDiv, content.firstChild);
            
            // 3秒後自動移除
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 3000);
        }

        // 頁面載入完成後的初始化
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM 載入完成');
            
            // 如果 LIFF 尚未初始化，則重新初始化
            if (!userId) {
                debugLog('重新初始化 LIFF');
                initializeLiff();
            }
        });

        // 錯誤處理
        window.addEventListener('error', function(e) {
            debugLog('全域錯誤', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                error: e.error
            });
            console.error('全域錯誤:', e);
        });

        // 未處理的 Promise 拒絕
        window.addEventListener('unhandledrejection', function(e) {
            debugLog('未處理的 Promise 拒絕', e.reason);
            console.error('未處理的 Promise 拒絕:', e.reason);
        });

    </script>
  </body>
  </html>
