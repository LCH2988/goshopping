<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF ç¹³è²»ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #FF8C69 0%, #FF7F50 50%, #FF6347 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(255, 99, 71, 0.3);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .admin-container {
            max-width: 800px;
        }

        .header {
            background: linear-gradient(135deg, #FF8C69, #FF7F50);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }

        .admin-header {
            background: linear-gradient(135deg, #4169E1, #1E90FF);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 30px 20px;
        }

        .user-info {
            background: linear-gradient(135deg, #FFF8DC, #FFE4B5);
            border: 2px solid #FF8C69;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .admin-info {
            background: linear-gradient(135deg, #E6F3FF, #CCE7FF);
            border: 2px solid #4169E1;
        }

        .user-info h2 {
            color: #D2691E;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .admin-info h2 {
            color: #1E90FF;
        }

        .user-info .line-name {
            color: #FF6347;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .admin-info .line-name {
            color: #4169E1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #D2691E;
            font-weight: 600;
            font-size: 14px;
        }

        .admin-label {
            color: #1E90FF !important;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #FFE4B5;
            border-radius: 12px;
            font-size: 16px;
            background: #FFFAF0;
            transition: all 0.3s ease;
        }

        .admin-input {
            border-color: #CCE7FF !important;
            background: #F8FBFF !important;
        }

        .admin-input:focus {
            border-color: #4169E1 !important;
            box-shadow: 0 0 0 3px rgba(65, 105, 225, 0.1) !important;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #FF8C69;
            box-shadow: 0 0 0 3px rgba(255, 140, 105, 0.1);
            background: white;
        }

        .form-group input.required {
            border-color: #FF6347;
            background: #FFF5F5;
        }

        .form-group input.required:focus {
            border-color: #FF4500;
            box-shadow: 0 0 0 3px rgba(255, 69, 0, 0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .btn-admin {
            background: linear-gradient(135deg, #4169E1, #1E90FF);
            color: white;
            box-shadow: 0 4px 15px rgba(65, 105, 225, 0.4);
        }

        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(65, 105, 225, 0.6);
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF8C69, #FF7F50);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 140, 105, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 140, 105, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #DEB887, #D2B48C);
            color: #8B4513;
            box-shadow: 0 4px 15px rgba(210, 180, 140, 0.4);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(210, 180, 140, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #32CD32, #228B22);
            color: white;
            box-shadow: 0 4px 15px rgba(50, 205, 50, 0.4);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(50, 205, 50, 0.6);
        }

        .btn-warning {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #8B4513;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
        }

        .btn-danger {
            background: linear-gradient(135deg, #FF6B6B, #FF4757);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        .btn:disabled {
            background: #ccc;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .order-item, .payment-item {
            background: linear-gradient(135deg, #FFFAF0, #FFF8DC);
            border: 2px solid #FFE4B5;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(255, 140, 105, 0.1);
            border-left: 5px solid #FF8C69;
        }

        .admin-item {
            background: linear-gradient(135deg, #F8FBFF, #E6F3FF);
            border: 2px solid #CCE7FF;
            border-left: 5px solid #4169E1;
        }

        .order-header, .payment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #FFE4B5;
        }

        .admin-header-item {
            border-bottom: 2px solid #CCE7FF;
        }

        .order-header h3, .payment-header h3 {
            margin: 0;
            color: #D2691E;
            font-size: 18px;
        }

        .admin-item h3 {
            color: #1E90FF !important;
        }

        .product-info {
            margin-top: 12px;
        }

        .product-name {
            font-size: 16px;
            color: #8B4513;
            margin-bottom: 12px;
            padding: 12px;
            background: linear-gradient(135deg, #FFF8DC, #FFFAF0);
            border-radius: 8px;
            border: 1px solid #FFE4B5;
            font-weight: 600;
        }

        .order-details, .payment-details {
            margin: 12px 0;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #FFE4B5;
        }

        .admin-detail-row {
            border-bottom: 1px solid #CCE7FF;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .total-row {
            background: linear-gradient(135deg, #FFE4B5, #F5DEB3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 8px;
            font-weight: bold;
            border: 2px solid #FF8C69;
        }

        .label {
            color: #D2691E;
            font-size: 14px;
            font-weight: 500;
        }

        .admin-label-text {
            color: #1E90FF;
        }

        .value {
            color: #8B4513;
            font-weight: 600;
        }

        .total-amount {
            color: #FF6347;
            font-size: 16px;
            font-weight: bold;
        }

        .order-date {
            font-size: 12px;
            color: #CD853F;
            margin-top: 12px;
            text-align: right;
        }

        .status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-paid {
            background: linear-gradient(135deg, #98FB98, #90EE90);
            color: #006400;
            border: 1px solid #32CD32;
        }

        .status-pending {
            background: linear-gradient(135deg, #FFE4B5, #F5DEB3);
            color: #FF8C00;
            border: 1px solid #FF8C69;
        }

        .status-confirmed {
            background: linear-gradient(135deg, #98FB98, #90EE90);
            color: #006400;
            border: 1px solid #32CD32;
        }

        .status-rejected {
            background: linear-gradient(135deg, #FFB6C1, #FFA0B4);
            color: #8B0000;
            border: 1px solid #DC143C;
        }

        .status-review {
            background: linear-gradient(135deg, #FFE4B5, #F5DEB3);
            color: #FF8C00;
            border: 1px solid #FF8C69;
        }

        .order-summary {
            background: linear-gradient(135deg, #FF8C69, #FF7F50);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 6px 20px rgba(255, 140, 105, 0.3);
        }

        .admin-summary {
            background: linear-gradient(135deg, #4169E1, #1E90FF);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .total-summary {
            border-top: 2px solid rgba(255,255,255,0.3);
            margin-top: 12px;
            padding-top: 15px;
            font-size: 18px;
            font-weight: bold;
        }

        .summary-label {
            font-size: 14px;
        }

        .summary-value {
            font-weight: bold;
        }

        .payment-methods {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }

        .payment-method {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border: 2px solid #FFE4B5;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-method:hover {
            border-color: #FF8C69;
            background: #FFFAF0;
        }

        .payment-method.selected {
            border-color: #FF6347;
            background: linear-gradient(135deg, #FFE4B5, #F5DEB3);
        }

        .payment-method input[type="radio"] {
            margin-right: 12px;
            accent-color: #FF8C69;
        }

        .payment-method label {
            font-weight: 500;
            color: #8B4513;
            cursor: pointer;
            flex: 1;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #FFE4B5;
            border-radius: 12px;
            font-size: 14px;
            background: #FFFAF0;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        textarea:focus {
            outline: none;
            border-color: #FF8C69;
            box-shadow: 0 0 0 3px rgba(255, 140, 105, 0.1);
            background: white;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #FF8C69;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #FFE4B5;
            border-top: 3px solid #FF8C69;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success {
            background: linear-gradient(135deg, #98FB98, #90EE90);
            color: #006400;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            border: 2px solid #32CD32;
        }

        .error {
            background: linear-gradient(135deg, #FFB6C1, #FFA0B4);
            color: #8B0000;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            border: 2px solid #DC143C;
        }

        .info {
            background: linear-gradient(135deg, #E0F6FF, #B0E0E6);
            color: #4682B4;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            border: 2px solid #87CEEB;
        }

        .required-note {
            font-size: 12px;
            color: #FF6347;
            margin-top: 5px;
            font-style: italic;
        }

        .user-display {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF8C69, #FF7F50);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .admin-avatar {
            background: linear-gradient(135deg, #4169E1, #1E90FF);
        }

        .menu-buttons {
            display: grid;
            gap: 12px;
            margin-top: 20px;
        }

        .admin-menu-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .payment-form {
            background: linear-gradient(135deg, #FFFAF0, #FFF8DC);
            border: 2px solid #FFE4B5;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .admin-form {
            background: linear-gradient(135deg, #F8FBFF, #E6F3FF);
            border: 2px solid #CCE7FF;
        }

        .payment-form h3 {
            color: #D2691E;
            margin-bottom: 20px;
            text-align: center;
            font-size: 18px;
        }

        .admin-form h3 {
            color: #1E90FF;
        }

        .transfer-note {
            background: #FFF8DC;
            border: 1px solid #FFE4B5;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #D2691E;
            display: none;
        }

        .transfer-note.show {
            display: block;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-bar input {
            flex: 1;
            padding: 12px;
            border: 2px solid #CCE7FF;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-bar button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #4169E1, #1E90FF);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .action-buttons button {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-confirm {
            background: linear-gradient(135deg, #32CD32, #228B22);
            color: white;
        }

        .btn-reject {
            background: linear-gradient(135deg, #FF6B6B, #FF4757);
            color: white;
        }

        .admin-tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f0f0f0;
            border-radius: 8px;
            padding: 4px;
        }

        .admin-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
        }

        .admin-tab.active {
            background: linear-gradient(135deg, #4169E1, #1E90FF);
            color: white;
        }

        @media (max-width: 480px) {
            .container {
                margin: 5px;
                border-radius: 15px;
            }
            
            .content {
                padding: 20px 15px;
            }
            
            .header {
                padding: 20px 15px;
            }

            .admin-menu-buttons {
                grid-template-columns: 1fr;
            }

            .search-bar {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        @media (min-width: 481px) {
            .admin-container {
                max-width: 800px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <div class="header" id="mainHeader">
            <h1 id="headerTitle">ğŸ’³ LIFF ç¹³è²»ç³»çµ±</h1>
            <div class="subtitle" id="headerSubtitle">å®‰å…¨ä¾¿åˆ©çš„ç·šä¸Šç¹³è²»å¹³å°</div>
        </div>

        <div class="content">
            <!-- è¼‰å…¥ä¸­ -->
            <div id="loading" class="loading show">
                <div class="spinner"></div>
                <div>ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
            </div>

            <!-- æœªè¨»å†Šç”¨æˆ¶ - è¨»å†Šå€æ®µ -->
            <div id="registerSection" class="section">
                <div class="user-info">
                    <h2>ğŸ‘‹ æ­¡è¿ä½¿ç”¨</h2>
                    <div id="unregisteredUserDisplay" class="user-display">
                        <div id="unregisteredUserAvatar" class="user-avatar"></div>
                        <div>
                            <div id="unregisteredLineName" class="line-name"></div>
                            <div style="font-size: 12px; color: #CD853F;">LINE ç”¨æˆ¶</div>
                        </div>
                    </div>
                    <div class="info">è«‹å…ˆå®Œæˆè¨»å†Šæ‰èƒ½ä½¿ç”¨ç¹³è²»åŠŸèƒ½</div>
                </div>

                <form id="registerForm">
                    <div class="form-group">
                        <label for="registerRealName">çœŸå¯¦å§“å <span style="color: #FF6347;">*</span></label>
                        <input type="text" id="registerRealName" name="realName" class="required" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å">
                        <div class="required-note">æ­¤è³‡è¨Šç”¨æ–¼è¨‚å–®æ ¸å°ï¼Œè«‹å‹™å¿…å¡«å¯«æ­£ç¢º</div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="registerBtn">
                        ğŸ“ ç¢ºèªé€å‡º
                    </button>
                </form>
            </div>

            <!-- å·²è¨»å†Šç”¨æˆ¶ - ä¸»é¸å–®å€æ®µ -->
            <div id="menuSection" class="section">
                <div class="user-info" id="userInfoCard">
                    <h2 id="welcomeTitle">ğŸ‰ æ­¡è¿å›ä¾†</h2>
                    <div id="registeredUserDisplay" class="user-display">
                        <div id="registeredUserAvatar" class="user-avatar"></div>
                        <div>
                            <div id="registeredLineName" class="line-name"></div>
                            <div id="registeredRealName" style="font-size: 14px; color: #8B4513; font-weight: 600;"></div>
                            <div id="adminBadge" style="display: none; font-size: 12px; color: #1E90FF; font-weight: bold;">ğŸ‘‘ ç®¡ç†å“¡</div>
                        </div>
                    </div>
                </div>

                <div class="menu-buttons" id="normalMenuButtons">
                    <button class="btn btn-secondary" onclick="showModifySection()">
                        âœï¸ ç¢ºèªä¿®æ”¹ (è®Šæ›´åå­—)
                    </button>
                    
                    <button class="btn btn-primary" onclick="loadUserOrders()">
                        ğŸ“‹ æŸ¥è©¢è¨‚è³¼æ¸…å–®
                    </button>
                    
                    <button class="btn btn-success" onclick="showPaymentSection()">
                        ğŸ’³ ç¹³è²»
                    </button>
                </div>

                <div class="admin-menu-buttons" id="adminMenuButtons" style="display: none;">
                    <button class="btn btn-admin" onclick="showPaymentReviewSection()">
                        ğŸ” ç¹³è²»å¯©æŸ¥
                    </button>
                    
                    <button class="btn btn-admin" onclick="showOrderQuerySection()">
                        ğŸ“‹ æŸ¥è©¢è¨‚å–®
                    </button>
                    
                    <button class="btn btn-secondary" onclick="showModifySection()">
                        âœï¸ ä¿®æ”¹è³‡æ–™
                    </button>
                    
                    <button class="btn btn-primary" onclick="loadUserOrders()">
                        ğŸ“‹ æˆ‘çš„è¨‚å–®
                    </button>
                    
                    <button class="btn btn-success" onclick="showPaymentSection()">
                        ğŸ’³ ç¹³è²»
                    </button>
                    
                    <button class="btn btn-warning" onclick="showUserManagementSection()">
                        ğŸ‘¥ ç”¨æˆ¶ç®¡ç†
                    </button>
                </div>
            </div>

            <!-- ä¿®æ”¹è³‡æ–™å€æ®µ -->
            <div id="modifySection" class="section">
                <div class="user-info">
                    <h2>âœï¸ ä¿®æ”¹å€‹äººè³‡æ–™</h2>
                    <div class="user-display">
                        <div id="modifyUserAvatar" class="user-avatar"></div>
                        <div>
                            <div id="modifyLineName" class="line-name"></div>
                            <div style="font-size: 12px; color: #CD853F;">LINE ç”¨æˆ¶</div>
                        </div>
                    </div>
                </div>

                <form id="modifyForm">
                    <div class="form-group">
                        <label for="modifyRealName">çœŸå¯¦å§“å</label>
                        <input type="text" id="modifyRealName" name="realName" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å">
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="modifyBtn">
                        âœ… ç¢ºèªä¿®æ”¹
                    </button>
                    
                    <button type="button" class="btn btn-secondary" onclick="showMenuSection()">
                        â¬…ï¸ è¿”å›ä¸»é¸å–®
                    </button>
                </form>
            </div>

            <!-- è¨‚å–®åˆ—è¡¨å€æ®µ -->
            <div id="ordersSection" class="section">
                <div class="user-info">
                    <h2>ğŸ“‹ æˆ‘çš„è¨‚å–®</h2>
                    <div class="user-display">
                          <div id="orderUserAvatar" class="user-avatar"></div>
                          <div>
                              <div id="orderLineName" class="line-name"></div>
                              <div id="orderRealName" style="font-size: 14px; color: #8B4513; font-weight: 600;"></div>
                          </div>
                      </div>
                  </div>

                  <div id="ordersList"></div>
                  
                  <button class="btn btn-secondary" onclick="showMenuSection()">
                      â¬…ï¸ è¿”å›ä¸»é¸å–®
                  </button>
              </div>

              <!-- ç¹³è²»å€æ®µ -->
              <div id="paymentSection" class="section">
                  <div class="user-info">
                      <h2>ğŸ’³ é¸æ“‡ç¹³è²»æ–¹å¼</h2>
                      <div class="user-display">
                          <div id="paymentUserAvatar" class="user-avatar"></div>
                          <div>
                              <div id="paymentLineName" class="line-name"></div>
                              <div id="paymentRealName" style="font-size: 14px; color: #8B4513; font-weight: 600;"></div>
                          </div>
                      </div>
                  </div>

                  <div class="payment-form">
                      <h3>è«‹é¸æ“‡æ‚¨çš„ç¹³è²»æ–¹å¼</h3>
                      
                      <div class="payment-methods">
                          <div class="payment-method" data-method="ç¾é‡‘">
                              <input type="radio" name="paymentMethod" value="ç¾é‡‘" id="cash">
                              <label for="cash">ğŸ’µ ç¾é‡‘ç¹³è²»</label>
                          </div>
                          
                          <div class="payment-method" data-method="è½‰å¸³">
                              <input type="radio" name="paymentMethod" value="è½‰å¸³" id="transfer">
                              <label for="transfer">ğŸ¦ éŠ€è¡Œè½‰å¸³</label>
                          </div>
                          
                          <div class="payment-method" data-method="ä¿¡ç”¨å¡">
                              <input type="radio" name="paymentMethod" value="ä¿¡ç”¨å¡" id="creditCard">
                              <label for="creditCard">ğŸ’³ ä¿¡ç”¨å¡</label>
                          </div>
                      </div>

                      <div id="transferNote" class="transfer-note">
                          ğŸ’¡ è½‰å¸³æé†’ï¼šè«‹åœ¨å‚™è¨»æ¬„å¡«å¯«æ‚¨çš„å¸³è™Ÿå¾Œ5ç¢¼ï¼Œä»¥ä¾¿æ ¸å°
                      </div>

                      <div class="form-group">
                          <label for="paymentNote">å‚™è¨» (é¸å¡«)</label>
                          <textarea id="paymentNote" placeholder="å¦‚é¸æ“‡è½‰å¸³ï¼Œè«‹æä¾›å¸³è™Ÿå¾Œ5ç¢¼ç­‰ç›¸é—œè³‡è¨Š..."></textarea>
                      </div>
                      
                      <button class="btn btn-primary" onclick="confirmPayment()">
                          âœ… ç¢ºèªç¹³è²»æ–¹å¼é€å‡º
                      </button>
                      
                      <button class="btn btn-secondary" onclick="showMenuSection()">
                          â¬…ï¸ è¿”å›ä¸»é¸å–®
                      </button>
                  </div>
              </div>

              <!-- ç®¡ç†å“¡ - ç¹³è²»å¯©æŸ¥å€æ®µ -->
              <div id="paymentReviewSection" class="section">
                  <div class="user-info admin-info">
                      <h2>ğŸ” ç¹³è²»å¯©æŸ¥ç®¡ç†</h2>
                      <div class="user-display">
                          <div id="reviewUserAvatar" class="user-avatar admin-avatar"></div>
                          <div>
                              <div id="reviewLineName" class="line-name">ç®¡ç†å“¡</div>
                              <div style="font-size: 12px; color: #1E90FF;">ğŸ‘‘ ç®¡ç†å“¡æ¬Šé™</div>
                          </div>
                      </div>
                  </div>

                  <div class="admin-form">
                      <div class="search-bar">
                          <input type="text" id="paymentSearchInput" placeholder="æœå°‹å§“åã€ç¹³è²»æ–¹å¼æˆ–å‚™è¨»...">
                          <button onclick="searchPayments()">ğŸ” æœå°‹</button>
                          <button onclick="loadAllPayments()">ğŸ“‹ å…¨éƒ¨</button>
                      </div>

                      <div class="admin-tabs">
                          <button class="admin-tab active" onclick="filterPayments('all')">å…¨éƒ¨</button>
                          <button class="admin-tab" onclick="filterPayments('pending')">å¾…å¯©æ ¸</button>
                          <button class="admin-tab" onclick="filterPayments('confirmed')">å·²ç¢ºèª</button>
                          <button class="admin-tab" onclick="filterPayments('rejected')">æœªæ”¶åˆ°</button>
                      </div>

                      <div id="paymentReviewList"></div>
                  </div>
                  
                  <button class="btn btn-secondary" onclick="showMenuSection()">
                      â¬…ï¸ è¿”å›ä¸»é¸å–®
                  </button>
              </div>

              <!-- ç®¡ç†å“¡ - æŸ¥è©¢è¨‚å–®å€æ®µ -->
              <div id="orderQuerySection" class="section">
                  <div class="user-info admin-info">
                      <h2>ğŸ“‹ è¨‚å–®æŸ¥è©¢ç®¡ç†</h2>
                      <div class="user-display">
                          <div id="queryUserAvatar" class="user-avatar admin-avatar"></div>
                          <div>
                              <div id="queryLineName" class="line-name">ç®¡ç†å“¡</div>
                              <div style="font-size: 12px; color: #1E90FF;">ğŸ‘‘ ç®¡ç†å“¡æ¬Šé™</div>
                          </div>
                      </div>
                  </div>

                  <div class="admin-form">
                      <div class="form-group">
                          <label for="queryLineNameInput" class="admin-label">è¼¸å…¥ LINE åç¨±</label>
                          <input type="text" id="queryLineNameInput" class="admin-input" placeholder="è«‹è¼¸å…¥è¦æŸ¥è©¢çš„ LINE åç¨±">
                      </div>
                      
                      <button class="btn btn-admin" onclick="queryUserOrders()">
                          ğŸ” æŸ¥è©¢è¨‚å–®
                      </button>

                      <div id="queryOrdersList"></div>
                  </div>
                  
                  <button class="btn btn-secondary" onclick="showMenuSection()">
                      â¬…ï¸ è¿”å›ä¸»é¸å–®
                  </button>
              </div>

              <!-- ç®¡ç†å“¡ - ç”¨æˆ¶ç®¡ç†å€æ®µ -->
              <div id="userManagementSection" class="section">
                  <div class="user-info admin-info">
                      <h2>ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</h2>
                      <div class="user-display">
                          <div id="userMgmtUserAvatar" class="user-avatar admin-avatar"></div>
                          <div>
                              <div id="userMgmtLineName" class="line-name">ç®¡ç†å“¡</div>
                              <div style="font-size: 12px; color: #1E90FF;">ğŸ‘‘ ç®¡ç†å“¡æ¬Šé™</div>
                          </div>
                      </div>
                  </div>

                  <div class="admin-form">
                      <div class="search-bar">
                          <input type="text" id="userSearchInput" placeholder="æœå°‹ç”¨æˆ¶åç¨±...">
                          <button onclick="searchUsers()">ğŸ” æœå°‹</button>
                          <button onclick="loadAllUsers()">ğŸ“‹ å…¨éƒ¨</button>
                      </div>

                      <div id="userManagementList"></div>
                  </div>
                  
                  <button class="btn btn-secondary" onclick="showMenuSection()">
                      â¬…ï¸ è¿”å›ä¸»é¸å–®
                  </button>
              </div>
          </div>
      </div>

      <script>
          // å…¨åŸŸè®Šæ•¸
          const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbyESTwQLa7Yn-wGoi09HinBtCI0YKsnQsHizc-hhCBGIDUnnbGuULNfv0ZArpLmo4Jk/exec'; // è«‹æ›¿æ›ç‚ºæ‚¨çš„ GAS éƒ¨ç½² URL
          let liff;
          let liffData = {};
          let currentUser = null;
          let userOrders = [];
          let allPayments = [];
          let allUsers = [];
          let currentFilter = 'all';

          // LIFF åˆå§‹åŒ–
          // ä¿®æ”¹åˆå§‹åŒ–å‡½æ•¸
          async function initializeLiff() {
              try {
                  // æª¢æŸ¥ LIFF SDK æ˜¯å¦è¼‰å…¥
                  if (typeof liff === 'undefined') {
                      throw new Error('LIFF SDK æœªè¼‰å…¥');
                  }

                  console.log('é–‹å§‹åˆå§‹åŒ– LIFF...');
                  
                  await liff.init({ liffId: '1657285806-2bmkYWkN' }); // è«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID
                  
                  if (!liff.isLoggedIn()) {
                      console.log('ç”¨æˆ¶æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
                      liff.login();
                      return;
                  }

                  // å–å¾—ç”¨æˆ¶è³‡æ–™
                  const profile = await liff.getProfile();
                  liffData = {
                      userId: profile.userId,
                      displayName: profile.displayName,
                      pictureUrl: profile.pictureUrl
                  };

                  console.log('LIFF åˆå§‹åŒ–æˆåŠŸ:', liffData);
                  
                  // æª¢æŸ¥è¨»å†Šç‹€æ…‹
                  await checkRegistrationStatus();

              } catch (error) {
                  console.error('LIFF åˆå§‹åŒ–éŒ¯èª¤:', error);
                  document.getElementById('loading').innerHTML = 
                      `<div class="error">
                          <h3>åˆå§‹åŒ–å¤±æ•—</h3>
                          <p>éŒ¯èª¤è¨Šæ¯: ${error.message}</p>
                          <p>è«‹æª¢æŸ¥ï¼š</p>
                          <ul style="text-align: left; margin: 10px 0;">
                              <li>LIFF ID æ˜¯å¦æ­£ç¢ºè¨­å®š</li>
                              <li>æ˜¯å¦åœ¨ LINE ç’°å¢ƒä¸­é–‹å•Ÿ</li>
                              <li>ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸</li>
                          </ul>
                          <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #FF6B6B; color: white; border: none; border-radius: 4px; cursor: pointer;">
                              é‡æ–°è¼‰å…¥é é¢
                          </button>
                      </div>`;
              }
          }

          // ä¿®æ”¹é é¢è¼‰å…¥äº‹ä»¶
          document.addEventListener('DOMContentLoaded', () => {
              console.log('é é¢è¼‰å…¥å®Œæˆ');
              
              // ç­‰å¾…ä¸€å°æ®µæ™‚é–“ç¢ºä¿ LIFF SDK å®Œå…¨è¼‰å…¥
              setTimeout(() => {
                  initializeLiff();
              }, 100);
          });

          // ä¹Ÿå¯ä»¥ç›£è½ window.onload äº‹ä»¶ä½œç‚ºå‚™ç”¨
          window.addEventListener('load', () => {
              console.log('æ‰€æœ‰è³‡æºè¼‰å…¥å®Œæˆ');
              
              // å¦‚æœ LIFF é‚„æ²’åˆå§‹åŒ–ï¼Œå†è©¦ä¸€æ¬¡
              if (typeof liffData === 'undefined' || !liffData.userId) {
                  setTimeout(() => {
                      if (typeof liff !== 'undefined') {
                          initializeLiff();
                      }
                  }, 500);
              }
          });

// åœ¨å…¨åŸŸç¯„åœåŠ å…¥åµéŒ¯è³‡è¨Š
console.log('æª¢æŸ¥ LIFF SDK è¼‰å…¥ç‹€æ…‹:', typeof liff);

// åŠ å…¥æ›´è©³ç´°çš„éŒ¯èª¤è™•ç†
function handleLiffError(error) {
    console.error('LIFF éŒ¯èª¤è©³æƒ…:', error);
    
    let errorMessage = 'åˆå§‹åŒ–å¤±æ•—';
    let suggestions = [];
    
    if (error.message.includes('LIFF SDK')) {
        errorMessage = 'LIFF SDK è¼‰å…¥å¤±æ•—';
        suggestions = [
            'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·š',
            'ç¢ºèªåœ¨ LINE æ‡‰ç”¨ç¨‹å¼ä¸­é–‹å•Ÿ',
            'é‡æ–°è¼‰å…¥é é¢'
        ];
    } else if (error.message.includes('liff id')) {
        errorMessage = 'LIFF ID è¨­å®šéŒ¯èª¤';
        suggestions = [
            'è«‹æª¢æŸ¥ LIFF ID æ˜¯å¦æ­£ç¢º',
            'ç¢ºèª LIFF æ‡‰ç”¨ç¨‹å¼å·²å•Ÿç”¨'
        ];
    } else if (error.message.includes('login')) {
        errorMessage = 'ç™»å…¥å¤±æ•—';
        suggestions = [
            'è«‹é‡æ–°ç™»å…¥ LINE',
            'æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼æ¬Šé™'
        ];
    }
    
    document.getElementById('loading').innerHTML = 
        `<div class="error">
            <h3>${errorMessage}</h3>
            <p>éŒ¯èª¤è©³æƒ…: ${error.message}</p>
            <div style="margin: 15px 0;">
                <strong>å»ºè­°è§£æ±ºæ–¹æ¡ˆ:</strong>
                <ul style="text-align: left; margin: 10px 0;">
                    ${suggestions.map(s => `<li>${s}</li>`).join('')}
                </ul>
            </div>
            <button onclick="location.reload()" class="btn btn-primary">
                ğŸ”„ é‡æ–°è¼‰å…¥é é¢
            </button>
        </div>`;
}

// ä¿®æ”¹åˆå§‹åŒ–å‡½æ•¸ä½¿ç”¨æ–°çš„éŒ¯èª¤è™•ç†
async function initializeLiff() {
    try {
        if (typeof liff === 'undefined') {
            throw new Error('LIFF SDK æœªè¼‰å…¥ï¼Œè«‹ç¢ºèªåœ¨ LINE ç’°å¢ƒä¸­é–‹å•Ÿ');
        }

        console.log('LIFF SDK è¼‰å…¥æˆåŠŸï¼Œé–‹å§‹åˆå§‹åŒ–...');
        
        await liff.init({ liffId: '1657285806-2bmkYWkN' });
        
        if (!liff.isLoggedIn()) {
            console.log('ç”¨æˆ¶æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
            liff.login();
            return;
        }

        const profile = await liff.getProfile();
        liffData = {
            userId: profile.userId,
            displayName: profile.displayName,
            pictureUrl: profile.pictureUrl
        };

        console.log('LIFF åˆå§‹åŒ–æˆåŠŸ:', liffData);
        await checkRegistrationStatus();

    } catch (error) {
        handleLiffError(error);
    }
}


          // æª¢æŸ¥è¨»å†Šç‹€æ…‹
          async function checkRegistrationStatus() {
              try {
                  const response = await fetch(`${API_BASE_URL}?action=check-registration&data=${encodeURIComponent(JSON.stringify({
                      userId: liffData.userId,
                      lineDisplayName: liffData.displayName
                  }))}`);
                  
                  const result = await response.json();
                  console.log('è¨»å†Šç‹€æ…‹æª¢æŸ¥çµæœ:', result);

                  document.getElementById('loading').classList.remove('show');

                  if (result.success && result.registered) {
                      currentUser = result.userInfo;
                      await checkAdminStatus();
                      showMenuSection();
                  } else {
                      showRegisterSection();
                  }

              } catch (error) {
                  console.error('æª¢æŸ¥è¨»å†Šç‹€æ…‹éŒ¯èª¤:', error);
                  document.getElementById('loading').innerHTML = 
                      '<div class="error">æª¢æŸ¥è¨»å†Šç‹€æ…‹å¤±æ•—: ' + error.message + '</div>';
              }
          }

          // æª¢æŸ¥ç®¡ç†å“¡èº«åˆ†
          async function checkAdminStatus() {
              try {
                  const response = await fetch(`${API_BASE_URL}?action=check-admin&data=${encodeURIComponent(JSON.stringify({
                      userId: liffData.userId,
                      lineDisplayName: liffData.displayName,
                      realName: currentUser.realName
                  }))}`);
                  
                  const result = await response.json();
                  console.log('ç®¡ç†å“¡æª¢æŸ¥çµæœ:', result);

                  if (result.success && result.isAdmin) {
                      currentUser.isAdmin = true;
                      setupAdminInterface();
                  }

              } catch (error) {
                  console.error('æª¢æŸ¥ç®¡ç†å“¡èº«åˆ†éŒ¯èª¤:', error);
              }
          }

          // è¨­å®šç®¡ç†å“¡ä»‹é¢
          function setupAdminInterface() {
              // æ›´æ”¹å®¹å™¨æ¨£å¼
              document.getElementById('mainContainer').classList.add('admin-container');
              document.getElementById('mainHeader').classList.add('admin-header');
              document.getElementById('headerTitle').textContent = 'ğŸ‘‘ LIFF ç®¡ç†ç³»çµ±';
              document.getElementById('headerSubtitle').textContent = 'ç®¡ç†å“¡å°ˆç”¨æ§åˆ¶å°';
              
              // é¡¯ç¤ºç®¡ç†å“¡æ¨™èªŒ
              document.getElementById('adminBadge').style.display = 'block';
              document.getElementById('welcomeTitle').textContent = 'ğŸ‘‘ ç®¡ç†å“¡æ­¡è¿';
              document.getElementById('userInfoCard').classList.add('admin-info');
              
              // åˆ‡æ›é¸å–®
              document.getElementById('normalMenuButtons').style.display = 'none';
              document.getElementById('adminMenuButtons').style.display = 'grid';
          }

          // é¡¯ç¤ºè¨»å†Šå€æ®µ
          function showRegisterSection() {
              document.getElementById('unregisteredLineName').textContent = liffData.displayName;
              document.getElementById('unregisteredUserAvatar').textContent = liffData.displayName.charAt(0).toUpperCase();
              
              document.querySelectorAll('.section').forEach(section => {
                  section.classList.remove('active');
              });
              document.getElementById('registerSection').classList.add('active');
          }

          // é¡¯ç¤ºä¸»é¸å–®å€æ®µ
          function showMenuSection() {
              document.getElementById('registeredLineName').textContent = liffData.displayName;
              document.getElementById('registeredRealName').textContent = currentUser.realName;
              document.getElementById('registeredUserAvatar').textContent = liffData.displayName.charAt(0).toUpperCase();
              
              document.querySelectorAll('.section').forEach(section => {
                  section.classList.remove('active');
              });
              document.getElementById('menuSection').classList.add('active');
          }

          // é¡¯ç¤ºä¿®æ”¹å€æ®µ
          function showModifySection() {
              document.getElementById('modifyLineName').textContent = liffData.displayName;
              document.getElementById('modifyRealName').value = currentUser.realName;
              document.getElementById('modifyUserAvatar').textContent = liffData.displayName.charAt(0).toUpperCase();
              
              document.querySelectorAll('.section').forEach(section => {
                  section.classList.remove('active');
              });
              document.getElementById('modifySection').classList.add('active');
          }

          // é¡¯ç¤ºç¹³è²»å€æ®µ
          function showPaymentSection() {
              document.getElementById('paymentLineName').textContent = liffData.displayName;
              document.getElementById('paymentRealName').textContent = currentUser.realName;
              document.getElementById('paymentUserAvatar').textContent = liffData.displayName.charAt(0).toUpperCase();
              
              document.querySelectorAll('.section').forEach(section => {
                  section.classList.remove('active');
              });
              document.getElementById('paymentSection').classList.add('active');
          }

          // é¡¯ç¤ºç¹³è²»å¯©æŸ¥å€æ®µ
          function showPaymentReviewSection() {
              document.getElementById('reviewLineName').textContent = liffData.displayName;
              document.getElementById('reviewUserAvatar').textContent = liffData.displayName.charAt(0).toUpperCase();
              
              document.querySelectorAll('.section').forEach(section => {
                  section.classList.remove('active');
              });
              document.getElementById('paymentReviewSection').classList.add('active');
              
              loadAllPayments();
          }

          // é¡¯ç¤ºè¨‚å–®æŸ¥è©¢å€æ®µ
          function showOrderQuerySection() {
              document.getElementById('queryLineName').textContent = liffData.displayName;
              document.getElementById('queryUserAvatar').textContent = liffData.displayName.charAt(0).toUpperCase();
              
              document.querySelectorAll('.section').forEach(section => {
                  section.classList.remove('active');
              });
              document.getElementById('orderQuerySection').classList.add('active');
          }

          // é¡¯ç¤ºç”¨æˆ¶ç®¡ç†å€æ®µ
          function showUserManagementSection() {
              document.getElementById('userMgmtLineName').textContent = liffData.displayName;
              document.getElementById('userMgmtUserAvatar').textContent = liffData.displayName.charAt(0).toUpperCase();
              
              document.querySelectorAll('.section').forEach(section => {
                  section.classList.remove('active');
              });
              document.getElementById('userManagementSection').classList.add('active');
              
              loadAllUsers();
          }

          // è¼‰å…¥æ‰€æœ‰ç¹³è²»è¨˜éŒ„
          async function loadAllPayments() {
              try {
                  document.getElementById('paymentReviewList').innerHTML = 
                      '<div class="loading show"><div class="spinner"></div><div>è¼‰å…¥ç¹³è²»è¨˜éŒ„ä¸­...</div></div>';

                  const response = await fetch(`${API_BASE_URL}?action=get-payments&data=${encodeURIComponent(JSON.stringify({
                      adminUserId: liffData.userId
                  }))}`);
                  
                  const result = await response.json();
                  console.log('ç¹³è²»è¨˜éŒ„:', result);

                  if (result.success) {
                      allPayments = result.payments;
                      displayPayments(result.payments);
                  } else {
                      throw new Error(result.message);
                  }

              } catch (error) {
                  console.error('è¼‰å…¥ç¹³è²»è¨˜éŒ„éŒ¯èª¤:', error);
                  document.getElementById('paymentReviewList').innerHTML = 
                      '<div class="error">è¼‰å…¥ç¹³è²»è¨˜éŒ„å¤±æ•—: ' + error.message + '</div>';
              }
          }

          // é¡¯ç¤ºç¹³è²»è¨˜éŒ„
          function displayPayments(payments) {
              let html = '';
              
              if (payments.length === 0) {
                  html = '<div class="info">æš«ç„¡ç¹³è²»è¨˜éŒ„</div>';
              } else {
                  payments.forEach((payment, index) => {
                      const statusClass = payment.status === 'å·²ç¢ºèª' ? 'status-confirmed' : 
                                        payment.status === 'æœªæ”¶åˆ°' ? 'status-rejected' : 'status-review';
                      const statusText = payment.status === 'å·²ç¢ºèª' ? 'âœ… å·²ç¢ºèª' : 
                                       payment.status === 'æœªæ”¶åˆ°' ? 'âŒ æœªæ”¶åˆ°' : 'â³ å¾…å¯©æ ¸';
                      
                      html += `
                          <div class="payment-item admin-item">
                              <div class="payment-header admin-header-item">
                                  <h3>ğŸ’³ ç¹³è²»è¨˜éŒ„ #${index + 1}</h3>
                                  <span class="status-badge ${statusClass}">${statusText}</span>
                              </div>
                              
                              <div class="payment-details">
                                  <div class="detail-row admin-detail-row">
                                      <span class="label admin-label-text">çœŸå¯¦å§“å:</span>
                                      <span class="value">${payment.realName}</span>
                                  </div>
                                  <div class="detail-row admin-detail-row">
                                      <span class="label admin-label-text">LINEåç¨±:</span>
                                      <span class="value">${payment.lineDisplayName}</span>
                                  </div>
                                  <div class="detail-row admin-detail-row">
                                      <span class="label admin-label-text">ç¹³è²»æ–¹å¼:</span>
                                      <span class="value">${payment.paymentMethod}</span>
                                  </div>
                                  <div class="detail-row admin-detail-row">
                                      <span class="label admin-label-text">å‚™è¨»:</span>
                                      <span class="value">${payment.paymentNote || 'ç„¡'}</span>
                                  </div>
                                  <div class="detail-row admin-detail-row">
                                      <span class="label admin-label-text">æäº¤æ™‚é–“:</span>
                                      <span class="value">${payment.submitTime}</span>
                                  </div>
                              </div>
                              
                              ${payment.status === 'å¾…å¯©æ ¸' ? `
                                  <div class="action-buttons">
                                      <button class="btn-confirm" onclick="updatePaymentStatus('${payment.userId}', '${payment.submitTime}', 'å·²ç¢ºèª')">
                                          âœ… ç¢ºèªæ”¶åˆ°
                                      </button>
                                      <button class="btn-reject" onclick="updatePaymentStatus('${payment.userId}', '${payment.submitTime}', 'æœªæ”¶åˆ°')">
                                          âŒ æœªæ”¶åˆ°
                                      </button>
                                  </div>
                              ` : ''}
                          </div>
                      `;
                  });
              }
              
              document.getElementById('paymentReviewList').innerHTML = html;
          }

          // æ›´æ–°ç¹³è²»ç‹€æ…‹
          async function updatePaymentStatus(userId, submitTime, status) {
              try {
                  const response = await fetch(`${API_BASE_URL}?action=update-payment-status&data=${encodeURIComponent(JSON.stringify({
                      adminUserId: liffData.userId,
                      targetUserId: userId,
                      submitTime: submitTime,
                      status: status
                  }))}`);
                  
                  const result = await response.json();
                  console.log('æ›´æ–°ç‹€æ…‹çµæœ:', result);

                  if (result.success) {
                      // é‡æ–°è¼‰å…¥ç¹³è²»è¨˜éŒ„
                      loadAllPayments();
                      
                      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                      const successDiv = document.createElement('div');
                      successDiv.className = 'success';
                      successDiv.textContent = 'âœ… ç‹€æ…‹æ›´æ–°æˆåŠŸï¼';
                      document.querySelector('#paymentReviewSection .admin-form').insertBefore(
                          successDiv, 
                          document.getElementById('paymentReviewList')
                      );
                      
                      setTimeout(() => successDiv.remove(), 3000);
                  } else {
                      throw new Error(result.message);
                  }

              } catch (error) {
                  console.error('æ›´æ–°ç¹³è²»ç‹€æ…‹éŒ¯èª¤:', error);
                  alert('æ›´æ–°ç‹€æ…‹å¤±æ•—: ' + error.message);
              }
          }

          // æœå°‹ç¹³è²»è¨˜éŒ„
          function searchPayments() {
              const keyword = document.getElementById('paymentSearchInput').value.trim().toLowerCase();
              if (!keyword) {
                  displayPayments(allPayments);
                  return;
              }
              
              const filtered = allPayments.filter(payment => 
                  payment.realName.toLowerCase().includes(keyword) ||
                  payment.lineDisplayName.toLowerCase().includes(keyword) ||
                  payment.paymentMethod.toLowerCase().includes(keyword) ||
                  (payment.paymentNote && payment.paymentNote.toLowerCase().includes(keyword))
              );
              
              displayPayments(filtered);
          }

          // ç¯©é¸ç¹³è²»è¨˜éŒ„
          function filterPayments(filter) {
              currentFilter = filter;
              
              // æ›´æ–°æ¨™ç±¤ç‹€æ…‹
              document.querySelectorAll('.admin-tab').forEach(tab => {
                  tab.classList.remove('active');
              });
              event.target.classList.add('active');
              
              let filtered = allPayments;
              if (filter === 'pending') {
                  filtered = allPayments.filter(p => p.status === 'å¾…å¯©æ ¸');
              } else if (filter === 'confirmed') {
                  filtered = allPayments.filter(p => p.status === 'å·²ç¢ºèª');
              } else if (filter === 'rejected') {
                  filtered = allPayments.filter(p => p.status === 'æœªæ”¶åˆ°');
              }
              
              displayPayments(filtered);
          }

          // æŸ¥è©¢ç”¨æˆ¶è¨‚å–®
          async function queryUserOrders() {
              const lineName = document.getElementById('queryLineNameInput').value.trim();
              if (!lineName) {
                  alert('è«‹è¼¸å…¥ LINE åç¨±');
                  return;
              }

              try {
                  document.getElementById('queryOrdersList').innerHTML = 
                      '<div class="loading show"><div class="spinner"></div><div>æŸ¥è©¢è¨‚å–®ä¸­...</div></div>';

                  const response = await fetch(`${API_BASE_URL}?action=admin-query-orders&data=${encodeURIComponent(JSON.stringify({
                      adminUserId: liffData.userId,
                      targetLineName: lineName
                  }))}`);
                  
                  const result = await response.json();
                  console.log('æŸ¥è©¢è¨‚å–®çµæœ:', result);

                  if (result.success) {
                      displayQueryOrders(result.orders, lineName);
                  } else {
                      throw new Error(result.message);
                  }

              } catch (error) {
                  console.error('æŸ¥è©¢è¨‚å–®éŒ¯èª¤:', error);
                  document.getElementById('queryOrdersList').innerHTML = 
                      '<div class="error">æŸ¥è©¢è¨‚å–®å¤±æ•—: ' + error.message + '</div>';
              }
          }

          // é¡¯ç¤ºæŸ¥è©¢çš„è¨‚å–®
          function displayQueryOrders(orders, lineName) {
              let html = `<div class="info">æŸ¥è©¢ç”¨æˆ¶: <strong>${lineName}</strong></div>`;
              let grandTotal = 0;
              
              if (orders.length === 0) {
                  html += '<div class="info">è©²ç”¨æˆ¶æš«ç„¡è¨‚å–®è¨˜éŒ„</div>';
              } else {
                  orders.forEach(order => {
                      const statusClass = order.paymentStatus === 'å·²ä»˜æ¬¾' ? 'status-paid' : 'status-pending';
                      const statusText = order.paymentStatus === 'å·²ä»˜æ¬¾' ? 'âœ… å·²ä»˜æ¬¾' : 'â³ å¾…ä»˜æ¬¾';
                      
                      html += `
                          <div class="order-item admin-item">
                              <div class="order-header admin-header-item">
                                  <h3>ğŸ“¦ è¨‚å–® #${order.orderId}</h3>
                                  <span class="status-badge ${statusClass}">${statusText}</span>
                              </div>
                              
                              <div class="product-info">
                                  <div class="product-name">
                                      ${order.productName}
                                  </div>
                                  
                                  <div class="order-details">
                                      <div class="detail-row admin-detail-row">
                                          <span class="label admin-label-text">çœŸå¯¦å§“å:</span>
                                          <span class="value">${order.realName}</span>
                                      </div>
                                      <div class="detail-row admin-detail-row">
                                          <span class="label admin-label-text">å–®åƒ¹:</span>
                                          <span class="value">NT$ ${order.unitPrice.toLocaleString()}</span>
                                      </div>
                                      <div class="detail-row admin-detail-row">
                                          <span class="label admin-label-text">æ•¸é‡:</span>
                                          <span class="value">${order.quantity}</span>
                                      </div>
                                      <div class="detail-row admin-detail-row total-row">
                                          <span class="label admin-label-text">å°è¨ˆ:</span>
                                          <span class="value total-amount">NT$ ${order.totalAmount.toLocaleString()}</span>
                                      </div>
                                  </div>
                                  
                                  <div class="order-date">
                                      è¨‚å–®æ—¥æœŸ: ${order.orderDate}
                                  </div>
                              </div>
                          </div>
                      `;
                      grandTotal += order.totalAmount;
                  });
                  
                  // ç¸½é‡‘é¡æ‘˜è¦
                  html += `
                      <div class="order-summary admin-summary">
                          <div class="summary-row">
                              <span class="summary-label">è¨‚å–®ç¸½æ•¸:</span>
                              <span class="summary-value">${orders.length} ç­†</span>
                          </div>
                          <div class="summary-row total-summary">
                              <span class="summary-label">ç¸½é‡‘é¡:</span>
                              <span class="summary-value">NT$ ${grandTotal.toLocaleString()}</span>
                          </div>
                      </div>
                  `;
              }
              
              document.getElementById('queryOrdersList').innerHTML = html;
          }

          // è¼‰å…¥æ‰€æœ‰ç”¨æˆ¶
          async function loadAllUsers() {
              try {
                  document.getElementById('userManagementList').innerHTML = 
                      '<div class="loading show"><div class="spinner"></div><div>è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨ä¸­...</div></div>';

                  const response = await fetch(`${API_BASE_URL}?action=get-users&data=${encodeURIComponent(JSON.stringify({
                      adminUserId: liffData.userId
                  }))}`);
                  
                  const result = await response.json();
                  console.log('ç”¨æˆ¶åˆ—è¡¨:', result);

                  if (result.success) {
                      allUsers = result.users;
                      displayUsers(result.users);
                  } else {
                      throw new Error(result.message);
                  }

              } catch (error) {
                  console.error('è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨éŒ¯èª¤:', error);
                  document.getElementById('userManagementList').innerHTML = 
                      '<div class="error">è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨å¤±æ•—: ' + error.message + '</div>';
              }
          }

          // é¡¯ç¤ºç”¨æˆ¶åˆ—è¡¨
          function displayUsers(users) {
              let html = '';
              
              if (users.length === 0) {
                  html = '<div class="info">æš«ç„¡ç”¨æˆ¶è¨˜éŒ„</div>';
              } else {
                  users.forEach((user, index) => {
                      const isAdmin = user.isAdmin ? true : false;
                      const adminBadge = isAdmin ? '<span style="color: #1E90FF; font-weight: bold;">ğŸ‘‘ ç®¡ç†å“¡</span>' : '';
                      
                      html += `
                          <div class="payment-item admin-item">
                              <div class="payment-header admin-header-item">
                                  <h3>ğŸ‘¤ ç”¨æˆ¶ #${index + 1}</h3>
                                  ${adminBadge}
                              </div>
                              
                              <div class="payment-details">
                                  <div class="detail-row admin-detail-row">
                                      <span class="label admin-label-text">çœŸå¯¦å§“å:</span>
                                      <span class="value">${user.realName}</span>
                                  </div>
                                  <div class="detail-row admin-detail-row">
                                      <span class="label admin-label-text">LINEåç¨±:</span>
                                      <span class="value">${user.lineDisplayName}</span>
                                  </div>
                                  <div class="detail-row admin-detail-row">
                                      <span class="label admin-label-text">ç”¨æˆ¶ID:</span>
                                      <span class="value">${user.userId}</span>
                                  </div>
                                  <div class="detail-row admin-detail-row">
                                      <span class="label admin-label-text">è¨»å†Šæ™‚é–“:</span>
                                      <span class="value">${user.registeredAt}</span>
                                  </div>
                              </div>
                              
                              <div class="action-buttons">
                                  ${!isAdmin ? `
                                      <button class="btn-confirm" onclick="toggleAdminStatus('${user.userId}', '${user.lineDisplayName}', '${user.realName}', true)">
                                          ğŸ‘‘ è¨­ç‚ºç®¡ç†å“¡
                                      </button>
                                  ` : `
                                      <button class="btn-reject" onclick="toggleAdminStatus('${user.userId}', '${user.lineDisplayName}', '${user.realName}', false)">
                                          ğŸ‘¤ å–æ¶ˆç®¡ç†å“¡
                                      </button>
                                  `}
                              </div>
                          </div>
                      `;
                  });
              }
              
              document.getElementById('userManagementList').innerHTML = html;
          }

          // åˆ‡æ›ç®¡ç†å“¡èº«åˆ†
          async function toggleAdminStatus(userId, lineDisplayName, realName, setAsAdmin) {
              try {
                  const response = await fetch(`${API_BASE_URL}?action=toggle-admin&data=${encodeURIComponent(JSON.stringify({
                      adminUserId: liffData.userId,
                      targetUserId: userId,
                      targetLineDisplayName: lineDisplayName,
                      targetRealName: realName,
                      setAsAdmin: setAsAdmin
                  }))}`);
                  
                  const result = await response.json();
                  console.log('åˆ‡æ›ç®¡ç†å“¡èº«åˆ†çµæœ:', result);

                  if (result.success) {
                      // é‡æ–°è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨
                      loadAllUsers();
                      
                      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                      const successDiv = document.createElement('div');
                      successDiv.className = 'success';
                      successDiv.textContent = setAsAdmin ? 'âœ… å·²è¨­ç‚ºç®¡ç†å“¡ï¼' : 'âœ… å·²å–æ¶ˆç®¡ç†å“¡èº«åˆ†ï¼';
                      document.querySelector('#userManagementSection .admin-form').insertBefore(
                          successDiv, 
                          document.getElementById('userManagementList')
                      );
                      
                      setTimeout(() => successDiv.remove(), 3000);
                  } else {
                      throw new Error(result.message);
                  }

              } catch (error) {
                  console.error('åˆ‡æ›ç®¡ç†å“¡èº«åˆ†éŒ¯èª¤:', error);
                  alert('æ“ä½œå¤±æ•—: ' + error.message);
              }
          }

          // æœå°‹ç”¨æˆ¶
          function searchUsers() {
              const keyword = document.getElementById('userSearchInput').value.trim().toLowerCase();
              if (!keyword) {
                  displayUsers(allUsers);
                  return;
              }
              
              const filtered = allUsers.filter(user => 
                  user.realName.toLowerCase().includes(keyword) ||
                  user.lineDisplayName.toLowerCase().includes(keyword)
              );
              
              displayUsers(filtered);
          }

          // è¼‰å…¥ç”¨æˆ¶è¨‚å–®
          async function loadUserOrders() {
              try {
                  document.getElementById('orderLineName').textContent = liffData.displayName;
                  document.getElementById('orderRealName').textContent = currentUser.realName;
                  document.getElementById('orderUserAvatar').textContent = liffData.displayName.charAt(0).toUpperCase();
                  
                  document.querySelectorAll('.section').forEach(section => {
                      section.classList.remove('active');
                  });
                  document.getElementById('ordersSection').classList.add('active');
                  
                  document.getElementById('ordersList').innerHTML = 
                      '<div class="loading show"><div class="spinner"></div><div>è¼‰å…¥è¨‚å–®ä¸­...</div></div>';

                  const response = await fetch(`${API_BASE_URL}?action=get-orders&data=${encodeURIComponent(JSON.stringify({
                      userId: liffData.userId,
                      lineDisplayName: liffData.displayName,
                      realName: currentUser.realName
                  }))}`);
                  
                  const result = await response.json();
                  console.log('è¨‚å–®çµæœ:', result);

                  if (result.success) {
                      userOrders = result.orders;
                      displayOrders(result.orders);
                  } else {
                      throw new Error(result.message);
                  }

              } catch (error) {
                  console.error('è¼‰å…¥è¨‚å–®éŒ¯èª¤:', error);
                  document.getElementById('ordersList').innerHTML = 
                      '<div class="error">è¼‰å…¥è¨‚å–®å¤±æ•—: ' + error.message + '</div>';
              }
          }

          // é¡¯ç¤ºè¨‚å–®
          function displayOrders(orders) {
              let html = '';
              let grandTotal = 0;
              
              if (orders.length === 0) {
                  html = '<div class="info">æ‚¨ç›®å‰æ²’æœ‰ä»»ä½•è¨‚å–®</div>';
              } else {
                  orders.forEach(order => {
                      const statusClass = order.paymentStatus === 'å·²ä»˜æ¬¾' ? 'status-paid' : 'status-pending';
                      const statusText = order.paymentStatus === 'å·²ä»˜æ¬¾' ? 'âœ… å·²ä»˜æ¬¾' : 'â³ å¾…ä»˜æ¬¾';
                      
                      html += `
                          <div class="order-item">
                              <div class="order-header">
                                  <h3>ğŸ“¦ è¨‚å–® #${order.orderId}</h3>
                                  <span class="status-badge ${statusClass}">${statusText}</span>
                              </div>
                              
                              <div class="product-info">
                                  <div class="product-name">
                                      ${order.productName}
                                  </div>
                                  
                                  <div class="order-details">
                                      <div class="detail-row">
                                          <span class="label">å–®åƒ¹:</span>
                                          <span class="value">NT$ ${order.unitPrice.toLocaleString()}</span>
                                      </div>
                                      <div class="detail-row">
                                          <span class="label">æ•¸é‡:</span>
                                          <span class="value">${order.quantity}</span>
                                      </div>
                                      <div class="detail-row total-row">
                                          <span class="label">å°è¨ˆ:</span>
                                          <span class="value total-amount">NT$ ${order.totalAmount.toLocaleString()}</span>
                                      </div>
                                  </div>
                                  
                                  <div class="order-date">
                                      è¨‚å–®æ—¥æœŸ: ${order.orderDate}
                                  </div>
                              </div>
                          </div>
                      `;
                      grandTotal += order.totalAmount;
                  });
                  
                  // ç¸½é‡‘é¡æ‘˜è¦
                  html += `
                      <div class="order-summary">
                          <div class="summary-row">
                              <span class="summary-label">è¨‚å–®ç¸½æ•¸:</span>
                              <span class="summary-value">${orders.length} ç­†</span>
                          </div>
                          <div class="summary-row total-summary">
                              <span class="summary-label">ç¸½é‡‘é¡:</span>
                              <span class="summary-value">NT$ ${grandTotal.toLocaleString()}</span>
                          </div>
                      </div>
                  `;
              }
              
              document.getElementById('ordersList').innerHTML = html;
          }

          // ç¢ºèªç¹³è²»
          async function confirmPayment() {
              const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
              const paymentNote = document.getElementById('paymentNote').value.trim();
              
              if (!selectedMethod) {
                  alert('è«‹é¸æ“‡ç¹³è²»æ–¹å¼');
                  return;
              }

              try {
                  const response = await fetch(`${API_BASE_URL}?action=submit-payment&data=${encodeURIComponent(JSON.stringify({
                      userId: liffData.userId,
                      lineDisplayName: liffData.displayName,
                      realName: currentUser.realName,
                      paymentMethod: selectedMethod.value,
                      paymentNote: paymentNote
                  }))}`);
                  
                  const result = await response.json();
                  console.log('ç¹³è²»æäº¤çµæœ:', result);

                  if (result.success) {
                      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                      const successDiv = document.createElement('div');
                      successDiv.className = 'success';
                      successDiv.innerHTML = `
                          <strong>âœ… ç¹³è²»è³‡è¨Šæäº¤æˆåŠŸï¼</strong><br>
                          ç¹³è²»æ–¹å¼: ${selectedMethod.value}<br>
                          ${paymentNote ? `å‚™è¨»: ${paymentNote}<br>` : ''}
                          è«‹ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸ç¢ºèª
                      `;
                      
                      document.querySelector('#paymentSection .payment-form').insertBefore(
                          successDiv, 
                          document.querySelector('#paymentSection .payment-form h3')
                      );
                      
                      // æ¸…ç©ºè¡¨å–®
                      document.querySelectorAll('input[name="paymentMethod"]').forEach(input => input.checked = false);
                      document.getElementById('paymentNote').value = '';
                      document.getElementById('transferNote').classList.remove('show');
                      
                      // 3ç§’å¾Œè¿”å›ä¸»é¸å–®
                      setTimeout(() => {
                          showMenuSection();
                      }, 3000);
                      
                  } else {
                      throw new Error(result.message);
                  }

              } catch (error) {
                  console.error('ç¹³è²»æäº¤éŒ¯èª¤:', error);
                  alert('ç¹³è²»æäº¤å¤±æ•—: ' + error.message);
              }
          }

          // è¨»å†Šç”¨æˆ¶
          document.getElementById('registerForm').addEventListener('submit', async (e) => {
              e.preventDefault();
              
              const realName = document.getElementById('registerRealName').value.trim();
              if (!realName) {
                  alert('è«‹è¼¸å…¥çœŸå¯¦å§“å');
                  return;
              }

              try {
                  document.getElementById('registerBtn').disabled = true;
                  document.getElementById('registerBtn').textContent = 'è¨»å†Šä¸­...';

                  const response = await fetch(`${API_BASE_URL}?action=register&data=${encodeURIComponent(JSON.stringify({
                      userId: liffData.userId,
                      lineDisplayName: liffData.displayName,
                      realName: realName,
                      isModify: false
                  }))}`);
                  
                  const result = await response.json();
                  console.log('è¨»å†Šçµæœ:', result);

                  if (result.success) {
                      currentUser = result.userInfo;
                      await checkAdminStatus();
                      showMenuSection();
                  } else {
                      throw new Error(result.message);
                  }

              } catch (error) {
                  console.error('è¨»å†ŠéŒ¯èª¤:', error);
                  alert('è¨»å†Šå¤±æ•—: ' + error.message);
              } finally {
                  document.getElementById('registerBtn').disabled = false;
                  document.getElementById('registerBtn').textContent = 'ğŸ“ ç¢ºèªé€å‡º';
              }
          });

          // ä¿®æ”¹ç”¨æˆ¶è³‡æ–™
          document.getElementById('modifyForm').addEventListener('submit', async (e) => {
              e.preventDefault();
              
              const realName = document.getElementById('modifyRealName').value.trim();
              if (!realName) {
                  alert('è«‹è¼¸å…¥çœŸå¯¦å§“å');
                  return;
              }

              try {
                  document.getElementById('modifyBtn').disabled = true;
                  document.getElementById('modifyBtn').textContent = 'ä¿®æ”¹ä¸­...';

                  const response = await fetch(`${API_BASE_URL}?action=register&data=${encodeURIComponent(JSON.stringify({
                      userId: liffData.userId,
                      lineDisplayName: liffData.displayName,
                      realName: realName,
                      isModify: true
                  }))}`);
                  
                  const result = await response.json();
                  console.log('ä¿®æ”¹çµæœ:', result);

                  if (result.success) {
                      currentUser = result.userInfo;
                      
                      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                      const successDiv = document.createElement('div');
                      successDiv.className = 'success';
                      successDiv.textContent = 'âœ… è³‡æ–™ä¿®æ”¹æˆåŠŸï¼';
                      document.getElementById('modifyForm').insertBefore(successDiv, document.getElementById('modifyBtn'));
                      
                      setTimeout(() => {
                          showMenuSection();
                      }, 2000);
                  } else {
                      throw new Error(result.message);
                  }

              } catch (error) {
                  console.error('ä¿®æ”¹éŒ¯èª¤:', error);
                  alert('ä¿®æ”¹å¤±æ•—: ' + error.message);
              } finally {
                  document.getElementById('modifyBtn').disabled = false;
                  document.getElementById('modifyBtn').textContent = 'âœ… ç¢ºèªä¿®æ”¹';
              }
          });

          // ç¹³è²»æ–¹å¼é¸æ“‡äº‹ä»¶
          document.querySelectorAll('.payment-method').forEach(method => {
              method.addEventListener('click', () => {
                  // ç§»é™¤æ‰€æœ‰é¸ä¸­ç‹€æ…‹
                  document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                  
                  // è¨­å®šç•¶å‰é¸ä¸­
                  method.classList.add('selected');
                  method.querySelector('input[type="radio"]').checked = true;
                  
                  // é¡¯ç¤ºè½‰å¸³æé†’
                  const transferNote = document.getElementById('transferNote');
                  if (method.dataset.method === 'è½‰å¸³') {
                      transferNote.classList.add('show');
                  } else {
                      transferNote.classList.remove('show');
                  }
              });
          });

          // æœå°‹è¼¸å…¥æ¡†äº‹ä»¶
          document.getElementById('paymentSearchInput').addEventListener('keypress', (e) => {
              if (e.key === 'Enter') {
                  searchPayments();
              }
          });

          document.getElementById('userSearchInput').addEventListener('keypress', (e) => {
              if (e.key === 'Enter') {
                  searchUsers();
              }
          });

          document.getElementById('queryLineNameInput').addEventListener('keypress', (e) => {
              if (e.key === 'Enter') {
                  queryUserOrders();
              }
          });

          // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
          document.addEventListener('DOMContentLoaded', () => {
              initializeLiff();
          });
      </script>
  </body>
  </html>

