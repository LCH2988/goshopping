<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LIFF ç¹³è²»ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #FF8C69 0%, #FF7F50 50%, #FF6347 100%);
          min-height: 100vh;
          padding: 10px;
      }

      .container {
          max-width: 400px;
          margin: 0 auto;
          background: rgba(255, 255, 255, 0.95);
          border-radius: 20px;
          box-shadow: 0 10px 30px rgba(255, 99, 71, 0.3);
          overflow: hidden;
          backdrop-filter: blur(10px);
      }

      .admin-container {
          max-width: 800px;
      }

      .header {
          background: linear-gradient(135deg, #FF8C69, #FF7F50);
          color: white;
          padding: 30px 20px;
          text-align: center;
          position: relative;
      }

      .admin-header {
          background: linear-gradient(135deg, #4169E1, #1E90FF);
      }

      .header::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
          opacity: 0.3;
      }

      .header h1 {
          font-size: 24px;
          font-weight: 700;
          margin-bottom: 8px;
          position: relative;
          z-index: 1;
      }

      .header .subtitle {
          font-size: 14px;
          opacity: 0.9;
          position: relative;
          z-index: 1;
      }

      .content {
          padding: 30px 20px;
      }

      .user-info {
          background: linear-gradient(135deg, #FFF8DC, #FFE4B5);
          border: 2px solid #FF8C69;
          border-radius: 15px;
          padding: 20px;
          margin-bottom: 25px;
          text-align: center;
      }

      .admin-info {
          background: linear-gradient(135deg, #E6F3FF, #CCE7FF);
          border: 2px solid #4169E1;
      }

      .user-info h2 {
          color: #D2691E;
          font-size: 18px;
          margin-bottom: 15px;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
      }

      .admin-info h2 {
          color: #1E90FF;
      }

      .user-info .line-name {
          color: #FF6347;
          font-weight: bold;
          font-size: 16px;
          margin-bottom: 10px;
      }

      .admin-info .line-name {
          color: #4169E1;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          color: #D2691E;
          font-weight: 600;
          font-size: 14px;
      }

      .admin-label {
          color: #1E90FF !important;
      }

      .form-group input, .form-group select {
          width: 100%;
          padding: 15px;
          border: 2px solid #FFE4B5;
          border-radius: 12px;
          font-size: 16px;
          background: #FFFAF0;
          transition: all 0.3s ease;
      }

      .admin-input {
          border-color: #CCE7FF !important;
          background: #F8FBFF !important;
      }

      .admin-input:focus {
          border-color: #4169E1 !important;
          box-shadow: 0 0 0 3px rgba(65, 105, 225, 0.1) !important;
      }

      .form-group input:focus, .form-group select:focus {
          outline: none;
          border-color: #FF8C69;
          box-shadow: 0 0 0 3px rgba(255, 140, 105, 0.1);
          background: white;
      }

      .form-group input.required {
          border-color: #FF6347;
          background: #FFF5F5;
      }

      .form-group input.required:focus {
          border-color: #FF4500;
          box-shadow: 0 0 0 3px rgba(255, 69, 0, 0.1);
      }

      .btn {
          width: 100%;
          padding: 15px;
          border: none;
          border-radius: 12px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          margin-bottom: 12px;
          position: relative;
          overflow: hidden;
      }

      .btn-admin {
          background: linear-gradient(135deg, #4169E1, #1E90FF);
          color: white;
          box-shadow: 0 4px 15px rgba(65, 105, 225, 0.4);
      }

      .btn-admin:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(65, 105, 225, 0.6);
      }

      .btn-primary {
          background: linear-gradient(135deg, #FF8C69, #FF7F50);
          color: white;
          box-shadow: 0 4px 15px rgba(255, 140, 105, 0.4);
      }

      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(255, 140, 105, 0.6);
      }

      .btn-secondary {
          background: linear-gradient(135deg, #DEB887, #D2B48C);
          color: #8B4513;
          box-shadow: 0 4px 15px rgba(210, 180, 140, 0.4);
      }

      .btn-secondary:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(210, 180, 140, 0.6);
      }

      .btn-success {
          background: linear-gradient(135deg, #32CD32, #228B22);
          color: white;
          box-shadow: 0 4px 15px rgba(50, 205, 50, 0.4);
      }

      .btn-success:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(50, 205, 50, 0.6);
      }

      .btn-warning {
          background: linear-gradient(135deg, #FFD700, #FFA500);
          color: #8B4513;
          box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
      }

      .btn-warning:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
      }

      .btn-danger {
          background: linear-gradient(135deg, #FF6B6B, #FF4757);
          color: white;
          box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
      }

      .btn-danger:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
      }

      .btn:disabled {
          background: #ccc;
          color: #999;
          cursor: not-allowed;
          transform: none;
          box-shadow: none;
      }

      .section {
          display: none;
          animation: fadeIn 0.5s ease-in;
      }

      .section.active {
          display: block;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .order-item, .payment-item {
          background: linear-gradient(135deg, #FFFAF0, #FFF8DC);
          border: 2px solid #FFE4B5;
          border-radius: 15px;
          padding: 20px;
          margin-bottom: 16px;
          box-shadow: 0 4px 12px rgba(255, 140, 105, 0.1);
          border-left: 5px solid #FF8C69;
      }

      .admin-item {
          background: linear-gradient(135deg, #F8FBFF, #E6F3FF);
          border: 2px solid #CCE7FF;
          border-left: 5px solid #4169E1;
      }

      .order-header, .payment-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 16px;
          padding-bottom: 12px;
          border-bottom: 2px solid #FFE4B5;
      }

      .admin-header-item {
          border-bottom: 2px solid #CCE7FF;
      }

      .order-header h3, .payment-header h3 {
          margin: 0;
          color: #D2691E;
          font-size: 18px;
      }

      .admin-item h3 {
          color: #1E90FF !important;
      }

      .product-info {
          margin-top: 12px;
      }

      .product-name {
          font-size: 16px;
          color: #8B4513;
          margin-bottom: 12px;
          padding: 12px;
          background: linear-gradient(135deg, #FFF8DC, #FFFAF0);
          border-radius: 8px;
          border: 1px solid #FFE4B5;
          font-weight: 600;
      }

      .order-details, .payment-details {
          margin: 12px 0;
      }

      .detail-row {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 10px 0;
          border-bottom: 1px solid #FFE4B5;
      }

      .admin-detail-row {
          border-bottom: 1px solid #CCE7FF;
      }

      .detail-row:last-child {
          border-bottom: none;
      }

      .total-row {
          background: linear-gradient(135deg, #FFE4B5, #F5DEB3);
          padding: 15px;
          border-radius: 8px;
          margin-top: 8px;
          font-weight: bold;
          border: 2px solid #FF8C69;
      }

      .label {
          color: #D2691E;
          font-size: 14px;
          font-weight: 500;
      }

      .admin-label-text {
          color: #1E90FF;
      }

      .value {
          color: #8B4513;
          font-weight: 600;
      }

      .total-amount {
          color: #FF6347;
          font-size: 16px;
          font-weight: bold;
      }

      .order-date {
          font-size: 12px;
          color: #CD853F;
          margin-top: 12px;
          text-align: right;
      }

      .status-badge {
          padding: 8px 15px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: bold;
      }

      .status-paid {
          background: linear-gradient(135deg, #98FB98, #90EE90);
          color: #006400;
          border: 1px solid #32CD32;
      }

      .status-pending {
          background: linear-gradient(135deg, #FFE4B5, #F5DEB3);
          color: #FF8C00;
          border: 1px solid #FF8C69;
      }

      .status-confirmed {
          background: linear-gradient(135deg, #98FB98, #90EE90);
          color: #006400;
          border: 1px solid #32CD32;
      }

      .status-rejected {
          background: linear-gradient(135deg, #FFB6C1, #FFA0B4);
          color: #8B0000;
          border: 1px solid #DC143C;
      }

      .status-review {
          background: linear-gradient(135deg, #FFE4B5, #F5DEB3);
          color: #FF8C00;
          border: 1px solid #FF8C69;
      }

      .order-summary {
          background: linear-gradient(135deg, #FF8C69, #FF7F50);
          color: white;
          padding: 25px;
          border-radius: 15px;
          margin-top: 20px;
          box-shadow: 0 6px 20px rgba(255, 140, 105, 0.3);
      }

      .admin-summary {
          background: linear-gradient(135deg, #4169E1, #1E90FF);
      }

      .summary-row {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 0;
      }

      .total-summary {
          border-top: 2px solid rgba(255,255,255,0.3);
          margin-top: 12px;
          padding-top: 15px;
          font-size: 18px;
          font-weight: bold;
      }

      .summary-label {
          font-size: 14px;
      }

      .summary-value {
          font-weight: bold;
      }

      .payment-methods {
          display: grid;
          gap: 12px;
          margin-bottom: 20px;
      }

      .payment-method {
          display: flex;
          align-items: center;
          padding: 15px;
          background: white;
          border: 2px solid #FFE4B5;
          border-radius: 10px;
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .payment-method:hover {
          border-color: #FF8C69;
          background: #FFFAF0;
      }

      .payment-method.selected {
          border-color: #FF6347;
          background: linear-gradient(135deg, #FFE4B5, #F5DEB3);
      }

      .payment-method input[type="radio"] {
          margin-right: 12px;
          accent-color: #FF8C69;
      }

      .payment-method label {
          font-weight: 500;
          color: #8B4513;
          cursor: pointer;
          flex: 1;
      }

      textarea {
          width: 100%;
          padding: 15px;
          border: 2px solid #FFE4B5;
          border-radius: 12px;
          font-size: 14px;
          background: #FFFAF0;
          resize: vertical;
          min-height: 100px;
          font-family: inherit;
      }

      textarea:focus {
          outline: none;
          border-color: #FF8C69;
          box-shadow: 0 0 0 3px rgba(255, 140, 105, 0.1);
          background: white;
      }

      .loading {
          display: none;
          text-align: center;
          padding: 20px;
          color: #FF8C69;
      }

      .loading.show {
          display: block;
      }

      .spinner {
          border: 3px solid #FFE4B5;
          border-top: 3px solid #FF8C69;
          border-radius: 50%;
          width: 30px;
          height: 30px;
          animation: spin 1s linear infinite;
          margin: 0 auto 10px;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .success {
          background: linear-gradient(135deg, #98FB98, #90EE90);
          color: #006400;
          padding: 15px;
          border-radius: 10px;
          margin: 15px 0;
          text-align: center;
          border: 2px solid #32CD32;
      }

      .error {
          background: linear-gradient(135deg, #FFB6C1, #FFA0B4);
          color: #8B0000;
          padding: 15px;
          border-radius: 10px;
          margin: 15px 0;
          text-align: center;
          border: 2px solid #DC143C;
      }

      .info {
          background: linear-gradient(135deg, #E0F6FF, #B0E0E6);
          color: #4682B4;
          padding: 15px;
          border-radius: 10px;
          margin: 15px 0;
          text-align: center;
          border: 2px solid #87CEEB;
      }

      .required-note {
          font-size: 12px;
          color: #FF6347;
          margin-top: 5px;
          font-style: italic;
      }

      .user-display {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 15px;
      }

      .user-avatar {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: linear-gradient(135deg, #FF8C69, #FF7F50);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: bold;
          font-size: 16px;
      }

      .admin-avatar {
          background: linear-gradient(135deg, #4169E1, #1E90FF);
      }

      .menu-buttons {
          display: grid;
          gap: 12px;
          margin-top: 20px;
      }

      .admin-menu-buttons {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 12px;
          margin-top: 20px;
      }

      .payment-form {
          background: linear-gradient(135deg, #FFFAF0, #FFF8DC);
          border: 2px solid #FFE4B5;
          border-radius: 15px;
          padding: 25px;
          margin-top: 20px;
      }

      .admin-form {
          background: linear-gradient(135deg, #F8FBFF, #E6F3FF);
          border: 2px solid #CCE7FF;
      }

      .payment-form h3 {
          color: #D2691E;
          margin-bottom: 20px;
          text-align: center;
          font-size: 18px;
      }

      .admin-form h3 {
          color: #1E90FF;
      }

      .transfer-note {
          background: #FFF8DC;
          border: 1px solid #FFE4B5;
          border-radius: 8px;
          padding: 10px;
          margin-top: 10px;
          font-size: 12px;
          color: #D2691E;
          display: none;
      }

      .transfer-note.show {
          display: block;
      }

      .search-bar {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
      }

      .search-bar input {
          flex: 1;
          padding: 12px;
          border: 2px solid #CCE7FF;
          border-radius: 8px;
          font-size: 14px;
      }

      .search-bar button {
          padding: 12px 20px;
          background: linear-gradient(135deg, #4169E1, #1E90FF);
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-weight: 600;
      }

      .action-buttons {
          display: flex;
          gap: 8px;
          margin-top: 15px;
      }

      .action-buttons button {
          flex: 1;
          padding: 8px 12px;
          border: none;
          border-radius: 6px;
          font-size: 12px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .btn-confirm {
          background: linear-gradient(135deg, #32CD32, #228B22);
          color: white;
      }

      .btn-reject {
          background: linear-gradient(135deg, #FF6B6B, #FF4757);
          color: white;
      }

      .admin-tabs {
          display: flex;
          margin-bottom: 20px;
          background: #f0f0f0;
          border-radius: 8px;
          padding: 4px;
      }

      .admin-tab {
          flex: 1;
          padding: 12px;
          text-align: center;
          background: transparent;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-weight: 600;
          color: #666;
          transition: all 0.3s ease;
      }

      .admin-tab.active {
          background: linear-gradient(135deg, #4169E1, #1E90FF);
          color: white;
      }

      /* å¿«å–ç‹€æ…‹æŒ‡ç¤ºå™¨ */
      .cache-indicator {
          position: fixed;
          top: 10px;
          right: 10px;
          padding: 5px 10px;
          background: rgba(0,0,0,0.7);
          color: white;
          border-radius: 15px;
          font-size: 12px;
          z-index: 1000;
          display: none;
      }

      .cache-indicator.show {
          display: block;
      }

      /* é›¢ç·šç‹€æ…‹æŒ‡ç¤ºå™¨ */
      .offline-indicator {
          position: fixed;
          bottom: 10px;
          left: 50%;
          transform: translateX(-50%);
          padding: 10px 20px;
          background: #FF6B6B;
          color: white;
          border-radius: 20px;
          font-size: 14px;
          z-index: 1000;
          display: none;
      }

      .offline-indicator.show {
          display: block;
      }

      @media (max-width: 480px) {
          .container {
              margin: 5px;
              border-radius: 15px;
          }
          
          .content {
              padding: 20px 15px;
          }
          
          .header {
              padding: 20px 15px;
          }

          .admin-menu-buttons {
              grid-template-columns: 1fr;
          }

          .search-bar {
              flex-direction: column;
          }

          .action-buttons {
              flex-direction: column;
          }
      }

      @media (min-width: 481px) {
          .admin-container {
              max-width: 800px;
          }
      }
  </style>
</head>
<body>
  <!-- å¿«å–ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
  <div id="cacheIndicator" class="cache-indicator">
      ğŸ“¦ å¿«å–
  </div>

  <!-- é›¢ç·šç‹€æ…‹æŒ‡ç¤ºå™¨ -->
  <div id="offlineIndicator" class="offline-indicator">
      ğŸ”Œ é›¢ç·šæ¨¡å¼
  </div>

  <div class="container" id="mainContainer">
      <div class="header" id="mainHeader">
          <h1 id="headerTitle">ğŸ’³ LIFF ç¹³è²»ç³»çµ±</h1>
          <div class="subtitle" id="headerSubtitle">å®‰å…¨ä¾¿åˆ©çš„ç·šä¸Šç¹³è²»å¹³å°</div>
      </div>

      <div class="content">
          <!-- è¼‰å…¥ä¸­ -->
          <div id="loading" class="loading show">
              <div class="spinner"></div>
              <div>ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
          </div>

          <!-- æœªè¨»å†Šç”¨æˆ¶ - è¨»å†Šå€æ®µ -->
          <div id="registerSection" class="section">
              <div class="user-info">
                  <h2>ğŸ‘‹ æ­¡è¿ä½¿ç”¨</h2>
                  <div id="unregisteredUserDisplay" class="user-display">
                      <div id="unregisteredUserAvatar" class="user-avatar"></div>
                      <div>
                          <div id="unregisteredLineName" class="line-name"></div>
                          <div style="font-size: 12px; color: #CD853F;">LINE ç”¨æˆ¶</div>
                      </div>
                  </div>
                  <div class="info">è«‹å…ˆå®Œæˆè¨»å†Šæ‰èƒ½ä½¿ç”¨ç¹³è²»åŠŸèƒ½</div>
              </div>

              <form id="registerForm">
                  <div class="form-group">
                      <label for="registerRealName">çœŸå¯¦å§“å <span style="color: #FF6347;">*</span></label>
                      <input type="text" id="registerRealName" name="realName" class="required" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å">
                      <div class="required-note">æ­¤è³‡è¨Šç”¨æ–¼è¨‚å–®æ ¸å°ï¼Œè«‹å‹™å¿…å¡«å¯«æ­£ç¢º</div>
                  </div>
                  
                  <button type="submit" class="btn btn-primary" id="registerBtn">
                      ğŸ“ ç¢ºèªé€å‡º
                  </button>
              </form>
          </div>

          <!-- å·²è¨»å†Šç”¨æˆ¶ - ä¸»é¸å–®å€æ®µ -->
          <div id="menuSection" class="section">
              <div class="user-info" id="userInfoCard">
                  <h2 id="welcomeTitle">ğŸ‰ æ­¡è¿å›ä¾†</h2>
                  <div id="registeredUserDisplay" class="user-display">
                      <div id="registeredUserAvatar" class="user-avatar"></div>
                      <div>
                          <div id="registeredLineName" class="line-name"></div>
                          <div id="registeredRealName" style="font-size: 14px; color: #8B4513; font-weight: 600;"></div>
                          <div id="adminBadge" style="display: none; font-size: 12px; color: #1E90FF; font-weight: bold;">ğŸ‘‘ ç®¡ç†å“¡</div>
                      </div>
                  </div>
              </div>

              <div class="menu-buttons" id="normalMenuButtons">
                  <button class="btn btn-secondary" onclick="showModifySection()">
                      âœï¸ ç¢ºèªä¿®æ”¹ (è®Šæ›´åå­—)
                  </button>
                  
                  <button class="btn btn-primary" onclick="loadUserOrders()">
                      ğŸ“‹ æŸ¥è©¢è¨‚è³¼æ¸…å–®
                  </button>
                  
                  <button class="btn btn-success" onclick="showPaymentSection()">
                      ğŸ’³ ç¹³è²»
                  </button>
              </div>

              <div class="admin-menu-buttons" id="adminMenuButtons" style="display: none;">
                  <button class="btn btn-admin" onclick="showPaymentReviewSection()">
                      ğŸ” ç¹³è²»å¯©æŸ¥
                  </button>
                  
                  <button class="btn btn-admin" onclick="showOrderQuerySection()">
                      ğŸ“‹ æŸ¥è©¢è¨‚å–®
                  </button>
                  
                  <button class="btn btn-secondary" onclick="showModifySection()">
                      âœï¸ ä¿®æ”¹è³‡æ–™
                  </button>
                  
                  <button class="btn btn-primary" onclick="loadUserOrders()">
                      ğŸ“‹ æˆ‘çš„è¨‚å–®
                  </button>
                  
                  <button class="btn btn-success" onclick="showPaymentSection()">
                      ğŸ’³ ç¹³è²»
                  </button>
                  
                  <button class="btn btn-warning" onclick="showUserManagementSection()">
                      ğŸ‘¥ ç”¨æˆ¶ç®¡ç†
                  </button>
              </div>
          </div>

          <!-- ä¿®æ”¹è³‡æ–™å€æ®µ -->
          <div id="modifySection" class="section">
              <div class="user-info">
                  <h2>âœï¸ ä¿®æ”¹å€‹äººè³‡æ–™</h2>
                  <div class="user-display">
                      <div id="modifyUserAvatar" class="user-avatar"></div>
                      <div>
                          <div id="modifyLineName" class="line-name"></div>
                          <div style="font-size: 12px; color: #CD853F;">LINE ç”¨æˆ¶</div>
                      </div>
                  </div>
              </div>

              <form id="modifyForm">
                  <div class="form-group">
                      <label for="modifyRealName">çœŸå¯¦å§“å</label>
                      <input type="text" id="modifyRealName" name="realName" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å">
                  </div>
                  
                  <button type="submit" class="btn btn-primary" id="modifyBtn">
                      âœ… ç¢ºèªä¿®æ”¹
                  </button>
                  
                  <button type="button" class="btn btn-secondary" onclick="showMenuSection()">
                      â¬…ï¸ è¿”å›ä¸»é¸å–®
                  </button>
              </form>
          </div>

          <!-- è¨‚å–®åˆ—è¡¨å€æ®µ -->
          <div id="ordersSection" class="section">
              <div class="user-info">
                  <h2>ğŸ“‹ æˆ‘çš„è¨‚å–®</h2>
                  <div class="user-display">
                      <div id="orderUserAvatar" class="user-avatar"></div>
                      <div>
                          <div id="orderLineName" class="line-name"></div>
                          <div id="orderRealName" style="font-size: 14px; color: #8B4513; font-weight: 600;"></div>
                      </div>
                  </div>
              </div>

              <div id="ordersList"></div>
              
              <button class="btn btn-secondary" onclick="showMenuSection()">
                  â¬…ï¸ è¿”å›ä¸»é¸å–®
              </button>
          </div>

          <!-- ç¹³è²»å€æ®µ -->
          <div id="paymentSection" class="section">
              <div class="user-info">
                  <h2>ğŸ’³ é¸æ“‡ç¹³è²»æ–¹å¼</h2>
                  <div class="user-display">
                      <div id="paymentUserAvatar" class="user-avatar"></div>
                      <div>
                          <div id="paymentLineName" class="line-name"></div>
                          <div id="paymentRealName" style="font-size: 14px; color: #8B4513; font-weight: 600;"></div>
                      </div>
                  </div>
              </div>

              <div class="payment-form">
                  <h3>è«‹é¸æ“‡æ‚¨çš„ç¹³è²»æ–¹å¼</h3>
                  
                  <div class="payment-methods">
                      <div class="payment-method" data-method="ç¾é‡‘">
                          <input type="radio" name="paymentMethod" value="ç¾é‡‘" id="cash">
                          <label for="cash">ğŸ’µ ç¾é‡‘ç¹³è²»</label>
                      </div>
                      
                      <div class="payment-method" data-method="è½‰å¸³">
                          <input type="radio" name="paymentMethod" value="è½‰å¸³" id="transfer">
                          <label for="transfer">ğŸ¦ éŠ€è¡Œè½‰å¸³</label>
                      </div>
                      
                      <div class="payment-method" data-method="ä¿¡ç”¨å¡">
                          <input type="radio" name="paymentMethod" value="ä¿¡ç”¨å¡" id="creditCard">
                          <label for="creditCard">ğŸ’³ ä¿¡ç”¨å¡</label>
                      </div>
                  </div>

                  <div id="transferNote" class="transfer-note">
                      ğŸ’¡ è½‰å¸³æé†’ï¼šè«‹åœ¨å‚™è¨»æ¬„å¡«å¯«æ‚¨çš„å¸³è™Ÿå¾Œ5ç¢¼ï¼Œä»¥ä¾¿æ ¸å°
                  </div>

                  <div class="form-group">
                      <label for="paymentNote">å‚™è¨» (é¸å¡«)</label>
                      <textarea id="paymentNote" placeholder="å¦‚é¸æ“‡è½‰å¸³ï¼Œè«‹æä¾›å¸³è™Ÿå¾Œ5ç¢¼ç­‰ç›¸é—œè³‡è¨Š..."></textarea>
                  </div>
                  
                  <button class="btn btn-primary" onclick="confirmPayment()">
                      âœ… ç¢ºèªç¹³è²»æ–¹å¼é€å‡º
                  </button>
                  
                  <button class="btn btn-secondary" onclick="showMenuSection()">
                      â¬…ï¸ è¿”å›ä¸»é¸å–®
                  </button>
              </div>
          </div>

          <!-- ç®¡ç†å“¡ - ç¹³è²»å¯©æŸ¥å€æ®µ -->
          <div id="paymentReviewSection" class="section">
              <div class="user-info admin-info">
                  <h2>ğŸ” ç¹³è²»å¯©æŸ¥ç®¡ç†</h2>
                  <div class="user-display">
                      <div id="reviewUserAvatar" class="user-avatar admin-avatar"></div>
                      <div>
                          <div id="reviewLineName" class="line-name">ç®¡ç†å“¡</div>
                          <div style="font-size: 12px; color: #1E90FF;">ğŸ‘‘ ç®¡ç†å“¡æ¬Šé™</div>
                      </div>
                  </div>
              </div>

              <div class="admin-form">
                  <div class="search-bar">
                      <input type="text" id="paymentSearchInput" placeholder="æœå°‹å§“åã€ç¹³è²»æ–¹å¼æˆ–å‚™è¨»...">
                      <button onclick="searchPayments()">ğŸ” æœå°‹</button>
                      <button onclick="loadAllPayments()">ğŸ“‹ å…¨éƒ¨</button>
                  </div>

                  <div class="admin-tabs">
                      <button class="admin-tab active" onclick="filterPayments('all')">å…¨éƒ¨</button>
                      <button class="admin-tab" onclick="filterPayments('pending')">å¾…å¯©æ ¸</button>
                      <button class="admin-tab" onclick="filterPayments('confirmed')">å·²ç¢ºèª</button>
                      <button class="admin-tab" onclick="filterPayments('rejected')">æœªæ”¶åˆ°</button>
                  </div>

                  <div id="paymentReviewList"></div>
              </div>
              
              <button class="btn btn-secondary" onclick="showMenuSection()">
                  â¬…ï¸ è¿”å›ä¸»é¸å–®
              </button>
          </div>

          <!-- ç®¡ç†å“¡ - æŸ¥è©¢è¨‚å–®å€æ®µ -->
          <div id="orderQuerySection" class="section">
              <div class="user-info admin-info">
                  <h2>ğŸ“‹ è¨‚å–®æŸ¥è©¢ç®¡ç†</h2>
                  <div class="user-display">
                      <div id="queryUserAvatar" class="user-avatar admin-avatar"></div>
                      <div>
                          <div id="queryLineName" class="line-name">ç®¡ç†å“¡</div>
                          <div style="font-size: 12px; color: #1E90FF;">ğŸ‘‘ ç®¡ç†å“¡æ¬Šé™</div>
                      </div>
                  </div>
              </div>

              <div class="admin-form">
                  <div class="form-group">
                      <label for="queryLineNameInput" class="admin-label">è¼¸å…¥ LINE åç¨±</label>
                      <input type="text" id="queryLineNameInput" class="admin-input" placeholder="è«‹è¼¸å…¥è¦æŸ¥è©¢çš„ LINE åç¨±">
                  </div>
                  
                  <button class="btn btn-admin" onclick="queryUserOrders()">
                      ğŸ” æŸ¥è©¢è¨‚å–®
                  </button>

                  <div id="queryOrdersList"></div>
              </div>
              
              <button class="btn btn-secondary" onclick="showMenuSection()">
                  â¬…ï¸ è¿”å›ä¸»é¸å–®
              </button>
          </div>

          <!-- ç®¡ç†å“¡ - ç”¨æˆ¶ç®¡ç†å€æ®µ -->
          <div id="userManagementSection" class="section">
              <div class="user-info admin-info">
                  <h2>ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</h2>
                  <div class="user-display">
                      <div id="userMgmtUserAvatar" class="user-avatar admin-avatar"></div>
                      <div>
                          <div id="userMgmtLineName" class="line-name">ç®¡ç†å“¡</div>
                          <div style="font-size: 12px; color: #1E90FF;">ğŸ‘‘ ç®¡ç†å“¡æ¬Šé™</div>
                      </div>
                  </div>
              </div>

              <div class="admin-form">
                  <div class="search-bar">
                      <input type="text" id="userSearchInput" placeholder="æœå°‹ç”¨æˆ¶åç¨±...">
                      <button onclick="searchUsers()">ğŸ” æœå°‹</button>
                      <button onclick="loadAllUsers()">ğŸ“‹ å…¨éƒ¨</button>
                  </div>

                  <div id="userManagementList"></div>
              </div>
              
              <button class="btn btn-secondary" onclick="showMenuSection()">
                  â¬…ï¸ è¿”å›ä¸»é¸å–®
              </button>
          </div>
      </div>
  </div>

  <script>
<!-- æ›´ç©©å®šçš„ LIFF SDK è¼‰å…¥ -->    

        // ç¢ºä¿ SDK å®Œå…¨è¼‰å…¥å¾Œå†åˆå§‹åŒ–
        window.addEventListener('load', function() {
            if (typeof liff !== 'undefined') {
                console.log('LIFF SDK è¼‰å…¥æˆåŠŸ');
                initializeLiff();
            } else {
                console.error('LIFF SDK è¼‰å…¥å¤±æ•—');
                // å˜—è©¦é‡æ–°è¼‰å…¥
                setTimeout(() => {
                    if (typeof liff !== 'undefined') {
                        initializeLiff();
                    } else {
                        showError('LIFF SDK è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                    }
                }, 2000);
            }
        });


      // ==================== é…ç½®èˆ‡å…¨åŸŸè®Šæ•¸ ====================
      const CONFIG = {
          API_BASE_URL: 'https://script.google.com/macros/s/AKfycbzVSQahECe4YMUfEmA_iYsUBr4tLwWts-CdGhOJee1nFFylLRezRCde6IRhp7F6TSNg/exec', // è«‹æ›¿æ›ç‚ºæ‚¨çš„ GAS éƒ¨ç½² URL
          LIFF_ID: '1657285806-2bmkYWkN', // è«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID
          CACHE_DURATION: 300000, // 5åˆ†é˜å¿«å–
          MAX_RETRIES: 3,
          RETRY_DELAY: 1000
      };

      let liff;
      let liffData = {};
      let currentUser = null;
      let userOrders = [];
      let allPayments = [];
      let allUsers = [];
      let currentFilter = 'all';
      let isOnline = navigator.onLine;

      // ==================== å·¥å…·é¡åˆ¥ ====================



      /**
       * æœ¬åœ°å¿«å–ç®¡ç†å™¨
       */
      class CacheManager {
          static set(key, data, expiry = CONFIG.CACHE_DURATION) {
              try {
                  const item = {
                      data: data,
                      timestamp: Date.now(),
                      expiry: expiry
                  };
                  localStorage.setItem(`liff_cache_${key}`, JSON.stringify(item));
                  this.showCacheIndicator();
              } catch (error) {
                  console.warn('å¿«å–è¨­å®šå¤±æ•—:', error);
              }
          }

          static get(key) {
              try {
                  const item = JSON.parse(localStorage.getItem(`liff_cache_${key}`));
                  if (!item) return null;

                  if (Date.now() - item.timestamp > item.expiry) {
                      localStorage.removeItem(`liff_cache_${key}`);
                      return null;
                  }

                  this.showCacheIndicator();
                  return item.data;
              } catch (error) {
                  console.warn('å¿«å–è®€å–å¤±æ•—:', error);
                  return null;
              }
          }

          static remove(key) {
              try {
                  localStorage.removeItem(`liff_cache_${key}`);
              } catch (error) {
                  console.warn('å¿«å–åˆªé™¤å¤±æ•—:', error);
              }
          }

          static clear() {
              try {
                  Object.keys(localStorage).forEach(key => {
                      if (key.startsWith('liff_cache_')) {
                          localStorage.removeItem(key);
                      }
                  });
              } catch (error) {
                  console.warn('å¿«å–æ¸…é™¤å¤±æ•—:', error);
              }
          }

          static showCacheIndicator() {
              const indicator = document.getElementById('cacheIndicator');
              indicator.classList.add('show');
              setTimeout(() => {
                  indicator.classList.remove('show');
              }, 1000);
          }
      }

      /**
       * API æœå‹™é¡åˆ¥
       */
      class APIService {
          static async call(action, data, useCache = true) {
              const cacheKey = `${action}_${JSON.stringify(data)}`;
              
              // æª¢æŸ¥å¿«å–
              if (useCache) {
                  const cachedData = CacheManager.get(cacheKey);
                  if (cachedData) {
                      console.log(`å¿«å–å‘½ä¸­: ${action}`);
                      return cachedData;
                  }
              }

              // æª¢æŸ¥ç¶²è·¯ç‹€æ…‹
              if (!isOnline) {
                  throw new Error('ç¶²è·¯é€£ç·šä¸­æ–·ï¼Œè«‹æª¢æŸ¥ç¶²è·¯è¨­å®š');
              }

              let lastError;
              
              // é‡è©¦æ©Ÿåˆ¶
              for (let i = 0; i < CONFIG.MAX_RETRIES; i++) {
                  try {
                      const response = await fetch(`${CONFIG.API_BASE_URL}?action=${action}&data=${encodeURIComponent(JSON.stringify(data))}`, {
                          method: 'GET',
                          headers: {
                              'Content-Type': 'application/json',
                          }
                      });

                      if (!response.ok) {
                          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                      }

                      const result = await response.json();
                      
                      // å¿«å–æˆåŠŸçš„å›æ‡‰
                      if (result.success && useCache) {
                          CacheManager.set(cacheKey, result);
                      }

                      console.log(`API å‘¼å«æˆåŠŸ: ${action}`, result);
                      return result;

                  } catch (error) {
                      lastError = error;
                      console.warn(`API å‘¼å«å¤±æ•— (å˜—è©¦ ${i + 1}/${CONFIG.MAX_RETRIES}):`, error);
                      
                      if (i < CONFIG.MAX_RETRIES - 1) {
                          await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * (i + 1)));
                      }
                  }
              }

              throw lastError;
          }
      }

      /**
       * éŒ¯èª¤è™•ç†å™¨
       */
      class ErrorHandler {
          static handle(error, context, showToUser = true) {
              const errorMessage = error.message || error.toString();
              console.error(`${context} éŒ¯èª¤:`, error);

              if (showToUser) {
                  this.showUserMessage(this.getUserFriendlyMessage(errorMessage), 'error');
              }

              return {
                  success: false,
                  message: this.getUserFriendlyMessage(errorMessage),
                  error: errorMessage,
                  context
              };
          }

          static getUserFriendlyMessage(error) {
              if (error.includes('ç¶²è·¯')) return 'ç¶²è·¯é€£ç·šç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯è¨­å®šå¾Œé‡è©¦';
              if (error.includes('LIFF')) return 'LINE æ‡‰ç”¨ç¨‹å¼é€£ç·šç•°å¸¸ï¼Œè«‹é‡æ–°é–‹å•Ÿ';
              if (error.includes('æ¬Šé™')) return 'æ‚¨æ²’æœ‰åŸ·è¡Œæ­¤æ“ä½œçš„æ¬Šé™';
              if (error.includes('å¿…å¡«')) return error;
              if (error.includes('ç„¡æ•ˆ')) return error;
              if (error.includes('æ‰¾ä¸åˆ°')) return error;
              
              return 'ç³»çµ±æš«æ™‚ç„¡æ³•è™•ç†æ‚¨çš„è«‹æ±‚ï¼Œè«‹ç¨å¾Œå†è©¦';
          }

          static showUserMessage(message, type = 'info') {
              const messageDiv = document.createElement('div');
              messageDiv.className = type;
              messageDiv.textContent = message;
              
              const content = document.querySelector('.content');
              const firstChild = content.firstChild;
              content.insertBefore(messageDiv, firstChild);
              
              setTimeout(() => {
                  if (messageDiv.parentNode) {
                      messageDiv.parentNode.removeChild(messageDiv);
                  }
              }, 5000);
          }
      }

      /**
       * è³‡æ–™é©—è­‰å™¨
       */
      class Validator {
          static validateRealName(name) {
              if (!name || name.trim().length < 2) {
                  throw new Error('çœŸå¯¦å§“ååªèƒ½åŒ…å«ä¸­æ–‡ã€è‹±æ–‡å’Œç©ºæ ¼');
              }
              return name.trim();
          }

          static validatePaymentMethod(method) {
              const validMethods = ['ç¾é‡‘', 'è½‰å¸³', 'ä¿¡ç”¨å¡'];
              if (!validMethods.includes(method)) {
                  throw new Error('è«‹é¸æ“‡æœ‰æ•ˆçš„ç¹³è²»æ–¹å¼');
              }
              return method;
          }

          static validateLineName(name) {
              if (!name || name.trim().length === 0) {
                  throw new Error('LINE åç¨±ä¸èƒ½ç‚ºç©º');
              }
              return name.trim();
          }
      }

      // ==================== LIFF åˆå§‹åŒ– ====================

      /**
       * åˆå§‹åŒ– LIFF
       */
      async function initializeLiff() {
          try {
              showLoading('æ­£åœ¨åˆå§‹åŒ– LIFF...');
              
              await liff.init({ liffId: CONFIG.LIFF_ID });
              
              if (!liff.isLoggedIn()) {
                  liff.login();
                  return;
              }

              // å–å¾—ç”¨æˆ¶è³‡æ–™
              const profile = await liff.getProfile();
              liffData = {
                  userId: profile.userId,
                  displayName: profile.displayName,
                  pictureUrl: profile.pictureUrl || null
              };

              console.log('LIFF åˆå§‹åŒ–æˆåŠŸ:', liffData);
              
              // æª¢æŸ¥ç”¨æˆ¶è¨»å†Šç‹€æ…‹
              await checkUserRegistration();

          } catch (error) {
              ErrorHandler.handle(error, 'LIFF åˆå§‹åŒ–');
              showError('LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°é–‹å•Ÿæ‡‰ç”¨ç¨‹å¼');
          }
      }

      /**
       * æª¢æŸ¥ç”¨æˆ¶è¨»å†Šç‹€æ…‹
       */
      async function checkUserRegistration() {
          try {
              showLoading('æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹...');

              const result = await APIService.call('check-registration', {
                  userId: liffData.userId,
                  lineDisplayName: liffData.displayName
              });

              if (result.success) {
                  if (result.registered) {
                      currentUser = result.userInfo;
                      await checkAdminStatus();
                      showMenuSection();
                  } else {
                      showRegisterSection();
                  }
              } else {
                  throw new Error(result.message);
              }

          } catch (error) {
              ErrorHandler.handle(error, 'æª¢æŸ¥ç”¨æˆ¶è¨»å†Šç‹€æ…‹');
          } finally {
              hideLoading();
          }
      }

      /**
       * æª¢æŸ¥ç®¡ç†å“¡ç‹€æ…‹
       */
      async function checkAdminStatus() {
          try {
              const result = await APIService.call('check-admin', {
                  userId: liffData.userId
              });

              if (result.success) {
                  currentUser.isAdmin = result.isAdmin;
                  updateUIForAdmin(result.isAdmin);
              }

          } catch (error) {
              console.warn('æª¢æŸ¥ç®¡ç†å“¡ç‹€æ…‹å¤±æ•—:', error);
              currentUser.isAdmin = false;
          }
      }

      // ==================== UI æ§åˆ¶å‡½æ•¸ ====================

      /**
       * é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
       */
      function showLoading(message = 'è¼‰å…¥ä¸­...') {
          const loading = document.getElementById('loading');
          loading.querySelector('div:last-child').textContent = message;
          loading.classList.add('show');
      }

      /**
       * éš±è—è¼‰å…¥ç‹€æ…‹
       */
      function hideLoading() {
          document.getElementById('loading').classList.remove('show');
      }

      /**
       * é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
       */
      function showError(message) {
          ErrorHandler.showUserMessage(message, 'error');
      }

      /**
       * é¡¯ç¤ºæˆåŠŸè¨Šæ¯
       */
      function showSuccess(message) {
          ErrorHandler.showUserMessage(message, 'success');
      }

      /**
       * é¡¯ç¤ºè³‡è¨Šè¨Šæ¯
       */
      function showInfo(message) {
          ErrorHandler.showUserMessage(message, 'info');
      }

      /**
       * åˆ‡æ›å€æ®µé¡¯ç¤º
       */
      function showSection(sectionId) {
          document.querySelectorAll('.section').forEach(section => {
              section.classList.remove('active');
          });
          document.getElementById(sectionId).classList.add('active');
      }

      /**
       * æ›´æ–°ç”¨æˆ¶é ­åƒ
       */
      function updateUserAvatar(avatarId, displayName) {
          const avatar = document.getElementById(avatarId);
          if (avatar) {
              avatar.textContent = displayName.charAt(0).toUpperCase();
          }
      }

      /**
       * æ›´æ–°ç®¡ç†å“¡ UI
       */
      function updateUIForAdmin(isAdmin) {
          const container = document.getElementById('mainContainer');
          const header = document.getElementById('mainHeader');
          const normalButtons = document.getElementById('normalMenuButtons');
          const adminButtons = document.getElementById('adminMenuButtons');
          const adminBadge = document.getElementById('adminBadge');

          if (isAdmin) {
              container.classList.add('admin-container');
              header.classList.add('admin-header');
              document.getElementById('headerTitle').textContent = 'ğŸ‘‘ ç®¡ç†å“¡æ§åˆ¶å°';
              document.getElementById('headerSubtitle').textContent = 'ç³»çµ±ç®¡ç†èˆ‡ç¹³è²»å¯©æŸ¥å¹³å°';
              
              normalButtons.style.display = 'none';
              adminButtons.style.display = 'grid';
              adminBadge.style.display = 'block';
          } else {
              container.classList.remove('admin-container');
              header.classList.remove('admin-header');
              document.getElementById('headerTitle').textContent = 'ğŸ’³ LIFF ç¹³è²»ç³»çµ±';
              document.getElementById('headerSubtitle').textContent = 'å®‰å…¨ä¾¿åˆ©çš„ç·šä¸Šç¹³è²»å¹³å°';
              
              normalButtons.style.display = 'grid';
              adminButtons.style.display = 'none';
              adminBadge.style.display = 'none';
          }
      }

      // ==================== å€æ®µé¡¯ç¤ºå‡½æ•¸ ====================

      /**
       * é¡¯ç¤ºè¨»å†Šå€æ®µ
       */
      function showRegisterSection() {
          showSection('registerSection');
          
          // æ›´æ–°ç”¨æˆ¶è³‡è¨Š
          document.getElementById('unregisteredLineName').textContent = liffData.displayName;
          updateUserAvatar('unregisteredUserAvatar', liffData.displayName);
      }

      /**
       * é¡¯ç¤ºä¸»é¸å–®å€æ®µ
       */
      function showMenuSection() {
          showSection('menuSection');
          
          if (currentUser) {
              // æ›´æ–°ç”¨æˆ¶è³‡è¨Š
              document.getElementById('registeredLineName').textContent = currentUser.lineDisplayName;
              document.getElementById('registeredRealName').textContent = currentUser.realName;
              updateUserAvatar('registeredUserAvatar', currentUser.lineDisplayName);
              
              // æ›´æ–°ç®¡ç†å“¡ç‹€æ…‹
              updateUIForAdmin(currentUser.isAdmin || false);
          }
      }

      /**
       * é¡¯ç¤ºä¿®æ”¹è³‡æ–™å€æ®µ
       */
      function showModifySection() {
          showSection('modifySection');
          
          if (currentUser) {
              document.getElementById('modifyLineName').textContent = currentUser.lineDisplayName;
              document.getElementById('modifyRealName').value = currentUser.realName;
              updateUserAvatar('modifyUserAvatar', currentUser.lineDisplayName);
          }
      }

      /**
       * é¡¯ç¤ºç¹³è²»å€æ®µ
       */
      function showPaymentSection() {
          showSection('paymentSection');
          
          if (currentUser) {
              document.getElementById('paymentLineName').textContent = currentUser.lineDisplayName;
              document.getElementById('paymentRealName').textContent = currentUser.realName;
              updateUserAvatar('paymentUserAvatar', currentUser.lineDisplayName);
          }

          // é‡ç½®è¡¨å–®
          document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
              radio.checked = false;
          });
          document.querySelectorAll('.payment-method').forEach(method => {
              method.classList.remove('selected');
          });
          document.getElementById('paymentNote').value = '';
          document.getElementById('transferNote').classList.remove('show');
      }

      /**
       * é¡¯ç¤ºç¹³è²»å¯©æŸ¥å€æ®µ
       */
      function showPaymentReviewSection() {
          showSection('paymentReviewSection');
          loadAllPayments();
      }

      /**
       * é¡¯ç¤ºè¨‚å–®æŸ¥è©¢å€æ®µ
       */
      function showOrderQuerySection() {
          showSection('orderQuerySection');
          document.getElementById('queryLineNameInput').value = '';
          document.getElementById('queryOrdersList').innerHTML = '';
      }

      /**
       * é¡¯ç¤ºç”¨æˆ¶ç®¡ç†å€æ®µ
       */
      function showUserManagementSection() {
          showSection('userManagementSection');
          loadAllUsers();
      }

      // ==================== ç”¨æˆ¶æ“ä½œå‡½æ•¸ ====================

      /**
       * ç”¨æˆ¶è¨»å†Š
       */
      async function registerUser(event) {
          event.preventDefault();
          
          try {
              const realName = Validator.validateRealName(document.getElementById('registerRealName').value);
              
              showLoading('è¨»å†Šä¸­...');

              const result = await APIService.call('register', {
                  userId: liffData.userId,
                  lineDisplayName: liffData.displayName,
                  realName: realName,
                  isModify: false
              }, false);

              if (result.success) {
                  currentUser = result.userInfo;
                  showSuccess(result.message);
                  
                  // æ¸…é™¤è¨»å†Šç›¸é—œå¿«å–
                  CacheManager.remove(`check-registration_${JSON.stringify({
                      userId: liffData.userId,
                      lineDisplayName: liffData.displayName
                  })}`);
                  
                  setTimeout(() => {
                      showMenuSection();
                  }, 1500);
              } else {
                  throw new Error(result.message);
              }

          } catch (error) {
              ErrorHandler.handle(error, 'ç”¨æˆ¶è¨»å†Š');
          } finally {
              hideLoading();
          }
      }

      /**
       * ä¿®æ”¹ç”¨æˆ¶è³‡æ–™
       */
      async function modifyUser(event) {
          event.preventDefault();
          
          try {
              const realName = Validator.validateRealName(document.getElementById('modifyRealName').value);
              
              showLoading('ä¿®æ”¹ä¸­...');

              const result = await APIService.call('register', {
                  userId: liffData.userId,
                  lineDisplayName: liffData.displayName,
                  realName: realName,
                  isModify: true
              }, false);

              if (result.success) {
                  currentUser.realName = realName;
                  showSuccess(result.message);
                  
                  // æ¸…é™¤ç›¸é—œå¿«å–
                  CacheManager.clear();
                  
                  setTimeout(() => {
                      showMenuSection();
                  }, 1500);
              } else {
                  throw new Error(result.message);
              }

          } catch (error) {
              ErrorHandler.handle(error, 'ä¿®æ”¹ç”¨æˆ¶è³‡æ–™');
          } finally {
              hideLoading();
          }
      }

      /**
       * è¼‰å…¥ç”¨æˆ¶è¨‚å–®
       */
      async function loadUserOrders() {
          try {
              showLoading('è¼‰å…¥è¨‚å–®ä¸­...');

              const result = await APIService.call('get-orders', {
                  userId: liffData.userId,
                  lineDisplayName: currentUser.lineDisplayName,
                  realName: currentUser.realName
              });

              if (result.success) {
                  userOrders = result.orders;
                  displayUserOrders();
                  showSection('ordersSection');
                  
                  // æ›´æ–°è¨‚å–®å€æ®µçš„ç”¨æˆ¶è³‡è¨Š
                  document.getElementById('orderLineName').textContent = currentUser.lineDisplayName;
                  document.getElementById('orderRealName').textContent = currentUser.realName;
                  updateUserAvatar('orderUserAvatar', currentUser.lineDisplayName);
              } else {
                  throw new Error(result.message);
              }

          } catch (error) {
              ErrorHandler.handle(error, 'è¼‰å…¥ç”¨æˆ¶è¨‚å–®');
          } finally {
              hideLoading();
          }
      }

      /**
       * é¡¯ç¤ºç”¨æˆ¶è¨‚å–®
       */
      function displayUserOrders() {
          const ordersList = document.getElementById('ordersList');
          
          if (userOrders.length === 0) {
              ordersList.innerHTML = `
                  <div class="info">
                      ğŸ“‹ ç›®å‰æ²’æœ‰è¨‚å–®è¨˜éŒ„
                  </div>
              `;
              return;
          }

          let totalAmount = 0;
          let orderHTML = '';

          userOrders.forEach(order => {
              totalAmount += order.totalAmount || 0;
              
              const statusClass = order.paymentStatus === 'å·²ä»˜æ¬¾' ? 'status-paid' : 'status-pending';
              const statusText = order.paymentStatus || 'å¾…ä»˜æ¬¾';

              orderHTML += `
                  <div class="order-item">
                      <div class="order-header">
                          <h3>è¨‚å–® #${order.orderId}</h3>
                          <span class="status-badge ${statusClass}">${statusText}</span>
                      </div>
                      
                      <div class="product-name">${order.productName}</div>
                      
                      <div class="order-details">
                          <div class="detail-row">
                              <span class="label">å–®åƒ¹</span>
                              <span class="value">NT$ ${order.unitPrice.toLocaleString()}</span>
                          </div>
                          <div class="detail-row">
                              <span class="label">æ•¸é‡</span>
                              <span class="value">${order.quantity}</span>
                          </div>
                          <div class="detail-row total-row">
                              <span class="label">å°è¨ˆ</span>
                              <span class="total-amount">NT$ ${order.totalAmount.toLocaleString()}</span>
                          </div>
                      </div>
                      
                      <div class="order-date">è¨‚å–®æ—¥æœŸ: ${order.orderDate}</div>
                  </div>
              `;
          });

          // åŠ å…¥ç¸½è¨ˆ
          orderHTML += `
              <div class="order-summary">
                  <div class="summary-row">
                      <span class="summary-label">ç¸½è¨‚å–®æ•¸</span>
                      <span class="summary-value">${userOrders.length} ç­†</span>
                  </div>
                  <div class="summary-row">
                      <span class="summary-label">å·²ä»˜æ¬¾</span>
                      <span class="summary-value">${userOrders.filter(o => o.paymentStatus === 'å·²ä»˜æ¬¾').length} ç­†</span>
                  </div>
                  <div class="summary-row">
                      <span class="summary-label">å¾…ä»˜æ¬¾</span>
                      <span class="summary-value">${userOrders.filter(o => o.paymentStatus !== 'å·²ä»˜æ¬¾').length} ç­†</span>
                  </div>
                  <div class="summary-row total-summary">
                      <span class="summary-label">ç¸½é‡‘é¡</span>
                      <span class="summary-value">NT$ ${totalAmount.toLocaleString()}</span>
                  </div>
              </div>
          `;

          ordersList.innerHTML = orderHTML;
      }

      /**
       * ç¢ºèªç¹³è²»
       */
      async function confirmPayment() {
          try {
              const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
              if (!selectedMethod) {
                  throw new Error('è«‹é¸æ“‡ç¹³è²»æ–¹å¼');
              }

              const paymentMethod = Validator.validatePaymentMethod(selectedMethod.value);
              const paymentNote = document.getElementById('paymentNote').value.trim();

              showLoading('æäº¤ç¹³è²»è³‡è¨Šä¸­...');

              const result = await APIService.call('submit-payment', {
                  userId: liffData.userId,
                  lineDisplayName: currentUser.lineDisplayName,
                  realName: currentUser.realName,
                  paymentMethod: paymentMethod,
                  paymentNote: paymentNote
              }, false);

              if (result.success) {
                  showSuccess(result.message);
                  
                  // æ¸…é™¤ç¹³è²»ç›¸é—œå¿«å–
                  CacheManager.remove('get-payments_' + JSON.stringify({adminUserId: liffData.userId}));
                  
                  setTimeout(() => {
                      showMenuSection();
                  }, 2000);
              } else {
                  throw new Error(result.message);
              }

          } catch (error) {
              ErrorHandler.handle(error, 'æäº¤ç¹³è²»è³‡è¨Š');
          } finally {
              hideLoading();
          }
      }

      // ==================== ç®¡ç†å“¡åŠŸèƒ½å‡½æ•¸ ====================

      /**
       * è¼‰å…¥æ‰€æœ‰ç¹³è²»è¨˜éŒ„
       */
      async function loadAllPayments() {
          try {
              showLoading('è¼‰å…¥ç¹³è²»è¨˜éŒ„ä¸­...');

              const result = await APIService.call('get-payments', {
                  adminUserId: liffData.userId
              });

              if (result.success) {
                  allPayments = result.payments;
                  displayPayments(allPayments);
              } else {
                  throw new Error(result.message);
              }

          } catch (error) {
              ErrorHandler.handle(error, 'è¼‰å…¥ç¹³è²»è¨˜éŒ„');
          } finally {
              hideLoading();
          }
      }

      /**
       * é¡¯ç¤ºç¹³è²»è¨˜éŒ„
       */
      function displayPayments(payments) {
          const paymentList = document.getElementById('paymentReviewList');
          
          if (payments.length === 0) {
              paymentList.innerHTML = `
                  <div class="info">
                      ğŸ“‹ ç›®å‰æ²’æœ‰ç¹³è²»è¨˜éŒ„
                  </div>
              `;
              return;
          }

          let paymentHTML = '';

          payments.forEach(payment => {
              let statusClass = 'status-review';
              let statusText = payment.status || 'å¾…å¯©æ ¸';
              
              switch (statusText) {
                  case 'å·²ç¢ºèª':
                      statusClass = 'status-confirmed';
                      break;
                  case 'æœªæ”¶åˆ°':
                      statusClass = 'status-rejected';
                      break;
                  default:
                      statusClass = 'status-review';
              }

              paymentHTML += `
                  <div class="payment-item admin-item">
                      <div class="payment-header admin-header-item">
                          <h3>${payment.realName}</h3>
                          <span class="status-badge ${statusClass}">${statusText}</span>
                      </div>
                      
                      <div class="payment-details">
                          <div class="detail-row admin-detail-row">
                              <span class="label admin-label-text">LINE åç¨±</span>
                              <span class="value">${payment.lineDisplayName}</span>
                          </div>
                          <div class="detail-row admin-detail-row">
                              <span class="label admin-label-text">ç¹³è²»æ–¹å¼</span>
                              <span class="value">${payment.paymentMethod}</span>
                          </div>
                          ${payment.paymentNote ? `
                          <div class="detail-row admin-detail-row">
                              <span class="label admin-label-text">å‚™è¨»</span>
                              <span class="value">${payment.paymentNote}</span>
                          </div>
                          ` : ''}
                          <div class="detail-row admin-detail-row">
                              <span class="label admin-label-text">æäº¤æ™‚é–“</span>
                              <span class="value">${payment.submitTime}</span>
                          </div>
                      </div>
                      
                      ${statusText === 'å¾…å¯©æ ¸' ? `
                      <div class="action-buttons">
                          <button class="btn-confirm" onclick="updatePaymentStatus('${payment.userId}', '${payment.submitTime}', 'å·²ç¢ºèª')">
                              âœ… ç¢ºèªæ”¶åˆ°
                          </button>
                          <button class="btn-reject" onclick="updatePaymentStatus('${payment.userId}', '${payment.submitTime}', 'æœªæ”¶åˆ°')">
                              âŒ æœªæ”¶åˆ°
                          </button>
                      </div>
                      ` : ''}
                  </div>
              `;
          });

          paymentList.innerHTML = paymentHTML;
      }

      /**
       * æ›´æ–°ç¹³è²»ç‹€æ…‹
       */
      async function updatePaymentStatus(targetUserId, submitTime, status) {
          try {
              showLoading('æ›´æ–°ç‹€æ…‹ä¸­...');

              const result = await APIService.call('update-payment-status', {
                  adminUserId: liffData.userId,
                  targetUserId: targetUserId,
                  submitTime: submitTime,
                  status: status
              }, false);

              if (result.success) {
                  showSuccess(result.message);
                  
                  // æ¸…é™¤å¿«å–ä¸¦é‡æ–°è¼‰å…¥
                  CacheManager.remove('get-payments_' + JSON.stringify({adminUserId: liffData.userId}));
                  await loadAllPayments();
              } else {
                  throw new Error(result.message);
              }

          } catch (error) {
              ErrorHandler.handle(error, 'æ›´æ–°ç¹³è²»ç‹€æ…‹');
          } finally {
              hideLoading();
          }
      }

      /**
       * ç¯©é¸ç¹³è²»è¨˜éŒ„
       */
      function filterPayments(status) {
          currentFilter = status;
          
          // æ›´æ–°æ¨™ç±¤ç‹€æ…‹
          document.querySelectorAll('.admin-tab').forEach(tab => {
              tab.classList.remove('active');
          });
          event.target.classList.add('active');

          let filteredPayments = allPayments;
          
          switch (status) {
              case 'pending':
                  filteredPayments = allPayments.filter(p => p.status === 'å¾…å¯©æ ¸');
                  break;
              case 'confirmed':
                  filteredPayments = allPayments.filter(p => p.status === 'å·²ç¢ºèª');
                  break;
              case 'rejected':
                  filteredPayments = allPayments.filter(p => p.status === 'æœªæ”¶åˆ°');
                  break;
              default:
                  filteredPayments = allPayments;
          }

          displayPayments(filteredPayments);
      }

      /**
       * æœå°‹ç¹³è²»è¨˜éŒ„
       */
      function searchPayments() {
          const searchTerm = document.getElementById('paymentSearchInput').value.trim().toLowerCase();
          
          if (!searchTerm) {
              displayPayments(allPayments);
              return;
          }

          const filteredPayments = allPayments.filter(payment => 
              payment.realName.toLowerCase().includes(searchTerm) ||
              payment.lineDisplayName.toLowerCase().includes(searchTerm) ||
              payment.paymentMethod.toLowerCase().includes(searchTerm) ||
              (payment.paymentNote && payment.paymentNote.toLowerCase().includes(searchTerm))
          );

          displayPayments(filteredPayments);
      }

      /**
       * æŸ¥è©¢ç”¨æˆ¶è¨‚å–®
       */
      async function queryUserOrders() {
          try {
              const targetLineName = Validator.validateLineName(document.getElementById('queryLineNameInput').value);
              
              showLoading('æŸ¥è©¢è¨‚å–®ä¸­...');

              const result = await APIService.call('admin-query-orders', {
                  adminUserId: liffData.userId,
                  targetLineName: targetLineName
              });

              if (result.success) {
                  displayQueryOrders(result.orders, targetLineName);
              } else {
                  throw new Error(result.message);
              }

          } catch (error) {
              ErrorHandler.handle(error, 'æŸ¥è©¢ç”¨æˆ¶è¨‚å–®');
          } finally {
              hideLoading();
          }
      }

      /**
       * é¡¯ç¤ºæŸ¥è©¢çš„è¨‚å–®
       */
      function displayQueryOrders(orders, targetLineName) {
          const ordersList = document.getElementById('queryOrdersList');
          
          if (orders.length === 0) {
              ordersList.innerHTML = `
                  <div class="info">
                      ğŸ“‹ ç”¨æˆ¶ã€Œ${targetLineName}ã€æ²’æœ‰è¨‚å–®è¨˜éŒ„
                  </div>
              `;
              return;
          }

          let totalAmount = 0;
          let orderHTML = `<h3 style="color: #1E90FF; margin: 20px 0;">ç”¨æˆ¶ã€Œ${targetLineName}ã€çš„è¨‚å–®</h3>`;

          orders.forEach(order => {
              totalAmount += order.totalAmount || 0;
              
              const statusClass = order.paymentStatus === 'å·²ä»˜æ¬¾' ? 'status-paid' : 'status-pending';
              const statusText = order.paymentStatus || 'å¾…ä»˜æ¬¾';

              orderHTML += `
                  <div class="order-item admin-item">
                      <div class="order-header admin-header-item">
                          <h3>è¨‚å–® #${order.orderId}</h3>
                          <span class="status-badge ${statusClass}">${statusText}</span>
                      </div>
                      
                      <div class="product-name">${order.productName}</div>
                      
                      <div class="order-details">
                          <div class="detail-row admin-detail-row">
                              <span class="label admin-label-text">çœŸå¯¦å§“å</span>
                              <span class="value">${order.realName}</span>
                          </div>
                          <div class="detail-row admin-detail-row">
                              <span class="label admin-label-text">å–®åƒ¹</span>
                              <span class="value">NT$ ${order.unitPrice.toLocaleString()}</span>
                          </div>
                          <div class="detail-row admin-detail-row">
                              <span class="label admin-label-text">æ•¸é‡</span>
                              <span class="value">${order.quantity}</span>
                          </div>
                          <div class="detail-row total-row">
                              <span class="label admin-label-text">å°è¨ˆ</span>
                              <span class="total-amount">NT$ ${order.totalAmount.toLocaleString()}</span>
                          </div>
                      </div>
                      
                      <div class="order-date">è¨‚å–®æ—¥æœŸ: ${order.orderDate}</div>
                  </div>
              `;
          });

          // åŠ å…¥ç¸½è¨ˆ
          orderHTML += `
              <div class="order-summary admin-summary">
                  <div class="summary-row">
                      <span class="summary-label">ç¸½è¨‚å–®æ•¸</span>
                      <span class="summary-value">${orders.length} ç­†</span>
                  </div>
                  <div class="summary-row">
                      <span class="summary-label">å·²ä»˜æ¬¾</span>
                      <span class="summary-value">${orders.filter(o => o.paymentStatus === 'å·²ä»˜æ¬¾').length} ç­†</span>
                  </div>
                  <div class="summary-row">
                      <span class="summary-label">å¾…ä»˜æ¬¾</span>
                      <span class="summary-value">${orders.filter(o => o.paymentStatus !== 'å·²ä»˜æ¬¾').length} ç­†</span>
                  </div>
                  <div class="summary-row total-summary">
                      <span class="summary-label">ç¸½é‡‘é¡</span>
                      <span class="summary-value">NT$ ${totalAmount.toLocaleString()}</span>
                  </div>
              </div>
          `;

          ordersList.innerHTML = orderHTML;
      }

      /**
       * è¼‰å…¥æ‰€æœ‰ç”¨æˆ¶
       */
      async function loadAllUsers() {
          try {
              showLoading('è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨ä¸­...');

              const result = await APIService.call('get-users', {
                  adminUserId: liffData.userId
              });

              if (result.success) {
                  allUsers = result.users;
                  displayUsers(allUsers);
              } else {
                  throw new Error(result.message);
              }

          } catch (error) {
              ErrorHandler.handle(error, 'è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨');
          } finally {
              hideLoading();
          }
      }

      /**
       * é¡¯ç¤ºç”¨æˆ¶åˆ—è¡¨
       */
      function displayUsers(users) {
          const userList = document.getElementById('userManagementList');
          
          if (users.length === 0) {
              userList.innerHTML = `
                  <div class="info">
                      ğŸ‘¥ ç›®å‰æ²’æœ‰ç”¨æˆ¶è¨˜éŒ„
                  </div>
              `;
              return;
          }

          let userHTML = '';

          users.forEach(user => {
              const isCurrentUser = user.userId === liffData.userId;
              const adminBadge = user.isAdmin ? '<span style="color: #1E90FF; font-weight: bold;">ğŸ‘‘ ç®¡ç†å“¡</span>' : '';

              userHTML += `
                  <div class="payment-item admin-item">
                      <div class="payment-header admin-header-item">
                          <h3>${user.realName} ${adminBadge}</h3>
                          ${isCurrentUser ? '<span class="status-badge status-confirmed">ç›®å‰ç”¨æˆ¶</span>' : ''}
                      </div>
                      
                      <div class="payment-details">
                          <div class="detail-row admin-detail-row">
                              <span class="label admin-label-text">LINE åç¨±</span>
                              <span class="value">${user.lineDisplayName}</span>
                          </div>
                          <div class="detail-row admin-detail-row">
                              <span class="label admin-label-text">è¨»å†Šæ™‚é–“</span>
                              <span class="value">${user.registeredAt}</span>
                          </div>
                      </div>
                      
                      ${!isCurrentUser ? `
                          <button class="${user.isAdmin ? 'btn-reject' : 'btn-confirm'}" onclick="toggleUserAdmin('${user.userId}', ${!user.isAdmin})">
                              ${user.isAdmin ? 'âŒ å–æ¶ˆç®¡ç†å“¡' : 'âœ… è¨­ç‚ºç®¡ç†å“¡'}
                          </button>
                      </div>
                      ` : ''}
                  </div>
              `;
          });

          userList.innerHTML = userHTML;
      }

      /**
       * åˆ‡æ›ç”¨æˆ¶ç®¡ç†å“¡æ¬Šé™
       */
      async function toggleUserAdmin(targetUserId, setAsAdmin) {
          try {
              const action = setAsAdmin ? 'è¨­ç‚ºç®¡ç†å“¡' : 'å–æ¶ˆç®¡ç†å“¡æ¬Šé™';
              
              if (!confirm(`ç¢ºå®šè¦${action}å—ï¼Ÿ`)) {
                  return;
              }

              showLoading(`${action}ä¸­...`);

              const result = await APIService.call('toggle-admin', {
                  adminUserId: liffData.userId,
                  targetUserId: targetUserId,
                  setAsAdmin: setAsAdmin
              }, false);

              if (result.success) {
                  showSuccess(result.message);
                  
                  // æ¸…é™¤å¿«å–ä¸¦é‡æ–°è¼‰å…¥
                  CacheManager.remove('get-users_' + JSON.stringify({adminUserId: liffData.userId}));
                  await loadAllUsers();
              } else {
                  throw new Error(result.message);
              }

          } catch (error) {
              ErrorHandler.handle(error, 'åˆ‡æ›ç®¡ç†å“¡æ¬Šé™');
          } finally {
              hideLoading();
          }
      }

      /**
       * æœå°‹ç”¨æˆ¶
       */
      function searchUsers() {
          const searchTerm = document.getElementById('userSearchInput').value.trim().toLowerCase();
          
          if (!searchTerm) {
              displayUsers(allUsers);
              return;
          }

          const filteredUsers = allUsers.filter(user => 
              user.realName.toLowerCase().includes(searchTerm) ||
              user.lineDisplayName.toLowerCase().includes(searchTerm)
          );

          displayUsers(filteredUsers);
      }

      // ==================== äº‹ä»¶ç›£è½å™¨ ====================

      /**
       * è¨­å®šäº‹ä»¶ç›£è½å™¨
       */
      function setupEventListeners() {
          // è¨»å†Šè¡¨å–®
          document.getElementById('registerForm').addEventListener('submit', registerUser);
          
          // ä¿®æ”¹è¡¨å–®
          document.getElementById('modifyForm').addEventListener('submit', modifyUser);
          
          // ç¹³è²»æ–¹å¼é¸æ“‡
          document.querySelectorAll('.payment-method').forEach(method => {
              method.addEventListener('click', function() {
                  // ç§»é™¤å…¶ä»–é¸é …çš„é¸ä¸­ç‹€æ…‹
                  document.querySelectorAll('.payment-method').forEach(m => {
                      m.classList.remove('selected');
                  });
                  
                  // è¨­å®šç•¶å‰é¸é …ç‚ºé¸ä¸­
                  this.classList.add('selected');
                  const radio = this.querySelector('input[type="radio"]');
                  radio.checked = true;
                  
                  // é¡¯ç¤º/éš±è—è½‰å¸³æé†’
                  const transferNote = document.getElementById('transferNote');
                  if (radio.value === 'è½‰å¸³') {
                      transferNote.classList.add('show');
                  } else {
                      transferNote.classList.remove('show');
                  }
              });
          });

          // æœå°‹æ¡† Enter éµç›£è½
          document.getElementById('paymentSearchInput').addEventListener('keypress', function(e) {
              if (e.key === 'Enter') {
                  searchPayments();
              }
          });

          document.getElementById('userSearchInput').addEventListener('keypress', function(e) {
              if (e.key === 'Enter') {
                  searchUsers();
              }
          });

          document.getElementById('queryLineNameInput').addEventListener('keypress', function(e) {
              if (e.key === 'Enter') {
                  queryUserOrders();
              }
          });

          // ç¶²è·¯ç‹€æ…‹ç›£è½
          window.addEventListener('online', function() {
              isOnline = true;
              document.getElementById('offlineIndicator').classList.remove('show');
              showInfo('ç¶²è·¯é€£ç·šå·²æ¢å¾©');
          });

          window.addEventListener('offline', function() {
              isOnline = false;
              document.getElementById('offlineIndicator').classList.add('show');
              showError('ç¶²è·¯é€£ç·šä¸­æ–·ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨');
          });

          // é é¢å¯è¦‹æ€§è®ŠåŒ–ç›£è½ï¼ˆç”¨æ–¼å¿«å–ç®¡ç†ï¼‰
          document.addEventListener('visibilitychange', function() {
              if (document.visibilityState === 'visible') {
                  // é é¢é‡æ–°å¯è¦‹æ™‚ï¼Œæª¢æŸ¥å¿«å–æ˜¯å¦éæœŸ
                  checkCacheExpiry();
              }
          });
      }

      /**
       * æª¢æŸ¥å¿«å–éæœŸ
       */
      function checkCacheExpiry() {
          const cacheKeys = Object.keys(localStorage).filter(key => key.startsWith('liff_cache_'));
          let expiredCount = 0;

          cacheKeys.forEach(key => {
              try {
                  const item = JSON.parse(localStorage.getItem(key));
                  if (item && Date.now() - item.timestamp > item.expiry) {
                      localStorage.removeItem(key);
                      expiredCount++;
                  }
              } catch (error) {
                  localStorage.removeItem(key);
                  expiredCount++;
              }
          });

          if (expiredCount > 0) {
              console.log(`æ¸…é™¤äº† ${expiredCount} å€‹éæœŸå¿«å–é …ç›®`);
          }
      }

      // ==================== åˆå§‹åŒ–å’Œå•Ÿå‹• ====================

      /**
       * é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
       */
      document.addEventListener('DOMContentLoaded', function() {
          console.log('LIFF ç¹³è²»ç³»çµ±å•Ÿå‹•ä¸­...');
          
          // æª¢æŸ¥ LIFF SDK æ˜¯å¦è¼‰å…¥
          if (typeof liff === 'undefined') {
              showError('LIFF SDK è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
              return;
          }

          // è¨­å®šäº‹ä»¶ç›£è½å™¨
          setupEventListeners();
          
          // åˆå§‹åŒ– LIFF
          liff = window.liff;
          initializeLiff();
      });

      // ==================== å·¥å…·å‡½æ•¸ ====================

      /**
       * æ ¼å¼åŒ–æ—¥æœŸ
       */
      function formatDate(dateString) {
          try {
              const date = new Date(dateString);
              return date.toLocaleString('zh-TW', {
                  year: 'numeric',
                  month: '2-digit',
                  day: '2-digit',
                  hour: '2-digit',
                  minute: '2-digit'
              });
          } catch (error) {
              return dateString;
          }
      }

      /**
       * æ ¼å¼åŒ–é‡‘é¡
       */
      function formatCurrency(amount) {
          return new Intl.NumberFormat('zh-TW', {
              style: 'currency',
              currency: 'TWD',
              minimumFractionDigits: 0
          }).format(amount);
      }

      /**
       * é˜²æŠ–å‡½æ•¸
       */
      function debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
              const later = () => {
                  clearTimeout(timeout);
                  func(...args);
              };
              clearTimeout(timeout);
              timeout = setTimeout(later, wait);
          };
      }

      /**
       * ç¯€æµå‡½æ•¸
       */
      function throttle(func, limit) {
          let inThrottle;
          return function() {
              const args = arguments;
              const context = this;
              if (!inThrottle) {
                  func.apply(context, args);
                  inThrottle = true;
                  setTimeout(() => inThrottle = false, limit);
              }
          }
      }

      // ==================== éŒ¯èª¤é‚Šç•Œè™•ç† ====================

      /**
       * å…¨åŸŸéŒ¯èª¤è™•ç†
       */
      window.addEventListener('error', function(event) {
          console.error('å…¨åŸŸéŒ¯èª¤:', event.error);
          ErrorHandler.handle(event.error, 'ç³»çµ±éŒ¯èª¤', false);
      });

      window.addEventListener('unhandledrejection', function(event) {
          console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', event.reason);
          ErrorHandler.handle(event.reason, 'Promise éŒ¯èª¤', false);
          event.preventDefault();
      });

      // ==================== æ•ˆèƒ½ç›£æ§ ====================

      /**
       * é é¢æ•ˆèƒ½ç›£æ§
       */
      window.addEventListener('load', function() {
          if ('performance' in window) {
              const perfData = performance.getEntriesByType('navigation')[0];
              console.log('é é¢è¼‰å…¥æ•ˆèƒ½:', {
                  loadTime: perfData.loadEventEnd - perfData.loadEventStart,
                  domReady: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
                  totalTime: perfData.loadEventEnd - perfData.fetchStart
              });
          }
      });

      // ==================== é–‹ç™¼è€…å·¥å…· ====================

      /**
       * é–‹ç™¼è€…é™¤éŒ¯å·¥å…·ï¼ˆåƒ…åœ¨é–‹ç™¼ç’°å¢ƒä½¿ç”¨ï¼‰
       */
      if (window.location.hostname === 'localhost' || window.location.hostname.includes('ngrok')) {
          window.liffDebug = {
              clearCache: () => {
                  CacheManager.clear();
                  console.log('å¿«å–å·²æ¸…é™¤');
              },
              showCache: () => {
                  const cache = {};
                  Object.keys(localStorage).forEach(key => {
                      if (key.startsWith('liff_cache_')) {
                          try {
                              cache[key] = JSON.parse(localStorage.getItem(key));
                          } catch (e) {
                              cache[key] = localStorage.getItem(key);
                          }
                      }
                  });
                  console.table(cache);
              },
              getCurrentUser: () => {
                  console.log('ç•¶å‰ç”¨æˆ¶:', currentUser);
              },
              getLiffData: () => {
                  console.log('LIFF è³‡æ–™:', liffData);
              },
              testAPI: async (action, data) => {
                  try {
                      const result = await APIService.call(action, data, false);
                      console.log('API æ¸¬è©¦çµæœ:', result);
                      return result;
                  } catch (error) {
                      console.error('API æ¸¬è©¦éŒ¯èª¤:', error);
                      return error;
                  }
              }
          };
          
          console.log('é–‹ç™¼è€…å·¥å…·å·²è¼‰å…¥ï¼Œä½¿ç”¨ window.liffDebug å­˜å–');
      }

      // ==================== ç‰ˆæœ¬è³‡è¨Š ====================
      
      console.log(`
      ğŸ‰ LIFF ç¹³è²»ç³»çµ± v2.0
      ğŸ“… æ›´æ–°æ—¥æœŸ: ${new Date().toLocaleDateString('zh-TW')}
      ğŸ”§ åŠŸèƒ½: ç”¨æˆ¶è¨»å†Šã€è¨‚å–®æŸ¥è©¢ã€ç¹³è²»æäº¤ã€ç®¡ç†å“¡å¯©æ ¸
      ğŸ’¡ å„ªåŒ–: å¿«å–æ©Ÿåˆ¶ã€éŒ¯èª¤è™•ç†ã€é›¢ç·šæ”¯æ´ã€æ•ˆèƒ½ç›£æ§
      `);
  </script>
</body>
</html>
          
