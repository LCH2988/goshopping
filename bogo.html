<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LIFF ç¹³è²»ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          color: #333;
      }

      .container {
          max-width: 500px;
          margin: 0 auto;
          padding: 20px;
          min-height: 100vh;
      }

      .card {
          background: white;
          border-radius: 15px;
          padding: 25px;
          margin-bottom: 20px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.2);
          animation: slideIn 0.5s ease-out;
      }

      @keyframes slideIn {
          from {
              opacity: 0;
              transform: translateY(20px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }

      .header {
          text-align: center;
          margin-bottom: 30px;
      }

      .header h1 {
          color: #667eea;
          font-size: 28px;
          margin-bottom: 10px;
      }

      .header p {
          color: #666;
          font-size: 16px;
      }

      .user-info {
          display: flex;
          align-items: center;
          padding: 20px;
          background: linear-gradient(135deg, #667eea, #764ba2);
          border-radius: 12px;
          margin-bottom: 25px;
          color: white;
      }

      .user-avatar {
          width: 60px;
          height: 60px;
          border-radius: 50%;
          background: rgba(255,255,255,0.3);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 24px;
          font-weight: bold;
          margin-right: 15px;
          border: 3px solid rgba(255,255,255,0.5);
      }

      .user-details h3 {
          font-size: 18px;
          margin-bottom: 5px;
      }

      .user-details p {
          font-size: 14px;
          opacity: 0.9;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #555;
      }

      .form-group input, .form-group textarea, .form-group select {
          width: 100%;
          padding: 12px 15px;
          border: 2px solid #e1e5e9;
          border-radius: 8px;
          font-size: 16px;
          transition: all 0.3s ease;
      }

      .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn {
          width: 100%;
          padding: 15px;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          margin-bottom: 10px;
      }

      .btn-primary {
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
      }

      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-primary:disabled {
          opacity: 0.6;
          cursor: not-allowed;
          transform: none;
      }

      .btn-success {
          background: linear-gradient(135deg, #56ab2f, #a8e6cf);
          color: white;
      }

      .btn-success:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4);
      }

      .order-item {
          border: 2px solid #f0f0f0;
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 15px;
          transition: all 0.3s ease;
      }

      .order-item:hover {
          border-color: #667eea;
          box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
      }

      .order-header {
          display: flex;
          justify-content: between;
          align-items: center;
          margin-bottom: 15px;
      }

      .order-header h4 {
          color: #667eea;
          font-size: 18px;
      }

      .status-badge {
          padding: 5px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
          text-transform: uppercase;
      }

      .status-unpaid {
          background: #ffebee;
          color: #c62828;
      }

      .status-paid {
          background: #e8f5e8;
          color: #2e7d32;
      }

      .order-details {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 10px;
          margin-bottom: 15px;
      }

      .detail-item {
          display: flex;
          justify-content: space-between;
          padding: 8px 0;
          border-bottom: 1px solid #f0f0f0;
      }

      .detail-label {
          color: #666;
          font-size: 14px;
      }

      .detail-value {
          font-weight: 600;
          color: #333;
      }

      .total-amount {
          font-size: 18px;
          font-weight: bold;
          color: #667eea;
          text-align: center;
          padding: 15px;
          background: #f8f9ff;
          border-radius: 8px;
          margin-top: 15px;
      }

      .payment-methods {
          margin-bottom: 20px;
      }

      .payment-method {
          display: flex;
          align-items: center;
          padding: 15px;
          border: 2px solid #e1e5e9;
          border-radius: 8px;
          margin-bottom: 10px;
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .payment-method:hover {
          border-color: #667eea;
          background: #f8f9ff;
      }

      .payment-method.selected {
          border-color: #667eea;
          background: #f8f9ff;
      }

      .payment-method input[type="radio"] {
          margin-right: 12px;
          transform: scale(1.2);
      }

      .payment-method label {
          font-weight: 600;
          cursor: pointer;
          flex: 1;
      }

      .loading {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.7);
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          z-index: 9999;
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s ease;
      }

      .loading.show {
          opacity: 1;
          visibility: visible;
      }

      .loading-spinner {
          width: 50px;
          height: 50px;
          border: 4px solid rgba(255,255,255,0.3);
          border-top: 4px solid white;
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin-bottom: 20px;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .loading-text {
          color: white;
          font-size: 16px;
          font-weight: 600;
      }

      .message {
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 20px;
          font-weight: 600;
          animation: slideIn 0.5s ease-out;
      }

      .message.success {
          background: #e8f5e8;
          color: #2e7d32;
          border: 1px solid #4caf50;
      }

      .message.error {
          background: #ffebee;
          color: #c62828;
          border: 1px solid #f44336;
      }

      .message.info {
          background: #e3f2fd;
          color: #1565c0;
          border: 1px solid #2196f3;
      }

      .section {
          display: none;
      }

      .section.active {
          display: block;
      }

      .summary-card {
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
          padding: 20px;
          border-radius: 12px;
          margin-bottom: 20px;
      }

      .summary-row {
          display: flex;
          justify-content: space-between;
          margin-bottom: 10px;
      }

      .summary-row:last-child {
          margin-bottom: 0;
          padding-top: 10px;
          border-top: 1px solid rgba(255,255,255,0.3);
          font-weight: bold;
          font-size: 18px;
      }

      .transfer-note {
          background: #fff3cd;
          border: 1px solid #ffeaa7;
          color: #856404;
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 20px;
          display: none;
      }

      .transfer-note.show {
          display: block;
      }

      @media (max-width: 480px) {
          .container {
              padding: 10px;
          }
          
          .card {
              padding: 20px;
          }
          
          .order-details {
              grid-template-columns: 1fr;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <!-- è¼‰å…¥ç•«é¢ -->
      <div id="loading" class="loading">
          <div class="loading-spinner"></div>
          <div class="loading-text">è¼‰å…¥ä¸­...</div>
      </div>

      <!-- æ­¥é©Ÿ1: ç”¨æˆ¶è³‡è¨Šè¼¸å…¥ -->
      <div id="userInfoSection" class="section active">
          <div class="card">
              <div class="header">
                  <h1>ğŸ’³ LIFF ç¹³è²»ç³»çµ±</h1>
                  <p>è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“åä»¥æŸ¥çœ‹è¨‚å–®</p>
              </div>

              <div id="userInfoDisplay" class="user-info" style="display: none;">
                  <div id="userAvatar" class="user-avatar"></div>
                  <div class="user-details">
                      <h3 id="lineDisplayName"></h3>
                      <p>LINE ç”¨æˆ¶</p>
                  </div>
              </div>

              <form id="userInfoForm">
                  <div class="form-group">
                      <label for="realName">çœŸå¯¦å§“å *</label>
                      <input type="text" id="realName" name="realName" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å" required>
                  </div>
                  
                  <button type="submit" class="btn btn-primary" id="submitBtn">
                      ğŸ“‹ æŸ¥çœ‹æˆ‘çš„è¨‚å–®
                  </button>
              </form>
          </div>
      </div>

      <!-- æ­¥é©Ÿ2: è¨‚å–®ç¢ºèª -->
      <div id="orderSection" class="section">
          <div class="card">
              <div class="header">
                  <h1>ğŸ“‹ è¨‚è³¼æ¸…å–®ç¢ºèª</h1>
                  <p>è«‹ç¢ºèªæ‚¨çš„è¨‚è³¼å…§å®¹</p>
              </div>

              <div id="userInfoConfirm" class="user-info">
                  <div id="userAvatarConfirm" class="user-avatar"></div>
                  <div class="user-details">
                      <h3 id="userNameConfirm"></h3>
                      <p id="lineNameConfirm"></p>
                  </div>
              </div>

              <div id="ordersList"></div>

              <div id="orderSummary" class="summary-card">
                  <div class="summary-row">
                      <span>ç¸½è¨‚å–®æ•¸ï¼š</span>
                      <span id="totalOrders">0 ç­†</span>
                  </div>
                  <div class="summary-row">
                      <span>æœªä»˜æ¬¾ï¼š</span>
                      <span id="unpaidOrders">0 ç­†</span>
                  </div>
                  <div class="summary-row">
                      <span>ç¸½é‡‘é¡ï¼š</span>
                      <span id="totalAmount">NT$ 0</span>
                  </div>
              </div>

              <button class="btn btn-success" onclick="showPaymentSection()" id="proceedPaymentBtn">
                  ğŸ’³ é€²è¡Œç¹³è²»å›å ±
              </button>
              
              <button class="btn btn-primary" onclick="showUserInfoSection()" style="background: #6c757d;">
                  â¬…ï¸ è¿”å›ä¸Šä¸€æ­¥
              </button>
          </div>
      </div>

      <!-- æ­¥é©Ÿ3: ç¹³è²»å›å ± -->
      <div id="paymentSection" class="section">
          <div class="card">
              <div class="header">
                  <h1>ğŸ’³ ç¹³è²»å›å ±</h1>
                  <p>è«‹é¸æ“‡æ‚¨çš„ç¹³è²»æ–¹å¼ä¸¦æäº¤</p>
              </div>

              <div id="userInfoPayment" class="user-info">
                  <div id="userAvatarPayment" class="user-avatar"></div>
                  <div class="user-details">
                      <h3 id="userNamePayment"></h3>
                      <p id="lineNamePayment"></p>
                  </div>
              </div>

              <form id="paymentForm">
                  <div class="form-group">
                      <label>ç¹³è²»æ–¹å¼ *</label>
                      <div class="payment-methods">
                          <div class="payment-method" data-method="ç¾é‡‘">
                              <input type="radio" name="paymentMethod" value="ç¾é‡‘" id="cash">
                              <label for="cash">ğŸ’µ ç¾é‡‘ç¹³è²»</label>
                          </div>
                          
                          <div class="payment-method" data-method="è½‰å¸³">
                              <input type="radio" name="paymentMethod" value="è½‰å¸³" id="transfer">
                              <label for="transfer">ğŸ¦ éŠ€è¡Œè½‰å¸³</label>
                          </div>
                          
                          <div class="payment-method" data-method="ä¿¡ç”¨å¡">
                              <input type="radio" name="paymentMethod" value="ä¿¡ç”¨å¡" id="creditCard">
                              <label for="creditCard">ğŸ’³ ä¿¡ç”¨å¡</label>
                          </div>
                      </div>
                  </div>

                  <div id="transferNote" class="transfer-note">
                      ğŸ’¡ è½‰å¸³æé†’ï¼šè«‹åœ¨å‚™è¨»æ¬„å¡«å¯«æ‚¨çš„å¸³è™Ÿå¾Œ5ç¢¼ï¼Œä»¥ä¾¿æ ¸å°
                  </div>

                  <div class="form-group">
                      <label for="paymentNote">å‚™è¨» (é¸å¡«)</label>
                      <textarea id="paymentNote" rows="3" placeholder="å¦‚é¸æ“‡è½‰å¸³ï¼Œè«‹æä¾›å¸³è™Ÿå¾Œ5ç¢¼ç­‰ç›¸é—œè³‡è¨Š..."></textarea>
                  </div>
                  
                  <button type="submit" class="btn btn-success" id="paymentSubmitBtn">
                      âœ… æäº¤ç¹³è²»å›å ±
                  </button>
                  
                  <button type="button" class="btn btn-primary" onclick="showOrderSection()" style="background: #6c757d;">
                      â¬…ï¸ è¿”å›è¨‚å–®ç¢ºèª
                  </button>
              </form>
          </div>
      </div>
  </div>

  <script>
      // ==================== é…ç½®èˆ‡å…¨åŸŸè®Šæ•¸ ====================
      const CONFIG = {
          API_BASE_URL: 'https://script.google.com/macros/s/AKfycbw9E1Qsc8-c8vowZ4pr7U_7Yd0t0q963Qiav5VvlrdLWr8kQS2e6Uy6ogBbwRi-0kpS/exec',
          LIFF_ID: '1657285806-2bmkYWkN'
      };

      let liffData = {};
      let currentUser = {};
      let userOrders = [];

      // ==================== LIFF åˆå§‹åŒ– ====================
      document.addEventListener('DOMContentLoaded', function() {
          console.log('=== LIFF ç¹³è²»ç³»çµ±å•Ÿå‹• ===');
          
          if (typeof liff === 'undefined') {
              showError('LIFF SDK è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
              return;
          }
          
          setupEventListeners();
          initializeLiff();
      });

      async function initializeLiff() {
          try {
              showLoading('åˆå§‹åŒ–ä¸­...');
              
              await liff.init({ liffId: CONFIG.LIFF_ID });
              console.log('LIFF åˆå§‹åŒ–æˆåŠŸ');
              
              if (liff.isLoggedIn()) {
                  const profile = await liff.getProfile();
                  liffData = {
                      userId: profile.userId,
                      displayName: profile.displayName,
                      pictureUrl: profile.pictureUrl || null
                  };
                  
                  console.log('ç”¨æˆ¶ LINE è³‡æ–™:', liffData);
                  displayUserInfo();
              } else {
                  console.log('ç”¨æˆ¶æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
                  liff.login();
              }
              
          } catch (error) {
              console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
              showError(`LIFF åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
          } finally {
              hideLoading();
          }
      }

      function displayUserInfo() {
          const userInfoDisplay = document.getElementById('userInfoDisplay');
          const lineDisplayName = document.getElementById('lineDisplayName');
          const userAvatar = document.getElementById('userAvatar');
          
          lineDisplayName.textContent = liffData.displayName;
          userAvatar.textContent = liffData.displayName.charAt(0).toUpperCase();
          userInfoDisplay.style.display = 'flex';
      }

      // ==================== äº‹ä»¶ç›£è½å™¨è¨­å®š ====================
      function setupEventListeners() {
          // ç”¨æˆ¶è³‡è¨Šè¡¨å–®æäº¤
          document.getElementById('userInfoForm').addEventListener('submit', handleUserInfoSubmit);
          
          // ç¹³è²»è¡¨å–®æäº¤
          document.getElementById('paymentForm').addEventListener('submit', handlePaymentSubmit);
          
          // ç¹³è²»æ–¹å¼é¸æ“‡
          document.querySelectorAll('.payment-method').forEach(method => {
              method.addEventListener('click', function() {
                  // ç§»é™¤å…¶ä»–é¸é …çš„é¸ä¸­ç‹€æ…‹
                  document.querySelectorAll('.payment-method').forEach(m => {
                      m.classList.remove('selected');
                  });
                  
                  // è¨­å®šç•¶å‰é¸é …ç‚ºé¸ä¸­
                  this.classList.add('selected');
                  const radio = this.querySelector('input[type="radio"]');
                  radio.checked = true;
                  
                  // é¡¯ç¤º/éš±è—è½‰å¸³æé†’
                  const transferNote = document.getElementById('transferNote');
                  if (radio.value === 'è½‰å¸³') {
                      transferNote.classList.add('show');
                  } else {
                      transferNote.classList.remove('show');
                  }
              });
          });
      }

      // ==================== è¡¨å–®è™•ç†å‡½æ•¸ ====================
      async function handleUserInfoSubmit(event) {
          event.preventDefault();
          
          try {
              const realName = document.getElementById('realName').value.trim();
              
              // é©—è­‰çœŸå¯¦å§“å
              if (!realName) {
                  throw new Error('è«‹è¼¸å…¥çœŸå¯¦å§“å');
              }
              
              if (realName.length < 2) {
                  throw new Error('çœŸå¯¦å§“åè‡³å°‘éœ€è¦2å€‹å­—å…ƒ');
              }
              
              if (!/^[\u4e00-\u9fa5a-zA-Z\s]+$/.test(realName)) {
                  throw new Error('çœŸå¯¦å§“ååªèƒ½åŒ…å«ä¸­æ–‡ã€è‹±æ–‡å’Œç©ºæ ¼');
              }
              
              currentUser = {
                  userId: liffData.userId,
                  lineDisplayName: liffData.displayName,
                  realName: realName
              };
              
              showLoading('è¼‰å…¥è¨‚å–®ä¸­...');
              
              // è¼‰å…¥ç”¨æˆ¶è¨‚å–®
              await loadUserOrders();
              
              // é¡¯ç¤ºè¨‚å–®ç¢ºèªé é¢
              showOrderSection();
              
          } catch (error) {
              showError(error.message);
          } finally {
              hideLoading();
          }
      }

      async function handlePaymentSubmit(event) {
          event.preventDefault();
          
          try {
              const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
              if (!selectedMethod) {
                  throw new Error('è«‹é¸æ“‡ç¹³è²»æ–¹å¼');
              }
              
              const paymentMethod = selectedMethod.value;
              const paymentNote = document.getElementById('paymentNote').value.trim();
              
              showLoading('æäº¤ç¹³è²»è³‡è¨Šä¸­...');
              
              const result = await submitPayment(paymentMethod, paymentNote);
              
              if (result.success) {
                  showSuccess('ç¹³è²»å›å ±æäº¤æˆåŠŸï¼ç®¡ç†å“¡å°‡æœƒé€²è¡Œç¢ºèªã€‚');
                  
                  // é‡ç½®è¡¨å–®
                  document.getElementById('paymentForm').reset();
                  document.querySelectorAll('.payment-method').forEach(m => {
                      m.classList.remove('selected');
                  });
                  document.getElementById('transferNote').classList.remove('show');
                  
                  // 3ç§’å¾Œè¿”å›è¨‚å–®é é¢
                  setTimeout(() => {
                      showOrderSection();
                  }, 3000);
              } else {
                  throw new Error(result.message || 'æäº¤å¤±æ•—');
              }
              
          } catch (error) {
              showError(error.message);
          } finally {
              hideLoading();
          }
      }

      // ==================== API å‘¼å«å‡½æ•¸ ====================
      async function loadUserOrders() {
          try {
              // æ¨¡æ“¬ API å‘¼å«è¼‰å…¥è¨‚å–®
              const response = await fetch(`${CONFIG.API_BASE_URL}?action=get-orders`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      userId: currentUser.userId,
                      lineDisplayName: currentUser.lineDisplayName,
                      realName: currentUser.realName
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  userOrders = result.orders || [];
              } else {
                  // å¦‚æœ API å¤±æ•—ï¼Œä½¿ç”¨ç¤ºç¯„è³‡æ–™
                  userOrders = generateSampleOrders();
              }
              
          } catch (error) {
              console.warn('è¼‰å…¥è¨‚å–®å¤±æ•—ï¼Œä½¿ç”¨ç¤ºç¯„è³‡æ–™:', error);
              // ä½¿ç”¨ç¤ºç¯„è³‡æ–™
              userOrders = generateSampleOrders();
          }
      }

      function generateSampleOrders() {
          return [
              {
                  orderId: 'ORD001',
                  productName: 'å•†å“ A',
                  unitPrice: 500,
                  quantity: 2,
                  totalAmount: 1000,
                  orderDate: '2024-01-15',
                  paymentStatus: 'æœªä»˜æ¬¾'
              },
              {
                  orderId: 'ORD002',
                  productName: 'å•†å“ B',
                  unitPrice: 800,
                  quantity: 1,
                  totalAmount: 800,
                  orderDate: '2024-01-20',
                  paymentStatus: 'å·²ä»˜æ¬¾'
              },
              {
                  orderId: 'ORD003',
                  productName: 'å•†å“ C',
                  unitPrice: 300,
                  quantity: 3,
                  totalAmount: 900,
                  orderDate: '2024-01-25',
                  paymentStatus: 'æœªä»˜æ¬¾'
              }
          ];
      }

      async function submitPayment(paymentMethod, paymentNote) {
          try {
              const response = await fetch(`${CONFIG.API_BASE_URL}?action=submit-payment`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      userId: currentUser.userId,
                      lineDisplayName: currentUser.lineDisplayName,
                      realName: currentUser.realName,
                      paymentMethod: paymentMethod,
                      paymentNote: paymentNote,
                      submitTime: new Date().toLocaleString('zh-TW')
                  })
              });
              
              const result = await response.json();
              return result;
              
          } catch (error) {
              console.warn('API å‘¼å«å¤±æ•—:', error);
              // æ¨¡æ“¬æˆåŠŸå›æ‡‰
              return {
                  success: true,
                  message: 'ç¹³è²»å›å ±å·²æäº¤ï¼Œè«‹ç­‰å¾…ç®¡ç†å“¡ç¢ºèª'
              };
          }
      }

      // ==================== é é¢é¡¯ç¤ºå‡½æ•¸ ====================
      function showSection(sectionId) {
          document.querySelectorAll('.section').forEach(section => {
              section.classList.remove('active');
          });
          document.getElementById(sectionId).classList.add('active');
      }

      function showUserInfoSection() {
          showSection('userInfoSection');
      }

      function showOrderSection() {
          showSection('orderSection');
          displayOrderConfirmation();
      }

      function showPaymentSection() {
          showSection('paymentSection');
          displayPaymentInfo();
      }

      function displayOrderConfirmation() {
          // æ›´æ–°ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º
          document.getElementById('userNameConfirm').textContent = currentUser.realName;
          document.getElementById('lineNameConfirm').textContent = currentUser.lineDisplayName;
          document.getElementById('userAvatarConfirm').textContent = currentUser.lineDisplayName.charAt(0).toUpperCase();
          
          // é¡¯ç¤ºè¨‚å–®åˆ—è¡¨
          const ordersList = document.getElementById('ordersList');
          let ordersHTML = '';
          let totalAmount = 0;
          let unpaidCount = 0;
          
          userOrders.forEach(order => {
              totalAmount += order.totalAmount;
              if (order.paymentStatus !== 'å·²ä»˜æ¬¾') {
                  unpaidCount++;
              }
              
              const statusClass = order.paymentStatus === 'å·²ä»˜æ¬¾' ? 'status-paid' : 'status-unpaid';
              
              ordersHTML += `
                  <div class="order-item">
                      <div class="order-header">
                          <h4>è¨‚å–® #${order.orderId}</h4>
                          <span class="status-badge ${statusClass}">${order.paymentStatus}</span>
                      </div>
                      
                      <div class="detail-item">
                          <span class="detail-label">å•†å“åç¨±</span>
                          <span class="detail-value">${order.productName}</span>
                      </div>
                      
                      <div class="order-details">
                          <div class="detail-item">
                              <span class="detail-label">å–®åƒ¹</span>
                              <span class="detail-value">NT$ ${order.unitPrice.toLocaleString()}</span>
                          </div>
                          <div class="detail-item">
                              <span class="detail-label">æ•¸é‡</span>
                              <span class="detail-value">${order.quantity}</span>
                          </div>
                      </div>
                      
                      <div class="total-amount">
                          å°è¨ˆï¼šNT$ ${order.totalAmount.toLocaleString()}
                      </div>
                      
                      <div style="text-align: center; color: #666; font-size: 14px; margin-top: 10px;">
                          è¨‚å–®æ—¥æœŸï¼š${order.orderDate}
                      </div>
                  </div>
              `;
          });
          
          ordersList.innerHTML = ordersHTML;
          
          // æ›´æ–°çµ±è¨ˆè³‡è¨Š
          document.getElementById('totalOrders').textContent = `${userOrders.length} ç­†`;
          document.getElementById('unpaidOrders').textContent = `${unpaidCount} ç­†`;
          document.getElementById('totalAmount').textContent = `NT$ ${toLocaleString()}`;
            
            // å¦‚æœæ²’æœ‰æœªä»˜æ¬¾è¨‚å–®ï¼Œéš±è—ç¹³è²»æŒ‰éˆ•
            const proceedPaymentBtn = document.getElementById('proceedPaymentBtn');
            if (unpaidCount === 0) {
                proceedPaymentBtn.style.display = 'none';
            } else {
                proceedPaymentBtn.style.display = 'block';
            }
        }

        function displayPaymentInfo() {
            // æ›´æ–°ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º
            document.getElementById('userNamePayment').textContent = currentUser.realName;
            document.getElementById('lineNamePayment').textContent = currentUser.lineDisplayName;
            document.getElementById('userAvatarPayment').textContent = currentUser.lineDisplayName.charAt(0).toUpperCase();
        }

        // ==================== å·¥å…·å‡½æ•¸ ====================
        function showLoading(message = 'è¼‰å…¥ä¸­...') {
            const loading = document.getElementById('loading');
            loading.querySelector('.loading-text').textContent = message;
            loading.classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }

        function showMessage(message, type = 'info') {
            // ç§»é™¤ç¾æœ‰è¨Šæ¯
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // å‰µå»ºæ–°è¨Šæ¯
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            // æ’å…¥åˆ°ç•¶å‰æ´»å‹•å€æ®µçš„é–‹é ­
            const activeSection = document.querySelector('.section.active .card');
            if (activeSection) {
                activeSection.insertBefore(messageDiv, activeSection.firstChild);
                
                // 5ç§’å¾Œè‡ªå‹•ç§»é™¤è¨Šæ¯
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 5000);
            }
        }

        function showSuccess(message) {
            showMessage(message, 'success');
        }

        function showError(message) {
            showMessage(message, 'error');
        }

        function showInfo(message) {
            showMessage(message, 'info');
        }

        // ==================== é™¤éŒ¯å·¥å…· ====================
        window.debugLiff = function() {
            console.log('=== LIFF é™¤éŒ¯è³‡è¨Š ===');
            console.log('LIFF ç‰©ä»¶:', liff);
            console.log('LIFF è³‡æ–™:', liffData);
            console.log('ç•¶å‰ç”¨æˆ¶:', currentUser);
            console.log('ç”¨æˆ¶è¨‚å–®:', userOrders);
            console.log('ç™»å…¥ç‹€æ…‹:', liff ? liff.isLoggedIn() : 'LIFF æœªè¼‰å…¥');
        };

        // ==================== æ¨¡æ“¬è³‡æ–™ç”Ÿæˆå™¨ (é–‹ç™¼ç”¨) ====================
        window.generateTestData = function() {
            liffData = {
                userId: 'test-user-123',
                displayName: 'æ¸¬è©¦ç”¨æˆ¶',
                pictureUrl: null
            };
            
            currentUser = {
                userId: 'test-user-123',
                lineDisplayName: 'æ¸¬è©¦ç”¨æˆ¶',
                realName: 'ç‹å°æ˜'
            };
            
            userOrders = [
                {
                    orderId: 'TEST001',
                    productName: 'æ¸¬è©¦å•†å“ A',
                    unitPrice: 1200,
                    quantity: 1,
                    totalAmount: 1200,
                    orderDate: '2024-01-15',
                    paymentStatus: 'æœªä»˜æ¬¾'
                },
                {
                    orderId: 'TEST002',
                    productName: 'æ¸¬è©¦å•†å“ B',
                    unitPrice: 800,
                    quantity: 2,
                    totalAmount: 1600,
                    orderDate: '2024-01-20',
                    paymentStatus: 'å·²ä»˜æ¬¾'
                }
            ];
            
            displayUserInfo();
            console.log('æ¸¬è©¦è³‡æ–™å·²ç”Ÿæˆ');
        };

        console.log('LIFF ç¹³è²»ç³»çµ±è…³æœ¬è¼‰å…¥å®Œæˆ');
    </script>
</body>
</html>
