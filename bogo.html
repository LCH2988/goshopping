<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LIFF Ë®ÇÂñÆÁ≥ªÁµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Microsoft JhengHei', Arial, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          color: #333;
      }

      .container {
          max-width: 500px;
          margin: 0 auto;
          padding: 20px;
          min-height: 100vh;
      }

      .card {
          background: white;
          border-radius: 15px;
          padding: 25px;
          margin-bottom: 20px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.2);
          animation: slideIn 0.5s ease-out;
      }

      @keyframes slideIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .header {
          text-align: center;
          margin-bottom: 30px;
      }

      .header h1 {
          color: #667eea;
          font-size: 28px;
          margin-bottom: 10px;
      }

      .header p {
          color: #666;
          font-size: 16px;
      }

      .user-info {
          display: flex;
          align-items: center;
          padding: 20px;
          background: linear-gradient(135deg, #667eea, #764ba2);
          border-radius: 12px;
          margin-bottom: 25px;
          color: white;
      }

      .user-avatar {
          width: 60px;
          height: 60px;
          border-radius: 50%;
          background: rgba(255,255,255,0.3);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 24px;
          font-weight: bold;
          margin-right: 15px;
          border: 3px solid rgba(255,255,255,0.5);
      }

      .user-details h3 {
          font-size: 18px;
          margin-bottom: 5px;
      }

      .user-details p {
          font-size: 14px;
          opacity: 0.9;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #555;
      }

      .form-group input, .form-group textarea, .form-group select {
          width: 100%;
          padding: 12px 15px;
          border: 2px solid #e1e5e9;
          border-radius: 8px;
          font-size: 16px;
          transition: all 0.3s ease;
      }

      .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn {
          width: 100%;
          padding: 15px;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          margin-bottom: 10px;
      }

      .btn-primary {
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
      }

      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-success {
          background: linear-gradient(135deg, #56ab2f, #a8e6cf);
          color: white;
      }

      .btn-success:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4);
      }

      .btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
          transform: none;
      }

      .order-item {
          border: 2px solid #f0f0f0;
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 15px;
          transition: all 0.3s ease;
      }

      .order-item:hover {
          border-color: #667eea;
          box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
      }

      .order-header h4 {
          color: #667eea;
          font-size: 18px;
          margin-bottom: 15px;
      }

      .detail-item {
          display: flex;
          justify-content: space-between;
          padding: 8px 0;
          border-bottom: 1px solid #f0f0f0;
      }

      .detail-label {
          color: #666;
          font-size: 14px;
      }

      .detail-value {
          font-weight: 600;
          color: #333;
      }

      .total-amount {
          font-size: 18px;
          font-weight: bold;
          color: #667eea;
          text-align: center;
          padding: 15px;
          background: #f8f9ff;
          border-radius: 8px;
          margin-top: 15px;
      }

      .payment-methods {
          margin-bottom: 20px;
      }

      .payment-method {
          display: flex;
          align-items: center;
          padding: 15px;
          border: 2px solid #e1e5e9;
          border-radius: 8px;
          margin-bottom: 10px;
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .payment-method:hover {
          border-color: #667eea;
          background: #f8f9ff;
      }

      .payment-method.selected {
          border-color: #667eea;
          background: #f8f9ff;
      }

      .payment-method input[type="radio"] {
          margin-right: 12px;
          transform: scale(1.2);
      }

      .payment-method label {
          font-weight: 600;
          cursor: pointer;
          flex: 1;
      }

      .section {
          display: none;
      }

      .section.active {
          display: block;
      }

      .summary-card {
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
          padding: 20px;
          border-radius: 12px;
          margin-bottom: 20px;
      }

      .summary-row {
          display: flex;
          justify-content: space-between;
          margin-bottom: 10px;
      }

      .summary-row:last-child {
          margin-bottom: 0;
          padding-top: 10px;
          border-top: 1px solid rgba(255,255,255,0.3);
          font-weight: bold;
          font-size: 18px;
      }

      .transfer-note {
          background: #fff3cd;
          border: 1px solid #ffeaa7;
          color: #856404;
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 20px;
          display: none;
      }

      .transfer-note.show {
          display: block;
      }

      .loading {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.7);
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          z-index: 9999;
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s ease;
      }

      .loading.show {
          opacity: 1;
          visibility: visible;
      }

      .loading-spinner {
          width: 50px;
          height: 50px;
          border: 4px solid rgba(255,255,255,0.3);
          border-top: 4px solid white;
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin-bottom: 20px;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .loading-text {
          color: white;
          font-size: 16px;
          font-weight: 600;
      }

      .message {
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 20px;
          font-weight: 600;
          animation: slideIn 0.5s ease-out;
      }

      .message.success {
          background: #e8f5e8;
          color: #2e7d32;
          border: 1px solid #4caf50;
      }

      .message.error {
          background: #ffebee;
          color: #c62828;
          border: 1px solid #f44336;
      }

      .message.info {
          background: #e3f2fd;
          color: #1565c0;
          border: 1px solid #2196f3;
      }

      .admin-indicator {
          background: linear-gradient(135deg, #ff6b6b, #ee5a24);
          color: white;
          padding: 10px;
          text-align: center;
          border-radius: 8px;
          margin-bottom: 20px;
          font-weight: bold;
      }

      @media (max-width: 480px) {
          .container {
              padding: 10px;
          }
          
          .card {
              padding: 20px;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <!-- ËºâÂÖ•Áï´Èù¢ -->
      <div id="loading" class="loading">
          <div class="loading-spinner"></div>
          <div class="loading-text">ËºâÂÖ•‰∏≠...</div>
      </div>

      <!-- ÁÆ°ÁêÜÂì°ÊèêÁ§∫ -->
      <div id="adminIndicator" class="admin-indicator" style="display: none;">
          üëë ÊÇ®ÊòØÁÆ°ÁêÜÂì°ÔºåË´ãÈªûÈÅ∏‰∏ãÊñπÊåâÈàïÈÄ≤ÂÖ•ÁÆ°ÁêÜÁ≥ªÁµ±
      </div>

      <!-- Ê≠•È©ü1: Áî®Êà∂Ë≥áË®äËº∏ÂÖ• -->
      <div id="userInfoSection" class="section active">
          <div class="card">
              <div class="header">
                  <h1>üì± LIFF Ë®ÇÂñÆÁ≥ªÁµ±</h1>
                  <p>Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÁúüÂØ¶ÂßìÂêç‰ª•Êü•ÁúãË®ÇÂñÆ</p>
              </div>

              <div id="userInfoDisplay" class="user-info" style="display: none;">
                  <div id="userAvatar" class="user-avatar"></div>
                  <div class="user-details">
                      <h3 id="lineDisplayName"></h3>
                      <p>LINE Áî®Êà∂</p>
                  </div>
              </div>

              <form id="userInfoForm">
                  <div class="form-group">
                      <label for="realName">ÁúüÂØ¶ÂßìÂêç *</label>
                      <input type="text" id="realName" name="realName" placeholder="Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÁúüÂØ¶ÂßìÂêç" required>
                  </div>
                  
                  <button type="submit" class="btn btn-primary" id="submitBtn">
                      üìã Êü•ÁúãÊàëÁöÑË®ÇÂñÆ
                  </button>
              </form>

              <button id="adminBtn" class="btn btn-success" style="display: none;" onclick="openAdminSystem()">
                  üëë ÈÄ≤ÂÖ•ÁÆ°ÁêÜÁ≥ªÁµ±
              </button>
          </div>
      </div>

      <!-- Ê≠•È©ü2: Ë®ÇÂñÆÁ¢∫Ë™ç -->
      <div id="orderSection" class="section">
          <div class="card">
              <div class="header">
                  <h1>üìã Ë®ÇË≥ºÊ∏ÖÂñÆÁ¢∫Ë™ç</h1>
                  <p>Ë´ãÁ¢∫Ë™çÊÇ®ÁöÑË®ÇË≥ºÂÖßÂÆπ</p>
              </div>

              <div id="userInfoConfirm" class="user-info">
                  <div id="userAvatarConfirm" class="user-avatar"></div>
                  <div class="user-details">
                      <h3 id="userNameConfirm"></h3>
                      <p id="lineNameConfirm"></p>
                  </div>
              </div>

              <div id="ordersList"></div>

              <div id="orderSummary" class="summary-card">
                  <div class="summary-row">
                      <span>Áî¢ÂìÅÁ®ÆÈ°ûÔºö</span>
                      <span id="productTypes">0 Á®Æ</span>
                  </div>
                  <div class="summary-row">
                      <span>Á∏ΩÊï∏ÈáèÔºö</span>
                      <span id="totalQuantity">0 ‰ª∂</span>
                  </div>
                  <div class="summary-row">
                      <span>Á∏ΩÈáëÈ°çÔºö</span>
                      <span id="totalAmount">NT$ 0</span>
                  </div>
              </div>

              <button class="btn btn-success" onclick="showPaymentSection()" id="proceedPaymentBtn">
                  üí≥ ÈÄ≤Ë°åÁπ≥Ë≤ªÂõûÂ†±
              </button>
              
              <button class="btn btn-primary" onclick="showUserInfoSection()" style="background: #6c757d;">
                  ‚¨ÖÔ∏è ËøîÂõû‰∏ä‰∏ÄÊ≠•
              </button>
          </div>
      </div>

      <!-- Ê≠•È©ü3: Áπ≥Ë≤ªÂõûÂ†± -->
      <div id="paymentSection" class="section">
          <div class="card">
              <div class="header">
                  <h1>üí≥ Áπ≥Ë≤ªÂõûÂ†±</h1>
                  <p>Ë´ãÈÅ∏ÊìáÊÇ®ÁöÑÁπ≥Ë≤ªÊñπÂºè‰∏¶Êèê‰∫§</p>
              </div>

              <div id="userInfoPayment" class="user-info">
                  <div id="userAvatarPayment" class="user-avatar"></div>
                  <div class="user-details">
                      <h3 id="userNamePayment"></h3>
                      <p id="lineNamePayment"></p>
                  </div>
              </div>

              <form id="paymentForm">
                  <div class="form-group">
                      <label>Áπ≥Ë≤ªÊñπÂºè *</label>
                      <div class="payment-methods">
                          <div class="payment-method" data-method="ÁèæÈáë">
                              <input type="radio" name="paymentMethod" value="ÁèæÈáë" id="cash">
                              <label for="cash">üíµ ÁèæÈáëÁπ≥Ë≤ª</label>
                          </div>
                          
                          <div class="payment-method" data-method="ËΩâÂ∏≥">
                              <input type="radio" name="paymentMethod" value="ËΩâÂ∏≥" id="transfer">
                              <label for="transfer">üè¶ ÈäÄË°åËΩâÂ∏≥</label>
                          </div>
                          
                          <div class="payment-method" data-method="LINE Pay">
                              <input type="radio" name="paymentMethod" value="LINE Pay" id="linePay">
                              <label for="linePay">üíö LINE Pay</label>
                          </div>
                      </div>
                  </div>

                  <div id="transferNote" class="transfer-note">
                      üí° ËΩâÂ∏≥ÊèêÈÜíÔºöË´ãÂú®ÂÇôË®ªÊ¨ÑÂ°´ÂØ´ÊÇ®ÁöÑÂ∏≥ËôüÂæå5Á¢ºÔºå‰ª•‰æøÊ†∏Â∞ç
                  </div>

                  <div class="form-group">
                      <label for="paymentNote">ÂÇôË®ª</label>
                      <textarea id="paymentNote" rows="3" placeholder="Â¶ÇÈÅ∏ÊìáËΩâÂ∏≥ÔºåË´ãÊèê‰æõÂ∏≥ËôüÂæå5Á¢ºÁ≠âÁõ∏ÈóúË≥áË®ä..."></textarea>
                  </div>
                  
                  <button type="submit" class="btn btn-success" id="paymentSubmitBtn">
                      ‚úÖ Êèê‰∫§Áπ≥Ë≤ªÂõûÂ†±
                  </button>
                  
                  <button type="button" class="btn btn-primary" onclick="showOrderSection()" style="background: #6c757d;">
                      ‚¨ÖÔ∏è ËøîÂõûË®ÇÂñÆÁ¢∫Ë™ç
                  </button>
              </form>
          </div>
      </div>
  </div>

  <script>
      // ===== Ë®≠ÂÆöËàáÂÖ®ÂüüËÆäÊï∏ =====
      const CONFIG = {
          API_BASE_URL: 'https://script.google.com/macros/s/AKfycbzlhqq6GX72Vk7RuKUwvD_tcuoFgik-trtLV-Sj0XghAeNc9Yi4g3F9FGikZZCoT8k/exec', // Ë´ãÊõøÊèõÁÇ∫ÊÇ®ÁöÑ GAS URL
          LIFF_ID: '1657285806-2bmkYWkN' // Ë´ãÊõøÊèõÁÇ∫ÊÇ®ÁöÑ LIFF ID
      };

      let liffData = {};
      let currentUser = {};
      let userOrders = [];
      let isAdmin = false;

      // ===== LIFF ÂàùÂßãÂåñ =====
      document.addEventListener('DOMContentLoaded', function() {
          console.log('=== LIFF Ë®ÇÂñÆÁ≥ªÁµ±ÂïüÂãï ===');
          
          if (typeof liff === 'undefined') {
              showError('LIFF SDK ËºâÂÖ•Â§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢');
              return;
          }
          
          setupEventListeners();
          initializeLiff();
      });

      async function initializeLiff() {
          try {
              showLoading('ÂàùÂßãÂåñ‰∏≠...');
              
              await liff.init({ liffId: CONFIG.LIFF_ID });
              console.log('LIFF ÂàùÂßãÂåñÊàêÂäü');
              
              if (liff.isLoggedIn()) {
                  const profile = await liff.getProfile();
                  liffData = {
                      userId: profile.userId,
                      displayName: profile.displayName,
                      pictureUrl: profile.pictureUrl || null
                  };
                  
                  console.log('Áî®Êà∂ LINE Ë≥áÊñô:', liffData);
                  
                  // Ê™¢Êü•Áî®Êà∂ÁãÄÊÖã
                  await checkUserStatus();
                  
              } else {
                  console.log('Áî®Êà∂Êú™ÁôªÂÖ•ÔºåÂ∞éÂêëÁôªÂÖ•È†ÅÈù¢');
                  liff.login();
              }
              
          } catch (error) {
              console.error('LIFF ÂàùÂßãÂåñÂ§±Êïó:', error);
              showError(`LIFF ÂàùÂßãÂåñÂ§±Êïó: ${error.message}`);
          } finally {
              hideLoading();
          }
      }

      async function checkUserStatus() {
          try {
              const response = await fetch(CONFIG.API_BASE_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'user_login',
                      userId: liffData.userId,
                      displayName: liffData.displayName
                  })
              });

              const result = await response.json();
              
              if (result.success) {
                  isAdmin = result.data.isAdmin;
                  
                  // È°ØÁ§∫Áî®Êà∂Ë≥áË®ä
                  displayUserInfo();
                  
                  // Â¶ÇÊûúÊòØÁÆ°ÁêÜÂì°ÔºåÈ°ØÁ§∫ÁÆ°ÁêÜÂì°ÊåâÈàï
                  if (isAdmin) {
                      document.getElementById('adminIndicator').style.display = 'block';
                      document.getElementById('adminBtn').style.display = 'block';
                  }
                  
                  // Â¶ÇÊûúÂ∑≤Ë®ªÂÜäÔºåËá™ÂãïÂ°´ÂÖ•ÁúüÂØ¶ÂßìÂêç
                  if (result.data.isRegistered && result.data.userInfo) {
                      document.getElementById('realName').value = result.data.userInfo.realName;
                      currentUser = result.data.userInfo;
                  }
                  
              } else {
                  showError(result.message || 'Ê™¢Êü•Áî®Êà∂ÁãÄÊÖãÂ§±Êïó');
              }
              
          } catch (error) {
              console.error('Ê™¢Êü•Áî®Êà∂ÁãÄÊÖãÂ§±Êïó:', error);
              showError('ÈÄ£Êé•‰º∫ÊúçÂô®Â§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑ö');
          }
      }

      function displayUserInfo() {
          const userInfoDisplay = document.getElementById('userInfoDisplay');
          const lineDisplayName = document.getElementById('lineDisplayName');
          const userAvatar = document.getElementById('userAvatar');
          
          lineDisplayName.textContent = liffData.displayName;
          userAvatar.textContent = liffData.displayName.charAt(0).toUpperCase();
          userInfoDisplay.style.display = 'flex';
      }

      // ===== ‰∫ã‰ª∂Áõ£ËÅΩÂô®Ë®≠ÂÆö =====
      function setupEventListeners() {
          // Áî®Êà∂Ë≥áË®äË°®ÂñÆÊèê‰∫§
          document.getElementById('userInfoForm').addEventListener('submit', handleUserInfoSubmit);
          
          // Áπ≥Ë≤ªË°®ÂñÆÊèê‰∫§
          document.getElementById('paymentForm').addEventListener('submit', handlePaymentSubmit);
          
          // Áπ≥Ë≤ªÊñπÂºèÈÅ∏Êìá
          document.querySelectorAll('.payment-method').forEach(method => {
              method.addEventListener('click', function() {
                  // ÁßªÈô§ÂÖ∂‰ªñÈÅ∏È†ÖÁöÑÈÅ∏‰∏≠ÁãÄÊÖã
                  document.querySelectorAll('.payment-method').forEach(m => {
                      m.classList.remove('selected');
                  });
                  
                  // Ë®≠ÂÆöÁï∂ÂâçÈÅ∏È†ÖÁÇ∫ÈÅ∏‰∏≠
                  this.classList.add('selected');
                  const radio = this.querySelector('input[type="radio"]');
                  radio.checked = true;
                  
                  // È°ØÁ§∫/Èö±ËóèËΩâÂ∏≥ÊèêÈÜí
                  const transferNote = document.getElementById('transferNote');
                  if (radio.value === 'ËΩâÂ∏≥') {
                      transferNote.classList.add('show');
                  } else {
                      transferNote.classList.remove('show');
                  }
              });
          });
      }

      // ===== Ë°®ÂñÆËôïÁêÜÂáΩÊï∏ =====
      async function handleUserInfoSubmit(event) {
          event.preventDefault();
          
          try {
              const realName = document.getElementById('realName').value.trim();
              
              // È©óË≠âÁúüÂØ¶ÂßìÂêç
              if (!realName) {
                  throw new Error('Ë´ãËº∏ÂÖ•ÁúüÂØ¶ÂßìÂêç');
              }
              
              if (realName.length < 2) {
                  throw new Error('ÁúüÂØ¶ÂßìÂêçËá≥Â∞ëÈúÄË¶Å2ÂÄãÂ≠óÂÖÉ');
              }
              
              if (!/^[\u4e00-\u9fa5a-zA-Z\s]+$/.test(realName)) {
                  throw new Error('ÁúüÂØ¶ÂßìÂêçÂè™ËÉΩÂåÖÂê´‰∏≠Êñá„ÄÅËã±ÊñáÂíåÁ©∫Ê†º');
              }
              
              showLoading('Ë®ªÂÜä‰∏≠...');
              
              // Ë®ªÂÜäÁî®Êà∂
              const registerResult = await registerUser(realName);
              
              if (registerResult.success) {
                  currentUser = registerResult.data.userInfo;
                  
                  // ËºâÂÖ•Áî®Êà∂Ë®ÇÂñÆ
                  await loadUserOrders();
                  
                  // È°ØÁ§∫Ë®ÇÂñÆÁ¢∫Ë™çÈ†ÅÈù¢
                  showOrderSection();
                  
              } else {
                  throw new Error(registerResult.message);
              }
              
          } catch (error) {
              showError(error.message);
          } finally {
              hideLoading();
          }
      }

      async function handlePaymentSubmit(event) {
          event.preventDefault();
          
          try {
              const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
              if (!selectedMethod) {
                  throw new Error('Ë´ãÈÅ∏ÊìáÁπ≥Ë≤ªÊñπÂºè');
              }
              
              const paymentMethod = selectedMethod.value;
              const paymentNote = document.getElementById('paymentNote').value.trim();
              
              // Â¶ÇÊûúÈÅ∏ÊìáËΩâÂ∏≥ÔºåÊ™¢Êü•ÂÇôË®ª
              if (paymentMethod === 'ËΩâÂ∏≥' && !paymentNote) {
                  throw new Error('ÈÅ∏ÊìáËΩâÂ∏≥Áπ≥Ë≤ªÊôÇÔºåË´ãÂú®ÂÇôË®ª‰∏≠Êèê‰æõÂ∏≥ËôüÂæå5Á¢º');
              }
              
              showLoading('Êèê‰∫§Áπ≥Ë≤ªË≥áË®ä‰∏≠...');
              
              const result = await submitPayment(paymentMethod, paymentNote);
              
              if (result.success) {
                  showSuccess('Áπ≥Ë≤ªÂõûÂ†±Êèê‰∫§ÊàêÂäüÔºÅÁÆ°ÁêÜÂì°Â∞áÊúÉÈÄ≤Ë°åÁ¢∫Ë™ç„ÄÇ');
                  
                  // ÈáçÁΩÆË°®ÂñÆ
                  document.getElementById('paymentForm').reset();
                  document.querySelectorAll('.payment-method').forEach(m => {
                      m.classList.remove('selected');
                  });
                  document.getElementById('transferNote').classList.remove('show');
                  
                  // 3ÁßíÂæåËøîÂõûË®ÇÂñÆÈ†ÅÈù¢
                  setTimeout(() => {
                      showOrderSection();
                  }, 3000);
              } else {
                  throw new Error(result.message || 'Êèê‰∫§Â§±Êïó');
              }
              
          } catch (error) {
              showError(error.message);
          } finally {
              hideLoading();
          }
      }

      // ===== API ÂëºÂè´ÂáΩÊï∏ =====
      async function registerUser(realName) {
          const response = await fetch(CONFIG.API_BASE_URL, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                  action: 'user_register',
                  userId: liffData.userId,
                  displayName: liffData.displayName,
                  realName: realName
              })
          });
          
          return await response.json();
      }

      async function loadUserOrders() {
          const response = await fetch(CONFIG.API_BASE_URL, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                  action: 'get_user_orders',
                  userId: liffData.userId,
                  displayName: liffData.displayName
              })
          });
          
          const result = await response.json();
          
          if (result.success) {
              userOrders = result.data;
          } else {
              throw new Error(result.message);
          }
      }

      async function submitPayment(paymentMethod, paymentNote) {
          const totalAmount = userOrders.summary ? userOrders.summary.totalAmount : 0;
          
          const response = await fetch(CONFIG.API_BASE_URL, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                  action: 'submit_payment',
                  userId: liffData.userId,
                  displayName: liffData.displayName,
                  realName: currentUser.realName,
                  paymentMethod: paymentMethod,
                  paymentNote: paymentNote,
                  totalAmount: totalAmount
              })
          });
          
          return await response.json();
      }

      // ===== È†ÅÈù¢È°ØÁ§∫ÂáΩÊï∏ =====
      function showSection(sectionId) {
          document.querySelectorAll('.section').forEach(section => {
              section.classList.remove('active');
          });
          document.getElementById(sectionId).classList.add('active');
      }

      function showUserInfoSection() {
          showSection('userInfoSection');
      }

      function showOrderSection() {
          showSection('orderSection');
          displayOrderConfirmation();
      }

      function showPaymentSection() {
          showSection('paymentSection');
          displayPaymentInfo();
      }

      function displayOrderConfirmation() {
          if (!userOrders.hasOrders) {
              showError('Ê≤íÊúâË®ÇÂñÆË≥áÊñô');
              return;
          }

          // Êõ¥Êñ∞Áî®Êà∂Ë≥áË®äÈ°ØÁ§∫
          document.getElementById('userNameConfirm').textContent = currentUser.realName;
          document.getElementById('lineNameConfirm').textContent = liffData.displayName;
          document.getElementById('userAvatarConfirm').textContent = liffData.displayName.charAt(0).toUpperCase();
          
          // È°ØÁ§∫Ë®ÇÂñÆÂàóË°®
          const ordersList = document.getElementById('ordersList');
          let ordersHTML = '';
          
          userOrders.products.forEach((product, index) => {
              ordersHTML += `
                  <div class="order-item">
                      <div class="order-header">
                          <h4>Áî¢ÂìÅ ${index + 1}</h4>
                      </div>
                      
                      <div class="detail-item">
                          <span class="detail-label">Áî¢ÂìÅÂêçÁ®±</span>
                          <span class="detail-value">${product.product}</span>
                      </div>
                      
                      <div class="detail-item">
                          <span class="detail-label">ÂñÆÂÉπ</span>
                          <span class="detail-value">NT$ ${product.unitPrice.toLocaleString()}</span>
                      </div>
                      
                      <div class="detail-item">
                          <span class="detail-label">Êï∏Èáè</span>
                          <span class="detail-value">${product.quantity}</span>
                      </div>
                      
                      <div class="total-amount">
                          Â∞èË®àÔºöNT$ ${product.total.toLocaleString()}
                      </div>
                  </div>
              `;
          });
          
          ordersList.innerHTML = ordersHTML;
          
      // Êõ¥Êñ∞Áµ±Ë®àË≥áË®ä
      document.getElementById('productTypes').textContent = `${userOrders.summary.productTypes} Á®Æ`;
      document.getElementById('totalQuantity').textContent = `${userOrders.summary.totalQuantity} ‰ª∂`;
      document.getElementById('totalAmount').textContent = `NT$ ${userOrders.summary.totalAmount.toLocaleString()}`;
  }

  function displayPaymentInfo() {
      // Êõ¥Êñ∞Áî®Êà∂Ë≥áË®äÈ°ØÁ§∫
      document.getElementById('userNamePayment').textContent = currentUser.realName;
      document.getElementById('lineNamePayment').textContent = liffData.displayName;
      document.getElementById('userAvatarPayment').textContent = liffData.displayName.charAt(0).toUpperCase();
  }

  // ===== ÁÆ°ÁêÜÂì°ÂäüËÉΩ =====
  function openAdminSystem() {
      // ÈñãÂïüÁÆ°ÁêÜÂì°Á≥ªÁµ± (Êñ∞Ë¶ñÁ™óÊàñÂ∞éÂêë)
      const adminUrl = 'admin.html'; // ÁÆ°ÁêÜÂì°È†ÅÈù¢ URL
      window.open(adminUrl, '_blank');
  }

  // ===== Â∑•ÂÖ∑ÂáΩÊï∏ =====
  function showLoading(message = 'ËºâÂÖ•‰∏≠...') {
      const loading = document.getElementById('loading');
      loading.querySelector('.loading-text').textContent = message;
      loading.classList.add('show');
  }

  function hideLoading() {
      document.getElementById('loading').classList.remove('show');
  }

  function showMessage(message, type = 'info') {
      // ÁßªÈô§ÁèæÊúâË®äÊÅØ
      const existingMessage = document.querySelector('.message');
      if (existingMessage) {
          existingMessage.remove();
      }
      
      // ÂâµÂª∫Êñ∞Ë®äÊÅØ
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;
      
      // ÊèíÂÖ•Âà∞Áï∂ÂâçÊ¥ªÂãïÂçÄÊÆµÁöÑÈñãÈ†≠
      const activeSection = document.querySelector('.section.active .card');
      if (activeSection) {
          activeSection.insertBefore(messageDiv, activeSection.firstChild);
          
          // 5ÁßíÂæåËá™ÂãïÁßªÈô§Ë®äÊÅØ
          setTimeout(() => {
              if (messageDiv.parentNode) {
                  messageDiv.remove();
              }
          }, 5000);
      }
  }

  function showSuccess(message) {
      showMessage(message, 'success');
  }

  function showError(message) {
      showMessage(message, 'error');
  }

  function showInfo(message) {
      showMessage(message, 'info');
  }

  // ===== Èô§ÈåØÂ∑•ÂÖ∑ =====
  window.debugLiff = function() {
      console.log('=== LIFF Èô§ÈåØË≥áË®ä ===');
      console.log('LIFF Áâ©‰ª∂:', liff);
      console.log('LIFF Ë≥áÊñô:', liffData);
      console.log('Áï∂ÂâçÁî®Êà∂:', currentUser);
      console.log('Áî®Êà∂Ë®ÇÂñÆ:', userOrders);
      console.log('ÊòØÂê¶ÁÇ∫ÁÆ°ÁêÜÂì°:', isAdmin);
      console.log('ÁôªÂÖ•ÁãÄÊÖã:', liff ? liff.isLoggedIn() : 'LIFF Êú™ËºâÂÖ•');
  };

  console.log('LIFF Ë®ÇÂñÆÁ≥ªÁµ±ËÖ≥Êú¨ËºâÂÖ•ÂÆåÊàê');
</script>
</body>
</html>
