<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title><!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>„ÄêÂ§öÁ¶èÊ∞£„ÄëBOGOÁÆ°ÁêÜËÄÖ‰ªãÈù¢</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: #f5f5f5;
          color: #333;
      }

      .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 1rem;
          text-align: center;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      .nav-tabs {
          display: flex;
          background: white;
          border-bottom: 1px solid #ddd;
          overflow-x: auto;
      }

      .nav-tab {
          flex: 1;
          min-width: 120px;
          padding: 1rem;
          text-align: center;
          background: white;
          border: none;
          cursor: pointer;
          transition: all 0.3s;
          font-size: 14px;
      }

      .nav-tab.active {
          background: #667eea;
          color: white;
      }

      .nav-tab:hover {
          background: #f0f0f0;
      }

      .nav-tab.active:hover {
          background: #5a6fd8;
      }

      .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 1rem;
      }

      .tab-content {
          display: none;
          background: white;
          border-radius: 8px;
          padding: 1.5rem;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          margin-top: 1rem;
      }

      .tab-content.active {
          display: block;
      }

      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1rem;
          margin-bottom: 2rem;
      }

      .stat-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 1.5rem;
          border-radius: 8px;
          text-align: center;
      }

      .stat-number {
          font-size: 2rem;
          font-weight: bold;
          margin-bottom: 0.5rem;
      }

      .stat-label {
          font-size: 0.9rem;
          opacity: 0.9;
      }

      .search-section {
          background: #f8f9fa;
          padding: 1.5rem;
          border-radius: 8px;
          margin-bottom: 2rem;
      }

      .search-input {
          width: 100%;
          padding: 0.75rem;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 16px;
          margin-bottom: 1rem;
      }

      .search-results {
          display: grid;
          gap: 0.5rem;
      }

      .member-item {
          background: white;
          padding: 1rem;
          border-radius: 4px;
          border: 1px solid #eee;
          cursor: pointer;
          transition: all 0.3s;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .member-item:hover {
          background: #f0f8ff;
          border-color: #667eea;
      }

      .member-info {
          flex: 1;
      }

      .member-name {
          font-weight: bold;
          margin-bottom: 0.25rem;
      }

      .member-details {
          font-size: 0.9rem;
          color: #666;
      }

      .order-badge {
          background: #667eea;
          color: white;
          padding: 0.25rem 0.5rem;
          border-radius: 12px;
          font-size: 0.8rem;
      }

      .table-container {
          overflow-x: auto;
          margin-top: 1rem;
      }

      table {
          width: 100%;
          border-collapse: collapse;
          background: white;
      }

      th, td {
          padding: 0.75rem;
          text-align: left;
          border-bottom: 1px solid #eee;
      }

      th {
          background: #f8f9fa;
          font-weight: bold;
          position: sticky;
          top: 0;
      }

      tr:hover {
          background: #f8f9fa;
      }

      .btn {
          padding: 0.5rem 1rem;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 14px;
          transition: all 0.3s;
          margin: 0.25rem;
      }

      .btn-primary {
          background: #667eea;
          color: white;
      }

      .btn-primary:hover {
          background: #5a6fd8;
      }

      .btn-success {
          background: #28a745;
          color: white;
      }

      .btn-success:hover {
          background: #218838;
      }

      .btn-danger {
          background: #dc3545;
          color: white;
      }

      .btn-danger:hover {
          background: #c82333;
      }

      .btn-warning {
          background: #ffc107;
          color: #212529;
      }

      .btn-warning:hover {
          background: #e0a800;
      }

      .btn-secondary {
          background: #6c757d;
          color: white;
      }

      .btn-secondary:hover {
          background: #5a6268;
      }

      .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
      }

      .modal-content {
          background: white;
          margin: 5% auto;
          padding: 2rem;
          border-radius: 8px;
          width: 90%;
          max-width: 600px;
          max-height: 80vh;
          overflow-y: auto;
      }

      .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
          padding-bottom: 1rem;
          border-bottom: 1px solid #eee;
      }

      .close {
          background: none;
          border: none;
          font-size: 1.5rem;
          cursor: pointer;
          color: #999;
      }

      .close:hover {
          color: #333;
      }

      .form-group {
          margin-bottom: 1rem;
      }

      .form-label {
          display: block;
          margin-bottom: 0.5rem;
          font-weight: bold;
      }

      .form-control {
          width: 100%;
          padding: 0.5rem;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 14px;
      }

      .form-control:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
      }

      .alert {
          padding: 1rem;
          border-radius: 4px;
          margin-bottom: 1rem;
      }

      .alert-success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }

      .alert-danger {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }

      .alert-warning {
          background: #fff3cd;
          color: #856404;
          border: 1px solid #ffeaa7;
      }

      .loading {
          text-align: center;
          padding: 2rem;
          color: #666;
      }

      .spinner {
          border: 3px solid #f3f3f3;
          border-top: 3px solid #667eea;
          border-radius: 50%;
          width: 30px;
          height: 30px;
          animation: spin 1s linear infinite;
          margin: 0 auto 1rem;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .checkbox-group {
          display: flex;
          flex-wrap: wrap;
          gap: 1rem;
          margin: 1rem 0;
      }

      .checkbox-item {
          display: flex;
          align-items: center;
          gap: 0.5rem;
      }

      .status-badge {
          padding: 0.25rem 0.5rem;
          border-radius: 12px;
          font-size: 0.8rem;
          font-weight: bold;
      }

      .status-pending {
          background: #fff3cd;
          color: #856404;
      }

      .status-approved {
          background: #d4edda;
          color: #155724;
      }

      .status-rejected {
          background: #f8d7da;
          color: #721c24;
      }

      .order-summary {
          background: #f8f9fa;
          padding: 1rem;
          border-radius: 4px;
          margin: 1rem 0;
      }

      .summary-row {
          display: flex;
          justify-content: space-between;
          margin-bottom: 0.5rem;
      }

      .summary-total {
          font-weight: bold;
          font-size: 1.1rem;
          border-top: 1px solid #ddd;
          padding-top: 0.5rem;
          margin-top: 0.5rem;
      }

      @media (max-width: 768px) {
          .container {
              padding: 0.5rem;
          }

          .stats-grid {
              grid-template-columns: repeat(2, 1fr);
          }

          .stat-card {
              padding: 1rem;
          }

          .stat-number {
              font-size: 1.5rem;
          }

          .modal-content {
              margin: 2% auto;
              width: 95%;
              padding: 1rem;
          }

          .nav-tab {
              font-size: 12px;
              padding: 0.75rem 0.5rem;
          }
      }
  </style>
</head>
<body>
  <div class="header">
      <h1>üìä Ë®ÇË≥ºÁ≥ªÁµ±ÁÆ°ÁêÜ‰∏≠ÂøÉ</h1>
      <p id="adminInfo">ËºâÂÖ•‰∏≠...</p>
  </div>

  <div class="nav-tabs">
      <button class="nav-tab active" onclick="showTab('dashboard')">ÂÑÄË°®Êùø</button>
      <button class="nav-tab" onclick="showTab('payments')">Áπ≥Ë≤ªÂØ©Ê†∏</button>
      <button class="nav-tab" onclick="showTab('members')">ÊúÉÂì°ÁÆ°ÁêÜ</button>
      <button class="nav-tab" onclick="showTab('orders')">Ë®ÇÂñÆÊü•Ë©¢</button>
      <button class="nav-tab" onclick="showTab('reports')">Â†±Ë°®</button>
      <button class="nav-tab" onclick="showTab('settings')">Á≥ªÁµ±Ë®≠ÂÆö</button>
  </div>

  <div class="container">
      <!-- ÂÑÄË°®Êùø -->
      <div id="dashboard" class="tab-content active">
          <h2>üìà Á≥ªÁµ±Ê¶ÇË¶Ω</h2>
          <div class="stats-grid" id="statsGrid">
              <!-- Áµ±Ë®àÂç°ÁâáÂ∞áÁî± JavaScript ÂãïÊÖãÁîüÊàê -->
          </div>
          
          <div class="alert alert-warning" id="pendingAlert" style="display: none;">
              <strong>‚ö†Ô∏è Ê≥®ÊÑèÔºö</strong> <span id="pendingCount">0</span> Á≠ÜÁπ≥Ë≤ªË®òÈåÑÂæÖÂØ©Ê†∏
          </div>
      </div>

      <!-- Áπ≥Ë≤ªÂØ©Ê†∏ -->
      <div id="payments" class="tab-content">
          <h2>üí≥ Áπ≥Ë≤ªÂØ©Ê†∏</h2>
          
          <div style="margin-bottom: 1rem;">
              <button class="btn btn-primary" onclick="loadPendingPayments()">üîÑ ÈáçÊñ∞ËºâÂÖ•</button>
              <button class="btn btn-success" onclick="showBatchReview('Â∑≤Á¢∫Ë™ç')">‚úÖ ÊâπÈáèÈÄöÈÅé</button>
              <button class="btn btn-danger" onclick="showBatchReview('Â∑≤ÊãíÁµï')">‚ùå ÊâπÈáèÊãíÁµï</button>
          </div>

          <div class="table-container">
              <table id="paymentsTable">
                  <thead>
                      <tr>
                          <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                          <th>Áπ≥Ë≤ªÁ∑®Ëôü</th>
                          <th>ÊúÉÂì°ÂßìÂêç</th>
                          <th>Áπ≥Ë≤ªÈáëÈ°ç</th>
                          <th>Áπ≥Ë≤ªÊñπÂºè</th>
                          <th>Êèê‰∫§ÊôÇÈñì</th>
                          <th>ÁãÄÊÖã</th>
                          <th>Êìç‰Ωú</th>
                      </tr>
                  </thead>
                  <tbody id="paymentsTableBody">
                      <!-- Ë≥áÊñôÂ∞áÁî± JavaScript ÂãïÊÖãËºâÂÖ• -->
                  </tbody>
              </table>
          </div>
      </div>

      <!-- ÊúÉÂì°ÁÆ°ÁêÜ -->
      <div id="members" class="tab-content">
          <h2>üë• ÊúÉÂì°ÁÆ°ÁêÜ</h2>
          
          <div class="table-container">
              <table id="membersTable">
                  <thead>
                      <tr>
                          <th>LINEÂêçÁ®±</th>
                          <th>ÁúüÂØ¶ÂßìÂêç</th>
                          <th>Ë®ªÂÜäÊôÇÈñì</th>
                          <th>Ë®ÇÂñÆÊï∏Èáè</th>
                          <th>Áπ≥Ë≤ªÊ¨°Êï∏</th>
                          <th>ÁãÄÊÖã</th>
                      </tr>
                  </thead>
                  <tbody id="membersTableBody">
                      <!-- Ë≥áÊñôÂ∞áÁî± JavaScript ÂãïÊÖãËºâÂÖ• -->
                  </tbody>
              </table>
          </div>
      </div>

      <!-- Ë®ÇÂñÆÊü•Ë©¢ -->
      <div id="orders" class="tab-content">
          <h2>üõí Ë®ÇÂñÆÊü•Ë©¢ËàáÁÆ°ÁêÜ</h2>
          
          <div class="search-section">
              <h3>üîç ÊêúÂ∞ãÊúÉÂì°</h3>
              <input type="text" id="memberSearch" class="search-input" 
                     placeholder="Ëº∏ÂÖ• LINE ÂêçÁ®±ÊàñÁúüÂØ¶ÂßìÂêçÈÄ≤Ë°åÊêúÂ∞ã..." 
                     onkeyup="searchMembers(event)">
              
              <div id="searchResults" class="search-results">
                  <!-- ÊêúÂ∞ãÁµêÊûúÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£° -->
              </div>
          </div>

          <div id="memberOrdersSection" style="display: none;">
              <div class="modal-header">
                  <h3 id="selectedMemberName">ÊúÉÂì°Ë®ÇÂñÆ</h3>
                  <button class="btn btn-primary" onclick="addNewOrder()">‚ûï Êñ∞Â¢ûË®ÇÂñÆ</button>
              </div>

              <div id="memberInfo" class="order-summary">
                  <!-- ÊúÉÂì°Ë≥áË®äÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£° -->
              </div>

              <div class="table-container">
                  <table id="memberOrdersTable">
                      <thead>
                          <tr>
                              <th>Áî¢ÂìÅ‰ª£Ëôü</th>
                              <th>Áî¢ÂìÅÂêçÁ®±</th>
                              <th>Êï∏Èáè</th>
                              <th>ÂñÆÂÉπ</th>
                              <th>ÂêàË®à</th>
                              <th>Êìç‰Ωú</th>
                          </tr>
                      </thead>
                      <tbody id="memberOrdersTableBody">
                          <!-- Ë®ÇÂñÆË≥áÊñôÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£° -->
                      </tbody>
                  </table>
              </div>

              <div id="orderSummary" class="order-summary">
                  <!-- Ë®ÇÂñÆÊëòË¶ÅÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£° -->
              </div>

              <div id="paymentHistory" style="margin-top: 2rem;">
                  <h4>üí∞ Áπ≥Ë≤ªË®òÈåÑ</h4>
                  <div class="table-container">
                      <table id="paymentHistoryTable">
                          <thead>
                              <tr>
                                  <th>Áπ≥Ë≤ªÁ∑®Ëôü</th>
                                  <th>Áπ≥Ë≤ªÈáëÈ°ç</th>
                                  <th>Áπ≥Ë≤ªÊñπÂºè</th>
                                  <th>Êèê‰∫§ÊôÇÈñì</th>
                                  <th>ÁãÄÊÖã</th>
                              </tr>
                          </thead>
                          <tbody id="paymentHistoryTableBody">
                              <!-- Áπ≥Ë≤ªË®òÈåÑÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£° -->
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      </div>

      <!-- Â†±Ë°® -->
      <div id="reports" class="tab-content">
          <h2>üìä Â†±Ë°®‰∏≠ÂøÉ</h2>
          
          <div style="margin-bottom: 2rem;">
              <div class="form-group">
                  <label class="form-label">ÈÅ∏ÊìáÊó•ÊúüÔºö</label>
                  <input type="date" id="reportDate" class="form-control" style="width: auto; display: inline-block;">
                  <button class="btn btn-primary" onclick="generateDailyReport()">üìà ÁîüÊàêÊó•Â†±Ë°®</button>
              </div>
          </div>

          <div id="reportContent">
              <!-- Â†±Ë°®ÂÖßÂÆπÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£° -->
          </div>

          <div style="margin-top: 2rem;">
              <button class="btn btn-secondary" onclick="exportAllData()">üì§ ÂåØÂá∫ÊâÄÊúâË≥áÊñô</button>
              <button class="btn btn-warning" onclick="cleanupTestData()">üßπ Ê∏ÖÁêÜÊ∏¨Ë©¶Ë≥áÊñô</button>
          </div>
      </div>

      <!-- Á≥ªÁµ±Ë®≠ÂÆö -->
      <div id="settings" class="tab-content">
          <h2>‚öôÔ∏è Á≥ªÁµ±Ë®≠ÂÆö</h2>
          
          <div style="margin-bottom: 2rem;">
              <h3>üîß Á≥ªÁµ±Á∂≠Ë≠∑</h3>
              <button class="btn btn-primary" onclick="initializeSystem()">üöÄ ÂàùÂßãÂåñÁ≥ªÁµ±</button>
              <button class="btn btn-secondary" onclick="setupTriggers()">‚è∞ Ë®≠ÂÆöËß∏ÁôºÂô®</button>
              <button class="btn btn-warning" onclick="cleanupOldLogs()">üóëÔ∏è Ê∏ÖÁêÜËàäÊó•Ë™å</button>
              <button class="btn btn-success" onclick="checkSystemHealth()">üè• Á≥ªÁµ±ÂÅ•Â∫∑Ê™¢Êü•</button>
          </div>

          <div>
              <h3>üíæ Ë≥áÊñôÂÇô‰ªΩ</h3>
              <div class="form-group">
                  <label class="form-label">ÂÇô‰ªΩË©¶ÁÆóË°® IDÔºö</label>
                  <input type="text" id="backupSpreadsheetId" class="form-control" 
                         placeholder="Ë´ãËº∏ÂÖ•ÁõÆÊ®ôË©¶ÁÆóË°®ÁöÑ ID">
                  <button class="btn btn-primary" onclick="backupData()" style="margin-top: 0.5rem;">
                      üíæ ÈñãÂßãÂÇô‰ªΩ
                  </button>
              </div>
          </div>

          <div id="systemStatus" style="margin-top: 2rem;">
              <!-- Á≥ªÁµ±ÁãÄÊÖãÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£° -->
          </div>
      </div>
  </div>

  <!-- ÂØ©Ê†∏Ê®°ÊÖãÊ°Ü -->
  <div id="reviewModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>ÂØ©Ê†∏Áπ≥Ë≤ªË®òÈåÑ</h3>
              <button class="close" onclick="closeModal('reviewModal')">&times;</button>
          </div>
          
          <div id="reviewPaymentInfo">
              <!-- Áπ≥Ë≤ªË≥áË®äÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£° -->
          </div>
          
          <div class="form-group">
              <label class="form-label">ÂØ©Ê†∏ÁµêÊûúÔºö</label>
              <select id="reviewStatus" class="form-control">
                  <option value="Â∑≤Á¢∫Ë™ç">‚úÖ ÈÄöÈÅé</option>
                  <option value="Â∑≤ÊãíÁµï">‚ùå ÊãíÁµï</option>
              </select>
          </div>
          
          <div class="form-group">
              <label class="form-label">ÂØ©Ê†∏ÂÇôË®ªÔºö</label>
              <textarea id="reviewNote" class="form-control" rows="3" 
                        placeholder="Ë´ãËº∏ÂÖ•ÂØ©Ê†∏ÂÇôË®ª..."></textarea>
          </div>
          
          <div style="text-align: right;">
              <button class="btn btn-secondary" onclick="closeModal('reviewModal')">ÂèñÊ∂à</button>
              <button class="btn btn-primary" onclick="submitReview()">Á¢∫Ë™çÂØ©Ê†∏</button>
          </div>
      </div>
  </div>

  <!-- ÊâπÈáèÂØ©Ê†∏Ê®°ÊÖãÊ°Ü -->
  <div id="batchReviewModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>ÊâπÈáèÂØ©Ê†∏</h3>
              <button class="close" onclick="closeModal('batchReviewModal')">&times;</button>
          </div>
          
          <div id="batchReviewInfo">
              <!-- ÊâπÈáèÂØ©Ê†∏Ë≥áË®äÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£° -->
          </div>
          
          <div class="form-group">
              <label class="form-label">ÂØ©Ê†∏ÂÇôË®ªÔºö</label>
              <textarea id="batchReviewNote" class="form-control" rows="3" 
                        placeholder="Ë´ãËº∏ÂÖ•ÂØ©Ê†∏ÂÇôË®ª..."></textarea>
          </div>
          
          <div style="text-align: right;">
              <button class="btn btn-secondary" onclick="closeModal('batchReviewModal')">ÂèñÊ∂à</button>
              <button class="btn btn-primary" onclick="submitBatchReview()">Á¢∫Ë™çÊâπÈáèÂØ©Ê†∏</button>
          </div>
      </div>
  </div>

  <!-- Á∑®ËºØË®ÇÂñÆÊ®°ÊÖãÊ°Ü -->
  <div id="editOrderModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="editOrderTitle">Á∑®ËºØË®ÇÂñÆ</h3>
              <button class="close" onclick="closeModal('editOrderModal')">&times;</button>
          </div>
          
          <div class="form-group">
              <label class="form-label">LINEÂêçÁ®±Ôºö</label>
              <input type="text" id="editLineName" class="form-control">
          </div>
          
          <div class="form-group">
              <label class="form-label">Áî¢ÂìÅ‰ª£ËôüÔºö</label>
              <input type="text" id="editProductCode" class="form-control">
          </div>
          
          <div class="form-group">
              <label class="form-label">Áî¢ÂìÅÂêçÁ®±Ôºö</label>
              <input type="text" id="editProductName" class="form-control">
          </div>
          
          <div class="form-group">
              <label class="form-label">Êï∏ÈáèÔºö</label>
              <input type="number" id="editQuantity" class="form-control" min="1" onchange="calculateTotal()">
          </div>
          
          <div class="form-group">
              <label class="form-label">ÂñÆÂÉπÔºö</label>
              <input type="number" id="editUnitPrice" class="form-control" min="0" step="0.01" onchange="calculateTotal()">
          </div>
          
          <div class="form-group">
              <label class="form-label">ÂêàË®àÔºö</label>
              <input type="number" id="editTotalPrice" class="form-control" readonly>
          </div>
          
          <div style="text-align: right;">
              <button class="btn btn-secondary" onclick="closeModal('editOrderModal')">ÂèñÊ∂à</button>
              <button class="btn btn-primary" onclick="saveOrder()">ÂÑ≤Â≠ò</button>
          </div>
      </div>
  </div>

  <script>
      // Ë®≠ÂÆöÂçÄÂüü
      const CONFIG = {
          LIFF_ID: '1657285806-2bmkYWkN', // Ë´ãÊõøÊèõÁÇ∫ÊÇ®ÁöÑ LIFF ID
          API_BASE_URL: 'https://script.google.com/macros/s/AKfycbwhseFb4yrYifu43nrhAz0EbAi_xsZvPYFjLZ_OK9st_kOYx3JBwxHiRg0CsCGx77cZ/exec' // Ë´ãÊõøÊèõÁÇ∫ÊÇ®ÁöÑ GAS Web App URL
      };

      // ÂÖ®ÂüüËÆäÊï∏
      let currentUser = null;
      let currentPaymentId = null;
      let currentRowIndex = null;
      let selectedPaymentIds = [];
      let batchReviewStatus = '';
      let currentMemberName = '';

      // LIFF ÂàùÂßãÂåñ
      document.addEventListener('DOMContentLoaded', function() {
          liff.init({
              liffId: CONFIG.LIFF_ID
          }).then(() => {
              if (liff.isLoggedIn()) {
                  liff.getProfile().then(profile => {
                      currentUser = {
                          userId: profile.userId,
                          displayName: profile.displayName
                      };
                      
                      document.getElementById('adminInfo').textContent = 
                          `ÁÆ°ÁêÜËÄÖÔºö${profile.displayName}`;
                      
                      // ËºâÂÖ•ÂàùÂßãË≥áÊñô
                      loadDashboard();
                      loadPendingPayments();
                      loadAllMembers();
                  });
              } else {
                  liff.login();
              }
          }).catch(err => {
              console.error('LIFF ÂàùÂßãÂåñÂ§±Êïó:', err);
              alert('Á≥ªÁµ±ÂàùÂßãÂåñÂ§±ÊïóÔºåË´ãÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢');
          });
      });

      // API ÂëºÂè´ÂáΩÊï∏
      function callAPI(action, data = {}) {
          return new Promise((resolve, reject) => {
              data.adminUserId = currentUser ? currentUser.userId : '';
              
              const url = `${CONFIG.API_BASE_URL}?action=${action}&data=${encodeURIComponent(JSON.stringify(data))}`;
              
              fetch(url)
                  .then(response => response.json())
                  .then(result => {
                      if (result.success) {
                          resolve(result);
                      } else {
                          reject(new Error(result.message || 'Êìç‰ΩúÂ§±Êïó'));
                      }
                  })
                  .catch(error => {
                      reject(error);
                  });
          });
      }

      // Ê®ôÁ±§ÂàáÊèõ
      function showTab(tabName) {
          // Èö±ËóèÊâÄÊúâÊ®ôÁ±§ÂÖßÂÆπ
          document.querySelectorAll('.tab-content').forEach(tab => {
              tab.classList.remove('active');
          });
          
          // ÁßªÈô§ÊâÄÊúâÊ®ôÁ±§ÁöÑ active ÁãÄÊÖã
          document.querySelectorAll('.nav-tab').forEach(tab => {
              tab.classList.remove('active');
          });
          
          // È°ØÁ§∫ÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§ÂÖßÂÆπ
          document.getElementById(tabName).classList.add('active');
          
          // Ë®≠ÂÆöÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§ÁÇ∫ active
          event.target.classList.add('active');
          
          // ËºâÂÖ•Â∞çÊáâÁöÑË≥áÊñô
          switch(tabName) {
              case 'dashboard':
                  loadDashboard();
                  break;
              case 'payments':
                  loadPendingPayments();
                  break;
              case 'members':
                  loadAllMembers();
                  break;
              case 'reports':
                  // Ë®≠ÂÆöÈ†êË®≠Êó•ÊúüÁÇ∫‰ªäÂ§©
                  document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
                  break;
          }
      }

      // ËºâÂÖ•ÂÑÄË°®Êùø
      function loadDashboard() {
          callAPI('admin-get-statistics')
              .then(result => {
                  const stats = result.statistics;
                  const statsGrid = document.getElementById('statsGrid');
                  
                  statsGrid.innerHTML = `
                      <div class="stat-card">
                          <div class="stat-number">${stats.totalUsers}</div>
                          <div class="stat-label">Ë®ªÂÜäÊúÉÂì°</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${stats.totalOrders}</div>
                          <div class="stat-label">Á∏ΩË®ÇÂñÆÊï∏</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${stats.totalPayments}</div>
                          <div class="stat-label">Áπ≥Ë≤ªË®òÈåÑ</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${stats.pendingPayments}</div>
                          <div class="stat-label">ÂæÖÂØ©Ê†∏</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${stats.approvedPayments}</div>
                          <div class="stat-label">Â∑≤Á¢∫Ë™ç</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">NT$ ${stats.totalAmount.toLocaleString()}</div>
                          <div class="stat-label">Á∏ΩÈáëÈ°ç</div>
                      </div>
                  `;
                  
                  // È°ØÁ§∫ÂæÖÂØ©Ê†∏ÊèêÈÜí
                  const pendingAlert = document.getElementById('pendingAlert');
                  const pendingCount = document.getElementById('pendingCount');
                  
                  if (stats.pendingPayments > 0) {
                      pendingCount.textContent = stats.pendingPayments;
                      pendingAlert.style.display = 'block';
                  } else {
                      pendingAlert.style.display = 'none';
                  }
              })
              .catch(error => {
                  console.error('ËºâÂÖ•Áµ±Ë®àË≥áÊñôÂ§±Êïó:', error);
                  showAlert('ËºâÂÖ•Áµ±Ë®àË≥áÊñôÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      // ËºâÂÖ•ÂæÖÂØ©Ê†∏Áπ≥Ë≤ª
      function loadPendingPayments() {
          const tbody = document.getElementById('paymentsTableBody');
          tbody.innerHTML = '<tr><td colspan="8" class="loading"><div class="spinner"></div>ËºâÂÖ•‰∏≠...</td></tr>';
          
          callAPI('admin-get-pending-payments')
              .then(result => {
                  const payments = result.payments;
                  
                  if (payments.length === 0) {
                      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">Êö´ÁÑ°ÂæÖÂØ©Ê†∏Ë®òÈåÑ</td></tr>';
                      return;
                  }
                  
                  tbody.innerHTML = payments.map(payment => `
                      <tr>
                          <td><input type="checkbox" class="payment-checkbox" value="${payment.paymentId}"></td>
                          <td>${payment.paymentId}</td>
                          <td>${payment.realName}</td>
                          <td>NT$ ${payment.paymentAmount.toLocaleString()}</td>
                          <td>${payment.paymentMethod}</td>
                          <td>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</td>
                          <td><span class="status-badge status-pending">${payment.status}</span></td>
                          <td>
                              <button class="btn btn-primary" onclick="showReviewModal('${payment.paymentId}')">ÂØ©Ê†∏</button>
                          </td>
                      </tr>
                  `).join('');
              })
              .catch(error => {
                  console.error('ËºâÂÖ•ÂæÖÂØ©Ê†∏Áπ≥Ë≤ªÂ§±Êïó:', error);
                  tbody.innerHTML = `<tr><td colspan="8" class="alert alert-danger">ËºâÂÖ•Â§±Êïó: ${error.message}</td></tr>`;
              });
      }

      // ËºâÂÖ•ÊâÄÊúâÊúÉÂì°
      function loadAllMembers() {
          const tbody = document.getElementById('membersTableBody');
          tbody.innerHTML = '<tr><td colspan="6" class="loading"><div class="spinner"></div>ËºâÂÖ•‰∏≠...</td></tr>';
          
          callAPI('admin-get-users')
              .then(result => {
                  const users = result.users;
                  
                  if (users.length === 0) {
                      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">Êö´ÁÑ°ÊúÉÂì°Ë≥áÊñô</td></tr>';
                      return;
                  }
                  
                  tbody.innerHTML = users.map(user => `
                      <tr>
                          <td>${user.lineDisplayName}</td>
                          <td>${user.realName}</td>
                          <td>${new Date(user.registeredAt).toLocaleDateString('zh-TW')}</td>
                          <td>${user.orderCount}</td>
                          <td>${user.paymentCount}</td>
                          <td><span class="status-badge status-approved">${user.status}</span></td>
                      </tr>
                  `).join('');
              })
              .catch(error => {
                  console.error('ËºâÂÖ•ÊúÉÂì°Ë≥áÊñôÂ§±Êïó:', error);
                  tbody.innerHTML = `<tr><td colspan="6" class="alert alert-danger">ËºâÂÖ•Â§±Êïó: ${error.message}</td></tr>`;
              });
      }

      // ÊêúÂ∞ãÊúÉÂì°
      function searchMembers(event) {
          const keyword = event.target.value.trim();
          const resultsDiv = document.getElementById('searchResults');
          
          if (keyword.length < 2) {
              resultsDiv.innerHTML = '';
              return;
          }
          
          if (event.key === 'Enter' || event.type === 'input') {
              callAPI('admin-search-members', { keyword: keyword })
                  .then(result => {
                      const members = result.members;
                      
                      if (members.length === 0) {
                          resultsDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">Êâæ‰∏çÂà∞Áõ∏ÈóúÊúÉÂì°</div>';
                          return;
                      }
                      
                      resultsDiv.innerHTML = members.map(member => `
                          <div class="member-item" onclick="selectMember('${member.lineName}')">
                              <div class="member-info">
                                  <div class="member-name">${member.lineName}</div>
                                  <div class="member-details">
                                      ÁúüÂØ¶ÂßìÂêç: ${member.realName} | 
                                      ${member.registeredAt ? 'Â∑≤Ë®ªÂÜä (' + new Date(member.registeredAt).toLocaleDateString('zh-TW') + ')' : 'Êú™Ë®ªÂÜä'}
                                  </div>
                              </div>
                              <div class="order-badge">${member.orderCount} Á≠ÜË®ÇÂñÆ</div>
                          </div>
                      `).join('');
                  })
                  .catch(error => {
                      console.error('ÊêúÂ∞ãÊúÉÂì°Â§±Êïó:', error);
                      resultsDiv.innerHTML = `<div class="alert alert-danger">ÊêúÂ∞ãÂ§±Êïó: ${error.message}</div>`;
                  });
          }
      }

      // ÈÅ∏ÊìáÊúÉÂì°
      function selectMember(lineName) {
          currentMemberName = lineName;
          document.getElementById('selectedMemberName').textContent = `${lineName} ÁöÑË®ÇÂñÆ`;
          
          loadMemberOrders(lineName);
          
          // Èö±ËóèÊêúÂ∞ãÁµêÊûúÔºåÈ°ØÁ§∫Ë®ÇÂñÆÂçÄÂüü
          document.getElementById('searchResults').innerHTML = '';
          document.getElementById('memberOrdersSection').style.display = 'block';
      }

      // ËºâÂÖ•ÊúÉÂì°Ë®ÇÂñÆ
      function loadMemberOrders(lineName) {
          callAPI('admin-get-member-orders', { lineName: lineName })
              .then(result => {
                  const { memberInfo, orders, payments, summary } = result;
                  
                  // È°ØÁ§∫ÊúÉÂì°Ë≥áË®ä
                  const memberInfoDiv = document.getElementById('memberInfo');
                  memberInfoDiv.innerHTML = `
                      <div class="summary-row">
                          <span>ÊúÉÂì°ÂßìÂêç:</span>
                          <span>${memberInfo ? memberInfo.realName : 'Êú™Ë®ªÂÜä'}</span>
                      </div>
                      <div class="summary-row">
                          <span>LINEÂêçÁ®±:</span>
                          <span>${lineName}</span>
                      </div>
                      ${memberInfo ? `
                      <div class="summary-row">
                          <span>Ë®ªÂÜäÊôÇÈñì:</span>
                          <span>${new Date(memberInfo.registeredAt).toLocaleString('zh-TW')}</span>
                      </div>
                      ` : ''}
                  `;
                  
                  // È°ØÁ§∫Ë®ÇÂñÆÂàóË°®
                  const tbody = document.getElementById('memberOrdersTableBody');
                  if (orders.length === 0) {
                      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">Êö´ÁÑ°Ë®ÇÂñÆË®òÈåÑ</td></tr>';
                  } else {
                      tbody.innerHTML = orders.map(order => `
                          <tr>
                              <td>${order.productCode}</td>
                              <td>${order.productName}</td>
                              <td>${order.quantity}</td>
                              <td>NT$ ${parseFloat(order.unitPrice).toLocaleString()}</td>
                              <td>NT$ ${parseFloat(order.totalPrice).toLocaleString()}</td>
                              <td>
                                  <button class="btn btn-warning" onclick="editOrder(${order.rowIndex})">Á∑®ËºØ</button>
                                  <button class="btn btn-danger" onclick="deleteOrder(${order.rowIndex})">Âà™Èô§</button>
                              </td>
                          </tr>
                      `).join('');
                  }
                  
                  // È°ØÁ§∫Ë®ÇÂñÆÊëòË¶Å
                  const summaryDiv = document.getElementById('orderSummary');
                  summaryDiv.innerHTML = `
                      <div class="summary-row">
                          <span>Ë®ÇÂñÆÈ†ÖÁõÆ:</span>
                          <span>${summary.orderCount} È†Ö</span>
                      </div>
                      <div class="summary-row summary-total">
                          <span>Á∏ΩÈáëÈ°ç:</span>
                          <span>NT$ ${summary.totalAmount.toLocaleString()}</span>
                      </div>
                  `;
                  
                  // È°ØÁ§∫Áπ≥Ë≤ªË®òÈåÑ
                  const paymentTbody = document.getElementById('paymentHistoryTableBody');
                  if (payments.length === 0) {
                      paymentTbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">Êö´ÁÑ°Áπ≥Ë≤ªË®òÈåÑ</td></tr>';
                  } else {
                      paymentTbody.innerHTML = payments.map(payment => `
                          <tr>
                              <td>${payment.paymentId}</td>
                              <td>NT$ ${parseFloat(payment.paymentAmount).toLocaleString()}</td>
                              <td>${payment.paymentMethod}</td>
                              <td>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</td>
                              <td><span class="status-badge status-${payment.status === 'Â∑≤Á¢∫Ë™ç' ? 'approved' : payment.status === 'Â∑≤ÊãíÁµï' ? 'rejected' : 'pending'}">${payment.status}</span></td>
                          </tr>
                      `).join('');
                  }
              })
              .catch(error => {
                  console.error('ËºâÂÖ•ÊúÉÂì°Ë®ÇÂñÆÂ§±Êïó:', error);
                  showAlert('ËºâÂÖ•ÊúÉÂì°Ë®ÇÂñÆÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      // Á∑®ËºØË®ÇÂñÆ
      function editOrder(rowIndex) {
          currentRowIndex = rowIndex;
          
          // ÂèñÂæóÁï∂ÂâçË®ÇÂñÆË≥áÊñô
          const row = document.querySelector(`#memberOrdersTableBody tr:nth-child(${rowIndex - 1})`);
          if (!row) return;
          
          const cells = row.cells;
          document.getElementById('editLineName').value = currentMemberName;
          document.getElementById('editProductCode').value = cells[0].textContent;
          document.getElementById('editProductName').value = cells[1].textContent;
          document.getElementById('editQuantity').value = cells[2].textContent;
          document.getElementById('editUnitPrice').value = cells[3].textContent.replace('NT$ ', '').replace(/,/g, '');
          document.getElementById('editTotalPrice').value = cells[4].textContent.replace('NT$ ', '').replace(/,/g, '');
          
          document.getElementById('editOrderTitle').textContent = 'Á∑®ËºØË®ÇÂñÆ';
          document.getElementById('editOrderModal').style.display = 'block';
      }

      // Êñ∞Â¢ûË®ÇÂñÆ
      function addNewOrder() {
          currentRowIndex = null;
          
          document.getElementById('editLineName').value = currentMemberName;
          document.getElementById('editProductCode').value = '';
          document.getElementById('editProductName').value = '';
          document.getElementById('editQuantity').value = '1';
          document.getElementById('editUnitPrice').value = '0';
          document.getElementById('editTotalPrice').value = '0';
          
          document.getElementById('editOrderTitle').textContent = 'Êñ∞Â¢ûË®ÇÂñÆ';
          document.getElementById('editOrderModal').style.display = 'block';
      }

      // Ë®àÁÆóÁ∏ΩÂÉπ
      function calculateTotal() {
          const quantity = parseFloat(document.getElementById('editQuantity').value) || 0;
          const unitPrice = parseFloat(document.getElementById('editUnitPrice').value) || 0;
          const total = quantity * unitPrice;
          document.getElementById('editTotalPrice').value = total.toFixed(2);
      }

      // ÂÑ≤Â≠òË®ÇÂñÆ
      function saveOrder() {
          const orderData = {
              lineName: document.getElementById('editLineName').value,
              productCode: document.getElementById('editProductCode').value,
              productName: document.getElementById('editProductName').value,
              quantity: parseFloat(document.getElementById('editQuantity').value),
              unitPrice: parseFloat(document.getElementById('editUnitPrice').value)
          };
          
          if (!orderData.lineName || !orderData.productCode || !orderData.productName || 
              !orderData.quantity || !orderData.unitPrice) {
              showAlert('Ë´ãÂ°´ÂØ´ÊâÄÊúâÂøÖË¶ÅÊ¨Ñ‰Ωç', 'warning');
              return;
          }
          
          const action = currentRowIndex ? 'admin-update-member-order' : 'admin-add-member-order';
          const data = currentRowIndex ? 
              { rowIndex: currentRowIndex, orderData: orderData } : 
              { orderData: orderData };
          
          callAPI(action, data)
              .then(result => {
                  showAlert(result.message, 'success');
                  closeModal('editOrderModal');
                  loadMemberOrders(currentMemberName);
              })
              .catch(error => {
                  console.error('ÂÑ≤Â≠òË®ÇÂñÆÂ§±Êïó:', error);
                  showAlert('ÂÑ≤Â≠òË®ÇÂñÆÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      // Âà™Èô§Ë®ÇÂñÆ
      function deleteOrder(rowIndex) {
          if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜË®ÇÂñÆÂóéÔºü')) return;
          
          callAPI('admin-delete-member-order', { rowIndex: rowIndex })
              .then(result => {
                  showAlert(result.message, 'success');
                  loadMemberOrders(currentMemberName);
              })
              .catch(error => {
                  console.error('Âà™Èô§Ë®ÇÂñÆÂ§±Êïó:', error);
                  showAlert('Âà™Èô§Ë®ÇÂñÆÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      // È°ØÁ§∫ÂØ©Ê†∏Ê®°ÊÖãÊ°Ü
      function showReviewModal(paymentId) {
          currentPaymentId = paymentId;
          
          // ÂèñÂæóÁπ≥Ë≤ªË©≥Á¥∞Ë≥áË®ä
          callAPI('admin-get-all-payments')
              .then(result => {
                  const payment = result.payments.find(p => p.paymentId === paymentId);
                  if (!payment) {
                      showAlert('Êâæ‰∏çÂà∞Áπ≥Ë≤ªË®òÈåÑ', 'danger');
                      return;
                  }
                  
                  document.getElementById('reviewPaymentInfo').innerHTML = `
                      <div class="order-summary">
                          <div class="summary-row">
                              <span>Áπ≥Ë≤ªÁ∑®Ëôü:</span>
                              <span>${payment.paymentId}</span>
                          </div>
                          <div class="summary-row">
                              <span>ÊúÉÂì°ÂßìÂêç:</span>
                              <span>${payment.realName}</span>
                          </div>
                          <div class="summary-row">
                              <span>Áπ≥Ë≤ªÈáëÈ°ç:</span>
                              <span>NT$ ${parseFloat(payment.paymentAmount).toLocaleString()}</span>
                          </div>
                          <div class="summary-row">
                              <span>Áπ≥Ë≤ªÊñπÂºè:</span>
                              <span>${payment.paymentMethod}</span>
                          </div>
                          <div class="summary-row">
                              <span>Êèê‰∫§ÊôÇÈñì:</span>
                              <span>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</span>
                          </div>
                          ${payment.paymentNote ? `
                          <div class="summary-row">
                              <span>Áî®Êà∂ÂÇôË®ª:</span>
                              <span>${payment.paymentNote}</span>
                          </div>
                          ` : ''}
                      </div>
                  `;
                  
                  document.getElementById('reviewStatus').value = 'Â∑≤Á¢∫Ë™ç';
                  document.getElementById('reviewNote').value = '';
                  document.getElementById('reviewModal').style.display = 'block';
              })
              .catch(error => {
                  console.error('ËºâÂÖ•Áπ≥Ë≤ªË©≥ÊÉÖÂ§±Êïó:', error);
                  showAlert('ËºâÂÖ•Áπ≥Ë≤ªË©≥ÊÉÖÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      // Êèê‰∫§ÂØ©Ê†∏
      function submitReview() {
          const status = document.getElementById('reviewStatus').value;
          const reviewNote = document.getElementById('reviewNote').value;
          
          callAPI('admin-review-payment', {
              paymentId: currentPaymentId,
              status: status,
              reviewNote: reviewNote
          })
              .then(result => {
                  showAlert(result.message, 'success');
                  closeModal('reviewModal');
                  loadPendingPayments();
                  loadDashboard();
              })
              .catch(error => {
                  console.error('ÂØ©Ê†∏Â§±Êïó:', error);
                  showAlert('ÂØ©Ê†∏Â§±Êïó: ' + error.message, 'danger');
              });
      }

      // ÂÖ®ÈÅ∏/ÂèñÊ∂àÂÖ®ÈÅ∏
      function toggleSelectAll() {
          const selectAll = document.getElementById('selectAll');
          const checkboxes = document.querySelectorAll('.payment-checkbox');
          
          checkboxes.forEach(checkbox => {
              checkbox.checked = selectAll.checked;
          });
          
          updateSelectedPayments();
      }

      // Êõ¥Êñ∞ÈÅ∏‰∏≠ÁöÑÁπ≥Ë≤ªË®òÈåÑ
      function updateSelectedPayments() {
          selectedPaymentIds = Array.from(document.querySelectorAll('.payment-checkbox:checked'))
              .map(checkbox => checkbox.value);
      }

      // È°ØÁ§∫ÊâπÈáèÂØ©Ê†∏
      function showBatchReview(status) {
          updateSelectedPayments();
          
          if (selectedPaymentIds.length === 0) {
              showAlert('Ë´ãÂÖàÈÅ∏ÊìáË¶ÅÂØ©Ê†∏ÁöÑË®òÈåÑ', 'warning');
              return;
          }
          
          batchReviewStatus = status;
          
          document.getElementById('batchReviewInfo').innerHTML = `
              <div class="alert alert-warning">
                  <strong>ÊâπÈáèÂØ©Ê†∏Á¢∫Ë™ç</strong><br>
                  ÊÇ®Âç≥Â∞áÂ∞á <strong>${selectedPaymentIds.length}</strong> Á≠ÜÁπ≥Ë≤ªË®òÈåÑÊ®ôË®òÁÇ∫ <strong>${status}</strong>
              </div>
          `;
          
          document.getElementById('batchReviewNote').value = '';
          document.getElementById('batchReviewModal').style.display = 'block';
      }

      // Êèê‰∫§ÊâπÈáèÂØ©Ê†∏
      function submitBatchReview() {
          const reviewNote = document.getElementById('batchReviewNote').value;
          
          callAPI('admin-batch-review', {
              paymentIds: selectedPaymentIds,
              status: batchReviewStatus,
              reviewNote: reviewNote
          })
              .then(result => {
                  showAlert(result.message, 'success');
                  closeModal('batchReviewModal');
                  loadPendingPayments();
                  loadDashboard();
                  
                  // Ê∏ÖÈô§ÈÅ∏Êìá
                  document.getElementById('selectAll').checked = false;
                  selectedPaymentIds = [];
              })
              .catch(error => {
                  console.error('ÊâπÈáèÂØ©Ê†∏Â§±Êïó:', error);
                  showAlert('ÊâπÈáèÂØ©Ê†∏Â§±Êïó: ' + error.message, 'danger');
              });
      }

      // ÁîüÊàêÊó•Â†±Ë°®
      function generateDailyReport() {
          const targetDate = document.getElementById('reportDate').value;
          if (!targetDate) {
              showAlert('Ë´ãÈÅ∏ÊìáÊó•Êúü', 'warning');
              return;
          }
          
          const reportContent = document.getElementById('reportContent');
          reportContent.innerHTML = '<div class="loading"><div class="spinner"></div>ÁîüÊàêÂ†±Ë°®‰∏≠...</div>';
          
          callAPI('admin-get-daily-report', { targetDate: targetDate })
              .then(result => {
                  const report = result.report;
                  
                  reportContent.innerHTML = `
                      <div class="order-summary">
                          <h3>üìÖ ${report.date} Êó•Â†±Ë°®</h3>
                          
                          <div class="stats-grid" style="margin: 1rem 0;">
                              <div class="stat-card">
                                  <div class="stat-number">${report.newRegistrations}</div>
                                  <div class="stat-label">Êñ∞Ë®ªÂÜäÊúÉÂì°</div>
                              </div>
                              <div class="stat-card">
                                  <div class="stat-number">${report.newPayments}</div>
                                  <div class="stat-label">Êñ∞Áπ≥Ë≤ªË®òÈåÑ</div>
                              </div>
                              <div class="stat-card">
                                  <div class="stat-number">${report.approvedPayments}</div>
                                  <div class="stat-label">ÂØ©Ê†∏ÈÄöÈÅé</div>
                              </div>
                              <div class="stat-card">
                                  <div class="stat-number">NT$ ${report.totalAmount.toLocaleString()}</div>
                                  <div class="stat-label">Á¢∫Ë™çÈáëÈ°ç</div>
                              </div>
                          </div>
                          
                          ${report.details.registrations.length > 0 ? `
                          <h4>üÜï Êñ∞Ë®ªÂÜäÊúÉÂì°</h4>
                          <div class="table-container">
                              <table>
                                  <thead>
                                      <tr><th>ÁúüÂØ¶ÂßìÂêç</th><th>LINEÂêçÁ®±</th><th>Ë®ªÂÜäÊôÇÈñì</th></tr>
                                  </thead>
                                  <tbody>
                                      ${report.details.registrations.map(reg => `
                                          <tr>
                                              <td>${reg.realName}</td>
                                              <td>${reg.lineDisplayName}</td>
                                              <td>${new Date(reg.registeredAt).toLocaleString('zh-TW')}</td>
                                          </tr>
                                      `).join('')}
                                  </tbody>
                              </table>
                          </div>
                          ` : ''}
                          
                          ${report.details.approvedPayments.length > 0 ? `
                          <h4>‚úÖ ÂØ©Ê†∏ÈÄöÈÅéÁπ≥Ë≤ª</h4>
                          <div class="table-container">
                              <table>
                                  <thead>
                                      <tr><th>Áπ≥Ë≤ªÁ∑®Ëôü</th><th>ÊúÉÂì°ÂßìÂêç</th><th>ÈáëÈ°ç</th></tr>
                                  </thead>
                                  <tbody>
                                      ${report.details.approvedPayments.map(payment => `
                                          <tr>
                                              <td>${payment.paymentId}</td>
                                              <td>${payment.realName}</td>
                                              <td>NT$ ${parseFloat(payment.paymentAmount).toLocaleString()}</td>
                                          </tr>
                                      `).join('')}
                                  </tbody>
                              </table>
                          </div>
                          ` : ''}
                      </div>
                  `;
              })
              .catch(error => {
                  console.error('ÁîüÊàêÊó•Â†±Ë°®Â§±Êïó:', error);
                  reportContent.innerHTML = `<div class="alert alert-danger">ÁîüÊàêÂ†±Ë°®Â§±Êïó: ${error.message}</div>`;
              });
      }

      // ÂåØÂá∫ÊâÄÊúâË≥áÊñô
      function exportAllData() {
          callAPI('admin-export-data')
              .then(result => {
                  const dataStr = JSON.stringify(result.data, null, 2);
                  const dataBlob = new Blob([dataStr], {type: 'application/json'});
                  const url = URL.createObjectURL(dataBlob);
                  const link = document.createElement('a');
                  link.href = url;
                  link.download = `system_export_${new Date().toISOString().split('T')[0]}.json`;
                  link.click();
                  URL.revokeObjectURL(url);
                  
                  showAlert('Ë≥áÊñôÂåØÂá∫ÊàêÂäü', 'success');
              })
              .catch(error => {
                  console.error('ÂåØÂá∫Ë≥áÊñôÂ§±Êïó:', error);
                  showAlert('ÂåØÂá∫Ë≥áÊñôÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      // Ê∏ÖÁêÜÊ∏¨Ë©¶Ë≥áÊñô
      function cleanupTestData() {
          if (!confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁêÜÊâÄÊúâÊ∏¨Ë©¶Ë≥áÊñôÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ')) return;
          
          callAPI('admin-cleanup-test-data')
              .then(result => {
                  showAlert(result.message, 'success');
                  loadDashboard();
              })
              .catch(error => {
                  console.error('Ê∏ÖÁêÜÊ∏¨Ë©¶Ë≥áÊñôÂ§±Êïó:', error);
                  showAlert('Ê∏ÖÁêÜÊ∏¨Ë©¶Ë≥áÊñôÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      // Á≥ªÁµ±Á∂≠Ë≠∑ÂäüËÉΩ
      function initializeSystem() {
          callAPI('admin-initialize-system')
              .then(result => {
                  showAlert(result.message, 'success');
                  updateSystemStatus(result.details);
              })
              .catch(error => {
                  console.error('Á≥ªÁµ±ÂàùÂßãÂåñÂ§±Êïó:', error);
                  showAlert('Á≥ªÁµ±ÂàùÂßãÂåñÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      function setupTriggers() {
          callAPI('admin-setup-triggers')
              .then(result => {
                  showAlert(result.message, 'success');
              })
              .catch(error => {
                  console.error('Ë®≠ÂÆöËß∏ÁôºÂô®Â§±Êïó:', error);
                  showAlert('Ë®≠ÂÆöËß∏ÁôºÂô®Â§±Êïó: ' + error.message, 'danger');
              });
      }

      function cleanupOldLogs() {
          callAPI('admin-cleanup-old-logs')
              .then(result => {
                  showAlert(result.message, 'success');
              })
              .catch(error => {
                  console.error('Ê∏ÖÁêÜÊó•Ë™åÂ§±Êïó:', error);
                  showAlert('Ê∏ÖÁêÜÊó•Ë™åÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      function checkSystemHealth() {
          callAPI('admin-check-system-health')
              .then(result => {
                  updateSystemStatus([`Á≥ªÁµ±ÁãÄÊÖã: ${result.health.status}`]);
                  showAlert('Á≥ªÁµ±ÂÅ•Â∫∑Ê™¢Êü•ÂÆåÊàê', 'success');
              })
              .catch(error => {
                  console.error('Á≥ªÁµ±ÂÅ•Â∫∑Ê™¢Êü•Â§±Êïó:', error);
                  showAlert('Á≥ªÁµ±ÂÅ•Â∫∑Ê™¢Êü•Â§±Êïó: ' + error.message, 'danger');
              });
      }

      function backupData() {
          const backupSpreadsheetId = document.getElementById('backupSpreadsheetId').value.trim();
          if (!backupSpreadsheetId) {
              showAlert('Ë´ãËº∏ÂÖ•ÂÇô‰ªΩË©¶ÁÆóË°® ID', 'warning');
              return;
          }
          
          callAPI('admin-backup-data', { backupSpreadsheetId: backupSpreadsheetId })
              .then(result => {
                  showAlert(result.message, 'success');
              })
              .catch(error => {
                  console.error('ÂÇô‰ªΩË≥áÊñôÂ§±Êïó:', error);
                  showAlert('ÂÇô‰ªΩË≥áÊñôÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      // Êõ¥Êñ∞Á≥ªÁµ±ÁãÄÊÖãÈ°ØÁ§∫
      function updateSystemStatus(details) {
          const statusDiv = document.getElementById('systemStatus');
          statusDiv.innerHTML = `
              <div class="alert alert-success">
                  <h4>Á≥ªÁµ±ÁãÄÊÖã</h4>
                  <ul>
                      ${details.map(detail => `<li>${detail}</li>`).join('')}
                  </ul>
              </div>
          `;
      }

      // Â∑•ÂÖ∑ÂáΩÊï∏
      function closeModal(modalId) {
          document.getElementById(modalId).style.display = 'none';
      }

      function showAlert(message, type = 'info') {
          const alertDiv = document.createElement('div');
          alertDiv.className = `alert alert-${type}`;
          alertDiv.textContent = message;
          alertDiv.style.position = 'fixed';
          alertDiv.style.top = '20px';
          alertDiv.style.right = '20px';
          alertDiv.style.zIndex = '9999';
          alertDiv.style.minWidth = '300px';
          
          document.body.appendChild(alertDiv);
          
          setTimeout(() => {
              alertDiv.remove();
          }, 5000);
      }

      // ÈªûÊìäÊ®°ÊÖãÊ°ÜÂ§ñÈÉ®ÈóúÈñâ
      window.onclick = function(event) {
          const modals = document.querySelectorAll('.modal');
          modals.forEach(modal => {
              if (event.target === modal) {
                  modal.style.display = 'none';
              }
          });
      }

      // Áõ£ËÅΩË§áÈÅ∏Ê°ÜËÆäÂåñ
      document.addEventListener('change', function(event) {
          if (event.target.classList.contains('payment-checkbox')) {
              updateSelectedPayments();
          }
      });
  </script>
</body>
</html>Ë®ÇË≥ºÁÆ°ÁêÜÁ≥ªÁµ± v2.0</title>
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', sans-serif;
        background: linear-gradient(135deg, #00B900, #00D300);
        min-height: 100vh;
        padding: 15px;
        line-height: 1.6;
    }
    
    .container {
        max-width: 420px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        overflow: hidden;
        animation: slideUp 0.5s ease-out;
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .header {
        background: linear-gradient(45deg, #00B900, #00D300);
        color: white;
        padding: 30px 20px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    .header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: repeating-linear-gradient(
            45deg,
            transparent,
            transparent 10px,
            rgba(255,255,255,0.1) 10px,
            rgba(255,255,255,0.1) 20px
        );
        animation: shimmer 3s linear infinite;
    }
    
    @keyframes shimmer {
        0% { transform: translateX(-100%) translateY(-100%); }
        100% { transform: translateX(100%) translateY(100%); }
    }
    
    .header h1 {
        font-size: 24px;
        margin-bottom: 8px;
        position: relative;
        z-index: 1;
    }
    
    .header p {
        opacity: 0.9;
        font-size: 14px;
        position: relative;
        z-index: 1;
    }
    
    .content {
        padding: 25px 20px;
    }
    
    .tab-buttons {
        display: flex;
        margin-bottom: 25px;
        border-radius: 12px;
        overflow: hidden;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
    }
    
    .tab-button {
        flex: 1;
        padding: 12px 8px;
        text-align: center;
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: all 0.3s ease;
        color: #6c757d;
        position: relative;
    }
    
    .tab-button.active {
        background: #00B900;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 185, 0, 0.3);
    }
    
    .tab-button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none;
    }
    
    .tab-button::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 0;
        height: 2px;
        background: #00B900;
        transition: all 0.3s ease;
        transform: translateX(-50%);
    }
    
    .tab-button.active::after {
        width: 80%;
    }
    
    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease-in;
    }
    
    .tab-content.active {
        display: block;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        font-size: 14px;
    }
    
    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: #fff;
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
        outline: none;
        border-color: #00B900;
        box-shadow: 0 0 0 3px rgba(0, 185, 0, 0.1);
        transform: translateY(-1px);
    }
    
    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }
    
    .btn {
        width: 100%;
        padding: 16px;
        background: linear-gradient(45deg, #00B900, #00D300);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }
    
    .btn:hover::before {
        left: 100%;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 185, 0, 0.3);
    }
    
    .btn:active {
        transform: translateY(0);
    }
    
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .btn.secondary {
        background: linear-gradient(45deg, #6c757d, #495057);
    }
    
    .btn.danger {
        background: linear-gradient(45deg, #dc3545, #c82333);
    }
    
    .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    
    .btn-group .btn {
        flex: 1;
    }
    
    .user-info {
        background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 25px;
        border: 1px solid #d4edda;
        position: relative;
    }
    
    .user-info::before {
        content: 'üë§';
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 24px;
        opacity: 0.3;
    }
    
    .user-info h3 {
        color: #00B900;
        margin-bottom: 15px;
        font-size: 18px;
    }
    
    .profile-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin: 0 auto 15px;
        display: block;
        border: 3px solid #00B900;
        box-shadow: 0 4px 12px rgba(0, 185, 0, 0.2);
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid rgba(0, 185, 0, 0.1);
        font-size: 14px;
    }
    
    .info-item:last-child {
        border-bottom: none;
    }
    
    .info-label {
        font-weight: 600;
        color: #155724;
        min-width: 80px;
    }
    
    .info-value {
        color: #333;
        text-align: right;
        word-break: break-all;
        max-width: 200px;
    }
    
    .welcome-message, .registered-info {
        background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 25px;
        border: 1px solid #d4edda;
        position: relative;
    }
    
    .welcome-message::before {
        content: 'üëã';
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 24px;
    }
    
    .registered-info::before {
        content: '‚úÖ';
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 24px;
    }
    
    .welcome-message h3, .registered-info h3 {
        color: #00B900;
        margin-bottom: 10px;
        font-size: 18px;
    }
    
    .welcome-message p, .registered-info p {
        color: #155724;
        font-size: 14px;
        line-height: 1.5;
    }
    
    .order-summary {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        border-left: 5px solid #ffc107;
        position: relative;
    }
    
    .order-summary::before {
        content: 'üìã';
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 24px;
    }
    
    .order-summary h3 {
        color: #856404;
        margin-bottom: 15px;
        font-size: 18px;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(133, 100, 4, 0.2);
        font-size: 14px;
    }
    
    .summary-item:last-child {
        border-bottom: none;
        font-weight: bold;
        font-size: 16px;
        color: #856404;
        margin-top: 10px;
        padding-top: 15px;
        border-top: 2px solid rgba(133, 100, 4, 0.3);
    }
    
    .product-list {
        background: #f8f9fa;
        padding: 18px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid #e9ecef;
    }
    
    .product-list h4 {
        color: #495057;
        margin-bottom: 15px;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .product-list h4::before {
        content: 'üì¶';
    }
    
    .product-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 12px 0;
        border-bottom: 1px solid #e9ecef;
        font-size: 14px;
    }
    
    .product-item:last-child {
        border-bottom: none;
    }
    
    .product-info {
        flex: 1;
    }
    
    .product-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }
    
    .product-code {
        font-size: 12px;
        color: #6c757d;
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 4px;
        display: inline-block;
    }
    
    .product-details {
        text-align: right;
        color: #495057;
        min-width: 100px;
    }
    
    .product-price {
        font-weight: 600;
        color: #00B900;
    }
    
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 40px 20px;
        color: #6c757d;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #00B900;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .error, .success, .warning, .info {
        padding: 15px 18px;
        border-radius: 12px;
        margin-bottom: 20px;
        font-size: 14px;
        font-weight: 500;
        position: relative;
        animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .error {
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        color: #721c24;
        border-left: 4px solid #dc3545;
    }
    
    .success {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        color: #155724;
        border-left: 4px solid #28a745;
    }
    
    .warning {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        color: #856404;
        border-left: 4px solid #ffc107;
    }
    
    .info {
        background: linear-gradient(135deg, #d1ecf1, #bee5eb);
        color: #0c5460;
        border-left: 4px solid #17a2b8;
    }
    
    .lock-message {
        text-align: center;
        padding: 50px 20px;
        color: #6c757d;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 15px;
        margin: 20px 0;
        border: 2px dashed #dee2e6;
    }
    
    .lock-icon {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    .lock-message h3 {
        margin-bottom: 10px;
        color: #495057;
    }
    
    .payment-status {
        margin-top: 20px;
    }
    
    .payment-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 10px;
        border-left: 4px solid #6c757d;
    }
    
    .payment-item.pending {
        border-left-color: #ffc107;
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    }
    
    .payment-item.approved {
        border-left-color: #28a745;
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
    }
    
    .payment-item.rejected {
        border-left-color: #dc3545;
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-pending {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-approved {
        background: #d4edda;
        color: #155724;
    }
    
    .status-rejected {
        background: #f8d7da;
        color: #721c24;
    }
    
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        z-index: 1000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        max-width: 300px;
        word-wrap: break-word;
    }
    
    /* ÈüøÊáâÂºèË®≠Ë®à */
    @media (max-width: 480px) {
        body {
            padding: 10px;
        }
        
        .container {
            border-radius: 15px;
        }
        
        .header {
            padding: 25px 15px;
        }
        
        .content {
            padding: 20px 15px;
        }
        
        .btn-group {
            flex-direction: column;
        }
        
        .btn-group .btn {
            margin-bottom: 10px;
        }
        
        .tab-button {
            font-size: 12px;
            padding: 10px 6px;
        }
        
        .toast {
            right: 10px;
            left: 10px;
            max-width: none;
            transform: translateY(-100%);
        }
        
        .toast.show {
            transform: translateY(0);
        }
    }
    
    /* Ê∑±Ëâ≤Ê®°ÂºèÊîØÊè¥ */
    @media (prefers-color-scheme: dark) {
        body {
            background: linear-gradient(135deg, #1a5d1a, #2d8f2d);
        }
        
        .container {
            background: #2d2d2d;
            color: #ffffff;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            background: #404040;
            color: #ffffff;
            border-color: #555555;
        }
        
        .product-list {
            background: #404040;
            border-color: #555555;
        }
        
        .tab-buttons {
            background: #404040;
            border-color: #555555;
        }
        
        .lock-message {
            background: linear-gradient(135deg, #404040, #555555);
            border-color: #666666;
            color: #cccccc;
        }
    }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üõí Ë®ÇË≥ºÁÆ°ÁêÜÁ≥ªÁµ±</h1>
        <p>ÂØ¶ÂêçÂà∂ÁôªË®ò ¬∑ Ë®ÇÂñÆÊü•Ë©¢ ¬∑ Áπ≥Ë≤ªÂõûÂ†±</p>
    </div>
    
    <div class="content">
        <!-- Áî®Êà∂Ë≥áË®äÈ°ØÁ§∫ -->
        <div id="userInfo" class="user-info" style="display: none;">
            <h3>Áî®Êà∂Ë≥áË®ä</h3>
            <img id="userAvatar" class="profile-avatar" style="display: none;">
            <div id="userDetails"></div>
        </div>
        
        <!-- Ê®ôÁ±§È†ÅÊåâÈàï -->
        <div class="tab-buttons">
            <button class="tab-button active" onclick="switchTab('register', event)">ÂØ¶ÂêçÁôªË®ò</button>
            <button class="tab-button" id="ordersTab" onclick="switchTab('orders', event)" disabled>ÊàëÁöÑË®ÇÂñÆ</button>
            <button class="tab-button" id="paymentTab" onclick="switchTab('payment', event)" disabled>Áπ≥Ë≤ªÂõûÂ†±</button>
            <button class="tab-button" id="statusTab" onclick="switchTab('status', event)" disabled>Áπ≥Ë≤ªÁãÄÊÖã</button>
        </div>
        
        <!-- ÂØ¶ÂêçÂà∂ÁôªË®ò -->
        <div id="register" class="tab-content active">
            <!-- Êú™Ë®ªÂÜäÁãÄÊÖã -->
            <div id="registerForm" style="display: none;">
                <div class="welcome-message">
                    <h3>Ê≠°Ëøé‰ΩøÁî®Ë®ÇË≥ºÁ≥ªÁµ±</h3>
                    <p>Ë´ãÂÖàÂÆåÊàêÂØ¶ÂêçÂà∂ÁôªË®òÔºåÂç≥ÂèØÊü•Ë©¢Ë®ÇÂñÆÂèäÈÄ≤Ë°åÁπ≥Ë≤ªÂõûÂ†±„ÄÇÊàëÂÄëÊúÉ‰øùË≠∑ÊÇ®ÁöÑÂÄã‰∫∫Ë≥áÊñôÂÆâÂÖ®„ÄÇ</p>
                </div>
                
                <h2 style="margin-bottom: 20px; color: #333;">üìù ÂØ¶ÂêçÂà∂ÁôªË®ò</h2>
                <form id="nameForm">
                    <div class="form-group">
                        <label for="realNameInput">ÁúüÂØ¶ÂßìÂêç *</label>
                        <input type="text" id="realNameInput" name="realName" required 
                               placeholder="Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÁúüÂØ¶ÂßìÂêç" maxlength="20">
                        <small style="color: #6c757d; font-size: 12px;">Ë´ãËº∏ÂÖ•2-20ÂÄãÂ≠óÁöÑÁúüÂØ¶ÂßìÂêç</small>
                    </div>
                    
                    <button type="submit" class="btn" id="registerSubmitBtn">
                        <span>ÂÆåÊàêÁôªË®ò</span>
                    </button>
                </form>
            </div>
            
            <!-- Â∑≤Ë®ªÂÜäÁãÄÊÖã -->
            <div id="registeredStatus" style="display: none;">
                <div class="registered-info">
                    <h3>ÂØ¶ÂêçÂà∂ÁôªË®òÂÆåÊàê</h3>
                    <p>ÊÇ®Â∑≤ÂÆåÊàêÂØ¶ÂêçÂà∂ÁôªË®òÔºåÂèØ‰ª•‰ΩøÁî®ÊâÄÊúâÂäüËÉΩ„ÄÇÊÑüË¨ùÊÇ®ÁöÑÈÖçÂêàÔºÅ</p>
                </div>
                
                <div class="btn-group">
                    <button class="btn" onclick="switchTab('orders', event)">Êü•ÁúãÊàëÁöÑË®ÇÂñÆ</button>
                    <button class="btn secondary" onclick="switchTab('payment', event)">ÈÄ≤Ë°åÁπ≥Ë≤ªÂõûÂ†±</button>
                </div>
            </div>
        </div>
        
        <!-- Ë®ÇÂñÆÊü•Ë©¢ -->
        <div id="orders" class="tab-content">
            <div id="ordersContent">
                <div class="lock-message">
                    <div class="lock-icon">üîí</div>
                    <h3>Ë´ãÂÖàÂÆåÊàêÂØ¶ÂêçÂà∂ÁôªË®ò</h3>
                    <p>ÂÆåÊàêÁôªË®òÂæåÂç≥ÂèØÊü•Ë©¢ÊÇ®ÁöÑË®ÇÂñÆË≥áË®ä</p>
                </div>
            </div>
        </div>
        
        <!-- Áπ≥Ë≤ªÂõûÂ†± -->
        <div id="payment" class="tab-content">
            <div id="paymentContent">
                <div class="lock-message">
                    <div class="lock-icon">üîí</div>
                    <h3>Ë´ãÂÖàÂÆåÊàêÂØ¶ÂêçÂà∂ÁôªË®ò</h3>
                    <p>ÂÆåÊàêÁôªË®òÂæåÂç≥ÂèØÈÄ≤Ë°åÁπ≥Ë≤ªÂõûÂ†±</p>
                </div>
            </div>
        </div>
        
        <!-- Áπ≥Ë≤ªÁãÄÊÖã -->
        <div id="status" class="tab-content">
            <div id="statusContent">
                <div class="lock-message">
                    <div class="lock-icon">üîí</div>
                    <h3>Ë´ãÂÖàÂÆåÊàêÂØ¶ÂêçÂà∂ÁôªË®ò</h3>
                    <p>ÂÆåÊàêÁôªË®òÂæåÂç≥ÂèØÊü•ÁúãÁπ≥Ë≤ªÁãÄÊÖã</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Ë®≠ÂÆöÂçÄÂüü - Ë´ã‰øÆÊîπÁÇ∫ÊÇ®ÁöÑÂØ¶ÈöõÂÄº
    const CONFIG = {
        LIFF_ID: '1657285806-2bmkYWkN', // Ë´ãÊõøÊèõÁÇ∫ÂØ¶ÈöõÁöÑ LIFF ID
        API_BASE_URL: 'https://script.google.com/macros/s/AKfycbyIL2QSFaU-T91GNgPa5VwvoqzJR21MJfCjbtpgU8xeW0l7p7POCsuTmMWlfmDDPtHH/exec', // Ë´ãÊõøÊèõÁÇ∫ GAS ÈÉ®ÁΩ≤Á∂≤ÂùÄ
        DEBUG_MODE: true, // ÈñãÁôºÊôÇË®≠ÁÇ∫ trueÔºåÊ≠£ÂºèÁí∞Â¢ÉË®≠ÁÇ∫ false
        MAX_RETRY_COUNT: 3,
        RETRY_DELAY: 1000
    };

    // ÂÖ®ÂüüËÆäÊï∏
    let userId = null;
    let userProfile = null;
    let liffContext = null;
    let liffEnvironment = null;
    let isRegistered = false;
    let userRegistrationData = null;
    let currentOrderSummary = null;
    let apiConnected = false;

    // Èô§ÈåØÂáΩÊï∏
    function debugLog(message, data = null) {
        if (CONFIG.DEBUG_MODE) {
            console.log(`[DEBUG] ${message}`, data || '');
        }
    }

    // UI ÁÆ°ÁêÜÈ°ûÂà•
    class UIManager {
        static showLoading(elementId, message = 'ËºâÂÖ•‰∏≠...') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <p>${message}</p>
                    </div>
                `;
            }
        }
        
        static hideLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = '';
            }
        }
        
        static showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#17a2b8'
            };
            toast.style.backgroundColor = colors[type] || colors.info;
            
            document.body.appendChild(toast);
            
            // È°ØÁ§∫ÂãïÁï´
            setTimeout(() => {
                toast.style.transform = window.innerWidth <= 480 ? 'translateY(0)' : 'translateX(0)';
                toast.classList.add('show');
            }, 100);
            
            // Ëá™ÂãïÁßªÈô§
            setTimeout(() => {
                toast.style.transform = window.innerWidth <= 480 ? 'translateY(-100%)' : 'translateX(100%)';
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }
    }

    // Ë°®ÂñÆÈ©óË≠âÈ°ûÂà•
    class FormValidator {
        static validateRealName(name) {
            if (!name || name.trim().length < 2) {
                return { valid: false, message: 'Ë´ãËº∏ÂÖ•Ëá≥Â∞ë2ÂÄãÂ≠óÁöÑÁúüÂØ¶ÂßìÂêç' };
            }
            
            if (name.length > 20) {
                return { valid: false, message: 'ÂßìÂêçÈï∑Â∫¶‰∏çËÉΩË∂ÖÈÅé20ÂÄãÂ≠ó' };
            }
            
            const invalidChars = /[<>\"'&]/;
            if (invalidChars.test(name)) {
                return { valid: false, message: 'ÂßìÂêç‰∏çËÉΩÂåÖÂê´ÁâπÊÆäÂ≠óÁ¨¶' };
            }
            
            return { valid: true };
        }
        
        static validatePaymentNote(note) {
            if (note && note.length > 200) {
                return { valid: false, message: 'ÂÇôË®ªÈï∑Â∫¶‰∏çËÉΩË∂ÖÈÅé200ÂÄãÂ≠ó' };
            }
            
            return { valid: true };
        }
    }

    // ÂàùÂßãÂåñ LIFF
    window.onload = function() {
        debugLog('ÈñãÂßãÂàùÂßãÂåñÊáâÁî®Á®ãÂºè');
        initializeLiff();
    };

    async function initializeLiff() {
        try {
            debugLog('LIFF ÂàùÂßãÂåñ‰∏≠...', { liffId: CONFIG.LIFF_ID });
            
            await liff.init({ liffId: CONFIG.LIFF_ID });
            debugLog('LIFF ÂàùÂßãÂåñÊàêÂäü');
            
            await collectLiffEnvironmentInfo();
            
            if (liff.isLoggedIn()) {
                debugLog('Áî®Êà∂Â∑≤ÁôªÂÖ•');
                userProfile = await liff.getProfile();
                userId = userProfile.userId;
                
                debugLog('ÂèñÂæóÁî®Êà∂Ë≥áÊñô', {
                    userId: userId,
                    displayName: userProfile.displayName
                });
                
                displayUserInfo();
                await testApiConnection();
                await checkUserRegistration();
            } else {
                debugLog('Áî®Êà∂Êú™ÁôªÂÖ•ÔºåÂ∞éÂêëÁôªÂÖ•È†ÅÈù¢');
                liff.login();
            }
        } catch (error) {
            debugLog('LIFFÂàùÂßãÂåñÂ§±Êïó', error);
            console.error('LIFFÂàùÂßãÂåñÂ§±Êïó:', error);
            showError('Á≥ªÁµ±ÂàùÂßãÂåñÂ§±ÊïóÔºåË´ãÈáçÊñ∞ÈñãÂïü: ' + error.message);
        }
    }

    async function collectLiffEnvironmentInfo() {
        try {
            liffEnvironment = {
                version: liff.getVersion(),
                language: liff.getLanguage(),
                isInClient: liff.isInClient(),
                isLoggedIn: liff.isLoggedIn(),
                os: liff.getOS(),
                lineVersion: liff.getLineVersion()
            };

            liffContext = liff.getContext();
            
            debugLog('LIFF Áí∞Â¢ÉË≥áË®ä', liffEnvironment);
            debugLog('LIFF ‰∏ä‰∏ãÊñá', liffContext);
            
        } catch (error) {
            debugLog('Êî∂ÈõÜ LIFF Áí∞Â¢ÉË≥áË®äÂ§±Êïó', error);
            console.error('Êî∂ÈõÜ LIFF Áí∞Â¢ÉË≥áË®äÂ§±Êïó:', error);
        }
    }

    async function testApiConnection() {
        try {
            debugLog('Ê∏¨Ë©¶ API ÈÄ£Á∑ö');
            
            const testResult = await callAPIWithRetry('test', { test: true });
            
            if (testResult && testResult.success !== false) {
                debugLog('API ÈÄ£Á∑öÊ∏¨Ë©¶ÊàêÂäü', testResult);
                apiConnected = true;
            } else {
                debugLog('API ÈÄ£Á∑öÊ∏¨Ë©¶Â§±Êïó', testResult);
                apiConnected = false;
                UIManager.showToast('API ÈÄ£Á∑öÁï∞Â∏∏ÔºåÈÉ®ÂàÜÂäüËÉΩÂèØËÉΩÁÑ°Ê≥ï‰ΩøÁî®', 'warning', 5000);
            }
        } catch (error) {
            debugLog('API ÈÄ£Á∑öÊ∏¨Ë©¶Â§±Êïó', error);
            apiConnected = false;
            UIManager.showToast('ÁÑ°Ê≥ïÈÄ£Êé•Âà∞‰º∫ÊúçÂô®ÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑ö', 'error', 5000);
        }
    }

    function displayUserInfo() {
        if (!userProfile) return;
        
        const userInfoDiv = document.getElementById('userInfo');
        const userDetailsDiv = document.getElementById('userDetails');
        const userAvatar = document.getElementById('userAvatar');
        
        if (!userInfoDiv || !userDetailsDiv) return;

        if (userProfile.pictureUrl && userAvatar) {
            userAvatar.src = userProfile.pictureUrl;
            userAvatar.style.display = 'block';
            userAvatar.onerror = function() {
                this.style.display = 'none';
            };
        }

        let html = `
            <div class="info-item">
                <span class="info-label">LINE ÂêçÁ®±:</span>
                <span class="info-value">${userProfile.displayName}</span>
            </div>
        `;

        if (userProfile.statusMessage) {
            html += `
                <div class="info-item">
                    <span class="info-label">ÁãÄÊÖãË®äÊÅØ:</span>
                    <span class="info-value">${userProfile.statusMessage}</span>
                </div>
            `;
        }

        if (userRegistrationData && userRegistrationData.realName) {
            html += `
                <div class="info-item">
                    <span class="info-label">ÁúüÂØ¶ÂßìÂêç:</span>
                    <span class="info-value">${userRegistrationData.realName}</span>
                </div>
            `;
        }

        if (userRegistrationData && userRegistrationData.registeredAt) {
            const regDate = new Date(userRegistrationData.registeredAt);
            html += `
                <div class="info-item">
                    <span class="info-label">Ë®ªÂÜäÊôÇÈñì:</span>
                    <span class="info-value">${regDate.toLocaleString('zh-TW')}</span>
                </div>
            `;
        }

        userDetailsDiv.innerHTML = html;
        userInfoDiv.style.display = 'block';
    }

    async function checkUserRegistration() {
        try {
            debugLog('Ê™¢Êü•Áî®Êà∂Ë®ªÂÜäÁãÄÊÖã');
            
            const result = await callAPIWithRetry('check-registration', {
                userId: userId,
                lineDisplayName: userProfile.displayName,
                liffContext: liffContext,
                liffEnvironment: liffEnvironment,
                timestamp: new Date().toISOString()
            });
            
            if (result && result.success && result.registered) {
                debugLog('Áî®Êà∂Â∑≤Ë®ªÂÜä', result.userInfo);
                isRegistered = true;
                userRegistrationData = result.userInfo;
                
                showRegisteredStatus();
                enableAllTabs();
                displayUserInfo();
                
                UIManager.showToast('Ê≠°ËøéÂõû‰æÜÔºå' + result.userInfo.realName, 'success');
            } else {
                debugLog('Áî®Êà∂Êú™Ë®ªÂÜä');
                isRegistered = false;
                showRegistrationForm();
            }
            
        } catch (error) {
            debugLog('Ê™¢Êü•Ë®ªÂÜäÁãÄÊÖãÂ§±Êïó', error);
            console.error('Ê™¢Êü•Ë®ªÂÜäÁãÄÊÖãÂ§±Êïó:', error);
            showError('Ê™¢Êü•Ë®ªÂÜäÁãÄÊÖãÂ§±Êïó: ' + error.message);
        }
    }

    function showRegistrationForm() {
        document.getElementById('registerForm').style.display = 'block';
        document.getElementById('registeredStatus').style.display = 'none';
    }

    function showRegisteredStatus() {
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('registeredStatus').style.display = 'block';
    }

    function enableAllTabs() {
        const tabs = ['ordersTab', 'paymentTab', 'statusTab'];
        tabs.forEach(tabId => {
            const tab = document.getElementById(tabId);
            if (tab) {
                tab.disabled = false;
            }
        });
    }

    // API ÂëºÂè´ÂáΩÊï∏ÔºàÂ∏∂ÈáçË©¶Ê©üÂà∂Ôºâ
    async function callAPIWithRetry(action, data, maxRetries = CONFIG.MAX_RETRY_COUNT) {
        let lastError;
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                debugLog(`API ÂëºÂè´ÂòóË©¶ ${attempt}/${maxRetries}: ${action}`);
                
                const result = await callAPI(action, data);
                
                if (result && result.success !== false) {
                    return result;
                } else {
                    throw new Error(result?.message || 'API ÂõûÊáâÈåØË™§');
                }
            } catch (error) {
                lastError = error;
                debugLog(`API ÂëºÂè´Â§±Êïó (ÂòóË©¶ ${attempt}/${maxRetries}):`, error);
                
                if (attempt < maxRetries) {
                    const delay = CONFIG.RETRY_DELAY * Math.pow(2, attempt - 1);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        throw lastError;
    }

    // Âü∫Êú¨ API ÂëºÂè´ÂáΩÊï∏
    function callAPI(action, data) {
        return new Promise((resolve, reject) => {
            const requestData = {
                action: action,
                data: JSON.stringify(data),
                callback: 'handleAPIResponse_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
            };
            
            debugLog('API Ë´ãÊ±Ç', { action, data, callback: requestData.callback });
            
            // Âª∫Á´ã JSONP ÂõûË™øÂáΩÊï∏
            window[requestData.callback] = function(response) {
                debugLog('API ÂõûÊáâ', response);
                delete window[requestData.callback];
                resolve(response);
            };
            
            // Âª∫Á´ã script Ê®ôÁ±§
            const script = document.createElement('script');
            const params = new URLSearchParams(requestData);
            script.src = CONFIG.API_BASE_URL + '?' + params.toString();
            
            // Ë®≠ÂÆöË∂ÖÊôÇËôïÁêÜ
            const timeout = setTimeout(() => {
                delete window[requestData.callback];
                document.head.removeChild(script);
                reject(new Error('API Ë´ãÊ±ÇË∂ÖÊôÇ'));
            }, 30000);
            
            script.onload = function() {
                clearTimeout(timeout);
                document.head.removeChild(script);
            };
            
            script.onerror = function() {
                clearTimeout(timeout);
                delete window[requestData.callback];
                document.head.removeChild(script);
                reject(new Error('API Ë´ãÊ±ÇÂ§±Êïó'));
            };
            
            document.head.appendChild(script);
        });
    }

    // Ê®ôÁ±§È†ÅÂàáÊèõ
    function switchTab(tabName, event) {
        if (event) {
            event.preventDefault();
        }
        
        debugLog('ÂàáÊèõÊ®ôÁ±§È†Å', tabName);
        
        // Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅË®ªÂÜä
        if (!isRegistered && ['orders', 'payment', 'status'].includes(tabName)) {
            UIManager.showToast('Ë´ãÂÖàÂÆåÊàêÂØ¶ÂêçÂà∂ÁôªË®ò', 'warning');
            return;
        }
        
        // Èö±ËóèÊâÄÊúâÊ®ôÁ±§ÂÖßÂÆπ
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => {
            content.classList.remove('active');
        });
        
        // ÁßªÈô§ÊâÄÊúâÊåâÈàïÁöÑ active ÁãÄÊÖã
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => {
            button.classList.remove('active');
        });
        
        // È°ØÁ§∫ÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§ÂÖßÂÆπ
        const selectedTab = document.getElementById(tabName);
        if (selectedTab) {
            selectedTab.classList.add('active');
        }
        
        // Ë®≠ÂÆöÂ∞çÊáâÊåâÈàïÁÇ∫ active
        if (event && event.target) {
            event.target.classList.add('active');
        }
        
        // ËºâÂÖ•Â∞çÊáâÂÖßÂÆπ
        loadTabContent(tabName);
    }

    async function loadTabContent(tabName) {
        switch (tabName) {
            case 'orders':
                await loadOrdersContent();
                break;
            case 'payment':
                await loadPaymentContent();
                break;
            case 'status':
                await loadStatusContent();
                break;
        }
    }

    async function loadOrdersContent() {
        if (!isRegistered || !userRegistrationData) return;
        
        const contentDiv = document.getElementById('ordersContent');
        UIManager.showLoading('ordersContent', 'ËºâÂÖ•Ë®ÇÂñÆË≥áÊñô‰∏≠...');
        
        try {
            const result = await callAPIWithRetry('get-orders', {
                userId: userId,
                lineName: userProfile.displayName,
                realName: userRegistrationData.realName
            });
            
            if (result && result.success) {
                if (result.orderSummary) {
                    currentOrderSummary = result.orderSummary;
                    displayOrderSummary(result.orderSummary);
                } else {
                    contentDiv.innerHTML = `
                        <div class="info">
                            <h3>üìã Ë®ÇÂñÆÊü•Ë©¢ÁµêÊûú</h3>
                            <p>${result.message || 'ÁõÆÂâçÊ≤íÊúâË®ÇË≥ºË®òÈåÑ'}</p>
                        </div>
                    `;
                }
            } else {
                throw new Error(result?.message || 'ËºâÂÖ•Ë®ÇÂñÆÂ§±Êïó');
            }
            
        } catch (error) {
            debugLog('ËºâÂÖ•Ë®ÇÂñÆÂ§±Êïó', error);
            contentDiv.innerHTML = `
                <div class="error">
                    <h3>‚ùå ËºâÂÖ•Â§±Êïó</h3>
                    <p>${error.message}</p>
                    <button class="btn" onclick="loadOrdersContent()" style="margin-top: 15px;">
                        ÈáçÊñ∞ËºâÂÖ•
                    </button>
                </div>
            `;
        }
    }

    function displayOrderSummary(orderSummary) {
        const contentDiv = document.getElementById('ordersContent');
        
        let html = `
            <div class="order-summary">
                <h3>üìã Ë®ÇÂñÆÊëòË¶Å</h3>
                <div class="summary-item">
                    <span>Ë®ÇÂñÆÁ∑®Ëôü:</span>
                    <span>${orderSummary.orderId}</span>
                </div>
                <div class="summary-item">
                    <span>LINE ÂêçÁ®±:</span>
                    <span>${orderSummary.lineName}</span>
                </div>
                <div class="summary-item">
                    <span>ÁúüÂØ¶ÂßìÂêç:</span>
                    <span>${orderSummary.realName}</span>
                </div>
                <div class="summary-item">
                    <span>ÂïÜÂìÅÁ®ÆÈ°û:</span>
                    <span>${orderSummary.productCount} Á®Æ</span>
                </div>
                <div class="summary-item">
                    <span>Á∏ΩÊï∏Èáè:</span>
                    <span>${orderSummary.totalQuantity} ‰ª∂</span>
                </div>
                <div class="summary-item">
                    <span>Ë®ÇÂñÆÁ∏ΩÈ°ç:</span>
                    <span>NT$ ${orderSummary.totalAmount.toLocaleString()}</span>
                </div>
            </div>
        `;
        
        if (orderSummary.products && orderSummary.products.length > 0) {
            html += `
                <div class="product-list">
                    <h4>üì¶ ÂïÜÂìÅÊòéÁ¥∞</h4>
            `;
            
            orderSummary.products.forEach(product => {
                html += `
                    <div class="product-item">
                        <div class="product-info">
                            <div class="product-name">${product.productName}</div>
                            <div class="product-code">${product.productCode}</div>
                        </div>
                        <div class="product-details">
                            <div>Êï∏Èáè: ${product.quantity}</div>
                            <div>ÂñÆÂÉπ: NT$ ${product.unitPrice.toLocaleString()}</div>
                            <div class="product-price">Â∞èË®à: NT$ ${product.totalPrice.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
        }
        
        html += `
            <div class="btn-group">
                <button class="btn" onclick="switchTab('payment', event)">
                    üí∞ ÂâçÂæÄÁπ≥Ë≤ªÂõûÂ†±
                </button>
                <button class="btn secondary" onclick="loadOrdersContent()">
                    üîÑ ÈáçÊñ∞Êï¥ÁêÜ
                </button>
            </div>
        `;
        
        contentDiv.innerHTML = html;
    }

    async function loadPaymentContent() {
        if (!isRegistered || !userRegistrationData) return;
        
        const contentDiv = document.getElementById('paymentContent');
        
        if (!currentOrderSummary) {
            contentDiv.innerHTML = `
                <div class="warning">
                    <h3>‚ö†Ô∏è Ë´ãÂÖàÊü•Ë©¢Ë®ÇÂñÆ</h3>
                    <p>Ë´ãÂÖàÂà∞„ÄåÊàëÁöÑË®ÇÂñÆ„ÄçÈ†ÅÈù¢Êü•Ë©¢Ë®ÇÂñÆË≥áË®äÔºåÂÜçÈÄ≤Ë°åÁπ≥Ë≤ªÂõûÂ†±„ÄÇ</p>
                    <button class="btn" onclick="switchTab('orders', event)" style="margin-top: 15px;">
                        ÂâçÂæÄÊü•Ë©¢Ë®ÇÂñÆ
                    </button>
                </div>
            `;
            return;
        }
        
        displayPaymentForm();
    }

    function displayPaymentForm() {
        const contentDiv = document.getElementById('paymentContent');
        
        const html = `
            <div class="order-summary">
                <h3>üí∞ Áπ≥Ë≤ªË≥áË®ä</h3>
                <div class="summary-item">
                    <span>Ë®ÇÂñÆÁ∑®Ëôü:</span>
                    <span>${currentOrderSummary.orderId}</span>
                </div>
                <div class="summary-item">
                    <span>ÊáâÁπ≥ÈáëÈ°ç:</span>
                    <span>NT$ ${currentOrderSummary.totalAmount.toLocaleString()}</span>
                </div>
            </div>
            
            <h2 style="margin: 25px 0 20px 0; color: #333;">üìù Áπ≥Ë≤ªË≠âÊòéÊèê‰∫§</h2>
            
            <form id="paymentForm">
                <div class="form-group">
                    <label for="paymentAmount">Áπ≥Ë≤ªÈáëÈ°ç *</label>
                    <input type="number" id="paymentAmount" name="paymentAmount" 
                           value="${currentOrderSummary.totalAmount}" required 
                           min="1" step="1" placeholder="Ë´ãËº∏ÂÖ•Áπ≥Ë≤ªÈáëÈ°ç">
                </div>
                
                <div class="form-group">
                    <label for="paymentMethod">Áπ≥Ë≤ªÊñπÂºè *</label>
                    <select id="paymentMethod" name="paymentMethod" required>
                        <option value="">Ë´ãÈÅ∏ÊìáÁπ≥Ë≤ªÊñπÂºè</option>
                        <option value="ÈäÄË°åËΩâÂ∏≥">ÈäÄË°åËΩâÂ∏≥</option>
                        <option value="ATMËΩâÂ∏≥">ATMËΩâÂ∏≥</option>
                        <option value="Ë∂ÖÂïÜÁπ≥Ë≤ª">Ë∂ÖÂïÜÁπ≥Ë≤ª</option>
                        <option value="‰ø°Áî®Âç°">‰ø°Áî®Âç°</option>
                        <option value="ÁèæÈáë">ÁèæÈáë</option>
                        <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="paymentNote">ÂÇôË®ªË™™Êòé</label>
                    <textarea id="paymentNote" name="paymentNote" 
                              placeholder="Ë´ãËº∏ÂÖ•Áπ≥Ë≤ªÁõ∏ÈóúË™™ÊòéÔºåÂ¶ÇÔºöËΩâÂ∏≥Â∏≥ËôüÂæå5Á¢º„ÄÅÁπ≥Ë≤ªÊôÇÈñìÁ≠â" 
                              maxlength="200"></textarea>
                    <small style="color: #6c757d; font-size: 12px;">ÂèØËº∏ÂÖ•ËΩâÂ∏≥Ë≥áË®ä„ÄÅÁπ≥Ë≤ªÊôÇÈñìÁ≠âÁõ∏ÈóúË™™Êòé</small>
                </div>
                
                <button type="submit" class="btn" id="paymentSubmitBtn">
                    <span>Êèê‰∫§Áπ≥Ë≤ªË≠âÊòé</span>
                </button>
            </form>
        `;
        
        contentDiv.innerHTML = html;
        
        // Á∂ÅÂÆöË°®ÂñÆÊèê‰∫§‰∫ã‰ª∂
        const form = document.getElementById('paymentForm');
        if (form) {
            form.addEventListener('submit', handlePaymentSubmit);
        }
    }

    async function handlePaymentSubmit(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const paymentAmount = parseFloat(formData.get('paymentAmount'));
        const paymentMethod = formData.get('paymentMethod').trim();
        const paymentNote = formData.get('paymentNote').trim();
        
        // È©óË≠â
        if (!paymentAmount || paymentAmount <= 0) {
            UIManager.showToast('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÁπ≥Ë≤ªÈáëÈ°ç', 'error');
            return;
        }
        
        if (!paymentMethod) {
            UIManager.showToast('Ë´ãÈÅ∏ÊìáÁπ≥Ë≤ªÊñπÂºè', 'error');
            return;
        }
        
        const noteValidation = FormValidator.validatePaymentNote(paymentNote);
        if (!noteValidation.valid) {
            UIManager.showToast(noteValidation.message, 'error');
            return;
        }
        
        const submitBtn = document.getElementById('paymentSubmitBtn');
        const originalText = submitBtn.innerHTML;
        
        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>Êèê‰∫§‰∏≠...</span>';
            
            const result = await callAPIWithRetry('submit-payment', {
                userId: userId,
                orderId: currentOrderSummary.orderId,
                lineName: userProfile.displayName,
                realName: userRegistrationData.realName,
                paymentAmount: paymentAmount,
                paymentMethod: paymentMethod,
                paymentNote: paymentNote,
                timestamp: new Date().toISOString()
            });
            
            if (result && result.success) {
                UIManager.showToast('Áπ≥Ë≤ªË≠âÊòéÊèê‰∫§ÊàêÂäüÔºÅ', 'success');
                
                // È°ØÁ§∫ÊàêÂäüË®äÊÅØ‰∏¶Êèê‰æõÂæåÁ∫åÊìç‰Ωú
                document.getElementById('paymentContent').innerHTML = `
                    <div class="success">
                        <h3>‚úÖ Êèê‰∫§ÊàêÂäü</h3>
                        <p>ÊÇ®ÁöÑÁπ≥Ë≤ªË≠âÊòéÂ∑≤ÊàêÂäüÊèê‰∫§ÔºåÊàëÂÄëÊúÉÁõ°Âø´ÈÄ≤Ë°åÂØ©Ê†∏„ÄÇ</p>
                        <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>Êèê‰∫§Ë≥áË®ä:</strong><br>
                            Áπ≥Ë≤ªÁ∑®Ëôü: ${result.paymentId}<br>
                            Êèê‰∫§ÊôÇÈñì: ${new Date(result.submittedAt).toLocaleString('zh-TW')}
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn" onclick="switchTab('status', event)">
                            üìä Êü•ÁúãÁπ≥Ë≤ªÁãÄÊÖã
                        </button>
                        <button class="btn secondary" onclick="loadPaymentContent()">
                            üîÑ ÈáçÊñ∞Êèê‰∫§
                        </button>
                    </div>
                `;
                
            } else {
                throw new Error(result?.message || 'Êèê‰∫§Â§±Êïó');
            }
            
        } catch (error) {
            debugLog('Êèê‰∫§Áπ≥Ë≤ªË≠âÊòéÂ§±Êïó', error);
            UIManager.showToast('Êèê‰∫§Â§±Êïó: ' + error.message, 'error');
            
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    }

    async function loadStatusContent() {
        if (!isRegistered || !userRegistrationData) return;
        
        const contentDiv = document.getElementById('statusContent');
        UIManager.showLoading('statusContent', 'ËºâÂÖ•Áπ≥Ë≤ªÁãÄÊÖã‰∏≠...');
        
        try {
            const result = await callAPIWithRetry('get-payment-status', {
                userId: userId,
                lineName: userProfile.displayName,
                realName: userRegistrationData.realName
            });
            
            if (result && result.success) {
                if (result.payments && result.payments.length > 0) {
                    displayPaymentStatus(result.payments);
                } else {
                    contentDiv.innerHTML = `
                        <div class="info">
                            <h3>üìä Áπ≥Ë≤ªÁãÄÊÖãÊü•Ë©¢</h3>
                            <p>${result.message || 'ÁõÆÂâçÊ≤íÊúâÁπ≥Ë≤ªË®òÈåÑ'}</p>
                            <button class="btn" onclick="switchTab('payment', event)" style="margin-top: 15px;">
                                ÂâçÂæÄÁπ≥Ë≤ªÂõûÂ†±
                            </button>
                        </div>
                    `;
                }
            } else {
                throw new Error(result?.message || 'ËºâÂÖ•Áπ≥Ë≤ªÁãÄÊÖãÂ§±Êïó');
            }
            
        } catch (error) {
            debugLog('ËºâÂÖ•Áπ≥Ë≤ªÁãÄÊÖãÂ§±Êïó', error);
            contentDiv.innerHTML = `
                <div class="error">
                    <h3>‚ùå ËºâÂÖ•Â§±Êïó</h3>
                    <p>${error.message}</p>
                    <button class="btn" onclick="loadStatusContent()" style="margin-top: 15px;">
                        ÈáçÊñ∞ËºâÂÖ•
                    </button>
                </div>
            `;
        }
    }

    function displayPaymentStatus(payments) {
        const contentDiv = document.getElementById('statusContent');
        
        let html = `
            <h2 style="margin-bottom: 20px; color: #333;">üìä Áπ≥Ë≤ªÁãÄÊÖã</h2>
            <div class="payment-status">
        `;
        
        payments.forEach(payment => {
            const statusClass = getStatusClass(payment.status);
            const statusText = getStatusText(payment.status);
            const submittedDate = new Date(payment.submittedAt).toLocaleString('zh-TW');
            
            html += `
                <div class="payment-item ${statusClass}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>Áπ≥Ë≤ªÁ∑®Ëôü: ${payment.paymentId}</strong>
                        <span class="status-badge status-${statusClass}">${statusText}</span>
                    </div>
                    
                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                        Ë®ÇÂñÆÁ∑®Ëôü: ${payment.orderId}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                        <div><strong>Áπ≥Ë≤ªÈáëÈ°ç:</strong> NT$ ${payment.paymentAmount.toLocaleString()}</div>
                        <div><strong>Áπ≥Ë≤ªÊñπÂºè:</strong> ${payment.paymentMethod}</div>
                        <div><strong>Êèê‰∫§ÊôÇÈñì:</strong> ${submittedDate}</div>
                        <div><strong>ÁãÄÊÖã:</strong> ${statusText}</div>
                    </div>
            `;
            
            if (payment.paymentNote) {
                html += `
                    <div style="margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 6px; font-size: 13px;">
                        <strong>ÂÇôË®ª:</strong> ${payment.paymentNote}
                    </div>
                `;
            }
            
            if (payment.reviewedAt && payment.reviewNote) {
                const reviewedDate = new Date(payment.reviewedAt).toLocaleString('zh-TW');
                html += `
                    <div style="margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 6px; font-size: 13px;">
                        <strong>ÂØ©Ê†∏ÊôÇÈñì:</strong> ${reviewedDate}<br>
                        <strong>ÂØ©Ê†∏ÂÇôË®ª:</strong> ${payment.reviewNote}
                    </div>
                `;
            }
            
            html += `</div>`;
        });
        
        html += `
            </div>
            <div class="btn-group">
                <button class="btn secondary" onclick="loadStatusContent()">
                    üîÑ ÈáçÊñ∞Êï¥ÁêÜ
                </button>
                <button class="btn" onclick="switchTab('payment', event)">
                    üí∞ Êñ∞Â¢ûÁπ≥Ë≤ªÂõûÂ†±
                </button>
            </div>
        `;
        
        contentDiv.innerHTML = html;
    }

    function getStatusClass(status) {
        switch (status) {
            case 'ÂæÖÂØ©Ê†∏': return 'pending';
            case 'Â∑≤Á¢∫Ë™ç': return 'approved';
            case 'Â∑≤ÊãíÁµï': return 'rejected';
            default: return 'pending';
        }
    }

    function getStatusText(status) {
        switch (status) {
            case 'ÂæÖÂØ©Ê†∏': return 'ÂæÖÂØ©Ê†∏';
            case 'Â∑≤Á¢∫Ë™ç': return 'Â∑≤Á¢∫Ë™ç';
            case 'Â∑≤ÊãíÁµï': return 'Â∑≤ÊãíÁµï';
            default: return status || 'Êú™Áü•';
        }
    }

    // Ë®ªÂÜäË°®ÂñÆÊèê‰∫§ËôïÁêÜ
    document.addEventListener('DOMContentLoaded', function() {
        const nameForm = document.getElementById('nameForm');
        if (nameForm) {
            nameForm.addEventListener('submit', handleRegistration);
        }
    });

    async function handleRegistration(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const realName = formData.get('realName').trim();
        
        // È©óË≠âÂßìÂêç
        const validation = FormValidator.validateRealName(realName);
        if (!validation.valid) {
            UIManager.showToast(validation.message, 'error');
            return;
        }
        
        const submitBtn = document.getElementById('registerSubmitBtn');
        const originalText = submitBtn.innerHTML;
        
        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>Ë®ªÂÜä‰∏≠...</span>';
            
            const result = await callAPIWithRetry('register', {
                userId: userId,
                lineDisplayName: userProfile.displayName,
                realName: realName,
                liffContext: liffContext,
                liffEnvironment: liffEnvironment,
                timestamp: new Date().toISOString()
            });
            
            if (result && result.success) {
                debugLog('Ë®ªÂÜäÊàêÂäü', result.userInfo);
                
                isRegistered = true;
                userRegistrationData = result.userInfo;
                
                UIManager.showToast('Ë®ªÂÜäÊàêÂäüÔºÅÊ≠°Ëøé‰ΩøÁî®Ë®ÇË≥ºÁ≥ªÁµ±', 'success');
                
                showRegisteredStatus();
                enableAllTabs();
                displayUserInfo();
                
            } else {
                throw new Error(result?.message || 'Ë®ªÂÜäÂ§±Êïó');
            }
            
        } catch (error) {
            debugLog('Ë®ªÂÜäÂ§±Êïó', error);
            UIManager.showToast('Ë®ªÂÜäÂ§±Êïó: ' + error.message, 'error');
            
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    }

    // ÈåØË™§È°ØÁ§∫ÂáΩÊï∏
    function showError(message) {
        const container = document.querySelector('.content');
        if (container) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `
                <h3>‚ùå Á≥ªÁµ±ÈåØË™§</h3>
                <p>${message}</p>
                <button class="btn" onclick="location.reload()" style="margin-top: 15px;">
                    ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢
                </button>
            `;
            container.insertBefore(errorDiv, container.firstChild);
        }
    }

    // È†ÅÈù¢ÁîüÂëΩÈÄ±ÊúüËôïÁêÜ
    window.addEventListener('beforeunload', function() {
        debugLog('È†ÅÈù¢Âç≥Â∞áÈóúÈñâ');
    });

    // Á∂≤Ë∑ØÁãÄÊÖãÁõ£Êéß
    window.addEventListener('online', function() {
        UIManager.showToast('Á∂≤Ë∑ØÈÄ£Á∑öÂ∑≤ÊÅ¢Âæ©', 'success');
        if (!apiConnected) {
            testApiConnection();
        }
    });

    window.addEventListener('offline', function() {
        UIManager.showToast('Á∂≤Ë∑ØÈÄ£Á∑ö‰∏≠Êñ∑', 'warning');
    });

    // ÈñãÁôºÁî®Ê∏¨Ë©¶ÂáΩÊï∏
    function testAllFunctions() {
        if (!CONFIG.DEBUG_MODE) return;
        
        console.log('=== Á≥ªÁµ±ÁãÄÊÖãÊ∏¨Ë©¶ ===');
        console.log('LIFF ÂàùÂßãÂåñ:', liff.isReady());
        console.log('Áî®Êà∂ÁôªÂÖ•:', liff.isLoggedIn());
        console.log('Áî®Êà∂Ë≥áÊñô:', userProfile);
        console.log('Ë®ªÂÜäÁãÄÊÖã:', isRegistered);
        console.log('API ÈÄ£Á∑ö:', apiConnected);
        console.log('Áï∂ÂâçË®ÇÂñÆ:', currentOrderSummary);
    }

    // Âú®ÈñãÁôºÊ®°Âºè‰∏ãÊö¥Èú≤Ê∏¨Ë©¶ÂáΩÊï∏Âà∞ÂÖ®Âüü
    if (CONFIG.DEBUG_MODE) {
        window.testAllFunctions = testAllFunctions;
        window.debugLog = debugLog;
        window.CONFIG = CONFIG;
    }
</script>
</body>
</html>
