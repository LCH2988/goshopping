<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è¨‚è³¼ç®¡ç†ç³»çµ±</title>
  <meta name="description" content="è¨‚è³¼ç®¡ç†ç³»çµ± - æŸ¥è©¢è¨‚å–®ã€ç¹³è²»å›å ±">
  <meta name="theme-color" content="#4285f4">
  
  <!-- LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    :root {
      --primary-color: #4285f4;
      --secondary-color: #34a853;
      --accent-color: #ea4335;
      --text-color: #333333;
      --light-text: #757575;
      --background-color: #f5f5f5;
      --card-color: #ffffff;
      --border-color: #e0e0e0;
      --shadow-color: rgba(0, 0, 0, 0.1);
      --success-color: #34a853;
      --warning-color: #fbbc05;
      --error-color: #ea4335;
      --info-color: #4285f4;
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: var(--font-family);
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
      padding: 0;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }
    
    .container {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
      flex: 1;
    }
    
    .header {
      background-color: var(--primary-color);
      color: white;
      padding: 16px;
      text-align: center;
      position: relative;
      box-shadow: 0 2px 4px var(--shadow-color);
    }
    
    .header h1 {
      font-size: 1.5rem;
      margin: 0;
      font-weight: 500;
    }
    
    .card {
      background-color: var(--card-color);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 4px var(--shadow-color);
    }
    
    .card h2 {
      font-size: 1.25rem;
      margin-bottom: 16px;
      color: var(--primary-color);
      font-weight: 500;
    }
    
    .tab-container {
      background-color: var(--card-color);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px var(--shadow-color);
      margin-bottom: 16px;
    }
    
    .tab-buttons {
      display: flex;
      background-color: var(--primary-color);
    }
    
    .tab-button {
      flex: 1;
      border: none;
      background: none;
      color: rgba(255, 255, 255, 0.8);
      padding: 12px 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      border-bottom: 3px solid transparent;
    }
    
    .tab-button.active {
      color: white;
      border-bottom: 3px solid white;
    }
    
    .tab-button:hover:not(.active) {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .tab-content {
      display: none;
      padding: 16px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-color);
    }
    
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1rem;
      color: var(--text-color);
      background-color: white;
      transition: border-color 0.3s;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: var(--primary-color);
      outline: none;
    }
    
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 16px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      width: 100%;
    }
    
    .btn:hover {
      background-color: #3367d6;
    }
    
    .btn:disabled {
      background-color: #b0bec5;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background-color: #757575;
    }
    
    .btn-secondary:hover {
      background-color: #616161;
    }
    
    .btn-success {
      background-color: var(--success-color);
    }
    
    .btn-success:hover {
      background-color: #2e7d32;
    }
    
    .btn-warning {
      background-color: var(--warning-color);
    }
    
    .btn-warning:hover {
      background-color: #f57c00;
    }
    
    .btn-error {
      background-color: var(--error-color);
    }
    
    .btn-error:hover {
      background-color: #c62828;
    }
    
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      text-align: center;
      color: var(--light-text);
    }
    
    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid var(--primary-color);
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 0.9rem;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
      max-width: 80%;
      text-align: center;
      pointer-events: none;
    }
    
    .toast.show {
      opacity: 1;
    }
    
    .toast.success {
      background-color: var(--success-color);
    }
    
    .toast.error {
      background-color: var(--error-color);
    }
    
    .toast.warning {
      background-color: var(--warning-color);
      color: var(--text-color);
    }
    
    .toast.info {
      background-color: var(--info-color);
    }
    
    .error-container {
      text-align: center;
      padding: 24px;
      color: var(--error-color);
    }
    
    .profile-card {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .profile-image {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 16px;
      border: 2px solid var(--primary-color);
    }
    
    .profile-info {
      flex: 1;
    }
    
    .profile-name {
      font-weight: 500;
      font-size: 1.1rem;
      margin-bottom: 4px;
    }
    
    .profile-status {
      color: var(--light-text);
      font-size: 0.9rem;
    }
    
    .info, .warning, .error, .success {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    
    .info {
      background-color: rgba(66, 133, 244, 0.1);
      border-left: 4px solid var(--info-color);
    }
    
    .warning {
      background-color: rgba(251, 188, 5, 0.1);
      border-left: 4px solid var(--warning-color);
    }
    
    .error {
      background-color: rgba(234, 67, 53, 0.1);
      border-left: 4px solid var(--error-color);
    }
    
    .success {
      background-color: rgba(52, 168, 83, 0.1);
      border-left: 4px solid var(--success-color);
    }
    
    .divider {
      height: 1px;
      background-color: var(--border-color);
      margin: 16px 0;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    
    .badge-primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .badge-secondary {
      background-color: #757575;
      color: white;
    }
    
    .badge-success {
      background-color: var(--success-color);
      color: white;
    }
    
    .badge-warning {
      background-color: var(--warning-color);
      color: var(--text-color);
    }
    
    .badge-error {
      background-color: var(--error-color);
      color: white;
    }
    
    .badge-info {
      background-color: var(--info-color);
      color: white;
    }
    
    .badge-light {
      background-color: #e0e0e0;
      color: var(--text-color);
    }
    
    .badge-dark {
      background-color: #424242;
      color: white;
    }
    
    .order-summary {
      margin-bottom: 16px;
      padding: 16px;
      background-color: rgba(66, 133, 244, 0.1);
      border-radius: 8px;
    }
    
    .order-summary h3 {
      margin-bottom: 12px;
      color: var(--primary-color);
      font-weight: 500;
    }
    
    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .summary-item:last-child {
      margin-bottom: 0;
    }
    
    .product-list {
      margin-top: 16px;
    }
    
    .product-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .product-item:last-child {
      border-bottom: none;
    }
    
    .product-name {
      flex: 1;
    }
    
    .product-price {
      font-weight: 500;
      text-align: right;
      margin-left: 16px;
    }
    
    .total-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      font-weight: 500;
      border-top: 2px solid var(--border-color);
      margin-top: 8px;
    }
    
    .payment-status {
      margin-top: 16px;
    }
    
    .payment-item {
      background-color: white;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px var(--shadow-color);
    }
    
    .payment-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .payment-id {
      font-size: 0.9rem;
      color: var(--light-text);
    }
    
    .payment-date {
      font-size: 0.9rem;
      color: var(--light-text);
    }
    
    .payment-amount {
      font-size: 1.2rem;
      font-weight: 500;
      margin-bottom: 8px;
    }
    
    .payment-method {
      margin-bottom: 8px;
    }
    
    .payment-note {
      font-size: 0.9rem;
      color: var(--light-text);
      margin-top: 8px;
      white-space: pre-line;
    }
    
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
      display: inline-block;
    }
    
    .status-pending {
      background-color: var(--warning-color);
      color: var(--text-color);
    }
    
    .status-approved {
      background-color: var(--success-color);
      color: white;
    }
    
    .status-rejected {
      background-color: var(--error-color);
      color: white;
    }
    
    .footer {
      text-align: center;
      padding: 16px;
      color: var(--light-text);
      font-size: 0.8rem;
      background-color: white;
      border-top: 1px solid var(--border-color);
    }
    
    .cache-info {
      text-align: center;
      padding: 8px;
      background-color: rgba(0, 0, 0, 0.05);
      border-radius: 4px;
      font-size: 0.8rem;
      color: var(--light-text);
      margin-top: 16px;
    }
    
    .offline-banner {
      background-color: var(--warning-color);
      color: var(--text-color);
      text-align: center;
      padding: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      display: none;
    }
    
    .offline-banner.show {
      display: block;
    }
    
    @media (max-width: 480px) {
      .header h1 {
        font-size: 1.3rem;
      }
      
      .tab-button {
        font-size: 0.8rem;
        padding: 10px 4px;
      }
    }
  </style>
</head>
<body>
  <div id="offlineBanner" class="offline-banner">
    æ‚¨ç›®å‰è™•æ–¼é›¢ç·šç‹€æ…‹ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨
  </div>
  
  <header class="header">
    <h1>è¨‚è³¼ç®¡ç†ç³»çµ±</h1>
  </header>
  
  <div class="container">
    <div id="loadingContainer" class="loading">
      <div class="loading-spinner"></div>
      <p>åˆå§‹åŒ–ä¸­ï¼Œè«‹ç¨å€™...</p>
    </div>
    
    <div id="errorContainer" class="error-container" style="display: none;">
      <h2>ç™¼ç”ŸéŒ¯èª¤</h2>
      <p id="errorMessage"></p>
      <button class="btn" onclick="location.reload()" style="margin-top: 16px; max-width: 200px;">
        é‡æ–°è¼‰å…¥
      </button>
    </div>
    
    <div id="mainContent" style="display: none;">
      <div class="tab-container">
        <div class="tab-buttons">
          <button class="tab-button active" onclick="switchTab('home', event)">é¦–é </button>
          <button class="tab-button" onclick="switchTab('orders', event)">æˆ‘çš„è¨‚å–®</button>
          <button class="tab-button" onclick="switchTab('payment', event)">ç¹³è²»å›å ±</button>
          <button class="tab-button" onclick="switchTab('status', event)">ç¹³è²»ç‹€æ…‹</button>
        </div>
        
        <div id="home" class="tab-content active">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
        
        <div id="orders" class="tab-content">
          <div id="ordersContent" class="loading">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
        
        <div id="payment" class="tab-content">
          <div id="paymentContent" class="loading">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
        
        <div id="status" class="tab-content">
          <div id="statusContent" class="loading">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="toast" class="toast"></div>
  
  <footer class="footer">
    <p>Â© 2025 è¨‚è³¼ç®¡ç†ç³»çµ± v2.0.0</p>
  </footer>
  
  <script>
    // ==================== å…¨åŸŸè®Šæ•¸ ====================
    
    // API è¨­å®š
    const API_CONFIG = {
      URL: 'https://script.google.com/macros/s/AKfycbzymu8Z2uyfuYP-ZI480g0QKIhJV5C0H3PKeHGWp90O3GXpsdnnpLO9d7bwWoNUs2G5/exec',
      RETRY_DELAY: 1000,
      MAX_RETRIES: 3
    };
    
    // ç”¨æˆ¶è³‡è¨Š
    let userId = null;
    let userProfile = null;
    let isRegistered = false;
    let userRegistrationData = null;
    
    // è¨‚å–®è³‡è¨Š
    let currentOrderSummary = null;
    
    // ç³»çµ±ç‹€æ…‹
    let isInitialized = false;
    let isOnline = true;
    let liffObject = null;
    
    // ==================== åˆå§‹åŒ–å‡½æ•¸ ====================
    
    /**
     * æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–
     */
    async function initializeApp() {
      try {
        // åˆå§‹åŒ–ç¶²è·¯ç‹€æ…‹ç›£æ§
        initializeNetworkMonitoring();
        
        // å˜—è©¦å¾ localStorage æ¢å¾©è¨‚å–®æ•¸æ“š
        try {
          const savedOrderSummary = localStorage.getItem('currentOrderSummary');
          if (savedOrderSummary) {
            currentOrderSummary = JSON.parse(savedOrderSummary);
            debugLog('å¾ localStorage æ¢å¾©è¨‚å–®æ•¸æ“š', currentOrderSummary);
          }
        } catch (e) {
          debugLog('æ¢å¾©è¨‚å–®æ•¸æ“šå¤±æ•—', e);
        }
        
        // åˆå§‹åŒ– LIFF
        await initializeLiff();
        
        // æ¸¬è©¦ API é€£ç·š
        await testApiConnection();
        
        // æª¢æŸ¥ç”¨æˆ¶è¨»å†Šç‹€æ…‹
        if (userId) {
          await checkUserRegistration();
        }
        
        // è¼‰å…¥é¦–é å…§å®¹
        loadHomeContent();
        
        // é¡¯ç¤ºä¸»å…§å®¹
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
        isInitialized = true;
        
      } catch (error) {
        debugLog('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—', error);
        showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°é–‹å•Ÿ: ' + error.message);
      }
    }
    
    /**
     * åˆå§‹åŒ– LIFF
     */
    async function initializeLiff() {
      try {
        debugLog('åˆå§‹åŒ– LIFF...');
        
        // åˆå§‹åŒ– LIFF SDK
        liffObject = await liff.init({
          liffId: '2001304097-vk1Gy5xN' // è«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID
        });
        
        debugLog('LIFF åˆå§‹åŒ–æˆåŠŸ');
        
        // æª¢æŸ¥æ˜¯å¦åœ¨ LINE ç’°å¢ƒä¸­
        if (!liff.isInClient()) {
          debugLog('ä¸åœ¨ LINE ç’°å¢ƒä¸­');
          UIManager.showToast('è«‹åœ¨ LINE æ‡‰ç”¨ç¨‹å¼ä¸­é–‹å•Ÿ', 'warning');
        }
        
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        if (!liff.isLoggedIn()) {
          debugLog('ç”¨æˆ¶æœªç™»å…¥ï¼ŒåŸ·è¡Œç™»å…¥ç¨‹åº');
          liff.login();
          return;
        }
        
        // å–å¾—ç”¨æˆ¶è³‡è¨Š
        userProfile = await liff.getProfile();
        userId = userProfile.userId;
        
        debugLog('å–å¾—ç”¨æˆ¶è³‡è¨Š', {
          userId: userId,
          displayName: userProfile.displayName
        });
        
      } catch (error) {
        debugLog('LIFF åˆå§‹åŒ–å¤±æ•—', error);
        throw new Error('LINE ä»‹é¢è¼‰å…¥å¤±æ•—: ' + error.message);
      }
    }
    
    /**
     * åˆå§‹åŒ–ç¶²è·¯ç‹€æ…‹ç›£æ§
     */
    function initializeNetworkMonitoring() {
      const offlineBanner = document.getElementById('offlineBanner');
      
      // åˆå§‹æª¢æŸ¥
      isOnline = navigator.onLine;
      offlineBanner.classList.toggle('show', !isOnline);
      
      // ç›£è½ç¶²è·¯ç‹€æ…‹è®ŠåŒ–
      window.addEventListener('online', () => {
        isOnline = true;
        offlineBanner.classList.remove('show');
        UIManager.showToast('å·²æ¢å¾©ç¶²è·¯é€£ç·š', 'success');
        
        // é‡æ–°è¼‰å…¥è³‡æ–™
        if (isInitialized) {
          const activeTab = document.querySelector('.tab-content.active');
          if (activeTab) {
            loadTabContent(activeTab.id);
          }
        }
      });
      
      window.addEventListener('offline', () => {
        isOnline = false;
        offlineBanner.classList.add('show');
        UIManager.showToast('ç¶²è·¯é€£ç·šä¸­æ–·ï¼Œä½¿ç”¨å¿«å–è³‡æ–™', 'warning');
      });
    }
    
    /**
     * æ¸¬è©¦ API é€£ç·š
     */
    async function testApiConnection() {
      try {
        debugLog('æ¸¬è©¦ API é€£ç·š...');
        
        const result = await callAPIWithRetry('test', {});
        
        if (result && result.success) {
          debugLog('API é€£ç·šæ­£å¸¸', result);
          return true;
        } else {
          throw new Error('API é€£ç·šå¤±æ•—');
        }
        
      } catch (error) {
        debugLog('API é€£ç·šæ¸¬è©¦å¤±æ•—', error);
        throw new Error('ç³»çµ±é€£ç·šå¤±æ•—: ' + error.message);
      }
    }
    
    /**
     * æª¢æŸ¥ç”¨æˆ¶è¨»å†Šç‹€æ…‹
     */
    async function checkUserRegistration() {
      try {
        debugLog('æª¢æŸ¥ç”¨æˆ¶è¨»å†Šç‹€æ…‹...');
        
        // æª¢æŸ¥å¿«å–
        const cacheKey = `registration_${userId}`;
        const cachedData = CacheManager.get(cacheKey);
        
        if (cachedData && !isOnline) {
          debugLog('ä½¿ç”¨å¿«å–çš„è¨»å†Šè³‡æ–™', cachedData);
          isRegistered = cachedData.registered;
          userRegistrationData = cachedData.userInfo;
          return;
        }
        
        const result = await callAPIWithRetry('check-registration', {
          userId: userId,
          lineName: userProfile.displayName
        });
        
        if (result && result.success) {
          isRegistered = result.registered;
          userRegistrationData = result.userInfo;
          
          // å¿«å–çµæœ
          CacheManager.set(cacheKey, {
            registered: isRegistered,
            userInfo: userRegistrationData
          });
          
          debugLog('è¨»å†Šç‹€æ…‹æª¢æŸ¥çµæœ', {
            isRegistered: isRegistered,
            userInfo: userRegistrationData
          });
          
        } else {
          throw new Error(result?.message || 'æª¢æŸ¥è¨»å†Šç‹€æ…‹å¤±æ•—');
        }
        
      } catch (error) {
        debugLog('æª¢æŸ¥è¨»å†Šç‹€æ…‹éŒ¯èª¤', error);
        UIManager.showToast('æª¢æŸ¥è¨»å†Šç‹€æ…‹å¤±æ•—: ' + error.message, 'error');
      }
    }
    
    // ==================== å…§å®¹è¼‰å…¥å‡½æ•¸ ====================
    
    /**
     * è¼‰å…¥æ¨™ç±¤é å…§å®¹
     */
    function loadTabContent(tabName) {
      switch (tabName) {
        case 'home':
          loadHomeContent();
          break;
          
        case 'orders':
          loadOrdersContent();
          break;
          
        case 'payment':
          loadPaymentContent();
          break;
          
        case 'status':
          loadStatusContent();
          break;
          
        default:
          break;
      }
    }
    
    /**
     * è¼‰å…¥é¦–é å…§å®¹
     */
    function loadHomeContent() {
      const contentDiv = document.getElementById('home');
      
      if (!userProfile) {
        contentDiv.innerHTML = `
          <div class="warning">
            <h3>âš ï¸ ç„¡æ³•å–å¾—ç”¨æˆ¶è³‡è¨Š</h3>
            <p>è«‹ç¢ºèªæ‚¨å·²ç™»å…¥ LINE ä¸¦æˆæ¬Šæ‡‰ç”¨ç¨‹å¼å­˜å–è³‡è¨Šã€‚</p>
            <button class="btn" onclick="location.reload()" style="margin-top: 15px; max-width: 200px;">
              é‡æ–°è¼‰å…¥
            </button>
          </div>
        `;
        return;
      }
      
      let profileImage = userProfile.pictureUrl || 'https://via.placeholder.com/60';
      
      // ç”¨æˆ¶è³‡è¨Šå¡ç‰‡
      let userInfoHtml = `
        <div class="profile-card">
          <img src="${profileImage}" alt="å€‹äººé ­åƒ" class="profile-image">
          <div class="profile-info">
            <div class="profile-name">${userProfile.displayName}</div>
            <div class="profile-status">
              ${isRegistered ? 
                `<span class="badge badge-success">å·²è¨»å†Š</span>` : 
                `<span class="badge badge-warning">æœªè¨»å†Š</span>`}
            </div>
          </div>
        </div>
      `;
      
      // ç³»çµ±è³‡è¨Šå¡ç‰‡
      let systemInfoHtml = `
        <div class="card">
          <h2>ğŸ“± ç³»çµ±è³‡è¨Š</h2>
          <p>æ­¡è¿ä½¿ç”¨è¨‚è³¼ç®¡ç†ç³»çµ±ï¼Œæ‚¨å¯ä»¥åœ¨é€™è£¡æŸ¥è©¢è¨‚å–®ã€å›å ±ç¹³è²»ä»¥åŠæŸ¥çœ‹ç¹³è²»ç‹€æ…‹ã€‚</p>
          
          <div class="divider"></div>
          
          <p style="margin-bottom: 12px;">ç³»çµ±åŠŸèƒ½ï¼š</p>
          <div>
            <span class="badge badge-primary">è¨‚å–®æŸ¥è©¢</span>
            <span class="badge badge-primary">ç¹³è²»å›å ±</span>
            <span class="badge badge-primary">ç¹³è²»ç‹€æ…‹</span>
          </div>
        </div>
      `;
      
      // è¨»å†Šè¡¨å–®æˆ–å·²è¨»å†Šè³‡è¨Š
      let registrationHtml = '';
      
      if (isRegistered) {
        registrationHtml = `
          <div class="card">
            <h2>ğŸ‘¤ ç”¨æˆ¶è³‡æ–™</h2>
            <div class="form-group">
              <label>çœŸå¯¦å§“å</label>
              <div style="padding: 10px 12px; background-color: rgba(0,0,0,0.05); border-radius: 4px;">
                ${userRegistrationData.realName}
              </div>
            </div>
            
            ${userRegistrationData.phone ? `
            <div class="form-group">
              <label>è¯çµ¡é›»è©±</label>
              <div style="padding: 10px 12px; background-color: rgba(0,0,0,0.05); border-radius: 4px;">
                ${userRegistrationData.phone}
              </div>
            </div>
            ` : ''}
            
            <div class="form-group">
              <label>è¨»å†Šæ™‚é–“</label>
              <div style="padding: 10px 12px; background-color: rgba(0,0,0,0.05); border-radius: 4px; font-size: 0.9rem;">
                ${new Date(userRegistrationData.registeredAt).toLocaleString('zh-TW')}
              </div>
            </div>
            
            <button class="btn" onclick="switchTab('orders', event)">
              æŸ¥è©¢æˆ‘çš„è¨‚å–®
            </button>
          </div>
        `;
      } else {
        registrationHtml = `
          <div class="card">
            <h2>ğŸ“ å¯¦ååˆ¶ç™»è¨˜</h2>
            <p style="margin-bottom: 16px;">è«‹å¡«å¯«ä»¥ä¸‹è³‡æ–™å®Œæˆå¯¦ååˆ¶ç™»è¨˜ï¼Œä»¥ä¾¿æŸ¥è©¢è¨‚å–®åŠç¹³è²»ã€‚</p>
            
            <form id="registrationForm">
              <div class="form-group">
                <label for="realName">çœŸå¯¦å§“å *</label>
                <input type="text" id="realName" name="realName" required placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å">
                <small style="color: #6c757d; font-size: 12px;">å¿…é ˆèˆ‡è¨‚è³¼æ™‚å¡«å¯«çš„å§“åç›¸åŒ</small>
              </div>
              
              <div class="form-group">
                <label for="phone">è¯çµ¡é›»è©±</label>
                <input type="tel" id="phone" name="phone" placeholder="è«‹è¼¸å…¥æ‚¨çš„è¯çµ¡é›»è©±">
                <small style="color: #6c757d; font-size: 12px;">é¸å¡«ï¼Œç”¨æ–¼å¿…è¦æ™‚è¯çµ¡</small>
              </div>
              
              <button type="submit" class="btn" id="registrationSubmitBtn">
                <span>æäº¤ç™»è¨˜è³‡æ–™</span>
              </button>
            </form>
          </div>
        `;
      }
      
      // çµ„åˆæ‰€æœ‰å…§å®¹
      contentDiv.innerHTML = userInfoHtml + systemInfoHtml + registrationHtml;
      
      // ç¶å®šè¨»å†Šè¡¨å–®äº‹ä»¶
      if (!isRegistered) {
        document.getElementById('registrationForm').addEventListener('submit', handleRegistrationSubmit);
      }
    }
    
    /**
     * è¼‰å…¥è¨‚å–®å…§å®¹
     */
    async function loadOrdersContent() {
      if (!isRegistered || !userRegistrationData) return;
      
      const contentDiv = document.getElementById('ordersContent');
      UIManager.showLoading('ordersContent', 'è¼‰å…¥è¨‚å–®è³‡æ–™ä¸­...');
      
      try {
        // æª¢æŸ¥å¿«å–
        const cacheKey = `orders_${userId}`;
        const cachedData = CacheManager.get(cacheKey);
        
        if (cachedData && !isOnline) {
          debugLog('ä½¿ç”¨å¿«å–çš„è¨‚å–®è³‡æ–™', cachedData);
          displayOrderData(cachedData, true);
          return;
        }
        
        const result = await callAPIWithRetry('get-orders', {
          userId: userId,
          lineName: userProfile.displayName,
          realName: userRegistrationData.realName
        });
        
        if (result && result.success) {
          // å¿«å–çµæœ
          CacheManager.set(cacheKey, result);
          displayOrderData(result, false);
          
          // å°‡è¨‚å–®æ•¸æ“šä¹Ÿå­˜å„²åˆ° localStorage ä¸­ï¼Œç¢ºä¿åœ¨é é¢é‡è¼‰å¾Œä»å¯ç”¨
          if (result.orderSummary) {
            localStorage.setItem('currentOrderSummary', JSON.stringify(result.orderSummary));
          }
        } else {
          throw new Error(result?.message || 'è¼‰å…¥è¨‚å–®å¤±æ•—');
        }
        
      } catch (error) {
        debugLog('è¼‰å…¥è¨‚å–®éŒ¯èª¤', error);
        contentDiv.innerHTML = `
          <div class="error">
            <h3>âŒ è¼‰å…¥å¤±æ•—</h3>
            <p>${error.message || 'ç„¡æ³•è¼‰å…¥è¨‚å–®è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦'}</p>
            <button class="btn" onclick="loadOrdersContent()" style="margin-top: 15px; max-width: 200px;">
              é‡æ–°è¼‰å…¥
            </button>
          </div>
        `;
      }
    }
    
    /**
     * é¡¯ç¤ºè¨‚å–®è³‡æ–™
     */
    function displayOrderData(result, isFromCache) {
      const contentDiv = document.getElementById('ordersContent');
      
      if (result.orderSummary) {
        // è¼¸å‡ºè©³ç´°æ—¥èªŒ
        debugLog('åŸå§‹è¨‚å–®æ•¸æ“š', result.orderSummary);
        
        // ä½¿ç”¨æ–°çš„ç”¢å“è™•ç†é‚è¼¯
        const processedSummary = {
          ...result.orderSummary,
          ...ProductDataProcessor.calculateSummary(result.orderSummary.products)
        };
        
        debugLog('è™•ç†å¾Œçš„è¨‚å–®æ•¸æ“š', processedSummary);
        
        // ç¢ºä¿è¨‚å–® ID å­˜åœ¨
        if (!processedSummary.orderId) {
          debugLog('è­¦å‘Š: è¨‚å–® ID ä¸å­˜åœ¨', processedSummary);
          contentDiv.innerHTML = `
            <div class="warning">
              <h3>âš ï¸ è¨‚å–®è³‡æ–™ä¸å®Œæ•´</h3>
              <p>ç„¡æ³•ç²å–è¨‚å–®ç·¨è™Ÿï¼Œè«‹è¯çµ¡å®¢æœè™•ç†ã€‚</p>
              <button class="btn" onclick="loadOrdersContent()" style="margin-top: 15px;">
                é‡æ–°è¼‰å…¥
              </button>
            </div>
          `;
          return;
        }
        
        currentOrderSummary = processedSummary;
        // ç«‹å³ä¿å­˜åˆ° localStorage
        localStorage.setItem('currentOrderSummary', JSON.stringify(currentOrderSummary));
        
        displayOrderSummary(processedSummary);
        
        if (isFromCache) {
          UIManager.showCacheInfo('ordersContent', result.timestamp || Date.now());
        }
      } else {
        contentDiv.innerHTML = `
          <div class="info">
            <h3>ğŸ“‹ è¨‚å–®æŸ¥è©¢çµæœ</h3>
            <p>${result.message || 'ç›®å‰æ²’æœ‰è¨‚è³¼è¨˜éŒ„'}</p>
          </div>
        `;
      }
    }
    
    /**
     * é¡¯ç¤ºè¨‚å–®æ‘˜è¦
     */
    function displayOrderSummary(orderSummary) {
      const contentDiv = document.getElementById('ordersContent');
      
      let productListHtml = '';
      orderSummary.products.forEach(product => {
        productListHtml += `
          <div class="product-item">
            <div class="product-name">
              ${product.productName}<br>
              <small style="color: #6c757d;">
                ${product.productCode} Ã— ${product.quantity}
              </small>
            </div>
            <div class="product-price">
              NT$ ${product.totalPrice.toLocaleString()}
              <br>
              <small style="color: #6c757d;">
                å–®åƒ¹: ${product.unitPrice.toLocaleString()}
              </small>
            </div>
          </div>
        `;
      });
      
      contentDiv.innerHTML = `
        <div class="order-summary">
          <h3>ğŸ“‹ è¨‚å–®æ‘˜è¦</h3>
          <div class="summary-item">
            <span>è¨‚å–®ç·¨è™Ÿ:</span>
            <span>${orderSummary.orderId}</span>
          </div>
          <div class="summary-item">
            <span>è¨‚è³¼æ—¥æœŸ:</span>
            <span>${new Date(orderSummary.orderDate).toLocaleDateString('zh-TW')}</span>
          </div>
          <div class="summary-item">
            <span>è¨‚è³¼äºº:</span>
            <span>${orderSummary.realName}</span>
          </div>
          <div class="summary-item">
            <span>å•†å“æ•¸é‡:</span>
            <span>${orderSummary.productCount} ç¨®å•†å“ï¼Œå…± ${orderSummary.totalQuantity} ä»¶</span>
          </div>
          <div class="summary-item">
            <span>æ‡‰ç¹³é‡‘é¡:</span>
            <span>NT$ ${orderSummary.totalAmount.toLocaleString()}</span>
          </div>
        </div>
        
        <div class="card">
          <h3>ğŸ›’ å•†å“æ˜ç´°</h3>
          <div class="product-list">
            ${productListHtml}
            <div class="total-row">
              <span>ç¸½è¨ˆé‡‘é¡:</span>
              <span>NT$ ${orderSummary.totalAmount.toLocaleString()}</span>
            </div>
          </div>
        </div>
        
        <button class="btn btn-success" onclick="switchTab('payment', event)" style="margin-top: 16px;">
          å‰å¾€ç¹³è²»å›å ±
        </button>
      `;
    }
    
    /**
     * è¼‰å…¥ç¹³è²»å›å ±å…§å®¹
     */
    function loadPaymentContent() {
      if (!isRegistered || !userRegistrationData) return;
      
      const contentDiv = document.getElementById('paymentContent');
      
      // æª¢æŸ¥è¨‚å–®æ•¸æ“šæ˜¯å¦å®Œæ•´
      if (!currentOrderSummary || !currentOrderSummary.orderId) {
        // å˜—è©¦å¾ localStorage æ¢å¾©
        try {
          const savedOrderSummary = localStorage.getItem('currentOrderSummary');
          if (savedOrderSummary) {
            currentOrderSummary = JSON.parse(savedOrderSummary);
            debugLog('å¾ localStorage æ¢å¾©è¨‚å–®æ•¸æ“š', currentOrderSummary);
          }
        } catch (e) {
          debugLog('æ¢å¾©è¨‚å–®æ•¸æ“šå¤±æ•—', e);
        }
        
        // å¦‚æœä»ç„¶æ²’æœ‰è¨‚å–®æ•¸æ“šï¼Œæç¤ºç”¨æˆ¶å…ˆæŸ¥è©¢è¨‚å–®
        if (!currentOrderSummary || !currentOrderSummary.orderId) {
          contentDiv.innerHTML = `
            <div class="warning">
              <h3>âš ï¸ è«‹å…ˆæŸ¥è©¢è¨‚å–®</h3>
              <p>è«‹å…ˆåˆ°ã€Œæˆ‘çš„è¨‚å–®ã€é é¢æŸ¥è©¢è¨‚å–®è³‡è¨Šï¼Œå†é€²è¡Œç¹³è²»å›å ±ã€‚</p>
              <button class="btn" onclick="switchTab('orders', event)" style="margin-top: 15px;">
                æŸ¥è©¢æˆ‘çš„è¨‚å–®
              </button>
            </div>
          `;
          return;
        }
      }
      
      // é¡¯ç¤ºç¹³è²»è¡¨å–®
      contentDiv.innerHTML = `
        <div class="order-summary">
          <h3>ğŸ’° ç¹³è²»å›å ±</h3>
          <div class="summary-item">
            <span>è¨‚å–®ç·¨è™Ÿ:</span>
            <span>${currentOrderSummary.orderId}</span>
          </div>
          <div class="summary-item">
            <span>æ‡‰ç¹³é‡‘é¡:</span>
            <span>NT$ ${currentOrderSummary.totalAmount.toLocaleString()}</span>
          </div>
        </div>
        
        <form id="paymentForm">
          <div class="form-group">
            <label for="paymentAmount">å¯¦éš›ç¹³è²»é‡‘é¡ *</label>
            <input type="number" id="paymentAmount" name="paymentAmount" 
                   value="${currentOrderSummary.totalAmount}" 
                   min="1" step="1" required 
                   placeholder="è«‹è¼¸å…¥å¯¦éš›ç¹³è²»é‡‘é¡">
            <small style="color: #6c757d; font-size: 12px;">è«‹è¼¸å…¥æ‚¨å¯¦éš›ç¹³è²»çš„é‡‘é¡</small>
          </div>
          
          <div class="form-group">
            <label for="paymentMethod">ç¹³è²»æ–¹å¼ *</label>
            <select id="paymentMethod" name="paymentMethod" required>
              <option value="">è«‹é¸æ“‡ç¹³è²»æ–¹å¼</option>
              <option value="éŠ€è¡Œè½‰å¸³">éŠ€è¡Œè½‰å¸³</option>
              <option value="ATMè½‰å¸³">ATMè½‰å¸³</option>
              <option value="ç¶²è·¯éŠ€è¡Œ">ç¶²è·¯éŠ€è¡Œ</option>
              <option value="ç¾é‡‘">ç¾é‡‘</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="paymentNote">å‚™è¨»èªªæ˜</label>
            <textarea id="paymentNote" name="paymentNote" 
                      placeholder="è«‹è¼¸å…¥å‚™è¨»èªªæ˜ï¼ˆå¦‚ï¼šè½‰å¸³å¸³è™Ÿå¾Œ5ç¢¼ã€ç¹³è²»æ™‚é–“ç­‰ï¼‰" 
                      maxlength="200"></textarea>
            <small style="color: #6c757d; font-size: 12px;">é¸å¡«ï¼Œæœ€å¤š200å­—</small>
          </div>
          
          <button type="submit" class="btn" id="paymentSubmitBtn">
            <span>æäº¤ç¹³è²»å›å ±</span>
          </button>
        </form>
      `;
      
      // ç¶å®šè¡¨å–®äº‹ä»¶
      document.getElementById('paymentForm').addEventListener('submit', handlePaymentSubmit);
    }
    
    /**
     * è¼‰å…¥ç¹³è²»ç‹€æ…‹å…§å®¹
     */
    async function loadStatusContent() {
      if (!isRegistered || !userRegistrationData) return;
      
      const contentDiv = document.getElementById('statusContent');
      UIManager.showLoading('statusContent', 'è¼‰å…¥ç¹³è²»ç‹€æ…‹ä¸­...');
      
      try {
        // æª¢æŸ¥å¿«å–
        const cacheKey = `payment_status_${userId}`;
        const cachedData = CacheManager.get(cacheKey);
        
        if (cachedData && !isOnline) {
          debugLog('ä½¿ç”¨å¿«å–çš„ç¹³è²»ç‹€æ…‹', cachedData);
          displayPaymentStatus(cachedData, true);
          return;
        }
        
        const result = await callAPIWithRetry('get-payment-status', {
          userId: userId,
          realName: userRegistrationData.realName
        });
        
        if (result && result.success) {
          // å¿«å–çµæœ
          CacheManager.set(cacheKey, result);
          displayPaymentStatus(result, false);
        } else {
          throw new Error(result?.message || 'è¼‰å…¥ç¹³è²»ç‹€æ…‹å¤±æ•—');
        }
        
      } catch (error) {
        debugLog('è¼‰å…¥ç¹³è²»ç‹€æ…‹éŒ¯èª¤', error);
        contentDiv.innerHTML = `
          <div class="error">
            <h3>âŒ è¼‰å…¥å¤±æ•—</h3>
            <p>${error.message || 'ç„¡æ³•è¼‰å…¥ç¹³è²»ç‹€æ…‹ï¼Œè«‹ç¨å¾Œå†è©¦'}</p>
            <button class="btn" onclick="loadStatusContent()" style="margin-top: 15px; max-width: 200px;">
              é‡æ–°è¼‰å…¥
            </button>
          </div>
        `;
      }
    }
    
    /**
     * é¡¯ç¤ºç¹³è²»ç‹€æ…‹
     */
    function displayPaymentStatus(result, isFromCache) {
      const contentDiv = document.getElementById('statusContent');
      
      if (result.payments && result.payments.length > 0) {
        let paymentsHtml = '';
        
        result.payments.forEach(payment => {
          let statusBadge = '';
          
          switch (payment.status) {
            case 'å¾…å¯©æ ¸':
              statusBadge = '<span class="status-badge status-pending">å¾…å¯©æ ¸</span>';
              break;
            case 'å·²ç¢ºèª':
              statusBadge = '<span class="status-badge status-approved">å·²ç¢ºèª</span>';
              break;
            case 'å·²æ‹’çµ•':
              statusBadge = '<span class="status-badge status-rejected">å·²æ‹’çµ•</span>';
              break;
            default:
              statusBadge = `<span class="status-badge">${payment.status}</span>`;
          }
          
          paymentsHtml += `
            <div class="payment-item">
              <div class="payment-header">
                <div class="payment-id">${payment.paymentId}</div>
                <div>${statusBadge}</div>
              </div>
              
              <div class="payment-amount">NT$ ${payment.paymentAmount.toLocaleString()}</div>
              
              <div class="payment-method">
                <strong>ç¹³è²»æ–¹å¼:</strong> ${payment.paymentMethod}
              </div>
              
              <div>
                <strong>è¨‚å–®ç·¨è™Ÿ:</strong> ${payment.orderId}
              </div>
              
              <div>
                <strong>æäº¤æ™‚é–“:</strong> ${new Date(payment.submittedAt).toLocaleString('zh-TW')}
              </div>
              
              ${payment.reviewedAt ? `
              <div>
                <strong>å¯©æ ¸æ™‚é–“:</strong> ${new Date(payment.reviewedAt).toLocaleString('zh-TW')}
              </div>
              ` : ''}
              
              ${payment.paymentNote ? `
              <div class="payment-note">
                <strong>å‚™è¨»:</strong> ${payment.paymentNote}
              </div>
              ` : ''}
              
              ${payment.reviewNote ? `
              <div class="payment-note">
                <strong>å¯©æ ¸å‚™è¨»:</strong> ${payment.reviewNote}
              </div>
              ` : ''}
            </div>
          `;
        });
        
        contentDiv.innerHTML = `
          <div class="info">
            <h3>ğŸ“Š ç¹³è²»ç‹€æ…‹</h3>
            <p>ä»¥ä¸‹æ˜¯æ‚¨çš„ç¹³è²»è¨˜éŒ„ï¼Œæœ€æ–°çš„è¨˜éŒ„æœƒé¡¯ç¤ºåœ¨æœ€å‰é¢ã€‚</p>
          </div>
          
          <div class="payment-status">
            ${paymentsHtml}
          </div>
        `;
        
        if (isFromCache) {
          UIManager.showCacheInfo('statusContent', result.timestamp || Date.now());
        }
        
      } else {
        contentDiv.innerHTML = `
          <div class="info">
            <h3>ğŸ“Š ç¹³è²»ç‹€æ…‹</h3>
            <p>${result.message || 'ç›®å‰æ²’æœ‰ç¹³è²»è¨˜éŒ„'}</p>
            <button class="btn" onclick="switchTab('payment', event)" style="margin-top: 15px;">
              å‰å¾€ç¹³è²»å›å ±
            </button>
          </div>
        `;
      }
    }
    
    // ==================== è¡¨å–®è™•ç†å‡½æ•¸ ====================
    
    /**
     * è™•ç†è¨»å†Šè¡¨å–®æäº¤
     */
    async function handleRegistrationSubmit(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const realName = formData.get('realName').trim();
      const phone = formData.get('phone').trim();
      
      // é©—è­‰
      if (!realName) {
        UIManager.showToast('è«‹è¼¸å…¥çœŸå¯¦å§“å', 'error');
        return;
      }
      
      const nameValidation = FormValidator.validateRealName(realName);
      if (!nameValidation.valid) {
        UIManager.showToast(nameValidation.message, 'error');
        return;
      }
      
      if (phone) {
        const phoneValidation = FormValidator.validatePhone(phone);
        if (!phoneValidation.valid) {
          UIManager.showToast(phoneValidation.message, 'error');
          return;
        }
      }
      
      const submitBtn = document.getElementById('registrationSubmitBtn');
      const originalText = submitBtn.innerHTML;
      
      try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span>è™•ç†ä¸­...</span>';
        
        // æº–å‚™ LIFF ç’°å¢ƒè³‡è¨Š
        const liffContext = {};
        try {
          liffContext.type = liff.getContext().type;
          liffContext.viewType = liff.getContext().viewType;
          liffContext.utouId = liff.getContext().utouId;
          liffContext.groupId = liff.getContext().groupId;
          liffContext.roomId = liff.getContext().roomId;
        } catch (error) {
          debugLog('ç²å– LIFF ä¸Šä¸‹æ–‡éŒ¯èª¤', error);
        }
        
        const liffEnvironment = {};
        try {
          liffEnvironment.language = liff.getLanguage();
          liffEnvironment.version = liff.getVersion();
          liffEnvironment.isInClient = liff.isInClient();
          liffEnvironment.isLoggedIn = liff.isLoggedIn();
          liffEnvironment.os = liff.getOS();
        } catch (error) {
          debugLog('ç²å– LIFF ç’°å¢ƒéŒ¯èª¤', error);
        }
        
        const result = await callAPIWithRetry('register', {
          userId: userId,
          lineDisplayName: userProfile.displayName,
          realName: realName,
          phone: phone,
          liffContext: liffContext,
          liffEnvironment: liffEnvironment
        });
        
        if (result && result.success) {
          UIManager.showToast('è¨»å†ŠæˆåŠŸ', 'success');
          
          // æ›´æ–°ç”¨æˆ¶è³‡è¨Š
          isRegistered = true;
          userRegistrationData = result.userInfo;
          
          // æ›´æ–°å¿«å–
          const cacheKey = `registration_${userId}`;
          CacheManager.set(cacheKey, {
            registered: true,
            userInfo: userRegistrationData
          });
          
          // é‡æ–°è¼‰å…¥é¦–é 
          loadHomeContent();
          
        } else {
          throw new Error(result?.message || 'è¨»å†Šå¤±æ•—');
        }
        
      } catch (error) {
        debugLog('è¨»å†ŠéŒ¯èª¤', error);
        UIManager.showToast('è¨»å†Šå¤±æ•—: ' + error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    }
    
    /**
     * è™•ç†ç¹³è²»è¡¨å–®æäº¤
     */
    async function handlePaymentSubmit(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const paymentAmount = parseFloat(formData.get('paymentAmount'));
      const paymentMethod = formData.get('paymentMethod').trim();
      const paymentNote = formData.get('paymentNote').trim();
      
      // é©—è­‰
      if (!paymentAmount || paymentAmount <= 0) {
        UIManager.showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¹³è²»é‡‘é¡', 'error');
        return;
      }
      
      if (!paymentMethod) {
        UIManager.showToast('è«‹é¸æ“‡ç¹³è²»æ–¹å¼', 'error');
        return;
      }
      
      const noteValidation = FormValidator.validatePaymentNote(paymentNote);
      if (!noteValidation.valid) {
        UIManager.showToast(noteValidation.message, 'error');
        return;
      }
      
      const submitBtn = document.getElementById('paymentSubmitBtn');
      const originalText = submitBtn.innerHTML;
      
      try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span>è™•ç†ä¸­...</span>';
        
        // å†æ¬¡æª¢æŸ¥è¨‚å–®æ•¸æ“š
        if (!currentOrderSummary) {
          debugLog('è¨‚å–®æ•¸æ“šç‚ºç©º');
          
          // å˜—è©¦å¾ localStorage æ¢å¾©
          try {
            const savedOrderSummary = localStorage.getItem('currentOrderSummary');
            if (savedOrderSummary) {
              currentOrderSummary = JSON.parse(savedOrderSummary);
              debugLog('å¾ localStorage æ¢å¾©è¨‚å–®æ•¸æ“š', currentOrderSummary);
            }
          } catch (e) {
            debugLog('æ¢å¾©è¨‚å–®æ•¸æ“šå¤±æ•—', e);
          }
          
          if (!currentOrderSummary || !currentOrderSummary.orderId) {
            throw new Error('è¨‚å–®è³‡è¨Šä¸å®Œæ•´ï¼Œè«‹é‡æ–°æŸ¥è©¢è¨‚å–®');
          }
        }
        
        debugLog('é–‹å§‹è™•ç†ç¹³è²»æäº¤', {
          paymentAmount,
          paymentMethod,
          paymentNote,
          orderId: currentOrderSummary.orderId
        });
        
        submitBtn.innerHTML = '<span>æäº¤ä¸­...</span>';
        
        // æº–å‚™æäº¤è³‡æ–™ - ç¢ºä¿æ‰€æœ‰å¿…è¦æ¬„ä½éƒ½æœ‰æä¾›
        const submitData = {
          userId: userId,
          orderId: currentOrderSummary.orderId,
          lineName: userProfile.displayName,
          realName: userRegistrationData.realName,
          paymentAmount: paymentAmount,
          paymentMethod: paymentMethod,
          paymentNote: paymentNote || '',
          images: []  // ä¿æŒç©ºé™£åˆ—
        };
        
        debugLog('æº–å‚™æäº¤è³‡æ–™', submitData);
        
        // æäº¤è³‡æ–™
        const result = await callAPIWithRetry('submit-payment', submitData);
        
        if (result && result.success) {
          handleSubmitSuccess(result);
        } else {
          throw new Error(result?.message || 'æäº¤å¤±æ•—');
        }
        
      } catch (error) {
        debugLog('æäº¤ç¹³è²»å›å ±å¤±æ•—', error);
        UIManager.showToast('æäº¤å¤±æ•—: ' + error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    }
    
    /**
     * è™•ç†æäº¤æˆåŠŸ
     */
    function handleSubmitSuccess(result) {
      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
      const contentDiv = document.getElementById('paymentContent');
      contentDiv.innerHTML = `
        <div class="success">
          <h3>âœ… æäº¤æˆåŠŸ</h3>
          <p>æ‚¨çš„ç¹³è²»å›å ±å·²æˆåŠŸæäº¤ï¼Œæˆ‘å€‘å°‡ç›¡å¿«è™•ç†ã€‚</p>
          <p style="margin-top: 8px;">ç¹³è²»ç·¨è™Ÿ: ${result.paymentId}</p>
          <p>æäº¤æ™‚é–“: ${new Date(result.submittedAt).toLocaleString('zh-TW')}</p>
        </div>
        
        <button class="btn" onclick="switchTab('status', event)" style="margin-top: 16px;">
          æŸ¥çœ‹ç¹³è²»ç‹€æ…‹
        </button>
      `;
      
      UIManager.showToast('ç¹³è²»å›å ±æäº¤æˆåŠŸ', 'success');
      
      // æ¸…é™¤å¿«å–ä¸­çš„ç¹³è²»ç‹€æ…‹ï¼Œä»¥ä¾¿ä¸‹æ¬¡é‡æ–°è¼‰å…¥
      CacheManager.remove(`payment_status_${userId}`);
    }
    
    // ==================== å·¥å…·å‡½æ•¸ ====================
    
    /**
     * åˆ‡æ›æ¨™ç±¤é 
     */
    function switchTab(tabName, event) {
      if (event) {
        event.preventDefault();
      }
      
      debugLog('åˆ‡æ›æ¨™ç±¤é ', tabName);
      
      // æª¢æŸ¥æ˜¯å¦éœ€è¦è¨»å†Š
      if (!isRegistered && ['orders', 'payment', 'status'].includes(tabName)) {
        UIManager.showToast('è«‹å…ˆå®Œæˆå¯¦ååˆ¶ç™»è¨˜', 'warning');
        return;
      }
      
      // å¦‚æœå¾è¨‚å–®é åˆ‡æ›åˆ°ç¹³è²»é ï¼Œç¢ºä¿è¨‚å–®æ•¸æ“šå·²ä¿å­˜
      const currentTab = document.querySelector('.tab-content.active');
      if (currentTab && currentTab.id === 'orders' && tabName === 'payment' && currentOrderSummary) {
        // ç¢ºä¿è¨‚å–®æ•¸æ“šå·²ä¿å­˜åˆ° localStorage
        localStorage.setItem('currentOrderSummary', JSON.stringify(currentOrderSummary));
        debugLog('è¨‚å–®æ•¸æ“šå·²ä¿å­˜åˆ° localStorage', currentOrderSummary);
      }
      
      // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(content => {
        content.classList.remove('active');
      });
      
      // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
      const tabButtons = document.querySelectorAll('.tab-button');
      tabButtons.forEach(button => {
        button.classList.remove('active');
      });
      
      // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
      document.getElementById(tabName).classList.add('active');
      
      // è¨­ç½®æŒ‰éˆ•ç‚º active
      if (event && event.target.classList.contains('tab-button')) {
        event.target.classList.add('active');
      } else {
        document.querySelector(`.tab-button[onclick*="${tabName}"]`).classList.add('active');
      }
      
      // è¼‰å…¥æ¨™ç±¤å…§å®¹
      loadTabContent(tabName);
    }
    
    /**
     * é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
     */
    function showError(message) {
      document.getElementById('loadingContainer').style.display = 'none';
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('errorContainer').style.display = 'block';
      document.getElementById('errorMessage').textContent = message;
    }
    
    /**
     * å‘¼å« API ä¸¦è‡ªå‹•é‡è©¦
     */
    async function callAPIWithRetry(action, data, retryCount = 0) {
      try {
        debugLog(`å‘¼å« API: ${action}`, data);
        
        if (!isOnline) {
          throw new Error('ç¶²è·¯é€£ç·šä¸­æ–·');
        }
        
        const url = new URL(API_CONFIG.URL);
        url.searchParams.append('action', action);
        url.searchParams.append('data', JSON.stringify(data));
        
        const response = await fetch(url.toString(), {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP éŒ¯èª¤: ${response.status}`);
        }
        
        const result = await response.json();
        debugLog(`API å›æ‡‰: ${action}`, result);
        
        return result;
        
      } catch (error) {
        debugLog(`API éŒ¯èª¤ (${action}): ${error.message}`);
        
        // æª¢æŸ¥æ˜¯å¦éœ€è¦é‡è©¦
        if (retryCount < API_CONFIG.MAX_RETRIES) {
          debugLog(`é‡è©¦ API å‘¼å« (${retryCount + 1}/${API_CONFIG.MAX_RETRIES})`);
          
          // ç­‰å¾…ä¸€æ®µæ™‚é–“å¾Œé‡è©¦
          await new Promise(resolve => setTimeout(resolve, API_CONFIG.RETRY_DELAY));
          
          return callAPIWithRetry(action, data, retryCount + 1);
        }
        
        throw error;
      }
    }
    
    /**
     * è¼¸å‡ºé™¤éŒ¯æ—¥èªŒ
     */
    function debugLog(message, data) {
      if (window.debugMode) {
        if (data) {
          console.log(`[DEBUG] ${message}:`, data);
        } else {
          console.log(`[DEBUG] ${message}`);
        }
      }
    }
    
    // ==================== å·¥å…·é¡åˆ¥ ====================
    
    /**
     * UI ç®¡ç†å™¨
     */
    const UIManager = {
      /**
       * é¡¯ç¤º Toast è¨Šæ¯
       */
      showToast: function(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast';
        toast.classList.add(type);
        toast.classList.add('show');
        
        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      },
      
      /**
       * é¡¯ç¤ºè¼‰å…¥ä¸­
       */
      showLoading: function(containerId, message = 'è¼‰å…¥ä¸­...') {
        const container = document.getElementById(containerId);
        container.innerHTML = `
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>${message}</p>
          </div>
        `;
      },
      
      /**
       * é¡¯ç¤ºå¿«å–è³‡è¨Š
       */
      showCacheInfo: function(containerId, timestamp) {
        const container = document.getElementById(containerId);
        
        // æª¢æŸ¥æ˜¯å¦å·²æœ‰å¿«å–è³‡è¨Š
        if (container.querySelector('.cache-info')) {
          return;
        }
        
        // è¨ˆç®—æ™‚é–“å·®
        const now = new Date();
        const cacheTime = new Date(timestamp);
        const diffMinutes = Math.floor((now - cacheTime) / (1000 * 60));
        
        let timeText = '';
        if (diffMinutes < 1) {
          timeText = 'å‰›å‰›';
        } else if (diffMinutes < 60) {
          timeText = `${diffMinutes} åˆ†é˜å‰`;
        } else {
          const diffHours = Math.floor(diffMinutes / 60);
          if (diffHours < 24) {
            timeText = `${diffHours} å°æ™‚å‰`;
          } else {
            const diffDays = Math.floor(diffHours / 24);
            timeText = `${diffDays} å¤©å‰`;
          }
        }
        
        // å»ºç«‹å¿«å–è³‡è¨Šå…ƒç´ 
        const cacheInfo = document.createElement('div');
        cacheInfo.className = 'cache-info';
        cacheInfo.innerHTML = `
          <span>âš ï¸ é›¢ç·šæ¨¡å¼ï¼šé¡¯ç¤º ${timeText} çš„å¿«å–è³‡æ–™</span>
        `;
        
        container.appendChild(cacheInfo);
      }
    };
    
    /**
     * å¿«å–ç®¡ç†å™¨
     */
    const CacheManager = {
      /**
       * è¨­å®šå¿«å–
       */
      set: function(key, value, expiresInMinutes = 30) {
        try {
          const cacheItem = {
            value: value,
            expires: Date.now() + (expiresInMinutes * 60 * 1000)
          };
          
          localStorage.setItem(`cache_${key}`, JSON.stringify(cacheItem));
          debugLog(`å¿«å–å·²è¨­å®š: ${key}`);
        } catch (error) {
          debugLog(`è¨­å®šå¿«å–éŒ¯èª¤: ${error.message}`);
        }
      },
      
      /**
       * å–å¾—å¿«å–
       */
      get: function(key) {
        try {
          const cacheItem = localStorage.getItem(`cache_${key}`);
          
          if (!cacheItem) {
            return null;
          }
          
          const { value, expires } = JSON.parse(cacheItem);
          
          if (Date.now() > expires) {
            this.remove(key);
            return null;
          }
          
          return value;
        } catch (error) {
          debugLog(`å–å¾—å¿«å–éŒ¯èª¤: ${error.message}`);
          return null;
        }
      },
      
      /**
       * ç§»é™¤å¿«å–
       */
      remove: function(key) {
        try {
          localStorage.removeItem(`cache_${key}`);
          debugLog(`å¿«å–å·²ç§»é™¤: ${key}`);
        } catch (error) {
          debugLog(`ç§»é™¤å¿«å–éŒ¯èª¤: ${error.message}`);
        }
      },
      
      /**
       * æ¸…é™¤æ‰€æœ‰å¿«å–
       */
      clear: function() {
        try {
          const keysToRemove = [];
          
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            
            if (key.startsWith('cache_')) {
              keysToRemove.push(key);
            }
          }
          
          keysToRemove.forEach(key => localStorage.removeItem(key));
          debugLog(`å·²æ¸…é™¤ ${keysToRemove.length} å€‹å¿«å–é …ç›®`);
        } catch (error) {
          debugLog(`æ¸…é™¤å¿«å–éŒ¯èª¤: ${error.message}`);
        }
      }
    };
    
    /**
     * è¡¨å–®é©—è­‰å™¨
     */
    const FormValidator = {
      /**
       * é©—è­‰çœŸå¯¦å§“å
       */
      validateRealName: function(name) {
        if (!name || name.trim() === '') {
          return { valid: false, message: 'è«‹è¼¸å…¥çœŸå¯¦å§“å' };
        }
        
        if (name.length < 2) {
          return { valid: false, message: 'å§“åè‡³å°‘éœ€è¦2å€‹å­—' };
        }
        
        if (name.length > 20) {
          return { valid: false, message: 'å§“åä¸å¯è¶…é20å€‹å­—' };
        }
        
        // æª¢æŸ¥ç‰¹æ®Šå­—å…ƒ
        const invalidChars = /[<>"'&]/;
        if (invalidChars.test(name)) {
          return { valid: false, message: 'å§“åä¸å¯åŒ…å«ç‰¹æ®Šå­—å…ƒ' };
        }
        
        return { valid: true };
      },
      
      /**
       * é©—è­‰é›»è©±è™Ÿç¢¼
       */
      validatePhone: function(phone) {
        if (!phone || phone.trim() === '') {
          return { valid: true }; // é›»è©±æ˜¯é¸å¡«çš„
        }
        
        // åŸºæœ¬æ ¼å¼æª¢æŸ¥
        const phoneRegex = /^[0-9\-\+\(\)\s]{8,15}$/;
        if (!phoneRegex.test(phone)) {
          return { valid: false, message: 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»è©±è™Ÿç¢¼æ ¼å¼' };
        }
        
        return { valid: true };
      },
      
      /**
       * é©—è­‰ç¹³è²»å‚™è¨»
       */
      validatePaymentNote: function(note) {
        if (!note || note.trim() === '') {
          return { valid: true }; // å‚™è¨»æ˜¯é¸å¡«çš„
        }
        
        if (note.length > 200) {
          return { valid: false, message: 'å‚™è¨»ä¸å¯è¶…é200å€‹å­—' };
        }
        
        // æª¢æŸ¥å±éšªå­—å…ƒ
        const dangerousChars = /<script|javascript:|onerror=|onclick=|onload=/i;
        if (dangerousChars.test(note)) {
          return { valid: false, message: 'å‚™è¨»åŒ…å«ä¸å…è¨±çš„å…§å®¹' };
        }
        
        return { valid: true };
      }
    };
    
    /**
     * ç”¢å“è³‡æ–™è™•ç†å™¨
     */
    const ProductDataProcessor = {
      /**
       * è¨ˆç®—è¨‚å–®æ‘˜è¦
       */
      calculateSummary: function(products) {
        if (!products || !Array.isArray(products) || products.length === 0) {
          debugLog('ç„¡æ•ˆçš„ç”¢å“æ•¸æ“š', products);
          return {
            productCount: 0,
            totalQuantity: 0,
            totalAmount: 0
          };
        }
        
        try {
          // ç¢ºä¿æ‰€æœ‰æ•¸å€¼éƒ½æ˜¯æ•¸å­—
          const processedProducts = products.map(product => {
            return {
              ...product,
              quantity: parseInt(product.quantity) || 0,
              unitPrice: parseFloat(product.unitPrice) || 0,
              totalPrice: parseFloat(product.totalPrice) || 0
            };
          });
          
          // è¨ˆç®—ç¸½æ•¸é‡å’Œç¸½é‡‘é¡
          const totalQuantity = processedProducts.reduce((sum, product) => sum + product.quantity, 0);
          const totalAmount = processedProducts.reduce((sum, product) => sum + product.totalPrice, 0);
          
          return {
            productCount: processedProducts.length,
            totalQuantity: totalQuantity,
            totalAmount: totalAmount
          };
        } catch (error) {
          debugLog('è¨ˆç®—è¨‚å–®æ‘˜è¦éŒ¯èª¤', error);
          return {
            productCount: products.length,
            totalQuantity: 0,
            totalAmount: 0
          };
        }
      }
    };
    
    // ==================== äº‹ä»¶ç›£è½ ====================
    
    // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', function() {
      // å•Ÿç”¨é™¤éŒ¯æ¨¡å¼ï¼ˆé–‹ç™¼æ™‚ä½¿ç”¨ï¼‰
      window.debugMode = false;
      
      // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
      initializeApp();
    });
    
    // é é¢é—œé–‰æˆ–é‡æ–°æ•´ç†å‰çš„è™•ç†
    window.addEventListener('beforeunload', function() {
      // å„²å­˜é‡è¦è³‡æ–™åˆ° localStorage
      if (currentOrderSummary) {
        localStorage.setItem('currentOrderSummary', JSON.stringify(currentOrderSummary));
      }
    });
  </script>
</body>
</html>


