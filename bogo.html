<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>實名制登記與繳費系統</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 10px;
      }

      .container {
          max-width: 500px;
          margin: 0 auto;
          background: white;
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.2);
          overflow: hidden;
      }

      .header {
          background: linear-gradient(135deg, #4CAF50, #45a049);
          color: white;
          padding: 20px;
          text-align: center;
          position: relative;
      }

      .header h1 {
          font-size: 24px;
          margin-bottom: 5px;
      }

      .header p {
          opacity: 0.9;
          font-size: 14px;
      }

      /* 新增管理員按鈕 */
      .admin-btn {
          position: absolute;
          top: 10px;
          right: 10px;
          background: rgba(255,255,255,0.2);
          border: 1px solid rgba(255,255,255,0.3);
          color: white;
          padding: 5px 10px;
          border-radius: 15px;
          font-size: 12px;
          cursor: pointer;
          transition: all 0.3s;
      }

      .admin-btn:hover {
          background: rgba(255,255,255,0.3);
      }

      .content {
          padding: 20px;
      }

      .status-bar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #f8f9fa;
          padding: 10px 15px;
          border-radius: 8px;
          margin-bottom: 20px;
          font-size: 12px;
      }

      .status-item {
          display: flex;
          align-items: center;
          gap: 5px;
      }

      .status-indicator {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background: #dc3545;
          animation: pulse 2s infinite;
      }

      .status-indicator.success {
          background: #28a745;
          animation: none;
      }

      @keyframes pulse {
          0% { opacity: 1; }
          50% { opacity: 0.5; }
          100% { opacity: 1; }
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #333;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
          width: 100%;
          padding: 12px;
          border: 2px solid #e9ecef;
          border-radius: 8px;
          font-size: 16px;
          transition: all 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
          outline: none;
          border-color: #4CAF50;
          box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
      }

      /* 改進的按鈕樣式 */
      .btn {
          width: 100%;
          padding: 15px;
          background: linear-gradient(135deg, #4CAF50, #45a049);
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          margin-bottom: 10px;
          position: relative;
          overflow: hidden;
      }

      .btn:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
      }

      .btn:active {
          transform: translateY(0);
      }

      .btn:disabled {
          background: #ccc;
          cursor: not-allowed;
          transform: none;
          box-shadow: none;
      }

      .btn-secondary {
          background: linear-gradient(135deg, #6c757d, #5a6268);
      }

      .btn-secondary:hover:not(:disabled) {
          box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
      }

      .btn-danger {
          background: linear-gradient(135deg, #dc3545, #c82333);
      }

      .btn-danger:hover:not(:disabled) {
          box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
      }

      /* 改進的上傳區域 */
      .upload-area {
          border: 2px dashed #ddd;
          border-radius: 8px;
          padding: 40px 20px;
          text-align: center;
          cursor: pointer;
          transition: all 0.3s;
          background: #fafafa;
          position: relative;
      }

      .upload-area:hover {
          border-color: #4CAF50;
          background: #f0f8f0;
      }

      .upload-area.dragover {
          border-color: #4CAF50;
          background: #e8f5e8;
          transform: scale(1.02);
      }

      .upload-area.uploading::after {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(76, 175, 80, 0.1);
          display: flex;
          align-items: center;
          justify-content: center;
      }

      .upload-icon {
          font-size: 48px;
          margin-bottom: 10px;
          transition: transform 0.3s;
      }

      .upload-area:hover .upload-icon {
          transform: scale(1.1);
      }

      .upload-area p {
          margin: 10px 0 5px 0;
          font-weight: 600;
          color: #333;
      }

      .upload-area small {
          color: #666;
          font-size: 12px;
      }

      .section {
          display: none;
          animation: fadeIn 0.5s ease-in;
      }

      .section.active {
          display: block;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
      }

      /* 改進的訂單卡片 */
      .order-card {
          background: #f8f9fa;
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 15px;
          border-left: 4px solid #4CAF50;
          transition: all 0.3s;
      }

      .order-card:hover {
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          transform: translateY(-1px);
      }

      .order-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
      }

      .order-id {
          font-weight: 600;
          color: #333;
      }

      .order-status {
          background: #4CAF50;
          color: white;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 12px;
      }

      .order-status.pending {
          background: #ffc107;
          color: #212529;
      }

      .order-status.completed {
          background: #28a745;
      }

      .order-status.cancelled {
          background: #dc3545;
      }

      .order-details {
          font-size: 14px;
          color: #666;
          line-height: 1.5;
      }

      .total-amount {
          background: linear-gradient(135deg, #e3f2fd, #bbdefb);
          padding: 20px;
          border-radius: 12px;
          text-align: center;
          margin: 20px 0;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      .total-amount h3 {
          color: #1976d2;
          margin-bottom: 10px;
          font-size: 18px;
      }

      .total-amount .amount {
          font-size: 28px;
          font-weight: bold;
          color: #d32f2f;
          text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      }

      /* 改進的警告框 */
      .alert {
          padding: 15px 20px;
          border-radius: 8px;
          margin-bottom: 20px;
          font-size: 14px;
          border-left: 4px solid;
          position: relative;
      }

      .alert-success {
          background: #d4edda;
          color: #155724;
          border-left-color: #28a745;
      }

      .alert-error {
          background: #f8d7da;
          color: #721c24;
          border-left-color: #dc3545;
      }

      .alert-info {
          background: #d1ecf1;
          color: #0c5460;
          border-left-color: #17a2b8;
      }

      .alert-warning {
          background: #fff3cd;
          color: #856404;
          border-left-color: #ffc107;
      }

      /* 新增關閉按鈕 */
      .alert .close-btn {
          position: absolute;
          top: 10px;
          right: 15px;
          background: none;
          border: none;
          font-size: 18px;
          cursor: pointer;
          opacity: 0.7;
      }

      .alert .close-btn:hover {
          opacity: 1;
      }

      .loading {
          text-align: center;
          padding: 40px;
      }

      .loading::after {
          content: '';
          display: inline-block;
          width: 24px;
          height: 24px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid #4CAF50;
          border-radius: 50%;
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      /* 改進的除錯資訊 */
      .debug-info {
          background: #f8f9fa;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          padding: 15px;
          margin-top: 20px;
          font-family: 'Courier New', monospace;
          font-size: 11px;
          max-height: 250px;
          overflow-y: auto;
          white-space: pre-wrap;
      }

      .debug-info::-webkit-scrollbar {
          width: 6px;
      }

      .debug-info::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 3px;
      }

      .debug-info::-webkit-scrollbar-thumb {
          background: #c1c1c1;
          border-radius: 3px;
      }

      .maintenance-mode {
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          background: #f5f5f5;
      }

      .maintenance-card {
          text-align: center;
          padding: 40px;
          background: white;
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.1);
          max-width: 400px;
      }

      .maintenance-icon {
          font-size: 64px;
          margin-bottom: 20px;
          animation: bounce 2s infinite;
      }

      @keyframes bounce {
          0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
          40% { transform: translateY(-10px); }
          60% { transform: translateY(-5px); }
      }

      .hidden {
          display: none !important;
      }

      /* 新增進度條 */
      .progress-bar {
          width: 100%;
          height: 4px;
          background: #e9ecef;
          border-radius: 2px;
          overflow: hidden;
          margin-bottom: 20px;
      }

      .progress-fill {
          height: 100%;
          background: linear-gradient(90deg, #4CAF50, #45a049);
          border-radius: 2px;
          transition: width 0.3s ease;
      }

      /* 新增浮動通知 */
      .toast {
          position: fixed;
          top: 20px;
          right: 20px;
          background: white;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          padding: 15px 20px;
          z-index: 1000;
          transform: translateX(400px);
          transition: transform 0.3s ease;
      }

      .toast.show {
          transform: translateX(0);
      }

      .toast.success {
          border-left: 4px solid #28a745;
      }

      .toast.error {
          border-left: 4px solid #dc3545;
      }

      .toast.info {
          border-left: 4px solid #17a2b8;
      }

      /* 響應式設計改進 */
      @media (max-width: 480px) {
          .container {
              margin: 0;
              border-radius: 0;
              min-height: 100vh;
          }
          
          .content {
              padding: 15px;
          }
          
          .form-group input,
          .form-group select,
          .form-group textarea {
              font-size: 16px; /* 防止 iOS 縮放 */
          }

          .admin-btn {
              position: static;
              margin-top: 10px;
              display: inline-block;
          }

          .total-amount .amount {
              font-size: 24px;
          }

          .upload-area {
              padding: 30px 15px;
          }

          .upload-icon {
              font-size: 36px;
          }
      }

      /* 新增管理員面板樣式 */
      .admin-panel {
          background: #f8f9fa;
          border-radius: 8px;
          padding: 20px;
          margin-bottom: 20px;
      }

      .admin-tabs {
          display: flex;
          margin-bottom: 20px;
          border-bottom: 1px solid #dee2e6;
      }

      .admin-tab {
          padding: 10px 20px;
          background: none;
          border: none;
          cursor: pointer;
          border-bottom: 2px solid transparent;
          transition: all 0.3s;
      }

      .admin-tab.active {
          border-bottom-color: #4CAF50;
          color: #4CAF50;
          font-weight: 600;
      }

      .admin-tab:hover {
          background: rgba(76, 175, 80, 0.1);
      }

      .data-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 15px;
      }

      .data-table th,
      .data-table td {
          padding: 12px;
          text-align: left;
          border-bottom: 1px solid #dee2e6;
      }

      .data-table th {
          background: #f8f9fa;
          font-weight: 600;
          color: #495057;
      }

      .data-table tr:hover {
          background: #f8f9fa;
      }

      /* 新增搜尋框樣式 */
      .search-box {
          position: relative;
          margin-bottom: 20px;
      }

      .search-box input {
          padding-left: 40px;
      }

      .search-box::before {
          content: '🔍';
          position: absolute;
          left: 12px;
          top: 50%;
          transform: translateY(-50%);
          z-index: 1;
      }

      /* 新增統計卡片 */
      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 15px;
          margin-bottom: 20px;
      }

      .stat-card {
          background: white;
          padding: 20px;
          border-radius: 8px;
          text-align: center;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          transition: transform 0.3s;
      }

      .stat-card:hover {
          transform: translateY(-2px);
      }

      .stat-number {
          font-size: 24px;
          font-weight: bold;
          color: #4CAF50;
      }

      .stat-label {
          font-size: 12px;
          color: #666;
          margin-top: 5px;
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <button class="admin-btn" onclick="checkAndShowAdminPanel()" id="adminToggle" style="display: none;">
              🛠️ 管理
          </button>
          <h1>🎫 實名制登記系統</h1>
          <p>請完成實名制登記後查看訂單</p>
      </div>

      <!-- 狀態列 -->
      <div class="content">
          <div class="status-bar">
              <div class="status-item">
                  <div class="status-indicator" id="apiIndicator"></div>
                  <span id="apiStatus">連線檢查中...</span>
              </div>
              <div class="status-item">
                  <div class="status-indicator" id="liffIndicator"></div>
                  <span id="liffStatus">LIFF 初始化中...</span>
              </div>
          </div>

          <!-- 進度條 -->
          <div class="progress-bar" id="progressBar" style="display: none;">
              <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
          </div>

          <!-- LIFF 環境資訊 -->
          <div id="liffInfo" class="alert alert-info hidden">
              <button class="close-btn" onclick="this.parentElement.style.display='none'">×</button>
              <strong>LIFF 環境資訊：</strong>
              <div id="liffDetails"></div>
          </div>

          <!-- 載入中 -->
          <div id="loadingSection" class="section active">
              <div class="loading">
                  <p>系統初始化中，請稍候...</p>
              </div>
          </div>

          <!-- 實名制登記表單 -->
          <div id="registrationSection" class="section">
              <div class="alert alert-info">
                  <strong>📝 實名制登記</strong><br>
                  請填寫真實資料以完成登記，登記後即可查看您的訂單資訊。
              </div>

              <form id="registrationForm">
                  <div class="form-group">
                      <label for="lineName">LINE 顯示名稱</label>
                      <input type="text" id="lineName" readonly>
                  </div>

                  <div class="form-group">
                      <label for="realName">真實姓名 *</label>
                      <input type="text" id="realName" placeholder="請輸入真實姓名" required>
                  </div>

                  <div class="form-group">
                      <label for="idNumber">身分證字號 *</label>
                      <input type="text" id="idNumber" placeholder="例：A123456789" required maxlength="10" style="text-transform: uppercase;">
                  </div>

                  <div class="form-group">
                      <label for="phoneNumber">手機號碼 *</label>
                      <input type="tel" id="phoneNumber" placeholder="例：0912345678" required maxlength="10">
                  </div>

                  <button type="submit" class="btn" id="registerBtn">
                      完成實名制登記
                  </button>
              </form>
          </div>

          <!-- 訂單列表 -->
          <div id="ordersSection" class="section">
              <div class="alert alert-success">
                  <strong>✅ 已完成實名制登記</strong><br>
                  <span id="userInfo"></span>
              </div>

              <div id="ordersContainer">
                  <!-- 訂單將動態載入到這裡 -->
              </div>

              <div class="total-amount">
                  <h3>總應繳金額</h3>
                  <div class="amount" id="totalAmount">NT$ 0</div>
              </div>

              <button class="btn" id="proceedToPaymentBtn">
                  前往繳費
              </button>

              <button class="btn btn-secondary" id="refreshOrdersBtn">
                  🔄 重新整理訂單
              </button>
          </div>

          <!-- 繳費證明上傳 -->
          <div id="paymentSection" class="section">
              <div class="alert alert-info">
                  <strong>💳 上傳繳費證明</strong><br>
                  請選擇繳費方式並上傳相關證明文件。
              </div>

              <form id="paymentForm">
                  <div class="form-group">
                      <label for="paymentMethod">繳費方式 *</label>
                      <select id="paymentMethod" required>
                          <option value="">請選擇繳費方式</option>
                          <!-- 選項將從系統設定動態載入 -->
                      </select>
                  </div>

                  <div class="form-group">
                      <label>上傳繳費證明</label>
                      <div class="upload-area" onclick="document.getElementById('paymentProof').click()">
                          <div class="upload-icon">📷</div>
                          <p>點擊上傳繳費證明照片</p>
                          <small>支援 JPG、PNG、PDF 格式，檔案大小限制 5MB</small>
                      </div>
                      <input type="file" id="paymentProof" accept="image/*,.pdf" style="display: none;" onchange="handleFileUpload(this)">
                  </div>

                  <div class="form-group" id="noteFieldGroup">
                      <label for="paymentNote">備註（選填）</label>
                      <textarea id="paymentNote" rows="3" placeholder="如有特殊說明請在此填寫..."></textarea>
                  </div>

                  <button type="button" class="btn" id="submitPaymentBtn" onclick="submitPayment()">
                      提交繳費證明
                  </button>

                  <button type="button" class="btn btn-secondary" id="backToOrdersBtn">
                      ← 返回訂單列表
                  </button>
              </form>
          </div>

          <!-- 管理員面板 -->
          <div id="adminSection" class="section">
              <div class="admin-panel">
                  <div class="alert alert-success">
                      <strong>🛠️ 管理員面板</strong><br>
                      <span id="adminWelcome"></span>
                  </div>

                  <div class="admin-tabs">
                      <button class="admin-tab active" onclick="showAdminTab('dashboard')">儀表板</button>
                      <button class="admin-tab" onclick="showAdminTab('users')">用戶管理</button>
                      <button class="admin-tab" onclick="showAdminTab('payments')">繳費管理</button>
                      <button class="admin-tab" onclick="showAdminTab('admins')">管理員</button>
                  </div>

                  <div id="adminContent">
                      <!-- 管理員內容將載入到這裡 -->
                  </div>

                  <button class="btn btn-secondary" onclick="backToMainSystem()">
                      ← 返回主系統
                  </button>
              </div>
          </div>

          <!-- 除錯資訊 -->
          <div id="debugInfo" class="debug-info hidden">
              <strong>🐛 除錯資訊：</strong>
              <div id="debugContent"></div>
          </div>
      </div>
  </div>

  <!-- 浮動通知模板 -->
  <div id="toastTemplate" class="toast" style="display: none;">
      <div class="toast-content"></div>
  </div>

  <script>
      // ==================== 全域設定 ====================
      const CONFIG = {
          LIFF_ID: '1657285806-2bmkYWkN', // 請替換為您的 LIFF ID
          API_BASE_URL: 'https://script.google.com/macros/s/AKfycbwR7eO2Tikx7XftsmsLUZhlDW1-LZ6LA8K9o7FA118U01WO1Jz5ZBX5vSbdZ9jFDAxj/exec',
          DEBUG_MODE: true,
          DEMO_MODE: false,
          RETRY_ATTEMPTS: 3,
          RETRY_DELAY: 1000
      };

      // ==================== 全域變數 ====================
      let liffProfile = null;
      let systemConfig = null;
      let currentOrderSummary = null;
      let debugLogs = [];
      let isAdminUser = false;
      let currentAdminTab = 'dashboard';

      // ==================== 改進的工具函數 ====================

      // 顯示浮動通知
      function showToast(message, type = 'info', duration = 3000) {
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          toast.innerHTML = `<div class="toast-content">${message}</div>`;
          
          document.body.appendChild(toast);
          
          // 觸發顯示動畫
          setTimeout(() => toast.classList.add('show'), 100);
          
          // 自動移除
          setTimeout(() => {
              toast.classList.remove('show');
              setTimeout(() => document.body.removeChild(toast), 300);
          }, duration);
      }

      // 改進的進度顯示
      function showProgress(percentage) {
          const progressBar = document.getElementById('progressBar');
          const progressFill = document.getElementById('progressFill');
          
          if (percentage > 0) {
              progressBar.style.display = 'block';
              progressFill.style.width = percentage + '%';
          } else {
              progressBar.style.display = 'none';
          }
      }

      // 改進的 API 呼叫（含重試機制）
      async function callAPIWithRetry(action, data = {}, retryCount = 0) {
          try {
              showProgress(25 + (retryCount * 25));
              
              const result = await callAPI(action, data);
              showProgress(100);
              
              setTimeout(() => showProgress(0), 500);
              return result;
              
          } catch (error) {
              if (retryCount < CONFIG.RETRY_ATTEMPTS) {
                  debugLog(`API 呼叫失敗，重試 ${retryCount + 1}/${CONFIG.RETRY_ATTEMPTS}`, error);
                    await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * (retryCount + 1)));
                    return callAPIWithRetry(action, data, retryCount + 1);
                } else {
                    showProgress(0);
                    throw error;
                }
            }
        }

        // 改進的除錯日誌
        function debugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            if (data) {
                console.log(logEntry, data);
                debugLogs.push({ timestamp, message, data: JSON.stringify(data, null, 2) });
            } else {
                console.log(logEntry);
                debugLogs.push({ timestamp, message });
            }
            
            updateDebugDisplay();
        }

        // 更新除錯顯示
        function updateDebugDisplay() {
            if (!CONFIG.DEBUG_MODE) return;
            
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                const recentLogs = debugLogs.slice(-15);
                debugContent.textContent = recentLogs.map(log => {
                    let logText = `${log.timestamp} - ${log.message}`;
                    if (log.data) {
                        logText += `\n${log.data}`;
                    }
                    return logText;
                }).join('\n\n');
                
                // 自動滾動到底部
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }

        // 改進的區域顯示
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                debugLog(`顯示區域: ${sectionId}`);
            }
        }

        // 改進的成功/錯誤訊息
        function showSuccess(message) {
            showToast(message, 'success', 4000);
        }

        function showError(message) {
            showToast(message, 'error', 6000);
        }

        function showInfo(message) {
            showToast(message, 'info', 3000);
        }

        // ==================== API 相關函數 ====================

        // 原有的 callAPI 函數保持不變
        async function callAPI(action, data = {}) {
            try {
                debugLog(`API 呼叫: ${action}`, data);
                
                if (CONFIG.DEMO_MODE) {
                    return getDemoData(action, data);
                }
                
                const params = new URLSearchParams({
                    action: action,
                    data: JSON.stringify(data),
                    callback: 'handleAPIResponse',
                    _: Date.now()
                });
                
                return new Promise((resolve, reject) => {
                    window.handleAPIResponse = (response) => {
                        debugLog(`API 回應: ${action}`, response);
                        resolve(response);
                        delete window.handleAPIResponse;
                    };
                    
                    const script = document.createElement('script');
                    script.src = `${CONFIG.API_BASE_URL}?${params}`;
                    script.onerror = () => {
                        reject(new Error('API 呼叫失敗'));
                        delete window.handleAPIResponse;
                    };
                    
                    document.head.appendChild(script);
                    
                    setTimeout(() => {
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                        }
                    }, 1000);
                    
                    setTimeout(() => {
                        if (window.handleAPIResponse) {
                            reject(new Error('API 呼叫逾時'));
                            delete window.handleAPIResponse;
                        }
                    }, 15000);
                });
                
            } catch (error) {
                debugLog(`API 呼叫失敗: ${action}`, error);
                throw error;
            }
        }

        // 示範資料函數保持不變
        function getDemoData(action, data) {
            debugLog(`使用示範資料: ${action}`, data);
            
            switch (action) {
                case 'test':
                    return { success: true, message: 'API 連線測試成功（示範模式）' };
                    
                case 'get-config':
                    return {
                        success: true,
                        config: {
                            basic: {
                                'API連線狀態顯示': true,
                                '除錯資訊顯示': true,
                                'LIFF環境資訊顯示': true,
                                '繳費證明上傳': '必須',
                                '備註欄位顯示': true,
                                '系統維護模式': false,
                                '最大檔案大小MB': 5,
                                '允許檔案格式': ['jpg', 'png', 'pdf']
                            },
                            paymentMethods: [
                                { code: 'bank_transfer', name: '銀行轉帳', enabled: true },
                                { code: 'cash', name: '現金繳費', enabled: true },
                                { code: 'atm', name: 'ATM轉帳', enabled: true }
                            ],
                            messages: {
                                welcome_message: '歡迎使用本系統！',
                                upload_success: '繳費證明上傳成功！',
                                upload_error: '上傳失敗，請檢查檔案格式',
                                registration_success: '實名制登記完成！'
                            }
                        }
                    };
                    
                case 'check-registration':
                    return { success: true, registered: false };
                    
                case 'register':
                    return {
                        success: true,
                        message: '實名制登記完成（示範模式）',
                        userData: {
                            lineName: data.lineName,
                            realName: data.realName,
                            idNumber: data.idNumber,
                            phoneNumber: data.phoneNumber,
                            registrationTime: new Date(),
                            status: '已登記'
                        }
                    };
                    
                case 'orders':
                    return {
                        success: true,
                        orders: [
                            {
                                orderId: 'ORDER001',
                                lineName: data.lineName,
                                realName: '示範用戶',
                                productName: '示範商品A',
                                quantity: 2,
                                unitPrice: 500,
                                totalPrice: 1000,
                                status: '待付款',
                                createdAt: new Date(),
                                note: '示範訂單'
                            }
                        ],
                        totalAmount: 1000,
                        userData: {
                            lineName: data.lineName,
                            realName: '示範用戶',
                            status: '已登記'
                        }
                    };
                    
                case 'submit-payment':
                    return { success: true, message: '繳費證明提交成功（示範模式）' };
                    
                case 'check-admin':
                    return {
                        success: true,
                        isAdmin: true,
                        role: 'admin',
                        adminData: { name: '示範管理員', lineId: data.userId }
                    };
                    
                default:
                    return { success: false, message: '未知的示範操作' };
            }
        }

        // ==================== 管理員功能 ====================

        // 檢查並顯示管理員面板
        async function checkAndShowAdminPanel() {
            try {
                if (!liffProfile) {
                    showError('請先登入 LINE');
                    return;
                }
                
                const result = await callAPIWithRetry('check-admin', {
                    userId: liffProfile.userId,
                    requiredRole: 'viewer'
                });
                
                if (result.success && result.isAdmin) {
                    isAdminUser = true;
                    showAdminPanel(result);
                } else {
                    showError('您沒有管理員權限');
                }
                
            } catch (error) {
                debugLog('檢查管理員權限失敗', error);
                showError('權限檢查失敗');
            }
        }

        // 顯示管理員面板
        function showAdminPanel(adminInfo) {
            const adminWelcome = document.getElementById('adminWelcome');
            if (adminWelcome) {
                adminWelcome.textContent = `歡迎，${adminInfo.adminData.name}（${adminInfo.role}）`;
            }
            
            showSection('adminSection');
            showAdminTab('dashboard');
        }

        // 顯示管理員標籤頁
        async function showAdminTab(tabName) {
            // 更新標籤狀態
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`[onclick="showAdminTab('${tabName}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            currentAdminTab = tabName;
            const adminContent = document.getElementById('adminContent');
            
            try {
                switch (tabName) {
                    case 'dashboard':
                        await loadAdminDashboard();
                        break;
                    case 'users':
                        await loadUserManagement();
                        break;
                    case 'payments':
                        await loadPaymentManagement();
                        break;
                    case 'admins':
                        await loadAdminManagement();
                        break;
                }
            } catch (error) {
                debugLog(`載入管理員標籤頁失敗: ${tabName}`, error);
                adminContent.innerHTML = `<div class="alert alert-error">載入失敗: ${error.message}</div>`;
            }
        }

        // 載入管理員儀表板
        async function loadAdminDashboard() {
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">-</div>
                        <div class="stat-label">總用戶數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalOrders">-</div>
                        <div class="stat-label">總訂單數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingPayments">-</div>
                        <div class="stat-label">待審核繳費</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalAmount">-</div>
                        <div class="stat-label">總金額</div>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <strong>📊 系統統計</strong><br>
                    載入中...
                </div>
            `;
            
            // 這裡可以加載實際的統計資料
            // 示範資料
            setTimeout(() => {
                document.getElementById('totalUsers').textContent = '128';
                document.getElementById('totalOrders').textContent = '256';
                document.getElementById('pendingPayments').textContent = '12';
                document.getElementById('totalAmount').textContent = 'NT$ 128,000';
            }, 1000);
        }

        // 載入用戶管理
        async function loadUserManagement() {
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="search-box">
                    <input type="text" placeholder="搜尋用戶..." onkeyup="searchUsers(this.value)">
                </div>
                
                <div class="alert alert-info">
                    <strong>👥 用戶管理</strong><br>
                    管理所有註冊用戶
                </div>
                
                <div id="usersList">載入中...</div>
            `;
            
            // 載入用戶列表
            setTimeout(() => {
                document.getElementById('usersList').innerHTML = `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-id">示範用戶1</div>
                            <div class="order-status">已登記</div>
                        </div>
                        <div class="order-details">
                            <div>LINE: 示範用戶1</div>
                            <div>註冊時間: 2024-01-15 10:30</div>
                            <div>訂單數: 3</div>
                        </div>
                    </div>
                `;
            }, 1000);
        }

        // 載入繳費管理
        async function loadPaymentManagement() {
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="alert alert-warning">
                    <strong>💳 繳費管理</strong><br>
                    審核用戶提交的繳費證明
                </div>
                
                <div class="admin-tabs" style="margin-top: 20px;">
                    <button class="admin-tab active" onclick="filterPayments('pending')">待審核</button>
                    <button class="admin-tab" onclick="filterPayments('approved')">已確認</button>
                    <button class="admin-tab" onclick="filterPayments('rejected')">已拒絕</button>
                </div>
                
                <div id="paymentsList">載入中...</div>
            `;
            
            // 載入繳費列表
            setTimeout(() => {
                document.getElementById('paymentsList').innerHTML = `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-id">PAY001</div>
                            <div class="order-status pending">待審核</div>
                        </div>
                        <div class="order-details">
                            <div>用戶: 示範用戶</div>
                            <div>金額: NT$ 1,000</div>
                            <div>方式: 銀行轉帳</div>
                            <div>提交時間: 2024-01-15 14:20</div>
                            <div style="margin-top: 10px;">
                                <button class="btn" style="padding: 5px 15px; margin-right: 10px;" onclick="reviewPayment('PAY001', 'approved')">確認</button>
                                <button class="btn btn-danger" style="padding: 5px 15px;" onclick="reviewPayment('PAY001', 'rejected')">拒絕</button>
                            </div>
                        </div>
                    </div>
                `;
            }, 1000);
        }

        // 載入管理員管理
        async function loadAdminManagement() {
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="alert alert-success">
                    <strong>🛠️ 管理員管理</strong><br>
                    管理系統管理員
                </div>
                
                <button class="btn" onclick="showAddAdminForm()" style="margin-bottom: 20px;">
                    ➕ 新增管理員
                </button>
                
                <div id="adminsList">載入中...</div>
            `;
            
            // 載入管理員列表
            setTimeout(() => {
                document.getElementById('adminsList').innerHTML = `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-id">系統管理員</div>
                            <div class="order-status">admin</div>
                        </div>
                        <div class="order-details">
                            <div>LINE ID: ${liffProfile?.userId || 'U1234567890'}</div>
                            <div>權限: 系統管理員</div>
                        </div>
                    </div>
                `;
            }, 1000);
        }

        // 搜尋用戶
        function searchUsers(keyword) {
            debugLog('搜尋用戶', { keyword });
            // 實作搜尋邏輯
        }

        // 篩選繳費記錄
        function filterPayments(status) {
            debugLog('篩選繳費記錄', { status });
            // 實作篩選邏輯
        }

        // 審核繳費
        function reviewPayment(paymentId, status) {
            if (confirm(`確定要${status === 'approved' ? '確認' : '拒絕'}此繳費記錄嗎？`)) {
                debugLog('審核繳費', { paymentId, status });
                showSuccess(`繳費記錄已${status === 'approved' ? '確認' : '拒絕'}`);
                // 重新載入列表
                loadPaymentManagement();
            }
        }

        // 返回主系統
        function backToMainSystem() {
            if (currentOrderSummary) {
                showSection('ordersSection');
            } else {
                showSection('registrationSection');
            }
        }

        // ==================== 初始化和事件處理 ====================

        // 初始化 LIFF
        async function initializeLiff() {
            try {
                debugLog('開始初始化 LIFF');
                showProgress(10);
                
                // 先載入系統設定
                await loadSystemConfig();
                showProgress(30);
                
                // 檢查系統維護模式
                if (systemConfig?.basic?.['系統維護模式']) {
                    showMaintenanceMode();
                    return;
                }
                
                updateLiffStatus('初始化中...', false);
                
                if (typeof liff === 'undefined') {
                    throw new Error('LIFF SDK 未載入');
                }
                
                await liff.init({ liffId: CONFIG.LIFF_ID });
                debugLog('LIFF 初始化成功');
                showProgress(60);
                
                // 檢查登入狀態
                if (liff.isLoggedIn()) {
                    debugLog('用戶已登入 LINE');
                    
                    // 取得用戶資料
                    liffProfile = await liff.getProfile();
                    debugLog('取得用戶資料', liffProfile);
                    showProgress(80);
                    
                    // 顯示 LIFF 環境資訊
                    displayLiffInfo();
                    
                    // 填入 LINE 名稱
                    const lineNameInput = document.getElementById('lineName');
                    if (lineNameInput) {
                        lineNameInput.value = liffProfile.displayName;
                    }
                    
                    // 檢查管理員權限
                    await checkAdminPermission();
                    
                    // 檢查用戶登記狀態
                    await checkRegistrationStatus();
                    showProgress(100);
                    
                    updateLiffStatus('已連線', true);
                } else {
                    debugLog('用戶未登入，導向登入頁面');
                    liff.login();
                }
                
                setTimeout(() => showProgress(0), 500);
                
            } catch (error) {
                debugLog('LIFF 初始化失敗', error);
                console.error('LIFF 初始化失敗:', error);
                updateLiffStatus('連線失敗', false);
                showError('系統初始化失敗，請重新整理頁面');
                showProgress(0);
                
                // 如果是開發模式，使用示範資料
                if (CONFIG.DEMO_MODE) {
                    liffProfile = { displayName: '示範用戶', userId: 'demo123' };
                    document.getElementById('lineName').value = liffProfile.displayName;
                    await checkRegistrationStatus();
                }
            }
        }

        // 檢查管理員權限
        async function checkAdminPermission() {
            try {
                if (!liffProfile) return;
                
                const result = await callAPI('check-admin', {
                    userId: liffProfile.userId,
                    requiredRole: 'viewer'
                });
                
                if (result.success && result.isAdmin) {
                    isAdminUser = true;
                    const adminToggle = document.getElementById('adminToggle');
                    if (adminToggle) {
                        adminToggle.style.display = 'block';
                    }
                    debugLog('用戶具有管理員權限', result);
                }
                
            } catch (error) {
                debugLog('檢查管理員權限時發生錯誤', error);
                // 不影響正常流程，靜默處理
            }
        }

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('頁面載入完成，開始初始化');
            
            // 檢查 API 連線狀態
            await checkAPIStatus();
            
            // 初始化 LIFF
            await initializeLiff();
            
            // 綁定事件處理器
            setupEventHandlers();
        });

        // 設定事件處理器
        function setupEventHandlers() {
            // 實名制登記表單
            const registrationForm = document.getElementById('registrationForm');
            if (registrationForm) {
                registrationForm.addEventListener('submit', handleRegistration);
            }
            
            // 身分證字號自動轉大寫
            const idNumberInput = document.getElementById('idNumber');
            if (idNumberInput) {
                idNumberInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.toUpperCase();
                });
            }
            
            // 手機號碼格式化
            const phoneNumberInput = document.getElementById('phoneNumber');
            if (phoneNumberInput) {
                phoneNumberInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 10) {
                        value = value.slice(0, 10);
                    }
                    e.target.value = value;
                });
            }
            
            // 前往繳費按鈕
            const proceedToPaymentBtn = document.getElementById('proceedToPaymentBtn');
            if (proceedToPaymentBtn) {
                proceedToPaymentBtn.addEventListener('click', () => {
                    showSection('paymentSection');
                });
            }
            
            // 重新整理訂單按鈕
            const refreshOrdersBtn = document.getElementById('refreshOrdersBtn');
            if (refreshOrdersBtn) {
                refreshOrdersBtn.addEventListener('click', async () => {
                    refreshOrdersBtn.disabled = true;
                    refreshOrdersBtn.textContent = '🔄 重新整理中...';
                    
                    try {
                        await loadUserOrders();
                        showSuccess('訂單已更新');
                    } catch (error) {
                        showError('更新失敗');
                    } finally {
                        refreshOrdersBtn.disabled = false;
                        refreshOrdersBtn.textContent = '🔄 重新整理訂單';
                    }
                });
            }
            
            // 返回訂單列表按鈕
            const backToOrdersBtn = document.getElementById('backToOrdersBtn');
            if (backToOrdersBtn) {
                backToOrdersBtn.addEventListener('click', () => {
                    showSection('ordersSection');
                });
            }
            
            // 檔案拖放處理
            setupFileUpload();
            
            debugLog('事件處理器設定完成');
        }

        // 設定檔案上傳功能
        function setupFileUpload() {
            const uploadArea = document.querySelector('.upload-area');
            if (!uploadArea) return;
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const paymentProofInput = document.getElementById('paymentProof');
                    if (paymentProofInput) {
                        paymentProofInput.files = files;
                        handleFileUpload(paymentProofInput);
                    }
                }
            });
        }

        // 其他必要函數（保持原有邏輯）
        async function loadSystemConfig() {
            // 原有邏輯保持不變
            try {
                debugLog('載入系統設定');
                
                const result = await callAPI('get-config', {});
                
                if (result.success) {
                    systemConfig = result.config;
                    debugLog('系統設定載入成功', systemConfig);
                    applySystemConfig();
                    return true;
                } else {
                    debugLog('載入系統設定失敗', result);
                    systemConfig = getDefaultFrontendConfig();
                    applySystemConfig();
                    return false;
                }
            } catch (error) {
                debugLog('載入系統設定失敗', error);
                console.error('載入系統設定失敗:', error);
                systemConfig = getDefaultFrontendConfig();
                applySystemConfig();
                return false;
            }
        }

        function getDefaultFrontendConfig() {
            return {
                basic: {
                    'API連線狀態顯示': true,
                    '除錯資訊顯示': false,
                    'LIFF環境資訊顯示': false,
                    '繳費證明上傳': '必須',
                    '備註欄位顯示': true,
                    '系統維護模式': false,
                    '最大檔案大小MB': 5,
                    '允許檔案格式': ['jpg', 'png', 'pdf']
                },
                paymentMethods: [
                    { code: 'bank_transfer', name: '銀行轉帳', enabled: true },
                    { code: 'cash', name: '現金繳費', enabled: true }
                ],
                messages: {
                    welcome_message: '歡迎使用本系統！',
                    upload_success: '繳費證明上傳成功！',
                    upload_error: '上傳失敗，請檢查檔案格式',
                    registration_success: '實名制登記完成！'
                }
            };
        }

        function applySystemConfig() {
            if (!systemConfig) return;
            
            const config = systemConfig.basic;
            
            // 控制各種顯示設定
            const statusBar = document.querySelector('.status-bar');
            if (statusBar) {
                statusBar.style.display = config['API連線狀態顯示'] ? 'flex' : 'none';
            }
            
            CONFIG.DEBUG_MODE = config['除錯資訊顯示'];
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo) {
                debugInfo.classList.toggle('hidden', !CONFIG.DEBUG_MODE);
            }
            
            const liffInfo = document.getElementById('liffInfo');
            if (liffInfo) {
                liffInfo.classList.toggle('hidden', !config['LIFF環境資訊顯示']);
            }
            
            if (config['系統維護模式']) {
                showMaintenanceMode();
                return;
            }
            
            updatePaymentMethods();
            updateFileUploadSettings();
            updateNoteFieldVisibility();
            
            debugLog('系統設定已套用', config);
        }

        function showMaintenanceMode() {
            const message = systemConfig?.messages?.maintenance_message || '系統維護中，請稍後再試';
            
            document.body.innerHTML = `
                <div class="maintenance-mode">
                    <div class="maintenance-card">
                        <div class="maintenance-icon">🔧</div>
                        <h2 style="color: #333; margin-bottom: 10px;">系統維護中</h2>
                        <p style="color: #666;">${message}</p>
                    </div>
                </div>
            `;
        }

        function updatePaymentMethods() {
            const paymentMethodSelect = document.getElementById('paymentMethod');
            if (!paymentMethodSelect || !systemConfig?.paymentMethods) return;
            
            const firstOption = paymentMethodSelect.firstElementChild;
            paymentMethodSelect.innerHTML = '';
            paymentMethodSelect.appendChild(firstOption);
            
            systemConfig.paymentMethods.forEach(method => {
                const option = document.createElement('option');
                option.value = method.code;
                option.textContent = method.name;
                paymentMethodSelect.appendChild(option);
            });
            
            debugLog('繳費方式選項已更新', systemConfig.paymentMethods);
        }

        function updateFileUploadSettings() {
            const config = systemConfig?.basic || {};
            const paymentProofInput = document.getElementById('paymentProof');
            const uploadArea = document.querySelector('.upload-area');
            
            if (!paymentProofInput || !uploadArea) return;
            
            const             isRequired = config['繳費證明上傳'] === '必須';
            
            if (!isRequired) {
                const uploadText = uploadArea.querySelector('p');
                if (uploadText) {
                    uploadText.textContent = '點擊上傳繳費證明照片（選填）';
                }
            }
            
            const allowedFormats = config['允許檔案格式'];
            if (allowedFormats && Array.isArray(allowedFormats)) {
                const acceptString = allowedFormats.map(format => {
                    if (format === 'jpg') return 'image/jpeg';
                    if (format === 'png') return 'image/png';
                    if (format === 'pdf') return 'application/pdf';
                    return `image/${format}`;
                }).join(',');
                
                paymentProofInput.setAttribute('accept', acceptString);
                
                const uploadText = uploadArea.querySelector('small');
                if (uploadText) {
                    uploadText.textContent = `支援 ${allowedFormats.join(', ').toUpperCase()} 格式，檔案大小限制 ${config['最大檔案大小MB'] || 5}MB`;
                }
            }
            
            const maxSizeMB = config['最大檔案大小MB'] || 5;
            paymentProofInput.setAttribute('data-max-size', maxSizeMB * 1024 * 1024);
            
            debugLog('檔案上傳設定已更新', {
                required: isRequired,
                formats: allowedFormats,
                maxSize: maxSizeMB
            });
        }

        function updateNoteFieldVisibility() {
            const noteFieldGroup = document.getElementById('noteFieldGroup');
            if (noteFieldGroup) {
                const showNote = systemConfig?.basic?.['備註欄位顯示'];
                noteFieldGroup.style.display = showNote ? 'block' : 'none';
            }
        }

        function displayLiffInfo() {
            if (!systemConfig?.basic?.['LIFF環境資訊顯示']) return;
            
            const liffDetails = document.getElementById('liffDetails');
            if (liffDetails && liffProfile) {
                liffDetails.innerHTML = `
                    <div>用戶ID: ${liffProfile.userId}</div>
                    <div>顯示名稱: ${liffProfile.displayName}</div>
                    <div>環境: ${liff.getOS()}</div>
                    <div>版本: ${liff.getVersion()}</div>
                `;
                document.getElementById('liffInfo').classList.remove('hidden');
            }
        }

        function updateLiffStatus(message, success) {
            const liffIndicator = document.getElementById('liffIndicator');
            const liffStatus = document.getElementById('liffStatus');
            
            if (liffIndicator && liffStatus) {
                liffIndicator.className = `status-indicator ${success ? 'success' : ''}`;
                liffStatus.textContent = message;
            }
        }

        async function checkAPIStatus() {
            try {
                debugLog('檢查 API 連線狀態');
                updateAPIStatus('檢查中...', false);
                
                const result = await callAPI('test');
                
                if (result.success) {
                    debugLog('API 連線正常', result);
                    updateAPIStatus('連線正常', true);
                    return true;
                } else {
                    debugLog('API 連線異常', result);
                    updateAPIStatus('連線異常', false);
                    return false;
                }
            } catch (error) {
                debugLog('API 連線檢查失敗', error);
                updateAPIStatus('連線失敗', false);
                return false;
            }
        }

        function updateAPIStatus(message, success) {
            const apiIndicator = document.getElementById('apiIndicator');
            const apiStatus = document.getElementById('apiStatus');
            
            if (apiIndicator && apiStatus) {
                apiIndicator.className = `status-indicator ${success ? 'success' : ''}`;
                apiStatus.textContent = message;
            }
        }

        async function checkRegistrationStatus() {
            try {
                debugLog('檢查用戶登記狀態');
                
                if (!liffProfile) {
                    showError('無法取得用戶資料');
                    return;
                }
                
                const result = await callAPIWithRetry('check-registration', {
                    lineName: liffProfile.displayName
                });
                
                if (result.success) {
                    if (result.registered) {
                        debugLog('用戶已完成登記', result.userData);
                        await loadUserOrders();
                    } else {
                        debugLog('用戶尚未登記');
                        showSection('registrationSection');
                    }
                } else {
                    debugLog('檢查登記狀態失敗', result);
                    showError(result.message || '檢查登記狀態失敗');
                }
                
            } catch (error) {
                debugLog('檢查登記狀態失敗', error);
                console.error('檢查登記狀態失敗:', error);
                showError('檢查登記狀態失敗，請稍後再試');
            }
        }

        async function handleRegistration(event) {
            event.preventDefault();
            
            try {
                debugLog('處理用戶登記');
                
                const formData = {
                    lineName: document.getElementById('lineName').value,
                    realName: document.getElementById('realName').value,
                    idNumber: document.getElementById('idNumber').value.toUpperCase(),
                    phoneNumber: document.getElementById('phoneNumber').value
                };
                
                // 前端驗證
                if (!formData.realName || !formData.idNumber || !formData.phoneNumber) {
                    showError('請填寫所有必要欄位');
                    return;
                }
                
                const idPattern = /^[A-Z][12]\d{8}$/;
                if (!idPattern.test(formData.idNumber)) {
                    showError('身分證字號格式不正確');
                    return;
                }
                
                const phonePattern = /^09\d{8}$/;
                if (!phonePattern.test(formData.phoneNumber)) {
                    showError('電話號碼格式不正確（請輸入09開頭的手機號碼）');
                    return;
                }
                
                const submitBtn = document.getElementById('registerBtn');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '登記中...';
                submitBtn.disabled = true;
                
                const result = await callAPIWithRetry('register', formData);
                
                if (result.success) {
                    debugLog('用戶登記成功', result);
                    const successMessage = systemConfig?.messages?.registration_success || '實名制登記完成！';
                    showSuccess(successMessage);
                    
                    setTimeout(async () => {
                        await loadUserOrders();
                    }, 1500);
                } else {
                    debugLog('用戶登記失敗', result);
                    showError(result.message || '登記失敗，請稍後再試');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
                
            } catch (error) {
                debugLog('用戶登記失敗', error);
                console.error('用戶登記失敗:', error);
                showError('登記失敗，請稍後再試');
                
                const submitBtn = document.getElementById('registerBtn');
                if (submitBtn) {
                    submitBtn.textContent = '完成實名制登記';
                    submitBtn.disabled = false;
                }
            }
        }

        async function loadUserOrders() {
            try {
                debugLog('載入用戶訂單');
                
                if (!liffProfile) {
                    showError('無法取得用戶資料');
                    return;
                }
                
                const result = await callAPIWithRetry('orders', {
                    lineName: liffProfile.displayName
                });
                
                if (result.success) {
                    debugLog('訂單載入成功', result);
                    
                    const userInfo = document.getElementById('userInfo');
                    if (userInfo && result.userData) {
                        userInfo.textContent = `姓名：${result.userData.realName} | 登記時間：${new Date(result.userData.registrationTime).toLocaleString()}`;
                    }
                    
                    displayOrders(result.orders, result.totalAmount);
                    
                    currentOrderSummary = {
                        orders: result.orders,
                        totalAmount: result.totalAmount,
                        userData: result.userData,
                        lineName: liffProfile.displayName,
                        realName: result.userData.realName,
                        orderId: result.orders.map(o => o.orderId).join(',')
                    };
                    
                    showSection('ordersSection');
                } else {
                    debugLog('載入訂單失敗', result);
                    if (result.needRegistration) {
                        showSection('registrationSection');
                    } else {
                        showError(result.message || '載入訂單失敗');
                    }
                }
                
            } catch (error) {
                debugLog('載入訂單失敗', error);
                console.error('載入訂單失敗:', error);
                showError('載入訂單失敗，請稍後再試');
            }
        }

        function displayOrders(orders, totalAmount) {
            const container = document.getElementById('ordersContainer');
            const totalAmountElement = document.getElementById('totalAmount');
            
            if (!container || !totalAmountElement) return;
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <strong>📋 暫無訂單</strong><br>
                        目前沒有找到您的訂單資料。
                    </div>
                `;
                totalAmountElement.textContent = 'NT$ 0';
                return;
            }
            
            container.innerHTML = orders.map(order => {
                const statusClass = order.status === '待付款' ? 'pending' : 
                                  order.status === '已完成' ? 'completed' : 
                                  order.status === '已取消' ? 'cancelled' : '';
                
                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-id">訂單 ${order.orderId}</div>
                            <div class="order-status ${statusClass}">${order.status}</div>
                        </div>
                        <div class="order-details">
                            <div><strong>${order.productName}</strong></div>
                            <div>數量：${order.quantity} | 單價：NT$ ${order.unitPrice?.toLocaleString()}</div>
                            <div>小計：NT$ ${order.totalPrice?.toLocaleString()}</div>
                            ${order.note ? `<div>備註：${order.note}</div>` : ''}
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                建立時間：${new Date(order.createdAt).toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            totalAmountElement.textContent = `NT$ ${totalAmount.toLocaleString()}`;
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            const config = systemConfig?.basic || {};
            const maxSizeMB = config['最大檔案大小MB'] || 5;
            const maxSizeBytes = maxSizeMB * 1024 * 1024;
            const allowedFormats = config['允許檔案格式'] || ['jpg', 'png', 'pdf'];
            
            if (file.size > maxSizeBytes) {
                showError(`檔案大小超過限制（最大 ${maxSizeMB}MB）`);
                input.value = '';
                return;
            }
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!allowedFormats.includes(fileExtension)) {
                showError(`不支援的檔案格式，請使用：${allowedFormats.join(', ').toUpperCase()}`);
                input.value = '';
                return;
            }
            
            debugLog('檔案驗證通過', { 
                name: file.name, 
                size: file.size, 
                type: file.type,
                extension: fileExtension
            });
            
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.innerHTML = `
                <div class="upload-icon">✅</div>
                <p>已選擇: ${file.name}</p>
                <small>檔案大小: ${(file.size / 1024 / 1024).toFixed(2)} MB</small>
            `;
            uploadArea.style.background = '#d4edda';
            uploadArea.style.borderColor = '#28a745';
            
            showSuccess('檔案選擇成功');
        }

        async function submitPayment() {
            debugLog('提交繳費證明');
            
            if (!currentOrderSummary) {
                showError('無法取得訂單資訊，請重新載入');
                return;
            }
            
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paymentNote = document.getElementById('paymentNote').value;
            const paymentProof = document.getElementById('paymentProof').files[0];
            
            if (!paymentMethod) {
                showError('請選擇繳費方式');
                return;
            }
            
            const isFileRequired = systemConfig?.basic?.['繳費證明上傳'] === '必須';
            
            if (isFileRequired && !paymentProof) {
                showError('請上傳繳費證明');
                return;
            }
            
            const paymentData = {
                orderId: currentOrderSummary.orderId,
                lineName: currentOrderSummary.lineName,
                realName: currentOrderSummary.realName,
                paymentAmount: currentOrderSummary.totalAmount,
                paymentMethod: paymentMethod,
                paymentNote: paymentNote,
                hasProof: !!paymentProof,
                submittedAt: new Date().toISOString()
            };
            
            try {
                const submitBtn = document.getElementById('submitPaymentBtn');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '提交中...';
                submitBtn.disabled = true;
                
                const result = await callAPIWithRetry('submit-payment', paymentData);
                
                if (result.success) {
                    debugLog('繳費證明提交成功');
                    const successMessage = systemConfig?.messages?.upload_success || '繳費證明提交成功！';
                    showSuccess(successMessage);
                    
                    // 清空表單
                    document.getElementById('paymentNote').value = '';
                    document.getElementById('paymentProof').value = '';
                    document.getElementById('paymentMethod').selectedIndex = 0;
                    
                    // 重置上傳區域
                    const uploadArea = document.querySelector('.upload-area');
                    uploadArea.innerHTML = `
                        <div class="upload-icon">📷</div>
                        <p>點擊上傳繳費證明照片</p>
                        <small>支援格式請參考系統設定</small>
                    `;
                    uploadArea.style.background = '';
                    uploadArea.style.borderColor = '';
                    
                    submitBtn.textContent = '✅ 已提交';
                    submitBtn.disabled = true;
                    submitBtn.classList.add('btn-secondary');
                    
                    // 3秒後返回訂單列表
                    setTimeout(() => {
                        showSection('ordersSection');
                    }, 3000);
                    
                } else {
                    debugLog('繳費證明提交失敗', result);
                    const errorMessage = result.message || systemConfig?.messages?.upload_error || '提交失敗，請稍後再試';
                    showError(errorMessage);
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                debugLog('繳費證明提交失敗', error);
                console.error('提交繳費證明失敗:', error);
                const errorMessage = systemConfig?.messages?.upload_error || '提交失敗，請稍後再試';
                showError(errorMessage + ': ' + error.message);
                
                const submitBtn = document.getElementById('submitPaymentBtn');
                if (submitBtn) {
                    submitBtn.textContent = '提交繳費證明';
                    submitBtn.disabled = false;
                }
            }
        }

        // 全域錯誤處理
        window.addEventListener('error', function(event) {
            debugLog('全域錯誤', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            });
            
            console.error('全域錯誤:', event.error);
            showError('系統發生錯誤，請重新整理頁面');
        });

        window.addEventListener('unhandledrejection', function(event) {
            debugLog('未處理的 Promise 拒絕', event.reason);
            console.error('未處理的 Promise 拒絕:', event.reason);
            showError('系統處理請求時發生錯誤');
        });

        // 新增一些實用函數
        function formatCurrency(amount) {
            return new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'TWD'
            }).format(amount);
        }

        function formatDate(date) {
            return new Intl.DateTimeFormat('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).format(new Date(date));
        }

        function validateIdNumber(idNumber) {
            const pattern = /^[A-Z][12]\d{8}$/;
            if (!pattern.test(idNumber)) return false;
            
            // 身分證字號檢查碼驗證
            const letters = 'ABCDEFGHJKLMNPQRSTUVXYWZIO';
            const weights = [1, 9, 8, 7, 6, 5, 4, 3, 2, 1, 1];
            
            let sum = letters.indexOf(idNumber[0]) + 10;
            sum = Math.floor(sum / 10) + (sum % 10) * 9;
            
            for (let i = 1; i < 10; i++) {
                sum += parseInt(idNumber[i]) * weights[i];
            }
            
            return (sum % 10) === 0;
        }

        function validatePhoneNumber(phoneNumber) {
            const pattern = /^09\d{8}$/;
            return pattern.test(phoneNumber);
        }

        // 導出一些函數供外部使用
        window.systemFunctions = {
            showToast,
            showSuccess,
            showError,
            showInfo,
            debugLog,
            formatCurrency,
            formatDate,
            validateIdNumber,
            validatePhoneNumber
        };

        // 在開發模式下導出更多函數
        if (CONFIG.DEBUG_MODE) {
            window.debugFunctions = {
                callAPI,
                loadSystemConfig,
                checkRegistrationStatus,
                loadUserOrders,
                submitPayment,
                systemConfig,
                liffProfile,
                currentOrderSummary
            };
        }

    </script>

</body>
</html>
