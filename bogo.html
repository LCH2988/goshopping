<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搶購名單管理系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <style>
        .profile-image-container {
            width: 100px;
            height: 100px;
            margin: 0 auto;
            overflow: hidden;
            border-radius: 50%;
            border: 2px solid #eee;
        }

        .profile-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #errorAlert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            min-width: 300px;
        }

        .select2-container {
            width: 100% !important;
        }

        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div id="errorAlert" class="alert alert-danger d-none mt-3" role="alert"></div>
        
        <div class="row">
            <!-- 左側個人資料 -->
            <div class="col-md-3">
                <div class="card my-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">LINE 個人資料</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <div class="profile-image-container mb-3">
                                <img id="profileImage" src="https://placehold.co/100x100" alt="Profile Image" class="rounded-circle">
                            </div>
                            <h3 id="displayName" class="mb-2">載入中...</h3>
                            <p id="userId" class="text-muted">載入中...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右側搶購名單 -->
            <div class="col-md-9">
                <div class="card my-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">搶購名單資料</h5>
                        <button class="btn btn-primary btn-sm" onclick="app.refreshData()">
                            重新整理
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- 篩選器 -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label class="form-label">買手篩選</label>
                                <select id="buyerFilter" class="form-select select2">
                                    <option value="">全部</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">搶購帳號篩選</label>
                                <select id="accountFilter" class="form-select select2">
                                    <option value="">全部</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">搶購組別篩選</label>
                                <select id="groupFilter" class="form-select select2">
                                    <option value="">全部</option>
                                </select>
                            </div>
                        </div>

                        <!-- 資料表格 -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>買手</th>
                                        <th>搶購帳號</th>
                                        <th>搶購組別</th>
                                        <th>數量</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="dataTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">載入中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改資料 Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">修改資料</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="editModalContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    <button type="button" class="btn btn-primary" id="editModalBtn">確認修改</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // 設定檔
        const CONFIG = {
            LIFF_ID: '1657285806-2bmkYWkN', // 替換為你的 LIFF ID
            GAS_URL: 'https://script.google.com/macros/s/AKfycbzQ2hXp6yMr8cctkWOZPmEo4Gx_JO2Xt0M7yuu9MGd-FLWNUCmUTmbweo3san0eD3x0JA/exec' // 替換為你的 GAS 部署網址
        };
    </script>
    <script>
        class App {
            constructor() {
                this.purchaseData = [];
                this.filteredData = [];
                this.initializeElements();
                this.initializeEventListeners();
            }

            initializeElements() {
                // Profile elements
                this.profileImage = document.getElementById('profileImage');
                this.displayName = document.getElementById('displayName');
                this.userId = document.getElementById('userId');

                // Filter elements
                this.buyerFilter = $('#buyerFilter');
                this.accountFilter = $('#accountFilter');
                this.groupFilter = $('#groupFilter');

                // Table element
                this.tableBody = document.getElementById('dataTableBody');

                // Modal elements
                this.editModal = new bootstrap.Modal(document.getElementById('editModal'));
                this.editModalContent = document.getElementById('editModalContent');
                this.editModalBtn = document.getElementById('editModalBtn');
            }

            initializeEventListeners() {
                // Initialize Select2
                $('.select2').select2({
                    placeholder: '請選擇',
                    allowClear: true
                });

                // Add filter change events
                this.buyerFilter.on('change', () => this.applyFilters());
                this.accountFilter.on('change', () => this.applyFilters());
                this.groupFilter.on('change', () => this.applyFilters());

                // Modal edit button
                this.editModalBtn.addEventListener('click', () => {
                    const rowId = this.editModalBtn.dataset.rowId;
                    if (rowId) {
                        this.updatePurchaseData(rowId);
                    }
                });
            }

            showError(message, isSuccess = false) {
                const errorAlert = document.getElementById('errorAlert');
                errorAlert.textContent = message;
                errorAlert.classList.remove('d-none', 'alert-danger', 'alert-success');
                errorAlert.classList.add(isSuccess ? 'alert-success' : 'alert-danger');
                
                setTimeout(() => {
                    errorAlert.classList.add('d-none');
                }, 5000);
            }

            async initialize() {
                try {
                    await this.initializeLiff();
                    await this.loadPurchaseData();
                } catch (error) {
                    console.error('初始化錯誤:', error);
                    this.showError(`初始化失敗: ${error.message}`);
                }
            }

            async initializeLiff() {
                try {
                    await liff.init({ liffId: CONFIG.LIFF_ID });
                    
                    if (!liff.isLoggedIn()) {
                        liff.login();
                        return;
                    }

                    const profile = await liff.getProfile();
                    this.updateProfile(profile);
                    await this.sendProfileToGAS(profile);
                    
                } catch (error) {
                    console.error('LIFF 初始化錯誤:', error);
                    throw new Error(`LIFF 初始化失敗: ${error.message}`);
                }
            }

            updateProfile(profile) {
                this.profileImage.src = profile.pictureUrl;
                this.displayName.textContent = profile.displayName;
                this.userId.textContent = profile.userId;
            }

            async sendProfileToGAS(profile) {
                try {
                    const response = await fetch(`${CONFIG.GAS_URL}?action=saveProfile&data=${encodeURIComponent(JSON.stringify(profile))}`);
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    console.error('儲存資料錯誤:', error);
                    this.showError(`儲存資料失敗: ${error.message}`);
                }
            }

            async loadPurchaseData() {
                try {
                    const response = await fetch(`${CONFIG.GAS_URL}?action=getPurchaseData`);
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.message);
                    }

                    this.purchaseData = result.data;
                    this.filteredData = [...this.purchaseData];
                    
                    this.updateFilterOptions();
                    this.renderTable();
                    
                } catch (error) {
                    console.error('載入搶購資料錯誤:', error);
                    this.showError(`載入搶購資料失敗: ${error.message}`);
                }
            }

            updateFilterOptions() {
                const buyers = [...new Set(this.purchaseData.map(item => item.buyer).filter(Boolean))];
                const accounts = [...new Set(this.purchaseData.map(item => item.account).filter(Boolean))];
                const groups = [...new Set(this.purchaseData.map(item => item.group).filter(Boolean))];

                this.updateSelect(this.buyerFilter, buyers);
                this.updateSelect(this.accountFilter, accounts);
                this.updateSelect(this.groupFilter, groups);
            }

            updateSelect(select, options) {
                select.empty().append('<option value="">全部</option>');
                options.sort().forEach(option => {
                    select.append(`<option value="${option}">${option}</option>`);
                });
            }

            applyFilters() {
                const buyer = this.buyerFilter.val();
                const account = this.accountFilter.val();
                const group = this.groupFilter.val();

                this.filteredData = this.purchaseData.filter(item => {
                    return (!buyer || item.buyer === buyer) &&
                           (!account || item.account === account) &&
                           (!group || item.group === group);
                });

                this.renderTable();
            }

            renderTable() {
                this.tableBody.innerHTML = this.filteredData.map(item => `
                    <tr>
                        <td>${item.buyer || ''}</td>
                        <td>${item.account || ''}</td>
                        <td>${item.group || ''}</td>
                        <td>${item.quantity || ''}</td>
                        <td>
                            <button class="btn btn-success btn-sm me-2" onclick="app.confirmData('${item.rowId}')">
                                確認
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="app.showEditModal('${item.rowId}')">
                                修改
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            async confirmData(rowId) {
                try {
                    const response = await fetch(CONFIG.GAS_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'confirmData',
                            rowId: rowId
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.message);
                    }

                    await this.loadPurchaseData();
                    this.showError('確認成功！資料已複製到 I、J 欄', true);
                    
                } catch (error) {
                    console.error('確認資料錯誤:', error);
                    this.showError(`確認資料失敗: ${error.message}`);
                }
            }

            showEditModal(rowId) {
                const item = this.purchaseData.find(item => item.rowId == rowId);
                if (!item) return;

                this.editModalContent.innerHTML = `
                    <div class="mb-3">
                        <strong>買手：</strong> ${item.buyer || ''}
                    </div>
                    <div class="mb-3">
                        <strong>搶購帳號：</strong> ${item.account || ''}
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>搶購組別：</strong></label>
                        <input type="text" class="form-control" id="groupInput" value="${item.group || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>數量：</strong></label>
                        <input type="number" class="form-control" id="quantityInput" value="${item.quantity || ''}">
                    </div>
                `;

                this.editModalBtn.dataset.rowId = rowId;
                this.editModal.show();
            }

            async updatePurchaseData(rowId) {
                try {
                    const group = document.getElementById('groupInput').value.trim();
                    const quantity = document.getElementById('quantityInput').value.trim();

                    if (!group && !quantity) {
                        throw new Error('請至少填寫一個欄位');
                    }

                    const response = await fetch(CONFIG.GAS_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'updatePurchaseData',
                            rowId: rowId,
                            group: group,
                            quantity: quantity
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.message);
                    }

                    this.editModal.hide();
                    await this.loadPurchaseData();
                    this.showError('更新成功！資料已同步複製到 I、J 欄', true);
                    
                } catch (error) {
                    console.error('更新資料錯誤:', error);
                    this.showError(`更新資料失敗: ${error.message}`);
                }
            }

            async refreshData() {
                await this.loadPurchaseData();
                this.showError('資料已重新整理！', true);
            }
        }

        // 當頁面載入完成後初始化應用
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new App();
            app.initialize();
        });
    </script>
</body>
</html>
