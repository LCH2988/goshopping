<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title><!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã€å¤šç¦æ°£ã€‘BOGOç®¡ç†è€…ä»‹é¢</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: #f5f5f5;
          color: #333;
      }

      .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 1rem;
          text-align: center;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      .nav-tabs {
          display: flex;
          background: white;
          border-bottom: 1px solid #ddd;
          overflow-x: auto;
      }

      .nav-tab {
          flex: 1;
          min-width: 120px;
          padding: 1rem;
          text-align: center;
          background: white;
          border: none;
          cursor: pointer;
          transition: all 0.3s;
          font-size: 14px;
      }

      .nav-tab.active {
          background: #667eea;
          color: white;
      }

      .nav-tab:hover {
          background: #f0f0f0;
      }

      .nav-tab.active:hover {
          background: #5a6fd8;
      }

      .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 1rem;
      }

      .tab-content {
          display: none;
          background: white;
          border-radius: 8px;
          padding: 1.5rem;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          margin-top: 1rem;
      }

      .tab-content.active {
          display: block;
      }

      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1rem;
          margin-bottom: 2rem;
      }

      .stat-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 1.5rem;
          border-radius: 8px;
          text-align: center;
      }

      .stat-number {
          font-size: 2rem;
          font-weight: bold;
          margin-bottom: 0.5rem;
      }

      .stat-label {
          font-size: 0.9rem;
          opacity: 0.9;
      }

      .search-section {
          background: #f8f9fa;
          padding: 1.5rem;
          border-radius: 8px;
          margin-bottom: 2rem;
      }

      .search-input {
          width: 100%;
          padding: 0.75rem;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 16px;
          margin-bottom: 1rem;
      }

      .search-results {
          display: grid;
          gap: 0.5rem;
      }

      .member-item {
          background: white;
          padding: 1rem;
          border-radius: 4px;
          border: 1px solid #eee;
          cursor: pointer;
          transition: all 0.3s;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .member-item:hover {
          background: #f0f8ff;
          border-color: #667eea;
      }

      .member-info {
          flex: 1;
      }

      .member-name {
          font-weight: bold;
          margin-bottom: 0.25rem;
      }

      .member-details {
          font-size: 0.9rem;
          color: #666;
      }

      .order-badge {
          background: #667eea;
          color: white;
          padding: 0.25rem 0.5rem;
          border-radius: 12px;
          font-size: 0.8rem;
      }

      .table-container {
          overflow-x: auto;
          margin-top: 1rem;
      }

      table {
          width: 100%;
          border-collapse: collapse;
          background: white;
      }

      th, td {
          padding: 0.75rem;
          text-align: left;
          border-bottom: 1px solid #eee;
      }

      th {
          background: #f8f9fa;
          font-weight: bold;
          position: sticky;
          top: 0;
      }

      tr:hover {
          background: #f8f9fa;
      }

      .btn {
          padding: 0.5rem 1rem;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 14px;
          transition: all 0.3s;
          margin: 0.25rem;
      }

      .btn-primary {
          background: #667eea;
          color: white;
      }

      .btn-primary:hover {
          background: #5a6fd8;
      }

      .btn-success {
          background: #28a745;
          color: white;
      }

      .btn-success:hover {
          background: #218838;
      }

      .btn-danger {
          background: #dc3545;
          color: white;
      }

      .btn-danger:hover {
          background: #c82333;
      }

      .btn-warning {
          background: #ffc107;
          color: #212529;
      }

      .btn-warning:hover {
          background: #e0a800;
      }

      .btn-secondary {
          background: #6c757d;
          color: white;
      }

      .btn-secondary:hover {
          background: #5a6268;
      }

      .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
      }

      .modal-content {
          background: white;
          margin: 5% auto;
          padding: 2rem;
          border-radius: 8px;
          width: 90%;
          max-width: 600px;
          max-height: 80vh;
          overflow-y: auto;
      }

      .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
          padding-bottom: 1rem;
          border-bottom: 1px solid #eee;
      }

      .close {
          background: none;
          border: none;
          font-size: 1.5rem;
          cursor: pointer;
          color: #999;
      }

      .close:hover {
          color: #333;
      }

      .form-group {
          margin-bottom: 1rem;
      }

      .form-label {
          display: block;
          margin-bottom: 0.5rem;
          font-weight: bold;
      }

      .form-control {
          width: 100%;
          padding: 0.5rem;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 14px;
      }

      .form-control:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
      }

      .alert {
          padding: 1rem;
          border-radius: 4px;
          margin-bottom: 1rem;
      }

      .alert-success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }

      .alert-danger {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }

      .alert-warning {
          background: #fff3cd;
          color: #856404;
          border: 1px solid #ffeaa7;
      }

      .loading {
          text-align: center;
          padding: 2rem;
          color: #666;
      }

      .spinner {
          border: 3px solid #f3f3f3;
          border-top: 3px solid #667eea;
          border-radius: 50%;
          width: 30px;
          height: 30px;
          animation: spin 1s linear infinite;
          margin: 0 auto 1rem;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .checkbox-group {
          display: flex;
          flex-wrap: wrap;
          gap: 1rem;
          margin: 1rem 0;
      }

      .checkbox-item {
          display: flex;
          align-items: center;
          gap: 0.5rem;
      }

      .status-badge {
          padding: 0.25rem 0.5rem;
          border-radius: 12px;
          font-size: 0.8rem;
          font-weight: bold;
      }

      .status-pending {
          background: #fff3cd;
          color: #856404;
      }

      .status-approved {
          background: #d4edda;
          color: #155724;
      }

      .status-rejected {
          background: #f8d7da;
          color: #721c24;
      }

      .order-summary {
          background: #f8f9fa;
          padding: 1rem;
          border-radius: 4px;
          margin: 1rem 0;
      }

      .summary-row {
          display: flex;
          justify-content: space-between;
          margin-bottom: 0.5rem;
      }

      .summary-total {
          font-weight: bold;
          font-size: 1.1rem;
          border-top: 1px solid #ddd;
          padding-top: 0.5rem;
          margin-top: 0.5rem;
      }

      @media (max-width: 768px) {
          .container {
              padding: 0.5rem;
          }

          .stats-grid {
              grid-template-columns: repeat(2, 1fr);
          }

          .stat-card {
              padding: 1rem;
          }

          .stat-number {
              font-size: 1.5rem;
          }

          .modal-content {
              margin: 2% auto;
              width: 95%;
              padding: 1rem;
          }

          .nav-tab {
              font-size: 12px;
              padding: 0.75rem 0.5rem;
          }
      }
  </style>
</head>
<body>
  <div class="header">
      <h1>ğŸ“Š è¨‚è³¼ç³»çµ±ç®¡ç†ä¸­å¿ƒ</h1>
      <p id="adminInfo">è¼‰å…¥ä¸­...</p>
  </div>

  <div class="nav-tabs">
      <button class="nav-tab active" onclick="showTab('dashboard')">å„€è¡¨æ¿</button>
      <button class="nav-tab" onclick="showTab('payments')">ç¹³è²»å¯©æ ¸</button>
      <button class="nav-tab" onclick="showTab('members')">æœƒå“¡ç®¡ç†</button>
      <button class="nav-tab" onclick="showTab('orders')">è¨‚å–®æŸ¥è©¢</button>
      <button class="nav-tab" onclick="showTab('reports')">å ±è¡¨</button>
      <button class="nav-tab" onclick="showTab('settings')">ç³»çµ±è¨­å®š</button>
  </div>

  <div class="container">
      <!-- å„€è¡¨æ¿ -->
      <div id="dashboard" class="tab-content active">
          <h2>ğŸ“ˆ ç³»çµ±æ¦‚è¦½</h2>
          <div class="stats-grid" id="statsGrid">
              <!-- çµ±è¨ˆå¡ç‰‡å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
          </div>
          
          <div class="alert alert-warning" id="pendingAlert" style="display: none;">
              <strong>âš ï¸ æ³¨æ„ï¼š</strong> <span id="pendingCount">0</span> ç­†ç¹³è²»è¨˜éŒ„å¾…å¯©æ ¸
          </div>
      </div>

      <!-- ç¹³è²»å¯©æ ¸ -->
      <div id="payments" class="tab-content">
          <h2>ğŸ’³ ç¹³è²»å¯©æ ¸</h2>
          
          <div style="margin-bottom: 1rem;">
              <button class="btn btn-primary" onclick="loadPendingPayments()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
              <button class="btn btn-success" onclick="showBatchReview('å·²ç¢ºèª')">âœ… æ‰¹é‡é€šé</button>
              <button class="btn btn-danger" onclick="showBatchReview('å·²æ‹’çµ•')">âŒ æ‰¹é‡æ‹’çµ•</button>
          </div>

          <div class="table-container">
              <table id="paymentsTable">
                  <thead>
                      <tr>
                          <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                          <th>ç¹³è²»ç·¨è™Ÿ</th>
                          <th>æœƒå“¡å§“å</th>
                          <th>ç¹³è²»é‡‘é¡</th>
                          <th>ç¹³è²»æ–¹å¼</th>
                          <th>æäº¤æ™‚é–“</th>
                          <th>ç‹€æ…‹</th>
                          <th>æ“ä½œ</th>
                      </tr>
                  </thead>
                  <tbody id="paymentsTableBody">
                      <!-- è³‡æ–™å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
                  </tbody>
              </table>
          </div>
      </div>

      <!-- æœƒå“¡ç®¡ç† -->
      <div id="members" class="tab-content">
          <h2>ğŸ‘¥ æœƒå“¡ç®¡ç†</h2>
          
          <div class="table-container">
              <table id="membersTable">
                  <thead>
                      <tr>
                          <th>LINEåç¨±</th>
                          <th>çœŸå¯¦å§“å</th>
                          <th>è¨»å†Šæ™‚é–“</th>
                          <th>è¨‚å–®æ•¸é‡</th>
                          <th>ç¹³è²»æ¬¡æ•¸</th>
                          <th>ç‹€æ…‹</th>
                      </tr>
                  </thead>
                  <tbody id="membersTableBody">
                      <!-- è³‡æ–™å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
                  </tbody>
              </table>
          </div>
      </div>

      <!-- è¨‚å–®æŸ¥è©¢ -->
      <div id="orders" class="tab-content">
          <h2>ğŸ›’ è¨‚å–®æŸ¥è©¢èˆ‡ç®¡ç†</h2>
          
          <div class="search-section">
              <h3>ğŸ” æœå°‹æœƒå“¡</h3>
              <input type="text" id="memberSearch" class="search-input" 
                     placeholder="è¼¸å…¥ LINE åç¨±æˆ–çœŸå¯¦å§“åé€²è¡Œæœå°‹..." 
                     onkeyup="searchMembers(event)">
              
              <div id="searchResults" class="search-results">
                  <!-- æœå°‹çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
              </div>
          </div>

          <div id="memberOrdersSection" style="display: none;">
              <div class="modal-header">
                  <h3 id="selectedMemberName">æœƒå“¡è¨‚å–®</h3>
                  <button class="btn btn-primary" onclick="addNewOrder()">â• æ–°å¢è¨‚å–®</button>
              </div>

              <div id="memberInfo" class="order-summary">
                  <!-- æœƒå“¡è³‡è¨Šå°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
              </div>

              <div class="table-container">
                  <table id="memberOrdersTable">
                      <thead>
                          <tr>
                              <th>ç”¢å“ä»£è™Ÿ</th>
                              <th>ç”¢å“åç¨±</th>
                              <th>æ•¸é‡</th>
                              <th>å–®åƒ¹</th>
                              <th>åˆè¨ˆ</th>
                              <th>æ“ä½œ</th>
                          </tr>
                      </thead>
                      <tbody id="memberOrdersTableBody">
                          <!-- è¨‚å–®è³‡æ–™å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                      </tbody>
                  </table>
              </div>

              <div id="orderSummary" class="order-summary">
                  <!-- è¨‚å–®æ‘˜è¦å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
              </div>

              <div id="paymentHistory" style="margin-top: 2rem;">
                  <h4>ğŸ’° ç¹³è²»è¨˜éŒ„</h4>
                  <div class="table-container">
                      <table id="paymentHistoryTable">
                          <thead>
                              <tr>
                                  <th>ç¹³è²»ç·¨è™Ÿ</th>
                                  <th>ç¹³è²»é‡‘é¡</th>
                                  <th>ç¹³è²»æ–¹å¼</th>
                                  <th>æäº¤æ™‚é–“</th>
                                  <th>ç‹€æ…‹</th>
                              </tr>
                          </thead>
                          <tbody id="paymentHistoryTableBody">
                              <!-- ç¹³è²»è¨˜éŒ„å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      </div>

      <!-- å ±è¡¨ -->
      <div id="reports" class="tab-content">
          <h2>ğŸ“Š å ±è¡¨ä¸­å¿ƒ</h2>
          
          <div style="margin-bottom: 2rem;">
              <div class="form-group">
                  <label class="form-label">é¸æ“‡æ—¥æœŸï¼š</label>
                  <input type="date" id="reportDate" class="form-control" style="width: auto; display: inline-block;">
                  <button class="btn btn-primary" onclick="generateDailyReport()">ğŸ“ˆ ç”Ÿæˆæ—¥å ±è¡¨</button>
              </div>
          </div>

          <div id="reportContent">
              <!-- å ±è¡¨å…§å®¹å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
          </div>

          <div style="margin-top: 2rem;">
              <button class="btn btn-secondary" onclick="exportAllData()">ğŸ“¤ åŒ¯å‡ºæ‰€æœ‰è³‡æ–™</button>
              <button class="btn btn-warning" onclick="cleanupTestData()">ğŸ§¹ æ¸…ç†æ¸¬è©¦è³‡æ–™</button>
          </div>
      </div>

      <!-- ç³»çµ±è¨­å®š -->
      <div id="settings" class="tab-content">
          <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>
          
          <div style="margin-bottom: 2rem;">
              <h3>ğŸ”§ ç³»çµ±ç¶­è­·</h3>
              <button class="btn btn-primary" onclick="initializeSystem()">ğŸš€ åˆå§‹åŒ–ç³»çµ±</button>
              <button class="btn btn-secondary" onclick="setupTriggers()">â° è¨­å®šè§¸ç™¼å™¨</button>
              <button class="btn btn-warning" onclick="cleanupOldLogs()">ğŸ—‘ï¸ æ¸…ç†èˆŠæ—¥èªŒ</button>
              <button class="btn btn-success" onclick="checkSystemHealth()">ğŸ¥ ç³»çµ±å¥åº·æª¢æŸ¥</button>
          </div>

          <div>
              <h3>ğŸ’¾ è³‡æ–™å‚™ä»½</h3>
              <div class="form-group">
                  <label class="form-label">å‚™ä»½è©¦ç®—è¡¨ IDï¼š</label>
                  <input type="text" id="backupSpreadsheetId" class="form-control" 
                         placeholder="è«‹è¼¸å…¥ç›®æ¨™è©¦ç®—è¡¨çš„ ID">
                  <button class="btn btn-primary" onclick="backupData()" style="margin-top: 0.5rem;">
                      ğŸ’¾ é–‹å§‹å‚™ä»½
                  </button>
              </div>
          </div>

          <div id="systemStatus" style="margin-top: 2rem;">
              <!-- ç³»çµ±ç‹€æ…‹å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
          </div>
      </div>
  </div>

  <!-- å¯©æ ¸æ¨¡æ…‹æ¡† -->
  <div id="reviewModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>å¯©æ ¸ç¹³è²»è¨˜éŒ„</h3>
              <button class="close" onclick="closeModal('reviewModal')">&times;</button>
          </div>
          
          <div id="reviewPaymentInfo">
              <!-- ç¹³è²»è³‡è¨Šå°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
          </div>
          
          <div class="form-group">
              <label class="form-label">å¯©æ ¸çµæœï¼š</label>
              <select id="reviewStatus" class="form-control">
                  <option value="å·²ç¢ºèª">âœ… é€šé</option>
                  <option value="å·²æ‹’çµ•">âŒ æ‹’çµ•</option>
              </select>
          </div>
          
          <div class="form-group">
              <label class="form-label">å¯©æ ¸å‚™è¨»ï¼š</label>
              <textarea id="reviewNote" class="form-control" rows="3" 
                        placeholder="è«‹è¼¸å…¥å¯©æ ¸å‚™è¨»..."></textarea>
          </div>
          
          <div style="text-align: right;">
              <button class="btn btn-secondary" onclick="closeModal('reviewModal')">å–æ¶ˆ</button>
              <button class="btn btn-primary" onclick="submitReview()">ç¢ºèªå¯©æ ¸</button>
          </div>
      </div>
  </div>

  <!-- æ‰¹é‡å¯©æ ¸æ¨¡æ…‹æ¡† -->
  <div id="batchReviewModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>æ‰¹é‡å¯©æ ¸</h3>
              <button class="close" onclick="closeModal('batchReviewModal')">&times;</button>
          </div>
          
          <div id="batchReviewInfo">
              <!-- æ‰¹é‡å¯©æ ¸è³‡è¨Šå°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
          </div>
          
          <div class="form-group">
              <label class="form-label">å¯©æ ¸å‚™è¨»ï¼š</label>
              <textarea id="batchReviewNote" class="form-control" rows="3" 
                        placeholder="è«‹è¼¸å…¥å¯©æ ¸å‚™è¨»..."></textarea>
          </div>
          
          <div style="text-align: right;">
              <button class="btn btn-secondary" onclick="closeModal('batchReviewModal')">å–æ¶ˆ</button>
              <button class="btn btn-primary" onclick="submitBatchReview()">ç¢ºèªæ‰¹é‡å¯©æ ¸</button>
          </div>
      </div>
  </div>

  <!-- ç·¨è¼¯è¨‚å–®æ¨¡æ…‹æ¡† -->
  <div id="editOrderModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="editOrderTitle">ç·¨è¼¯è¨‚å–®</h3>
              <button class="close" onclick="closeModal('editOrderModal')">&times;</button>
          </div>
          
          <div class="form-group">
              <label class="form-label">LINEåç¨±ï¼š</label>
              <input type="text" id="editLineName" class="form-control">
          </div>
          
          <div class="form-group">
              <label class="form-label">ç”¢å“ä»£è™Ÿï¼š</label>
              <input type="text" id="editProductCode" class="form-control">
          </div>
          
          <div class="form-group">
              <label class="form-label">ç”¢å“åç¨±ï¼š</label>
              <input type="text" id="editProductName" class="form-control">
          </div>
          
          <div class="form-group">
              <label class="form-label">æ•¸é‡ï¼š</label>
              <input type="number" id="editQuantity" class="form-control" min="1" onchange="calculateTotal()">
          </div>
          
          <div class="form-group">
              <label class="form-label">å–®åƒ¹ï¼š</label>
              <input type="number" id="editUnitPrice" class="form-control" min="0" step="0.01" onchange="calculateTotal()">
          </div>
          
          <div class="form-group">
              <label class="form-label">åˆè¨ˆï¼š</label>
              <input type="number" id="editTotalPrice" class="form-control" readonly>
          </div>
          
          <div style="text-align: right;">
              <button class="btn btn-secondary" onclick="closeModal('editOrderModal')">å–æ¶ˆ</button>
              <button class="btn btn-primary" onclick="saveOrder()">å„²å­˜</button>
          </div>
      </div>
  </div>

  <script>
      // è¨­å®šå€åŸŸ
      const CONFIG = {
          LIFF_ID: '1657285806-2bmkYWkN', // è«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID
          API_BASE_URL: 'https://script.google.com/macros/s/AKfycbwhseFb4yrYifu43nrhAz0EbAi_xsZvPYFjLZ_OK9st_kOYx3JBwxHiRg0CsCGx77cZ/exec' // è«‹æ›¿æ›ç‚ºæ‚¨çš„ GAS Web App URL
      };

      // å…¨åŸŸè®Šæ•¸
      let currentUser = null;
      let currentPaymentId = null;
      let currentRowIndex = null;
      let selectedPaymentIds = [];
      let batchReviewStatus = '';
      let currentMemberName = '';

      // LIFF åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', function() {
          liff.init({
              liffId: CONFIG.LIFF_ID
          }).then(() => {
              if (liff.isLoggedIn()) {
                  liff.getProfile().then(profile => {
                      currentUser = {
                          userId: profile.userId,
                          displayName: profile.displayName
                      };
                      
                      document.getElementById('adminInfo').textContent = 
                          `ç®¡ç†è€…ï¼š${profile.displayName}`;
                      
                      // è¼‰å…¥åˆå§‹è³‡æ–™
                      loadDashboard();
                      loadPendingPayments();
                      loadAllMembers();
                  });
              } else {
                  liff.login();
              }
          }).catch(err => {
              console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', err);
              alert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢');
          });
      });

      // API å‘¼å«å‡½æ•¸
      function callAPI(action, data = {}) {
          return new Promise((resolve, reject) => {
              data.adminUserId = currentUser ? currentUser.userId : '';
              
              const url = `${CONFIG.API_BASE_URL}?action=${action}&data=${encodeURIComponent(JSON.stringify(data))}`;
              
              fetch(url)
                  .then(response => response.json())
                  .then(result => {
                      if (result.success) {
                          resolve(result);
                      } else {
                          reject(new Error(result.message || 'æ“ä½œå¤±æ•—'));
                      }
                  })
                  .catch(error => {
                      reject(error);
                  });
          });
      }

      // æ¨™ç±¤åˆ‡æ›
      function showTab(tabName) {
          // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
          document.querySelectorAll('.tab-content').forEach(tab => {
              tab.classList.remove('active');
          });
          
          // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„ active ç‹€æ…‹
          document.querySelectorAll('.nav-tab').forEach(tab => {
              tab.classList.remove('active');
          });
          
          // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
          document.getElementById(tabName).classList.add('active');
          
          // è¨­å®šé¸ä¸­çš„æ¨™ç±¤ç‚º active
          event.target.classList.add('active');
          
          // è¼‰å…¥å°æ‡‰çš„è³‡æ–™
          switch(tabName) {
              case 'dashboard':
                  loadDashboard();
                  break;
              case 'payments':
                  loadPendingPayments();
                  break;
              case 'members':
                  loadAllMembers();
                  break;
              case 'reports':
                  // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
                  document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
                  break;
          }
      }

      // è¼‰å…¥å„€è¡¨æ¿
      function loadDashboard() {
          callAPI('admin-get-statistics')
              .then(result => {
                  const stats = result.statistics;
                  const statsGrid = document.getElementById('statsGrid');
                  
                  statsGrid.innerHTML = `
                      <div class="stat-card">
                          <div class="stat-number">${stats.totalUsers}</div>
                          <div class="stat-label">è¨»å†Šæœƒå“¡</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${stats.totalOrders}</div>
                          <div class="stat-label">ç¸½è¨‚å–®æ•¸</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${stats.totalPayments}</div>
                          <div class="stat-label">ç¹³è²»è¨˜éŒ„</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${stats.pendingPayments}</div>
                          <div class="stat-label">å¾…å¯©æ ¸</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${stats.approvedPayments}</div>
                          <div class="stat-label">å·²ç¢ºèª</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">NT$ ${stats.totalAmount.toLocaleString()}</div>
                          <div class="stat-label">ç¸½é‡‘é¡</div>
                      </div>
                  `;
                  
                  // é¡¯ç¤ºå¾…å¯©æ ¸æé†’
                  const pendingAlert = document.getElementById('pendingAlert');
                  const pendingCount = document.getElementById('pendingCount');
                  
                  if (stats.pendingPayments > 0) {
                      pendingCount.textContent = stats.pendingPayments;
                      pendingAlert.style.display = 'block';
                  } else {
                      pendingAlert.style.display = 'none';
                  }
              })
              .catch(error => {
                  console.error('è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—:', error);
                  showAlert('è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // è¼‰å…¥å¾…å¯©æ ¸ç¹³è²»
      function loadPendingPayments() {
          const tbody = document.getElementById('paymentsTableBody');
          tbody.innerHTML = '<tr><td colspan="8" class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­...</td></tr>';
          
          callAPI('admin-get-pending-payments')
              .then(result => {
                  const payments = result.payments;
                  
                  if (payments.length === 0) {
                      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">æš«ç„¡å¾…å¯©æ ¸è¨˜éŒ„</td></tr>';
                      return;
                  }
                  
                  tbody.innerHTML = payments.map(payment => `
                      <tr>
                          <td><input type="checkbox" class="payment-checkbox" value="${payment.paymentId}"></td>
                          <td>${payment.paymentId}</td>
                          <td>${payment.realName}</td>
                          <td>NT$ ${payment.paymentAmount.toLocaleString()}</td>
                          <td>${payment.paymentMethod}</td>
                          <td>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</td>
                          <td><span class="status-badge status-pending">${payment.status}</span></td>
                          <td>
                              <button class="btn btn-primary" onclick="showReviewModal('${payment.paymentId}')">å¯©æ ¸</button>
                          </td>
                      </tr>
                  `).join('');
              })
              .catch(error => {
                  console.error('è¼‰å…¥å¾…å¯©æ ¸ç¹³è²»å¤±æ•—:', error);
                  tbody.innerHTML = `<tr><td colspan="8" class="alert alert-danger">è¼‰å…¥å¤±æ•—: ${error.message}</td></tr>`;
              });
      }

      // è¼‰å…¥æ‰€æœ‰æœƒå“¡
      function loadAllMembers() {
          const tbody = document.getElementById('membersTableBody');
          tbody.innerHTML = '<tr><td colspan="6" class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­...</td></tr>';
          
          callAPI('admin-get-users')
              .then(result => {
                  const users = result.users;
                  
                  if (users.length === 0) {
                      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">æš«ç„¡æœƒå“¡è³‡æ–™</td></tr>';
                      return;
                  }
                  
                  tbody.innerHTML = users.map(user => `
                      <tr>
                          <td>${user.lineDisplayName}</td>
                          <td>${user.realName}</td>
                          <td>${new Date(user.registeredAt).toLocaleDateString('zh-TW')}</td>
                          <td>${user.orderCount}</td>
                          <td>${user.paymentCount}</td>
                          <td><span class="status-badge status-approved">${user.status}</span></td>
                      </tr>
                  `).join('');
              })
              .catch(error => {
                  console.error('è¼‰å…¥æœƒå“¡è³‡æ–™å¤±æ•—:', error);
                  tbody.innerHTML = `<tr><td colspan="6" class="alert alert-danger">è¼‰å…¥å¤±æ•—: ${error.message}</td></tr>`;
              });
      }

      // æœå°‹æœƒå“¡
      function searchMembers(event) {
          const keyword = event.target.value.trim();
          const resultsDiv = document.getElementById('searchResults');
          
          if (keyword.length < 2) {
              resultsDiv.innerHTML = '';
              return;
          }
          
          if (event.key === 'Enter' || event.type === 'input') {
              callAPI('admin-search-members', { keyword: keyword })
                  .then(result => {
                      const members = result.members;
                      
                      if (members.length === 0) {
                          resultsDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">æ‰¾ä¸åˆ°ç›¸é—œæœƒå“¡</div>';
                          return;
                      }
                      
                      resultsDiv.innerHTML = members.map(member => `
                          <div class="member-item" onclick="selectMember('${member.lineName}')">
                              <div class="member-info">
                                  <div class="member-name">${member.lineName}</div>
                                  <div class="member-details">
                                      çœŸå¯¦å§“å: ${member.realName} | 
                                      ${member.registeredAt ? 'å·²è¨»å†Š (' + new Date(member.registeredAt).toLocaleDateString('zh-TW') + ')' : 'æœªè¨»å†Š'}
                                  </div>
                              </div>
                              <div class="order-badge">${member.orderCount} ç­†è¨‚å–®</div>
                          </div>
                      `).join('');
                  })
                  .catch(error => {
                      console.error('æœå°‹æœƒå“¡å¤±æ•—:', error);
                      resultsDiv.innerHTML = `<div class="alert alert-danger">æœå°‹å¤±æ•—: ${error.message}</div>`;
                  });
          }
      }

      // é¸æ“‡æœƒå“¡
      function selectMember(lineName) {
          currentMemberName = lineName;
          document.getElementById('selectedMemberName').textContent = `${lineName} çš„è¨‚å–®`;
          
          loadMemberOrders(lineName);
          
          // éš±è—æœå°‹çµæœï¼Œé¡¯ç¤ºè¨‚å–®å€åŸŸ
          document.getElementById('searchResults').innerHTML = '';
          document.getElementById('memberOrdersSection').style.display = 'block';
      }

      // è¼‰å…¥æœƒå“¡è¨‚å–®
      function loadMemberOrders(lineName) {
          callAPI('admin-get-member-orders', { lineName: lineName })
              .then(result => {
                  const { memberInfo, orders, payments, summary } = result;
                  
                  // é¡¯ç¤ºæœƒå“¡è³‡è¨Š
                  const memberInfoDiv = document.getElementById('memberInfo');
                  memberInfoDiv.innerHTML = `
                      <div class="summary-row">
                          <span>æœƒå“¡å§“å:</span>
                          <span>${memberInfo ? memberInfo.realName : 'æœªè¨»å†Š'}</span>
                      </div>
                      <div class="summary-row">
                          <span>LINEåç¨±:</span>
                          <span>${lineName}</span>
                      </div>
                      ${memberInfo ? `
                      <div class="summary-row">
                          <span>è¨»å†Šæ™‚é–“:</span>
                          <span>${new Date(memberInfo.registeredAt).toLocaleString('zh-TW')}</span>
                      </div>
                      ` : ''}
                  `;
                  
                  // é¡¯ç¤ºè¨‚å–®åˆ—è¡¨
                  const tbody = document.getElementById('memberOrdersTableBody');
                  if (orders.length === 0) {
                      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">æš«ç„¡è¨‚å–®è¨˜éŒ„</td></tr>';
                  } else {
                      tbody.innerHTML = orders.map(order => `
                          <tr>
                              <td>${order.productCode}</td>
                              <td>${order.productName}</td>
                              <td>${order.quantity}</td>
                              <td>NT$ ${parseFloat(order.unitPrice).toLocaleString()}</td>
                              <td>NT$ ${parseFloat(order.totalPrice).toLocaleString()}</td>
                              <td>
                                  <button class="btn btn-warning" onclick="editOrder(${order.rowIndex})">ç·¨è¼¯</button>
                                  <button class="btn btn-danger" onclick="deleteOrder(${order.rowIndex})">åˆªé™¤</button>
                              </td>
                          </tr>
                      `).join('');
                  }
                  
                  // é¡¯ç¤ºè¨‚å–®æ‘˜è¦
                  const summaryDiv = document.getElementById('orderSummary');
                  summaryDiv.innerHTML = `
                      <div class="summary-row">
                          <span>è¨‚å–®é …ç›®:</span>
                          <span>${summary.orderCount} é …</span>
                      </div>
                      <div class="summary-row summary-total">
                          <span>ç¸½é‡‘é¡:</span>
                          <span>NT$ ${summary.totalAmount.toLocaleString()}</span>
                      </div>
                  `;
                  
                  // é¡¯ç¤ºç¹³è²»è¨˜éŒ„
                  const paymentTbody = document.getElementById('paymentHistoryTableBody');
                  if (payments.length === 0) {
                      paymentTbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">æš«ç„¡ç¹³è²»è¨˜éŒ„</td></tr>';
                  } else {
                      paymentTbody.innerHTML = payments.map(payment => `
                          <tr>
                              <td>${payment.paymentId}</td>
                              <td>NT$ ${parseFloat(payment.paymentAmount).toLocaleString()}</td>
                              <td>${payment.paymentMethod}</td>
                              <td>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</td>
                              <td><span class="status-badge status-${payment.status === 'å·²ç¢ºèª' ? 'approved' : payment.status === 'å·²æ‹’çµ•' ? 'rejected' : 'pending'}">${payment.status}</span></td>
                          </tr>
                      `).join('');
                  }
              })
              .catch(error => {
                  console.error('è¼‰å…¥æœƒå“¡è¨‚å–®å¤±æ•—:', error);
                  showAlert('è¼‰å…¥æœƒå“¡è¨‚å–®å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // ç·¨è¼¯è¨‚å–®
      function editOrder(rowIndex) {
          currentRowIndex = rowIndex;
          
          // å–å¾—ç•¶å‰è¨‚å–®è³‡æ–™
          const row = document.querySelector(`#memberOrdersTableBody tr:nth-child(${rowIndex - 1})`);
          if (!row) return;
          
          const cells = row.cells;
          document.getElementById('editLineName').value = currentMemberName;
          document.getElementById('editProductCode').value = cells[0].textContent;
          document.getElementById('editProductName').value = cells[1].textContent;
          document.getElementById('editQuantity').value = cells[2].textContent;
          document.getElementById('editUnitPrice').value = cells[3].textContent.replace('NT$ ', '').replace(/,/g, '');
          document.getElementById('editTotalPrice').value = cells[4].textContent.replace('NT$ ', '').replace(/,/g, '');
          
          document.getElementById('editOrderTitle').textContent = 'ç·¨è¼¯è¨‚å–®';
          document.getElementById('editOrderModal').style.display = 'block';
      }

      // æ–°å¢è¨‚å–®
      function addNewOrder() {
          currentRowIndex = null;
          
          document.getElementById('editLineName').value = currentMemberName;
          document.getElementById('editProductCode').value = '';
          document.getElementById('editProductName').value = '';
          document.getElementById('editQuantity').value = '1';
          document.getElementById('editUnitPrice').value = '0';
          document.getElementById('editTotalPrice').value = '0';
          
          document.getElementById('editOrderTitle').textContent = 'æ–°å¢è¨‚å–®';
          document.getElementById('editOrderModal').style.display = 'block';
      }

      // è¨ˆç®—ç¸½åƒ¹
      function calculateTotal() {
          const quantity = parseFloat(document.getElementById('editQuantity').value) || 0;
          const unitPrice = parseFloat(document.getElementById('editUnitPrice').value) || 0;
          const total = quantity * unitPrice;
          document.getElementById('editTotalPrice').value = total.toFixed(2);
      }

      // å„²å­˜è¨‚å–®
      function saveOrder() {
          const orderData = {
              lineName: document.getElementById('editLineName').value,
              productCode: document.getElementById('editProductCode').value,
              productName: document.getElementById('editProductName').value,
              quantity: parseFloat(document.getElementById('editQuantity').value),
              unitPrice: parseFloat(document.getElementById('editUnitPrice').value)
          };
          
          if (!orderData.lineName || !orderData.productCode || !orderData.productName || 
              !orderData.quantity || !orderData.unitPrice) {
              showAlert('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½', 'warning');
              return;
          }
          
          const action = currentRowIndex ? 'admin-update-member-order' : 'admin-add-member-order';
          const data = currentRowIndex ? 
              { rowIndex: currentRowIndex, orderData: orderData } : 
              { orderData: orderData };
          
          callAPI(action, data)
              .then(result => {
                  showAlert(result.message, 'success');
                  closeModal('editOrderModal');
                  loadMemberOrders(currentMemberName);
              })
              .catch(error => {
                  console.error('å„²å­˜è¨‚å–®å¤±æ•—:', error);
                  showAlert('å„²å­˜è¨‚å–®å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // åˆªé™¤è¨‚å–®
      function deleteOrder(rowIndex) {
          if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ')) return;
          
          callAPI('admin-delete-member-order', { rowIndex: rowIndex })
              .then(result => {
                  showAlert(result.message, 'success');
                  loadMemberOrders(currentMemberName);
              })
              .catch(error => {
                  console.error('åˆªé™¤è¨‚å–®å¤±æ•—:', error);
                  showAlert('åˆªé™¤è¨‚å–®å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // é¡¯ç¤ºå¯©æ ¸æ¨¡æ…‹æ¡†
      function showReviewModal(paymentId) {
          currentPaymentId = paymentId;
          
          // å–å¾—ç¹³è²»è©³ç´°è³‡è¨Š
          callAPI('admin-get-all-payments')
              .then(result => {
                  const payment = result.payments.find(p => p.paymentId === paymentId);
                  if (!payment) {
                      showAlert('æ‰¾ä¸åˆ°ç¹³è²»è¨˜éŒ„', 'danger');
                      return;
                  }
                  
                  document.getElementById('reviewPaymentInfo').innerHTML = `
                      <div class="order-summary">
                          <div class="summary-row">
                              <span>ç¹³è²»ç·¨è™Ÿ:</span>
                              <span>${payment.paymentId}</span>
                          </div>
                          <div class="summary-row">
                              <span>æœƒå“¡å§“å:</span>
                              <span>${payment.realName}</span>
                          </div>
                          <div class="summary-row">
                              <span>ç¹³è²»é‡‘é¡:</span>
                              <span>NT$ ${parseFloat(payment.paymentAmount).toLocaleString()}</span>
                          </div>
                          <div class="summary-row">
                              <span>ç¹³è²»æ–¹å¼:</span>
                              <span>${payment.paymentMethod}</span>
                          </div>
                          <div class="summary-row">
                              <span>æäº¤æ™‚é–“:</span>
                              <span>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</span>
                          </div>
                          ${payment.paymentNote ? `
                          <div class="summary-row">
                              <span>ç”¨æˆ¶å‚™è¨»:</span>
                              <span>${payment.paymentNote}</span>
                          </div>
                          ` : ''}
                      </div>
                  `;
                  
                  document.getElementById('reviewStatus').value = 'å·²ç¢ºèª';
                  document.getElementById('reviewNote').value = '';
                  document.getElementById('reviewModal').style.display = 'block';
              })
              .catch(error => {
                  console.error('è¼‰å…¥ç¹³è²»è©³æƒ…å¤±æ•—:', error);
                  showAlert('è¼‰å…¥ç¹³è²»è©³æƒ…å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // æäº¤å¯©æ ¸
      function submitReview() {
          const status = document.getElementById('reviewStatus').value;
          const reviewNote = document.getElementById('reviewNote').value;
          
          callAPI('admin-review-payment', {
              paymentId: currentPaymentId,
              status: status,
              reviewNote: reviewNote
          })
              .then(result => {
                  showAlert(result.message, 'success');
                  closeModal('reviewModal');
                  loadPendingPayments();
                  loadDashboard();
              })
              .catch(error => {
                  console.error('å¯©æ ¸å¤±æ•—:', error);
                  showAlert('å¯©æ ¸å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // å…¨é¸/å–æ¶ˆå…¨é¸
      function toggleSelectAll() {
          const selectAll = document.getElementById('selectAll');
          const checkboxes = document.querySelectorAll('.payment-checkbox');
          
          checkboxes.forEach(checkbox => {
              checkbox.checked = selectAll.checked;
          });
          
          updateSelectedPayments();
      }

      // æ›´æ–°é¸ä¸­çš„ç¹³è²»è¨˜éŒ„
      function updateSelectedPayments() {
          selectedPaymentIds = Array.from(document.querySelectorAll('.payment-checkbox:checked'))
              .map(checkbox => checkbox.value);
      }

      // é¡¯ç¤ºæ‰¹é‡å¯©æ ¸
      function showBatchReview(status) {
          updateSelectedPayments();
          
          if (selectedPaymentIds.length === 0) {
              showAlert('è«‹å…ˆé¸æ“‡è¦å¯©æ ¸çš„è¨˜éŒ„', 'warning');
              return;
          }
          
          batchReviewStatus = status;
          
          document.getElementById('batchReviewInfo').innerHTML = `
              <div class="alert alert-warning">
                  <strong>æ‰¹é‡å¯©æ ¸ç¢ºèª</strong><br>
                  æ‚¨å³å°‡å°‡ <strong>${selectedPaymentIds.length}</strong> ç­†ç¹³è²»è¨˜éŒ„æ¨™è¨˜ç‚º <strong>${status}</strong>
              </div>
          `;
          
          document.getElementById('batchReviewNote').value = '';
          document.getElementById('batchReviewModal').style.display = 'block';
      }

      // æäº¤æ‰¹é‡å¯©æ ¸
      function submitBatchReview() {
          const reviewNote = document.getElementById('batchReviewNote').value;
          
          callAPI('admin-batch-review', {
              paymentIds: selectedPaymentIds,
              status: batchReviewStatus,
              reviewNote: reviewNote
          })
              .then(result => {
                  showAlert(result.message, 'success');
                  closeModal('batchReviewModal');
                  loadPendingPayments();
                  loadDashboard();
                  
                  // æ¸…é™¤é¸æ“‡
                  document.getElementById('selectAll').checked = false;
                  selectedPaymentIds = [];
              })
              .catch(error => {
                  console.error('æ‰¹é‡å¯©æ ¸å¤±æ•—:', error);
                  showAlert('æ‰¹é‡å¯©æ ¸å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // ç”Ÿæˆæ—¥å ±è¡¨
      function generateDailyReport() {
          const targetDate = document.getElementById('reportDate').value;
          if (!targetDate) {
              showAlert('è«‹é¸æ“‡æ—¥æœŸ', 'warning');
              return;
          }
          
          const reportContent = document.getElementById('reportContent');
          reportContent.innerHTML = '<div class="loading"><div class="spinner"></div>ç”Ÿæˆå ±è¡¨ä¸­...</div>';
          
          callAPI('admin-get-daily-report', { targetDate: targetDate })
              .then(result => {
                  const report = result.report;
                  
                  reportContent.innerHTML = `
                      <div class="order-summary">
                          <h3>ğŸ“… ${report.date} æ—¥å ±è¡¨</h3>
                          
                          <div class="stats-grid" style="margin: 1rem 0;">
                              <div class="stat-card">
                                  <div class="stat-number">${report.newRegistrations}</div>
                                  <div class="stat-label">æ–°è¨»å†Šæœƒå“¡</div>
                              </div>
                              <div class="stat-card">
                                  <div class="stat-number">${report.newPayments}</div>
                                  <div class="stat-label">æ–°ç¹³è²»è¨˜éŒ„</div>
                              </div>
                              <div class="stat-card">
                                  <div class="stat-number">${report.approvedPayments}</div>
                                  <div class="stat-label">å¯©æ ¸é€šé</div>
                              </div>
                              <div class="stat-card">
                                  <div class="stat-number">NT$ ${report.totalAmount.toLocaleString()}</div>
                                  <div class="stat-label">ç¢ºèªé‡‘é¡</div>
                              </div>
                          </div>
                          
                          ${report.details.registrations.length > 0 ? `
                          <h4>ğŸ†• æ–°è¨»å†Šæœƒå“¡</h4>
                          <div class="table-container">
                              <table>
                                  <thead>
                                      <tr><th>çœŸå¯¦å§“å</th><th>LINEåç¨±</th><th>è¨»å†Šæ™‚é–“</th></tr>
                                  </thead>
                                  <tbody>
                                      ${report.details.registrations.map(reg => `
                                          <tr>
                                              <td>${reg.realName}</td>
                                              <td>${reg.lineDisplayName}</td>
                                              <td>${new Date(reg.registeredAt).toLocaleString('zh-TW')}</td>
                                          </tr>
                                      `).join('')}
                                  </tbody>
                              </table>
                          </div>
                          ` : ''}
                          
                          ${report.details.approvedPayments.length > 0 ? `
                          <h4>âœ… å¯©æ ¸é€šéç¹³è²»</h4>
                          <div class="table-container">
                              <table>
                                  <thead>
                                      <tr><th>ç¹³è²»ç·¨è™Ÿ</th><th>æœƒå“¡å§“å</th><th>é‡‘é¡</th></tr>
                                  </thead>
                                  <tbody>
                                      ${report.details.approvedPayments.map(payment => `
                                          <tr>
                                              <td>${payment.paymentId}</td>
                                              <td>${payment.realName}</td>
                                              <td>NT$ ${parseFloat(payment.paymentAmount).toLocaleString()}</td>
                                          </tr>
                                      `).join('')}
                                  </tbody>
                              </table>
                          </div>
                          ` : ''}
                      </div>
                  `;
              })
              .catch(error => {
                  console.error('ç”Ÿæˆæ—¥å ±è¡¨å¤±æ•—:', error);
                  reportContent.innerHTML = `<div class="alert alert-danger">ç”Ÿæˆå ±è¡¨å¤±æ•—: ${error.message}</div>`;
              });
      }

      // åŒ¯å‡ºæ‰€æœ‰è³‡æ–™
      function exportAllData() {
          callAPI('admin-export-data')
              .then(result => {
                  const dataStr = JSON.stringify(result.data, null, 2);
                  const dataBlob = new Blob([dataStr], {type: 'application/json'});
                  const url = URL.createObjectURL(dataBlob);
                  const link = document.createElement('a');
                  link.href = url;
                  link.download = `system_export_${new Date().toISOString().split('T')[0]}.json`;
                  link.click();
                  URL.revokeObjectURL(url);
                  
                  showAlert('è³‡æ–™åŒ¯å‡ºæˆåŠŸ', 'success');
              })
              .catch(error => {
                  console.error('åŒ¯å‡ºè³‡æ–™å¤±æ•—:', error);
                  showAlert('åŒ¯å‡ºè³‡æ–™å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // æ¸…ç†æ¸¬è©¦è³‡æ–™
      function cleanupTestData() {
          if (!confirm('ç¢ºå®šè¦æ¸…ç†æ‰€æœ‰æ¸¬è©¦è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
          
          callAPI('admin-cleanup-test-data')
              .then(result => {
                  showAlert(result.message, 'success');
                  loadDashboard();
              })
              .catch(error => {
                  console.error('æ¸…ç†æ¸¬è©¦è³‡æ–™å¤±æ•—:', error);
                  showAlert('æ¸…ç†æ¸¬è©¦è³‡æ–™å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // ç³»çµ±ç¶­è­·åŠŸèƒ½
      function initializeSystem() {
          callAPI('admin-initialize-system')
              .then(result => {
                  showAlert(result.message, 'success');
                  updateSystemStatus(result.details);
              })
              .catch(error => {
                  console.error('ç³»çµ±åˆå§‹åŒ–å¤±æ•—:', error);
                  showAlert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'danger');
              });
      }

      function setupTriggers() {
          callAPI('admin-setup-triggers')
              .then(result => {
                  showAlert(result.message, 'success');
              })
              .catch(error => {
                  console.error('è¨­å®šè§¸ç™¼å™¨å¤±æ•—:', error);
                  showAlert('è¨­å®šè§¸ç™¼å™¨å¤±æ•—: ' + error.message, 'danger');
              });
      }

      function cleanupOldLogs() {
          callAPI('admin-cleanup-old-logs')
              .then(result => {
                  showAlert(result.message, 'success');
              })
              .catch(error => {
                  console.error('æ¸…ç†æ—¥èªŒå¤±æ•—:', error);
                  showAlert('æ¸…ç†æ—¥èªŒå¤±æ•—: ' + error.message, 'danger');
              });
      }

      function checkSystemHealth() {
          callAPI('admin-check-system-health')
              .then(result => {
                  updateSystemStatus([`ç³»çµ±ç‹€æ…‹: ${result.health.status}`]);
                  showAlert('ç³»çµ±å¥åº·æª¢æŸ¥å®Œæˆ', 'success');
              })
              .catch(error => {
                  console.error('ç³»çµ±å¥åº·æª¢æŸ¥å¤±æ•—:', error);
                  showAlert('ç³»çµ±å¥åº·æª¢æŸ¥å¤±æ•—: ' + error.message, 'danger');
              });
      }

      function backupData() {
          const backupSpreadsheetId = document.getElementById('backupSpreadsheetId').value.trim();
          if (!backupSpreadsheetId) {
              showAlert('è«‹è¼¸å…¥å‚™ä»½è©¦ç®—è¡¨ ID', 'warning');
              return;
          }
          
          callAPI('admin-backup-data', { backupSpreadsheetId: backupSpreadsheetId })
              .then(result => {
                  showAlert(result.message, 'success');
              })
              .catch(error => {
                  console.error('å‚™ä»½è³‡æ–™å¤±æ•—:', error);
                  showAlert('å‚™ä»½è³‡æ–™å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // æ›´æ–°ç³»çµ±ç‹€æ…‹é¡¯ç¤º
      function updateSystemStatus(details) {
          const statusDiv = document.getElementById('systemStatus');
          statusDiv.innerHTML = `
              <div class="alert alert-success">
                  <h4>ç³»çµ±ç‹€æ…‹</h4>
                  <ul>
                      ${details.map(detail => `<li>${detail}</li>`).join('')}
                  </ul>
              </div>
          `;
      }

      // å·¥å…·å‡½æ•¸
      function closeModal(modalId) {
          document.getElementById(modalId).style.display = 'none';
      }

      function showAlert(message, type = 'info') {
          const alertDiv = document.createElement('div');
          alertDiv.className = `alert alert-${type}`;
          alertDiv.textContent = message;
          alertDiv.style.position = 'fixed';
          alertDiv.style.top = '20px';
          alertDiv.style.right = '20px';
          alertDiv.style.zIndex = '9999';
          alertDiv.style.minWidth = '300px';
          
          document.body.appendChild(alertDiv);
          
          setTimeout(() => {
              alertDiv.remove();
          }, 5000);
      }

      // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
      window.onclick = function(event) {
          const modals = document.querySelectorAll('.modal');
          modals.forEach(modal => {
              if (event.target === modal) {
                  modal.style.display = 'none';
              }
          });
      }

      // ç›£è½è¤‡é¸æ¡†è®ŠåŒ–
      document.addEventListener('change', function(event) {
          if (event.target.classList.contains('payment-checkbox')) {
              updateSelectedPayments();
          }
      });
  </script>
</body>
</html>è¨‚è³¼ç®¡ç†ç³»çµ± v2.0</title>
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', sans-serif;
        background: linear-gradient(135deg, #00B900, #00D300);
        min-height: 100vh;
        padding: 15px;
        line-height: 1.6;
    }
    
    .container {
        max-width: 420px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        overflow: hidden;
        animation: slideUp 0.5s ease-out;
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .header {
        background: linear-gradient(45deg, #00B900, #00D300);
        color: white;
        padding: 30px 20px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    .header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: repeating-linear-gradient(
            45deg,
            transparent,
            transparent 10px,
            rgba(255,255,255,0.1) 10px,
            rgba(255,255,255,0.1) 20px
        );
        animation: shimmer 3s linear infinite;
    }
    
    @keyframes shimmer {
        0% { transform: translateX(-100%) translateY(-100%); }
        100% { transform: translateX(100%) translateY(100%); }
    }
    
    .header h1 {
        font-size: 24px;
        margin-bottom: 8px;
        position: relative;
        z-index: 1;
    }
    
    .header p {
        opacity: 0.9;
        font-size: 14px;
        position: relative;
        z-index: 1;
    }
    
    .content {
        padding: 25px 20px;
    }
    
    .tab-buttons {
        display: flex;
        margin-bottom: 25px;
        border-radius: 12px;
        overflow: hidden;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
    }
    
    .tab-button {
        flex: 1;
        padding: 12px 8px;
        text-align: center;
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: all 0.3s ease;
        color: #6c757d;
        position: relative;
    }
    
    .tab-button.active {
        background: #00B900;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 185, 0, 0.3);
    }
    
    .tab-button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none;
    }
    
    .tab-button::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 0;
        height: 2px;
        background: #00B900;
        transition: all 0.3s ease;
        transform: translateX(-50%);
    }
    
    .tab-button.active::after {
        width: 80%;
    }
    
    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease-in;
    }
    
    .tab-content.active {
        display: block;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        font-size: 14px;
    }
    
    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: #fff;
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
        outline: none;
        border-color: #00B900;
        box-shadow: 0 0 0 3px rgba(0, 185, 0, 0.1);
        transform: translateY(-1px);
    }
    
    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }
    
    .btn {
        width: 100%;
        padding: 16px;
        background: linear-gradient(45deg, #00B900, #00D300);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }
    
    .btn:hover::before {
        left: 100%;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 185, 0, 0.3);
    }
    
    .btn:active {
        transform: translateY(0);
    }
    
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .btn.secondary {
        background: linear-gradient(45deg, #6c757d, #495057);
    }
    
    .btn.danger {
        background: linear-gradient(45deg, #dc3545, #c82333);
    }
    
    .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    
    .btn-group .btn {
        flex: 1;
    }
    
    .user-info {
        background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 25px;
        border: 1px solid #d4edda;
        position: relative;
    }
    
    .user-info::before {
        content: 'ğŸ‘¤';
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 24px;
        opacity: 0.3;
    }
    
    .user-info h3 {
        color: #00B900;
        margin-bottom: 15px;
        font-size: 18px;
    }
    
    .profile-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin: 0 auto 15px;
        display: block;
        border: 3px solid #00B900;
        box-shadow: 0 4px 12px rgba(0, 185, 0, 0.2);
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid rgba(0, 185, 0, 0.1);
        font-size: 14px;
    }
    
    .info-item:last-child {
        border-bottom: none;
    }
    
    .info-label {
        font-weight: 600;
        color: #155724;
        min-width: 80px;
    }
    
    .info-value {
        color: #333;
        text-align: right;
        word-break: break-all;
        max-width: 200px;
    }
    
    .welcome-message, .registered-info {
        background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 25px;
        border: 1px solid #d4edda;
        position: relative;
    }
    
    .welcome-message::before {
        content: 'ğŸ‘‹';
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 24px;
    }
    
    .registered-info::before {
        content: 'âœ…';
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 24px;
    }
    
    .welcome-message h3, .registered-info h3 {
        color: #00B900;
        margin-bottom: 10px;
        font-size: 18px;
    }
    
    .welcome-message p, .registered-info p {
        color: #155724;
        font-size: 14px;
        line-height: 1.5;
    }
    
    .order-summary {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        border-left: 5px solid #ffc107;
        position: relative;
    }
    
    .order-summary::before {
        content: 'ğŸ“‹';
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 24px;
    }
    
    .order-summary h3 {
        color: #856404;
        margin-bottom: 15px;
        font-size: 18px;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(133, 100, 4, 0.2);
        font-size: 14px;
    }
    
    .summary-item:last-child {
        border-bottom: none;
        font-weight: bold;
        font-size: 16px;
        color: #856404;
        margin-top: 10px;
        padding-top: 15px;
        border-top: 2px solid rgba(133, 100, 4, 0.3);
    }
    
    .product-list {
        background: #f8f9fa;
        padding: 18px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid #e9ecef;
    }
    
    .product-list h4 {
        color: #495057;
        margin-bottom: 15px;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .product-list h4::before {
        content: 'ğŸ“¦';
    }
    
    .product-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 12px 0;
        border-bottom: 1px solid #e9ecef;
        font-size: 14px;
    }
    
    .product-item:last-child {
        border-bottom: none;
    }
    
    .product-info {
        flex: 1;
    }
    
    .product-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }
    
    .product-code {
        font-size: 12px;
        color: #6c757d;
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 4px;
        display: inline-block;
    }
    
    .product-details {
        text-align: right;
        color: #495057;
        min-width: 100px;
    }
    
    .product-price {
        font-weight: 600;
        color: #00B900;
    }
    
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 40px 20px;
        color: #6c757d;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #00B900;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .error, .success, .warning, .info {
        padding: 15px 18px;
        border-radius: 12px;
        margin-bottom: 20px;
        font-size: 14px;
        font-weight: 500;
        position: relative;
        animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .error {
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        color: #721c24;
        border-left: 4px solid #dc3545;
    }
    
    .success {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        color: #155724;
        border-left: 4px solid #28a745;
    }
    
    .warning {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        color: #856404;
        border-left: 4px solid #ffc107;
    }
    
    .info {
        background: linear-gradient(135deg, #d1ecf1, #bee5eb);
        color: #0c5460;
        border-left: 4px solid #17a2b8;
    }
    
    .lock-message {
        text-align: center;
        padding: 50px 20px;
        color: #6c757d;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 15px;
        margin: 20px 0;
        border: 2px dashed #dee2e6;
    }
    
    .lock-icon {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    .lock-message h3 {
        margin-bottom: 10px;
        color: #495057;
    }
    
    .payment-status {
        margin-top: 20px;
    }
    
    .payment-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 10px;
        border-left: 4px solid #6c757d;
    }
    
    .payment-item.pending {
        border-left-color: #ffc107;
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    }
    
    .payment-item.approved {
        border-left-color: #28a745;
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
    }
    
    .payment-item.rejected {
        border-left-color: #dc3545;
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-pending {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-approved {
        background: #d4edda;
        color: #155724;
    }
    
    .status-rejected {
        background: #f8d7da;
        color: #721c24;
    }
    
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        z-index: 1000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        max-width: 300px;
        word-wrap: break-word;
    }
    
    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 480px) {
        body {
            padding: 10px;
        }
        
        .container {
            border-radius: 15px;
        }
        
        .header {
            padding: 25px 15px;
        }
        
        .content {
            padding: 20px 15px;
        }
        
        .btn-group {
            flex-direction: column;
        }
        
        .btn-group .btn {
            margin-bottom: 10px;
        }
        
        .tab-button {
            font-size: 12px;
            padding: 10px 6px;
        }
        
        .toast {
            right: 10px;
            left: 10px;
            max-width: none;
            transform: translateY(-100%);
        }
        
        .toast.show {
            transform: translateY(0);
        }
    }
    
    /* æ·±è‰²æ¨¡å¼æ”¯æ´ */
    @media (prefers-color-scheme: dark) {
        body {
            background: linear-gradient(135deg, #1a5d1a, #2d8f2d);
        }
        
        .container {
            background: #2d2d2d;
            color: #ffffff;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            background: #404040;
            color: #ffffff;
            border-color: #555555;
        }
        
        .product-list {
            background: #404040;
            border-color: #555555;
        }
        
        .tab-buttons {
            background: #404040;
            border-color: #555555;
        }
        
        .lock-message {
            background: linear-gradient(135deg, #404040, #555555);
            border-color: #666666;
            color: #cccccc;
        }
    }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ›’ è¨‚è³¼ç®¡ç†ç³»çµ±</h1>
        <p>å¯¦ååˆ¶ç™»è¨˜ Â· è¨‚å–®æŸ¥è©¢ Â· ç¹³è²»å›å ±</p>
    </div>
    
    <div class="content">
        <!-- ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º -->
        <div id="userInfo" class="user-info" style="display: none;">
            <h3>ç”¨æˆ¶è³‡è¨Š</h3>
            <img id="userAvatar" class="profile-avatar" style="display: none;">
            <div id="userDetails"></div>
        </div>
        
        <!-- æ¨™ç±¤é æŒ‰éˆ• -->
        <div class="tab-buttons">
            <button class="tab-button active" onclick="switchTab('register', event)">å¯¦åç™»è¨˜</button>
            <button class="tab-button" id="ordersTab" onclick="switchTab('orders', event)" disabled>æˆ‘çš„è¨‚å–®</button>
            <button class="tab-button" id="paymentTab" onclick="switchTab('payment', event)" disabled>ç¹³è²»å›å ±</button>
            <button class="tab-button" id="statusTab" onclick="switchTab('status', event)" disabled>ç¹³è²»ç‹€æ…‹</button>
        </div>
        
        <!-- å¯¦ååˆ¶ç™»è¨˜ -->
        <div id="register" class="tab-content active">
            <!-- æœªè¨»å†Šç‹€æ…‹ -->
            <div id="registerForm" style="display: none;">
                <div class="welcome-message">
                    <h3>æ­¡è¿ä½¿ç”¨è¨‚è³¼ç³»çµ±</h3>
                    <p>è«‹å…ˆå®Œæˆå¯¦ååˆ¶ç™»è¨˜ï¼Œå³å¯æŸ¥è©¢è¨‚å–®åŠé€²è¡Œç¹³è²»å›å ±ã€‚æˆ‘å€‘æœƒä¿è­·æ‚¨çš„å€‹äººè³‡æ–™å®‰å…¨ã€‚</p>
                </div>
                
                <h2 style="margin-bottom: 20px; color: #333;">ğŸ“ å¯¦ååˆ¶ç™»è¨˜</h2>
                <form id="nameForm">
                    <div class="form-group">
                        <label for="realNameInput">çœŸå¯¦å§“å *</label>
                        <input type="text" id="realNameInput" name="realName" required 
                               placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å" maxlength="20">
                        <small style="color: #6c757d; font-size: 12px;">è«‹è¼¸å…¥2-20å€‹å­—çš„çœŸå¯¦å§“å</small>
                    </div>
                    
                    <button type="submit" class="btn" id="registerSubmitBtn">
                        <span>å®Œæˆç™»è¨˜</span>
                    </button>
                </form>
            </div>
            
            <!-- å·²è¨»å†Šç‹€æ…‹ -->
            <div id="registeredStatus" style="display: none;">
                <div class="registered-info">
                    <h3>å¯¦ååˆ¶ç™»è¨˜å®Œæˆ</h3>
                    <p>æ‚¨å·²å®Œæˆå¯¦ååˆ¶ç™»è¨˜ï¼Œå¯ä»¥ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ã€‚æ„Ÿè¬æ‚¨çš„é…åˆï¼</p>
                </div>
                
                <div class="btn-group">
                    <button class="btn" onclick="switchTab('orders', event)">æŸ¥çœ‹æˆ‘çš„è¨‚å–®</button>
                    <button class="btn secondary" onclick="switchTab('payment', event)">é€²è¡Œç¹³è²»å›å ±</button>
                </div>
            </div>
        </div>
        
        <!-- è¨‚å–®æŸ¥è©¢ -->
        <div id="orders" class="tab-content">
            <div id="ordersContent">
                <div class="lock-message">
                    <div class="lock-icon">ğŸ”’</div>
                    <h3>è«‹å…ˆå®Œæˆå¯¦ååˆ¶ç™»è¨˜</h3>
                    <p>å®Œæˆç™»è¨˜å¾Œå³å¯æŸ¥è©¢æ‚¨çš„è¨‚å–®è³‡è¨Š</p>
                </div>
            </div>
        </div>
        
        <!-- ç¹³è²»å›å ± -->
        <div id="payment" class="tab-content">
            <div id="paymentContent">
                <div class="lock-message">
                    <div class="lock-icon">ğŸ”’</div>
                    <h3>è«‹å…ˆå®Œæˆå¯¦ååˆ¶ç™»è¨˜</h3>
                    <p>å®Œæˆç™»è¨˜å¾Œå³å¯é€²è¡Œç¹³è²»å›å ±</p>
                </div>
            </div>
        </div>
        
        <!-- ç¹³è²»ç‹€æ…‹ -->
        <div id="status" class="tab-content">
            <div id="statusContent">
                <div class="lock-message">
                    <div class="lock-icon">ğŸ”’</div>
                    <h3>è«‹å…ˆå®Œæˆå¯¦ååˆ¶ç™»è¨˜</h3>
                    <p>å®Œæˆç™»è¨˜å¾Œå³å¯æŸ¥çœ‹ç¹³è²»ç‹€æ…‹</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // è¨­å®šå€åŸŸ - è«‹ä¿®æ”¹ç‚ºæ‚¨çš„å¯¦éš›å€¼
    const CONFIG = {
        LIFF_ID: '1657285806-2bmkYWkN', // è«‹æ›¿æ›ç‚ºå¯¦éš›çš„ LIFF ID
        API_BASE_URL: 'https://script.google.com/macros/s/AKfycbyIL2QSFaU-T91GNgPa5VwvoqzJR21MJfCjbtpgU8xeW0l7p7POCsuTmMWlfmDDPtHH/exec', // è«‹æ›¿æ›ç‚º GAS éƒ¨ç½²ç¶²å€
        DEBUG_MODE: true, // é–‹ç™¼æ™‚è¨­ç‚º trueï¼Œæ­£å¼ç’°å¢ƒè¨­ç‚º false
        MAX_RETRY_COUNT: 3,
        RETRY_DELAY: 1000
    };

    // å…¨åŸŸè®Šæ•¸
    let userId = null;
    let userProfile = null;
    let liffContext = null;
    let liffEnvironment = null;
    let isRegistered = false;
    let userRegistrationData = null;
    let currentOrderSummary = null;
    let apiConnected = false;

    // é™¤éŒ¯å‡½æ•¸
    function debugLog(message, data = null) {
        if (CONFIG.DEBUG_MODE) {
            console.log(`[DEBUG] ${message}`, data || '');
        }
    }

    // UI ç®¡ç†é¡åˆ¥
    class UIManager {
        static showLoading(elementId, message = 'è¼‰å…¥ä¸­...') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <p>${message}</p>
                    </div>
                `;
            }
        }
        
        static hideLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = '';
            }
        }
        
        static showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#17a2b8'
            };
            toast.style.backgroundColor = colors[type] || colors.info;
            
            document.body.appendChild(toast);
            
            // é¡¯ç¤ºå‹•ç•«
            setTimeout(() => {
                toast.style.transform = window.innerWidth <= 480 ? 'translateY(0)' : 'translateX(0)';
                toast.classList.add('show');
            }, 100);
            
            // è‡ªå‹•ç§»é™¤
            setTimeout(() => {
                toast.style.transform = window.innerWidth <= 480 ? 'translateY(-100%)' : 'translateX(100%)';
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }
    }

    // è¡¨å–®é©—è­‰é¡åˆ¥
    class FormValidator {
        static validateRealName(name) {
            if (!name || name.trim().length < 2) {
                return { valid: false, message: 'è«‹è¼¸å…¥è‡³å°‘2å€‹å­—çš„çœŸå¯¦å§“å' };
            }
            
            if (name.length > 20) {
                return { valid: false, message: 'å§“åé•·åº¦ä¸èƒ½è¶…é20å€‹å­—' };
            }
            
            const invalidChars = /[<>\"'&]/;
            if (invalidChars.test(name)) {
                return { valid: false, message: 'å§“åä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦' };
            }
            
            return { valid: true };
        }
        
        static validatePaymentNote(note) {
            if (note && note.length > 200) {
                return { valid: false, message: 'å‚™è¨»é•·åº¦ä¸èƒ½è¶…é200å€‹å­—' };
            }
            
            return { valid: true };
        }
    }

    // åˆå§‹åŒ– LIFF
    window.onload = function() {
        debugLog('é–‹å§‹åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼');
        initializeLiff();
    };

    async function initializeLiff() {
        try {
            debugLog('LIFF åˆå§‹åŒ–ä¸­...', { liffId: CONFIG.LIFF_ID });
            
            await liff.init({ liffId: CONFIG.LIFF_ID });
            debugLog('LIFF åˆå§‹åŒ–æˆåŠŸ');
            
            await collectLiffEnvironmentInfo();
            
            if (liff.isLoggedIn()) {
                debugLog('ç”¨æˆ¶å·²ç™»å…¥');
                userProfile = await liff.getProfile();
                userId = userProfile.userId;
                
                debugLog('å–å¾—ç”¨æˆ¶è³‡æ–™', {
                    userId: userId,
                    displayName: userProfile.displayName
                });
                
                displayUserInfo();
                await testApiConnection();
                await checkUserRegistration();
            } else {
                debugLog('ç”¨æˆ¶æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
                liff.login();
            }
        } catch (error) {
            debugLog('LIFFåˆå§‹åŒ–å¤±æ•—', error);
            console.error('LIFFåˆå§‹åŒ–å¤±æ•—:', error);
            showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°é–‹å•Ÿ: ' + error.message);
        }
    }

    async function collectLiffEnvironmentInfo() {
        try {
            liffEnvironment = {
                version: liff.getVersion(),
                language: liff.getLanguage(),
                isInClient: liff.isInClient(),
                isLoggedIn: liff.isLoggedIn(),
                os: liff.getOS(),
                lineVersion: liff.getLineVersion()
            };

            liffContext = liff.getContext();
            
            debugLog('LIFF ç’°å¢ƒè³‡è¨Š', liffEnvironment);
            debugLog('LIFF ä¸Šä¸‹æ–‡', liffContext);
            
        } catch (error) {
            debugLog('æ”¶é›† LIFF ç’°å¢ƒè³‡è¨Šå¤±æ•—', error);
            console.error('æ”¶é›† LIFF ç’°å¢ƒè³‡è¨Šå¤±æ•—:', error);
        }
    }

    async function testApiConnection() {
        try {
            debugLog('æ¸¬è©¦ API é€£ç·š');
            
            const testResult = await callAPIWithRetry('test', { test: true });
            
            if (testResult && testResult.success !== false) {
                debugLog('API é€£ç·šæ¸¬è©¦æˆåŠŸ', testResult);
                apiConnected = true;
            } else {
                debugLog('API é€£ç·šæ¸¬è©¦å¤±æ•—', testResult);
                apiConnected = false;
                UIManager.showToast('API é€£ç·šç•°å¸¸ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨', 'warning', 5000);
            }
        } catch (error) {
            debugLog('API é€£ç·šæ¸¬è©¦å¤±æ•—', error);
            apiConnected = false;
            UIManager.showToast('ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error', 5000);
        }
    }

    function displayUserInfo() {
        if (!userProfile) return;
        
        const userInfoDiv = document.getElementById('userInfo');
        const userDetailsDiv = document.getElementById('userDetails');
        const userAvatar = document.getElementById('userAvatar');
        
        if (!userInfoDiv || !userDetailsDiv) return;

        if (userProfile.pictureUrl && userAvatar) {
            userAvatar.src = userProfile.pictureUrl;
            userAvatar.style.display = 'block';
            userAvatar.onerror = function() {
                this.style.display = 'none';
            };
        }

        let html = `
            <div class="info-item">
                <span class="info-label">LINE åç¨±:</span>
                <span class="info-value">${userProfile.displayName}</span>
            </div>
        `;

        if (userProfile.statusMessage) {
            html += `
                <div class="info-item">
                    <span class="info-label">ç‹€æ…‹è¨Šæ¯:</span>
                    <span class="info-value">${userProfile.statusMessage}</span>
                </div>
            `;
        }

        if (userRegistrationData && userRegistrationData.realName) {
            html += `
                <div class="info-item">
                    <span class="info-label">çœŸå¯¦å§“å:</span>
                    <span class="info-value">${userRegistrationData.realName}</span>
                </div>
            `;
        }

        if (userRegistrationData && userRegistrationData.registeredAt) {
            const regDate = new Date(userRegistrationData.registeredAt);
            html += `
                <div class="info-item">
                    <span class="info-label">è¨»å†Šæ™‚é–“:</span>
                    <span class="info-value">${regDate.toLocaleString('zh-TW')}</span>
                </div>
            `;
        }

        userDetailsDiv.innerHTML = html;
        userInfoDiv.style.display = 'block';
    }

    async function checkUserRegistration() {
        try {
            debugLog('æª¢æŸ¥ç”¨æˆ¶è¨»å†Šç‹€æ…‹');
            
            const result = await callAPIWithRetry('check-registration', {
                userId: userId,
                lineDisplayName: userProfile.displayName,
                liffContext: liffContext,
                liffEnvironment: liffEnvironment,
                timestamp: new Date().toISOString()
            });
            
            if (result && result.success && result.registered) {
                debugLog('ç”¨æˆ¶å·²è¨»å†Š', result.userInfo);
                isRegistered = true;
                userRegistrationData = result.userInfo;
                
                showRegisteredStatus();
                enableAllTabs();
                displayUserInfo();
                
                UIManager.showToast('æ­¡è¿å›ä¾†ï¼Œ' + result.userInfo.realName, 'success');
            } else {
                debugLog('ç”¨æˆ¶æœªè¨»å†Š');
                isRegistered = false;
                showRegistrationForm();
            }
            
        } catch (error) {
            debugLog('æª¢æŸ¥è¨»å†Šç‹€æ…‹å¤±æ•—', error);
            console.error('æª¢æŸ¥è¨»å†Šç‹€æ…‹å¤±æ•—:', error);
            showError('æª¢æŸ¥è¨»å†Šç‹€æ…‹å¤±æ•—: ' + error.message);
        }
    }

    function showRegistrationForm() {
        document.getElementById('registerForm').style.display = 'block';
        document.getElementById('registeredStatus').style.display = 'none';
    }

    function showRegisteredStatus() {
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('registeredStatus').style.display = 'block';
    }

    function enableAllTabs() {
        const tabs = ['ordersTab', 'paymentTab', 'statusTab'];
        tabs.forEach(tabId => {
            const tab = document.getElementById(tabId);
            if (tab) {
                tab.disabled = false;
            }
        });
    }

    // API å‘¼å«å‡½æ•¸ï¼ˆå¸¶é‡è©¦æ©Ÿåˆ¶ï¼‰
    async function callAPIWithRetry(action, data, maxRetries = CONFIG.MAX_RETRY_COUNT) {
        let lastError;
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                debugLog(`API å‘¼å«å˜—è©¦ ${attempt}/${maxRetries}: ${action}`);
                
                const result = await callAPI(action, data);
                
                if (result && result.success !== false) {
                    return result;
                } else {
                    throw new Error(result?.message || 'API å›æ‡‰éŒ¯èª¤');
                }
            } catch (error) {
                lastError = error;
                debugLog(`API å‘¼å«å¤±æ•— (å˜—è©¦ ${attempt}/${maxRetries}):`, error);
                
                if (attempt < maxRetries) {
                    const delay = CONFIG.RETRY_DELAY * Math.pow(2, attempt - 1);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        throw lastError;
    }

    // åŸºæœ¬ API å‘¼å«å‡½æ•¸
    function callAPI(action, data) {
        return new Promise((resolve, reject) => {
            const requestData = {
                action: action,
                data: JSON.stringify(data),
                callback: 'handleAPIResponse_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
            };
            
            debugLog('API è«‹æ±‚', { action, data, callback: requestData.callback });
            
            // å»ºç«‹ JSONP å›èª¿å‡½æ•¸
            window[requestData.callback] = function(response) {
                debugLog('API å›æ‡‰', response);
                delete window[requestData.callback];
                resolve(response);
            };
            
            // å»ºç«‹ script æ¨™ç±¤
            const script = document.createElement('script');
            const params = new URLSearchParams(requestData);
            script.src = CONFIG.API_BASE_URL + '?' + params.toString();
            
            // è¨­å®šè¶…æ™‚è™•ç†
            const timeout = setTimeout(() => {
                delete window[requestData.callback];
                document.head.removeChild(script);
                reject(new Error('API è«‹æ±‚è¶…æ™‚'));
            }, 30000);
            
            script.onload = function() {
                clearTimeout(timeout);
                document.head.removeChild(script);
            };
            
            script.onerror = function() {
                clearTimeout(timeout);
                delete window[requestData.callback];
                document.head.removeChild(script);
                reject(new Error('API è«‹æ±‚å¤±æ•—'));
            };
            
            document.head.appendChild(script);
        });
    }

    // æ¨™ç±¤é åˆ‡æ›
    function switchTab(tabName, event) {
        if (event) {
            event.preventDefault();
        }
        
        debugLog('åˆ‡æ›æ¨™ç±¤é ', tabName);
        
        // æª¢æŸ¥æ˜¯å¦éœ€è¦è¨»å†Š
        if (!isRegistered && ['orders', 'payment', 'status'].includes(tabName)) {
            UIManager.showToast('è«‹å…ˆå®Œæˆå¯¦ååˆ¶ç™»è¨˜', 'warning');
            return;
        }
        
        // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => {
            content.classList.remove('active');
        });
        
        // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => {
            button.classList.remove('active');
        });
        
        // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
        const selectedTab = document.getElementById(tabName);
        if (selectedTab) {
            selectedTab.classList.add('active');
        }
        
        // è¨­å®šå°æ‡‰æŒ‰éˆ•ç‚º active
        if (event && event.target) {
            event.target.classList.add('active');
        }
        
        // è¼‰å…¥å°æ‡‰å…§å®¹
        loadTabContent(tabName);
    }

    async function loadTabContent(tabName) {
        switch (tabName) {
            case 'orders':
                await loadOrdersContent();
                break;
            case 'payment':
                await loadPaymentContent();
                break;
            case 'status':
                await loadStatusContent();
                break;
        }
    }

    async function loadOrdersContent() {
        if (!isRegistered || !userRegistrationData) return;
        
        const contentDiv = document.getElementById('ordersContent');
        UIManager.showLoading('ordersContent', 'è¼‰å…¥è¨‚å–®è³‡æ–™ä¸­...');
        
        try {
            const result = await callAPIWithRetry('get-orders', {
                userId: userId,
                lineName: userProfile.displayName,
                realName: userRegistrationData.realName
            });
            
            if (result && result.success) {
                if (result.orderSummary) {
                    currentOrderSummary = result.orderSummary;
                    displayOrderSummary(result.orderSummary);
                } else {
                    contentDiv.innerHTML = `
                        <div class="info">
                            <h3>ğŸ“‹ è¨‚å–®æŸ¥è©¢çµæœ</h3>
                            <p>${result.message || 'ç›®å‰æ²’æœ‰è¨‚è³¼è¨˜éŒ„'}</p>
                        </div>
                    `;
                }
            } else {
                throw new Error(result?.message || 'è¼‰å…¥è¨‚å–®å¤±æ•—');
            }
            
        } catch (error) {
            debugLog('è¼‰å…¥è¨‚å–®å¤±æ•—', error);
            contentDiv.innerHTML = `
                <div class="error">
                    <h3>âŒ è¼‰å…¥å¤±æ•—</h3>
                    <p>${error.message}</p>
                    <button class="btn" onclick="loadOrdersContent()" style="margin-top: 15px;">
                        é‡æ–°è¼‰å…¥
                    </button>
                </div>
            `;
        }
    }

    function displayOrderSummary(orderSummary) {
        const contentDiv = document.getElementById('ordersContent');
        
        let html = `
            <div class="order-summary">
                <h3>ğŸ“‹ è¨‚å–®æ‘˜è¦</h3>
                <div class="summary-item">
                    <span>è¨‚å–®ç·¨è™Ÿ:</span>
                    <span>${orderSummary.orderId}</span>
                </div>
                <div class="summary-item">
                    <span>LINE åç¨±:</span>
                    <span>${orderSummary.lineName}</span>
                </div>
                <div class="summary-item">
                    <span>çœŸå¯¦å§“å:</span>
                    <span>${orderSummary.realName}</span>
                </div>
                <div class="summary-item">
                    <span>å•†å“ç¨®é¡:</span>
                    <span>${orderSummary.productCount} ç¨®</span>
                </div>
                <div class="summary-item">
                    <span>ç¸½æ•¸é‡:</span>
                    <span>${orderSummary.totalQuantity} ä»¶</span>
                </div>
                <div class="summary-item">
                    <span>è¨‚å–®ç¸½é¡:</span>
                    <span>NT$ ${orderSummary.totalAmount.toLocaleString()}</span>
                </div>
            </div>
        `;
        
        if (orderSummary.products && orderSummary.products.length > 0) {
            html += `
                <div class="product-list">
                    <h4>ğŸ“¦ å•†å“æ˜ç´°</h4>
            `;
            
            orderSummary.products.forEach(product => {
                html += `
                    <div class="product-item">
                        <div class="product-info">
                            <div class="product-name">${product.productName}</div>
                            <div class="product-code">${product.productCode}</div>
                        </div>
                        <div class="product-details">
                            <div>æ•¸é‡: ${product.quantity}</div>
                            <div>å–®åƒ¹: NT$ ${product.unitPrice.toLocaleString()}</div>
                            <div class="product-price">å°è¨ˆ: NT$ ${product.totalPrice.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
        }
        
        html += `
            <div class="btn-group">
                <button class="btn" onclick="switchTab('payment', event)">
                    ğŸ’° å‰å¾€ç¹³è²»å›å ±
                </button>
                <button class="btn secondary" onclick="loadOrdersContent()">
                    ğŸ”„ é‡æ–°æ•´ç†
                </button>
            </div>
        `;
        
        contentDiv.innerHTML = html;
    }

    async function loadPaymentContent() {
        if (!isRegistered || !userRegistrationData) return;
        
        const contentDiv = document.getElementById('paymentContent');
        
        if (!currentOrderSummary) {
            contentDiv.innerHTML = `
                <div class="warning">
                    <h3>âš ï¸ è«‹å…ˆæŸ¥è©¢è¨‚å–®</h3>
                    <p>è«‹å…ˆåˆ°ã€Œæˆ‘çš„è¨‚å–®ã€é é¢æŸ¥è©¢è¨‚å–®è³‡è¨Šï¼Œå†é€²è¡Œç¹³è²»å›å ±ã€‚</p>
                    <button class="btn" onclick="switchTab('orders', event)" style="margin-top: 15px;">
                        å‰å¾€æŸ¥è©¢è¨‚å–®
                    </button>
                </div>
            `;
            return;
        }
        
        displayPaymentForm();
    }

    function displayPaymentForm() {
        const contentDiv = document.getElementById('paymentContent');
        
        const html = `
            <div class="order-summary">
                <h3>ğŸ’° ç¹³è²»è³‡è¨Š</h3>
                <div class="summary-item">
                    <span>è¨‚å–®ç·¨è™Ÿ:</span>
                    <span>${currentOrderSummary.orderId}</span>
                </div>
                <div class="summary-item">
                    <span>æ‡‰ç¹³é‡‘é¡:</span>
                    <span>NT$ ${currentOrderSummary.totalAmount.toLocaleString()}</span>
                </div>
            </div>
            
            <h2 style="margin: 25px 0 20px 0; color: #333;">ğŸ“ ç¹³è²»è­‰æ˜æäº¤</h2>
            
            <form id="paymentForm">
                <div class="form-group">
                    <label for="paymentAmount">ç¹³è²»é‡‘é¡ *</label>
                    <input type="number" id="paymentAmount" name="paymentAmount" 
                           value="${currentOrderSummary.totalAmount}" required 
                           min="1" step="1" placeholder="è«‹è¼¸å…¥ç¹³è²»é‡‘é¡">
                </div>
                
                <div class="form-group">
                    <label for="paymentMethod">ç¹³è²»æ–¹å¼ *</label>
                    <select id="paymentMethod" name="paymentMethod" required>
                        <option value="">è«‹é¸æ“‡ç¹³è²»æ–¹å¼</option>
                        <option value="éŠ€è¡Œè½‰å¸³">éŠ€è¡Œè½‰å¸³</option>
                        <option value="ATMè½‰å¸³">ATMè½‰å¸³</option>
                        <option value="è¶…å•†ç¹³è²»">è¶…å•†ç¹³è²»</option>
                        <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                        <option value="ç¾é‡‘">ç¾é‡‘</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="paymentNote">å‚™è¨»èªªæ˜</label>
                    <textarea id="paymentNote" name="paymentNote" 
                              placeholder="è«‹è¼¸å…¥ç¹³è²»ç›¸é—œèªªæ˜ï¼Œå¦‚ï¼šè½‰å¸³å¸³è™Ÿå¾Œ5ç¢¼ã€ç¹³è²»æ™‚é–“ç­‰" 
                              maxlength="200"></textarea>
                    <small style="color: #6c757d; font-size: 12px;">å¯è¼¸å…¥è½‰å¸³è³‡è¨Šã€ç¹³è²»æ™‚é–“ç­‰ç›¸é—œèªªæ˜</small>
                </div>
                
                <button type="submit" class="btn" id="paymentSubmitBtn">
                    <span>æäº¤ç¹³è²»è­‰æ˜</span>
                </button>
            </form>
        `;
        
        contentDiv.innerHTML = html;
        
        // ç¶å®šè¡¨å–®æäº¤äº‹ä»¶
        const form = document.getElementById('paymentForm');
        if (form) {
            form.addEventListener('submit', handlePaymentSubmit);
        }
    }

    async function handlePaymentSubmit(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const paymentAmount = parseFloat(formData.get('paymentAmount'));
        const paymentMethod = formData.get('paymentMethod').trim();
        const paymentNote = formData.get('paymentNote').trim();
        
        // é©—è­‰
        if (!paymentAmount || paymentAmount <= 0) {
            UIManager.showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¹³è²»é‡‘é¡', 'error');
            return;
        }
        
        if (!paymentMethod) {
            UIManager.showToast('è«‹é¸æ“‡ç¹³è²»æ–¹å¼', 'error');
            return;
        }
        
        const noteValidation = FormValidator.validatePaymentNote(paymentNote);
        if (!noteValidation.valid) {
            UIManager.showToast(noteValidation.message, 'error');
            return;
        }
        
        const submitBtn = document.getElementById('paymentSubmitBtn');
        const originalText = submitBtn.innerHTML;
        
        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>æäº¤ä¸­...</span>';
            
            const result = await callAPIWithRetry('submit-payment', {
                userId: userId,
                orderId: currentOrderSummary.orderId,
                lineName: userProfile.displayName,
                realName: userRegistrationData.realName,
                paymentAmount: paymentAmount,
                paymentMethod: paymentMethod,
                paymentNote: paymentNote,
                timestamp: new Date().toISOString()
            });
            
            if (result && result.success) {
                UIManager.showToast('ç¹³è²»è­‰æ˜æäº¤æˆåŠŸï¼', 'success');
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯ä¸¦æä¾›å¾ŒçºŒæ“ä½œ
                document.getElementById('paymentContent').innerHTML = `
                    <div class="success">
                        <h3>âœ… æäº¤æˆåŠŸ</h3>
                        <p>æ‚¨çš„ç¹³è²»è­‰æ˜å·²æˆåŠŸæäº¤ï¼Œæˆ‘å€‘æœƒç›¡å¿«é€²è¡Œå¯©æ ¸ã€‚</p>
                        <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>æäº¤è³‡è¨Š:</strong><br>
                            ç¹³è²»ç·¨è™Ÿ: ${result.paymentId}<br>
                            æäº¤æ™‚é–“: ${new Date(result.submittedAt).toLocaleString('zh-TW')}
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn" onclick="switchTab('status', event)">
                            ğŸ“Š æŸ¥çœ‹ç¹³è²»ç‹€æ…‹
                        </button>
                        <button class="btn secondary" onclick="loadPaymentContent()">
                            ğŸ”„ é‡æ–°æäº¤
                        </button>
                    </div>
                `;
                
            } else {
                throw new Error(result?.message || 'æäº¤å¤±æ•—');
            }
            
        } catch (error) {
            debugLog('æäº¤ç¹³è²»è­‰æ˜å¤±æ•—', error);
            UIManager.showToast('æäº¤å¤±æ•—: ' + error.message, 'error');
            
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    }

    async function loadStatusContent() {
        if (!isRegistered || !userRegistrationData) return;
        
        const contentDiv = document.getElementById('statusContent');
        UIManager.showLoading('statusContent', 'è¼‰å…¥ç¹³è²»ç‹€æ…‹ä¸­...');
        
        try {
            const result = await callAPIWithRetry('get-payment-status', {
                userId: userId,
                lineName: userProfile.displayName,
                realName: userRegistrationData.realName
            });
            
            if (result && result.success) {
                if (result.payments && result.payments.length > 0) {
                    displayPaymentStatus(result.payments);
                } else {
                    contentDiv.innerHTML = `
                        <div class="info">
                            <h3>ğŸ“Š ç¹³è²»ç‹€æ…‹æŸ¥è©¢</h3>
                            <p>${result.message || 'ç›®å‰æ²’æœ‰ç¹³è²»è¨˜éŒ„'}</p>
                            <button class="btn" onclick="switchTab('payment', event)" style="margin-top: 15px;">
                                å‰å¾€ç¹³è²»å›å ±
                            </button>
                        </div>
                    `;
                }
            } else {
                throw new Error(result?.message || 'è¼‰å…¥ç¹³è²»ç‹€æ…‹å¤±æ•—');
            }
            
        } catch (error) {
            debugLog('è¼‰å…¥ç¹³è²»ç‹€æ…‹å¤±æ•—', error);
            contentDiv.innerHTML = `
                <div class="error">
                    <h3>âŒ è¼‰å…¥å¤±æ•—</h3>
                    <p>${error.message}</p>
                    <button class="btn" onclick="loadStatusContent()" style="margin-top: 15px;">
                        é‡æ–°è¼‰å…¥
                    </button>
                </div>
            `;
        }
    }

    function displayPaymentStatus(payments) {
        const contentDiv = document.getElementById('statusContent');
        
        let html = `
            <h2 style="margin-bottom: 20px; color: #333;">ğŸ“Š ç¹³è²»ç‹€æ…‹</h2>
            <div class="payment-status">
        `;
        
        payments.forEach(payment => {
            const statusClass = getStatusClass(payment.status);
            const statusText = getStatusText(payment.status);
            const submittedDate = new Date(payment.submittedAt).toLocaleString('zh-TW');
            
            html += `
                <div class="payment-item ${statusClass}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>ç¹³è²»ç·¨è™Ÿ: ${payment.paymentId}</strong>
                        <span class="status-badge status-${statusClass}">${statusText}</span>
                    </div>
                    
                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                        è¨‚å–®ç·¨è™Ÿ: ${payment.orderId}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                        <div><strong>ç¹³è²»é‡‘é¡:</strong> NT$ ${payment.paymentAmount.toLocaleString()}</div>
                        <div><strong>ç¹³è²»æ–¹å¼:</strong> ${payment.paymentMethod}</div>
                        <div><strong>æäº¤æ™‚é–“:</strong> ${submittedDate}</div>
                        <div><strong>ç‹€æ…‹:</strong> ${statusText}</div>
                    </div>
            `;
            
            if (payment.paymentNote) {
                html += `
                    <div style="margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 6px; font-size: 13px;">
                        <strong>å‚™è¨»:</strong> ${payment.paymentNote}
                    </div>
                `;
            }
            
            if (payment.reviewedAt && payment.reviewNote) {
                const reviewedDate = new Date(payment.reviewedAt).toLocaleString('zh-TW');
                html += `
                    <div style="margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 6px; font-size: 13px;">
                        <strong>å¯©æ ¸æ™‚é–“:</strong> ${reviewedDate}<br>
                        <strong>å¯©æ ¸å‚™è¨»:</strong> ${payment.reviewNote}
                    </div>
                `;
            }
            
            html += `</div>`;
        });
        
        html += `
            </div>
            <div class="btn-group">
                <button class="btn secondary" onclick="loadStatusContent()">
                    ğŸ”„ é‡æ–°æ•´ç†
                </button>
                <button class="btn" onclick="switchTab('payment', event)">
                    ğŸ’° æ–°å¢ç¹³è²»å›å ±
                </button>
            </div>
        `;
        
        contentDiv.innerHTML = html;
    }

    function getStatusClass(status) {
        switch (status) {
            case 'å¾…å¯©æ ¸': return 'pending';
            case 'å·²ç¢ºèª': return 'approved';
            case 'å·²æ‹’çµ•': return 'rejected';
            default: return 'pending';
        }
    }

    function getStatusText(status) {
        switch (status) {
            case 'å¾…å¯©æ ¸': return 'å¾…å¯©æ ¸';
            case 'å·²ç¢ºèª': return 'å·²ç¢ºèª';
            case 'å·²æ‹’çµ•': return 'å·²æ‹’çµ•';
            default: return status || 'æœªçŸ¥';
        }
    }

    // è¨»å†Šè¡¨å–®æäº¤è™•ç†
    document.addEventListener('DOMContentLoaded', function() {
        const nameForm = document.getElementById('nameForm');
        if (nameForm) {
            nameForm.addEventListener('submit', handleRegistration);
        }
    });

    async function handleRegistration(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const realName = formData.get('realName').trim();
        
        // é©—è­‰å§“å
        const validation = FormValidator.validateRealName(realName);
        if (!validation.valid) {
            UIManager.showToast(validation.message, 'error');
            return;
        }
        
        const submitBtn = document.getElementById('registerSubmitBtn');
        const originalText = submitBtn.innerHTML;
        
        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>è¨»å†Šä¸­...</span>';
            
            const result = await callAPIWithRetry('register', {
                userId: userId,
                lineDisplayName: userProfile.displayName,
                realName: realName,
                liffContext: liffContext,
                liffEnvironment: liffEnvironment,
                timestamp: new Date().toISOString()
            });
            
            if (result && result.success) {
                debugLog('è¨»å†ŠæˆåŠŸ', result.userInfo);
                
                isRegistered = true;
                userRegistrationData = result.userInfo;
                
                UIManager.showToast('è¨»å†ŠæˆåŠŸï¼æ­¡è¿ä½¿ç”¨è¨‚è³¼ç³»çµ±', 'success');
                
                showRegisteredStatus();
                enableAllTabs();
                displayUserInfo();
                
            } else {
                throw new Error(result?.message || 'è¨»å†Šå¤±æ•—');
            }
            
        } catch (error) {
            debugLog('è¨»å†Šå¤±æ•—', error);
            UIManager.showToast('è¨»å†Šå¤±æ•—: ' + error.message, 'error');
            
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    }

    // éŒ¯èª¤é¡¯ç¤ºå‡½æ•¸
    function showError(message) {
        const container = document.querySelector('.content');
        if (container) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `
                <h3>âŒ ç³»çµ±éŒ¯èª¤</h3>
                <p>${message}</p>
                <button class="btn" onclick="location.reload()" style="margin-top: 15px;">
                    é‡æ–°è¼‰å…¥é é¢
                </button>
            `;
            container.insertBefore(errorDiv, container.firstChild);
        }
    }

    // é é¢ç”Ÿå‘½é€±æœŸè™•ç†
    window.addEventListener('beforeunload', function() {
        debugLog('é é¢å³å°‡é—œé–‰');
    });

    // ç¶²è·¯ç‹€æ…‹ç›£æ§
    window.addEventListener('online', function() {
        UIManager.showToast('ç¶²è·¯é€£ç·šå·²æ¢å¾©', 'success');
        if (!apiConnected) {
            testApiConnection();
        }
    });

    window.addEventListener('offline', function() {
        UIManager.showToast('ç¶²è·¯é€£ç·šä¸­æ–·', 'warning');
    });

    // é–‹ç™¼ç”¨æ¸¬è©¦å‡½æ•¸
    function testAllFunctions() {
        if (!CONFIG.DEBUG_MODE) return;
        
        console.log('=== ç³»çµ±ç‹€æ…‹æ¸¬è©¦ ===');
        console.log('LIFF åˆå§‹åŒ–:', liff.isReady());
        console.log('ç”¨æˆ¶ç™»å…¥:', liff.isLoggedIn());
        console.log('ç”¨æˆ¶è³‡æ–™:', userProfile);
        console.log('è¨»å†Šç‹€æ…‹:', isRegistered);
        console.log('API é€£ç·š:', apiConnected);
        console.log('ç•¶å‰è¨‚å–®:', currentOrderSummary);
    }

    // åœ¨é–‹ç™¼æ¨¡å¼ä¸‹æš´éœ²æ¸¬è©¦å‡½æ•¸åˆ°å…¨åŸŸ
    if (CONFIG.DEBUG_MODE) {
        window.testAllFunctions = testAllFunctions;
        window.debugLog = debugLog;
        window.CONFIG = CONFIG;
    }
</script>
</body>
</html>
