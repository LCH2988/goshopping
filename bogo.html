<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搶購名單管理系統</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f8f9fa;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 15px;
      }
      .filter-section {
        margin-bottom: 20px;
        padding: 20px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
      }
      th, td {
        padding: 12px;
        border: 1px solid #dee2e6;
        text-align: left;
      }
      th {
        background-color: #4CAF50;
        color: white;
        font-weight: bold;
      }
      tr:nth-child(even) {
        background-color: #f8f9fa;
      }
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 0 5px;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      .btn:hover {
        opacity: 0.9;
      }
      .confirm-btn {
        background-color: #28a745;
        color: white;
      }
      .edit-btn {
        background-color: #007bff;
        color: white;
      }
      .save-btn {
        background-color: #ffc107;
        color: black;
      }
      .filter-select {
        padding: 8px;
        margin: 0 10px;
        min-width: 150px;
        border: 1px solid #ced4da;
        border-radius: 4px;
      }
      .confirmed {
        background-color: #d4edda !important;
      }
      .modified {
        background-color: #cce5ff !important;
      }
      #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .loading-text {
        font-size: 1.2em;
        color: #4CAF50;
        font-weight: bold;
      }
      .header {
        margin-bottom: 30px;
        text-align: center;
      }
      .header h1 {
        color: #2c3e50;
        margin-bottom: 10px;
      }
      .filter-group {
        display: flex;
        gap: 20px;
        align-items: center;
        margin-bottom: 10px;
      }
      .filter-label {
        min-width: 60px;
      }
      
      @media screen and (max-width: 768px) {
        .filter-section {
          padding: 15px;
        }
        .filter-group {
          flex-direction: column;
          align-items: stretch;
          gap: 10px;
        }
        .filter-select {
          width: 100%;
          margin: 5px 0;
        }
        .btn {
          width: 100%;
          margin: 5px 0;
        }
        th, td {
          padding: 8px;
          font-size: 14px;
        }
      }
    </style>
  </head>
  <body>
    <div id="loading">
      <div class="loading-text">載入中...</div>
    </div>

    <div class="container">
      <div class="header">
        <h1>搶購名單管理系統</h1>
      </div>
      
      <div class="filter-section">
        <h3>篩選條件</h3>
        <div class="filter-group">
          <div class="filter-label">買手：</div>
          <select id="buyerFilter" class="filter-select" onchange="applyFilters()">
            <option value="">全部</option>
          </select>
        </div>
        
        <div class="filter-group">
          <div class="filter-label">帳號：</div>
          <select id="accountFilter" class="filter-select" onchange="applyFilters()">
            <option value="">全部</option>
          </select>
        </div>
        
        <div class="filter-group">
          <div class="filter-label">組別：</div>
          <select id="groupFilter" class="filter-select" onchange="applyFilters()">
            <option value="">全部</option>
          </select>
        </div>
      </div>

      <div id="dataTable"></div>
    </div>

    <script>
      const CONFIG = {
        LIFF_ID: '1657285806-2bmkYWkN',
        GAS_API_URL: 'https://script.google.com/macros/s/AKfycbyBigEcZpFQ4xesMo6zJUjfs6fn6ttDRWJcr4ZnLOmdiuaxPj5Wk6PSMSIemQlV-aBhig/exec',
        MAX_RETRIES: 3,
        RETRY_DELAY: 1000
      };

      let dataStatus = {};
      let lineUserId = '';
      let originalData = [];

      async function fetchWithRetry(url, options, retries = CONFIG.MAX_RETRIES) {
        try {
          return await fetch(url, options);
        } catch (err) {
          if (retries > 0) {
            await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY));
            return fetchWithRetry(url, options, retries - 1);
          }
          throw err;
        }
      }

      async function fetchGAS(action, data = {}) {
        try {
          const url = `${CONFIG.GAS_API_URL}?action=${action}`;
          document.getElementById('loading').style.display = 'flex';
          
          const options = {
            method: 'POST',
            mode: 'cors',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
            },
            body: JSON.stringify({ 
              ...data, 
              lineUserId,
              timestamp: new Date().getTime()
            }),
          };

          const response = await fetchWithRetry(url, options);
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const result = await response.json();
          if (result.error) {
            throw new Error(result.error);
          }
          return result;
          
        } catch (err) {
          console.error('API 呼叫失敗:', err);
          alert(`操作失敗：${err.message || '請稍後再試'}`);
          throw err;
        } finally {
          document.getElementById('loading').style.display = 'none';
        }
      }

      async function initializeLiff() {
        try {
          await liff.init({ liffId: CONFIG.LIFF_ID });
          if (!liff.isLoggedIn()) {
            liff.login();
          } else {
            const profile = await liff.getProfile();
            lineUserId = profile.userId;
            await loadData();
          }
        } catch (err) {
          console.error('LIFF 初始化失敗:', err);
          alert('LIFF 初始化失敗，請重新整理頁面');
        }
      }

      async function loadData() {
        try {
          document.getElementById('loading').style.display = 'flex';
          const result = await fetchGAS('getData');
          originalData = result.data;
          displayData(result.data);
          updateFilterOptions(result.data);
          const status = await fetchGAS('getStatus');
          dataStatus = status;
          applyStatus();
        } catch (err) {
          console.error('資料載入失敗:', err);
        } finally {
          document.getElementById('loading').style.display = 'none';
        }
      }

      function updateFilterOptions(data) {
        const buyers = new Set();
        const accounts = new Set();
        const groups = new Set();
        
        data.forEach(row => {
          if (row[0]) buyers.add(row[0]);
          if (row[1]) accounts.add(row[1]);
          if (row[2]) groups.add(row[2]);
        });

        updateSelect('buyerFilter', buyers);
        updateSelect('accountFilter', accounts);
        updateSelect('groupFilter', groups);
      }

      function updateSelect(id, options) {
        const select = document.getElementById(id);
        const currentValue = select.value;
        select.innerHTML = '<option value="">全部</option>';
        
        Array.from(options)
          .filter(option => option)
          .sort()
          .forEach(option => {
            const opt = document.createElement('option');
            opt.value = option;
            opt.textContent = option;
            select.appendChild(opt);
          });
        
        select.value = currentValue;
      }

      function displayData(data) {
        const tableDiv = document.getElementById('dataTable');
        let html = `
          <table>
            <thead>
              <tr>
                <th>買手</th>
                <th>帳號</th>
                <th>組別</th>
                <th>組數</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        data.forEach((row, index) => {
          html += `
            <tr id="row-${index}">
              <td>${row[0] || ''}</td>
              <td>${row[1] || ''}</td>
              <td>${row[2] || ''}</td>
              <td>${row[3] || ''}</td>
              <td>
                <button class="btn confirm-btn" onclick="confirmRow(${index})">確認</button>
                <button class="btn edit-btn" onclick="editRow(${index})">修改</button>
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        tableDiv.innerHTML = html;
        applyStatus();
      }

      function applyStatus() {
        for (const [rowIndex, status] of Object.entries(dataStatus)) {
          const row = document.getElementById(`row-${rowIndex}`);
          if (row) {
            row.className = status;
          }
        }
      }

      function applyFilters() {
        const buyer = document.getElementById('buyerFilter').value;
        const account = document.getElementById('accountFilter').value;
        const group = document.getElementById('groupFilter').value;
        
        const filteredData = originalData.filter(row => {
          const buyerMatch = !buyer || row[0] === buyer;
          const accountMatch = !account || row[1] === account;
          const groupMatch = !group || row[2] === group;
          return buyerMatch && accountMatch && groupMatch;
        });
        
        displayData(filteredData);
      }

      async function confirmRow(index) {
        try {
          document.getElementById('loading').style.display = 'flex';
          await fetchGAS('confirmRow', { rowIndex: index + 3 });
          const row = document.getElementById(`row-${index}`);
          row.className = 'confirmed';
          dataStatus[index] = 'confirmed';
        } catch (err) {
          console.error('確認失敗:', err);
        } finally {
          document.getElementById('loading').style.display = 'none';
        }
      }

      function editRow(index) {
        const row = document.getElementById(`row-${index}`);
        const cells = row.getElementsByTagName('td');
        
        cells[2].innerHTML = `<input type="text" value="${cells[2].textContent}" class="filter-select">`;
        cells[3].innerHTML = `<input type="number" value="${cells[3].textContent}" class="filter-select">`;
        
        cells[4].innerHTML = `<button class="btn save-btn" onclick="saveRow(${index})">儲存</button>`;
      }

      async function saveRow(index) {
        const row = document.getElementById(`row-${index}`);
        const cells = row.getElementsByTagName('td');
        
        const newGroup = cells[2].getElementsByTagName('input')[0].value;
        const newCount = cells[3].getElementsByTagName('input')[0].value;
        
        try {
          document.getElementById('loading').style.display = 'flex';
          await fetchGAS('updateData', {
            rowIndex: index + 3,
            newGroup,
            newCount
          });

          cells[2].textContent = newGroup;
          cells[3].textContent = newCount;
          
          cells[4].innerHTML = `
            <button class="btn confirm-btn" onclick="confirmRow(${index})">確認</button>
            <button class="btn edit-btn" onclick="editRow(${index})">修改</button>
          `;
          
          row.className = 'modified';
          dataStatus[index] = 'modified';
          
          const result = await fetchGAS('getData');
          originalData = result.data;
          updateFilterOptions(result.data);
        } catch (err) {
          console.error('儲存失敗:', err);
        } finally {
          document.getElementById('loading').style.display = 'none';
        }
      }

      window.onload = initializeLiff;
    </script>
  </body>
</html>
