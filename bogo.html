<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF 繳費系統</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #FF8C69 0%, #FF7F50 50%, #FF6347 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(255, 99, 71, 0.3);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(135deg, #FF8C69, #FF7F50);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 30px 20px;
        }

        .user-info {
            background: linear-gradient(135deg, #FFF8DC, #FFE4B5);
            border: 2px solid #FF8C69;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .user-info h2 {
            color: #D2691E;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .user-info .line-name {
            color: #FF6347;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #D2691E;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #FFE4B5;
            border-radius: 12px;
            font-size: 16px;
            background: #FFFAF0;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #FF8C69;
            box-shadow: 0 0 0 3px rgba(255, 140, 105, 0.1);
            background: white;
        }

        .form-group input.required {
            border-color: #FF6347;
            background: #FFF5F5;
        }

        .form-group input.required:focus {
            border-color: #FF4500;
            box-shadow: 0 0 0 3px rgba(255, 69, 0, 0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF8C69, #FF7F50);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 140, 105, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 140, 105, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #DEB887, #D2B48C);
            color: #8B4513;
            box-shadow: 0 4px 15px rgba(210, 180, 140, 0.4);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(210, 180, 140, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #32CD32, #228B22);
            color: white;
            box-shadow: 0 4px 15px rgba(50, 205, 50, 0.4);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(50, 205, 50, 0.6);
        }

        .btn:disabled {
            background: #ccc;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .order-item {
            background: linear-gradient(135deg, #FFFAF0, #FFF8DC);
            border: 2px solid #FFE4B5;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(255, 140, 105, 0.1);
            border-left: 5px solid #FF8C69;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #FFE4B5;
        }

        .order-header h3 {
            margin: 0;
            color: #D2691E;
            font-size: 18px;
        }

        .product-info {
            margin-top: 12px;
        }

        .product-name {
            font-size: 16px;
            color: #8B4513;
            margin-bottom: 12px;
            padding: 12px;
            background: linear-gradient(135deg, #FFF8DC, #FFFAF0);
            border-radius: 8px;
            border: 1px solid #FFE4B5;
            font-weight: 600;
        }

        .order-details {
            margin: 12px 0;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #FFE4B5;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .total-row {
            background: linear-gradient(135deg, #FFE4B5, #F5DEB3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 8px;
            font-weight: bold;
            border: 2px solid #FF8C69;
        }

        .label {
            color: #D2691E;
            font-size: 14px;
            font-weight: 500;
        }

        .value {
            color: #8B4513;
            font-weight: 600;
        }

        .total-amount {
            color: #FF6347;
            font-size: 16px;
            font-weight: bold;
        }

        .order-date {
            font-size: 12px;
            color: #CD853F;
            margin-top: 12px;
            text-align: right;
        }

        .status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-paid {
            background: linear-gradient(135deg, #98FB98, #90EE90);
            color: #006400;
            border: 1px solid #32CD32;
        }

        .status-pending {
            background: linear-gradient(135deg, #FFE4B5, #F5DEB3);
            color: #FF8C00;
            border: 1px solid #FF8C69;
        }

        .order-summary {
            background: linear-gradient(135deg, #FF8C69, #FF7F50);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 6px 20px rgba(255, 140, 105, 0.3);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .total-summary {
            border-top: 2px solid rgba(255,255,255,0.3);
            margin-top: 12px;
            padding-top: 15px;
            font-size: 18px;
            font-weight: bold;
        }

        .summary-label {
            font-size: 14px;
        }

        .summary-value {
            font-weight: bold;
        }

        .payment-methods {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }

        .payment-method {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border: 2px solid #FFE4B5;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-method:hover {
            border-color: #FF8C69;
            background: #FFFAF0;
        }

        .payment-method.selected {
            border-color: #FF6347;
            background: linear-gradient(135deg, #FFE4B5, #F5DEB3);
        }

        .payment-method input[type="radio"] {
            margin-right: 12px;
            accent-color: #FF8C69;
        }

        .payment-method label {
            font-weight: 500;
            color: #8B4513;
            cursor: pointer;
            flex: 1;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #FFE4B5;
            border-radius: 12px;
            font-size: 14px;
            background: #FFFAF0;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        textarea:focus {
            outline: none;
            border-color: #FF8C69;
            box-shadow: 0 0 0 3px rgba(255, 140, 105, 0.1);
            background: white;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #FF8C69;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #FFE4B5;
            border-top: 3px solid #FF8C69;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success {
            background: linear-gradient(135deg, #98FB98, #90EE90);
            color: #006400;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            border: 2px solid #32CD32;
        }

        .error {
            background: linear-gradient(135deg, #FFB6C1, #FFA0B4);
            color: #8B0000;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            border: 2px solid #DC143C;
        }

        .info {
            background: linear-gradient(135deg, #E0F6FF, #B0E0E6);
            color: #4682B4;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            border: 2px solid #87CEEB;
        }

        .required-note {
            font-size: 12px;
            color: #FF6347;
            margin-top: 5px;
            font-style: italic;
        }

        .user-display {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF8C69, #FF7F50);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .menu-buttons {
            display: grid;
            gap: 12px;
            margin-top: 20px;
        }

        .payment-form {
            background: linear-gradient(135deg, #FFFAF0, #FFF8DC);
            border: 2px solid #FFE4B5;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .payment-form h3 {
            color: #D2691E;
            margin-bottom: 20px;
            text-align: center;
            font-size: 18px;
        }

        .transfer-note {
            background: #FFF8DC;
            border: 1px solid #FFE4B5;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #D2691E;
            display: none;
        }

        .transfer-note.show {
            display: block;
        }

        @media (max-width: 480px) {
            .container {
                margin: 5px;
                border-radius: 15px;
            }
            
            .content {
                padding: 20px 15px;
            }
            
            .header {
                padding: 20px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💳 LIFF 繳費系統</h1>
            <div class="subtitle">安全便利的線上繳費平台</div>
        </div>

        <div class="content">
            <!-- 載入中 -->
            <div id="loading" class="loading show">
                <div class="spinner"></div>
                <div>系統初始化中...</div>
            </div>

            <!-- 未註冊用戶 - 註冊區段 -->
            <div id="registerSection" class="section">
                <div class="user-info">
                    <h2>👋 歡迎使用</h2>
                    <div id="unregisteredUserDisplay" class="user-display">
                        <div id="unregisteredUserAvatar" class="user-avatar"></div>
                        <div>
                            <div id="unregisteredLineName" class="line-name"></div>
                            <div style="font-size: 12px; color: #CD853F;">LINE 用戶</div>
                        </div>
                    </div>
                    <div class="info">請先完成註冊才能使用繳費功能</div>
                </div>

                <form id="registerForm">
                    <div class="form-group">
                        <label for="registerRealName">真實姓名 <span style="color: #FF6347;">*</span></label>
                        <input type="text" id="registerRealName" name="realName" class="required" placeholder="請輸入您的真實姓名">
                        <div class="required-note">此資訊用於訂單核對，請務必填寫正確</div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="registerBtn">
                        📝 確認送出
                    </button>
                </form>
            </div>

            <!-- 已註冊用戶 - 主選單區段 -->
            <div id="menuSection" class="section">
                <div class="user-info">
                    <h2>🎉 歡迎回來</h2>
                    <div id="registeredUserDisplay" class="user-display">
                        <div id="registeredUserAvatar" class="user-avatar"></div>
                        <div>
                            <div id="registeredLineName" class="line-name"></div>
                            <div id="registeredRealName" style="font-size: 14px; color: #8B4513; font-weight: 600;"></div>
                        </div>
                    </div>
                </div>

                <div class="menu-buttons">
                    <button class="btn btn-secondary" onclick="showModifySection()">
                        ✏️ 確認修改 (變更名字)
                    </button>
                    
                    <button class="btn btn-primary" onclick="loadUserOrders()">
                        📋 查詢訂購清單
                    </button>
                    
                    <button class="btn btn-success" onclick="showPaymentSection()">
                        💳 繳費
                    </button>
                </div>
            </div>

            <!-- 修改資料區段 -->
            <div id="modifySection" class="section">
                <div class="user-info">
                    <h2>✏️ 修改個人資料</h2>
                    <div class="user-display">
                        <div id="modifyUserAvatar" class="user-avatar"></div>
                        <div>
                            <div id="modifyLineName" class="line-name"></div>
                            <div style="font-size: 12px; color: #CD853F;">LINE 用戶</div>
                        </div>
                    </div>
                </div>

                <form id="modifyForm">
                    <div class="form-group">
                        <label for="modifyRealName">真實姓名</label>
                        <input type="text" id="modifyRealName" name="realName" placeholder="請輸入您的真實姓名">
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="modifyBtn">
                        ✅ 確認修改
                    </button>
                    
                    <button type="button" class="btn btn-secondary" onclick="showMenuSection()">
                        ⬅️ 返回主選單
                    </button>
                </form>
            </div>

            <!-- 訂單列表區段 -->
            <div id="ordersSection" class="section">
                <div class="user-info">
                    <h2>📋 我的訂單</h2>
                    <div class="user-display">
                        <div id="orderUserAvatar" class="user-avatar"></div>
                        <div>
                            <div id="orderLineName" class="line-name"></div>
                            <div id="orderRealName" style="font-size: 14px; color: #8B4513; font-weight: 600;"></div>
                        </div>
                    </div>
                </div>

                <div id="ordersList"></div>
                
                <button class="btn btn-secondary" onclick="showMenuSection()">
                    ⬅️ 返回主選單
                </button>
            </div>

            <!-- 繳費區段 -->
            <div id="paymentSection" class="section">
                <div class="payment-form">
                    <h3>💰 選擇繳費方式</h3>
                    
                    <div class="form-group">
                        <label>繳費方式</label>
                        <div class="payment-methods">
                            <div class="payment-method" data-method="現金">
                                <input type="radio" id="cash" name="paymentMethod" value="現金">
                                <label for="cash">💵 現金</label>
                            </div>
                            <div class="payment-method" data-method="LINE Pay">
                                <input type="radio" id="linepay" name="paymentMethod" value="LINE Pay">
                                <label for="linepay">📱 LINE Pay</label>
                            </div>
                            <div class="payment-method" data-method="轉帳">
                                <input type="radio" id="transfer" name="paymentMethod" value="轉帳">
                                <label for="transfer">🏦 轉帳</label>
                            </div>
                        </div>
                        
                        <div id="transferNote" class="transfer-note">
                            <strong>轉帳資訊：</strong><br>
                            請於備註欄位提供轉帳帳號後5碼，以便核對
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="paymentNote">備註說明</label>
                        <textarea id="paymentNote" placeholder="請輸入相關資訊...&#10;• 現金：繳費時間、地點&#10;• LINE Pay：交易編號&#10;• 轉帳：帳號後5碼、轉帳時間"></textarea>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="confirmPayment()">
                        ✅ 確認繳費方式送出
                    </button>
                    
                    <button type="button" class="btn btn-secondary" onclick="showMenuSection()">
                        ⬅️ 返回主選單
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全域變數
        let liffData = {};
        let currentUser = {};
        let userOrders = [];

        // API 設定
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbzNdoyT2-lAhAxYM4weFROAQ9SSaWj_pCJ6AJz0vIhTcp-564kBkF47a-zwnG65HNgo/exec';

        // LIFF 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeLiff();
        });

        async function initializeLiff() {
            try {
                await liff.init({ liffId: '1657285806-2bmkYWkN' });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // 取得用戶資料
                const profile = await liff.getProfile();
                liffData = {
                    userId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl,
                    statusMessage: profile.statusMessage
                };

                console.log('LIFF 用戶資料:', liffData);

                // 檢查用戶註冊狀態
                await checkUserRegistration();

            } catch (error) {
                console.error('LIFF 初始化錯誤:', error);
                document.getElementById('loading').innerHTML = 
                    '<div class="error">系統初始化失敗，請重新整理頁面</div>';
            }
        }

        async function checkUserRegistration() {
            try {
                const response = await fetch(`${API_BASE_URL}?action=check-registration&data=${encodeURIComponent(JSON.stringify({
                    userId: liffData.userId,
                    lineDisplayName: liffData.displayName
                }))}`);
                
                const result = await response.json();
                console.log('註冊檢查結果:', result);

                // 隱藏載入中
                document.getElementById('loading').classList.remove('show');

                if (result.success && result.registered) {
                    // 用戶已註冊，顯示主選單
                    currentUser = result.userInfo;
                    showMenuSection();
                } else {
                    // 用戶未註冊，顯示註冊頁面
                    showRegisterSection();
                }

            } catch (error) {
                console.error('檢查註冊狀態錯誤:', error);
                document.getElementById('loading').innerHTML = 
                    '<div class="error">無法連接伺服器，請檢查網路連線</div>';
            }
        }

        // 顯示註冊區段
        function showRegisterSection() {
            // 設定用戶顯示
            document.getElementById('unregisteredLineName').textContent = liffData.displayName;
            document.getElementById('unregisteredUserAvatar').textContent = liffData.displayName.charAt(0).toUpperCase();
            
            // 顯示註冊區段
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('registerSection').classList.add('active');
        }

        // 顯示主選單區段
        function showMenuSection() {
            // 設定用戶顯示
            document.getElementById('registeredLineName').textContent = liffData.displayName;
            document.getElementById('registeredRealName').textContent = currentUser.realName || '未設定';
            document.getElementById('registeredUserAvatar').textContent = liffData.displayName.charAt(0).toUpperCase();
            
            // 顯示主選單區段
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('menuSection').classList.add('active');
        }

        // 顯示修改資料區段
        function showModifySection() {
            // 設定用戶顯示
            document.getElementById('modifyLineName').textContent = liffData.displayName;
            document.getElementById('modifyUserAvatar').textContent = liffData.displayName.charAt(0).toUpperCase();
            document.getElementById('modifyRealName').value = currentUser.realName || '';
            
            // 顯示修改區段
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('modifySection').classList.add('active');
        }

        // 顯示繳費區段
        function showPaymentSection() {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('paymentSection').classList.add('active');
        }

        // 註冊表單提交
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const realName = document.getElementById('registerRealName').value.trim();
            
            if (!realName) {
                alert('請輸入真實姓名');
                return;
            }

            await submitRegistration(realName);
        });

        // 修改表單提交
        document.getElementById('modifyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const realName = document.getElementById('modifyRealName').value.trim();
            
              if (!realName) {
                  alert('請輸入真實姓名');
                  return;
              }

              await submitRegistration(realName, true);
          });

          // 提交註冊/修改資料
          async function submitRegistration(realName, isModify = false) {
              try {
                  const btnId = isModify ? 'modifyBtn' : 'registerBtn';
                  const btn = document.getElementById(btnId);
                  
                  btn.disabled = true;
                  btn.textContent = '處理中...';

                  const response = await fetch(`${API_BASE_URL}?action=register&data=${encodeURIComponent(JSON.stringify({
                      userId: liffData.userId,
                      lineDisplayName: liffData.displayName,
                      realName: realName,
                      isModify: isModify,
                      liffContext: liff.getContext(),
                      timestamp: new Date().toISOString()
                  }))}`);
                  
                  const result = await response.json();
                  console.log('註冊/修改結果:', result);

                  if (result.success) {
                      currentUser = result.userInfo;
                      
                      // 顯示成功訊息
                      const successDiv = document.createElement('div');
                      successDiv.className = 'success';
                      successDiv.textContent = result.message;
                      
                      const form = document.getElementById(isModify ? 'modifyForm' : 'registerForm');
                      form.appendChild(successDiv);
                      
                      // 2秒後跳轉到主選單
                      setTimeout(() => {
                          showMenuSection();
                      }, 2000);
                      
                  } else {
                      throw new Error(result.message);
                  }

              } catch (error) {
                  console.error('註冊/修改錯誤:', error);
                  const errorDiv = document.createElement('div');
                  errorDiv.className = 'error';
                  errorDiv.textContent = '操作失敗: ' + error.message;
                  
                  const form = document.getElementById(isModify ? 'modifyForm' : 'registerForm');
                  form.appendChild(errorDiv);
              } finally {
                  const btnId = isModify ? 'modifyBtn' : 'registerBtn';
                  const btn = document.getElementById(btnId);
                  btn.disabled = false;
                  btn.textContent = isModify ? '✅ 確認修改' : '📝 確認送出';
              }
          }

          // 載入用戶訂單
          async function loadUserOrders() {
              try {
                  // 顯示載入狀態
                  document.getElementById('ordersList').innerHTML = 
                      '<div class="loading show"><div class="spinner"></div><div>載入訂單中...</div></div>';
                  
                  showOrdersSection();

                  const response = await fetch(`${API_BASE_URL}?action=orders&data=${encodeURIComponent(JSON.stringify({
                      lineDisplayName: liffData.displayName,
                      realName: currentUser.realName
                  }))}`);
                  
                  const result = await response.json();
                  console.log('訂單資料:', result);

                  if (result.success) {
                      userOrders = result.orders;
                      displayOrders(result.orders);
                  } else {
                      throw new Error(result.message);
                  }

              } catch (error) {
                  console.error('載入訂單錯誤:', error);
                  document.getElementById('ordersList').innerHTML = 
                      '<div class="error">載入訂單失敗: ' + error.message + '</div>';
              }
          }

          // 顯示訂單列表區段
          function showOrdersSection() {
              // 設定用戶顯示
              document.getElementById('orderLineName').textContent = liffData.displayName;
              document.getElementById('orderRealName').textContent = currentUser.realName;
              document.getElementById('orderUserAvatar').textContent = liffData.displayName.charAt(0).toUpperCase();
              
              document.querySelectorAll('.section').forEach(section => {
                  section.classList.remove('active');
              });
              document.getElementById('ordersSection').classList.add('active');
          }

          // 顯示訂單資料
          function displayOrders(orders) {
              let html = '';
              let grandTotal = 0;
              
              if (orders.length === 0) {
                  html = '<div class="info">暫無訂單記錄，請聯繫管理員確認</div>';
              } else {
                  orders.forEach(order => {
                      const statusClass = order.paymentStatus === '已付款' ? 'status-paid' : 'status-pending';
                      const statusText = order.paymentStatus === '已付款' ? '✅ 已付款' : '⏳ 待付款';
                      
                      html += `
                          <div class="order-item">
                              <div class="order-header">
                                  <h3>📦 訂單 #${order.orderId}</h3>
                                  <span class="status-badge ${statusClass}">${statusText}</span>
                              </div>
                              
                              <div class="product-info">
                                  <div class="product-name">
                                      ${order.productName}
                                  </div>
                                  
                                  <div class="order-details">
                                      <div class="detail-row">
                                          <span class="label">單價:</span>
                                          <span class="value">NT$ ${order.unitPrice.toLocaleString()}</span>
                                      </div>
                                      <div class="detail-row">
                                          <span class="label">數量:</span>
                                          <span class="value">${order.quantity}</span>
                                      </div>
                                      <div class="detail-row total-row">
                                          <span class="label">小計:</span>
                                          <span class="value total-amount">NT$ ${order.totalAmount.toLocaleString()}</span>
                                      </div>
                                  </div>
                                  
                                  <div class="order-date">
                                      訂單日期: ${order.orderDate}
                                  </div>
                              </div>
                          </div>
                      `;
                      grandTotal += order.totalAmount;
                  });
                  
                  // 總金額摘要
                  html += `
                      <div class="order-summary">
                          <div class="summary-row">
                              <span class="summary-label">訂單總數:</span>
                              <span class="summary-value">${orders.length} 筆</span>
                          </div>
                          <div class="summary-row total-summary">
                              <span class="summary-label">總金額:</span>
                              <span class="summary-value">NT$ ${grandTotal.toLocaleString()}</span>
                          </div>
                      </div>
                  `;
              }
              
              document.getElementById('ordersList').innerHTML = html;
          }

          // 繳費方式選擇
          document.querySelectorAll('.payment-method').forEach(method => {
              method.addEventListener('click', function() {
                  // 移除其他選中狀態
                  document.querySelectorAll('.payment-method').forEach(m => {
                      m.classList.remove('selected');
                  });
                  
                  // 設定當前選中
                  this.classList.add('selected');
                  this.querySelector('input[type="radio"]').checked = true;
                  
                  // 顯示/隱藏轉帳提示
                  const transferNote = document.getElementById('transferNote');
                  if (this.dataset.method === '轉帳') {
                      transferNote.classList.add('show');
                  } else {
                      transferNote.classList.remove('show');
                  }
              });
          });

          // 確認繳費方式
          async function confirmPayment() {
              const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
              const paymentNote = document.getElementById('paymentNote').value.trim();

              if (!paymentMethod) {
                  alert('請選擇繳費方式');
                  return;
              }

              // 轉帳方式需要備註
              if (paymentMethod === '轉帳' && !paymentNote) {
                  alert('轉帳方式請提供帳號後5碼等相關資訊');
                  return;
              }

              try {
                  const submitBtn = document.querySelector('#paymentSection .btn-primary');
                  submitBtn.disabled = true;
                  submitBtn.textContent = '提交中...';

                  const response = await fetch(`${API_BASE_URL}?action=submit-payment&data=${encodeURIComponent(JSON.stringify({
                      userId: liffData.userId,
                      lineDisplayName: liffData.displayName,
                      realName: currentUser.realName,
                      paymentMethod: paymentMethod,
                      paymentNote: paymentNote,
                      liffContext: liff.getContext(),
                      timestamp: new Date().toISOString()
                  }))}`);
                  
                  const result = await response.json();
                  console.log('繳費提交結果:', result);

                  if (result.success) {
                      // 顯示成功訊息
                      const successDiv = document.createElement('div');
                      successDiv.className = 'success';
                      successDiv.innerHTML = `
                          <strong>✅ 繳費資訊提交成功！</strong><br>
                          我們已收到您的繳費資訊，將於1-2個工作天內完成審核。<br>
                          <small>繳費方式: ${paymentMethod}</small>
                      `;
                      
                      document.querySelector('.payment-form').insertBefore(
                          successDiv, 
                          document.querySelector('.payment-form').firstChild
                      );

                      // 清空表單
                      document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                          radio.checked = false;
                      });
                      document.querySelectorAll('.payment-method').forEach(method => {
                          method.classList.remove('selected');
                      });
                      document.getElementById('paymentNote').value = '';
                      document.getElementById('transferNote').classList.remove('show');

                      // 3秒後返回主選單
                      setTimeout(() => {
                          showMenuSection();
                      }, 3000);
                      
                  } else {
                      throw new Error(result.message);
                  }

              } catch (error) {
                  console.error('提交繳費資訊錯誤:', error);
                  const errorDiv = document.createElement('div');
                  errorDiv.className = 'error';
                  errorDiv.textContent = '提交失敗: ' + error.message;
                  document.querySelector('.payment-form').insertBefore(
                      errorDiv, 
                      document.querySelector('.payment-form').firstChild
                  );
              } finally {
                  const submitBtn = document.querySelector('#paymentSection .btn-primary');
                  submitBtn.disabled = false;
                  submitBtn.textContent = '✅ 確認繳費方式送出';
              }
          }

          // 錯誤處理
          window.addEventListener('error', function(e) {
              console.error('頁面錯誤:', e.error);
          });

          // 頁面離開前確認
          window.addEventListener('beforeunload', function(e) {
              const paymentNote = document.getElementById('paymentNote').value.trim();
              const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked');
              
              if (paymentNote || selectedPayment) {
                  e.preventDefault();
                  e.returnValue = '';
              }
          });
      </script>
  </body>
  </html>
