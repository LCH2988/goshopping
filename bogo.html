<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LIFF è¨‚å–®ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Microsoft JhengHei', Arial, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          color: #333;
      }

      .container {
          max-width: 500px;
          margin: 0 auto;
          padding: 20px;
          min-height: 100vh;
      }

      .card {
          background: white;
          border-radius: 15px;
          padding: 25px;
          margin-bottom: 20px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.2);
          animation: slideIn 0.5s ease-out;
      }

      @keyframes slideIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .header {
          text-align: center;
          margin-bottom: 30px;
      }

      .header h1 {
          color: #667eea;
          font-size: 28px;
          margin-bottom: 10px;
      }

      .header p {
          color: #666;
          font-size: 16px;
      }

      .user-info {
          display: flex;
          align-items: center;
          padding: 20px;
          background: linear-gradient(135deg, #667eea, #764ba2);
          border-radius: 12px;
          margin-bottom: 25px;
          color: white;
          opacity: 0;
          transform: translateY(20px);
          transition: all 0.5s ease;
      }

      .user-info.show {
          opacity: 1;
          transform: translateY(0);
      }

      .user-avatar {
          width: 60px;
          height: 60px;
          border-radius: 50%;
          background: rgba(255,255,255,0.3);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 24px;
          font-weight: bold;
          margin-right: 15px;
          border: 3px solid rgba(255,255,255,0.5);
          overflow: hidden;
      }

      .user-avatar img {
          width: 100%;
          height: 100%;
          object-fit: cover;
          border-radius: 50%;
      }

      .user-details h3 {
          font-size: 18px;
          margin-bottom: 5px;
          font-weight: 600;
      }

      .user-details p {
          font-size: 14px;
          opacity: 0.9;
      }

      .user-id {
          font-size: 12px;
          opacity: 0.7;
          margin-top: 2px;
          font-family: monospace;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #555;
      }

      .form-group input, .form-group textarea, .form-group select {
          width: 100%;
          padding: 12px 15px;
          border: 2px solid #e1e5e9;
          border-radius: 8px;
          font-size: 16px;
          transition: all 0.3s ease;
      }

      .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn {
          width: 100%;
          padding: 15px;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          margin-bottom: 10px;
      }

      .btn-primary {
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
      }

      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-success {
          background: linear-gradient(135deg, #56ab2f, #a8e6cf);
          color: white;
      }

      .btn-success:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4);
      }

      .btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
          transform: none;
      }

      .section {
          display: none;
      }

      .section.active {
          display: block;
      }

      .loading {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.7);
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          z-index: 9999;
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s ease;
      }

      .loading.show {
          opacity: 1;
          visibility: visible;
      }

      .loading-spinner {
          width: 50px;
          height: 50px;
          border: 4px solid rgba(255,255,255,0.3);
          border-top: 4px solid white;
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin-bottom: 20px;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .loading-text {
          color: white;
          font-size: 16px;
          font-weight: 600;
      }

      .message {
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 20px;
          font-weight: 600;
          animation: slideIn 0.5s ease-out;
      }

      .message.success {
          background: #e8f5e8;
          color: #2e7d32;
          border: 1px solid #4caf50;
      }

      .message.error {
          background: #ffebee;
          color: #c62828;
          border: 1px solid #f44336;
      }

      .message.info {
          background: #e3f2fd;
          color: #1565c0;
          border: 1px solid #2196f3;
      }

      .line-info-card {
          background: #00C300;
          color: white;
          padding: 15px;
          border-radius: 12px;
          margin-bottom: 20px;
          text-align: center;
      }

      .line-info-title {
          font-size: 16px;
          font-weight: bold;
          margin-bottom: 10px;
      }

      .line-info-details {
          font-size: 14px;
          opacity: 0.9;
      }

      .admin-indicator {
          background: linear-gradient(135deg, #ff6b6b, #ee5a24);
          color: white;
          padding: 10px;
          text-align: center;
          border-radius: 8px;
          margin-bottom: 20px;
          font-weight: bold;
      }

      .user-status {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 10px 15px;
          background: #f8f9fa;
          border-radius: 8px;
          margin-bottom: 15px;
          font-size: 14px;
      }

      .status-label {
          color: #666;
      }

      .status-value {
          font-weight: bold;
          color: #333;
      }

      @media (max-width: 480px) {
          .container {
              padding: 10px;
          }
          
          .card {
              padding: 20px;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <!-- è¼‰å…¥ç•«é¢ -->
      <div id="loading" class="loading">
          <div class="loading-spinner"></div>
          <div class="loading-text">æ­£åœ¨é€£æ¥ LINE...</div>
      </div>

      <!-- ç®¡ç†å“¡æç¤º -->
      <div id="adminIndicator" class="admin-indicator" style="display: none;">
          ğŸ‘‘ æ‚¨æ˜¯ç®¡ç†å“¡ï¼Œè«‹é»é¸ä¸‹æ–¹æŒ‰éˆ•é€²å…¥ç®¡ç†ç³»çµ±
      </div>

      <!-- ä¸»è¦å…§å®¹å€ -->
      <div id="mainSection" class="section active">
          <div class="card">
              <div class="header">
                  <h1>ğŸ“± LIFF è¨‚å–®ç³»çµ±</h1>
                  <p>æ­¡è¿ä½¿ç”¨ LINE è¨‚å–®ç®¡ç†ç³»çµ±</p>
              </div>

              <!-- LINE ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º -->
              <div id="lineInfoCard" class="line-info-card" style="display: none;">
                  <div class="line-info-title">âœ… LINE èº«åˆ†é©—è­‰æˆåŠŸ</div>
                  <div class="line-info-details">å·²å–å¾—æ‚¨çš„ LINE è³‡è¨Š</div>
              </div>

              <!-- ç”¨æˆ¶è³‡è¨Šå¡ç‰‡ -->
              <div id="userInfoDisplay" class="user-info" style="display: none;">
                  <div id="userAvatar" class="user-avatar">
                      <span id="avatarText"></span>
                      <img id="avatarImage" style="display: none;" alt="ç”¨æˆ¶é ­åƒ">
                  </div>
                  <div class="user-details">
                      <h3 id="lineDisplayName">è¼‰å…¥ä¸­...</h3>
                      <p>LINE ç”¨æˆ¶</p>
                      <div id="lineUserId" class="user-id">ID: è¼‰å…¥ä¸­...</div>
                  </div>
              </div>

              <!-- ç”¨æˆ¶ç‹€æ…‹è³‡è¨Š -->
              <div id="userStatusInfo" style="display: none;">
                  <div class="user-status">
                      <span class="status-label">è¨»å†Šç‹€æ…‹ï¼š</span>
                      <span id="registrationStatus" class="status-value">æª¢æŸ¥ä¸­...</span>
                  </div>
                  <div class="user-status">
                      <span class="status-label">ç®¡ç†å“¡æ¬Šé™ï¼š</span>
                      <span id="adminStatus" class="status-value">æª¢æŸ¥ä¸­...</span>
                  </div>
                  <div class="user-status">
                      <span class="status-label">ç™»å…¥æ™‚é–“ï¼š</span>
                      <span id="loginTime" class="status-value">-</span>
                  </div>
              </div>

              <!-- çœŸå¯¦å§“åè¼¸å…¥è¡¨å–® -->
              <form id="userInfoForm" style="display: none;">
                  <div class="form-group">
                      <label for="realName">çœŸå¯¦å§“å *</label>
                      <input type="text" id="realName" name="realName" 
                             placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“åä»¥æŸ¥çœ‹è¨‚å–®" required>
                      <small style="color: #666; font-size: 12px;">
                          â€» æ­¤å§“åå°‡ç”¨æ–¼è¨‚å–®è­˜åˆ¥ï¼Œè«‹è¼¸å…¥çœŸå¯¦å§“å
                      </small>
                  </div>
                  
                  <button type="submit" class="btn btn-primary" id="submitBtn">
                      ğŸ“‹ æŸ¥çœ‹æˆ‘çš„è¨‚å–®
                  </button>
              </form>

              <!-- ç®¡ç†å“¡æŒ‰éˆ• -->
              <button id="adminBtn" class="btn btn-success" style="display: none;" onclick="openAdminSystem()">
                  ğŸ‘‘ é€²å…¥ç®¡ç†ç³»çµ±
              </button>

              <!-- é™¤éŒ¯è³‡è¨ŠæŒ‰éˆ• -->
              <button id="debugBtn" class="btn" style="background: #6c757d; color: white; display: none;" onclick="showDebugInfo()">
                  ğŸ”§ é¡¯ç¤ºé™¤éŒ¯è³‡è¨Š
              </button>
          </div>
      </div>
  </div>

  <script>
      // ===== è¨­å®šèˆ‡å…¨åŸŸè®Šæ•¸ =====
      const CONFIG = {
          API_BASE_URL: 'https://script.google.com/macros/s/AKfycbylbsJJAcMW0rEbojRJYL_hpkUyK-DcSLfwYKjRZISnK2QinYTJelHLBlMRQKp5zr34/exec', // è«‹æ›¿æ›ç‚ºæ‚¨çš„ GAS URL
          LIFF_ID: '1657285806-2bmkYWkN', // è«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID
          DEBUG_MODE: true // é–‹ç™¼æ™‚è¨­ç‚º trueï¼Œæ­£å¼ç’°å¢ƒè¨­ç‚º false
      };

      let liffData = {
          userId: null,
          displayName: null,
          pictureUrl: null,
          statusMessage: null,
          email: null
      };
      
      let currentUser = {};
      let isAdmin = false;
      let initStartTime = Date.now();

      // ===== LIFF åˆå§‹åŒ– =====
      document.addEventListener('DOMContentLoaded', function() {
          console.log('=== LIFF è¨‚å–®ç³»çµ±å•Ÿå‹• ===');
          console.log('å•Ÿå‹•æ™‚é–“:', new Date().toLocaleString());
          
          // æª¢æŸ¥ LIFF SDK
          if (typeof liff === 'undefined') {
              showError('LIFF SDK è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
              hideLoading();
              return;
          }
          
          setupEventListeners();
          initializeLiff();
      });

      async function initializeLiff() {
          try {
              showLoading('æ­£åœ¨åˆå§‹åŒ– LIFF...');
              
              // æª¢æŸ¥ LIFF ID æ˜¯å¦å·²è¨­å®š
              if (CONFIG.LIFF_ID === 'YOUR_LIFF_ID') {
                  throw new Error('è«‹å…ˆè¨­å®šæ­£ç¢ºçš„ LIFF ID');
              }
              
              console.log('é–‹å§‹ LIFF åˆå§‹åŒ–...');
              await liff.init({ liffId: CONFIG.LIFF_ID });
              console.log('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ');
              
              // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
              if (liff.isLoggedIn()) {
                  console.log('âœ… ç”¨æˆ¶å·²ç™»å…¥');
                  await getUserProfile();
              } else {
                  console.log('âŒ ç”¨æˆ¶æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
                  showLoading('å°å‘ LINE ç™»å…¥...');
                  liff.login();
                  return;
              }
              
          } catch (error) {
              console.error('âŒ LIFF åˆå§‹åŒ–å¤±æ•—:', error);
              showError(`LIFF åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
              
              // é¡¯ç¤ºé™¤éŒ¯æŒ‰éˆ•
              if (CONFIG.DEBUG_MODE) {
                  document.getElementById('debugBtn').style.display = 'block';
              }
          } finally {
              hideLoading();
          }
      }

      async function getUserProfile() {
          try {
              showLoading('å–å¾—ç”¨æˆ¶è³‡æ–™...');
              
              console.log('é–‹å§‹å–å¾—ç”¨æˆ¶ Profile...');
              const profile = await liff.getProfile();
              
              // å„²å­˜ç”¨æˆ¶è³‡æ–™
              liffData = {
                  userId: profile.userId,
                  displayName: profile.displayName,
                  pictureUrl: profile.pictureUrl || null,
                  statusMessage: profile.statusMessage || null
              };
              
              // å˜—è©¦å–å¾— email (éœ€è¦ email scope)
              try {
                  const email = await liff.getDecodedIDToken()?.email;
                  if (email) {
                      liffData.email = email;
                  }
              } catch (emailError) {
                  console.log('ç„¡æ³•å–å¾— email (å¯èƒ½æœªè¨­å®š email scope)');
              }
              
              console.log('âœ… ç”¨æˆ¶è³‡æ–™å–å¾—æˆåŠŸ:', liffData);
              
              // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
              displayUserInfo();
              
              // é¡¯ç¤º LINE é©—è­‰æˆåŠŸæç¤º
              showLineInfoCard();
              
              // æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹
              await checkUserStatus();
              
          } catch (error) {
              console.error('âŒ å–å¾—ç”¨æˆ¶è³‡æ–™å¤±æ•—:', error);
              showError(`å–å¾—ç”¨æˆ¶è³‡æ–™å¤±æ•—: ${error.message}`);
              
              // é¡¯ç¤ºé™¤éŒ¯æŒ‰éˆ•
              if (CONFIG.DEBUG_MODE) {
                  document.getElementById('debugBtn').style.display = 'block';
              }
          }
      }

      function displayUserInfo() {
          try {
              console.log('é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š...');
              
              // æ›´æ–°ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º
              const userInfoDisplay = document.getElementById('userInfoDisplay');
              const lineDisplayName = document.getElementById('lineDisplayName');
              const lineUserId = document.getElementById('lineUserId');
              const avatarText = document.getElementById('avatarText');
              const avatarImage = document.getElementById('avatarImage');
              
              // è¨­å®šé¡¯ç¤ºåç¨±
              lineDisplayName.textContent = liffData.displayName || 'æœªçŸ¥ç”¨æˆ¶';
              
              // è¨­å®šç”¨æˆ¶ ID (é®è”½éƒ¨åˆ†å­—å…ƒ)
              const maskedUserId = liffData.userId ? 
                  liffData.userId.substring(0, 8) + '...' + liffData.userId.slice(-4) : 
                  'æœªçŸ¥';
              lineUserId.textContent = `ID: ${maskedUserId}`;
              
              // è¨­å®šé ­åƒ
              if (liffData.pictureUrl) {
                  avatarImage.src = liffData.pictureUrl;
                  avatarImage.style.display = 'block';
                  avatarText.style.display = 'none';
                  
                  // è™•ç†åœ–ç‰‡è¼‰å…¥å¤±æ•—
                  avatarImage.onerror = function() {
                      this.style.display = 'none';
                      avatarText.style.display = 'flex';
                      avatarText.textContent = (liffData.displayName || 'U').charAt(0).toUpperCase();
                  };
              } else {
                  avatarText.textContent = (liffData.displayName || 'U').charAt(0).toUpperCase();
                  avatarText.style.display = 'flex';
                  avatarImage.style.display = 'none';
              }
              
              // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Šå€å¡Š
              userInfoDisplay.style.display = 'flex';
              
              // æ·»åŠ å‹•ç•«æ•ˆæœ
              setTimeout(() => {
                  userInfoDisplay.classList.add('show');
              }, 100);
              
              console.log('âœ… ç”¨æˆ¶è³‡è¨Šé¡¯ç¤ºå®Œæˆ');
              
          } catch (error) {
              console.error('âŒ é¡¯ç¤ºç”¨æˆ¶è³‡è¨Šå¤±æ•—:', error);
              showError('é¡¯ç¤ºç”¨æˆ¶è³‡è¨Šæ™‚ç™¼ç”ŸéŒ¯èª¤');
          }
      }

      function showLineInfoCard() {
          const lineInfoCard = document.getElementById('lineInfoCard');
          lineInfoCard.style.display = 'block';
          
          // 3ç§’å¾Œè‡ªå‹•éš±è—
          setTimeout(() => {
              lineInfoCard.style.display = 'none';
          }, 3000);
      }

      async function checkUserStatus() {
          try {
              showLoading('æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹...');
              
              // æª¢æŸ¥ API URL æ˜¯å¦å·²è¨­å®š
              if (CONFIG.API_BASE_URL.includes('YOUR_GAS_WEB_APP_URL')) {
                  throw new Error('è«‹å…ˆè¨­å®šæ­£ç¢ºçš„ API URL');
              }
              
              const response = await fetch(CONFIG.API_BASE_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'user_login',
                      userId: liffData.userId,
                      displayName: liffData.displayName,
                      pictureUrl: liffData.pictureUrl
                  })
              });

              if (!response.ok) {
                  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }

              const result = await response.json();
              
              if (result.success) {
                  isAdmin = result.data.isAdmin || false;
                  
                  // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
                  updateUserStatus(result.data);
                  
                  // å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œé¡¯ç¤ºç®¡ç†å“¡åŠŸèƒ½
                  if (isAdmin) {
                      document.getElementById('adminIndicator').style.display = 'block';
                      document.getElementById('adminBtn').style.display = 'block';
                  }
                  
                  // å¦‚æœå·²è¨»å†Šï¼Œè‡ªå‹•å¡«å…¥çœŸå¯¦å§“å
                  if (result.data.isRegistered && result.data.userInfo) {
                      document.getElementById('realName').value = result.data.userInfo.realName;
                      currentUser = result.data.userInfo;
                      showInfo('æ­¡è¿å›ä¾†ï¼å·²è‡ªå‹•å¡«å…¥æ‚¨çš„è¨»å†Šè³‡æ–™ã€‚');
                  }
                  
                  // é¡¯ç¤ºè¨»å†Šè¡¨å–®
                  document.getElementById('userInfoForm').style.display = 'block';
                  
              } else {
                  throw new Error(result.message || 'æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹å¤±æ•—');
              }
              
          } catch (error) {
              console.error('âŒ æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹å¤±æ•—:', error);
              showError(`é€£æ¥ä¼ºæœå™¨å¤±æ•—: ${error.message}`);
              
              // ä»ç„¶é¡¯ç¤ºè¡¨å–®è®“ç”¨æˆ¶å¯ä»¥å˜—è©¦
              document.getElementById('userInfoForm').style.display = 'block';
              
              // é¡¯ç¤ºé™¤éŒ¯æŒ‰éˆ•
              if (CONFIG.DEBUG_MODE) {
                  document.getElementById('debugBtn').style.display = 'block';
              }
          } finally {
              hideLoading();
          }
      }

      function updateUserStatus(data) {
          const userStatusInfo = document.getElementById('userStatusInfo');
          const registrationStatus = document.getElementById('registrationStatus');
          const adminStatus = document.getElementById('adminStatus');
          const loginTime = document.getElementById('loginTime');
          
          // æ›´æ–°è¨»å†Šç‹€æ…‹
          registrationStatus.textContent = data.isRegistered ? 'å·²è¨»å†Š' : 'æœªè¨»å†Š';
          registrationStatus.style.color = data.isRegistered ? '#28a745' : '#ffc107';
          
          // æ›´æ–°ç®¡ç†å“¡ç‹€æ…‹
          adminStatus.textContent = data.isAdmin ? 'æ˜¯' : 'å¦';
          adminStatus.style.color = data.isAdmin ? '#dc3545' : '#6c757d';
          
          // æ›´æ–°ç™»å…¥æ™‚é–“
          loginTime.textContent = new Date().toLocaleString();
          
          // é¡¯ç¤ºç‹€æ…‹è³‡è¨Š
          userStatusInfo.style.display = 'block';
      }

      // ===== äº‹ä»¶ç›£è½å™¨è¨­å®š =====
      function setupEventListeners() {
          // ç”¨æˆ¶è³‡è¨Šè¡¨å–®æäº¤
          document.getElementById('userInfoForm').addEventListener('submit', handleUserInfoSubmit);
      }

      async function handleUserInfoSubmit(event) {
          event.preventDefault();
          
          try {
              const realName = document.getElementById('realName').value.trim();
              
              // é©—è­‰çœŸå¯¦å§“å
              if (!realName) {
                  throw new Error('è«‹è¼¸å…¥çœŸå¯¦å§“å');
              }
              
              if (realName.length < 2) {
                  throw new Error('çœŸå¯¦å§“åè‡³å°‘éœ€è¦2å€‹å­—å…ƒ');
              }
              
              if (!/^[\u4e00-\u9fa5a-zA-Z\s]+$/.test(realName)) {
                  throw new Error('çœŸå¯¦å§“ååªèƒ½åŒ…å«ä¸­æ–‡ã€è‹±æ–‡å’Œç©ºæ ¼');
              }
              
              showLoading('è¨»å†Šä¸­...');
              
              // è¨»å†Šç”¨æˆ¶
              const registerResult = await registerUser(realName);
              
              if (registerResult.success) {
                  currentUser = registerResult.data.userInfo;
                  showSuccess('è¨»å†ŠæˆåŠŸï¼æ­£åœ¨è¼‰å…¥æ‚¨çš„è¨‚å–®è³‡æ–™...');
                  
                  // é€™è£¡å¯ä»¥ç¹¼çºŒå…¶ä»–åŠŸèƒ½ï¼Œå¦‚è¼‰å…¥è¨‚å–®ç­‰
                  console.log('ç”¨æˆ¶è¨»å†ŠæˆåŠŸ:', currentUser);
                  
              } else {
                  throw new Error(registerResult.message);
              }
              
          } catch (error) {
              showError(error.message);
          } finally {
              hideLoading();
          }
      }

      // ===== API å‘¼å«å‡½æ•¸ =====
      async function registerUser(realName) {
          const response = await fetch(CONFIG.API_BASE_URL, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                  action: 'user_register',
                  userId: liffData.userId,
                  displayName: liffData.displayName,
                  realName: realName,
                  pictureUrl: liffData.pictureUrl
              })
          });
          
          if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          return await response.json();
      }

      // ===== ç®¡ç†å“¡åŠŸèƒ½ =====
      function openAdminSystem() {
          const adminUrl = 'admin.html'; // ç®¡ç†å“¡é é¢ URL
          if (liff.isInClient()) {
              liff.openWindow({
                  url: adminUrl,
                  external: true
              });
          } else {
              window.open(adminUrl, '_blank');
          }
      }

      // ===== å·¥å…·å‡½æ•¸ =====
      function showLoading(message = 'è¼‰å…¥ä¸­...') {
          const loading = document.getElementById('loading');
          loading.querySelector('.loading-text').textContent = message;
          loading.classList.add('show');
      }

      function hideLoading() {
          document.getElementById('loading').classList.remove('show');
      }

      function showMessage(message, type = 'info') {
          // ç§»é™¤ç¾æœ‰è¨Šæ¯
          const existingMessage = document.querySelector('.message');
          if (existingMessage) {
              existingMessage.remove();
          }
          
          // å‰µå»ºæ–°è¨Šæ¯
          const messageDiv = document.createElement('div');
          messageDiv.className = `message ${type}`;
          messageDiv.textContent = message;
          
          // æ’å…¥åˆ°å¡ç‰‡é–‹é ­
          const card = document.querySelector('.card');
          if (card) {
              card.insertBefore(messageDiv, card.firstChild);
              
              // 5ç§’å¾Œè‡ªå‹•ç§»é™¤è¨Šæ¯
              setTimeout(() => {
                  if (messageDiv.parentNode) {
                      messageDiv.remove();
                  }
              }, 5000);
          }
      }

      function showSuccess(message) {
          showMessage(message, 'success');
      }

      function showError(message) {
          showMessage(message, 'error');
      }

      function showInfo(message) {
          showMessage(message, 'info');
      }

      // ===== é™¤éŒ¯å·¥å…· =====
      function showDebugInfo() {
          const debugInfo = {
              'LIFF ç‰©ä»¶': liff,
              'LIFF è³‡æ–™': liffData,
              'ç•¶å‰ç”¨æˆ¶': currentUser,
              'æ˜¯å¦ç‚ºç®¡ç†å“¡': isAdmin,
              'ç™»å…¥ç‹€æ…‹': liff ? liff.isLoggedIn() : 'LIFF æœªè¼‰å…¥',
              'åˆå§‹åŒ–æ™‚é–“': `${Date.now() - initStartTime}ms`,
              'è¨­å®š': CONFIG,
              'ç€è¦½å™¨è³‡è¨Š': {
                  userAgent: navigator.userAgent,
                  language: navigator.language,
                  platform: navigator.platform
              }
          };
          
          console.log('=== LIFF é™¤éŒ¯è³‡è¨Š ===', debugInfo);
          
          // é¡¯ç¤ºç°¡åŒ–çš„é™¤éŒ¯è³‡è¨Š
          const debugText = `
LIFF ç‹€æ…‹: ${liff ? (liff.isLoggedIn() ? 'å·²ç™»å…¥' : 'æœªç™»å…¥') : 'æœªè¼‰å…¥'}
ç”¨æˆ¶ ID: ${liffData.userId || 'æœªå–å¾—'}
é¡¯ç¤ºåç¨±: ${liffData.displayName || 'æœªå–å¾—'}
ç®¡ç†å“¡: ${isAdmin ? 'æ˜¯' : 'å¦'}
åˆå§‹åŒ–æ™‚é–“: ${Date.now() - initStartTime}ms
          `.trim();
          
          alert(debugText);
      }

      window.debugLiff = showDebugInfo;

      console.log('âœ… LIFF è¨‚å–®ç³»çµ±è…³æœ¬è¼‰å…¥å®Œæˆ');
  </script>
</body>
</html>
