<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>實名制登記系統</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          line-height: 1.6;
          color: #333;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
      }

      .container {
          max-width: 800px;
          margin: 0 auto;
          padding: 20px;
      }

      .header {
          background: white;
          padding: 20px;
          border-radius: 10px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          margin-bottom: 20px;
          text-align: center;
      }

      .header h1 {
          color: #333;
          margin-bottom: 10px;
          font-size: 24px;
      }

      .user-info {
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          margin-top: 15px;
      }

      .section {
          background: white;
          padding: 25px;
          border-radius: 10px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          margin-bottom: 20px;
          display: none;
      }

      .section.active {
          display: block;
      }

      .section h2 {
          color: #333;
          margin-bottom: 20px;
          font-size: 20px;
          border-bottom: 2px solid #007bff;
          padding-bottom: 10px;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 5px;
          font-weight: 600;
          color: #555;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
          width: 100%;
          padding: 12px;
          border: 2px solid #ddd;
          border-radius: 6px;
          font-size: 16px;
          transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
          outline: none;
          border-color: #007bff;
      }

      .btn {
          background: #007bff;
          color: white;
          padding: 12px 24px;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-size: 16px;
          transition: background-color 0.3s;
          margin-right: 10px;
          margin-bottom: 10px;
      }

      .btn:hover {
          background: #0056b3;
      }

      .btn-secondary {
          background: #6c757d;
      }

      .btn-secondary:hover {
          background: #545b62;
      }

      .btn-success {
          background: #28a745;
      }

      .btn-success:hover {
          background: #1e7e34;
      }

      .btn-danger {
          background: #dc3545;
      }

      .btn-danger:hover {
          background: #c82333;
      }

      .btn-primary {
          background: #007bff;
      }

      .btn-primary:hover {
          background: #0056b3;
      }

      .notification {
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 20px;
          border-radius: 6px;
          color: white;
          font-weight: 600;
          z-index: 1000;
          opacity: 0;
          transform: translateX(100%);
          transition: all 0.3s;
      }

      .notification.show {
          opacity: 1;
          transform: translateX(0);
      }

      .notification.success {
          background: #28a745;
      }

      .notification.error {
          background: #dc3545;
      }

      .notification.info {
          background: #17a2b8;
      }

      .loading {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1001;
          display: none;
      }

      .loading.show {
          display: flex;
      }

      .spinner {
          width: 50px;
          height: 50px;
          border: 5px solid #f3f3f3;
          border-top: 5px solid #007bff;
          border-radius: 50%;
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .order-item {
          background: #f8f9fa;
          padding: 15px;
          border-radius: 6px;
          margin-bottom: 15px;
          border-left: 4px solid #007bff;
      }

      .order-status {
          display: inline-block;
          padding: 4px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
          text-transform: uppercase;
      }

      .status-pending {
          background: #fff3cd;
          color: #856404;
      }

      .status-paid {
          background: #d4edda;
          color: #155724;
      }

      .status-processing {
          background: #cce7ff;
          color: #004085;
      }

      .file-upload {
          border: 2px dashed #ddd;
          padding: 30px;
          text-align: center;
          border-radius: 6px;
          cursor: pointer;
          transition: border-color 0.3s;
      }

      .file-upload:hover {
          border-color: #007bff;
      }

      .file-upload.dragover {
          border-color: #007bff;
          background: #f8f9ff;
      }

      .admin-controls {
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
          margin-bottom: 20px;
      }

      .filter-group {
          display: flex;
          flex-wrap: wrap;
          gap: 15px;
          margin-bottom: 20px;
          align-items: center;
      }

      .filter-group label {
          font-weight: 600;
          color: #555;
      }

      .filter-group select,
      .filter-group input {
          padding: 8px 12px;
          border: 1px solid #ddd;
          border-radius: 4px;
      }

      .payment-record {
          background: white;
          border: 1px solid #ddd;
          border-radius: 6px;
          padding: 15px;
          margin-bottom: 15px;
      }

      .payment-record h4 {
          margin-bottom: 10px;
          color: #333;
      }

      .payment-details {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 10px;
          margin-bottom: 15px;
      }

      .payment-actions {
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
      }

      .image-preview {
          max-width: 200px;
          max-height: 200px;
          border-radius: 6px;
          margin-top: 10px;
      }

      /* 模態框樣式 */
      .modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
      }
      
      .modal-content {
          background: white;
          border-radius: 8px;
          width: 90%;
          max-width: 500px;
          max-height: 90vh;
          overflow-y: auto;
      }
      
      .modal-large .modal-content {
          max-width: 800px;
      }
      
      .modal-header {
          padding: 20px;
          border-bottom: 1px solid #eee;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      
      .modal-close {
          background: none;
          border: none;
          font-size: 24px;
          cursor: pointer;
          color: #999;
      }
      
      .modal-body {
          padding: 20px;
      }
      
      .modal-footer {
          padding: 20px;
          border-top: 1px solid #eee;
          display: flex;
          justify-content: flex-end;
          gap: 10px;
      }
      
      /* 分頁樣式 */
      .config-tabs {
          width: 100%;
      }
      
      .tab-buttons {
          display: flex;
          border-bottom: 1px solid #ddd;
          margin-bottom: 20px;
      }
      
      .tab-btn {
          background: none;
          border: none;
          padding: 10px 20px;
          cursor: pointer;
          border-bottom: 2px solid transparent;
      }
      
      .tab-btn.active {
          border-bottom-color: #007bff;
          color: #007bff;
      }
      
      .tab-pane {
          display: none;
      }
      
      .tab-pane.active {
          display: block;
      }
      
      /* 管理員列表樣式 */
      .admin-list {
          margin-top: 20px;
      }
      
      .list-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
      }
      
      .admin-table {
          overflow-x: auto;
      }
      
      .table {
          width: 100%;
          border-collapse: collapse;
      }
      
      .table th,
      .table td {
          padding: 12px;
          text-align: left;
          border-bottom: 1px solid #ddd;
      }
      
      .table th {
          background-color: #f8f9fa;
          font-weight: 600;
      }
      
      .badge {
          display: inline-block;
          padding: 4px 8px;
          font-size: 12px;
          border-radius: 4px;
          color: white;
      }
      
      .badge-success { background-color: #28a745; }
      .badge-info { background-color: #17a2b8; }
      .badge-warning { background-color: #ffc107; color: #212529; }
      .badge-danger { background-color: #dc3545; }
      .badge-secondary { background-color: #6c757d; }
      
      .btn-group {
          display: flex;
          gap: 5px;
      }
      
      .btn-sm {
          padding: 4px 8px;
          font-size: 12px;
      }
      
      .btn-outline-primary {
          border: 1px solid #007bff;
          color: #007bff;
          background: transparent;
      }
      
      .btn-outline-danger {
          border: 1px solid #dc3545;
          color: #dc3545;
          background: transparent;
      }
      
      .empty-state {
          text-align: center;
          padding: 40px;
          color: #666;
      }

      @media (max-width: 768px) {
          .container {
              padding: 10px;
          }

          .header h1 {
              font-size: 20px;
          }

          .section {
              padding: 20px;
          }

          .admin-controls {
              flex-direction: column;
          }

          .filter-group {
              flex-direction: column;
              align-items: stretch;
          }

          .payment-details {
              grid-template-columns: 1fr;
          }

          .payment-actions {
              flex-direction: column;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <!-- 標題區域 -->
      <div class="header">
          <h1><i class="fas fa-clipboard-list"></i> 實名制登記系統</h1>
          <div id="userInfo" class="user-info" style="display: none;">
              <p><strong>用戶名稱：</strong><span id="userName"></span></p>
              <p><strong>用戶ID：</strong><span id="userId"></span></p>
          </div>
      </div>

      <!-- 用戶登記區域 -->
      <div id="registrationSection" class="section">
          <h2><i class="fas fa-user-plus"></i> 用戶登記</h2>
          <form id="registrationForm">
              <div class="form-group">
                  <label for="realName">真實姓名 *</label>
                  <input type="text" id="realName" name="realName" required>
              </div>
              <div class="form-group">
                  <label for="phone">聯絡電話 *</label>
                  <input type="tel" id="phone" name="phone" required>
              </div>
              <div class="form-group">
                  <label for="email">電子信箱</label>
                  <input type="email" id="email" name="email">
              </div>
              <div class="form-group">
                  <label for="address">聯絡地址</label>
                  <textarea id="address" name="address" rows="3"></textarea>
              </div>
              <div class="form-group">
                  <label for="emergencyContact">緊急聯絡人</label>
                  <input type="text" id="emergencyContact" name="emergencyContact">
              </div>
              <div class="form-group">
                  <label for="emergencyPhone">緊急聯絡電話</label>
                  <input type="tel" id="emergencyPhone" name="emergencyPhone">
              </div>
              <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i> 提交登記
              </button>
          </form>
      </div>

      <!-- 訂單管理區域 -->
      <div id="ordersSection" class="section">
          <h2><i class="fas fa-shopping-cart"></i> 我的訂單</h2>
          <div id="ordersList">
              <!-- 訂單列表會在這裡動態載入 -->
          </div>
          <div style="margin-top: 20px;">
              <button class="btn btn-primary" onclick="showSection('paymentSection')">
                  <i class="fas fa-credit-card"></i> 繳費證明上傳
              </button>
          </div>
      </div>

      <!-- 繳費證明上傳區域 -->
      <div id="paymentSection" class="section">
          <h2><i class="fas fa-receipt"></i> 繳費證明上傳</h2>
          <form id="paymentForm">
              <div class="form-group">
                  <label for="orderId">選擇訂單 *</label>
                  <select id="orderId" name="orderId" required>
                      <option value="">請選擇訂單</option>
                  </select>
              </div>
              <div class="form-group">
                  <label for="paymentMethod">繳費方式 *</label>
                  <select id="paymentMethod" name="paymentMethod" required>
                      <option value="">請選擇繳費方式</option>
                  </select>
              </div>
              <div class="form-group">
                  <label for="paymentAmount">繳費金額 *</label>
                  <input type="number" id="paymentAmount" name="paymentAmount" required min="0" step="1">
              </div>
              <div class="form-group">
                  <label for="paymentDate">繳費日期 *</label>
                  <input type="date" id="paymentDate" name="paymentDate" required>
              </div>
              <div class="form-group">
                  <label>上傳繳費證明 *</label>
                  <div class="file-upload" onclick="document.getElementById('paymentProof').click()">
                      <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #ddd; margin-bottom: 10px;"></i>
                      <p>點擊或拖拽文件到此處上傳</p>
                      <p style="font-size: 14px; color: #666;">支援 JPG, PNG, PDF 格式，檔案大小不超過 5MB</p>
                  </div>
                  <input type="file" id="paymentProof" name="paymentProof" accept="image/*,.pdf" style="display: none;" required>
                  <div id="filePreview" style="margin-top: 15px;"></div>
              </div>
              <div class="form-group">
                  <label for="paymentNote">備註</label>
                  <textarea id="paymentNote" name="paymentNote" rows="3" placeholder="其他說明或備註資訊"></textarea>
              </div>
              <button type="submit" class="btn btn-success">
                  <i class="fas fa-upload"></i> 提交繳費證明
              </button>
              <button type="button" class="btn btn-secondary" onclick="showSection('ordersSection')">
                  <i class="fas fa-arrow-left"></i> 返回訂單
              </button>
          </form>
      </div>

      <!-- 管理員區域 -->
      <div id="adminSection" class="section">
          <h2><i class="fas fa-cog"></i> 管理員面板</h2>
          
          <div class="admin-controls">
              <button class="btn btn-primary" onclick="loadPaymentRecords()">
                  <i class="fas fa-refresh"></i> 重新載入
              </button>
              <button class="btn btn-success" onclick="exportData('payments')">
                  <i class="fas fa-download"></i> 匯出繳費記錄
              </button>
              <button class="btn btn-info" onclick="exportData('registrations')">
                  <i class="fas fa-download"></i> 匯出登記資料
              </button>
              <button class="btn btn-warning" onclick="showAddAdminForm()">
                  <i class="fas fa-user-plus"></i> 新增管理員
              </button>
              <button class="btn btn-secondary" onclick="showSystemConfigForm()">
                  <i class="fas fa-cog"></i> 系統設定
              </button>
              <button class="btn btn-danger" onclick="createBackup()">
                  <i class="fas fa-database"></i> 建立備份
              </button>
          </div>

          <div class="filter-group">
              <label>狀態篩選：</label>
              <select id="statusFilter" onchange="filterPaymentRecords()">
                  <option value="">全部狀態</option>
                  <option value="pending">待審核</option>
                  <option value="approved">已核准</option>
                  <option value="rejected">已拒絕</option>
              </select>
              
              <label>日期範圍：</label>
              <input type="date" id="dateFrom" onchange="filterPaymentRecords()">
              <span>至</span>
              <input type="date" id="dateTo" onchange="filterPaymentRecords()">
              
              <label>搜尋：</label>
              <input type="text" id="searchKeyword" placeholder="姓名或訂單號" onchange="filterPaymentRecords()">
          </div>

          <div id="paymentRecordsList">
              <!-- 繳費記錄會在這裡動態載入 -->
          </div>

          <div id="adminListContainer">
              <!-- 管理員列表會在這裡動態載入 -->
          </div>
      </div>
  </div>

  <!-- 通知訊息 -->
  <div id="notification" class="notification"></div>

  <!-- 載入動畫 -->
  <div id="loading" class="loading">
      <div style="text-align: center; color: white;">
          <div class="spinner"></div>
          <p style="margin-top: 15px;" id="loadingText">載入中...</p>
      </div>
  </div>

  <script>
      // ==================== 設定區域 ====================
      const CONFIG = {
          LIFF_ID: '1657285806-2bmkYWkN',
          API_BASE_URL: 'https://script.google.com/macros/s/AKfycbyuskwU4dTuDRJU4GgR8y7W33QLcLFCUm6qhD-IPTyy2KC7MBCsR_PwMAr8LsUGwHSC/exec',
          DEBUG_MODE: true,
          DEMO_MODE: false, // 設為 true 使用示範模式false
          RETRY_ATTEMPTS: 3,
          RETRY_DELAY: 1000
      };

      // ==================== 全域變數 ====================
      let currentUser = null;
      let isAdmin = false;
      let systemConfig = {};
      let allPaymentRecords = [];

      // ==================== 工具函數 ====================
      function debugLog(message, data = null) {
          if (CONFIG.DEBUG_MODE) {
              const timestamp = new Date().toLocaleString('zh-TW');
              if (data) {
                  console.log(`%c[${timestamp}] ${message}`, 'color: #007bff;', data);
              } else {
                  console.log(`%c[${timestamp}] ${message}`, 'color: #28a745;');
              }
          }
      }

      function showNotification(message, type = 'info') {
          const notification = document.getElementById('notification');
          notification.textContent = message;
          notification.className = `notification ${type}`;
          notification.classList.add('show');

          setTimeout(() => {
              notification.classList.remove('show');
          }, 3000);
      }

      function showLoading(message = '載入中...') {
          document.getElementById('loadingText').textContent = message;
          document.getElementById('loading').classList.add('show');
      }

      function hideLoading() {
          document.getElementById('loading').classList.remove('show');
      }

      function showSection(sectionId) {
          debugLog(`顯示區域: ${sectionId}`);
          
          // 隱藏所有區域
          document.querySelectorAll('.section').forEach(section => {
              section.classList.remove('active');
          });
          
          // 顯示指定區域
          const targetSection = document.getElementById(sectionId);
          if (targetSection) {
              targetSection.classList.add('active');
          }
      }

      function formatDateTime(dateString) {
          if (!dateString) return '未知';
          const date = new Date(dateString);
          return date.toLocaleString('zh-TW');
      }

      function formatCurrency(amount) {
          return new Intl.NumberFormat('zh-TW', {
              style: 'currency',
              currency: 'TWD'
          }).format(amount);
      }

      // ==================== API 呼叫函數 ====================
      async function callAPI(action, data = {}) {
          try {
              debugLog(`API 呼叫: ${action}`, data);
              
              if (CONFIG.DEMO_MODE) {
                  return getDemoData(action, data);
              }
              
              // 使用 fetch 方法替代 JSONP
              const params = new URLSearchParams({
                  action: action,
                  data: JSON.stringify(data)
              });
              
              const response = await fetch(`${CONFIG.API_BASE_URL}?${params}`, {
                  method: 'GET',
                  mode: 'cors'
              });
              
              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }
              
              const result = await response.json();
              debugLog(`API 回應: ${action}`, result);
              return result;
              
          } catch (error) {
              debugLog(`API 呼叫失敗: ${action}`, error);
              
              // 如果 fetch 失敗，嘗試 JSONP 方法
              try {
                  return await callAPIWithJSONP(action, data);
              } catch (jsonpError) {
                  debugLog(`JSONP 也失敗: ${action}`, jsonpError);
                  throw error;
              }
          }
      }

      // JSONP 備用方法
      async function callAPIWithJSONP(action, data = {}) {
          return new Promise((resolve, reject) => {
              const callbackName = 'callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
              
              window[callbackName] = (response) => {
                  debugLog(`JSONP 回應: ${action}`, response);
                  delete window[callbackName];
                  resolve(response);
              };
              
              const params = new URLSearchParams({
                  action: action,
                  data: JSON.stringify(data),
                  callback: callbackName,
                  _: Date.now()
              });
              
              const script = document.createElement('script');
              script.src = `${CONFIG.API_BASE_URL}?${params}`;
              script.onerror = () => {
                  delete window[callbackName];
                  reject(new Error('JSONP 呼叫失敗'));
              };
              
              document.head.appendChild(script);
              
              // 清理腳本標籤
              setTimeout(() => {
                  if (document.head.contains(script)) {
                      document.head.removeChild(script);
                  }
              }, 1000);
              
              // 設定逾時
              setTimeout(() => {
                  if (window[callbackName]) {
                      delete window[callbackName];
                      reject(new Error('API 呼叫逾時'));
                  }
              }, 15000);
          });
      }

      // ==================== 示範資料函數 ====================
      function getDemoData(action, data) {
          debugLog(`使用示範資料: ${action}`, data);
          
          // 模擬網路延遲
          return new Promise(resolve => {
              setTimeout(() => {
                  let result;
                  
                  switch (action) {
                      case 'test':
                          result = { success: true, message: 'API 連線測試成功（示範模式）' };
                          break;
                          
                      case 'get-config':
                          result = {
                              success: true,
                              config: {
                                  paymentMethods: [
                                      { id: 'bank', name: '銀行轉帳', account: '123-456-789' },
                                      { id: 'atm', name: 'ATM 轉帳', account: '987-654-321' },
                                      { id: 'cash', name: '現金繳費', note: '請至指定地點繳費' }
                                  ],
                                  fileUpload: {
                                      maxSize: 5242880,
                                      allowedTypes: ['image/jpeg', 'image/png', 'application/pdf']
                                  },
                                  basic: {
                                      systemName: '實名制登記系統',
                                      contactPhone: '0912-345-678',
                                      contactEmail: 'admin@example.com'
                                  },
                                  messages: {
                                      welcome: '歡迎使用實名制登記系統',
                                      registrationSuccess: '您的實名制登記已完成'
                                  }
                              }
                          };
                          break;
                          
                      case 'check-admin':
                          result = { success: true, isAdmin: true, role: 'admin' };
                          break;
                          
                      case 'check-registration':
                          result = { success: true, registered: false };
                          break;
                          
                      case 'register':
                          result = { 
                              success: true, 
                              message: '用戶登記成功（示範模式）',
                              userId: 'demo_user_123'
                          };
                          break;
                          
                      case 'orders':
                          result = {
                              success: true,
                              orders: [
                                  {
                                      id: 'ORDER001',
                                      productName: '示範商品A',
                                      amount: 1500,
                                      status: 'pending',
                                      createdAt: '2024-01-15T10:30:00Z',
                                      dueDate: '2024-01-25T23:59:59Z'
                                  },
                                  {
                                      id: 'ORDER002',
                                      productName: '示範商品B',
                                      amount: 2800,
                                      status: 'paid',
                                      createdAt: '2024-01-10T14:20:00Z',
                                      paidAt: '2024-01-12T09:15:00Z'
                                  }
                              ]
                          };
                          break;
                          
                      case 'submit-payment':
                          result = { 
                              success: true, 
                              message: '繳費證明提交成功（示範模式）',
                              paymentId: 'PAY_' + Date.now()
                          };
                          break;
                          
                      case 'get-payment-records':
                          result = {
                              success: true,
                              records: [
                                  {
                                      id: 'PAY001',
                                      orderId: 'ORDER001',
                                      userName: '王小明',
                                      userId: 'user123',
                                      amount: 1500,
                                      paymentMethod: '銀行轉帳',
                                      status: 'pending',
                                      submittedAt: '2024-01-16T08:30:00Z',
                                      proofUrl: 'demo_proof_1.jpg'
                                  },
                                  {
                                      id: 'PAY002',
                                      orderId: 'ORDER002',
                                      userName: '李小華',
                                      userId: 'user456',
                                      amount: 2800,
                                      paymentMethod: 'ATM轉帳',
                                      status: 'approved',
                                      submittedAt: '2024-01-12T09:15:00Z',
                                      approvedAt: '2024-01-12T15:30:00Z',
                                      proofUrl: 'demo_proof_2.jpg'
                                  }
                              ]
                          };
                          break;
                          
                      case 'approve-payment':
                      case 'reject-payment':
                          result = { 
                              success: true, 
                              message: `繳費記錄${action === 'approve-payment' ? '核准' : '拒絕'}成功（示範模式）`
                          };
                          break;
                          
                      case 'get-admin-list':
                          result = {
                              success: true,
                              admins: [
                                  {
                                      lineId: 'admin001',
                                      name: '系統管理員',
                                      role: 'admin',
                                      active: true,
                                      createdAt: '2024-01-01T00:00:00Z'
                                  },
                                  {
                                      lineId: 'mod001',
                                      name: '管理者A',
                                      role: 'moderator',
                                      active: true,
                                      createdAt: '2024-01-05T10:00:00Z'
                                  }
                              ]
                          };
                          break;
                          
                      case 'add-admin':
                      case 'remove-admin':
                      case 'update-system-config':
                      case 'create-backup':
                          result = { 
                              success: true, 
                              message: `${action}操作成功（示範模式）`
                          };
                          break;
                          
                      case 'export-data':
                          result = {
                              success: true,
                              data: data.dataType === 'payments' ? 
                                  [{ id: 'PAY001', amount: 1500, status: 'pending' }] :
                                  [{ id: 'REG001', name: '王小明', phone: '0912345678' }],
                              fileName: `${data.dataType}_export_${new Date().toISOString().split('T')[0]}.json`,
                              recordCount: 2
                          };
                          break;
                          
                      default:
                          result = { success: false, message: '未知的操作' };
                  }
                  
                  resolve(result);
              }, 500); // 模擬 500ms 延遲
          });
      }

      // ==================== 管理員功能函數 ====================

      // 顯示新增管理員表單
      function showAddAdminForm() {
          debugLog('顯示新增管理員表單');
          
          const modal = document.createElement('div');
          modal.className = 'modal-overlay';
          modal.innerHTML = `
              <div class="modal-content">
                  <div class="modal-header">
                      <h3>新增管理員</h3>
                      <button class="modal-close" onclick="closeModal(this)">&times;</button>
                  </div>
                  <div class="modal-body">
                      <form id="addAdminForm">
                          <div class="form-group">
                              <label for="adminLineId">LINE ID</label>
                              <input type="text" id="adminLineId" required 
                                     placeholder="請輸入 LINE 用戶 ID">
                          </div>
                          <div class="form-group">
                              <label for="adminName">管理員姓名</label>
                              <input type="text" id="adminName" required 
                                     placeholder="請輸入管理員姓名">
                          </div>
                          <div class="form-group">
                              <label for="adminRole">權限等級</label>
                              <select id="adminRole" required>
                                  <option value="">請選擇權限等級</option>
                                  <option value="viewer">檢視者</option>
                                  <option value="moderator">管理者</option>
                                  <option value="admin">系統管理員</option>
                              </select>
                          </div>
                          <div class="form-group">
                              <label for="adminNote">備註</label>
                              <textarea id="adminNote" rows="3" 
                                      placeholder="選填：管理員備註資訊"></textarea>
                          </div>
                      </form>
                  </div>
                  <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" onclick="closeModal(this)">
                          取消
                      </button>
                      <button type="button" class="btn btn-primary" onclick="submitAddAdmin()">
                          新增管理員
                      </button>
                  </div>
              </div>
          `;
          
          document.body.appendChild(modal);
          
          // 設定焦點
          setTimeout(() => {
              document.getElementById('adminLineId').focus();
          }, 100);
      }

      // 提交新增管理員
      async function submitAddAdmin() {
          try {
              const lineId = document.getElementById('adminLineId').value.trim();
              const name = document.getElementById('adminName').value.trim();
              const role = document.getElementById('adminRole').value;
              const note = document.getElementById('adminNote').value.trim();
              
              // 驗證輸入
              if (!lineId || !name || !role) {
                  showNotification('請填寫所有必填欄位', 'error');
                  return;
              }
              
              showLoading('新增管理員中...');
              
              const result = await callAPI('add-admin', {
                  requestUserId: currentUser.userId,
                  newAdminData: {
                      lineId: lineId,
                      name: name,
                      role: role,
                      note: note
                  }
              });
              
              hideLoading();
              
              if (result.success) {
                  showNotification('管理員新增成功', 'success');
                  closeModal(document.querySelector('.modal-overlay'));
                  loadAdminList(); // 重新載入管理員列表
              } else {
                  showNotification(result.message || '新增管理員失敗', 'error');
              }
              
          } catch (error) {
              hideLoading();
              debugLog('新增管理員失敗', error);
              showNotification('新增管理員時發生錯誤', 'error');
          }
      }

      // 載入管理員列表
      async function loadAdminList() {
          try {
              debugLog('載入管理員列表');
              
              const result = await callAPI('get-admin-list', {
                  userId: currentUser.userId
              });
              
              if (result.success) {
                  displayAdminList(result.admins);
              } else {
                  showNotification(result.message || '載入管理員列表失敗', 'error');
              }
              
          } catch (error) {
              debugLog('載入管理員列表失敗', error);
              showNotification('載入管理員列表時發生錯誤', 'error');
          }
      }

      // 顯示管理員列表
      function displayAdminList(admins) {
          const container = document.getElementById('adminListContainer');
          if (!container) {
              debugLog('找不到管理員列表容器');
              return;
          }
          
          if (!admins || admins.length === 0) {
              container.innerHTML = `
                  <div class="empty-state">
                      <p>目前沒有管理員資料</p>
                  </div>
              `;
              return;
          }
          
          const html = `
              <div class="admin-list">
                  <div class="list-header">
                      <h4>管理員列表 (${admins.length})</h4>
                      <button class="btn btn-primary btn-sm" onclick="showAddAdminForm()">
                          <i class="fas fa-plus"></i> 新增管理員
                      </button>
                  </div>
                  <div class="admin-table">
                      <table class="table">
                          <thead>
                              <tr>
                                  <th>姓名</th>
                                  <th>LINE ID</th>
                                  <th>權限等級</th>
                                  <th>狀態</th>
                                  <th>建立時間</th>
                                  <th>操作</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${admins.map(admin => `
                                  <tr>
                                      <td>${admin.name}</td>
                                      <td><code>${admin.lineId}</code></td>
                                      <td>
                                          <span class="badge badge-${getRoleBadgeClass(admin.role)}">
                                              ${getRoleDisplayName(admin.role)}
                                          </span>
                                      </td>
                                      <td>
                                          <span class="badge badge-${admin.active ? 'success' : 'secondary'}">
                                              ${admin.active ? '啟用' : '停用'}
                                          </span>
                                      </td>
                                      <td>${formatDateTime(admin.createdAt)}</td>
                                      <td>
                                          <div class="btn-group">
                                              <button class="btn btn-sm btn-outline-primary" 
                                                      onclick="editAdmin('${admin.lineId}')">
                                                  編輯
                                              </button>
                                              <button class="btn btn-sm btn-outline-danger" 
                                                      onclick="confirmRemoveAdmin('${admin.lineId}', '${admin.name}')">
                                                  移除
                                              </button>
                                          </div>
                                      </td>
                                  </tr>
                              `).join('')}
                          </tbody>
                      </table>
                  </div>
              </div>
          `;
          
          container.innerHTML = html;
      }

      // 取得權限等級顯示名稱
      function getRoleDisplayName(role) {
          const roleNames = {
              'viewer': '檢視者',
              'moderator': '管理者',
              'admin': '系統管理員'
          };
          return roleNames[role] || role;
      }

      // 取得權限等級徽章樣式
      function getRoleBadgeClass(role) {
          const badgeClasses = {
              'viewer': 'info',
              'moderator': 'warning',
              'admin': 'danger'
          };
          return badgeClasses[role] || 'secondary';
      }

      // 編輯管理員
      function editAdmin(lineId) {
          debugLog('編輯管理員', lineId);
          showNotification('編輯功能開發中', 'info');
      }

      // 確認移除管理員
      function confirmRemoveAdmin(lineId, name) {
          if (confirm(`確定要移除管理員「${name}」嗎？此操作無法復原。`)) {
              removeAdmin(lineId);
          }
      }

      // 移除管理員
      async function removeAdmin(lineId) {
          try {
              showLoading('移除管理員中...');
              
              const result = await callAPI('remove-admin', {
                  requestUserId: currentUser.userId,
                  targetLineId: lineId
              });
              
              hideLoading();
              
              if (result.success) {
                  showNotification('管理員移除成功', 'success');
                  loadAdminList(); // 重新載入管理員列表
              } else {
                  showNotification(result.message || '移除管理員失敗', 'error');
              }
              
          } catch (error) {
              hideLoading();
              debugLog('移除管理員失敗', error);
              showNotification('移除管理員時發生錯誤', 'error');
          }
      }

      // 關閉模態框
      function closeModal(element) {
          const modal = element.closest('.modal-overlay');
          if (modal) {
              modal.remove();
          }
      }

      // 顯示系統設定表單
      function showSystemConfigForm() {
          debugLog('顯示系統設定表單');
          
          const modal = document.createElement('div');
          modal.className = 'modal-overlay modal-large';
          modal.innerHTML = `
              <div class="modal-content">
                  <div class="modal-header">
                      <h3>系統設定</h3>
                      <button class="modal-close" onclick="closeModal(this)">&times;</button>
                  </div>
                  <div class="modal-body">
                      <div class="config-tabs">
                          <div class="tab-buttons">
                              <button class="tab-btn active" onclick="showConfigTab('basic')">基本設定</button>
                              <button class="tab-btn" onclick="showConfigTab('payment')">繳費方式</button>
                              <button class="tab-btn" onclick="showConfigTab('messages')">系統訊息</button>
                          </div>
                          
                          <div class="tab-content">
                              <div id="basicConfigTab" class="tab-pane active">
                                  <h4>基本設定</h4>
                                  <div class="form-group">
                                      <label>系統名稱</label>
                                      <input type="text" id="systemName" value="實名制登記系統">
                                  </div>
                                  <div class="form-group">
                                      <label>聯絡電話</label>
                                      <input type="text" id="contactPhone" value="0912-345-678">
                                  </div>
                                  <div class="form-group">
                                      <label>聯絡信箱</label>
                                      <input type="email" id="contactEmail" value="admin@example.com">
                                  </div>
                              </div>
                              
                              <div id="paymentConfigTab" class="tab-pane">
                                  <h4>繳費方式設定</h4>
                                  <div id="paymentMethodsList">
                                      <!-- 繳費方式列表會在這裡動態載入 -->
                                  </div>
                                  <button class="btn btn-secondary" onclick="addPaymentMethod()">
                                      新增繳費方式
                                  </button>
                              </div>
                              
                              <div id="messagesConfigTab" class="tab-pane">
                                  <h4>系統訊息設定</h4>
                                  <div class="form-group">
                                      <label>歡迎訊息</label>
                                      <textarea id="welcomeMessage" rows="3">歡迎使用實名制登記系統</textarea>
                                  </div>
                                  <div class="form-group">
                                      <label>登記成功訊息</label>
                                      <textarea id="registrationSuccessMessage" rows="3">您的實名制登記已完成</textarea>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
                  <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" onclick="closeModal(this)">
                          取消
                      </button>
                      <button type="button" class="btn btn-primary" onclick="saveSystemConfig()">
                          儲存設定
                      </button>
                  </div>
              </div>
          `;
          
          document.body.appendChild(modal);
          loadCurrentConfig();
      }

      // 顯示設定分頁
      function showConfigTab(tabName) {
          // 移除所有 active 類別
          document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
          
          // 啟用選中的分頁
          document.querySelector(`[onclick="showConfigTab('${tabName}')"]`).classList.add('active');
          document.getElementById(`${tabName}ConfigTab`).classList.add('active');
      }

      // 載入目前設定
      async function loadCurrentConfig() {
          try {
              const result = await callAPI('get-config');
              if (result.success && result.config) {
                  // 填入基本設定
                  if (result.config.basic) {
                      document.getElementById('systemName').value = result.config.basic.systemName || '';
                      document.getElementById('contactPhone').value = result.config.basic.contactPhone || '';
                      document.getElementById('contactEmail').value = result.config.basic.contactEmail || '';
                  }
                  
                  // 填入系統訊息
                  if (result.config.messages) {
                      document.getElementById('welcomeMessage').value = result.config.messages.welcome || '';
                      document.getElementById('registrationSuccessMessage').value = result.config.messages.registrationSuccess || '';
                  }
              }
          } catch (error) {
              debugLog('載入設定失敗', error);
          }
      }

      // 儲存系統設定
      async function saveSystemConfig() {
          try {
              showLoading('儲存設定中...');
              
              const configData = {
                  basic: {
                      systemName: document.getElementById('systemName').value,
                      contactPhone: document.getElementById('contactPhone').value,
                      contactEmail: document.getElementById('contactEmail').value
                  },
                  messages: {
                      welcome: document.getElementById('welcomeMessage').value,
                      registrationSuccess: document.getElementById('registrationSuccessMessage').value
                  }
              };
              
              const result = await callAPI('update-system-config', {
                  requestUserId: currentUser.userId,
                  configData: configData
              });
              
              hideLoading();
              
              if (result.success) {
                  showNotification('系統設定儲存成功', 'success');
                  closeModal(document.querySelector('.modal-overlay'));
              } else {
                  showNotification(result.message || '儲存設定失敗', 'error');
              }
              
          } catch (error) {
              hideLoading();
              debugLog('儲存設定失敗', error);
              showNotification('儲存設定時發生錯誤', 'error');
          }
      }

      // 匯出資料
      async function exportData(dataType) {
          try {
              showLoading('匯出資料中...');
              
              const result = await callAPI('export-data', {
                  requestUserId: currentUser.userId,
                  dataType: dataType
              });
              
              hideLoading();
              
              if (result.success) {
                  // 建立下載連結
                  const dataStr = JSON.stringify(result.data, null, 2);
                  const dataBlob = new Blob([dataStr], {type: 'application/json'});
                  
                  const link = document.createElement('a');
                  link.href = URL.createObjectURL(dataBlob);
                  link.download = result.fileName || `${dataType}_export.json`;
                  link.click();
                  
                  showNotification(`資料匯出成功 (${result.recordCount} 筆記錄)`, 'success');
              } else {
                  showNotification(result.message || '匯出資料失敗', 'error');
              }
              
          } catch (error) {
              hideLoading();
              debugLog('匯出資料失敗', error);
              showNotification('匯出資料時發生錯誤', 'error');
          }
      }

      // 建立系統備份
      async function createBackup() {
          try {
              if (!confirm('確定要建立系統備份嗎？這可能需要一些時間。')) {
                  return;
              }
              
              showLoading('建立備份中...');
              
              const result = await callAPI('create-backup', {
                  requestUserId: currentUser.userId
              });
              
              hideLoading();
              
              if (result.success) {
                  showNotification('系統備份建立成功', 'success');
                  debugLog('備份資訊', result.backup);
              } else {
                  showNotification(result.message || '建立備份失敗', 'error');
              }
              
          } catch (error) {
              hideLoading();
              debugLog('建立備份失敗', error);
              showNotification('建立備份時發生錯誤', 'error');
          }
      }

      // ==================== 核心業務邏輯 ====================

      // 初始化應用程式
      async function initializeApp() {
          try {
              debugLog('頁面載入完成，開始初始化');
              
              // 檢查 API 連線
              debugLog('檢查 API 連線狀態');
              const apiTest = await callAPI('test');
              if (apiTest.success) {
                  debugLog('API 連線正常', apiTest);
              } else {
                  throw new Error('API 連線失敗');
              }
              
              // 初始化 LIFF
              debugLog('開始初始化 LIFF');
              await liff.init({ liffId: CONFIG.LIFF_ID });
              debugLog('LIFF 初始化成功');
              
              // 載入系統設定
              debugLog('載入系統設定');
              const configResult = await callAPI('get-config');
              if (configResult.success) {
                  systemConfig = configResult.config;
                  debugLog('系統設定載入成功', systemConfig);
                  
                  // 更新繳費方式選項
                  updatePaymentMethods(systemConfig.paymentMethods);
                  
                  // 更新檔案上傳設定
                  updateFileUploadSettings(systemConfig.fileUpload);
                  
                  // 套用其他系統設定
                  applySystemConfig(systemConfig);
              } else {
                  debugLog('系統設定載入失敗', configResult);
              }
              
              // 檢查登入狀態
              if (liff.isLoggedIn()) {
                  debugLog('用戶已登入 LINE');
                  
                  // 取得用戶資料
                  const profile = await liff.getProfile();
                  currentUser = {
                      userId: profile.userId,
                      displayName: profile.displayName,
                      pictureUrl: profile.pictureUrl
                  };
                  debugLog('取得用戶資料', currentUser);
                  
                  // 顯示用戶資訊
                  displayUserInfo(currentUser);
                  
                  // 檢查管理員權限
                  const adminCheck = await callAPI('check-admin', { userId: currentUser.userId });
                  if (adminCheck.success && adminCheck.isAdmin) {
                      isAdmin = true;
                      debugLog('用戶具有管理員權限', adminCheck);
                  }
                  
                  // 檢查用戶登記狀態
                  debugLog('檢查用戶登記狀態');
                  const registrationCheck = await callAPI('check-registration', { userId: currentUser.userId });
                  
                  if (registrationCheck.success) {
                      if (registrationCheck.registered) {
                          debugLog('用戶已登記');
                          await loadUserOrders();
                          showSection('ordersSection');
                      } else {
                          debugLog('用戶尚未登記');
                          showSection('registrationSection');
                      }
                  } else {
                      showNotification('檢查登記狀態時發生錯誤', 'error');
                      showSection('registrationSection');
                  }
              } else {
                  debugLog('用戶未登入，開始登入流程');
                  liff.login();
              }
              
              // 設定事件處理器
              setupEventHandlers();
              debugLog('事件處理器設定完成');
              
          } catch (error) {
              debugLog('初始化失敗', error);
              showNotification('系統初始化失敗，請重新載入頁面', 'error');
          }
      }

      // 顯示用戶資訊
      function displayUserInfo(user) {
          document.getElementById('userName').textContent = user.displayName;
          document.getElementById('userId').textContent = user.userId;
          document.getElementById('userInfo').style.display = 'block';
      }

      // 更新繳費方式選項
      function updatePaymentMethods(methods) {
          if (!methods) return;
          
          const select = document.getElementById('paymentMethod');
          if (select) {
              // 清空現有選項（保留第一個預設選項）
              while (select.children.length > 1) {
                  select.removeChild(select.lastChild);
              }
              
              // 添加新選項
              methods.forEach(method => {
                  const option = document.createElement('option');
                  option.value = method.id;
                  option.textContent = method.name;
                  select.appendChild(option);
              });
              
              debugLog('繳費方式選項已更新', methods);
          }
      }

      // 更新檔案上傳設定
      function updateFileUploadSettings(settings) {
          if (!settings) return;
          
          // 更新檔案大小限制和類型限制
          window.fileUploadSettings = settings;
          debugLog('檔案上傳設定已更新', settings);
      }

      // 套用系統設定
      function applySystemConfig(config) {
          if (config.basic) {
              // 可以在這裡更新頁面標題等
              if (config.basic.systemName) {
                  document.title = config.basic.systemName;
              }
          }
          debugLog('系統設定已套用', config);
      }

      // 設定事件處理器
      function setupEventHandlers() {
          // 登記表單提交
          document.getElementById('registrationForm').addEventListener('submit', handleRegistration);
          
          // 繳費表單提交
          document.getElementById('paymentForm').addEventListener('submit', handlePaymentSubmission);
          
          // 檔案上傳處理
          const fileInput = document.getElementById('paymentProof');
          fileInput.addEventListener('change', handleFileSelection);
          
          // 拖拽上傳
          const fileUpload = document.querySelector('.file-upload');
          fileUpload.addEventListener('dragover', handleDragOver);
          fileUpload.addEventListener('dragleave', handleDragLeave);
          fileUpload.addEventListener('drop', handleFileDrop);
          
          // 全域錯誤處理
          window.addEventListener('error', (event) => {
              debugLog('全域錯誤', event.error);
          });
      }

      // 處理用戶登記
      async function handleRegistration(event) {
          event.preventDefault();
          
          try {
              debugLog('處理用戶登記');
              
              const formData = new FormData(event.target);
              const registrationData = {
                  userId: currentUser.userId,
                  realName: formData.get('realName'),
                  phone: formData.get('phone'),
                  email: formData.get('email'),
                  address: formData.get('address'),
                  emergencyContact: formData.get('emergencyContact'),
                  emergencyPhone: formData.get('emergencyPhone')
              };
              
              showLoading('處理登記中...');
              
              const result = await callAPI('register', registrationData);
              
              hideLoading();
              
              if (result.success) {
                  showNotification('登記成功！', 'success');
                  debugLog('用戶登記成功', result);
                  
                  // 載入用戶訂單
                  debugLog('載入用戶訂單');
                  await loadUserOrders();
                  showSection('ordersSection');
              } else {
                  showNotification(result.message || '登記失敗', 'error');
              }
              
          } catch (error) {
              hideLoading();
              debugLog('登記處理失敗', error);
              showNotification('登記時發生錯誤', 'error');
          }
      }

      // 載入用戶訂單
      async function loadUserOrders() {
          try {
              const result = await callAPI('orders', { userId: currentUser.userId });
              
              if (result.success) {
                  displayOrders(result.orders);
                  updateOrderOptions(result.orders);
                  debugLog('訂單載入成功', result);
              } else {
                  showNotification(result.message || '載入訂單失敗', 'error');
              }
              
          } catch (error) {
              debugLog('載入訂單失敗', error);
              showNotification('載入訂單時發生錯誤', 'error');
          }
      }

      // 顯示訂單列表
      function displayOrders(orders) {
          const container = document.getElementById('ordersList');
          
          if (!orders || orders.length === 0) {
              container.innerHTML = `
                  <div class="empty-state">
                      <p>目前沒有訂單資料</p>
                  </div>
              `;
              return;
          }
          
          const html = orders.map(order => `
              <div class="order-item">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                      <h4>訂單 ${order.id}</h4>
                      <span class="order-status status-${order.status}">
                          ${getStatusText(order.status)}
                      </span>
                  </div>
                  <p><strong>商品：</strong>${order.productName}</p>
                  <p><strong>金額：</strong>${formatCurrency(order.amount)}</p>
                  <p><strong>建立時間：</strong>${formatDateTime(order.createdAt)}</p>
                  ${order.dueDate ? `<p><strong>繳費期限：</strong>${formatDateTime(order.dueDate)}</p>` : ''}
                  ${order.paidAt ? `<p><strong>繳費時間：</strong>${formatDateTime(order.paidAt)}</p>` : ''}
              </div>
          `).join('');
          
          container.innerHTML = html;
      }

      // 更新訂單選項
      function updateOrderOptions(orders) {
          const select = document.getElementById('orderId');
          if (!select) return;
          
          // 清空現有選項（保留第一個預設選項）
          while (select.children.length > 1) {
              select.removeChild(select.lastChild);
          }
          
          // 只顯示未付款的訂單
          const unpaidOrders = orders.filter(order => order.status === 'pending');
          
          unpaidOrders.forEach(order => {
              const option = document.createElement('option');
              option.value = order.id;
              option.textContent = `${order.id} - ${order.productName} (${formatCurrency(order.amount)})`;
              select.appendChild(option);
          });
      }

      // 取得狀態文字
      function getStatusText(status) {
          const statusMap = {
              'pending': '待繳費',
              'paid': '已繳費',
              'processing': '處理中',
              'completed': '已完成',
              'cancelled': '已取消'
          };
          return statusMap[status] || status;
      }

      // 處理繳費證明提交
      async function handlePaymentSubmission(event) {
          event.preventDefault();
          
          try {
              debugLog('提交繳費證明');
              
              const formData = new FormData(event.target);
              const fileInput = document.getElementById('paymentProof');
              
              if (!fileInput.files[0]) {
                  showNotification('請選擇繳費證明檔案', 'error');
                  return;
              }
              
              // 驗證檔案
              const validationResult = validateFile(fileInput.files[0]);
              if (!validationResult.valid) {
                  showNotification(validationResult.message, 'error');
                  return;
              }
              
              showLoading('提交繳費證明中...');
              
              // 模擬檔案上傳（實際應用中需要上傳到伺服器）
              const fileData = await readFileAsBase64(fileInput.files[0]);
              
              const paymentData = {
                  userId: currentUser.userId,
                  orderId: formData.get('orderId'),
                  paymentMethod: formData.get('paymentMethod'),
                  amount: parseInt(formData.get('paymentAmount')),
                  paymentDate: formData.get('paymentDate'),
                  note: formData.get('paymentNote'),
                  proofFile: {
                      name: fileInput.files[0].name,
                      type: fileInput.files[0].type,
                      size: fileInput.files[0].size,
                      data: fileData
                  }
              };
              
              const result = await callAPI('submit-payment', paymentData);
              
              hideLoading();
              
              if (result.success) {
                  showNotification('繳費證明提交成功！', 'success');
                  debugLog('繳費證明提交成功');
                  
                  // 清空表單
                  event.target.reset();
                  document.getElementById('filePreview').innerHTML = '';
                  
                  // 重新載入訂單
                  await loadUserOrders();
                  showSection('ordersSection');
              } else {
                  showNotification(result.message || '提交失敗', 'error');
              }
              
          } catch (error) {
              hideLoading();
              debugLog('提交繳費證明失敗', error);
              showNotification('提交時發生錯誤', 'error');
          }
      }

      // 檔案選擇處理
      function handleFileSelection(event) {
          const file = event.target.files[0];
          if (file) {
              const validationResult = validateFile(file);
              if (validationResult.valid) {
                  debugLog('檔案驗證通過', validationResult);
                  previewFile(file);
              } else {
                  showNotification(validationResult.message, 'error');
                  event.target.value = '';
              }
          }
      }

      // 驗證檔案
      function validateFile(file) {
          const settings = window.fileUploadSettings || {
              maxSize: 5242880, // 5MB
              allowedTypes: ['image/jpeg', 'image/png', 'application/pdf']
          };
          
          if (file.size > settings.maxSize) {
              return {
                  valid: false,
                  message: `檔案大小不能超過 ${(settings.maxSize / 1024 / 1024).toFixed(1)}MB`
              };
          }
          
          if (!settings.allowedTypes.includes(file.type)) {
              return {
                  valid: false,
                  message: '不支援的檔案格式，請上傳 JPG、PNG 或 PDF 檔案'
              };
          }
          
          return { valid: true };
      }

      // 預覽檔案
      function previewFile(file) {
          const preview = document.getElementById('filePreview');
          preview.innerHTML = '';
          
          if (file.type.startsWith('image/')) {
              const img = document.createElement('img');
              img.src = URL.createObjectURL(file);
              img.className = 'image-preview';
              img.onload = () => URL.revokeObjectURL(img.src);
              preview.appendChild(img);
          }
          
          const fileInfo = document.createElement('div');
          fileInfo.innerHTML = `
              <p><strong>檔案名稱：</strong>${file.name}</p>
              <p><strong>檔案大小：</strong>${(file.size / 1024).toFixed(1)} KB</p>
              <p><strong>檔案類型：</strong>${file.type}</p>
          `;
          preview.appendChild(fileInfo);
      }

      // 讀取檔案為 Base64
      function readFileAsBase64(file) {
          return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsDataURL(file);
          });
      }

      // 拖拽處理
      function handleDragOver(event) {
          event.preventDefault();
          event.currentTarget.classList.add('dragover');
      }

      function handleDragLeave(event) {
          event.currentTarget.classList.remove('dragover');
      }

      function handleFileDrop(event) {
          event.preventDefault();
          event.currentTarget.classList.remove('dragover');
          
          const files = event.dataTransfer.files;
          if (files.length > 0) {
              const fileInput = document.getElementById('paymentProof');
              fileInput.files = files;
              handleFileSelection({ target: fileInput });
          }
      }

      // ==================== 管理員功能 ====================

      // 載入繳費記錄
      async function loadPaymentRecords() {
          try {
              if (!isAdmin) {
                  showNotification('沒有權限執行此操作', 'error');
                  return;
              }
              
              showLoading('載入繳費記錄中...');
              
              const result = await callAPI('get-payment-records', {
                  userId: currentUser.userId
              });
              
              hideLoading();
              
              if (result.success) {
                  allPaymentRecords = result.records;
                  displayPaymentRecords(allPaymentRecords);
                  debugLog('繳費記錄載入成功', result);
              } else {
                  showNotification(result.message || '載入繳費記錄失敗', 'error');
              }
              
          } catch (error) {
              hideLoading();
              debugLog('載入繳費記錄失敗', error);
              showNotification('載入繳費記錄時發生錯誤', 'error');
          }
      }

      // 顯示繳費記錄
      function displayPaymentRecords(records) {
          const container = document.getElementById('paymentRecordsList');
          
          if (!records || records.length === 0) {
              container.innerHTML = `
                  <div class="empty-state">
                      <p>目前沒有繳費記錄</p>
                  </div>
              `;
              return;
          }
          
          const html = records.map(record => `
              <div class="payment-record">
                  <h4>繳費記錄 ${record.id}</h4>
                  <div class="payment-details">
                      <div><strong>訂單號：</strong>${record.orderId}</div>
                      <div><strong>用戶：</strong>${record.userName}</div>
                      <div><strong>金額：</strong>${formatCurrency(record.amount)}</div>
                      <div><strong>繳費方式：</strong>${record.paymentMethod}</div>
                      <div><strong>狀態：</strong>
                          <span class="order-status status-${record.status}">
                              ${getPaymentStatusText(record.status)}
                          </span>
                      </div>
                      <div><strong>提交時間：</strong>${formatDateTime(record.submittedAt)}</div>
                      ${record.approvedAt ? `<div><strong>審核時間：</strong>${formatDateTime(record.approvedAt)}</div>` : ''}
                  </div>
                  ${record.proofUrl ? `
                      <div style="margin: 10px 0;">
                          <strong>繳費證明：</strong>
                          <a href="#" onclick="viewPaymentProof('${record.proofUrl}')" class="btn btn-sm btn-outline-primary">
                              查看證明
                          </a>
                      </div>
                  ` : ''}
                  <div class="payment-actions">
                      ${record.status === 'pending' ? `
                          <button class="btn btn-sm btn-success" onclick="approvePayment('${record.id}')">
                              <i class="fas fa-check"></i> 核准
                          </button>
                          <button class="btn btn-sm btn-danger" onclick="rejectPayment('${record.id}')">
                              <i class="fas fa-times"></i> 拒絕
                          </button>
                      ` : ''}
                      <button class="btn btn-sm btn-secondary" onclick="viewPaymentDetails('${record.id}')">
                          <i class="fas fa-eye"></i> 詳細資訊
                      </button>
                  </div>
              </div>
          `).join('');
          
          container.innerHTML = html;
      }

      // 取得繳費狀態文字
      function getPaymentStatusText(status) {
          const statusMap = {
              'pending': '待審核',
              'approved': '已核准',
              'rejected': '已拒絕'
          };
          return statusMap[status] || status;
      }

      // 篩選繳費記錄
      function filterPaymentRecords() {
          const status = document.getElementById('statusFilter').value;
          const dateFrom = document.getElementById('dateFrom').value;
          const dateTo = document.getElementById('dateTo').value;
          const keyword = document.getElementById('searchKeyword').value.toLowerCase();
          
          let filteredRecords = allPaymentRecords;
          
          // 狀態篩選
          if (status) {
              filteredRecords = filteredRecords.filter(record => record.status === status);
          }
          
          // 日期篩選
          if (dateFrom) {
              filteredRecords = filteredRecords.filter(record => 
                  new Date(record.submittedAt) >= new Date(dateFrom)
              );
          }
          
          if (dateTo) {
              filteredRecords = filteredRecords.filter(record => 
                  new Date(record.submittedAt) <= new Date(dateTo + 'T23:59:59')
              );
          }
          
          // 關鍵字搜尋
          if (keyword) {
              filteredRecords = filteredRecords.filter(record => 
                  record.userName.toLowerCase().includes(keyword) ||
                  record.orderId.toLowerCase().includes(keyword)
              );
          }
          
          debugLog('篩選繳費記錄', {
              original: allPaymentRecords.length,
              filtered: filteredRecords.length,
              filters: { status, dateFrom, dateTo, keyword }
          });
          
          displayPaymentRecords(filteredRecords);
      }

      // 核准繳費
      async function approvePayment(paymentId) {
          try {
              if (!confirm('確定要核准這筆繳費嗎？')) return;
              
              showLoading('處理中...');
              
              const result = await callAPI('approve-payment', {
                  userId: currentUser.userId,
                  paymentId: paymentId
              });
              
              hideLoading();
              
              if (result.success) {
                  showNotification('繳費記錄已核准', 'success');
                  loadPaymentRecords(); // 重新載入記錄
              } else {
                  showNotification(result.message || '核准失敗', 'error');
              }
              
          } catch (error) {
              hideLoading();
              debugLog('核准繳費失敗', error);
              showNotification('核准時發生錯誤', 'error');
          }
      }

      // 拒絕繳費
      async function rejectPayment(paymentId) {
          try {
              const reason = prompt('請輸入拒絕原因：');
              if (!reason) return;
              
              showLoading('處理中...');
              
              const result = await callAPI('reject-payment', {
                  userId: currentUser.userId,
                  paymentId: paymentId,
                  reason: reason
              });
              
              hideLoading();
              
              if (result.success) {
                  showNotification('繳費記錄已拒絕', 'success');
                  loadPaymentRecords(); // 重新載入記錄
              } else {
                  showNotification(result.message || '拒絕失敗', 'error');
              }
              
          } catch (error) {
              hideLoading();
              debugLog('拒絕繳費失敗', error);
              showNotification('拒絕時發生錯誤', 'error');
          }
      }

      // 查看繳費證明
      function viewPaymentProof(proofUrl) {
          // 在實際應用中，這裡應該顯示實際的繳費證明圖片
          showNotification('查看繳費證明功能（示範模式）', 'info');
      }

      // 查看繳費詳細資訊
      function viewPaymentDetails(paymentId) {
          const record = allPaymentRecords.find(r => r.id === paymentId);
          if (record) {
              alert(`繳費詳細資訊：\n\n訂單號：${record.orderId}\n用戶：${record.userName}\n金額：${formatCurrency(record.amount)}\n狀態：${getPaymentStatusText(record.status)}\n提交時間：${formatDateTime(record.submittedAt)}`);
          }
      }

      // ==================== 頁面載入事件 ====================
      
      // 當頁面載入完成時初始化應用程式
      if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initializeApp);
      } else {
          initializeApp();
      }

      // 檢查管理員權限並顯示管理員面板
      function checkAdminAccess() {
          if (isAdmin) {
              // 在訂單區域添加管理員按鈕
              const ordersSection = document.getElementById('ordersSection');
              if (ordersSection && !document.getElementById('adminButton')) {
                  const adminButton = document.createElement('button');
                  adminButton.id = 'adminButton';
                  adminButton.className = 'btn btn-warning';
                  adminButton.innerHTML = '<i class="fas fa-cog"></i> 管理員面板';
                  adminButton.onclick = () => {
                      loadPaymentRecords();
                      loadAdminList();
                      showSection('adminSection');
                  };
                  ordersSection.appendChild(adminButton);
              }
          }
      }

      // 在載入訂單後檢查管理員權限
      async function loadUserOrdersWithAdminCheck() {
          await loadUserOrders();
          checkAdminAccess();
      }

      // 替換原本的 loadUserOrders 調用
      // 在 handleRegistration 函數中
      // 將 await loadUserOrders(); 替換為 await loadUserOrdersWithAdminCheck();

  </script>
</body>
</html>
              
