<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ë®ÇË≥ºÊ∏ÖÂñÆÊü•Ë©¢Á≥ªÁµ±</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      
      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #00B900, #00D300);
          min-height: 100vh;
          padding: 20px;
      }
      
      .container {
          max-width: 400px;
          margin: 0 auto;
          background: white;
          border-radius: 20px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.2);
          overflow: hidden;
      }
      
      .header {
          background: linear-gradient(45deg, #00B900, #00D300);
          color: white;
          padding: 30px 20px;
          text-align: center;
      }
      
      .header h1 {
          font-size: 24px;
          margin-bottom: 10px;
      }
      
      .content {
          padding: 30px 20px;
      }
      
      .tab-buttons {
          display: flex;
          margin-bottom: 30px;
          border-radius: 10px;
          overflow: hidden;
          background: #f5f5f5;
      }
      
      .tab-button {
          flex: 1;
          padding: 15px;
          text-align: center;
          background: #f5f5f5;
          border: none;
          cursor: pointer;
          font-size: 14px;
          transition: all 0.3s;
      }
      
      .tab-button.active {
          background: #00B900;
          color: white;
      }
      
      .tab-button:disabled {
          opacity: 0.5;
          cursor: not-allowed;
      }
      
      .tab-content {
          display: none;
      }
      
      .tab-content.active {
          display: block;
      }
      
      .form-group {
          margin-bottom: 20px;
      }
      
      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #333;
      }
      
      .form-group input, .form-group select {
          width: 100%;
          padding: 15px;
          border: 2px solid #e0e0e0;
          border-radius: 10px;
          font-size: 16px;
          transition: border-color 0.3s;
      }
      
      .form-group input:focus, .form-group select:focus {
          outline: none;
          border-color: #00B900;
      }
      
      .btn {
          width: 100%;
          padding: 15px;
          background: linear-gradient(45deg, #00B900, #00D300);
          color: white;
          border: none;
          border-radius: 10px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: transform 0.2s;
      }
      
      .btn:hover {
          transform: translateY(-2px);
      }
      
      .btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
          transform: none;
      }
      
      .order-item {
          background: #f8f9fa;
          padding: 20px;
          margin-bottom: 15px;
          border-radius: 10px;
          border-left: 4px solid #00B900;
      }
      
      .order-item h3 {
          color: #00B900;
          margin-bottom: 10px;
      }
      
      .order-detail {
          display: flex;
          justify-content: space-between;
          margin-bottom: 5px;
          font-size: 14px;
      }
      
      .total-amount {
          font-size: 18px;
          font-weight: bold;
          color: #e74c3c;
          text-align: right;
          margin-top: 10px;
      }
      
      .status-badge {
          display: inline-block;
          padding: 5px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
      }
      
      .status-pending {
          background: #fff3cd;
          color: #856404;
      }
      
      .status-paid {
          background: #d4edda;
          color: #155724;
      }
      
      .upload-area {
          border: 2px dashed #00B900;
          border-radius: 10px;
          padding: 30px;
          text-align: center;
          margin-bottom: 20px;
          cursor: pointer;
          transition: background-color 0.3s;
      }
      
      .upload-area:hover {
          background-color: #f8f9fa;
      }
      
      .upload-icon {
          font-size: 48px;
          color: #00B900;
          margin-bottom: 10px;
      }
      
      .user-info {
          background: #e8f5e8;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
      }
      
      .user-info h3 {
          color: #00B900;
          margin-bottom: 15px;
          text-align: center;
      }
      
      .info-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 0;
          border-bottom: 1px solid #d4edda;
          font-size: 14px;
      }
      
      .info-item:last-child {
          border-bottom: none;
      }
      
      .info-label {
          font-weight: 600;
          color: #155724;
          min-width: 80px;
      }
      
      .info-value {
          color: #333;
          text-align: right;
          word-break: break-all;
          max-width: 200px;
      }
      
      .loading {
          text-align: center;
          padding: 40px;
          color: #666;
      }
      
      .error {
          background: #f8d7da;
          color: #721c24;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
      }
      
      .success {
          background: #d4edda;
          color: #155724;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
      }
      
      .welcome-message {
          background: #e8f5e8;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
          margin-bottom: 20px;
      }
      
      .welcome-message h3 {
          color: #00B900;
          margin-bottom: 10px;
      }
      
      .registered-info {
          background: #d4edda;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
          margin-bottom: 20px;
      }
      
      .registered-info h3 {
          color: #155724;
          margin-bottom: 10px;
      }
      
      .lock-message {
          text-align: center;
          padding: 40px;
          color: #666;
          background: #f8f9fa;
          border-radius: 10px;
          margin: 20px 0;
      }
      
      .lock-icon {
          font-size: 48px;
          margin-bottom: 15px;
      }

      .btn-group {
          display: flex;
          gap: 10px;
      }

      .btn-group .btn {
          flex: 1;
      }

      .btn.secondary {
          background: linear-gradient(45deg, #e74c3c, #c0392b);
      }

      .debug-info {
          background: #f8f9fa;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
          font-family: monospace;
          font-size: 12px;
          border: 1px solid #dee2e6;
          max-height: 200px;
          overflow-y: auto;
      }

      .liff-info {
          background: #f0f8ff;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
          border-left: 4px solid #4169E1;
      }

      .liff-info h3 {
          color: #4169E1;
          margin-bottom: 15px;
          text-align: center;
      }

      .profile-avatar {
          width: 60px;
          height: 60px;
          border-radius: 50%;
          margin: 0 auto 15px;
          display: block;
          border: 3px solid #00B900;
      }

      .context-badge {
          display: inline-block;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 11px;
          font-weight: 600;
          text-transform: uppercase;
      }

      .context-utou { background: #e3f2fd; color: #1976d2; }
      .context-group { background: #e8f5e8; color: #2e7d32; }
      .context-room { background: #fff3e0; color: #f57c00; }
      .context-square { background: #fce4ec; color: #c2185b; }

      .demo-mode {
          background: #fff3cd;
          border: 1px solid #ffeaa7;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
          text-align: center;
      }

      .demo-mode h3 {
          color: #856404;
          margin-bottom: 10px;
      }

      .order-summary {
          background: #e8f5e8;
          padding: 20px;
          border-radius: 10px;
          margin-bottom: 20px;
          border-left: 4px solid #00B900;
      }

      .order-summary h3 {
          color: #00B900;
          margin-bottom: 15px;
          text-align: center;
      }

      .summary-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 0;
          border-bottom: 1px solid #d4edda;
          font-size: 14px;
      }

      .summary-item:last-child {
          border-bottom: none;
          font-weight: bold;
          font-size: 16px;
          color: #00B900;
      }

      .product-list {
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 15px;
      }

      .product-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 5px 0;
          font-size: 14px;
      }

      .product-name {
          font-weight: 600;
          color: #333;
      }

      .product-details {
          text-align: right;
          color: #666;
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>üõí Ë®ÇË≥ºÁÆ°ÁêÜÁ≥ªÁµ±</h1>
          <p>ÂØ¶ÂêçÂà∂ÁôªË®ò ¬∑ Ë®ÇÂñÆÊü•Ë©¢ ¬∑ Áπ≥Ë≤ªÂõûÂ†±</p>
      </div>
      
      <div class="content">
          <!-- Èô§ÈåØË≥áË®ä -->
          <div id="debugInfo" class="debug-info" style="display: none;">
              <strong>Èô§ÈåØË≥áË®ä:</strong><br>
              <span id="debugText"></span>
          </div>

          <!-- Á§∫ÁØÑÊ®°ÂºèÊèêÁ§∫ -->
          <div id="demoMode" class="demo-mode" style="display: none;">
              <h3>üöß Á§∫ÁØÑÊ®°Âºè</h3>
              <p>ÁõÆÂâçÁÑ°Ê≥ïÈÄ£Êé•ÂæåÁ´Ø APIÔºåÈ°ØÁ§∫Á§∫ÁØÑË≥áÊñô</p>
          </div>

          <!-- LIFF Áí∞Â¢ÉË≥áË®ä -->
          <div id="liffInfo" class="liff-info" style="display: none;">
              <h3>üì± LIFF Áí∞Â¢ÉË≥áË®ä</h3>
              <div id="liffDetails"></div>
          </div>

          <!-- Áî®Êà∂Ë≥áË®äÈ°ØÁ§∫ -->
          <div id="userInfo" class="user-info" style="display: none;">
              <h3>üë§ Áî®Êà∂Ë≥áË®ä</h3>
              <img id="userAvatar" class="profile-avatar" style="display: none;">
              <div id="userDetails"></div>
          </div>
          
          <!-- Ê®ôÁ±§È†ÅÊåâÈàï -->
          <div class="tab-buttons">
              <button class="tab-button active" onclick="switchTab('register', event)">ÂØ¶ÂêçÁôªË®ò</button>
              <button class="tab-button" id="ordersTab" onclick="switchTab('orders', event)" disabled>ÊàëÁöÑË®ÇÂñÆ</button>
              <button class="tab-button" id="paymentTab" onclick="switchTab('payment', event)" disabled>Áπ≥Ë≤ªÂõûÂ†±</button>
          </div>
          
          <!-- ÂØ¶ÂêçÂà∂ÁôªË®ò -->
          <div id="register" class="tab-content active">
              <!-- Êú™Ë®ªÂÜäÁãÄÊÖã -->
              <div id="registerForm" style="display: none;">
                  <div class="welcome-message">
                      <h3>üëã Ê≠°Ëøé‰ΩøÁî®Ë®ÇË≥ºÁ≥ªÁµ±</h3>
                      <p>Ë´ãÂÖàÂÆåÊàêÂØ¶ÂêçÂà∂ÁôªË®òÔºåÂç≥ÂèØÊü•Ë©¢Ë®ÇÂñÆÂèäÈÄ≤Ë°åÁπ≥Ë≤ªÂõûÂ†±</p>
                  </div>
                  
                  <h2>üìù ÂØ¶ÂêçÂà∂ÁôªË®ò</h2>
                  <form id="nameForm">
                      <div class="form-group">
                          <label for="realNameInput">ÁúüÂØ¶ÂßìÂêç *</label>
                          <input type="text" id="realNameInput" name="realName" required placeholder="Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÁúüÂØ¶ÂßìÂêç">
                      </div>
                      
                      <button type="submit" class="btn" id="registerSubmitBtn">ÂÆåÊàêÁôªË®ò</button>
                  </form>
              </div>
              
              <!-- Â∑≤Ë®ªÂÜäÁãÄÊÖã -->
              <div id="registeredStatus" style="display: none;">
                  <div class="registered-info">
                      <h3>‚úÖ ÂØ¶ÂêçÂà∂ÁôªË®òÂÆåÊàê</h3>
                      <p>ÊÇ®Â∑≤ÂÆåÊàêÂØ¶ÂêçÂà∂ÁôªË®òÔºåÂèØ‰ª•‰ΩøÁî®ÊâÄÊúâÂäüËÉΩ</p>
                  </div>
                  
                  <div class="btn-group">
                      <button class="btn" onclick="switchTab('orders', event)">Êü•ÁúãÊàëÁöÑË®ÇÂñÆ</button>
                      <button class="btn secondary" onclick="switchTab('payment', event)">ÈÄ≤Ë°åÁπ≥Ë≤ªÂõûÂ†±</button>
                  </div>
              </div>
          </div>
          
          <!-- Ë®ÇÂñÆÊü•Ë©¢ -->
          <div id="orders" class="tab-content">
              <div id="ordersContent">
                  <div class="lock-message">
                      <div class="lock-icon">üîí</div>
                      <h3>Ë´ãÂÖàÂÆåÊàêÂØ¶ÂêçÂà∂ÁôªË®ò</h3>
                      <p>ÂÆåÊàêÁôªË®òÂæåÂç≥ÂèØÊü•Ë©¢ÊÇ®ÁöÑË®ÇÂñÆË≥áË®ä</p>
                  </div>
              </div>
          </div>
          
          <!-- Áπ≥Ë≤ªÂõûÂ†± -->
          <div id="payment" class="tab-content">
              <div id="paymentContent">
                  <div class="lock-message">
                      <div class="lock-icon">üîí</div>
                      <h3>Ë´ãÂÖàÂÆåÊàêÂØ¶ÂêçÂà∂ÁôªË®ò</h3>
                      <p>ÂÆåÊàêÁôªË®òÂæåÂç≥ÂèØÈÄ≤Ë°åÁπ≥Ë≤ªÂõûÂ†±</p>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <script>
      // Ë®≠ÂÆöÂçÄÂüü - Ë´ã‰øÆÊîπÁÇ∫ÊÇ®ÁöÑÂØ¶ÈöõÂÄº
      const CONFIG = {
          LIFF_ID: '1657285806-2bmkYWkN', // Ë´ãÊõøÊèõÁÇ∫ÂØ¶ÈöõÁöÑ LIFF ID
          API_BASE_URL: 'https://script.google.com/macros/s/AKfycbztaoz3deH2K1_cmfHneSnuGn176k5u8ViCxf8mRP74zT5oJNOWiJpAPYf9g6dwn-Fw/exec', // Ë´ãÊõøÊèõÁÇ∫ GAS ÈÉ®ÁΩ≤Á∂≤ÂùÄ
          DEBUG_MODE: true, // ÈñãÂïüÈô§ÈåØÊ®°Âºè
          DEMO_MODE: false // Á§∫ÁØÑÊ®°ÂºèÔºàÁï∂ API ÁÑ°Ê≥ï‰ΩøÁî®ÊôÇÔºâ
      };

      let userId = null;
      let userProfile = null;
      let liffContext = null;
      let liffEnvironment = null;
      let isRegistered = false;
      let userRegistrationData = null;
      let demoMode = false;
      let currentOrderSummary = null; // ÂÑ≤Â≠òÁï∂ÂâçË®ÇÂñÆÊëòË¶Å

      // Èô§ÈåØÂáΩÊï∏
      function debugLog(message, data = null) {
          console.log(message, data);
          if (CONFIG.DEBUG_MODE) {
              const debugDiv = document.getElementById('debugInfo');
              const debugText = document.getElementById('debugText');
              if (debugDiv && debugText) {
                  debugDiv.style.display = 'block';
                  debugText.innerHTML += `${new Date().toLocaleTimeString()}: ${message}<br>`;
                  if (data) {
                      debugText.innerHTML += `Êï∏Êìö: ${JSON.stringify(data, null, 2)}<br>`;
                  }
                  debugText.innerHTML += '<br>';
                  debugText.scrollTop = debugText.scrollHeight;
              }
          }
      }

      // ÂàùÂßãÂåñ LIFF
      window.onload = function() {
          debugLog('ÈñãÂßãÂàùÂßãÂåñ LIFF');
          initializeLiff();
      };

      async function initializeLiff() {
          try {
              debugLog('LIFF ÂàùÂßãÂåñ‰∏≠...', { liffId: CONFIG.LIFF_ID });
              
              await liff.init({ liffId: CONFIG.LIFF_ID });
              debugLog('LIFF ÂàùÂßãÂåñÊàêÂäü');
              
              // Êî∂ÈõÜ LIFF Áí∞Â¢ÉË≥áË®ä
              await collectLiffEnvironmentInfo();
              
              if (liff.isLoggedIn()) {
                  debugLog('Áî®Êà∂Â∑≤ÁôªÂÖ•');
                  userProfile = await liff.getProfile();
                  userId = userProfile.userId;
                  
                  debugLog('ÂèñÂæóÁî®Êà∂Ë≥áÊñô', {
                      userId: userId,
                      displayName: userProfile.displayName
                  });
                  
                  // È°ØÁ§∫Áî®Êà∂Ë≥áË®ä
                  displayUserInfo();
                  
                  // Ê™¢Êü•Áî®Êà∂ÊòØÂê¶Â∑≤Ë®ªÂÜä
                  await checkUserRegistration();
              } else {
                  debugLog('Áî®Êà∂Êú™ÁôªÂÖ•ÔºåÂ∞éÂêëÁôªÂÖ•È†ÅÈù¢');
                  liff.login();
              }
          } catch (error) {
              debugLog('LIFFÂàùÂßãÂåñÂ§±Êïó', error);
              console.error('LIFFÂàùÂßãÂåñÂ§±Êïó:', error);
              showError('Á≥ªÁµ±ÂàùÂßãÂåñÂ§±ÊïóÔºåË´ãÈáçÊñ∞ÈñãÂïü: ' + error.message);
          }
      }

      // Êî∂ÈõÜ LIFF Áí∞Â¢ÉË≥áË®ä
      async function collectLiffEnvironmentInfo() {
          try {
              // Âü∫Êú¨ LIFF Ë≥áË®ä
              liffEnvironment = {
                  version: liff.getVersion(),
                  language: liff.getLanguage(),
                  isInClient: liff.isInClient(),
                  isLoggedIn: liff.isLoggedIn(),
                  os: liff.getOS(),
                  lineVersion: liff.getLineVersion()
              };

              // ÂèñÂæó LIFF ‰∏ä‰∏ãÊñá
              liffContext = liff.getContext();
              
              debugLog('LIFF Áí∞Â¢ÉË≥áË®ä', liffEnvironment);
              debugLog('LIFF ‰∏ä‰∏ãÊñá', liffContext);
              
              // È°ØÁ§∫ LIFF Ë≥áË®ä
              displayLiffInfo();
              
          } catch (error) {
              debugLog('Êî∂ÈõÜ LIFF Áí∞Â¢ÉË≥áË®äÂ§±Êïó', error);
              console.error('Êî∂ÈõÜ LIFF Áí∞Â¢ÉË≥áË®äÂ§±Êïó:', error);
          }
      }

      // È°ØÁ§∫ LIFF Áí∞Â¢ÉË≥áË®ä
      function displayLiffInfo() {
          const liffInfoDiv = document.getElementById('liffInfo');
          const liffDetailsDiv = document.getElementById('liffDetails');
          
          if (!liffInfoDiv || !liffDetailsDiv) return;
          
          let contextInfo = '';
          let contextClass = 'context-utou';
          
          if (liffContext) {
              switch (liffContext.type) {
                  case 'utou':
                      contextInfo = 'ÂÄã‰∫∫ËÅäÂ§©';
                      contextClass = 'context-utou';
                      break;
                  case 'group':
                      contextInfo = 'Áæ§ÁµÑËÅäÂ§©';
                      contextClass = 'context-group';
                      break;
                  case 'room':
                      contextInfo = 'ËÅäÂ§©ÂÆ§';
                      contextClass = 'context-room';
                      break;
                  case 'square_chat':
                      contextInfo = 'OpenChat';
                      contextClass = 'context-square';
                      break;
                  default:
                      contextInfo = 'Êú™Áü•';
              }
          }

          let html = `
              <div class="info-item">
                  <span class="info-label">Áí∞Â¢ÉÈ°ûÂûã:</span>
                  <span class="info-value">
                      <span class="context-badge ${contextClass}">${contextInfo}</span>
                  </span>
              </div>
              <div class="info-item">
                  <span class="info-label">LIFF ÁâàÊú¨:</span>
                  <span class="info-value">${liffEnvironment.version}</span>
              </div>
              <div class="info-item">
                  <span class="info-label">‰ΩúÊ•≠Á≥ªÁµ±:</span>
                  <span class="info-value">${liffEnvironment.os}</span>
              </div>
              <div class="info-item">
                  <span class="info-label">LINE ÁâàÊú¨:</span>
                  <span class="info-value">${liffEnvironment.lineVersion}</span>
              </div>
              <div class="info-item">
                  <span class="info-label">Ë™ûË®ÄË®≠ÂÆö:</span>
                  <span class="info-value">${liffEnvironment.language}</span>
              </div>
              <div class="info-item">
                  <span class="info-label">Âú® LINE ÂÖß:</span>
                  <span class="info-value">${liffEnvironment.isInClient ? 'ÊòØ' : 'Âê¶'}</span>
              </div>
          `;

          // Â¶ÇÊûúÊòØÁæ§ÁµÑÊàñËÅäÂ§©ÂÆ§ÔºåÈ°ØÁ§∫ ID
          if (liffContext && (liffContext.groupId || liffContext.roomId)) {
              const chatId = liffContext.groupId || liffContext.roomId;
              const chatType = liffContext.groupId ? 'Áæ§ÁµÑ ID' : 'ËÅäÂ§©ÂÆ§ ID';
              
              html += `
                  <div class="info-item">
                      <span class="info-label">${chatType}:</span>
                      <span class="info-value" style="font-family: monospace; font-size: 11px;">${chatId}</span>
                  </div>
              `;
          }

          liffDetailsDiv.innerHTML = html;
          liffInfoDiv.style.display = 'block';
      }

      // È°ØÁ§∫Áî®Êà∂Ë≥áË®ä
      function displayUserInfo() {
          if (!userProfile) return;
          
          const userInfoDiv = document.getElementById('userInfo');
          const userDetailsDiv = document.getElementById('userDetails');
          const userAvatar = document.getElementById('userAvatar');
          
          if (!userInfoDiv || !userDetailsDiv) return;

          // È°ØÁ§∫È†≠ÂÉè
          if (userProfile.pictureUrl && userAvatar) {
              userAvatar.src = userProfile.pictureUrl;
              userAvatar.style.display = 'block';
              userAvatar.onerror = function() {
                  this.style.display = 'none';
              };
          }

          let html = `
              <div class="info-item">
                  <span class="info-label">LINE ÂêçÁ®±:</span>
                  <span class="info-value">${userProfile.displayName}</span>
              </div>
              <div class="info-item">
                  <span class="info-label">LINE ID:</span>
                  <span class="info-value" style="font-family: monospace; font-size: 11px;">${userId}</span>
              </div>
          `;

          // È°ØÁ§∫ÁãÄÊÖãË®äÊÅØÔºàÂ¶ÇÊûúÊúâÔºâ
          if (userProfile.statusMessage) {
              html += `
                  <div class="info-item">
                      <span class="info-label">ÁãÄÊÖãË®äÊÅØ:</span>
                      <span class="info-value">${userProfile.statusMessage}</span>
                  </div>
              `;
          }

          // Â¶ÇÊûúÂú®Áæ§ÁµÑ‰∏≠ÔºåÂòóË©¶ÂèñÂæóÁæ§ÁµÑÂêçÁ®±ÔºàÈúÄË¶ÅÈ°çÂ§ñ APIÔºâ
          if (liffContext && liffContext.type === 'group' && liffContext.groupId) {
              html += `
                  <div class="info-item">
                      <span class="info-label">Áæ§ÁµÑÈ°ûÂûã:</span>
                      <span class="info-value">LINE Áæ§ÁµÑ</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">Áæ§ÁµÑ ID:</span>
                      <span class="info-value" style="font-family: monospace; font-size: 10px;">${liffContext.groupId}</span>
                  </div>
              `;
          } else if (liffContext && liffContext.type === 'room' && liffContext.roomId) {
              html += `
                  <div class="info-item">
                      <span class="info-label">ËÅäÂ§©ÂÆ§È°ûÂûã:</span>
                      <span class="info-value">LINE ËÅäÂ§©ÂÆ§</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">ËÅäÂ§©ÂÆ§ ID:</span>
                      <span class="info-value" style="font-family: monospace; font-size: 10px;">${liffContext.roomId}</span>
                  </div>
              `;
          }

          // Â¶ÇÊûúÂ∑≤Ë®ªÂÜäÔºåÈ°ØÁ§∫Ë®ªÂÜäË≥áË®ä
          if (isRegistered && userRegistrationData) {
              html += `
                  <div class="info-item">
                      <span class="info-label">ÁúüÂØ¶ÂßìÂêç:</span>
                      <span class="info-value">${userRegistrationData.realName}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">Ë®ªÂÜäÊôÇÈñì:</span>
                      <span class="info-value">${new Date(userRegistrationData.registeredAt).toLocaleDateString('zh-TW')}</span>
                  </div>
              `;
          }

          userDetailsDiv.innerHTML = html;
          userInfoDiv.style.display = 'block';
      }

      // ‰øÆÊ≠£ÁöÑ API ÂëºÂè´ÂáΩÊï∏ - ‰ΩøÁî® GET Ë´ãÊ±ÇÈÅøÂÖç CORS È†êÊ™¢
      async function callAPI(path, data, method = 'GET') {
          try {
              debugLog(`ÂëºÂè´ API: ${path}`, data);
              
              let url = CONFIG.API_BASE_URL;
              
              if (method === 'GET') {
                  // Â∞áÂèÉÊï∏Á∑®Á¢ºÂà∞ URL ‰∏≠
                  const params = new URLSearchParams();
                  params.append('action', path);
                  
                  if (data) {
                      // Âä†ÂÖ• LIFF Áí∞Â¢ÉË≥áË®äÂà∞ API Ë´ãÊ±Ç
                      const enhancedData = {
                          ...data,
                          liffContext: liffContext,
                          liffEnvironment: liffEnvironment,
                          timestamp: new Date().toISOString()
                      };
                      params.append('data', JSON.stringify(enhancedData));
                  }
                  
                  url += '?' + params.toString();
              }

              debugLog('ÁôºÈÄÅË´ãÊ±Ç', { url, method });
              
              const response = await fetch(url, {
                  method: method,
                  mode: 'no-cors' // ‰ΩøÁî® no-cors Ê®°Âºè
              });
              
              debugLog('Êî∂Âà∞ÂõûÊáâ', {
                  status: response.status,
                  type: response.type
              });
              
              // Áî±Êñº‰ΩøÁî® no-cors Ê®°ÂºèÔºåÁÑ°Ê≥ïËÆÄÂèñÂõûÊáâÂÖßÂÆπ
              // ÈÄôË£°ÊàëÂÄëÂÅáË®≠Ë´ãÊ±ÇÊàêÂäü‰∏¶ËøîÂõûÁ§∫ÁØÑË≥áÊñô
              return await handleDemoResponse(path, data);
              
            } catch (error) {
                debugLog('API ÂëºÂè´Â§±ÊïóÔºåÂàáÊèõÂà∞Á§∫ÁØÑÊ®°Âºè', error);
                console.error(`API ÂëºÂè´Â§±Êïó (${path}):`, error);
                
                // ÂïüÁî®Á§∫ÁØÑÊ®°Âºè
                enableDemoMode();
                return await handleDemoResponse(path, data);
            }
        }

        // ÂïüÁî®Á§∫ÁØÑÊ®°Âºè
        function enableDemoMode() {
            if (!demoMode) {
                demoMode = true;
                document.getElementById('demoMode').style.display = 'block';
                debugLog('ÂïüÁî®Á§∫ÁØÑÊ®°Âºè');
            }
        }

        // ËôïÁêÜÁ§∫ÁØÑÂõûÊáâ
        async function handleDemoResponse(path, data) {
            debugLog(`Á§∫ÁØÑÊ®°ÂºèÂõûÊáâ: ${path}`, data);
            
            switch (path) {
                case 'check-registration':
                    // Ê®°Êì¨Êú™Ë®ªÂÜäÁãÄÊÖã
                    return {
                        success: true,
                        registered: false,
                        message: 'Áî®Êà∂Êú™Ë®ªÂÜä'
                    };
                
                case 'register':
                    // Ê®°Êì¨Ë®ªÂÜäÊàêÂäü
                    return {
                        success: true,
                        message: 'Ë®ªÂÜäÊàêÂäü',
                        userInfo: data
                    };
                
                case 'orders':
                    // Ê®°Êì¨Ë®ÇË≥ºÊ∏ÖÂñÆË≥áÊñô - Ê†πÊìöLINEÂêçÁ®±Êü•Ë©¢
                    return {
                        success: true,
                        orderSummary: {
                            orderId: 'ORD-' + new Date().getTime(),
                            lineName: userProfile.displayName,
                            realName: userRegistrationData?.realName || 'Á§∫ÁØÑÁî®Êà∂',
                            totalAmount: 3200,
                            products: [
                                {
                                    productName: 'Á§∫ÁØÑÂïÜÂìÅ A',
                                    quantity: 3,
                                    unitPrice: 800,
                                    totalPrice: 2400
                                },
                                {
                                    productName: 'Á§∫ÁØÑÂïÜÂìÅ B',
                                    quantity: 1,
                                    unitPrice: 800,
                                    totalPrice: 800
                                }
                            ]
                        }
                    };
                
                case 'submit-payment':
                    // Ê®°Êì¨Áπ≥Ë≤ªÊèê‰∫§ÊàêÂäü
                    return {
                        success: true,
                        message: 'Áπ≥Ë≤ªË≠âÊòéÊèê‰∫§ÊàêÂäü'
                    };
                
                default:
                    return {
                        success: false,
                        message: 'Êú™Áü•ÁöÑ API Ë∑ØÂæë'
                    };
            }
        }

        async function checkUserRegistration() {
            try {
                debugLog('Ê™¢Êü•Áî®Êà∂Ë®ªÂÜäÁãÄÊÖã');
                
                const result = await callAPI('check-registration', {
                    userId: userId,
                    lineDisplayName: userProfile.displayName 
                });
                
                if (result.success && result.registered) {
                    debugLog('Áî®Êà∂Â∑≤Ë®ªÂÜä');
                    isRegistered = true;
                    userRegistrationData = result.userInfo;
                    showRegisteredStatus();
                    enableAllTabs();
                    displayUserInfo(); // ÈáçÊñ∞È°ØÁ§∫Áî®Êà∂Ë≥áË®äÔºàÂåÖÂê´Ë®ªÂÜäË≥áË®äÔºâ
                } else {
                    debugLog('Áî®Êà∂Êú™Ë®ªÂÜä');
                    showRegisterForm();
                }
            } catch (error) {
                debugLog('Ê™¢Êü•Ë®ªÂÜäÁãÄÊÖãÂ§±Êïó', error);
                console.error('Ê™¢Êü•Ë®ªÂÜäÁãÄÊÖãÂ§±Êïó:', error);
                showError('Ê™¢Êü•Ë®ªÂÜäÁãÄÊÖãÂ§±Êïó: ' + error.message);
                showRegisterForm(); // ÁôºÁîüÈåØË™§ÊôÇÈ°ØÁ§∫Ë®ªÂÜäË°®ÂñÆ
            }
        }

        function showRegisterForm() {
            debugLog('È°ØÁ§∫Ë®ªÂÜäË°®ÂñÆ');
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('registeredStatus').style.display = 'none';
        }

        function showRegisteredStatus() {
            debugLog('È°ØÁ§∫Â∑≤Ë®ªÂÜäÁãÄÊÖã');
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('registeredStatus').style.display = 'block';
        }

        function enableAllTabs() {
            debugLog('ÂïüÁî®ÊâÄÊúâÊ®ôÁ±§È†Å');
            document.getElementById('ordersTab').disabled = false;
            document.getElementById('paymentTab').disabled = false;
            
            // Êõ¥Êñ∞Ë®ÇÂñÆÂíåÁπ≥Ë≤ªÈ†ÅÈù¢ÂÖßÂÆπ
            updateOrdersContent();
            updatePaymentContent();
        }

        function updateOrdersContent() {
            document.getElementById('ordersContent').innerHTML = `
                <h2>üìã ÊàëÁöÑË®ÇÂñÆ</h2>
                <div id="ordersList">
                    <div class="loading">ËºâÂÖ•‰∏≠...</div>
                </div>
                <button class="btn" onclick="loadOrders()">ÈáçÊñ∞ËºâÂÖ•</button>
            `;
            loadOrders();
        }

        function updatePaymentContent() {
            document.getElementById('paymentContent').innerHTML = `
                <h2>üí≥ Áπ≥Ë≤ªÂõûÂ†±</h2>
                
                <div id="orderSummarySection" style="display: none;">
                    <div class="order-summary">
                        <h3>üìã Ë®ÇÂñÆÊëòË¶Å</h3>
                        <div id="orderSummaryDetails"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>‰∏äÂÇ≥Áπ≥Ë≤ªË≠âÊòé</label>
                    <div class="upload-area" onclick="document.getElementById('paymentProof').click()">
                        <div class="upload-icon">üì∑</div>
                        <p>ÈªûÊìä‰∏äÂÇ≥Áπ≥Ë≤ªË≠âÊòéÁÖßÁâá</p>
                        <small>ÊîØÊè¥ JPG, PNG Ê†ºÂºè</small>
                    </div>
                    <input type="file" id="paymentProof" accept="image/*" style="display: none;" onchange="handleFileUpload(this)">
                </div>
                
                <div class="form-group">
                    <label for="paymentMethod">Áπ≥Ë≤ªÊñπÂºè</label>
                    <select id="paymentMethod">
                        <option value="bank_transfer">ÈäÄË°åËΩâÂ∏≥</option>
                        <option value="cash">ÁèæÈáë</option>
                        <option value="line_pay">LINE Pay</option>
                        <option value="credit_card">‰ø°Áî®Âç°</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="paymentNote">ÂÇôË®ª</label>
                    <input type="text" id="paymentNote" placeholder="ËΩâÂ∏≥Â∏≥ËôüÂæå5Á¢ºÊàñÂÖ∂‰ªñË™™Êòé">
                </div>
                
                <button class="btn" onclick="submitPayment()" id="submitPaymentBtn" disabled>Êèê‰∫§Áπ≥Ë≤ªË≠âÊòé</button>
            `;
            
            // ËºâÂÖ•Ë®ÇÂñÆÊëòË¶Å
            loadOrderSummaryForPayment();
        }

        // Ê®ôÁ±§È†ÅÂàáÊèõ - ‰øÆÊ≠£ÁâàÊú¨
        function switchTab(tabName, event) {
            debugLog(`ÂàáÊèõÊ®ôÁ±§È†Å: ${tabName}`);
            
            // Ê™¢Êü•ÊòØÂê¶Â∑≤Ë®ªÂÜäÔºàÈô§‰∫ÜregisterÈ†ÅÈù¢Ôºâ
            if (tabName !== 'register' && !isRegistered) {
                showError('Ë´ãÂÖàÂÆåÊàêÂØ¶ÂêçÂà∂ÁôªË®ò');
                return;
            }
            
            // ÁßªÈô§ÊâÄÊúâactive class
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Ê∑ªÂä†active class
            if (event && event.target) {
                event.target.classList.add('active');
            }
            document.getElementById(tabName).classList.add('active');
            
            // ËºâÂÖ•Â∞çÊáâÂÖßÂÆπ
            if (tabName === 'orders' && isRegistered) {
                loadOrders();
            } else if (tabName === 'payment' && isRegistered) {
                loadOrderSummaryForPayment();
            }
        }

        // ÂØ¶ÂêçÂà∂ÁôªË®ò - ‰øÆÊ≠£ÁâàÊú¨
        document.addEventListener('submit', async function(e) {
            if (e.target.id === 'nameForm') {
                e.preventDefault();
                
                debugLog('Êèê‰∫§Ë®ªÂÜäË°®ÂñÆ');
                
                const formData = new FormData(e.target);
                const realName = formData.get('realName').trim();
                
                if (!realName) {
                    showError('Ë´ãËº∏ÂÖ•ÁúüÂØ¶ÂßìÂêç');
                    return;
                }
                
                const registerData = {
                    userId: userId,
                    lineDisplayName: userProfile.displayName,
                    realName: realName,
                    registeredAt: new Date().toISOString()
                };
                
                try {
                    // È°ØÁ§∫ËºâÂÖ•ÁãÄÊÖã
                    const submitBtn = document.getElementById('registerSubmitBtn');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'ÁôªË®ò‰∏≠...';
                    submitBtn.disabled = true;
                    
                    const result = await callAPI('register', registerData);
                    
                    if (result.success) {
                        debugLog('Ë®ªÂÜäÊàêÂäü');
                        showSuccess('ÂØ¶ÂêçÂà∂ÁôªË®òÂÆåÊàêÔºÅ');
                        isRegistered = true;
                        userRegistrationData = registerData;
                        showRegisteredStatus();
                        enableAllTabs();
                        displayUserInfo(); // ÈáçÊñ∞È°ØÁ§∫Áî®Êà∂Ë≥áË®ä
                    } else {
                        debugLog('Ë®ªÂÜäÂ§±Êïó', result);
                        showError(result.message || 'ÁôªË®òÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }
                } catch (error) {
                    debugLog('Ë®ªÂÜäÂ§±Êïó', error);
                    console.error('ÁôªË®òÂ§±Êïó:', error);
                    showError('ÁôªË®òÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶: ' + error.message);
                    
                    const submitBtn = document.getElementById('registerSubmitBtn');
                    if (submitBtn) {
                        submitBtn.textContent = 'ÂÆåÊàêÁôªË®ò';
                        submitBtn.disabled = false;
                    }
                }
            }
        });

        // ËºâÂÖ•Ë®ÇÂñÆ - Ê†πÊìöLINEÂêçÁ®±Êü•Ë©¢‰∏¶Âêà‰ΩµÁõ∏ÂêåÁî¢ÂìÅ
        async function loadOrders() {
            if (!isRegistered) return;
            
            debugLog('ËºâÂÖ•Áî®Êà∂Ë®ÇÂñÆ');
            document.getElementById('ordersList').innerHTML = '<div class="loading">ËºâÂÖ•‰∏≠...</div>';
            
            try {
                const result = await callAPI('orders', { 
                    lineName: userProfile.displayName 
                });
                
                if (result.success && result.orderSummary) {
                    debugLog('Ë®ÇÂñÆËºâÂÖ•ÊàêÂäü', result.orderSummary);
                    currentOrderSummary = result.orderSummary;
                    displayOrderSummary(result.orderSummary);
                } else {
                    debugLog('ÁÑ°Ë®ÇÂñÆË®òÈåÑ');
                    document.getElementById('ordersList').innerHTML = '<div class="error">Êö´ÁÑ°Ë®ÇÂñÆË®òÈåÑ</div>';
                }
            } catch (error) {
                debugLog('ËºâÂÖ•Ë®ÇÂñÆÂ§±Êïó', error);
                console.error('ËºâÂÖ•Ë®ÇÂñÆÂ§±Êïó:', error);
                document.getElementById('ordersList').innerHTML = '<div class="error">ËºâÂÖ•Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶: ' + error.message + '</div>';
            }
        }

        // È°ØÁ§∫Ë®ÇÂñÆÊëòË¶Å
        function displayOrderSummary(orderSummary) {
            let html = `
                <div class="order-summary">
                    <h3>üìã Ë®ÇÂñÆÊëòË¶Å</h3>
                    <div class="summary-item">
                        <span>Ë®ÇÂñÆID:</span>
                        <span>${orderSummary.orderId}</span>
                    </div>
                    <div class="summary-item">
                        <span>LINEÂêçÁ®±:</span>
                        <span>${orderSummary.lineName}</span>
                    </div>
                    <div class="summary-item">
                        <span>ÁúüÂØ¶ÂßìÂêç:</span>
                        <span>${orderSummary.realName}</span>
                    </div>
                </div>
                
                <div class="product-list">
                    <h4>üì¶ Áî¢ÂìÅÊ∏ÖÂñÆ</h4>
            `;
            
            orderSummary.products.forEach(product => {
                html += `
                    <div class="product-item">
                        <div class="product-name">${product.productName}</div>
                        <div class="product-details">
                            ${product.quantity} √ó NT$ ${product.unitPrice.toLocaleString()} = NT$ ${product.totalPrice.toLocaleString()}
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div class="order-item" style="background: #e8f5e8; border-left-color: #00B900;">
                    <div class="total-amount" style="font-size: 20px; color: #00B900;">
                        Á∏ΩÈáëÈ°ç: NT$ ${orderSummary.totalAmount.toLocaleString()}
                    </div>
                </div>
            `;
            
            document.getElementById('ordersList').innerHTML = html;
        }

        // ËºâÂÖ•Ë®ÇÂñÆÊëòË¶Å‰æõÁπ≥Ë≤ª‰ΩøÁî®
        async function loadOrderSummaryForPayment() {
            if (!isRegistered) return;
            
            debugLog('ËºâÂÖ•Áπ≥Ë≤ªË®ÇÂñÆÊëòË¶Å');
            
            try {
                const result = await callAPI('orders', { 
                    lineName: userProfile.displayName 
                });
                
                if (result.success && result.orderSummary) {
                    currentOrderSummary = result.orderSummary;
                    displayOrderSummaryForPayment(result.orderSummary);
                    
                    // ÂïüÁî®Êèê‰∫§ÊåâÈàï
                    const submitBtn = document.getElementById('submitPaymentBtn');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                    }
                } else {
                    debugLog('ÁÑ°Ë®ÇÂñÆË®òÈåÑ');
                    const summarySection = document.getElementById('orderSummarySection');
                    if (summarySection) {
                        summarySection.innerHTML = '<div class="error">Êö´ÁÑ°ÂæÖÁπ≥Ë≤ªË®ÇÂñÆ</div>';
                        summarySection.style.display = 'block';
                    }
                }
            } catch (error) {
                debugLog('ËºâÂÖ•Áπ≥Ë≤ªË®ÇÂñÆÊëòË¶ÅÂ§±Êïó', error);
                console.error('ËºâÂÖ•Áπ≥Ë≤ªË®ÇÂñÆÊëòË¶ÅÂ§±Êïó:', error);
            }
        }

        // È°ØÁ§∫Áπ≥Ë≤ªÁî®ÁöÑË®ÇÂñÆÊëòË¶Å
        function displayOrderSummaryForPayment(orderSummary) {
            let html = `
                <div class="summary-item">
                    <span>Ë®ÇÂñÆID:</span>
                    <span>${orderSummary.orderId}</span>
                </div>
                <div class="summary-item">
                    <span>LINEÂêçÁ®±:</span>
                    <span>${orderSummary.lineName}</span>
                </div>
                <div class="summary-item">
                    <span>ÁúüÂØ¶ÂßìÂêç:</span>
                    <span>${orderSummary.realName}</span>
                </div>
            `;
            
            orderSummary.products.forEach(product => {
                html += `
                    <div class="summary-item">
                        <span>${product.productName}:</span>
                        <span>${product.quantity} √ó NT$ ${product.unitPrice.toLocaleString()}</span>
                    </div>
                `;
            });
            
            html += `
                <div class="summary-item">
                    <span>ÊáâÁπ≥ÈáëÈ°ç:</span>
                    <span>NT$ ${orderSummary.totalAmount.toLocaleString()}</span>
                </div>
            `;
            
            document.getElementById('orderSummaryDetails').innerHTML = html;
            document.getElementById('orderSummarySection').style.display = 'block';
        }

        // ËôïÁêÜÊ™îÊ°à‰∏äÂÇ≥
        function handleFileUpload(input) {
            const file = input.files[0];
            if (file) {
                debugLog('ÈÅ∏ÊìáÊ™îÊ°à', { name: file.name, size: file.size, type: file.type });
                
                const uploadArea = document.querySelector('.upload-area');
                uploadArea.innerHTML = `
                    <div class="upload-icon">‚úÖ</div>
                    <p>Â∑≤ÈÅ∏Êìá: ${file.name}</p>
                    <small>Ê™îÊ°àÂ§ßÂ∞è: ${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                `;
                uploadArea.style.background = '#d4edda';
            }
        }

        // Êèê‰∫§Áπ≥Ë≤ªË≠âÊòé
        async function submitPayment() {
            debugLog('Êèê‰∫§Áπ≥Ë≤ªË≠âÊòé');
            
            if (!currentOrderSummary) {
                showError('ÁÑ°Ê≥ïÂèñÂæóË®ÇÂñÆË≥áË®äÔºåË´ãÈáçÊñ∞ËºâÂÖ•');
                return;
            }
            
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paymentNote = document.getElementById('paymentNote').value;
            const paymentProof = document.getElementById('paymentProof').files[0];
            
            if (!paymentProof) {
                showError('Ë´ã‰∏äÂÇ≥Áπ≥Ë≤ªË≠âÊòé');
                return;
            }
            
            const paymentData = {
                orderId: currentOrderSummary.orderId,
                lineName: currentOrderSummary.lineName,
                realName: currentOrderSummary.realName,
                paymentAmount: currentOrderSummary.totalAmount,
                paymentMethod: paymentMethod,
                paymentNote: paymentNote,
                submittedAt: new Date().toISOString()
            };
            
            try {
                // È°ØÁ§∫ËºâÂÖ•ÁãÄÊÖã
                const submitBtn = document.getElementById('submitPaymentBtn');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Êèê‰∫§‰∏≠...';
                submitBtn.disabled = true;
                
                const result = await callAPI('submit-payment', paymentData);
                
                if (result.success) {
                    debugLog('Áπ≥Ë≤ªË≠âÊòéÊèê‰∫§ÊàêÂäü');
                    showSuccess('Áπ≥Ë≤ªË≠âÊòéÊèê‰∫§ÊàêÂäüÔºÅÊàëÂÄëÊúÉÁõ°Âø´ËôïÁêÜÊÇ®ÁöÑÁî≥Ë´ã„ÄÇ');
                    
                    // Ê∏ÖÁ©∫Ë°®ÂñÆ
                    document.getElementById('paymentNote').value = '';
                    document.getElementById('paymentProof').value = '';
                    
                    // ÈáçÁΩÆ‰∏äÂÇ≥ÂçÄÂüü
                    const uploadArea = document.querySelector('.upload-area');
                    uploadArea.innerHTML = `
                        <div class="upload-icon">üì∑</div>
                        <p>ÈªûÊìä‰∏äÂÇ≥Áπ≥Ë≤ªË≠âÊòéÁÖßÁâá</p>
                        <small>ÊîØÊè¥ JPG, PNG Ê†ºÂºè</small>
                    `;
                    uploadArea.style.background = '';
                    
                    submitBtn.textContent = 'Â∑≤Êèê‰∫§';
                    submitBtn.disabled = true;
                } else {
                    debugLog('Áπ≥Ë≤ªË≠âÊòéÊèê‰∫§Â§±Êïó', result);
                    showError(result.message || 'Êèê‰∫§Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                debugLog('Áπ≥Ë≤ªË≠âÊòéÊèê‰∫§Â§±Êïó', error);
                console.error('Êèê‰∫§Áπ≥Ë≤ªË≠âÊòéÂ§±Êïó:', error);
                showError('Êèê‰∫§Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶: ' + error.message);
                
                const submitBtn = document.getElementById('submitPaymentBtn');
                if (submitBtn) {
                    submitBtn.textContent = 'Êèê‰∫§Áπ≥Ë≤ªË≠âÊòé';
                    submitBtn.disabled = false;
                }
            }
        }

        // È°ØÁ§∫ÈåØË™§Ë®äÊÅØ
        function showError(message) {
            debugLog('È°ØÁ§∫ÈåØË™§Ë®äÊÅØ', message);
            
            // ÁßªÈô§ÁèæÊúâÁöÑË®äÊÅØ
            const existingMessages = document.querySelectorAll('.error, .success');
            existingMessages.forEach(msg => msg.remove());
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(errorDiv, content.firstChild);
            
            // 5ÁßíÂæåËá™ÂãïÁßªÈô§
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
        function showSuccess(message) {
            debugLog('È°ØÁ§∫ÊàêÂäüË®äÊÅØ', message);
            
            // ÁßªÈô§ÁèæÊúâÁöÑË®äÊÅØ
            const existingMessages = document.querySelectorAll('.error, .success');
            existingMessages.forEach(msg => msg.remove());
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(successDiv, content.firstChild);
            
            // 3ÁßíÂæåËá™ÂãïÁßªÈô§
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 3000);
        }

        // È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂæåÁöÑÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM ËºâÂÖ•ÂÆåÊàê');
            
            // Â¶ÇÊûú LIFF Â∞öÊú™ÂàùÂßãÂåñÔºåÂâáÈáçÊñ∞ÂàùÂßãÂåñ
            if (!userId) {
                debugLog('ÈáçÊñ∞ÂàùÂßãÂåñ LIFF');
                initializeLiff();
            }
        });

        // ÈåØË™§ËôïÁêÜ
        window.addEventListener('error', function(e) {
            debugLog('ÂÖ®ÂüüÈåØË™§', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                error: e.error
            });
            console.error('ÂÖ®ÂüüÈåØË™§:', e);
        });

        // Êú™ËôïÁêÜÁöÑ Promise ÊãíÁµï
        window.addEventListener('unhandledrejection', function(e) {
            debugLog('Êú™ËôïÁêÜÁöÑ Promise ÊãíÁµï', e.reason);
            console.error('Êú™ËôïÁêÜÁöÑ Promise ÊãíÁµï:', e.reason);
        });

    </script>
  </body>
  </html>
