<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>訂購管理系統</title>
  <meta name="description" content="訂購管理系統 - 查詢訂單、繳費回報">
  <meta name="theme-color" content="#4285f4">
  
  <!-- LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    :root {
      --primary-color: #4285f4;
      --secondary-color: #34a853;
      --accent-color: #ea4335;
      --text-color: #333333;
      --light-text: #757575;
      --background-color: #f5f5f5;
      --card-color: #ffffff;
      --border-color: #e0e0e0;
      --shadow-color: rgba(0, 0, 0, 0.1);
      --success-color: #34a853;
      --warning-color: #fbbc05;
      --error-color: #ea4335;
      --info-color: #4285f4;
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: var(--font-family);
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
      padding: 0;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }
    
    .container {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
      flex: 1;
    }
    
    .header {
      background-color: var(--primary-color);
      color: white;
      padding: 16px;
      text-align: center;
      position: relative;
      box-shadow: 0 2px 4px var(--shadow-color);
    }
    
    .header h1 {
      font-size: 1.5rem;
      margin: 0;
      font-weight: 500;
    }
    
    .card {
      background-color: var(--card-color);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 4px var(--shadow-color);
    }
    
    .card h2 {
      font-size: 1.25rem;
      margin-bottom: 16px;
      color: var(--primary-color);
      font-weight: 500;
    }
    
    .tab-container {
      background-color: var(--card-color);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px var(--shadow-color);
      margin-bottom: 16px;
    }
    
    .tab-buttons {
      display: flex;
      background-color: var(--primary-color);
    }
    
    .tab-button {
      flex: 1;
      border: none;
      background: none;
      color: rgba(255, 255, 255, 0.8);
      padding: 12px 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      border-bottom: 3px solid transparent;
    }
    
    .tab-button.active {
      color: white;
      border-bottom: 3px solid white;
    }
    
    .tab-button:hover:not(.active) {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .tab-content {
      display: none;
      padding: 16px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-color);
    }
    
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1rem;
      color: var(--text-color);
      background-color: white;
      transition: border-color 0.3s;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: var(--primary-color);
      outline: none;
    }
    
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 16px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      width: 100%;
    }
    
    .btn:hover {
      background-color: #3367d6;
    }
    
    .btn:disabled {
      background-color: #b0bec5;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background-color: #757575;
    }
    
    .btn-secondary:hover {
      background-color: #616161;
    }
    
    .btn-success {
      background-color: var(--success-color);
    }
    
    .btn-success:hover {
      background-color: #2e7d32;
    }
    
    .btn-warning {
      background-color: var(--warning-color);
    }
    
    .btn-warning:hover {
      background-color: #f57c00;
    }
    
    .btn-error {
      background-color: var(--error-color);
    }
    
    .btn-error:hover {
      background-color: #c62828;
    }
    
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      text-align: center;
      color: var(--light-text);
    }
    
    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid var(--primary-color);
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 0.9rem;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
      max-width: 80%;
      text-align: center;
      pointer-events: none;
    }
    
    .toast.show {
      opacity: 1;
    }
    
    .toast.success {
      background-color: var(--success-color);
    }
    
    .toast.error {
      background-color: var(--error-color);
    }
    
    .toast.warning {
      background-color: var(--warning-color);
      color: var(--text-color);
    }
    
    .toast.info {
      background-color: var(--info-color);
    }
    
    .error-container {
      text-align: center;
      padding: 24px;
      color: var(--error-color);
    }
    
    .profile-card {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .profile-image {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 16px;
      border: 2px solid var(--primary-color);
    }
    
    .profile-info {
      flex: 1;
    }
    
    .profile-name {
      font-weight: 500;
      font-size: 1.1rem;
      margin-bottom: 4px;
    }
    
    .profile-status {
      color: var(--light-text);
      font-size: 0.9rem;
    }
    
    .info, .warning, .error, .success {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    
    .info {
      background-color: rgba(66, 133, 244, 0.1);
      border-left: 4px solid var(--info-color);
    }
    
    .warning {
      background-color: rgba(251, 188, 5, 0.1);
      border-left: 4px solid var(--warning-color);
    }
    
    .error {
      background-color: rgba(234, 67, 53, 0.1);
      border-left: 4px solid var(--error-color);
    }
    
    .success {
      background-color: rgba(52, 168, 83, 0.1);
      border-left: 4px solid var(--success-color);
    }
    
    .divider {
      height: 1px;
      background-color: var(--border-color);
      margin: 16px 0;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    
    .badge-primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .badge-secondary {
      background-color: #757575;
      color: white;
    }
    
    .badge-success {
      background-color: var(--success-color);
      color: white;
    }
    
    .badge-warning {
      background-color: var(--warning-color);
      color: var(--text-color);
    }
    
    .badge-error {
      background-color: var(--error-color);
      color: white;
    }
    
    .badge-info {
      background-color: var(--info-color);
      color: white;
    }
    
    .badge-light {
      background-color: #e0e0e0;
      color: var(--text-color);
    }
    
    .badge-dark {
      background-color: #424242;
      color: white;
    }
    
    .order-summary {
      margin-bottom: 16px;
      padding: 16px;
      background-color: rgba(66, 133, 244, 0.1);
      border-radius: 8px;
    }
    
    .order-summary h3 {
      margin-bottom: 12px;
      color: var(--primary-color);
      font-weight: 500;
    }
    
    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .summary-item:last-child {
      margin-bottom: 0;
    }
    
    .product-list {
      margin-top: 16px;
    }
    
    .product-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .product-item:last-child {
      border-bottom: none;
    }
    
    .product-name {
      flex: 1;
    }
    
    .product-price {
      font-weight: 500;
      text-align: right;
      margin-left: 16px;
    }
    
    .total-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      font-weight: 500;
      border-top: 2px solid var(--border-color);
      margin-top: 8px;
    }
    
    .payment-status {
      margin-top: 16px;
    }
    
    .payment-item {
      background-color: white;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px var(--shadow-color);
    }
    
    .payment-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .payment-id {
      font-size: 0.9rem;
      color: var(--light-text);
    }
    
    .payment-date {
      font-size: 0.9rem;
      color: var(--light-text);
    }
    
    .payment-amount {
      font-size: 1.2rem;
      font-weight: 500;
      margin-bottom: 8px;
    }
    
    .payment-method {
      margin-bottom: 8px;
    }
    
    .payment-note {
      font-size: 0.9rem;
      color: var(--light-text);
      margin-top: 8px;
      white-space: pre-line;
    }
    
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
      display: inline-block;
    }
    
    .status-pending {
      background-color: var(--warning-color);
      color: var(--text-color);
    }
    
    .status-approved {
      background-color: var(--success-color);
      color: white;
    }
    
    .status-rejected {
      background-color: var(--error-color);
      color: white;
    }
    
    .footer {
      text-align: center;
      padding: 16px;
      color: var(--light-text);
      font-size: 0.8rem;
      background-color: white;
      border-top: 1px solid var(--border-color);
    }
    
    .cache-info {
      text-align: center;
      padding: 8px;
      background-color: rgba(0, 0, 0, 0.05);
      border-radius: 4px;
      font-size: 0.8rem;
      color: var(--light-text);
      margin-top: 16px;
    }
    
    .offline-banner {
      background-color: var(--warning-color);
      color: var(--text-color);
      text-align: center;
      padding: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      display: none;
    }
    
    .offline-banner.show {
      display: block;
    }
    
    @media (max-width: 480px) {
      .header h1 {
        font-size: 1.3rem;
      }
      
      .tab-button {
        font-size: 0.8rem;
        padding: 10px 4px;
      }
    }
  </style>
</head>
<body>
  <div id="offlineBanner" class="offline-banner">
    您目前處於離線狀態，部分功能可能無法使用
  </div>
  
  <header class="header">
    <h1>訂購管理系統</h1>
  </header>
  
  <div class="container">
    <div id="loadingContainer" class="loading">
      <div class="loading-spinner"></div>
      <p>初始化中，請稍候...</p>
    </div>
    
    <div id="errorContainer" class="error-container" style="display: none;">
      <h2>發生錯誤</h2>
      <p id="errorMessage"></p>
      <button class="btn" onclick="location.reload()" style="margin-top: 16px; max-width: 200px;">
        重新載入
      </button>
    </div>
    
    <div id="mainContent" style="display: none;">
      <div class="tab-container">
        <div class="tab-buttons">
          <button class="tab-button active" onclick="switchTab('home', event)">首頁</button>
          <button class="tab-button" onclick="switchTab('orders', event)">我的訂單</button>
          <button class="tab-button" onclick="switchTab('payment', event)">繳費回報</button>
          <button class="tab-button" onclick="switchTab('status', event)">繳費狀態</button>
        </div>
        
        <div id="home" class="tab-content active">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
        
        <div id="orders" class="tab-content">
          <div id="ordersContent" class="loading">
            <div class="loading-spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
        
        <div id="payment" class="tab-content">
          <div id="paymentContent" class="loading">
            <div class="loading-spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
        
        <div id="status" class="tab-content">
          <div id="statusContent" class="loading">
            <div class="loading-spinner"></div>
            <p>載入中...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="toast" class="toast"></div>
  
  <footer class="footer">
    <p>© 2025 訂購管理系統 v2.0.0</p>
  </footer>
  
  <script>
    // ==================== 全域變數 ====================
    
    // API 設定
    const API_CONFIG = {
      URL: 'https://script.google.com/macros/s/AKfycbzymu8Z2uyfuYP-ZI480g0QKIhJV5C0H3PKeHGWp90O3GXpsdnnpLO9d7bwWoNUs2G5/exec',
      RETRY_DELAY: 1000,
      MAX_RETRIES: 3
    };
    
    // 用戶資訊
    let userId = null;
    let userProfile = null;
    let isRegistered = false;
    let userRegistrationData = null;
    
    // 訂單資訊
    let currentOrderSummary = null;
    
    // 系統狀態
    let isInitialized = false;
    let isOnline = true;
    let liffObject = null;
    
    // ==================== 初始化函數 ====================
    
    /**
     * 應用程式初始化
     */
    async function initializeApp() {
      try {
        // 初始化網路狀態監控
        initializeNetworkMonitoring();
        
        // 嘗試從 localStorage 恢復訂單數據
        try {
          const savedOrderSummary = localStorage.getItem('currentOrderSummary');
          if (savedOrderSummary) {
            currentOrderSummary = JSON.parse(savedOrderSummary);
            debugLog('從 localStorage 恢復訂單數據', currentOrderSummary);
          }
        } catch (e) {
          debugLog('恢復訂單數據失敗', e);
        }
        
        // 初始化 LIFF
        await initializeLiff();
        
        // 測試 API 連線
        await testApiConnection();
        
        // 檢查用戶註冊狀態
        if (userId) {
          await checkUserRegistration();
        }
        
        // 載入首頁內容
        loadHomeContent();
        
        // 顯示主內容
        document.getElementById('loadingContainer').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
        isInitialized = true;
        
      } catch (error) {
        debugLog('應用程式初始化失敗', error);
        showError('系統初始化失敗，請重新開啟: ' + error.message);
      }
    }
    
    /**
     * 初始化 LIFF
     */
    async function initializeLiff() {
      try {
        debugLog('初始化 LIFF...');
        
        // 初始化 LIFF SDK
        liffObject = await liff.init({
          liffId: '2001304097-vk1Gy5xN' // 請替換為您的 LIFF ID
        });
        
        debugLog('LIFF 初始化成功');
        
        // 檢查是否在 LINE 環境中
        if (!liff.isInClient()) {
          debugLog('不在 LINE 環境中');
          UIManager.showToast('請在 LINE 應用程式中開啟', 'warning');
        }
        
        // 檢查登入狀態
        if (!liff.isLoggedIn()) {
          debugLog('用戶未登入，執行登入程序');
          liff.login();
          return;
        }
        
        // 取得用戶資訊
        userProfile = await liff.getProfile();
        userId = userProfile.userId;
        
        debugLog('取得用戶資訊', {
          userId: userId,
          displayName: userProfile.displayName
        });
        
      } catch (error) {
        debugLog('LIFF 初始化失敗', error);
        throw new Error('LINE 介面載入失敗: ' + error.message);
      }
    }
    
    /**
     * 初始化網路狀態監控
     */
    function initializeNetworkMonitoring() {
      const offlineBanner = document.getElementById('offlineBanner');
      
      // 初始檢查
      isOnline = navigator.onLine;
      offlineBanner.classList.toggle('show', !isOnline);
      
      // 監聽網路狀態變化
      window.addEventListener('online', () => {
        isOnline = true;
        offlineBanner.classList.remove('show');
        UIManager.showToast('已恢復網路連線', 'success');
        
        // 重新載入資料
        if (isInitialized) {
          const activeTab = document.querySelector('.tab-content.active');
          if (activeTab) {
            loadTabContent(activeTab.id);
          }
        }
      });
      
      window.addEventListener('offline', () => {
        isOnline = false;
        offlineBanner.classList.add('show');
        UIManager.showToast('網路連線中斷，使用快取資料', 'warning');
      });
    }
    
    /**
     * 測試 API 連線
     */
    async function testApiConnection() {
      try {
        debugLog('測試 API 連線...');
        
        const result = await callAPIWithRetry('test', {});
        
        if (result && result.success) {
          debugLog('API 連線正常', result);
          return true;
        } else {
          throw new Error('API 連線失敗');
        }
        
      } catch (error) {
        debugLog('API 連線測試失敗', error);
        throw new Error('系統連線失敗: ' + error.message);
      }
    }
    
    /**
     * 檢查用戶註冊狀態
     */
    async function checkUserRegistration() {
      try {
        debugLog('檢查用戶註冊狀態...');
        
        // 檢查快取
        const cacheKey = `registration_${userId}`;
        const cachedData = CacheManager.get(cacheKey);
        
        if (cachedData && !isOnline) {
          debugLog('使用快取的註冊資料', cachedData);
          isRegistered = cachedData.registered;
          userRegistrationData = cachedData.userInfo;
          return;
        }
        
        const result = await callAPIWithRetry('check-registration', {
          userId: userId,
          lineName: userProfile.displayName
        });
        
        if (result && result.success) {
          isRegistered = result.registered;
          userRegistrationData = result.userInfo;
          
          // 快取結果
          CacheManager.set(cacheKey, {
            registered: isRegistered,
            userInfo: userRegistrationData
          });
          
          debugLog('註冊狀態檢查結果', {
            isRegistered: isRegistered,
            userInfo: userRegistrationData
          });
          
        } else {
          throw new Error(result?.message || '檢查註冊狀態失敗');
        }
        
      } catch (error) {
        debugLog('檢查註冊狀態錯誤', error);
        UIManager.showToast('檢查註冊狀態失敗: ' + error.message, 'error');
      }
    }
    
    // ==================== 內容載入函數 ====================
    
    /**
     * 載入標籤頁內容
     */
    function loadTabContent(tabName) {
      switch (tabName) {
        case 'home':
          loadHomeContent();
          break;
          
        case 'orders':
          loadOrdersContent();
          break;
          
        case 'payment':
          loadPaymentContent();
          break;
          
        case 'status':
          loadStatusContent();
          break;
          
        default:
          break;
      }
    }
    
    /**
     * 載入首頁內容
     */
    function loadHomeContent() {
      const contentDiv = document.getElementById('home');
      
      if (!userProfile) {
        contentDiv.innerHTML = `
          <div class="warning">
            <h3>⚠️ 無法取得用戶資訊</h3>
            <p>請確認您已登入 LINE 並授權應用程式存取資訊。</p>
            <button class="btn" onclick="location.reload()" style="margin-top: 15px; max-width: 200px;">
              重新載入
            </button>
          </div>
        `;
        return;
      }
      
      let profileImage = userProfile.pictureUrl || 'https://via.placeholder.com/60';
      
      // 用戶資訊卡片
      let userInfoHtml = `
        <div class="profile-card">
          <img src="${profileImage}" alt="個人頭像" class="profile-image">
          <div class="profile-info">
            <div class="profile-name">${userProfile.displayName}</div>
            <div class="profile-status">
              ${isRegistered ? 
                `<span class="badge badge-success">已註冊</span>` : 
                `<span class="badge badge-warning">未註冊</span>`}
            </div>
          </div>
        </div>
      `;
      
      // 系統資訊卡片
      let systemInfoHtml = `
        <div class="card">
          <h2>📱 系統資訊</h2>
          <p>歡迎使用訂購管理系統，您可以在這裡查詢訂單、回報繳費以及查看繳費狀態。</p>
          
          <div class="divider"></div>
          
          <p style="margin-bottom: 12px;">系統功能：</p>
          <div>
            <span class="badge badge-primary">訂單查詢</span>
            <span class="badge badge-primary">繳費回報</span>
            <span class="badge badge-primary">繳費狀態</span>
          </div>
        </div>
      `;
      
      // 註冊表單或已註冊資訊
      let registrationHtml = '';
      
      if (isRegistered) {
        registrationHtml = `
          <div class="card">
            <h2>👤 用戶資料</h2>
            <div class="form-group">
              <label>真實姓名</label>
              <div style="padding: 10px 12px; background-color: rgba(0,0,0,0.05); border-radius: 4px;">
                ${userRegistrationData.realName}
              </div>
            </div>
            
            ${userRegistrationData.phone ? `
            <div class="form-group">
              <label>聯絡電話</label>
              <div style="padding: 10px 12px; background-color: rgba(0,0,0,0.05); border-radius: 4px;">
                ${userRegistrationData.phone}
              </div>
            </div>
            ` : ''}
            
            <div class="form-group">
              <label>註冊時間</label>
              <div style="padding: 10px 12px; background-color: rgba(0,0,0,0.05); border-radius: 4px; font-size: 0.9rem;">
                ${new Date(userRegistrationData.registeredAt).toLocaleString('zh-TW')}
              </div>
            </div>
            
            <button class="btn" onclick="switchTab('orders', event)">
              查詢我的訂單
            </button>
          </div>
        `;
      } else {
        registrationHtml = `
          <div class="card">
            <h2>📝 實名制登記</h2>
            <p style="margin-bottom: 16px;">請填寫以下資料完成實名制登記，以便查詢訂單及繳費。</p>
            
            <form id="registrationForm">
              <div class="form-group">
                <label for="realName">真實姓名 *</label>
                <input type="text" id="realName" name="realName" required placeholder="請輸入您的真實姓名">
                <small style="color: #6c757d; font-size: 12px;">必須與訂購時填寫的姓名相同</small>
              </div>
              
              <div class="form-group">
                <label for="phone">聯絡電話</label>
                <input type="tel" id="phone" name="phone" placeholder="請輸入您的聯絡電話">
                <small style="color: #6c757d; font-size: 12px;">選填，用於必要時聯絡</small>
              </div>
              
              <button type="submit" class="btn" id="registrationSubmitBtn">
                <span>提交登記資料</span>
              </button>
            </form>
          </div>
        `;
      }
      
      // 組合所有內容
      contentDiv.innerHTML = userInfoHtml + systemInfoHtml + registrationHtml;
      
      // 綁定註冊表單事件
      if (!isRegistered) {
        document.getElementById('registrationForm').addEventListener('submit', handleRegistrationSubmit);
      }
    }
    
    /**
     * 載入訂單內容
     */
    async function loadOrdersContent() {
      if (!isRegistered || !userRegistrationData) return;
      
      const contentDiv = document.getElementById('ordersContent');
      UIManager.showLoading('ordersContent', '載入訂單資料中...');
      
      try {
        // 檢查快取
        const cacheKey = `orders_${userId}`;
        const cachedData = CacheManager.get(cacheKey);
        
        if (cachedData && !isOnline) {
          debugLog('使用快取的訂單資料', cachedData);
          displayOrderData(cachedData, true);
          return;
        }
        
        const result = await callAPIWithRetry('get-orders', {
          userId: userId,
          lineName: userProfile.displayName,
          realName: userRegistrationData.realName
        });
        
        if (result && result.success) {
          // 快取結果
          CacheManager.set(cacheKey, result);
          displayOrderData(result, false);
          
          // 將訂單數據也存儲到 localStorage 中，確保在頁面重載後仍可用
          if (result.orderSummary) {
            localStorage.setItem('currentOrderSummary', JSON.stringify(result.orderSummary));
          }
        } else {
          throw new Error(result?.message || '載入訂單失敗');
        }
        
      } catch (error) {
        debugLog('載入訂單錯誤', error);
        contentDiv.innerHTML = `
          <div class="error">
            <h3>❌ 載入失敗</h3>
            <p>${error.message || '無法載入訂單資料，請稍後再試'}</p>
            <button class="btn" onclick="loadOrdersContent()" style="margin-top: 15px; max-width: 200px;">
              重新載入
            </button>
          </div>
        `;
      }
    }
    
    /**
     * 顯示訂單資料
     */
    function displayOrderData(result, isFromCache) {
      const contentDiv = document.getElementById('ordersContent');
      
      if (result.orderSummary) {
        // 輸出詳細日誌
        debugLog('原始訂單數據', result.orderSummary);
        
        // 使用新的產品處理邏輯
        const processedSummary = {
          ...result.orderSummary,
          ...ProductDataProcessor.calculateSummary(result.orderSummary.products)
        };
        
        debugLog('處理後的訂單數據', processedSummary);
        
        // 確保訂單 ID 存在
        if (!processedSummary.orderId) {
          debugLog('警告: 訂單 ID 不存在', processedSummary);
          contentDiv.innerHTML = `
            <div class="warning">
              <h3>⚠️ 訂單資料不完整</h3>
              <p>無法獲取訂單編號，請聯絡客服處理。</p>
              <button class="btn" onclick="loadOrdersContent()" style="margin-top: 15px;">
                重新載入
              </button>
            </div>
          `;
          return;
        }
        
        currentOrderSummary = processedSummary;
        // 立即保存到 localStorage
        localStorage.setItem('currentOrderSummary', JSON.stringify(currentOrderSummary));
        
        displayOrderSummary(processedSummary);
        
        if (isFromCache) {
          UIManager.showCacheInfo('ordersContent', result.timestamp || Date.now());
        }
      } else {
        contentDiv.innerHTML = `
          <div class="info">
            <h3>📋 訂單查詢結果</h3>
            <p>${result.message || '目前沒有訂購記錄'}</p>
          </div>
        `;
      }
    }
    
    /**
     * 顯示訂單摘要
     */
    function displayOrderSummary(orderSummary) {
      const contentDiv = document.getElementById('ordersContent');
      
      let productListHtml = '';
      orderSummary.products.forEach(product => {
        productListHtml += `
          <div class="product-item">
            <div class="product-name">
              ${product.productName}<br>
              <small style="color: #6c757d;">
                ${product.productCode} × ${product.quantity}
              </small>
            </div>
            <div class="product-price">
              NT$ ${product.totalPrice.toLocaleString()}
              <br>
              <small style="color: #6c757d;">
                單價: ${product.unitPrice.toLocaleString()}
              </small>
            </div>
          </div>
        `;
      });
      
      contentDiv.innerHTML = `
        <div class="order-summary">
          <h3>📋 訂單摘要</h3>
          <div class="summary-item">
            <span>訂單編號:</span>
            <span>${orderSummary.orderId}</span>
          </div>
          <div class="summary-item">
            <span>訂購日期:</span>
            <span>${new Date(orderSummary.orderDate).toLocaleDateString('zh-TW')}</span>
          </div>
          <div class="summary-item">
            <span>訂購人:</span>
            <span>${orderSummary.realName}</span>
          </div>
          <div class="summary-item">
            <span>商品數量:</span>
            <span>${orderSummary.productCount} 種商品，共 ${orderSummary.totalQuantity} 件</span>
          </div>
          <div class="summary-item">
            <span>應繳金額:</span>
            <span>NT$ ${orderSummary.totalAmount.toLocaleString()}</span>
          </div>
        </div>
        
        <div class="card">
          <h3>🛒 商品明細</h3>
          <div class="product-list">
            ${productListHtml}
            <div class="total-row">
              <span>總計金額:</span>
              <span>NT$ ${orderSummary.totalAmount.toLocaleString()}</span>
            </div>
          </div>
        </div>
        
        <button class="btn btn-success" onclick="switchTab('payment', event)" style="margin-top: 16px;">
          前往繳費回報
        </button>
      `;
    }
    
    /**
     * 載入繳費回報內容
     */
    function loadPaymentContent() {
      if (!isRegistered || !userRegistrationData) return;
      
      const contentDiv = document.getElementById('paymentContent');
      
      // 檢查訂單數據是否完整
      if (!currentOrderSummary || !currentOrderSummary.orderId) {
        // 嘗試從 localStorage 恢復
        try {
          const savedOrderSummary = localStorage.getItem('currentOrderSummary');
          if (savedOrderSummary) {
            currentOrderSummary = JSON.parse(savedOrderSummary);
            debugLog('從 localStorage 恢復訂單數據', currentOrderSummary);
          }
        } catch (e) {
          debugLog('恢復訂單數據失敗', e);
        }
        
        // 如果仍然沒有訂單數據，提示用戶先查詢訂單
        if (!currentOrderSummary || !currentOrderSummary.orderId) {
          contentDiv.innerHTML = `
            <div class="warning">
              <h3>⚠️ 請先查詢訂單</h3>
              <p>請先到「我的訂單」頁面查詢訂單資訊，再進行繳費回報。</p>
              <button class="btn" onclick="switchTab('orders', event)" style="margin-top: 15px;">
                查詢我的訂單
              </button>
            </div>
          `;
          return;
        }
      }
      
      // 顯示繳費表單
      contentDiv.innerHTML = `
        <div class="order-summary">
          <h3>💰 繳費回報</h3>
          <div class="summary-item">
            <span>訂單編號:</span>
            <span>${currentOrderSummary.orderId}</span>
          </div>
          <div class="summary-item">
            <span>應繳金額:</span>
            <span>NT$ ${currentOrderSummary.totalAmount.toLocaleString()}</span>
          </div>
        </div>
        
        <form id="paymentForm">
          <div class="form-group">
            <label for="paymentAmount">實際繳費金額 *</label>
            <input type="number" id="paymentAmount" name="paymentAmount" 
                   value="${currentOrderSummary.totalAmount}" 
                   min="1" step="1" required 
                   placeholder="請輸入實際繳費金額">
            <small style="color: #6c757d; font-size: 12px;">請輸入您實際繳費的金額</small>
          </div>
          
          <div class="form-group">
            <label for="paymentMethod">繳費方式 *</label>
            <select id="paymentMethod" name="paymentMethod" required>
              <option value="">請選擇繳費方式</option>
              <option value="銀行轉帳">銀行轉帳</option>
              <option value="ATM轉帳">ATM轉帳</option>
              <option value="網路銀行">網路銀行</option>
              <option value="現金">現金</option>
              <option value="其他">其他</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="paymentNote">備註說明</label>
            <textarea id="paymentNote" name="paymentNote" 
                      placeholder="請輸入備註說明（如：轉帳帳號後5碼、繳費時間等）" 
                      maxlength="200"></textarea>
            <small style="color: #6c757d; font-size: 12px;">選填，最多200字</small>
          </div>
          
          <button type="submit" class="btn" id="paymentSubmitBtn">
            <span>提交繳費回報</span>
          </button>
        </form>
      `;
      
      // 綁定表單事件
      document.getElementById('paymentForm').addEventListener('submit', handlePaymentSubmit);
    }
    
    /**
     * 載入繳費狀態內容
     */
    async function loadStatusContent() {
      if (!isRegistered || !userRegistrationData) return;
      
      const contentDiv = document.getElementById('statusContent');
      UIManager.showLoading('statusContent', '載入繳費狀態中...');
      
      try {
        // 檢查快取
        const cacheKey = `payment_status_${userId}`;
        const cachedData = CacheManager.get(cacheKey);
        
        if (cachedData && !isOnline) {
          debugLog('使用快取的繳費狀態', cachedData);
          displayPaymentStatus(cachedData, true);
          return;
        }
        
        const result = await callAPIWithRetry('get-payment-status', {
          userId: userId,
          realName: userRegistrationData.realName
        });
        
        if (result && result.success) {
          // 快取結果
          CacheManager.set(cacheKey, result);
          displayPaymentStatus(result, false);
        } else {
          throw new Error(result?.message || '載入繳費狀態失敗');
        }
        
      } catch (error) {
        debugLog('載入繳費狀態錯誤', error);
        contentDiv.innerHTML = `
          <div class="error">
            <h3>❌ 載入失敗</h3>
            <p>${error.message || '無法載入繳費狀態，請稍後再試'}</p>
            <button class="btn" onclick="loadStatusContent()" style="margin-top: 15px; max-width: 200px;">
              重新載入
            </button>
          </div>
        `;
      }
    }
    
    /**
     * 顯示繳費狀態
     */
    function displayPaymentStatus(result, isFromCache) {
      const contentDiv = document.getElementById('statusContent');
      
      if (result.payments && result.payments.length > 0) {
        let paymentsHtml = '';
        
        result.payments.forEach(payment => {
          let statusBadge = '';
          
          switch (payment.status) {
            case '待審核':
              statusBadge = '<span class="status-badge status-pending">待審核</span>';
              break;
            case '已確認':
              statusBadge = '<span class="status-badge status-approved">已確認</span>';
              break;
            case '已拒絕':
              statusBadge = '<span class="status-badge status-rejected">已拒絕</span>';
              break;
            default:
              statusBadge = `<span class="status-badge">${payment.status}</span>`;
          }
          
          paymentsHtml += `
            <div class="payment-item">
              <div class="payment-header">
                <div class="payment-id">${payment.paymentId}</div>
                <div>${statusBadge}</div>
              </div>
              
              <div class="payment-amount">NT$ ${payment.paymentAmount.toLocaleString()}</div>
              
              <div class="payment-method">
                <strong>繳費方式:</strong> ${payment.paymentMethod}
              </div>
              
              <div>
                <strong>訂單編號:</strong> ${payment.orderId}
              </div>
              
              <div>
                <strong>提交時間:</strong> ${new Date(payment.submittedAt).toLocaleString('zh-TW')}
              </div>
              
              ${payment.reviewedAt ? `
              <div>
                <strong>審核時間:</strong> ${new Date(payment.reviewedAt).toLocaleString('zh-TW')}
              </div>
              ` : ''}
              
              ${payment.paymentNote ? `
              <div class="payment-note">
                <strong>備註:</strong> ${payment.paymentNote}
              </div>
              ` : ''}
              
              ${payment.reviewNote ? `
              <div class="payment-note">
                <strong>審核備註:</strong> ${payment.reviewNote}
              </div>
              ` : ''}
            </div>
          `;
        });
        
        contentDiv.innerHTML = `
          <div class="info">
            <h3>📊 繳費狀態</h3>
            <p>以下是您的繳費記錄，最新的記錄會顯示在最前面。</p>
          </div>
          
          <div class="payment-status">
            ${paymentsHtml}
          </div>
        `;
        
        if (isFromCache) {
          UIManager.showCacheInfo('statusContent', result.timestamp || Date.now());
        }
        
      } else {
        contentDiv.innerHTML = `
          <div class="info">
            <h3>📊 繳費狀態</h3>
            <p>${result.message || '目前沒有繳費記錄'}</p>
            <button class="btn" onclick="switchTab('payment', event)" style="margin-top: 15px;">
              前往繳費回報
            </button>
          </div>
        `;
      }
    }
    
    // ==================== 表單處理函數 ====================
    
    /**
     * 處理註冊表單提交
     */
    async function handleRegistrationSubmit(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const realName = formData.get('realName').trim();
      const phone = formData.get('phone').trim();
      
      // 驗證
      if (!realName) {
        UIManager.showToast('請輸入真實姓名', 'error');
        return;
      }
      
      const nameValidation = FormValidator.validateRealName(realName);
      if (!nameValidation.valid) {
        UIManager.showToast(nameValidation.message, 'error');
        return;
      }
      
      if (phone) {
        const phoneValidation = FormValidator.validatePhone(phone);
        if (!phoneValidation.valid) {
          UIManager.showToast(phoneValidation.message, 'error');
          return;
        }
      }
      
      const submitBtn = document.getElementById('registrationSubmitBtn');
      const originalText = submitBtn.innerHTML;
      
      try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span>處理中...</span>';
        
        // 準備 LIFF 環境資訊
        const liffContext = {};
        try {
          liffContext.type = liff.getContext().type;
          liffContext.viewType = liff.getContext().viewType;
          liffContext.utouId = liff.getContext().utouId;
          liffContext.groupId = liff.getContext().groupId;
          liffContext.roomId = liff.getContext().roomId;
        } catch (error) {
          debugLog('獲取 LIFF 上下文錯誤', error);
        }
        
        const liffEnvironment = {};
        try {
          liffEnvironment.language = liff.getLanguage();
          liffEnvironment.version = liff.getVersion();
          liffEnvironment.isInClient = liff.isInClient();
          liffEnvironment.isLoggedIn = liff.isLoggedIn();
          liffEnvironment.os = liff.getOS();
        } catch (error) {
          debugLog('獲取 LIFF 環境錯誤', error);
        }
        
        const result = await callAPIWithRetry('register', {
          userId: userId,
          lineDisplayName: userProfile.displayName,
          realName: realName,
          phone: phone,
          liffContext: liffContext,
          liffEnvironment: liffEnvironment
        });
        
        if (result && result.success) {
          UIManager.showToast('註冊成功', 'success');
          
          // 更新用戶資訊
          isRegistered = true;
          userRegistrationData = result.userInfo;
          
          // 更新快取
          const cacheKey = `registration_${userId}`;
          CacheManager.set(cacheKey, {
            registered: true,
            userInfo: userRegistrationData
          });
          
          // 重新載入首頁
          loadHomeContent();
          
        } else {
          throw new Error(result?.message || '註冊失敗');
        }
        
      } catch (error) {
        debugLog('註冊錯誤', error);
        UIManager.showToast('註冊失敗: ' + error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    }
    
    /**
     * 處理繳費表單提交
     */
    async function handlePaymentSubmit(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const paymentAmount = parseFloat(formData.get('paymentAmount'));
      const paymentMethod = formData.get('paymentMethod').trim();
      const paymentNote = formData.get('paymentNote').trim();
      
      // 驗證
      if (!paymentAmount || paymentAmount <= 0) {
        UIManager.showToast('請輸入有效的繳費金額', 'error');
        return;
      }
      
      if (!paymentMethod) {
        UIManager.showToast('請選擇繳費方式', 'error');
        return;
      }
      
      const noteValidation = FormValidator.validatePaymentNote(paymentNote);
      if (!noteValidation.valid) {
        UIManager.showToast(noteValidation.message, 'error');
        return;
      }
      
      const submitBtn = document.getElementById('paymentSubmitBtn');
      const originalText = submitBtn.innerHTML;
      
      try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span>處理中...</span>';
        
        // 再次檢查訂單數據
        if (!currentOrderSummary) {
          debugLog('訂單數據為空');
          
          // 嘗試從 localStorage 恢復
          try {
            const savedOrderSummary = localStorage.getItem('currentOrderSummary');
            if (savedOrderSummary) {
              currentOrderSummary = JSON.parse(savedOrderSummary);
              debugLog('從 localStorage 恢復訂單數據', currentOrderSummary);
            }
          } catch (e) {
            debugLog('恢復訂單數據失敗', e);
          }
          
          if (!currentOrderSummary || !currentOrderSummary.orderId) {
            throw new Error('訂單資訊不完整，請重新查詢訂單');
          }
        }
        
        debugLog('開始處理繳費提交', {
          paymentAmount,
          paymentMethod,
          paymentNote,
          orderId: currentOrderSummary.orderId
        });
        
        submitBtn.innerHTML = '<span>提交中...</span>';
        
        // 準備提交資料 - 確保所有必要欄位都有提供
        const submitData = {
          userId: userId,
          orderId: currentOrderSummary.orderId,
          lineName: userProfile.displayName,
          realName: userRegistrationData.realName,
          paymentAmount: paymentAmount,
          paymentMethod: paymentMethod,
          paymentNote: paymentNote || '',
          images: []  // 保持空陣列
        };
        
        debugLog('準備提交資料', submitData);
        
        // 提交資料
        const result = await callAPIWithRetry('submit-payment', submitData);
        
        if (result && result.success) {
          handleSubmitSuccess(result);
        } else {
          throw new Error(result?.message || '提交失敗');
        }
        
      } catch (error) {
        debugLog('提交繳費回報失敗', error);
        UIManager.showToast('提交失敗: ' + error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    }
    
    /**
     * 處理提交成功
     */
    function handleSubmitSuccess(result) {
      // 顯示成功訊息
      const contentDiv = document.getElementById('paymentContent');
      contentDiv.innerHTML = `
        <div class="success">
          <h3>✅ 提交成功</h3>
          <p>您的繳費回報已成功提交，我們將盡快處理。</p>
          <p style="margin-top: 8px;">繳費編號: ${result.paymentId}</p>
          <p>提交時間: ${new Date(result.submittedAt).toLocaleString('zh-TW')}</p>
        </div>
        
        <button class="btn" onclick="switchTab('status', event)" style="margin-top: 16px;">
          查看繳費狀態
        </button>
      `;
      
      UIManager.showToast('繳費回報提交成功', 'success');
      
      // 清除快取中的繳費狀態，以便下次重新載入
      CacheManager.remove(`payment_status_${userId}`);
    }
    
    // ==================== 工具函數 ====================
    
    /**
     * 切換標籤頁
     */
    function switchTab(tabName, event) {
      if (event) {
        event.preventDefault();
      }
      
      debugLog('切換標籤頁', tabName);
      
      // 檢查是否需要註冊
      if (!isRegistered && ['orders', 'payment', 'status'].includes(tabName)) {
        UIManager.showToast('請先完成實名制登記', 'warning');
        return;
      }
      
      // 如果從訂單頁切換到繳費頁，確保訂單數據已保存
      const currentTab = document.querySelector('.tab-content.active');
      if (currentTab && currentTab.id === 'orders' && tabName === 'payment' && currentOrderSummary) {
        // 確保訂單數據已保存到 localStorage
        localStorage.setItem('currentOrderSummary', JSON.stringify(currentOrderSummary));
        debugLog('訂單數據已保存到 localStorage', currentOrderSummary);
      }
      
      // 隱藏所有標籤內容
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(content => {
        content.classList.remove('active');
      });
      
      // 移除所有按鈕的 active 狀態
      const tabButtons = document.querySelectorAll('.tab-button');
      tabButtons.forEach(button => {
        button.classList.remove('active');
      });
      
      // 顯示選中的標籤內容
      document.getElementById(tabName).classList.add('active');
      
      // 設置按鈕為 active
      if (event && event.target.classList.contains('tab-button')) {
        event.target.classList.add('active');
      } else {
        document.querySelector(`.tab-button[onclick*="${tabName}"]`).classList.add('active');
      }
      
      // 載入標籤內容
      loadTabContent(tabName);
    }
    
    /**
     * 顯示錯誤訊息
     */
    function showError(message) {
      document.getElementById('loadingContainer').style.display = 'none';
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('errorContainer').style.display = 'block';
      document.getElementById('errorMessage').textContent = message;
    }
    
    /**
     * 呼叫 API 並自動重試
     */
    async function callAPIWithRetry(action, data, retryCount = 0) {
      try {
        debugLog(`呼叫 API: ${action}`, data);
        
        if (!isOnline) {
          throw new Error('網路連線中斷');
        }
        
        const url = new URL(API_CONFIG.URL);
        url.searchParams.append('action', action);
        url.searchParams.append('data', JSON.stringify(data));
        
        const response = await fetch(url.toString(), {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP 錯誤: ${response.status}`);
        }
        
        const result = await response.json();
        debugLog(`API 回應: ${action}`, result);
        
        return result;
        
      } catch (error) {
        debugLog(`API 錯誤 (${action}): ${error.message}`);
        
        // 檢查是否需要重試
        if (retryCount < API_CONFIG.MAX_RETRIES) {
          debugLog(`重試 API 呼叫 (${retryCount + 1}/${API_CONFIG.MAX_RETRIES})`);
          
          // 等待一段時間後重試
          await new Promise(resolve => setTimeout(resolve, API_CONFIG.RETRY_DELAY));
          
          return callAPIWithRetry(action, data, retryCount + 1);
        }
        
        throw error;
      }
    }
    
    /**
     * 輸出除錯日誌
     */
    function debugLog(message, data) {
      if (window.debugMode) {
        if (data) {
          console.log(`[DEBUG] ${message}:`, data);
        } else {
          console.log(`[DEBUG] ${message}`);
        }
      }
    }
    
    // ==================== 工具類別 ====================
    
    /**
     * UI 管理器
     */
    const UIManager = {
      /**
       * 顯示 Toast 訊息
       */
      showToast: function(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast';
        toast.classList.add(type);
        toast.classList.add('show');
        
        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      },
      
      /**
       * 顯示載入中
       */
      showLoading: function(containerId, message = '載入中...') {
        const container = document.getElementById(containerId);
        container.innerHTML = `
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>${message}</p>
          </div>
        `;
      },
      
      /**
       * 顯示快取資訊
       */
      showCacheInfo: function(containerId, timestamp) {
        const container = document.getElementById(containerId);
        
        // 檢查是否已有快取資訊
        if (container.querySelector('.cache-info')) {
          return;
        }
        
        // 計算時間差
        const now = new Date();
        const cacheTime = new Date(timestamp);
        const diffMinutes = Math.floor((now - cacheTime) / (1000 * 60));
        
        let timeText = '';
        if (diffMinutes < 1) {
          timeText = '剛剛';
        } else if (diffMinutes < 60) {
          timeText = `${diffMinutes} 分鐘前`;
        } else {
          const diffHours = Math.floor(diffMinutes / 60);
          if (diffHours < 24) {
            timeText = `${diffHours} 小時前`;
          } else {
            const diffDays = Math.floor(diffHours / 24);
            timeText = `${diffDays} 天前`;
          }
        }
        
        // 建立快取資訊元素
        const cacheInfo = document.createElement('div');
        cacheInfo.className = 'cache-info';
        cacheInfo.innerHTML = `
          <span>⚠️ 離線模式：顯示 ${timeText} 的快取資料</span>
        `;
        
        container.appendChild(cacheInfo);
      }
    };
    
    /**
     * 快取管理器
     */
    const CacheManager = {
      /**
       * 設定快取
       */
      set: function(key, value, expiresInMinutes = 30) {
        try {
          const cacheItem = {
            value: value,
            expires: Date.now() + (expiresInMinutes * 60 * 1000)
          };
          
          localStorage.setItem(`cache_${key}`, JSON.stringify(cacheItem));
          debugLog(`快取已設定: ${key}`);
        } catch (error) {
          debugLog(`設定快取錯誤: ${error.message}`);
        }
      },
      
      /**
       * 取得快取
       */
      get: function(key) {
        try {
          const cacheItem = localStorage.getItem(`cache_${key}`);
          
          if (!cacheItem) {
            return null;
          }
          
          const { value, expires } = JSON.parse(cacheItem);
          
          if (Date.now() > expires) {
            this.remove(key);
            return null;
          }
          
          return value;
        } catch (error) {
          debugLog(`取得快取錯誤: ${error.message}`);
          return null;
        }
      },
      
      /**
       * 移除快取
       */
      remove: function(key) {
        try {
          localStorage.removeItem(`cache_${key}`);
          debugLog(`快取已移除: ${key}`);
        } catch (error) {
          debugLog(`移除快取錯誤: ${error.message}`);
        }
      },
      
      /**
       * 清除所有快取
       */
      clear: function() {
        try {
          const keysToRemove = [];
          
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            
            if (key.startsWith('cache_')) {
              keysToRemove.push(key);
            }
          }
          
          keysToRemove.forEach(key => localStorage.removeItem(key));
          debugLog(`已清除 ${keysToRemove.length} 個快取項目`);
        } catch (error) {
          debugLog(`清除快取錯誤: ${error.message}`);
        }
      }
    };
    
    /**
     * 表單驗證器
     */
    const FormValidator = {
      /**
       * 驗證真實姓名
       */
      validateRealName: function(name) {
        if (!name || name.trim() === '') {
          return { valid: false, message: '請輸入真實姓名' };
        }
        
        if (name.length < 2) {
          return { valid: false, message: '姓名至少需要2個字' };
        }
        
        if (name.length > 20) {
          return { valid: false, message: '姓名不可超過20個字' };
        }
        
        // 檢查特殊字元
        const invalidChars = /[<>"'&]/;
        if (invalidChars.test(name)) {
          return { valid: false, message: '姓名不可包含特殊字元' };
        }
        
        return { valid: true };
      },
      
      /**
       * 驗證電話號碼
       */
      validatePhone: function(phone) {
        if (!phone || phone.trim() === '') {
          return { valid: true }; // 電話是選填的
        }
        
        // 基本格式檢查
        const phoneRegex = /^[0-9\-\+\(\)\s]{8,15}$/;
        if (!phoneRegex.test(phone)) {
          return { valid: false, message: '請輸入有效的電話號碼格式' };
        }
        
        return { valid: true };
      },
      
      /**
       * 驗證繳費備註
       */
      validatePaymentNote: function(note) {
        if (!note || note.trim() === '') {
          return { valid: true }; // 備註是選填的
        }
        
        if (note.length > 200) {
          return { valid: false, message: '備註不可超過200個字' };
        }
        
        // 檢查危險字元
        const dangerousChars = /<script|javascript:|onerror=|onclick=|onload=/i;
        if (dangerousChars.test(note)) {
          return { valid: false, message: '備註包含不允許的內容' };
        }
        
        return { valid: true };
      }
    };
    
    /**
     * 產品資料處理器
     */
    const ProductDataProcessor = {
      /**
       * 計算訂單摘要
       */
      calculateSummary: function(products) {
        if (!products || !Array.isArray(products) || products.length === 0) {
          debugLog('無效的產品數據', products);
          return {
            productCount: 0,
            totalQuantity: 0,
            totalAmount: 0
          };
        }
        
        try {
          // 確保所有數值都是數字
          const processedProducts = products.map(product => {
            return {
              ...product,
              quantity: parseInt(product.quantity) || 0,
              unitPrice: parseFloat(product.unitPrice) || 0,
              totalPrice: parseFloat(product.totalPrice) || 0
            };
          });
          
          // 計算總數量和總金額
          const totalQuantity = processedProducts.reduce((sum, product) => sum + product.quantity, 0);
          const totalAmount = processedProducts.reduce((sum, product) => sum + product.totalPrice, 0);
          
          return {
            productCount: processedProducts.length,
            totalQuantity: totalQuantity,
            totalAmount: totalAmount
          };
        } catch (error) {
          debugLog('計算訂單摘要錯誤', error);
          return {
            productCount: products.length,
            totalQuantity: 0,
            totalAmount: 0
          };
        }
      }
    };
    
    // ==================== 事件監聽 ====================
    
    // 頁面載入完成後初始化
    window.addEventListener('DOMContentLoaded', function() {
      // 啟用除錯模式（開發時使用）
      window.debugMode = false;
      
      // 初始化應用程式
      initializeApp();
    });
    
    // 頁面關閉或重新整理前的處理
    window.addEventListener('beforeunload', function() {
      // 儲存重要資料到 localStorage
      if (currentOrderSummary) {
        localStorage.setItem('currentOrderSummary', JSON.stringify(currentOrderSummary));
      }
    });
  </script>
</body>
</html>


