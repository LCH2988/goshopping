<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LIFF 訂單管理系統</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          color: #333;
      }

      .container {
          max-width: 400px;
          margin: 0 auto;
          padding: 20px;
          min-height: 100vh;
          display: flex;
          flex-direction: column;
      }

      .header {
          text-align: center;
          margin-bottom: 30px;
          color: white;
      }

      .header h1 {
          font-size: 28px;
          margin-bottom: 10px;
          font-weight: 700;
      }

      .header p {
          opacity: 0.9;
          font-size: 16px;
      }

      .card {
          background: white;
          border-radius: 20px;
          padding: 30px;
          margin-bottom: 20px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.2);
          backdrop-filter: blur(10px);
      }

      .user-info {
          text-align: center;
          margin-bottom: 25px;
      }

      .user-avatar {
          width: 80px;
          height: 80px;
          border-radius: 50%;
          margin: 0 auto 15px;
          border: 4px solid #667eea;
          object-fit: cover;
      }

      .user-name {
          font-size: 20px;
          font-weight: 600;
          color: #333;
          margin-bottom: 5px;
      }

      .user-id {
          font-size: 14px;
          color: #666;
          font-family: monospace;
      }

      .section {
          display: none;
      }

      .section.active {
          display: block;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #555;
      }

      .form-control {
          width: 100%;
          padding: 15px;
          border: 2px solid #e1e5e9;
          border-radius: 12px;
          font-size: 16px;
          transition: all 0.3s ease;
          background: #f8f9fa;
      }

      .form-control:focus {
          outline: none;
          border-color: #667eea;
          background: white;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn {
          width: 100%;
          padding: 15px;
          border: none;
          border-radius: 12px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          text-transform: uppercase;
          letter-spacing: 0.5px;
      }

      .btn-primary {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
      }

      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
          background: #6c757d;
          color: white;
      }

      .btn-success {
          background: #28a745;
          color: white;
      }

      .btn-danger {
          background: #dc3545;
          color: white;
      }

      .btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
          transform: none !important;
      }

      .alert {
          padding: 15px;
          border-radius: 12px;
          margin-bottom: 20px;
          font-weight: 500;
      }

      .alert-success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }

      .alert-error {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }

      .alert-info {
          background: #d1ecf1;
          color: #0c5460;
          border: 1px solid #bee5eb;
      }

      .loading {
          display: none;
          text-align: center;
          padding: 20px;
      }

      .loading.show {
          display: block;
      }

      .spinner {
          width: 40px;
          height: 40px;
          border: 4px solid #f3f3f3;
          border-top: 4px solid #667eea;
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin: 0 auto 15px;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .orders-list {
          max-height: 400px;
          overflow-y: auto;
      }

      .order-item {
          background: #f8f9fa;
          border-radius: 12px;
          padding: 15px;
          margin-bottom: 15px;
          border-left: 4px solid #667eea;
      }

      .order-header {
          display: flex;
          justify-content: between;
          align-items: center;
          margin-bottom: 10px;
      }

      .order-id {
          font-weight: 600;
          color: #667eea;
      }

      .order-date {
          font-size: 12px;
          color: #666;
      }

      .order-details {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 10px;
          font-size: 14px;
      }

      .order-total {
          font-size: 18px;
          font-weight: 700;
          color: #28a745;
          text-align: right;
          margin-top: 10px;
      }

      .payment-methods {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
          margin-bottom: 20px;
      }

      .payment-method {
          padding: 15px;
          border: 2px solid #e1e5e9;
          border-radius: 12px;
          text-align: center;
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .payment-method:hover {
          border-color: #667eea;
      }

      .payment-method.selected {
          border-color: #667eea;
          background: rgba(102, 126, 234, 0.1);
      }

      .payment-method i {
          font-size: 24px;
          margin-bottom: 8px;
          display: block;
      }

      .summary-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border-radius: 15px;
          padding: 20px;
          margin-bottom: 20px;
      }

      .summary-row {
          display: flex;
          justify-content: space-between;
          margin-bottom: 10px;
      }

      .summary-total {
          font-size: 24px;
          font-weight: 700;
          border-top: 1px solid rgba(255,255,255,0.3);
          padding-top: 15px;
          margin-top: 15px;
      }

      .debug-info {
          background: #f8f9fa;
          border-radius: 8px;
          padding: 15px;
          margin-top: 20px;
          font-family: monospace;
          font-size: 12px;
          max-height: 200px;
          overflow-y: auto;
      }

      .nav-tabs {
          display: flex;
          background: rgba(255,255,255,0.1);
          border-radius: 12px;
          margin-bottom: 20px;
          overflow: hidden;
      }

      .nav-tab {
          flex: 1;
          padding: 12px;
          text-align: center;
          background: transparent;
          border: none;
          color: rgba(255,255,255,0.7);
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .nav-tab.active {
          background: white;
          color: #667eea;
          font-weight: 600;
      }

      .status-badge {
          display: inline-block;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 600;
      }

      .status-pending {
          background: #fff3cd;
          color: #856404;
      }

      .status-confirmed {
          background: #d4edda;
          color: #155724;
      }

      .status-rejected {
          background: #f8d7da;
          color: #721c24;
      }

      @media (max-width: 480px) {
          .container {
              padding: 15px;
          }
          
          .card {
              padding: 20px;
          }
          
          .payment-methods {
              grid-template-columns: 1fr;
          }
      }

      .fade-in {
          animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
      }
  </style>
</head>
<body>
  <div class="container">
      <!-- 標題區域 -->
      <div class="header">
          <h1><i class="fas fa-shopping-cart"></i> 訂單管理系統</h1>
          <p>LIFF 整合版本 v3.0</p>
      </div>

      <!-- 載入中畫面 -->
      <div id="loadingSection" class="loading show">
          <div class="card">
              <div class="spinner"></div>
              <p id="loadingText">正在初始化系統...</p>
          </div>
      </div>

      <!-- 用戶資訊區域 -->
      <div id="userInfoSection" class="section">
          <div class="card fade-in">
              <div class="user-info">
                  <img id="userAvatar" class="user-avatar" src="" alt="用戶頭像">
                  <div id="userName" class="user-name"></div>
                  <div id="userId" class="user-id"></div>
              </div>
          </div>
      </div>

      <!-- 用戶註冊區域 -->
      <div id="registerSection" class="section">
          <div class="card fade-in">
              <h2 style="text-align: center; margin-bottom: 25px; color: #667eea;">
                  <i class="fas fa-user-plus"></i> 用戶註冊
              </h2>
              
              <form id="registerForm">
                  <div class="form-group">
                      <label for="realName">
                          <i class="fas fa-user"></i> 真實姓名
                      </label>
                      <input type="text" id="realName" class="form-control" 
                             placeholder="請輸入您的真實姓名" required>
                      <small style="color: #666; font-size: 12px;">
                          此姓名將用於訂單查詢，請確保與訂單上的姓名一致
                      </small>
                  </div>
                  
                  <button type="submit" class="btn btn-primary">
                      <i class="fas fa-check"></i> 完成註冊
                  </button>
              </form>
          </div>
      </div>

      <!-- 主功能區域 -->
      <div id="mainSection" class="section">
          <!-- 導航標籤 -->
          <div class="nav-tabs">
              <button class="nav-tab active" onclick="showTab('orders')">
                  <i class="fas fa-list"></i> 我的訂單
              </button>
              <button class="nav-tab" onclick="showTab('payment')">
                  <i class="fas fa-credit-card"></i> 繳費
              </button>
          </div>

          <!-- 訂單標籤內容 -->
          <div id="ordersTab" class="tab-content">
              <div class="card fade-in">
                  <h3 style="margin-bottom: 20px; color: #667eea;">
                      <i class="fas fa-shopping-bag"></i> 我的訂單
                  </h3>
                  
                  <div id="ordersSummary" class="summary-card" style="display: none;">
                      <div class="summary-row">
                          <span>總訂單數：</span>
                          <span id="totalOrders">0</span>
                      </div>
                      <div class="summary-row">
                          <span>總金額：</span>
                          <span id="totalAmount">NT$ 0</span>
                      </div>
                  </div>
                  
                  <div id="ordersList" class="orders-list">
                      <!-- 訂單列表將在這裡動態載入 -->
                  </div>
                  
                  <button id="refreshOrdersBtn" class="btn btn-secondary" onclick="loadUserOrders()">
                      <i class="fas fa-sync-alt"></i> 重新整理
                  </button>
              </div>
          </div>

          <!-- 繳費標籤內容 -->
          <div id="paymentTab" class="tab-content" style="display: none;">
              <div class="card fade-in">
                  <h3 style="margin-bottom: 20px; color: #667eea;">
                      <i class="fas fa-money-bill-wave"></i> 繳費通知
                  </h3>
                  
                  <form id="paymentForm">
                      <div class="form-group">
                          <label>繳費方式</label>
                          <div class="payment-methods">
                              <div class="payment-method" data-method="bank_transfer">
                                  <i class="fas fa-university"></i>
                                  <div>銀行轉帳</div>
                              </div>
                              <div class="payment-method" data-method="atm">
                                  <i class="fas fa-credit-card"></i>
                                  <div>ATM 轉帳</div>
                              </div>
                          </div>
                      </div>

                      <div class="form-group">
                          <label for="paymentAmount">
                              <i class="fas fa-dollar-sign"></i> 繳費金額
                          </label>
                          <input type="number" id="paymentAmount" class="form-control" 
                                 placeholder="請輸入繳費金額" min="1" required>
                      </div>

                      <div class="form-group">
                          <label for="bankLastFive">
                              <i class="fas fa-hashtag"></i> 轉帳帳號後5碼
                          </label>
                          <input type="text" id="bankLastFive" class="form-control" 
                                 placeholder="請輸入轉帳帳號後5碼" maxlength="5" required>
                      </div>

                      <div class="form-group">
                          <label for="paymentNote">
                              <i class="fas fa-sticky-note"></i> 備註說明
                          </label>
                          <textarea id="paymentNote" class="form-control" rows="3" 
                                    placeholder="請輸入相關備註或說明"></textarea>
                      </div>

                      <button type="submit" class="btn btn-success">
                          <i class="fas fa-paper-plane"></i> 提交繳費通知
                      </button>
                  </form>
              </div>
          </div>
      </div>

      <!-- 管理員登入區域 -->
      <div id="adminLoginSection" class="section">
          <div class="card fade-in">
              <h2 style="text-align: center; margin-bottom: 25px; color: #dc3545;">
                  <i class="fas fa-shield-alt"></i> 管理員登入
              </h2>
              
              <form id="adminLoginForm">
                  <div class="form-group">
                      <label for="adminSecret">
                          <i class="fas fa-key"></i> 管理員密鑰
                      </label>
                      <input type="password" id="adminSecret" class="form-control" 
                             placeholder="請輸入管理員密鑰" required>
                  </div>
                  
                  <button type="submit" class="btn btn-danger">
                      <i class="fas fa-sign-in-alt"></i> 管理員登入
                  </button>
              </form>
          </div>
      </div>

      <!-- 管理員面板 -->
      <div id="adminPanelSection" class="section">
          <div class="nav-tabs">
              <button class="nav-tab active" onclick="showAdminTab('dashboard')">
                  <i class="fas fa-tachometer-alt"></i> 儀表板
              </button>
              <button class="nav-tab" onclick="showAdminTab('users')">
                  <i class="fas fa-users"></i> 用戶管理
              </button>
              <button class="nav-tab" onclick="showAdminTab('payments')">
                  <i class="fas fa-money-check"></i> 繳費管理
              </button>
          </div>

          <!-- 儀表板標籤 -->
          <div id="dashboardTab" class="tab-content">
              <div class="card fade-in">
                  <h3 style="margin-bottom: 20px; color: #667eea;">
                      <i class="fas fa-chart-line"></i> 系統儀表板
                  </h3>
                  <div id="dashboardContent">
                      <!-- 儀表板內容將在這裡載入 -->
                  </div>
              </div>
          </div>

          <!-- 用戶管理標籤 -->
          <div id="usersTab" class="tab-content" style="display: none;">
              <div class="card fade-in">
                  <h3 style="margin-bottom: 20px; color: #667eea;">
                      <i class="fas fa-user-cog"></i> 用戶管理
                  </h3>
                  <div id="usersContent">
                      <!-- 用戶列表將在這裡載入 -->
                  </div>
              </div>
          </div>

          <!-- 繳費管理標籤 -->
          <div id="paymentsTab" class="tab-content" style="display: none;">
              <div class="card fade-in">
                  <h3 style="margin-bottom: 20px; color: #667eea;">
                      <i class="fas fa-receipt"></i> 繳費管理
                  </h3>
                  <div id="paymentsContent">
                      <!-- 繳費記錄將在這裡載入 -->
                  </div>
              </div>
          </div>
      </div>

      <!-- 訊息顯示區域 -->
      <div id="messageArea"></div>

      <!-- 除錯資訊 -->
      <div id="debugInfo" class="debug-info" style="display: none;"></div>
  </div>

  <script>
      // ===== 系統配置 =====
      const CONFIG = {
          LIFF_ID: '1657285806-2bmkYWkN',
          API_BASE_URL: 'https://script.google.com/macros/s/AKfycbxC5LwZ6mRp3W8kDYLk5iZGxuxAvGw8yrrbNREJjt1juEYuxcRY1bDmg1BXyruhdzqv/exec',
          ADMIN_SECRET: 'admin_secret_2025_liff',
          DEBUG_MODE: true,
          VERSION: '3.0'
      };

      // ===== 全域變數 =====
      let liffData = {
          userId: null,
          displayName: null,
          pictureUrl: null,
          realName: null,
          isRegistered: false,
          isAdmin: false
      };

      let selectedPaymentMethod = null;
      let currentUserOrders = [];

      // ===== 系統初始化 =====
      document.addEventListener('DOMContentLoaded', function() {
          console.log('=== LIFF 訂單管理系統啟動 ===');
          console.log('啟動時間:', new Date().toLocaleString());
          console.log('版本:', CONFIG.VERSION);
          
          initializeLIFF();
      });

      async function initializeLIFF() {
          try {
              showLoading('正在初始化 LIFF...');
              
              if (CONFIG.LIFF_ID === 'YOUR_LIFF_ID_HERE') {
                  throw new Error('請設定正確的 LIFF_ID');
              }
              
              console.log('開始 LIFF 初始化...');
              await liff.init({ liffId: CONFIG.LIFF_ID });
              console.log('✅ LIFF 初始化成功');

              if (liff.isLoggedIn()) {
                  console.log('✅ 用戶已登入');
                  await handleUserLogin();
              } else {
                  console.log('❌ 用戶未登入，開始登入流程');
                  liff.login();
              }

          } catch (error) {
              console.error('❌ LIFF 初始化失敗:', error);
              showError('系統初始化失敗: ' + error.message);
              hideLoading();
          }
      }

      async function handleUserLogin() {
          try {
              showLoading('正在取得用戶資料...');
              
              const profile = await liff.getProfile();
              console.log('✅ 用戶資料取得成功:', profile);
              
              liffData.userId = profile.userId;
              liffData.displayName = profile.displayName;
              liffData.pictureUrl = profile.pictureUrl;
              
              // 顯示用戶資訊
              displayUserInfo();
              
              // 檢查用戶狀態
              const userStatus = await checkUserStatus();
              
              if (userStatus.isAdmin) {
                  liffData.isAdmin = true;
                  showAdminLoginSection();
              } else if (userStatus.isRegistered) {
                  liffData.isRegistered = true;
                  liffData.realName = userStatus.userInfo.realName;
                  showMainSection();
                  await loadUserOrders();
              } else {
                  showRegisterSection();
              }
              
          } catch (error) {
              console.error('❌ 用戶登入處理失敗:', error);
              showError('用戶登入失敗: ' + error.message);
          } finally {
              hideLoading();
          }
      }

      async function checkUserStatus() {
          try {
              console.log('檢查用戶狀態...');
              
              const requestData = {
                  action: 'user_login',
                  userId: liffData.userId,
                  displayName: liffData.displayName,
                  pictureUrl: liffData.pictureUrl
              };
              
              const result = await makeAPIRequest(requestData);
              
              if (result.success) {
                  return result.data;
              } else {
                  throw new Error(result.error?.message || '用戶狀態檢查失敗');
              }
              
          } catch (error) {
              console.error('❌ 檢查用戶狀態失敗:', error);
              throw error;
          }
      }

      // ===== API 請求處理 =====
      async function makeAPIRequest(requestData) {
          try {
              console.log('發送 API 請求:', requestData.action);
              
              const response = await fetch(CONFIG.API_BASE_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(requestData)
              });

              if (!response.ok) {
                  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }

              const result = await response.json();
              console.log('API 回應:', result);
              
              return result;
              
          } catch (error) {
              console.error('❌ API 請求失敗:', error);
              throw error;
          }
      }

      // ===== 用戶註冊處理 =====
      document.getElementById('registerForm').addEventListener('submit', async function(event) {
          event.preventDefault();
          
          try {
              const realName = document.getElementById('realName').value.trim();
              
              if (!realName) {
                  throw new Error('請輸入真實姓名');
              }
              
              if (realName.length < 2) {
                  throw new Error('真實姓名至少需要2個字元');
              }
              
              showLoading('註冊中...');
              
              const requestData = {
                  action: 'user_register',
                  userId: liffData.userId,
                  displayName: liffData.displayName,
                  realName: realName,
                  pictureUrl: liffData.pictureUrl
              };
              
              const result = await makeAPIRequest(requestData);
              
              if (result.success) {
                  showSuccess('註冊成功！');
                  
                  liffData.realName = realName;
                  liffData.isRegistered = true;
                  
                  setTimeout(() => {
                      showMainSection();
                      loadUserOrders();
                  }, 1500);
              } else {
                  throw new Error(result.error?.message || '註冊失敗');
              }
              
          } catch (error) {
              console.error('❌ 用戶註冊失敗:', error);
              showError(error.message);
          } finally {
              hideLoading();
          }
      });

      // ===== 訂單管理 =====
      async function loadUserOrders() {
          try {
              if (!liffData.realName) {
                  throw new Error('缺少用戶真實姓名');
              }
              
              showLoading('載入訂單資料...');
              
              const requestData = {
                  action: 'user_get_orders',
                  userId: liffData.userId,
                  realName: liffData.realName
              };
              
              const result = await makeAPIRequest(requestData);
              
              if (result.success) {
                  currentUserOrders = result.data.orders;
                  displayOrders(result.data.orders);
                  updateOrderSummary(result.data.orders);
              } else {
                  throw new Error(result.error?.message || '載入訂單失敗');
              }
              
          } catch (error) {
              console.error('❌ 載入訂單失敗:', error);
              showError(error.message);
          } finally {
              hideLoading();
          }
      }

      function displayOrders(orders) {
          const ordersList = document.getElementById('ordersList');
          
          if (orders.length === 0) {
              ordersList.innerHTML = `
                  <div style="text-align: center; padding: 40px; color: #666;">
                      <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                      <p>目前沒有訂單記錄</p>
                  </div>
              `;
              return;
          }
          
          ordersList.innerHTML = orders.map(order => `
              <div class="order-item">
                  <div class="order-header">
                      <span class="order-id">${order.orderId}</span>
                      <span class="order-date">${formatDate(order.orderDate)}</span>
                  </div>
                  <div class="order-details">
                      <div><strong>產品：</strong>${order.productName}</div>
                      <div><strong>數量：</strong>${order.quantity}</div>
                      <div><strong>單價：</strong>NT$ ${formatNumber(order.unitPrice)}</div>
                      <div><strong>狀態：</strong><span class="status-badge status-${getStatusClass(order.status)}">${order.status}</span></div>
                  </div>
                  <div class="order-total">總計：NT$ ${formatNumber(order.total)}</div>
              </div>
          `).join('');
      }

      function updateOrderSummary(orders) {
          const summaryCard = document.getElementById('ordersSummary');
          const totalOrders = document.getElementById('totalOrders');
          const totalAmount = document.getElementById('totalAmount');
          
          const total = orders.reduce((sum, order) => sum + parseFloat(order.total || 0), 0);
          
          totalOrders.textContent = orders.length;
          totalAmount.textContent = 'NT$ ' + formatNumber(total);
          
          summaryCard.style.display = orders.length > 0 ? 'block' : 'none';
      }

      // ===== 繳費處理 =====
      // 繳費方式選擇
      document.querySelectorAll('.payment-method').forEach(method => {
          method.addEventListener('click', function() {
              document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
              this.classList.add('selected');
              selectedPaymentMethod = this.dataset.method;
          });
      });

      // 繳費表單提交
      document.getElementById('paymentForm').addEventListener('submit', async function(event) {
          event.preventDefault();
          
          try {
              if (!selectedPaymentMethod) {
                  throw new Error('請選擇繳費方式');
              }
              
              const amount = document.getElementById('paymentAmount').value;
              const bankLastFive = document.getElementById('bankLastFive').value;
              const note = document.getElementById('paymentNote').value;
              
              if (!amount || amount <= 0) {
                  throw new Error('請輸入有效的繳費金額');
              }
              
              if (!bankLastFive || bankLastFive.length !== 5) {
                  throw new Error('請輸入正確的帳號後5碼');
              }
              
              showLoading('提交繳費通知...');
              
              const requestData = {
                  action: 'user_submit_payment',
                  userId: liffData.userId,
                  realName: liffData.realName,
                  paymentMethod: selectedPaymentMethod,
                  totalAmount: parseFloat(amount),
                  paymentNote: note,
                  bankLastFive: bankLastFive
              };
              
              const result = await makeAPIRequest(requestData);
              
              if (result.success) {
                  showSuccess('繳費通知提交成功！管理員將盡快確認。');
                  
                  // 重置表單
                  document.getElementById('paymentForm').reset();
                  document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                  selectedPaymentMethod = null;
                  
              } else {
                  throw new Error(result.error?.message || '繳費通知提交失敗');
              }
              
          } catch (error) {
              console.error('❌ 繳費提交失敗:', error);
              showError(error.message);
          } finally {
              hideLoading();
          }
      });

      // ===== 管理員功能 =====
      document.getElementById('adminLoginForm').addEventListener('submit', async function(event) {
          event.preventDefault();
          
          try {
              const secretKey = document.getElementById('adminSecret').value;
              
              if (!secretKey) {
                  throw new Error('請輸入管理員密鑰');
              }
              
              showLoading('驗證管理員身分...');
              
              const requestData = {
                  action: 'admin_login',
                  userId: liffData.userId,
                  displayName: liffData.displayName,
                  secretKey: secretKey
              };
              
              const result = await makeAPIRequest(requestData);
              
              if (result.success) {
                  showSuccess('管理員登入成功！');
                  
                  setTimeout(() => {
                      showAdminPanelSection();
                      loadAdminDashboard();
                  }, 1500);
              } else {
                  throw new Error(result.error?.message || '管理員登入失敗');
              }
              
          } catch (error) {
              console.error('❌ 管理員登入失敗:', error);
              showError(error.message);
          } finally {
              hideLoading();
          }
      });

      async function loadAdminDashboard() {
          try {
              showLoading('載入儀表板資料...');
              
              const requestData = {
                  action: 'admin_get_dashboard',
                  adminUserId: liffData.userId,
                  adminDisplayName: liffData.displayName
              };
              
              const result = await makeAPIRequest(requestData);
              
              if (result.success) {
                  displayDashboard(result.data);
              } else {
                  throw new Error(result.error?.message || '載入儀表板失敗');
              }
              
          } catch (error) {
              console.error('❌ 載入儀表板失敗:', error);
              showError(error.message);
          } finally {
              hideLoading();
          }
      }

      function displayDashboard(data) {
          const dashboardContent = document.getElementById('dashboardContent');
          
          dashboardContent.innerHTML = `
              <div class="summary-card">
                  <h4 style="margin-bottom: 15px;"><i class="fas fa-chart-bar"></i> 系統統計</h4>
                  <div class="summary-row">
                      <span>總用戶數：</span>
                      <span>${data.summary.totalUsers}</span>
                  </div>
                  <div class="summary-row">
                      <span>總訂單數：</span>
                      <span>${data.summary.totalOrders}</span>
                  </div>
                  <div class="summary-row">
                      <span>總繳費記錄：</span>
                      <span>${data.summary.totalPayments}</span>
                  </div>
                  <div class="summary-row">
                      <span>待處理繳費：</span>
                      <span style="color: #ffc107;">${data.summary.pendingPayments}</span>
                  </div>
                  <div class="summary-total">
                      <div class="summary-row">
                          <span>總確認金額：</span>
                          <span>NT$ ${formatNumber(data.statistics.totalAmount)}</span>
                      </div>
                  </div>
              </div>
              
              <div style="margin-top: 20px;">
                  <h4 style="margin-bottom: 15px;"><i class="fas fa-clock"></i> 最近活動</h4>
                  <div style="font-size: 14px; color: #666;">
                      <p>今日新註冊用戶：${data.statistics.todayRegistrations} 位</p>
                      <p>最近用戶：${data.recentUsers.slice(0, 3).map(u => u.realName).join(', ')}</p>
                  </div>
              </div>
          `;
      }

      // ===== UI 控制函數 =====
      function showSection(sectionId) {
          document.querySelectorAll('.section').forEach(section => {
              section.classList.remove('active');
          });
          document.getElementById(sectionId).classList.add('active');
      }

      function showRegisterSection() {
          showSection('registerSection');
          document.getElementById('userInfoSection').classList.add('active');
      }

      function showMainSection() {
          showSection('mainSection');
          document.getElementById('userInfoSection').classList.add('active');
      }

      function showAdminLoginSection() {
          showSection('adminLoginSection');
          document.getElementById('userInfoSection').classList.add('active');
      }

      function showAdminPanelSection() {
          showSection('adminPanelSection');
          document.getElementById('userInfoSection').classList.add('active');
      }

      function showTab(tabName) {
          document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
          
          event.target.classList.add('active');
          document.getElementById(tabName + 'Tab').style.display = 'block';
      }

      function showAdminTab(tabName) {
          document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
          
          event.target.classList.add('active');
          document.getElementById(tabName + 'Tab').style.display = 'block';
          
          // 載入對應的管理員資料
          if (tabName === 'users') {
              loadAdminUsers();
          } else if (tabName === 'payments') {
              loadAdminPayments();
          }
      }

      async function loadAdminUsers() {
          try {
              showLoading('載入用戶資料...');
              
              const requestData = {
                  action: 'admin_get_users',
                  adminUserId: liffData.userId,
                  adminDisplayName: liffData.displayName
              };
              
              const result = await makeAPIRequest(requestData);
              
              if (result.success) {
                  displayAdminUsers(result.data.users);
              } else {
                  throw new Error(result.error?.message || '載入用戶資料失敗');
              }
              
          } catch (error) {
              console.error('❌ 載入用戶資料失敗:', error);
              showError(error.message);
          } finally {
              hideLoading();
          }
      }

      function displayAdminUsers(users) {
          const usersContent = document.getElementById('usersContent');
          
          if (users.length === 0) {
              usersContent.innerHTML = '<p style="text-align: center; color: #666;">目前沒有註冊用戶</p>';
              return;
          }
          
          usersContent.innerHTML = users.map(user => `
              <div class="order-item">
                  <div class="order-header">
                      <span class="order-id">${user.realName}</span>
                      <span class="order-date">${formatDate(user.registerTime)}</span>
                  </div>
                  <div class="order-details">
                      <div><strong>LINE名稱：</strong>${user.displayName}</div>
                      <div><strong>最後登入：</strong>${formatDate(user.lastLogin)}</div>
                  </div>
              </div>
          `).join('');
      }

      async function loadAdminPayments() {
          try {
              showLoading('載入繳費資料...');
              
              const requestData = {
                  action: 'admin_get_payments',
                  adminUserId: liffData.userId,
                  adminDisplayName: liffData.displayName
              };
              
              const result = await makeAPIRequest(requestData);
              
              if (result.success) {
                  displayAdminPayments(result.data.payments);
              } else {
                  throw new Error(result.error?.message || '載入繳費資料失敗');
              }
              
          } catch (error) {
              console.error('❌ 載入繳費資料失敗:', error);
              showError(error.message);
          } finally {
              hideLoading();
          }
      }

      function displayAdminPayments(payments) {
          const paymentsContent = document.getElementById('paymentsContent');
          
          if (payments.length === 0) {
              paymentsContent.innerHTML = '<p style="text-align: center; color: #666;">目前沒有繳費記錄</p>';
              return;
          }
          
          paymentsContent.innerHTML = payments.map(payment => `
              <div class="order-item">
                  <div class="order-header">
                      <span class="order-id">${payment.paymentId}</span>
                      <span class="status-badge status-${getStatusClass(payment.status)}">${payment.status}</span>
                  </div>
                  <div class="order-details">
                      <div><strong>用戶：</strong>${payment.realName}</div>
                      <div><strong>金額：</strong>NT$ ${formatNumber(payment.amount)}</div>
                      <div><strong>方式：</strong>${getPaymentMethodText(payment.paymentMethod)}</div>
                      <div><strong>帳號後5碼：</strong>${payment.bankLastFive}</div>
                  </div>
                  <div style="margin-top: 10px; font-size: 12px; color: #666;">
                      提交時間：${formatDate(payment.submitTime)}
                  </div>
                  ${payment.status === '待確認' ? `
                      <div style="margin-top: 15px; display: flex; gap: 10px;">
                          <button class="btn btn-success" style="flex: 1; padding: 8px;" 
                                  onclick="updatePaymentStatus('${payment.paymentId}', '已確認')">
                              確認
                          </button>
                          <button class="btn btn-danger" style="flex: 1; padding: 8px;" 
                                  onclick="updatePaymentStatus('${payment.paymentId}', '已拒絕')">
                              拒絕
                          </button>
                      </div>
                  ` : ''}
              </div>
          `).join('');
      }

      async function updatePaymentStatus(paymentId, status) {
          try {
              showLoading('更新繳費狀態...');
              
              const requestData = {
                  action: 'admin_update_payment_status',
                  adminUserId: liffData.userId,
                  adminDisplayName: liffData.displayName,
                  paymentId: paymentId,
                  status: status
              };
              
              const result = await makeAPIRequest(requestData);
              
              if (result.success) {
                  showSuccess('繳費狀態更新成功！');
                  loadAdminPayments(); // 重新載入繳費資料
              } else {
                  throw new Error(result.error?.message || '更新繳費狀態失敗');
              }
              
          } catch (error) {
              console.error('❌ 更新繳費狀態失敗:', error);
              showError(error.message);
          } finally {
              hideLoading();
          }
      }

      // ===== 輔助函數 =====
      function displayUserInfo() {
          document.getElementById('userAvatar').src = liffData.pictureUrl || 'https://via.placeholder.com/80';
          document.getElementById('userName').textContent = liffData.displayName;
          document.getElementById('userId').textContent = liffData.userId;
      }

      function formatDate(dateString) {
          if (!dateString) return '-';
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-TW') + ' ' + date.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
      }

      function formatNumber(number) {
          return new Intl.NumberFormat('zh-TW').format(number);
      }

      function getStatusClass(status) {
          switch (status) {
              case '待確認': return 'pending';
              case '已確認': return 'confirmed';
              case '已拒絕': return 'rejected';
              default: return 'pending';
          }
      }

      function getPaymentMethodText(method) {
          switch (method) {
              case 'bank_transfer': return '銀行轉帳';
              case 'atm': return 'ATM轉帳';
              default: return method;
          }
      }

      // ===== 訊息顯示函數 =====
      function showMessage(message, type = 'info') {
          const messageArea = document.getElementById('messageArea');
          const messageDiv = document.createElement('div');
          messageDiv.className = `alert alert-${type} fade-in`;
          messageDiv.innerHTML = `
              <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
              ${message}
          `;
          
          messageArea.appendChild(messageDiv);
          
          setTimeout(() => {
              messageDiv.remove();
          }, 5000);
      }

      function showSuccess(message) {
          showMessage(message, 'success');
      }

      function showError(message) {
          showMessage(message, 'error');
      }

      function showInfo(message) {
          showMessage(message, 'info');
      }

      function showLoading(text = '載入中...') {
          document.getElementById('loadingText').textContent = text;
          document.getElementById('loadingSection').classList.add('show');
      }

      function hideLoading() {
          document.getElementById('loadingSection').classList.remove('show');
      }

      // ===== 除錯功能 =====
      if (CONFIG.DEBUG_MODE) {
          console.log('✅ 除錯模式已啟用');
          
          // 顯示除錯資訊
          setInterval(() => {
              const debugInfo = document.getElementById('debugInfo');
              debugInfo.innerHTML = `
                  <strong>除錯資訊 (${new Date().toLocaleTimeString()})</strong><br>
                  用戶ID: ${liffData.userId || 'N/A'}<br>
                  顯示名稱: ${liffData.displayName || 'N/A'}<br>
                  真實姓名: ${liffData.realName || 'N/A'}<br>
                  已註冊: ${liffData.isRegistered}<br>
                  管理員: ${liffData.isAdmin}<br>
                  繳費方式: ${selectedPaymentMethod || 'N/A'}<br>
                  訂單數量: ${currentUserOrders.length}<br>
                  API URL: ${CONFIG.API_BASE_URL}<br>
                  LIFF ID: ${CONFIG.LIFF_ID}
              `;
              debugInfo.style.display = 'block';
          }, 2000);
      }

      // ===== 系統腳本載入完成 =====
      console.log('✅ LIFF 管理員系統腳本載入完成');
  </script>
</body>
</html>
              
