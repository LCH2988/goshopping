<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BOGO管理系統</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
  <!-- DataTables CSS -->
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <!-- 自定義CSS -->
  <style>
    /* 側邊欄 */
    .sidebar {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      z-index: 100;
      padding: 48px 0 0;
      box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
      background-color: #f8f9fa;
    }
    
    .sidebar-sticky {
      position: relative;
      top: 0;
      height: calc(100vh - 48px);
      padding-top: .5rem;
      overflow-x: hidden;
      overflow-y: auto;
    }
    
    .sidebar .nav-link {
      font-weight: 500;
      color: #333;
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      margin: 0.2rem 0.5rem;
    }
    
    .sidebar .nav-link:hover {
      background-color: rgba(0, 0, 0, .05);
    }
    
    .sidebar .nav-link.active {
      color: #fff;
      background-color: #0d6efd;
    }
    
    .sidebar .nav-link .bi {
      margin-right: 0.5rem;
    }
    
    /* 主內容區 */
    .main-content {
      margin-left: 240px;
      padding: 48px 20px 20px;
    }
    
    @media (max-width: 767.98px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        padding: 0;
      }
      
      .main-content {
        margin-left: 0;
        padding-top: 20px;
      }
    }
    
    /* 導航欄 */
    .navbar {
      padding: 0.5rem 1rem;
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      z-index: 1030;
    }
    
    /* 組織架構表格 */
    .org-structure-table .member-avatar {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    .org-structure-table .toggle-btn {
      padding: 0.1rem 0.25rem;
      font-size: 0.75rem;
    }
    
    /* 步驟指示器 */
    .steps {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    
    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
    }
    
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    .step.active .step-circle {
      background-color: #0d6efd;
      color: white;
    }
    
    .step-line {
      flex: 1;
      height: 2px;
      background-color: #e9ecef;
      margin: 0 1rem;
      position: relative;
      top: -20px;
      z-index: 0;
    }
    
    .step-text {
      font-size: 0.875rem;
      color: #6c757d;
    }
    
    .step.active .step-text {
      color: #0d6efd;
      font-weight: bold;
    }
    
    /* 卡片 */
    .card {
      margin-bottom: 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .card-header {
      border-radius: 0.5rem 0.5rem 0 0 !important;
      padding: 0.75rem 1.25rem;
    }
    
    /* 儀表板卡片 */
    .dashboard-card {
      border-left: 4px solid #0d6efd;
      transition: transform 0.2s;
    }
    
    .dashboard-card:hover {
      transform: translateY(-5px);
    }
    
    .dashboard-card .card-body {
      padding: 1.25rem;
    }
    
    .dashboard-card .card-title {
      color: #6c757d;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    
    .dashboard-card .card-value {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0;
    }
    
    .dashboard-card .card-icon {
      font-size: 2rem;
      color: rgba(13, 110, 253, 0.2);
    }
    
    /* 載入中動畫 */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
  </style>
</head>
<body>
  <!-- 載入中動畫 -->
  <div class="loading" id="loadingIndicator">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">載入中...</span>
    </div>
  </div>
  
  <!-- 頂部導航欄 -->
  <nav class="navbar navbar-expand-md navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">BOGO管理系統</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="#" id="refreshDataBtn">
              <i class="bi bi-arrow-clockwise"></i> 重新整理
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="settingsBtn">
              <i class="bi bi-gear"></i> 設定
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  
  <!-- 側邊欄 -->
  <div class="sidebar col-md-3 col-lg-2 d-md-block">
    <div class="sidebar-sticky">
      <ul class="nav flex-column">
        <li class="nav-item">
          <a class="nav-link active" href="#dashboard" data-bs-toggle="tab">
            <i class="bi bi-speedometer2"></i> 儀表板
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#organizationStructure" data-bs-toggle="tab">
            <i class="bi bi-diagram-3"></i> 組織架構
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#bogoTeam" data-bs-toggle="tab">
            <i class="bi bi-people"></i> BOGO團隊
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#buyerManagement" data-bs-toggle="tab">
            <i class="bi bi-person-badge"></i> 搶購員管理
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#taskAssignment" data-bs-toggle="tab">
            <i class="bi bi-list-check"></i> 任務分配
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#taskManagement" data-bs-toggle="tab">
            <i class="bi bi-clipboard-check"></i> 任務管理
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#reports" data-bs-toggle="tab">
            <i class="bi bi-bar-chart"></i> 報表分析
          </a>
        </li>
      </ul>
    </div>
  </div>
  
  <!-- 主內容區 -->
  <main class="main-content">
    <div class="tab-content">
      <!-- 儀表板 -->
      <div class="tab-pane fade show active" id="dashboard">
        <h2 class="mb-4">儀表板</h2>
        
        <div class="row">
          <div class="col-md-3 mb-4">
            <div class="card dashboard-card">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="card-title">總成員數</h6>
                  <h2 class="card-value" id="totalMembersValue">--</h2>
                </div>
                <div class="card-icon">
                  <i class="bi bi-people"></i>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-3 mb-4">
            <div class="card dashboard-card">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="card-title">BOGO團隊成員</h6>
                  <h2 class="card-value" id="bogoTeamMembersValue">--</h2>
                </div>
                <div class="card-icon">
                  <i class="bi bi-person-check"></i>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-3 mb-4">
            <div class="card dashboard-card">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="card-title">進行中任務</h6>
                  <h2 class="card-value" id="activeTasksValue">--</h2>
                </div>
                <div class="card-icon">
                  <i class="bi bi-clipboard-data"></i>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-3 mb-4">
            <div class="card dashboard-card">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="card-title">總BOGO配額PV</h6>
                  <h2 class="card-value" id="totalBogoPVValue">--</h2>
                </div>
                <div class="card-icon">
                  <i class="bi bi-graph-up"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6 mb-4">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">最新任務</h5>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover table-striped mb-0" id="recentTasksTable">
                    <thead>
                      <tr>
                        <th>任務ID</th>
                        <th>產品名稱</th>
                        <th>BOGO帳號</th>
                        <th>分配數量</th>
                        <th>狀態</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- 動態生成 -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6 mb-4">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">BOGO團隊PV排行</h5>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover table-striped mb-0" id="bogoPVRankTable">
                    <thead>
                      <tr>
                        <th>排名</th>
                        <th>成員</th>
                        <th>BOGO帳號</th>
                        <th>BOGO配額PV</th>
                        <th>個人總PV</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- 動態生成 -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 組織架構 -->
      <div class="tab-pane fade" id="organizationStructure">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>組織架構</h2>
          <div>
            <button class="btn btn-outline-primary me-2" id="expandAllBtn">
              <i class="bi bi-arrows-expand"></i> 全部展開
            </button>
            <button class="btn btn-outline-secondary" id="collapseAllBtn">
              <i class="bi bi-arrows-collapse"></i> 全部收合
            </button>
          </div>
        </div>
        
        <div class="card">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover table-striped mb-0" id="orgStructureTable">
                <thead>
                  <tr class="bg-light">
                    <th style="width: 5%">層級</th>
                    <th style="width: 20%">成員資訊</th>
                    <th style="width: 10%">個人PV</th>
                    <th style="width: 10%">團隊PV</th>
                    <th style="width: 10%">BOGO配額PV</th>
                    <th style="width: 10%">個人總PV</th>
                    <th style="width: 8%">下線人數</th>
                    <th style="width: 8%">狀態</th>
                    <th style="width: 10%">BOGO團隊</th>
                    <th style="width: 9%">操作</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- 動態生成 -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- BOGO團隊 -->
      <div class="tab-pane fade" id="bogoTeam">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>BOGO團隊管理</h2>
          <button class="btn btn-primary" id="saveBogoTeamBtn">
            <i class="bi bi-save"></i> 儲存變更
          </button>
        </div>
        
        <div class="card mb-4">
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="input-group">
                  <input type="text" class="form-control" placeholder="搜尋成員..." id="searchBogoMember">
                  <button class="btn btn-outline-secondary" type="button" id="searchBogoMemberBtn">搜尋</button>
                </div>
              </div>
              <div class="col-md-6 text-end">
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-outline-primary" id="selectAllBogoBtn">全選</button>
                  <button type="button" class="btn btn-outline-secondary" id="deselectAllBogoBtn">取消全選</button>
                </div>
              </div>
            </div>
            
            <div class="table-responsive">
              <table class="table table-hover table-striped" id="bogoTeamTable">
                <thead>
                  <tr>
                    <th style="width: 5%">選擇</th>
                    <th style="width: 10%">成員ID</th>
                    <th style="width: 15%">姓名</th>
                    <th style="width: 15%">BOGO帳號</th>
                    <th style="width: 15%">卡號</th>
                    <th style="width: 10%">個人PV</th>
                    <th style="width: 10%">BOGO配額PV</th>
                    <th style="width: 10%">個人總PV</th>
                    <th style="width: 10%">操作</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- 動態生成 -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 搶購員管理 -->
      <div class="tab-pane fade" id="buyerManagement">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>搶購員管理</h2>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBuyerModal">
            <i class="bi bi-plus-circle"></i> 新增搶購員
          </button>
        </div>
        
        <div class="card">
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="input-group">
                  <input type="text" class="form-control" placeholder="搜尋搶購員..." id="searchBuyer">
                  <button class="btn btn-outline-secondary" type="button" id="searchBuyerBtn">搜尋</button>
                </div>
              </div>
              <div class="col-md-6 text-end">
                <button type="button" class="btn btn-outline-primary" id="exportBuyersBtn">
                  <i class="bi bi-download"></i> 匯出列表
                </button>
              </div>
            </div>
            
            <div class="table-responsive">
              <table class="table table-hover table-striped" id="buyersTable">
                <thead>
                  <tr>
                    <th style="width: 5%">ID</th>
                    <th style="width: 15%">姓名</th>
                    <th style="width: 15%">聯絡方式</th>
                    <th style="width: 25%">可配合日期</th>
                    <th style="width: 10%">狀態</th>
                    <th style="width: 20%">備註</th>
                    <th style="width: 10%">操作</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- 動態生成 -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 任務分配 -->
      <div class="tab-pane fade" id="taskAssignment">
        <h2 class="mb-4">搶購任務分配</h2>
        
        <div class="card">
          <div class="card-body">
            <!-- 步驟指示器 -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="steps">
                  <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-text">選擇產品</div>
                  </div>
                  <div class="step-line"></div>
                  <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-text">指定BOGO帳號</div>
                  </div>
                  <div class="step-line"></div>
                  <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-text">確認派發</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 步驟1：選擇產品 -->
            <div class="step-content active" id="step1Content">
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="input-group">
                    <input type="text" class="form-control" placeholder="搜尋產品..." id="searchProduct">
                    <button class="btn btn-outline-secondary" type="button" id="searchProductBtn">搜尋</button>
                  </div>
                </div>
              </div>
              
              <div class="table-responsive">
                <table class="table table-hover table-striped" id="productsTable">
                  <thead>
                    <tr>
                      <th style="width: 5%">選擇</th>
                      <th style="width: 10%">產品代號</th>
                      <th style="width: 20%">產品名稱</th>
                      <th style="width: 10%">單價</th>
                      <th style="width: 10%">PV數</th>
                      <th style="width: 15%">需搶購數量</th>
                      <th style="width: 15%">已分配數量</th>
                      <th style="width: 15%">剩餘數量</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- 動態生成 -->
                  </tbody>
                </table>
              </div>
              
              <div class="text-end mt-3">
                <button class="btn btn-primary" id="nextToStep2Btn">下一步</button>
              </div>
            </div>
            
            <!-- 步驟2：指定BOGO帳號 -->
            <div class="step-content" id="step2Content" style="display: none;">
              <div class="row mb-4">
                <div class="col-md-12">
                  <div class="card bg-light">
                    <div class="card-body">
                      <h6 class="card-title">已選擇產品</h6>
                      <div class="row">
                        <div class="col-md-3">
                          <p class="mb-1"><strong>產品代號:</strong> <span id="selectedProductCode">--</span></p>
                        </div>
                        <div class="col-md-3">
                          <p class="mb-1"><strong>產品名稱:</strong> <span id="selectedProductName">--</span></p>
                        </div>
                        <div class="col-md-2">
                          <p class="mb-1"><strong>單價:</strong> <span id="selectedProductPrice">--</span></p>
                        </div>
                        <div class="col-md-2">
                          <p class="mb-1"><strong>PV數:</strong> <span id="selectedProductPV">--</span></p>
                        </div>
                        <div class="col-md-2">
                          <p class="mb-1"><strong>剩餘數量:</strong> <span id="selectedProductRemaining">--</span></p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="input-group">
                    <input type="text" class="form-control" placeholder="搜尋BOGO帳號..." id="searchBogoAccount">
                    <button class="btn btn-outline-secondary" type="button" id="searchBogoAccountBtn">搜尋</button>
                  </div>
                </div>
                <div class="col-md-6 text-end">
                  <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#assignTaskModal">
                    <i class="bi bi-plus-circle"></i> 新增分配
                  </button>
                </div>
              </div>
              
              <div class="table-responsive mb-4">
                <table class="table table-hover table-striped" id="assignedTasksTable">
                  <thead>
                    <tr>
                      <th style="width: 10%">BOGO帳號</th>
                      <th style="width: 15%">姓名</th>
                      <th style="width: 10%">個人PV</th>
                      <th style="width: 10%">BOGO配額PV</th>
                      <th style="width: 10%">個人總PV</th>
                      <th style="width: 15%">分配數量</th>
                      <th style="width: 15%">搶購人員</th>
                      <th style="width: 15%">操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- 動態生成 -->
                  </tbody>
                  <tfoot>
                    <tr class="table-primary">
                      <td colspan="5" class="text-end"><strong>總計:</strong></td>
                      <td id="totalAssignedQuantity"><strong>0</strong></td>
                      <td colspan="2"></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
              
              <div class="text-end mt-3">
                <button class="btn btn-secondary me-2" id="backToStep1Btn">上一步</button>
                <button class="btn btn-primary" id="nextToStep3Btn">下一步</button>
              </div>
            </div>
            
            <!-- 步驟3：確認派發 -->
            <div class="step-content" id="step3Content" style="display: none;">
              <div class="row mb-4">
                <div class="col-md-12">
                  <div class="card bg-light">
                    <div class="card-body">
                      <h6 class="card-title">搶購任務確認</h6>
                      <div class="row">
                        <div class="col-md-4">
                          <p class="mb-1"><strong>產品代號:</strong> <span id="confirmProductCode">--</span></p>
                          <p class="mb-1"><strong>產品名稱:</strong> <span id="confirmProductName">--</span></p>
                        </div>
                        <div class="col-md-4">
                          <p class="mb-1"><strong>單價:</strong> <span id="confirmProductPrice">--</span></p>
                          <p class="mb-1"><strong>PV數:</strong> <span id="confirmProductPV">--</span></p>
                        </div>
                        <div class="col-md-4">
                          <p class="mb-1"><strong>需搶購數量:</strong> <span id="confirmTotalQuantity">--</span></p>
                          <p class="mb-1"><strong>本次分配數量:</strong> <span id="confirmAssignedQuantity">--</span></p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="table-responsive mb-4">
                <table class="table table-hover table-striped" id="confirmTasksTable">
                  <thead>
                    <tr>
                      <th style="width: 10%">BOGO帳號</th>
                      <th style="width: 15%">姓名</th>
                      <th style="width: 15%">分配數量</th>
                      <th style="width: 15%">預估PV</th>
                      <th style="width: 15%">搶購人員</th>
                      <th style="width: 15%">聯絡方式</th>
                      <th style="width: 15%">備註</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- 動態生成 -->
                  </tbody>
                  <tfoot>
                    <tr class="table-primary">
                      <td colspan="2" class="text-end"><strong>總計:</strong></td>
                      <td id="confirmTotalQuantityFooter"><strong>0</strong></td>
                      <td id="confirmTotalPVFooter"><strong>0</strong></td>
                      <td colspan="3"></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
              
              <div class="text-end mt-3">
                <button class="btn btn-secondary me-2" id="backToStep2Btn">上一步</button>
                <button class="btn btn-success me-2" id="exportTaskBtn">匯出任務清單</button>
                <button class="btn btn-primary" id="confirmTaskBtn">確認派發</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 任務管理 -->
      <div class="tab-pane fade" id="taskManagement">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>任務管理</h2>
          <div>
            <button class="btn btn-outline-primary me-2" id="exportTasksBtn">
              <i class="bi bi-download"></i> 匯出任務
            </button>
            <div class="btn-group">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-filter"></i> 狀態篩選
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item task-filter active" href="#" data-filter="all">全部</a></li>
                <li><a class="dropdown-item task-filter" href="#" data-filter="待處理">待處理</a></li>
                <li><a class="dropdown-item task-filter" href="#" data-filter="進行中">進行中</a></li>
                <li><a class="dropdown-item task-filter" href="#" data-filter="已完成">已完成</a></li>
              </ul>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="input-group">
                  <input type="text" class="form-control" placeholder="搜尋任務..." id="searchTask">
                  <button class="btn btn-outline-secondary" type="button" id="searchTaskBtn">搜尋</button>
                </div>
              </div>
            </div>
            
            <div class="table-responsive">
              <table class="table table-hover table-striped" id="tasksTable">
                <thead>
                  <tr>
                    <th>任務ID</th>
                    <th>產品</th>
                    <th>BOGO帳號</th>
                    <th>姓名</th>
                    <th>搶購員</th>
                    <th>分配數量</th>
                    <th>回報數量</th>
                    <th>狀態</th>
                    <th>分配日期</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- 動態生成 -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 報表分析 -->
      <div class="tab-pane fade" id="reports">
        <h2 class="mb-4">報表分析</h2>
        
        <div class="row">
          <div class="col-md-6 mb-4">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">BOGO配額PV統計</h5>
              </div>
              <div class="card-body">
                <canvas id="bogoPVChart" height="250"></canvas>
              </div>
            </div>
          </div>
          
          <div class="col-md-6 mb-4">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">任務完成統計</h5>
              </div>
              <div class="card-body">
                <canvas id="taskCompletionChart" height="250"></canvas>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-12 mb-4">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">BOGO團隊月度PV趨勢</h5>
              </div>
              <div class="card-body">
                <canvas id="monthlyPVTrendChart" height="250"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- 新增搶購員模態框 -->
  <div class="modal fade" id="addBuyerModal" tabindex="-1" aria-labelledby="addBuyerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addBuyerModalLabel">新增搶購員</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="buyerForm">
            <div class="mb-3">
              <label for="buyerName" class="form-label">姓名</label>
              <input type="text" class="form-control" id="buyerName" required>
            </div>
            <div class="mb-3">
              <label for="buyerContact" class="form-label">聯絡方式</label>
              <input type="text" class="form-control" id="buyerContact" required>
            </div>
            <div class="mb-3">
              <label class="form-label">可配合日期</label>
              <div class="d-flex flex-wrap">
                <div class="form-check me-3">
                  <input class="form-check-input" type="checkbox" value="週一" id="monday">
                  <label class="form-check-label" for="monday">週一</label>
                </div>
                <div class="form-check me-3">
                  <input class="form-check-input" type="checkbox" value="週二" id="tuesday">
                  <label class="form-check-label" for="tuesday">週二</label>
                </div>
                <div class="form-check me-3">
                  <input class="form-check-input" type="checkbox" value="週三" id="wednesday">
                  <label class="form-check-label" for="wednesday">週三</label>
                </div>
                <div class="form-check me-3">
                  <input class="form-check-input" type="checkbox" value="週四" id="thursday">
                  <label class="form-check-label" for="thursday">週四</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="週五" id="friday">
                  <label class="form-check-label" for="friday">週五</label>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label for="buyerNote" class="form-label">備註</label>
              <textarea class="form-control" id="buyerNote" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="saveBuyerBtn">儲存</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 分配任務模態框 -->
  <div class="modal fade" id="assignTaskModal" tabindex="-1" aria-labelledby="assignTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="assignTaskModalLabel">分配任務</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="assignTaskForm">
            <div class="mb-3">
              <label for="selectBogoAccount" class="form-label">BOGO帳號</label>
              <select class="form-select" id="selectBogoAccount" required>
                <option value="" selected disabled>請選擇BOGO帳號</option>
                <!-- 動態生成 -->
              </select>
            </div>
            <div class="mb-3">
              <label for="assignQuantity" class="form-label">分配數量</label>
              <input type="number" class="form-control" id="assignQuantity" min="1" required>
            </div>
            <div class="mb-3">
              <label for="selectBuyer" class="form-label">搶購人員</label>
              <select class="form-select" id="selectBuyer" required>
                <option value="" selected disabled>請選擇搶購人員</option>
                <!-- 動態生成 -->
              </select>
            </div>
            <div class="mb-3">
              <label for="assignNote" class="form-label">備註</label>
              <textarea class="form-control" id="assignNote" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="saveAssignBtn">儲存</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 回報任務模態框 -->
  <div class="modal fade" id="reportTaskModal" tabindex="-1" aria-labelledby="reportTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reportTaskModalLabel">回報任務</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="reportTaskForm">
            <input type="hidden" id="reportTaskId">
            <div class="mb-3">
              <label class="form-label">任務資訊</label>
              <p id="reportTaskInfo" class="mb-1"></p>
            </div>
            <div class="mb-3">
              <label for="reportQuantity" class="form-label">回報數量</label>
              <input type="number" class="form-control" id="reportQuantity" min="0" required>
            </div>
            <div class="mb-3">
              <label for="reportStatus" class="form-label">任務狀態</label>
              <select class="form-select" id="reportStatus" required>
                <option value="待處理">待處理</option>
                <option value="進行中">進行中</option>
                <option value="已完成">已完成</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="reportNote" class="form-label">備註</label>
              <textarea class="form-control" id="reportNote" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="saveReportBtn">儲存</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS (xlsx) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <!-- 主要JavaScript -->
  <script>
    // 全局變數
    let members = [];
    let bogoTeam = [];
    let products = [];
    let buyers = [];
    let tasks = [];
    let selectedProduct = null;
    let assignedTasks = [];
    
    // 網頁加載完成後執行
    $(document).ready(function() {
      // 初始化頁面
      initializePage();
      
      // 註冊事件處理程序
      registerEventHandlers();
    });
    
    // 初始化頁面
    function initializePage() {
      // 顯示載入中動畫
      showLoading();
      
      // 初始化系統
      callApi('init', {})
        .then(response => {
          if (response.success) {
            console.log('系統初始化成功');
            // 載入儀表板數據
            loadDashboardData();
            // 載入組織架構
            loadOrganizationStructure();
            // 載入BOGO團隊
            loadBogoTeam();
            // 載入搶購員
            loadBuyers();
            // 載入產品
            loadProducts();
            // 載入任務
            loadTasks();
          } else {
            showError('初始化失敗: ' + response.message);
          }
        })
        .catch(error => {
          showError('系統初始化錯誤: ' + error);
        })
        .finally(() => {
          // 隱藏載入中動畫
          hideLoading();
        });
    }
    
    // 註冊事件處理程序
    function registerEventHandlers() {
      // 側邊欄導航事件
      $('.sidebar .nav-link').on('click', function() {
        $('.sidebar .nav-link').removeClass('active');
        $(this).addClass('active');
      });
      
      // 重新整理按鈕
      $('#refreshDataBtn').on('click', function() {
        initializePage();
      });
      
      // 組織架構全部展開/收合按鈕
      $('#expandAllBtn').on('click', expandAllOrganizationRows);
      $('#collapseAllBtn').on('click', collapseAllOrganizationRows);
      
      // BOGO團隊全選/取消全選按鈕
      $('#selectAllBogoBtn').on('click', selectAllBogoMembers);
      $('#deselectAllBogoBtn').on('click', deselectAllBogoMembers);
      
      // 儲存BOGO團隊按鈕
      $('#saveBogoTeamBtn').on('click', saveBogoTeam);
      
      // 新增搶購員按鈕
      $('#saveBuyerBtn').on('click', saveBuyer);
      
      // 任務分配步驟按鈕
      $('#nextToStep2Btn').on('click', goToStep2);
      $('#backToStep1Btn').on('click', goToStep1);
      $('#nextToStep3Btn').on('click', goToStep3);
      $('#backToStep2Btn').on('click', goToStep2);
      $('#confirmTaskBtn').on('click', confirmTasks);
      
      // 新增分配按鈕
      $('#saveAssignBtn').on('click', saveAssignment);
      
      // 回報任務按鈕
      $('#saveReportBtn').on('click', saveTaskReport);
      
      // 任務狀態篩選
      $('.task-filter').on('click', function(e) {
        e.preventDefault();
        $('.task-filter').removeClass('active');
        $(this).addClass('active');
        filterTasks($(this).data('filter'));
      });
      
      // 搜尋功能
      $('#searchBogoMemberBtn').on('click', function() {
        searchBogoMembers($('#searchBogoMember').val());
      });
      
      $('#searchBuyerBtn').on('click', function() {
        searchBuyers($('#searchBuyer').val());
      });
      
      $('#searchProductBtn').on('click', function() {
        searchProducts($('#searchProduct').val());
      });
      
      $('#searchTaskBtn').on('click', function() {
        searchTasks($('#searchTask').val());
      });
      
      // 匯出按鈕
      $('#exportBuyersBtn').on('click', exportBuyersList);
      $('#exportTasksBtn').on('click', exportTasksList);
      $('#exportTaskBtn').on('click', exportCurrentTaskList);
    }
    
    // API調用函數
    function callApi(action, data) {
      // 如果是GET請求
      if (!data || Object.keys(data).length === 0) {
        return fetch(`${getScriptUrl()}?action=${action}`)
          .then(response => response.json());
      }
      
      // 如果是POST請求
      return fetch(getScriptUrl(), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          action: action,
          ...data
        })
      })
      .then(response => response.json());
    }
    
    // 獲取Google Apps Script的URL
    function getScriptUrl() {
      // 這裡應該填入您部署的Google Apps Script網頁應用程式URL
      return 'https://script.google.com/macros/s/AKfycbzkRM2UjnOElWao9de_cRgOPK0IN6gxYN4ra-nVJJXwiTnFPlAhzgv78Y7cym9pZ6PA/exec';
    }
    
    // 載入儀表板數據
    function loadDashboardData() {
      showLoading();
      callApi('getDashboardData', {})
        .then(response => {
          if (response.success) {
            const data = response.data;
            
            // 更新儀表板卡片
            $('#totalMembersValue').text(data.totalMembers);
            $('#bogoTeamMembersValue').text(data.totalBogoTeamMembers);
            $('#activeTasksValue').text(data.inProgressTasks);
            $('#totalBogoPVValue').text(data.totalBogoPV.toLocaleString());
            
            // 更新最新任務表格
            updateRecentTasksTable();
            
            // 更新BOGO團隊PV排行表格
            updateBogoPVRankTable();
            
            // 更新圖表
            updateDashboardCharts();
          } else {
            showError('載入儀表板數據失敗: ' + response.message);
          }
        })
        .catch(error => {
          showError('載入儀表板數據錯誤: ' + error);
        })
        .finally(() => {
          hideLoading();
        });
    }
    
    // 載入組織架構
    function loadOrganizationStructure() {
      showLoading();
      callApi('getOrganizationStructure', {})
        .then(response => {
          if (response.success) {
            // 更新組織架構表格
            updateOrganizationStructureTable(response.data);
          } else {
            showError('載入組織架構失敗: ' + response.message);
          }
        })
        .catch(error => {
          showError('載入組織架構錯誤: ' + error);
        })
        .finally(() => {
          hideLoading();
        });
    }
    
    // 載入BOGO團隊
    function loadBogoTeam() {
      showLoading();
      Promise.all([
        callApi('getAllMembers', {}),
        callApi('getBogoTeam', {})
      ])
        .then(([membersResponse, bogoTeamResponse]) => {
          if (membersResponse.success && bogoTeamResponse.success) {
            members = membersResponse.data;
            bogoTeam = bogoTeamResponse.data;
            
            // 更新BOGO團隊表格
            updateBogoTeamTable();
          } else {
            showError('載入BOGO團隊失敗');
          }
        })
        .catch(error => {
          showError('載入BOGO團隊錯誤: ' + error);
        })
        .finally(() => {
          hideLoading();
        });
    }
    
    // 載入搶購員
    function loadBuyers() {
      showLoading();
      callApi('getBuyers', {})
        .then(response => {
          if (response.success) {
            buyers = response.data;
            
            // 更新搶購員表格
            updateBuyersTable();
          } else {
            showError('載入搶購員失敗: ' + response.message);
          }
        })
        .catch(error => {
          showError('載入搶購員錯誤: ' + error);
        })
        .finally(() => {
          hideLoading();
        });
    }
    
    // 載入產品
    function loadProducts() {
      showLoading();
      callApi('getProducts', {})
        .then(response => {
          if (response.success) {
            products = response.data;
            
            // 更新產品表格
            updateProductsTable();
          } else {
            showError('載入產品失敗: ' + response.message);
          }
        })
        .catch(error => {
          showError('載入產品錯誤: ' + error);
        })
        .finally(() => {
          hideLoading();
        });
    }
    
    // 載入任務
    function loadTasks() {
      showLoading();
      callApi('getTasks', {})
        .then(response => {
          if (response.success) {
            tasks = response.data;
            
            // 更新任務表格
            updateTasksTable();
          } else {
            showError('載入任務失敗: ' + response.message);
          }
        })
        .catch(error => {
          showError('載入任務錯誤: ' + error);
        })
        .finally(() => {
          hideLoading();
        });
    }
    
    // 更新組織架構表格
    function updateOrganizationStructureTable(organizationTree) {
      const tableBody = $('#orgStructureTable tbody');
      tableBody.empty();
      
        // 遞歸生成表格行
        function generateRows(member, level, parentId) {
          const isInBogoTeam = bogoTeam.some(b => b['成員ID'] === member['成員ID']);
          const hasChildren = member.children && member.children.length > 0;
          
          const row = $('<tr>').addClass('member-row');
          if (parentId) {
            row.addClass('child-of-' + parentId).hide();
          }
          
          // 層級
          row.append($('<td>').text(member['層級']));
          
          // 成員資訊
          const memberInfo = $('<td>');
          const toggleBtn = hasChildren ? 
            $('<button>').addClass('btn btn-sm btn-outline-secondary toggle-btn me-1')
              .html('<i class="bi bi-plus"></i>')
              .attr('data-id', member['成員ID'])
              .on('click', toggleChildren) : '';
          
          const avatar = $('<span>').addClass('member-avatar bg-primary text-white')
            .text(member['姓名'].charAt(0));
          
          memberInfo.append(toggleBtn, avatar, member['姓名'], ' (', member['BOGO帳號'], ')');
          row.append(memberInfo);
          
          // 其他資訊
          row.append($('<td>').text(member['個人PV'] || 0));
          row.append($('<td>').text(member['團隊PV'] || 0));
          row.append($('<td>').text(member['BOGO配額PV'] || 0));
          row.append($('<td>').text(member['個人總PV'] || 0));
          row.append($('<td>').text(member['下線人數'] || 0));
          row.append($('<td>').append(
            $('<span>').addClass('badge ' + (member['狀態'] === '活躍' ? 'bg-success' : 'bg-secondary'))
              .text(member['狀態'])
          ));
          
          // BOGO團隊
          row.append($('<td>').append(
            $('<span>').addClass('badge ' + (isInBogoTeam ? 'bg-primary' : 'bg-light text-dark'))
              .text(isInBogoTeam ? '是' : '否')
          ));
          
          // 操作
          const actionCell = $('<td>');
          actionCell.append(
            $('<button>').addClass('btn btn-sm btn-outline-primary me-1')
              .html('<i class="bi bi-eye"></i>')
              .attr('title', '查看詳情')
              .on('click', function() {
                viewMemberDetail(member['成員ID']);
              })
          );
          row.append(actionCell);
          
          tableBody.append(row);
          
          // 遞歸處理子節點
          if (hasChildren) {
            member.children.forEach(child => {
              generateRows(child, level + 1, member['成員ID']);
            });
          }
        }
        
        // 生成表格
        organizationTree.forEach(member => {
          generateRows(member, 0, null);
        });
    }
    
    // 切換子節點顯示/隱藏
    function toggleChildren() {
      const id = $(this).data('id');
      const childRows = $('.child-of-' + id);
      
      if (childRows.is(':visible')) {
        // 收合子節點
        $(this).html('<i class="bi bi-plus"></i>');
        childRows.hide();
        
        // 遞歸收合所有子節點
        childRows.each(function() {
          const childId = $(this).find('.toggle-btn').data('id');
          if (childId) {
            $('.child-of-' + childId).hide();
            $(this).find('.toggle-btn').html('<i class="bi bi-plus"></i>');
          }
        });
      } else {
        // 展開子節點
        $(this).html('<i class="bi bi-dash"></i>');
        childRows.show();
      }
    }
    
    // 展開所有組織架構行
    function expandAllOrganizationRows() {
      $('.member-row').show();
      $('.toggle-btn').html('<i class="bi bi-dash"></i>');
    }
    
    // 收合所有組織架構行
    function collapseAllOrganizationRows() {
      $('.member-row').not(':first').hide();
      $('.toggle-btn').html('<i class="bi bi-plus"></i>');
    }
    
    // 更新BOGO團隊表格
    function updateBogoTeamTable() {
      const tableBody = $('#bogoTeamTable tbody');
      tableBody.empty();
      
      // 篩選出有BOGO帳號的成員
      const eligibleMembers = members.filter(m => m['BOGO帳號']);
      
      eligibleMembers.forEach(member => {
        const isInBogoTeam = bogoTeam.some(b => b['成員ID'] === member['成員ID']);
        
        const row = $('<tr>');
        
        // 選擇
        row.append($('<td>').append(
          $('<input>').attr({
            type: 'checkbox',
            class: 'form-check-input bogo-member-checkbox',
            'data-id': member['成員ID'],
            checked: isInBogoTeam
          })
        ));
        
        // 成員資訊
        row.append($('<td>').text(member['成員ID']));
        row.append($('<td>').text(member['姓名']));
        row.append($('<td>').text(member['BOGO帳號']));
        row.append($('<td>').text(member['卡號'] || '-'));
        row.append($('<td>').text(member['個人PV'] || 0));
        row.append($('<td>').text(member['BOGO配額PV'] || 0));
        row.append($('<td>').text(member['個人總PV'] || 0));
        
        // 操作
        const actionCell = $('<td>');
        actionCell.append(
          $('<button>').addClass('btn btn-sm btn-outline-primary me-1')
            .html('<i class="bi bi-eye"></i>')
            .attr('title', '查看詳情')
            .on('click', function() {
              viewMemberDetail(member['成員ID']);
            })
        );
        row.append(actionCell);
        
        tableBody.append(row);
      });
    }
    
    // 選擇所有BOGO成員
    function selectAllBogoMembers() {
      $('.bogo-member-checkbox').prop('checked', true);
    }
    
    // 取消選擇所有BOGO成員
    function deselectAllBogoMembers() {
      $('.bogo-member-checkbox').prop('checked', false);
    }
    
    // 搜尋BOGO成員
    function searchBogoMembers(keyword) {
      if (!keyword) {
        $('#bogoTeamTable tbody tr').show();
        return;
      }
      
      keyword = keyword.toLowerCase();
      $('#bogoTeamTable tbody tr').each(function() {
        const row = $(this);
        const name = row.find('td:eq(2)').text().toLowerCase();
        const account = row.find('td:eq(3)').text().toLowerCase();
        const cardNo = row.find('td:eq(4)').text().toLowerCase();
        
        if (name.includes(keyword) || account.includes(keyword) || cardNo.includes(keyword)) {
          row.show();
        } else {
          row.hide();
        }
      });
    }
    
    // 儲存BOGO團隊
    function saveBogoTeam() {
      showLoading();
      
      // 獲取選中的成員
      const selectedMembers = [];
      $('.bogo-member-checkbox:checked').each(function() {
        const memberId = $(this).data('id');
        const member = members.find(m => m['成員ID'] === memberId);
        
        if (member) {
          selectedMembers.push({
            memberId: member['成員ID'],
            bogoAccount: member['BOGO帳號'],
            name: member['姓名']
          });
        }
      });
      
      callApi('updateBogoTeam', { teamMembers: selectedMembers })
        .then(response => {
          if (response.success) {
            showSuccess('BOGO團隊更新成功');
            loadBogoTeam();
          } else {
            showError('更新BOGO團隊失敗: ' + response.message);
          }
        })
        .catch(error => {
          showError('更新BOGO團隊錯誤: ' + error);
        })
        .finally(() => {
          hideLoading();
        });
    }
    
    // 更新搶購員表格
    function updateBuyersTable() {
      const tableBody = $('#buyersTable tbody');
      tableBody.empty();
      
      buyers.forEach(buyer => {
        const row = $('<tr>');
        
        // 基本資訊
        row.append($('<td>').text(buyer['搶購員ID']));
        row.append($('<td>').text(buyer['姓名']));
        row.append($('<td>').text(buyer['聯絡方式']));
        
        // 可配合日期
        const availableDays = [];
        if (buyer['週一']) availableDays.push('週一');
        if (buyer['週二']) availableDays.push('週二');
        if (buyer['週三']) availableDays.push('週三');
        if (buyer['週四']) availableDays.push('週四');
        if (buyer['週五']) availableDays.push('週五');
        
        row.append($('<td>').text(availableDays.join(', ') || '無'));
        
        // 狀態
        row.append($('<td>').append(
          $('<span>').addClass('badge ' + (buyer['狀態'] === '可用' ? 'bg-success' : 'bg-secondary'))
            .text(buyer['狀態'])
        ));
        
        // 備註
        row.append($('<td>').text(buyer['備註'] || ''));
        
        // 操作
        const actionCell = $('<td>');
        actionCell.append(
          $('<button>').addClass('btn btn-sm btn-outline-primary me-1')
            .html('<i class="bi bi-pencil"></i>')
            .attr('title', '編輯')
            .on('click', function() {
              editBuyer(buyer['搶購員ID']);
            })
        );
        actionCell.append(
          $('<button>').addClass('btn btn-sm btn-outline-danger')
            .html('<i class="bi bi-trash"></i>')
            .attr('title', '刪除')
            .on('click', function() {
              deleteBuyer(buyer['搶購員ID']);
            })
        );
        row.append(actionCell);
        
        tableBody.append(row);
      });
      
      // 更新任務分配模態框中的搶購員下拉選單
      updateBuyersDropdown();
    }
    
    // 搜尋搶購員
    function searchBuyers(keyword) {
      if (!keyword) {
        $('#buyersTable tbody tr').show();
        return;
      }
      
      keyword = keyword.toLowerCase();
      $('#buyersTable tbody tr').each(function() {
        const row = $(this);
        const id = row.find('td:eq(0)').text().toLowerCase();
        const name = row.find('td:eq(1)').text().toLowerCase();
        const contact = row.find('td:eq(2)').text().toLowerCase();
        const days = row.find('td:eq(3)').text().toLowerCase();
        const note = row.find('td:eq(5)').text().toLowerCase();
        
        if (id.includes(keyword) || name.includes(keyword) || contact.includes(keyword) || 
            days.includes(keyword) || note.includes(keyword)) {
          row.show();
        } else {
          row.hide();
        }
      });
    }
    
    // 儲存搶購員
    function saveBuyer() {
      const name = $('#buyerName').val();
      const contact = $('#buyerContact').val();
      
      if (!name || !contact) {
        showError('請填寫姓名和聯絡方式');
        return;
      }
      
      showLoading();
      
      const buyer = {
        name: name,
        contact: contact,
        monday: $('#monday').is(':checked'),
        tuesday: $('#tuesday').is(':checked'),
        wednesday: $('#wednesday').is(':checked'),
        thursday: $('#thursday').is(':checked'),
        friday: $('#friday').is(':checked'),
        note: $('#buyerNote').val()
      };
      
      callApi('addBuyer', { buyer: buyer })
        .then(response => {
          if (response.success) {
            showSuccess('搶購員新增成功');
            $('#addBuyerModal').modal('hide');
            $('#buyerForm')[0].reset();
            loadBuyers();
          } else {
            showError('新增搶購員失敗: ' + response.message);
          }
        })
        .catch(error => {
          showError('新增搶購員錯誤: ' + error);
        })
        .finally(() => {
          hideLoading();
        });
    }
    
    // 更新產品表格
    function updateProductsTable() {
      const tableBody = $('#productsTable tbody');
      tableBody.empty();
      
      products.forEach(product => {
        const row = $('<tr>');
        
        // 選擇
        row.append($('<td>').append(
          $('<input>').attr({
            type: 'radio',
            name: 'productRadio',
            class: 'form-check-input product-radio',
            'data-code': product['產品代號']
          })
        ));
        
        // 產品資訊
        row.append($('<td>').text(product['產品代號']));
        row.append($('<td>').text(product['產品名稱']));
        row.append($('<td>').text(product['單價']));
        row.append($('<td>').text(product['PV數']));
        row.append($('<td>').text(product['需搶購數量']));
        row.append($('<td>').text(product['已分配數量']));
        row.append($('<td>').text(product['剩餘數量']));
        
        tableBody.append(row);
      });
    }
    
    // 搜尋產品
    function searchProducts(keyword) {
      if (!keyword) {
        $('#productsTable tbody tr').show();
        return;
      }
      
      keyword = keyword.toLowerCase();
      $('#productsTable tbody tr').each(function() {
        const row = $(this);
        const code = row.find('td:eq(1)').text().toLowerCase();
        const name = row.find('td:eq(2)').text().toLowerCase();
        
        if (code.includes(keyword) || name.includes(keyword)) {
          row.show();
        } else {
          row.hide();
        }
      });
    }
    
    // 更新任務表格
    function updateTasksTable() {
      const tableBody = $('#tasksTable tbody');
      tableBody.empty();
      
      tasks.forEach(task => {
        const row = $('<tr>').addClass('task-row').attr('data-status', task['任務狀態']);
        
        // 任務資訊
        row.append($('<td>').text(task['任務ID']));
        
        // 產品資訊
        const product = products.find(p => p['產品代號'] === task['產品代號']);
        row.append($('<td>').text(product ? product['產品名稱'] : task['產品代號']));
        
        // BOGO帳號和姓名
        row.append($('<td>').text(task['BOGO帳號']));
        const member = members.find(m => m['成員ID'] === task['成員ID']);
        row.append($('<td>').text(member ? member['姓名'] : '-'));
        
        // 搶購員
        const buyer = buyers.find(b => b['搶購員ID'] === task['搶購員ID']);
        row.append($('<td>').text(buyer ? buyer['姓名'] : '-'));
        
        // 數量
        row.append($('<td>').text(task['分配數量']));
        row.append($('<td>').text(task['回報數量']));
        
        // 狀態
        const statusClass = task['任務狀態'] === '已完成' ? 'bg-success' : 
                          task['任務狀態'] === '進行中' ? 'bg-primary' : 'bg-secondary';
        row.append($('<td>').append(
          $('<span>').addClass('badge ' + statusClass).text(task['任務狀態'])
        ));
        
        // 分配日期
        row.append($('<td>').text(formatDate(task['分配日期'])));
        
        // 操作
        const actionCell = $('<td>');
        actionCell.append(
          $('<button>').addClass('btn btn-sm btn-outline-primary me-1')
            .html('<i class="bi bi-clipboard-check"></i>')
            .attr('title', '回報')
            .on('click', function() {
              openReportTaskModal(task['任務ID']);
            })
        );
        actionCell.append(
          $('<button>').addClass('btn btn-sm btn-outline-info')
            .html('<i class="bi bi-info-circle"></i>')
            .attr('title', '詳情')
            .on('click', function() {
              viewTaskDetail(task['任務ID']);
            })
        );
        row.append(actionCell);
        
        tableBody.append(row);
      });
      
      // 更新最新任務表格
      updateRecentTasksTable();
    }
    
    // 篩選任務
    function filterTasks(status) {
      if (status === 'all') {
        $('.task-row').show();
      } else {
        $('.task-row').hide();
        $('.task-row[data-status="' + status + '"]').show();
      }
    }
    
    // 搜尋任務
    function searchTasks(keyword) {
      if (!keyword) {
        $('.task-row').show();
        return;
      }
      
      keyword = keyword.toLowerCase();
      $('.task-row').each(function() {
        const row = $(this);
        const id = row.find('td:eq(0)').text().toLowerCase();
        const product = row.find('td:eq(1)').text().toLowerCase();
        const account = row.find('td:eq(2)').text().toLowerCase();
        const name = row.find('td:eq(3)').text().toLowerCase();
        const buyer = row.find('td:eq(4)').text().toLowerCase();
        
        if (id.includes(keyword) || product.includes(keyword) || account.includes(keyword) || 
            name.includes(keyword) || buyer.includes(keyword)) {
          row.show();
        } else {
          row.hide();
        }
      });
    }
    
    // 更新最新任務表格
    function updateRecentTasksTable() {
      const tableBody = $('#recentTasksTable tbody');
      tableBody.empty();
      
      // 獲取最新的5個任務
      const recentTasks = [...tasks].sort((a, b) => {
        return new Date(b['分配日期']) - new Date(a['分配日期']);
      }).slice(0, 5);
      
      recentTasks.forEach(task => {
        const row = $('<tr>');
        
        // 任務資訊
        row.append($('<td>').text(task['任務ID']));
        
        // 產品資訊
        const product = products.find(p => p['產品代號'] === task['產品代號']);
        row.append($('<td>').text(product ? product['產品名稱'] : task['產品代號']));
        
        // BOGO帳號
        row.append($('<td>').text(task['BOGO帳號']));
        
        // 數量
        row.append($('<td>').text(task['分配數量']));
        
        // 狀態
        const statusClass = task['任務狀態'] === '已完成' ? 'bg-success' : 
                          task['任務狀態'] === '進行中' ? 'bg-primary' : 'bg-secondary';
        row.append($('<td>').append(
          $('<span>').addClass('badge ' + statusClass).text(task['任務狀態'])
        ));
        
        tableBody.append(row);
      });
    }
    
    // 更新BOGO團隊PV排行表格
    function updateBogoPVRankTable() {
      const tableBody = $('#bogoPVRankTable tbody');
      tableBody.empty();
      
      // 獲取BOGO團隊成員
      const bogoMembers = members.filter(m => bogoTeam.some(b => b['成員ID'] === m['成員ID']));
      
      // 按BOGO配額PV排序
      const rankedMembers = [...bogoMembers].sort((a, b) => {
        return (b['BOGO配額PV'] || 0) - (a['BOGO配額PV'] || 0);
      }).slice(0, 5);
      
      rankedMembers.forEach((member, index) => {
        const row = $('<tr>');
        
        // 排名
        row.append($('<td>').text(index + 1));
        
        // 成員資訊
        row.append($('<td>').text(member['姓名']));
        row.append($('<td>').text(member['BOGO帳號']));
        
        // PV資訊
        row.append($('<td>').text((member['BOGO配額PV'] || 0).toLocaleString()));
        row.append($('<td>').text((member['個人總PV'] || 0).toLocaleString()));
        
        tableBody.append(row);
      });
    }
    
    // 更新儀表板圖表
    function updateDashboardCharts() {
      // BOGO配額PV統計圖
      updateBogoPVChart();
      
      // 任務完成統計圖
      updateTaskCompletionChart();
      
      // 月度PV趨勢圖
      updateMonthlyPVTrendChart();
    }
    
    // 更新BOGO配額PV統計圖
    function updateBogoPVChart() {
      const ctx = document.getElementById('bogoPVChart').getContext('2d');
      
      // 獲取BOGO團隊成員
      const bogoMembers = members.filter(m => bogoTeam.some(b => b['成員ID'] === m['成員ID']));
      
      // 按BOGO配額PV排序
      const rankedMembers = [...bogoMembers].sort((a, b) => {
        return (b['BOGO配額PV'] || 0) - (a['BOGO配額PV'] || 0);
      }).slice(0, 5);
      
      const labels = rankedMembers.map(m => m['姓名']);
      const data = rankedMembers.map(m => m['BOGO配額PV'] || 0);
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'BOGO配額PV',
            data: data,
            backgroundColor: 'rgba(13, 110, 253, 0.7)',
            borderColor: 'rgba(13, 110, 253, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }
    
    // 更新任務完成統計圖
    function updateTaskCompletionChart() {
      const ctx = document.getElementById('taskCompletionChart').getContext('2d');
      
      // 計算各狀態的任務數量
      const pending = tasks.filter(t => t['任務狀態'] === '待處理').length;
      const inProgress = tasks.filter(t => t['任務狀態'] === '進行中').length;
      const completed = tasks.filter(t => t['任務狀態'] === '已完成').length;
      
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['待處理', '進行中', '已完成'],
          datasets: [{
            data: [pending, inProgress, completed],
            backgroundColor: [
              'rgba(108, 117, 125, 0.7)',
              'rgba(13, 110, 253, 0.7)',
              'rgba(25, 135, 84, 0.7)'
            ],
            borderColor: [
              'rgba(108, 117, 125, 1)',
              'rgba(13, 110, 253, 1)',
              'rgba(25, 135, 84, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true
        }
      });
    }
    
    // 更新月度PV趨勢圖
    function updateMonthlyPVTrendChart() {
      const ctx = document.getElementById('monthlyPVTrendChart').getContext('2d');
      
      // 模擬月度數據
      const months = ['1月', '2月', '3月', '4月', '5月', '6月'];
      const personalPVData = [120, 150, 180, 210, 250, 300];
      const bogoPVData = [200, 350, 450, 500, 650, 800];
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [
            {
              label: '個人PV',
              data: personalPVData,
              backgroundColor: 'rgba(13, 110, 253, 0.1)',
              borderColor: 'rgba(13, 110, 253, 1)',
              borderWidth: 2,
              fill: true
            },
            {
              label: 'BOGO配額PV',
              data: bogoPVData,
              backgroundColor: 'rgba(25, 135, 84, 0.1)',
              borderColor: 'rgba(25, 135, 84, 1)',
              borderWidth: 2,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }
    
    // 任務分配步驟1
    function goToStep1() {
      // 更新步驟指示器
      $('.step').removeClass('active');
      $('#step1').addClass('active');
      
      // 顯示步驟1內容
      $('.step-content').hide();
      $('#step1Content').show();
    }
    
    // 任務分配步驟2
    function goToStep2() {
      // 檢查是否已選擇產品
      const selectedProductCode = $('input[name="productRadio"]:checked').data('code');
      if (!selectedProductCode) {
        showError('請先選擇一個產品');
        return;
      }
      
      // 獲取選中的產品資訊
      selectedProduct = products.find(p => p['產品代號'] === selectedProductCode);
      
      // 更新步驟2的產品資訊
      $('#selectedProductCode').text(selectedProduct['產品代號']);
      $('#selectedProductName').text(selectedProduct['產品名稱']);
      $('#selectedProductPrice').text(selectedProduct['單價']);
      $('#selectedProductPV').text(selectedProduct['PV數']);
      $('#selectedProductRemaining').text(selectedProduct['剩餘數量']);
      
      // 更新步驟指示器
      $('.step').removeClass('active');
      $('#step2').addClass('active');
      
      // 顯示步驟2內容
      $('.step-content').hide();
      $('#step2Content').show();
      
      // 清空已分配任務
      assignedTasks = [];
      updateAssignedTasksTable();
      
      // 更新BOGO帳號下拉選單
      updateBogoAccountsDropdown();
    }
    
    // 任務分配步驟3
    function goToStep3() {
      // 檢查是否已分配任務
      if (assignedTasks.length === 0) {
        showError('請先分配至少一個任務');
        return;
      }
      
      // 更新步驟3的確認資訊
      $('#confirmProductCode').text(selectedProduct['產品代號']);
      $('#confirmProductName').text(selectedProduct['產品名稱']);
      $('#confirmProductPrice').text(selectedProduct['單價']);
      $('#confirmProductPV').text(selectedProduct['PV數']);
      $('#confirmTotalQuantity').text(selectedProduct['需搶購數量']);
      
      const totalAssigned = assignedTasks.reduce((sum, task) => sum + task.quantity, 0);
      $('#confirmAssignedQuantity').text(totalAssigned);
      
      // 更新確認任務表格
      updateConfirmTasksTable();
      
      // 更新步驟指示器
      $('.step').removeClass('active');
      $('#step3').addClass('active');
      
      // 顯示步驟3內容
      $('.step-content').hide();
      $('#step3Content').show();
    }
    
    // 更新已分配任務表格
    function updateAssignedTasksTable() {
      const tableBody = $('#assignedTasksTable tbody');
      tableBody.empty();
      
      assignedTasks.forEach((task, index) => {
        const row = $('<tr>');
        
        // BOGO帳號和成員資訊
        row.append($('<td>').text(task.bogoAccount));
        row.append($('<td>').text(task.memberName));
        row.append($('<td>').text(task.personalPV || 0));
        row.append($('<td>').text(task.bogoPV || 0));
        row.append($('<td>').text(task.totalPV || 0));
        
        // 分配數量
        row.append($('<td>').append(
          $('<input>').attr({
            type: 'number',
            class: 'form-control form-control-sm quantity-input',
            'data-index': index,
            value: task.quantity,
            min: 1,
            max: selectedProduct['剩餘數量']
          }).on('change', function() {
            updateTaskQuantity(index, parseInt($(this).val()));
          })
        ));
        
        // 搶購人員
        const buyer = buyers.find(b => b['搶購員ID'] === task.buyerId);
        row.append($('<td>').text(buyer ? buyer['姓名'] : '-'));
        
        // 操作
        const actionCell = $('<td>');
        actionCell.append(
          $('<button>').addClass('btn btn-sm btn-outline-danger')
            .html('<i class="bi bi-trash"></i>')
            .attr('title', '移除')
            .on('click', function() {
              removeAssignedTask(index);
            })
        );
        row.append(actionCell);
        
        tableBody.append(row);
      });
      
      // 更新總計
      const totalQuantity = assignedTasks.reduce((sum, task) => sum + task.quantity, 0);
      $('#totalAssignedQuantity').text(totalQuantity);
    }
    
    // 更新確認任務表格
    function updateConfirmTasksTable() {
      const tableBody = $('#confirmTasksTable tbody');
      tableBody.empty();
      
      let totalQuantity = 0;
      let totalPV = 0;
      
      assignedTasks.forEach(task => {
        const row = $('<tr>');
        
        // BOGO帳號和成員資訊
        row.append($('<td>').text(task.bogoAccount));
        row.append($('<td>').text(task.memberName));
        
        // 分配數量
        row.append($('<td>').text(task.quantity));
        
        // 預估PV
        const estimatedPV = task.quantity * selectedProduct['PV數'];
        totalPV += estimatedPV;
        row.append($('<td>').text(estimatedPV));
        
        // 搶購人員資訊
        const buyer = buyers.find(b => b['搶購員ID'] === task.buyerId);
        row.append($('<td>').text(buyer ? buyer['姓名'] : '-'));
        row.append($('<td>').text(buyer ? buyer['聯絡方式'] : '-'));
        
        // 備註
        row.append($('<td>').text(task.note || ''));
        
        totalQuantity += task.quantity;
        tableBody.append(row);
      });
      
      // 更新總計
      $('#confirmTotalQuantityFooter').text(totalQuantity);
      $('#confirmTotalPVFooter').text(totalPV);
    }
    
    // 更新BOGO帳號下拉選單
    function updateBogoAccountsDropdown() {
      const select = $('#selectBogoAccount');
      select.empty();
      
      select.append($('<option>').attr('value', '').attr('disabled', true).attr('selected', true).text('請選擇BOGO帳號'));
      
      // 獲取BOGO團隊成員
      const bogoMembers = members.filter(m => bogoTeam.some(b => b['成員ID'] === m['成員ID']));
      
      // 過濾掉已分配的成員
      const availableMembers = bogoMembers.filter(m => 
        !assignedTasks.some(t => t.memberId === m['成員ID'])
      );
      
      availableMembers.forEach(member => {
        select.append(
          $('<option>')
            .attr('value', member['BOGO帳號'])
            .attr('data-member-id', member['成員ID'])
            .attr('data-name', member['姓名'])
            .attr('data-personal-pv', member['個人PV'] || 0)
            .attr('data-bogo-pv', member['BOGO配額PV'] || 0)
            .attr('data-total-pv', member['個人總PV'] || 0)
            .text(member['BOGO帳號'] + ' - ' + member['姓名'])
        );
      });
    }
    
    // 更新搶購員下拉選單
    function updateBuyersDropdown() {
      const select = $('#selectBuyer');
      select.empty();
      
      select.append($('<option>').attr('value', '').attr('disabled', true).attr('selected', true).text('請選擇搶購人員'));
      
      // 只顯示狀態為"可用"的搶購員
      const availableBuyers = buyers.filter(b => b['狀態'] === '可用');
      
      availableBuyers.forEach(buyer => {
        select.append(
          $('<option>')
            .attr('value', buyer['搶購員ID'])
            .text(buyer['姓名'] + ' (' + buyer['聯絡方式'] + ')')
        );
      });
    }
    
    // 儲存任務分配
    function saveAssignment() {
      const bogoAccount = $('#selectBogoAccount').val();
      const quantity = parseInt($('#assignQuantity').val());
      const buyerId = $('#selectBuyer').val();
      const note = $('#assignNote').val();
      
      if (!bogoAccount || isNaN(quantity) || quantity <= 0 || !buyerId) {
        showError('請填寫完整的分配資訊');
        return;
      }
      
      const option = $('#selectBogoAccount option:selected');
      const memberId = option.data('member-id');
      const memberName = option.data('name');
      const personalPV = option.data('personal-pv');
      const bogoPV = option.data('bogo-pv');
      const totalPV = option.data('total-pv');
      
      // 添加到已分配任務
      assignedTasks.push({
        memberId: memberId,
        bogoAccount: bogoAccount,
        memberName: memberName,
        personalPV: personalPV,
        bogoPV: bogoPV,
        totalPV: totalPV,
        quantity: quantity,
        buyerId: buyerId,
        note: note
      });
      
      // 更新已分配任務表格
      updateAssignedTasksTable();
      
      // 更新BOGO帳號下拉選單
      updateBogoAccountsDropdown();
      
      // 關閉模態框
      $('#assignTaskModal').modal('hide');
      
      // 重置表單
      $('#assignTaskForm')[0].reset();
    }
    
    // 更新任務數量
    function updateTaskQuantity(index, quantity) {
      if (isNaN(quantity) || quantity <= 0) {
        showError('數量必須大於0');
        return;
      }
      
      assignedTasks[index].quantity = quantity;
      
      // 更新總計
      const totalQuantity = assignedTasks.reduce((sum, task) => sum + task.quantity, 0);
      $('#totalAssignedQuantity').text(totalQuantity);
    }
    
    // 移除已分配任務
    function removeAssignedTask(index) {
      assignedTasks.splice(index, 1);
      
      // 更新已分配任務表格
      updateAssignedTasksTable();
      
      // 更新BOGO帳號下拉選單
      updateBogoAccountsDropdown();
    }
    
    // 確認派發任務
    function confirmTasks() {
      if (assignedTasks.length === 0) {
        showError('請先分配至少一個任務');
        return;
      }
      
      showLoading();
      
      // 轉換為API所需格式
      const tasks = assignedTasks.map(task => ({
        productCode: selectedProduct['產品代號'],
        bogoAccount: task.bogoAccount,
        memberId: task.memberId,
        buyerId: task.buyerId,
        quantity: task.quantity,
        note: task.note
      }));
      
      callApi('createTasks', { tasks: tasks })
        .then(response => {
          if (response.success) {
            showSuccess('任務派發成功');
            
            // 重置任務分配
            selectedProduct = null;
            assignedTasks = [];
            
            // 返回步驟1
            goToStep1();
            
            // 重新載入產品和任務
            loadProducts();
            loadTasks();
          } else {
            showError('任務派發失敗: ' + response.message);
          }
        })
        .catch(error => {
          showError('任務派發錯誤: ' + error);
        })
        .finally(() => {
          hideLoading();
        });
    }
    
    // 開啟回報任務模態框
    function openReportTaskModal(taskId) {
      const task = tasks.find(t => t['任務ID'] === taskId);
      if (!task) {
        showError('找不到指定的任務');
        return;
      }
      
      const product = products.find(p => p['產品代號'] === task['產品代號']);
      const productName = product ? product['產品名稱'] : task['產品代號'];
      
      $('#reportTaskId').val(taskId);
      $('#reportTaskInfo').html(
        `<strong>任務ID:</strong> ${task['任務ID']}<br>` +
        `<strong>產品:</strong> ${productName}<br>` +
        `<strong>BOGO帳號:</strong> ${task['BOGO帳號']}<br>` +
        `<strong>分配數量:</strong> ${task['分配數量']}`
      );
      $('#reportQuantity').val(task['回報數量']);
      $('#reportStatus').val(task['任務狀態']);
      
      $('#reportTaskModal').modal('show');
    }
    
    // 儲存任務回報
    function saveTaskReport() {
      const taskId = $('#reportTaskId').val();
      const reportedQuantity = parseInt($('#reportQuantity').val());
      const status = $('#reportStatus').val();
      
      if (isNaN(reportedQuantity) || reportedQuantity < 0) {
        showError('回報數量必須大於或等於0');
        return;
      }
      
      showLoading();
      
      callApi('updateTaskStatus', {
        taskId: taskId,
        reportedQuantity: reportedQuantity,
        status: status
      })
        .then(response => {
          if (response.success) {
            showSuccess('任務回報成功');
            $('#reportTaskModal').modal('hide');
            loadTasks();
            loadDashboardData();
          } else {
            showError('任務回報失敗: ' + response.message);
          }
        })
        .catch(error => {
          showError('任務回報錯誤: ' + error);
        })
        .finally(() => {
          hideLoading();
        });
    }
    
    // 匯出搶購員列表
    function exportBuyersList() {
      const data = [
        ['搶購員ID', '姓名', '聯絡方式', '週一', '週二', '週三', '週四', '週五', '狀態', '備註']
      ];
      
      buyers.forEach(buyer => {
        data.push([
          buyer['搶購員ID'],
          buyer['姓名'],
          buyer['聯絡方式'],
          buyer['週一'] ? 'V' : '',
          buyer['週二'] ? 'V' : '',
          buyer['週三'] ? 'V' : '',
          buyer['週四'] ? 'V' : '',
          buyer['週五'] ? 'V' : '',
          buyer['狀態'],
          buyer['備註'] || ''
        ]);
      });
      
      exportToExcel(data, '搶購員列表');
    }
    
    // 匯出任務列表
    function exportTasksList() {
      const data = [
        ['任務ID', '產品代號', '產品名稱', 'BOGO帳號', '姓名', '搶購員', '分配數量', '回報數量', '狀態', '分配日期', '完成日期', '備註']
      ];
      
      tasks.forEach(task => {
        const product = products.find(p => p['產品代號'] === task['產品代號']);
        const member = members.find(m => m['成員ID'] === task['成員ID']);
        const buyer = buyers.find(b => b['搶購員ID'] === task['搶購員ID']);
        
        data.push([
          task['任務ID'],
          task['產品代號'],
          product ? product['產品名稱'] : '',
          task['BOGO帳號'],
          member ? member['姓名'] : '',
          buyer ? buyer['姓名'] : '',
          task['分配數量'],
          task['回報數量'],
          task['任務狀態'],
          formatDate(task['分配日期']),
          formatDate(task['完成日期']),
          task['備註'] || ''
        ]);
      });
      
      exportToExcel(data, '任務列表');
    }
    
    // 匯出當前任務列表
    function exportCurrentTaskList() {
      const data = [
        ['產品代號', '產品名稱', 'BOGO帳號', '姓名', '搶購員', '聯絡方式', '分配數量', '預估PV', '備註']
      ];
      
      assignedTasks.forEach(task => {
        const buyer = buyers.find(b => b['搶購員ID'] === task.buyerId);
        const estimatedPV = task.quantity * selectedProduct['PV數'];
        
        data.push([
          selectedProduct['產品代號'],
          selectedProduct['產品名稱'],
          task.bogoAccount,
          task.memberName,
          buyer ? buyer['姓名'] : '',
          buyer ? buyer['聯絡方式'] : '',
          task.quantity,
          estimatedPV,
          task.note || ''
        ]);
      });
      
      exportToExcel(data, selectedProduct['產品名稱'] + '_任務分配表');
    }
    
    // 匯出到Excel
    function exportToExcel(data, fileName) {
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
      XLSX.writeFile(wb, fileName + '.xlsx');
    }
    
    // 格式化日期
    function formatDate(dateStr) {
      if (!dateStr) return '';
      
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) return dateStr;
      
      return date.toLocaleDateString('zh-TW');
    }
    
    // 顯示載入中動畫
    function showLoading() {
      $('#loadingIndicator').show();
    }
    
    // 隱藏載入中動畫
    function hideLoading() {
      $('#loadingIndicator').hide();
    }
    
    // 顯示成功訊息
    function showSuccess(message) {
      alert('成功: ' + message);
    }
    
    // 顯示錯誤訊息
    function showError(message) {
      alert('錯誤: ' + message);
    }
  </script>
</body>
</html>
      
