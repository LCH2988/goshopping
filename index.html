<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LIFF 訂購單查詢系統</title>
<script src="https://static.line-scdn.net/liff/edge/2.1/liff.js"></script>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .container {
        max-width: 450px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .header {
        background: linear-gradient(45deg, #00c851, #00a843);
        color: white;
        padding: 30px 20px;
        text-align: center;
    }
    
    .header h1 {
        font-size: 24px;
        margin-bottom: 10px;
    }
    
    .user-info {
        background: rgba(255,255,255,0.1);
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
    }
    
    .content {
        padding: 30px 20px;
    }
    
    .config-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        border: 2px dashed #dee2e6;
    }
    
    .config-section h3 {
        color: #495057;
        margin-bottom: 10px;
        font-size: 14px;
    }
    
    .config-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 5px;
        font-size: 12px;
        margin-bottom: 8px;
    }
    
    .config-button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        font-size: 12px;
        cursor: pointer;
        margin-right: 5px;
    }
    
    .config-button:hover {
        background: #0056b3;
    }
    
    .tab-buttons {
        display: flex;
        margin-bottom: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        padding: 5px;
    }
    
    .tab-button {
        flex: 1;
        padding: 12px;
        border: none;
        background: transparent;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
        font-size: 14px;
    }
    
    .tab-button.active {
        background: #00c851;
        color: white;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
    }
    
    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s;
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
        outline: none;
        border-color: #00c851;
    }
    
    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }
    
    .btn {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 10px;
    }
    
    .btn-primary {
        background: linear-gradient(45deg, #00c851, #00a843);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0,200,81,0.3);
    }
    
    .btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .order-summary {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #00c851;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #dee2e6;
    }
    
    .summary-item:last-child {
        border-bottom: none;
        font-weight: bold;
        font-size: 18px;
        color: #00c851;
    }
    
    .order-item {
        background: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .order-item h4 {
        color: #333;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .order-item p {
        color: #666;
        margin: 5px 0;
        font-size: 14px;
    }
    
    .payment-status {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .status-unpaid {
        background: #f8d7da;
        color: #721c24;
    }
    
    .status-reported {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-confirmed {
        background: #d4edda;
        color: #155724;
    }
    
    .payment-form {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-top: 10px;
        border: 1px solid #dee2e6;
    }
    
    .payment-methods {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .payment-method {
        flex: 1;
        padding: 8px 12px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        text-align: center;
        font-size: 12px;
        transition: all 0.3s;
    }
    
    .payment-method.selected {
        border-color: #00c851;
        background: #d4edda;
        color: #155724;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #00c851;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .alert {
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 14px;
    }
    
    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .alert-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    
    .alert-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }
    
    .stat-number {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 12px;
        opacity: 0.9;
    }
    
    .connection-status {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        font-size: 12px;
        text-align: center;
    }
    
    .status-connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .status-testing {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .search-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .search-input {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .search-input input {
        flex: 1;
        padding: 10px 15px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }
    
    .search-input button {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }
    
    .member-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .member-item {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .member-item:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .member-item h5 {
        margin-bottom: 8px;
        color: #333;
    }
    
    .member-item p {
        margin: 3px 0;
        font-size: 13px;
        color: #666;
    }
    
    .admin-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }
    
    .admin-btn {
        flex: 1;
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .admin-btn-confirm {
        background: #28a745;
        color: white;
    }
    
    .admin-btn-reject {
        background: #dc3545;
        color: white;
    }
    
    .hidden {
        display: none !important;
    }
    
    .role-indicator {
        background: #007bff;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        margin-left: 10px;
    }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>🔍 訂購單查詢系統</h1>
        <div class="user-info" id="userInfo" style="display: none;">
            <div id="userName">載入中...</div>
            <div id="userId" style="font-size: 12px; opacity: 0.8;"></div>
            <div id="userRole" style="font-size: 12px; opacity: 0.8;"></div>
        </div>
    </div>
    
    <div class="content">
        <!-- 設定區塊 -->
        <div class="config-section">
            <h3>⚙️ 系統設定</h3>
            <input type="text" id="gasWebAppUrl" class="config-input" 
                   placeholder="請輸入 Google Apps Script Web App URL">
            <input type="text" id="liffId" class="config-input" 
                   placeholder="請輸入 LIFF ID">
            <button class="config-button" onclick="saveConfig()">💾 儲存設定</button>
            <button class="config-button" onclick="testConnection()">🔗 測試連線</button>
            <div id="connectionStatus"></div>
        </div>
        
        <!-- 會員資料設定 -->
        <div id="memberSetupSection" class="config-section" style="display: none;">
            <h3>👤 個人資料設定</h3>
            <div class="form-group">
                <label for="realName">真實姓名 *</label>
                <input type="text" id="realName" required placeholder="請輸入您的真實姓名">
            </div>
            <button class="config-button" onclick="saveMemberInfo()">💾 儲存個人資料</button>
        </div>
        
        <div class="tab-buttons" id="tabButtons">
            <button class="tab-button active" onclick="switchTab('orders')" id="ordersTabBtn">我的訂單</button>
            <button class="tab-button hidden" onclick="switchTab('admin')" id="adminTabBtn">管理介面</button>
        </div>
        
        <!-- 會員訂單查詢頁面 -->
        <div id="ordersTab" class="tab-content active">
            <div id="orderSummary" style="display: none;"></div>
            <div id="ordersList">
                <div class="loading">
                    <div class="spinner"></div>
                    載入訂單資料中...
                </div>
            </div>
        </div>
        
        <!-- 管理者介面 -->
        <div id="adminTab" class="tab-content">
            <div class="search-section">
                <h3>🔍 會員搜尋</h3>
                <div class="search-input">
                    <input type="text" id="searchInput" placeholder="輸入會員姓名搜尋...">
                    <button onclick="searchMembers()">搜尋</button>
                </div>
            </div>
            
            <div class="stats" id="adminStats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalMembers">0</div>
                    <div class="stat-label">總會員數</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingPayments">0</div>
                    <div class="stat-label">待確認繳費</div>
                </div>
            </div>
            
            <div id="membersList">
                <div class="loading">
                    <div class="spinner"></div>
                    載入會員資料中...
                </div>
            </div>
        </div>
        
        <div id="messageContainer"></div>
    </div>
</div>

<script>
    // 全域變數
    const FIXED_GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxPi3R9W2jB4W3s5tDxZ7dU0d3ka4Ba2Jg80H8ov9yVYIO7Iil0-fvQvkLyIFFpAw6-/exec';
    const FIXED_LIFF_ID = '1657285806-2bmkYWkN';
    let gasWebAppUrl = FIXED_GAS_WEB_APP_URL;
    let liffId = FIXED_LIFF_ID;
    let liffInitialized = false;
    let currentUser = null;
    // let gasWebAppUrl = '';
    // let liffId = '';
    let userRole = 'member'; // member 或 admin
    let groupInfo = null;
    
    // 管理者名單 (可從後端設定檔載入)
    const adminUsers = ['小劉（彤彤爸）', 'U47d2577a751e274ed113028beab304b7']; // 請根據實際需要調整
    
    // 頁面載入時初始化
    document.addEventListener('DOMContentLoaded', function() {
        loadConfig();
        initializeLiff();
    });
    
    // 載入設定
    function loadConfig() {
        try {
            gasWebAppUrl = localStorage.getItem('gasWebAppUrl') || '';
            liffId = localStorage.getItem('liffId') || '';
            
            document.getElementById('gasWebAppUrl').value = gasWebAppUrl;
            document.getElementById('liffId').value = liffId;
            
            updateConnectionStatus();
        } catch (error) {
            console.error('載入設定失敗:', error);
        }
    }
    
    // 儲存設定
    function saveConfig() {
        try {
            gasWebAppUrl = document.getElementById('gasWebAppUrl').value.trim();
            liffId = document.getElementById('liffId').value.trim();
            
            if (!gasWebAppUrl) {
                showMessage('請輸入 Google Apps Script Web App URL', 'error');
                return;
            }
            
            if (!liffId) {
                showMessage('請輸入 LIFF ID', 'error');
                return;
            }
            
            localStorage.setItem('gasWebAppUrl', gasWebAppUrl);
            localStorage.setItem('liffId', liffId);
            
            updateConnectionStatus();
            showMessage('✅ 設定已儲存！', 'success');
            
            // 重新初始化 LIFF
            setTimeout(() => {
                location.reload();
            }, 1000);
            
        } catch (error) {
            console.error('儲存設定失敗:', error);
            showMessage('❌ 儲存設定失敗: ' + error.message, 'error');
        }
    }
    
    // 測試連線
    async function testConnection() {
        if (!gasWebAppUrl) {
            showMessage('請先輸入並儲存 Google Apps Script Web App URL', 'error');
            return;
        }
        
        try {
            showConnectionStatus('🔄 測試連線中...', 'testing');
            
            const response = await fetch(gasWebAppUrl + '?action=test&timestamp=' + Date.now(), {
                method: 'GET',
                mode: 'cors'
            });
            
            if (response.ok) {
                const result = await response.json();
                showConnectionStatus('✅ 連線成功！', 'connected');
                showMessage('🎉 與後端連線成功！', 'success');
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
        } catch (error) {
            console.error('連線測試失敗:', error);
            showConnectionStatus('❌ 連線失敗', 'disconnected');
            showMessage('❌ 連線測試失敗: ' + error.message, 'error');
        }
    }
    
    // 更新連線狀態顯示
    function updateConnectionStatus() {
        if (gasWebAppUrl && liffId) {
            showConnectionStatus('⚡ 已設定完成', 'connected');
        } else {
            showConnectionStatus('⚠️ 請完成設定', 'disconnected');
        }
    }
    
    // 顯示連線狀態
    function showConnectionStatus(message, status) {
        const statusElement = document.getElementById('connectionStatus');
        const statusClass = `status-${status}`;
        
        statusElement.className = `connection-status ${statusClass}`;
        statusElement.textContent = message;
    }
    
    // LIFF 初始化
    async function initializeLiff() {
        try {
            if (!liffId) {
                showMessage('⚠️ 請先設定 LIFF ID', 'warning');
                return;
            }
            
            await liff.init({ liffId: liffId });
            
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }
            
            const profile = await liff.getProfile();
            currentUser = {
                displayName: profile.displayName,
                userId: profile.userId
            };
            
            // 獲取群組資訊
            try {
                const context = liff.getContext();
                if (context && context.type === 'group') {
                    groupInfo = {
                        groupName: '群組',
                        groupId: context.groupId
                    };
                } else {
                    groupInfo = {
                        groupName: '個人聊天',
                        groupId: 'personal'
                    };
                }
            } catch (contextError) {
                console.warn('無法獲取群組資訊:', contextError);
                groupInfo = {
                    groupName: '未知群組',
                    groupId: 'unknown'
                };
            }
            
            checkUserRole();
            updateUserInfo();
            showMemberSetup();
            liffInitialized = true;
            
        } catch (error) {
            console.error('LIFF 初始化失敗:', error);
            showMessage('❌ LIFF 初始化失敗: ' + error.message, 'error');
        }
    }
    
    // 檢查用戶角色
    function checkUserRole() {
        if (currentUser && adminUsers.includes(currentUser.displayName)) {
            userRole = 'admin';
            document.getElementById('adminTabBtn').classList.remove('hidden');
        } else {
            userRole = 'member';
            document.getElementById('adminTabBtn').classList.add('hidden');
        }
    }
    
    // 更新用戶資訊顯示
    function updateUserInfo() {
        if (currentUser) {
            document.getElementById('userName').innerHTML = 
                `👋 ${currentUser.displayName} <span class="role-indicator">${userRole === 'admin' ? '管理員' : '會員'}</span>`;
            document.getElementById('userId').textContent = `LINE ID: ${currentUser.userId}`;
            document.getElementById('userRole').textContent = 
                `群組: ${groupInfo ? groupInfo.groupName : '未知'}`;
            document.getElementById('userInfo').style.display = 'block';
        }
    }
    
    // 顯示會員資料設定
    function showMemberSetup() {
        const savedRealName = localStorage.getItem(`realName_${currentUser.userId}`);
        if (!savedRealName) {
            document.getElementById('memberSetupSection').style.display = 'block';
        } else {
            document.getElementById('realName').value = savedRealName;
            loadUserOrders();
        }
    }
    
    // 儲存會員資料
    function saveMemberInfo() {
        const realName = document.getElementById('realName').value.trim();
        
        if (!realName) {
            showMessage('請輸入真實姓名', 'error');
            return;
        }
        
        localStorage.setItem(`realName_${currentUser.userId}`, realName);
        document.getElementById('memberSetupSection').style.display = 'none';
        
        showMessage('✅ 個人資料已儲存！', 'success');
        loadUserOrders();
    }
    
    // 切換分頁
    function switchTab(tabName) {
        // 更新按鈕狀態
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(tabName + 'TabBtn').classList.add('active');
        
        // 更新內容顯示
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabName + 'Tab').classList.add('active');
        
        // 載入對應資料
        if (tabName === 'orders') {
            loadUserOrders();
        } else if (tabName === 'admin') {
            loadAdminData();
        }
    }
    
    // 載入用戶訂單
    async function loadUserOrders() {
        if (!gasWebAppUrl || !liffInitialized || !currentUser) {
            document.getElementById('ordersList').innerHTML = 
                '<div class="alert alert-error">❌ 系統尚未初始化完成，請確認設定</div>';
            return;
        }
        
        const realName = localStorage.getItem(`realName_${currentUser.userId}`);
        if (!realName) {
            document.getElementById('ordersList').innerHTML = 
                '<div class="alert alert-warning">⚠️ 請先設定個人資料</div>';
            return;
        }
        
        try {
            document.getElementById('ordersList').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    載入訂單資料中...
                </div>
            `;
            
            const url = `${gasWebAppUrl}?action=getUserOrdersByLineId&lineUserId=${encodeURIComponent(currentUser.userId)}&timestamp=${Date.now()}`;
            
            const response = await fetch(url, {
                method: 'GET',
                mode: 'cors'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                displayUserOrders(result.data || []);
            } else {
                throw new Error(result.message || '載入失敗');
            }
            
        } catch (error) {
            console.error('載入訂單失敗:', error);
            document.getElementById('ordersList').innerHTML = 
                `<div class="alert alert-error">❌ 載入失敗: ${error.message}</div>`;
        }
    }
    
// 前端 JavaScript 剩餘部分

// 顯示用戶訂單 (續)
function displayUserOrders(orders) {
    const summaryContainer = document.getElementById('orderSummary');
    const listContainer = document.getElementById('ordersList');
    
    if (!orders || orders.length === 0) {
        listContainer.innerHTML = 
            '<div class="alert alert-info">📝 暫無訂單記錄</div>';
        summaryContainer.style.display = 'none';
        return;
    }
    
    // 按產品合併數量
    const productSummary = {};
    let totalAmount = 0;
    
    orders.forEach(order => {
        const productId = order.productId || '未知產品';
        const quantity = parseInt(order.quantity) || 0;
        const unitPrice = parseFloat(order.unitPrice) || 0;
        const itemTotal = quantity * unitPrice;
        
        if (!productSummary[productId]) {
            productSummary[productId] = {
                quantity: 0,
                unitPrice: unitPrice,
                total: 0
            };
        }
        
        productSummary[productId].quantity += quantity;
        productSummary[productId].total += itemTotal;
        totalAmount += itemTotal;
    });
    
    // 顯示訂單摘要
    let summaryHtml = '<div class="order-summary"><h3>📊 訂單摘要</h3>';
    Object.keys(productSummary).forEach(productId => {
        const product = productSummary[productId];
        summaryHtml += `
            <div class="summary-item">
                <span>${productId}</span>
                <span>${product.quantity} 個 × $${product.unitPrice} = $${product.total}</span>
            </div>
        `;
    });
    summaryHtml += `
        <div class="summary-item">
            <span>總金額</span>
            <span>$${totalAmount}</span>
        </div>
    </div>`;
    
    summaryContainer.innerHTML = summaryHtml;
    summaryContainer.style.display = 'block';
    
    // 顯示訂單列表
    const orderHtml = orders.map((order, index) => {
        const paymentStatus = order.paymentStatus || 'unpaid';
        const statusText = paymentStatus === 'confirmed' ? '已確認' : 
                         paymentStatus === 'reported' ? '已回報' : '未繳費';
        const statusClass = `status-${paymentStatus}`;
        
        return `
            <div class="order-item">
                <h4>
                    📦 ${order.productId || '未知產品'}
                    <span class="payment-status ${statusClass}">${statusText}</span>
                </h4>
                <p>🔢 數量: ${order.quantity || 1}</p>
                <p>💰 單價: $${order.unitPrice || 0}</p>
                <p>💳 小計: $${(order.quantity || 1) * (order.unitPrice || 0)}</p>
                <p>📅 日期: ${formatDate(order.orderDate)}</p>
                ${order.paymentMethod ? `<p>💳 繳費方式: ${order.paymentMethod}</p>` : ''}
                ${order.paymentNote ? `<p>📝 備註: ${order.paymentNote}</p>` : ''}
                
                ${paymentStatus === 'unpaid' ? `
                    <div class="payment-form" id="paymentForm_${index}">
                        <h5>💳 回報繳費</h5>
                        <div class="payment-methods">
                            <div class="payment-method" onclick="selectPaymentMethod(${index}, 'cash')">💵 現金</div>
                            <div class="payment-method" onclick="selectPaymentMethod(${index}, 'transfer')">🏦 轉帳</div>
                            <div class="payment-method" onclick="selectPaymentMethod(${index}, 'linepay')">📱 LinePay</div>
                        </div>
                        <div class="form-group">
                            <textarea id="paymentNote_${index}" placeholder="備註 (轉帳請提供後5碼)" rows="2"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="reportPayment('${order.orderId}', ${index})">
                            ✅ 回報繳費
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
    
    listContainer.innerHTML = orderHtml;
}

// 選擇繳費方式
function selectPaymentMethod(orderIndex, method) {
    const form = document.getElementById(`paymentForm_${orderIndex}`);
    const methods = form.querySelectorAll('.payment-method');
    
    methods.forEach(m => m.classList.remove('selected'));
    event.target.classList.add('selected');
    
    // 儲存選擇的方式
    form.setAttribute('data-payment-method', method);
    
    // 如果是轉帳，自動聚焦到備註欄
    if (method === 'transfer') {
        document.getElementById(`paymentNote_${orderIndex}`).focus();
    }
}

// 回報繳費
async function reportPayment(orderId, orderIndex) {
    const form = document.getElementById(`paymentForm_${orderIndex}`);
    const paymentMethod = form.getAttribute('data-payment-method');
    const paymentNote = document.getElementById(`paymentNote_${orderIndex}`).value.trim();
    
    if (!paymentMethod) {
        showMessage('請選擇繳費方式', 'error');
        return;
    }
    
    if (paymentMethod === 'transfer' && !paymentNote) {
        showMessage('轉帳請提供後5碼或相關資訊', 'error');
        return;
    }
    
    try {
        const response = await fetch(gasWebAppUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'reportPayment',
                data: {
                    orderId: orderId,
                    paymentMethod: paymentMethod,
                    paymentNote: paymentNote,
                    reportedBy: currentUser.displayName,
                    reportedAt: new Date().toISOString()
                }
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('✅ 繳費回報成功！等待管理員確認', 'success');
            setTimeout(() => loadUserOrders(), 1000);
        } else {
            throw new Error(result.message || '回報失敗');
        }
        
    } catch (error) {
        console.error('回報繳費失敗:', error);
        showMessage('❌ 回報失敗: ' + error.message, 'error');
    }
}

// 載入管理者資料
async function loadAdminData() {
    if (userRole !== 'admin') {
        document.getElementById('membersList').innerHTML = 
            '<div class="alert alert-error">❌ 您沒有管理員權限</div>';
        return;
    }
    
    try {
        document.getElementById('membersList').innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                載入會員資料中...
            </div>
        `;
        
        const url = `${gasWebAppUrl}?action=getAllMembersWithOrders&timestamp=${Date.now()}`;
        
        const response = await fetch(url, {
            method: 'GET',
            mode: 'cors'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            displayMembersList(result.data || []);
        } else {
            throw new Error(result.message || '載入失敗');
        }
        
    } catch (error) {
        console.error('載入會員資料失敗:', error);
        document.getElementById('membersList').innerHTML = 
            `<div class="alert alert-error">❌ 載入失敗: ${error.message}</div>`;
    }
}

// 顯示會員列表
function displayMembersList(members) {
    const statsContainer = document.getElementById('adminStats');
    const listContainer = document.getElementById('membersList');
    
    if (!members || members.length === 0) {
        listContainer.innerHTML = 
            '<div class="alert alert-info">📝 暫無會員資料</div>';
        statsContainer.style.display = 'none';
        return;
    }
    
    // 計算統計資料
    const totalMembers = members.length;
    const pendingPayments = members.reduce((count, member) => {
        return count + (member.orders || []).filter(order => order.paymentStatus === 'reported').length;
    }, 0);
    
    document.getElementById('totalMembers').textContent = totalMembers;
    document.getElementById('pendingPayments').textContent = pendingPayments;
    statsContainer.style.display = 'grid';
    
    // 顯示會員列表
    const memberHtml = members.map(member => {
        const orders = member.orders || [];
        const totalAmount = orders.reduce((sum, order) => sum + ((order.quantity || 1) * (order.unitPrice || 0)), 0);
        const reportedOrders = orders.filter(order => order.paymentStatus === 'reported');
        
        return `
            <div class="member-item" onclick="toggleMemberDetails('${member.lineUserId}')">
                <h5>${member.realName || member.displayName} 
                    ${reportedOrders.length > 0 ? `<span class="payment-status status-reported">${reportedOrders.length} 筆待確認</span>` : ''}
                </h5>
                <p>📱 LINE: ${member.displayName}</p>
                <p>📦 訂單數: ${orders.length} 筆</p>
                <p>💰 總金額: $${totalAmount}</p>
                
                <div id="memberDetails_${member.lineUserId}" class="hidden" style="margin-top: 15px;">
                    ${orders.map(order => `
                        <div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 3px solid ${order.paymentStatus === 'reported' ? '#ffc107' : order.paymentStatus === 'confirmed' ? '#28a745' : '#dc3545'};">
                            <strong>${order.productId}</strong> - 數量: ${order.quantity} - $${(order.quantity || 1) * (order.unitPrice || 0)}
                            <br>狀態: ${order.paymentStatus === 'confirmed' ? '已確認' : order.paymentStatus === 'reported' ? '已回報' : '未繳費'}
                            ${order.paymentMethod ? `<br>繳費方式: ${order.paymentMethod}` : ''}
                            ${order.paymentNote ? `<br>備註: ${order.paymentNote}` : ''}
                            
                            ${order.paymentStatus === 'reported' ? `
                                <div class="admin-actions">
                                    <button class="admin-btn admin-btn-confirm" onclick="confirmPayment('${order.orderId}', event)">
                                        ✅ 確認繳費
                                    </button>
                                    <button class="admin-btn admin-btn-reject" onclick="rejectPayment('${order.orderId}', event)">
                                        ❌ 駁回
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }).join('');
    
    listContainer.innerHTML = memberHtml;
}

// 切換會員詳細資料顯示
function toggleMemberDetails(lineUserId) {
    const details = document.getElementById(`memberDetails_${lineUserId}`);
    if (details) {
        details.classList.toggle('hidden');
    }
}

// 搜尋會員
function searchMembers() {
    const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
    
    if (!searchTerm) {
        loadAdminData();
        return;
    }
    
    const memberItems = document.querySelectorAll('.member-item');
    memberItems.forEach(item => {
        const memberName = item.querySelector('h5').textContent.toLowerCase();
        if (memberName.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// 確認繳費
async function confirmPayment(orderId, event) {
    event.stopPropagation();
    
    if (!confirm('確定要確認此筆繳費嗎？')) {
        return;
    }
    
    try {
        const response = await fetch(gasWebAppUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'confirmPayment',
                data: {
                    orderId: orderId,
                    confirmedBy: currentUser.displayName,
                    confirmedAt: new Date().toISOString()
                }
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('✅ 繳費已確認！', 'success');
            setTimeout(() => loadAdminData(), 1000);
        } else {
            throw new Error(result.message || '確認失敗');
        }
        
    } catch (error) {
        console.error('確認繳費失敗:', error);
        showMessage('❌ 確認失敗: ' + error.message, 'error');
    }
}

// 駁回繳費
async function rejectPayment(orderId, event) {
    event.stopPropagation();
    
    const reason = prompt('請輸入駁回原因：');
    if (!reason) {
        return;
    }
    
    try {
        const response = await fetch(gasWebAppUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'rejectPayment',
                data: {
                    orderId: orderId,
                    rejectedBy: currentUser.displayName,
                    rejectedAt: new Date().toISOString(),
                    rejectionReason: reason
                }
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('✅ 繳費已駁回！', 'success');
            setTimeout(() => loadAdminData(), 1000);
        } else {
            throw new Error(result.message || '駁回失敗');
        }
        
    } catch (error) {
        console.error('駁回繳費失敗:', error);
        showMessage('❌ 駁回失敗: ' + error.message, 'error');
    }
}

// 格式化日期
function formatDate(dateString) {
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW') + ' ' + 
               date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
    } catch (error) {
        return '未知日期';
    }
}

// 顯示訊息
function showMessage(message, type = 'info') {
    const messageContainer = document.getElementById('messageContainer');
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-error' : 
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    
    messageContainer.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
    
    // 5秒後自動清除訊息
    setTimeout(() => {
        messageContainer.innerHTML = '';
    }, 5000);
}

    </script>
</body>
</html>
