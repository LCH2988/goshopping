<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã€å¤šç¦æ°£ã€‘BOGOè¨‚è³¼ç³»çµ±ç®¡ç†å¾Œå°</title>
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #00B900, #00D300);
        min-height: 100vh;
        padding: 20px;
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .header {
        background: linear-gradient(45deg, #00B900, #00D300);
        color: white;
        padding: 30px;
        text-align: center;
    }
    
    .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
    }
    
    .nav-tabs {
        display: flex;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        overflow-x: auto;
    }
    
    .nav-tab {
        flex: 1;
        min-width: 120px;
        padding: 15px 20px;
        text-align: center;
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: #6c757d;
        transition: all 0.3s ease;
        white-space: nowrap;
    }
    
    .nav-tab.active {
        background: white;
        color: #00B900;
        border-bottom: 3px solid #00B900;
    }
    
    .content {
        padding: 30px;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #00B900, #00D300);
        color: white;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 185, 0, 0.3);
    }
    
    .stat-number {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 8px;
    }
    
    .stat-label {
        font-size: 14px;
        opacity: 0.9;
    }
    
    .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .table th {
        background: #f8f9fa;
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
    }
    
    .table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
        vertical-align: middle;
    }
    
    .table tr:hover {
        background: #f8f9fa;
    }
    
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
        margin: 2px;
    }
    
    .btn-primary {
        background: #00B900;
        color: white;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-warning {
        background: #ffc107;
        color: #212529;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .status-badge {
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-pending {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-approved {
        background: #d4edda;
        color: #155724;
    }
    
    .status-rejected {
        background: #f8d7da;
        color: #721c24;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #00B900;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #dc3545;
    }
    
    .success {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #28a745;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
    }
    
    .close:hover {
        color: #000;
    }
    
    .admin-info {
        background: #e8f5e8;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        border-left: 4px solid #00B900;
    }
    
    .admin-info h3 {
        color: #00B900;
        margin-bottom: 10px;
    }
    
    .order-details {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
    }
    
    .product-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        font-size: 14px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .product-item:last-child {
        border-bottom: none;
    }
    
    .product-name {
        font-weight: 600;
        color: #333;
    }
    
    .product-details {
        text-align: right;
        color: #666;
    }
    
    @media (max-width: 768px) {
        .nav-tabs {
            flex-direction: column;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .table {
            min-width: 600px;
        }
        
        .content {
            padding: 15px;
        }
    }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ›¡ï¸ ã€å¤šç¦æ°£ã€‘BOGOç®¡ç†å¾Œå°</h1>
        <p>è¨‚è³¼ç®¡ç† Â· ç¹³è²»å¯©æ ¸ Â· ç”¨æˆ¶çµ±è¨ˆ</p>
    </div>
    
    <!-- ç®¡ç†è€…è³‡è¨Š -->
    <div id="adminInfo" class="admin-info" style="display: none; margin: 20px 30px 0;">
        <h3>ğŸ‘¤ ç®¡ç†è€…è³‡è¨Š</h3>
        <div id="adminDetails"></div>
    </div>
    
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('dashboard')">ğŸ“Š å„€è¡¨æ¿</button>
        <button class="nav-tab" onclick="switchTab('pending')">â³ å¾…å¯©æ ¸</button>
        <button class="nav-tab" onclick="switchTab('payments')">ğŸ’° ç¹³è²»è¨˜éŒ„</button>
        <button class="nav-tab" onclick="switchTab('orders')">ğŸ“‹ è¨‚å–®ç®¡ç†</button>
        <button class="nav-tab" onclick="switchTab('users')">ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</button>
        <button class="nav-tab" onclick="switchTab('reports')">ğŸ“ˆ å ±è¡¨</button>
        <button class="nav-tab" onclick="switchTab('settings')">âš™ï¸ ç³»çµ±è¨­å®š</button>
    </div>
    
    <div class="content">
        <!-- å„€è¡¨æ¿ -->
        <div id="dashboard" class="tab-content active">
            <div id="dashboardStats" class="stats-grid">
                <div class="loading">è¼‰å…¥çµ±è¨ˆè³‡æ–™ä¸­...</div>
            </div>
            
            <div class="table-container">
                <h3 style="padding: 20px 20px 0; margin: 0;">ğŸ“ˆ ç³»çµ±æ¦‚è¦½</h3>
                <div id="systemOverview" style="padding: 20px;">
                    <div class="loading">è¼‰å…¥ç³»çµ±æ¦‚è¦½ä¸­...</div>
                </div>
            </div>
        </div>
        
        <!-- å¾…å¯©æ ¸ -->
        <div id="pending" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2>â³ å¾…å¯©æ ¸ç¹³è²»è¨˜éŒ„</h2>
                <div>
                    <button class="btn btn-success" onclick="batchApprove()">âœ… æ‰¹é‡é€šé</button>
                    <button class="btn btn-danger" onclick="batchReject()">âŒ æ‰¹é‡æ‹’çµ•</button>
                    <button class="btn btn-primary" onclick="loadPendingPayments()">ğŸ”„ é‡æ–°æ•´ç†</button>
                </div>
            </div>
            
            <div class="table-container">
                <div id="pendingPaymentsTable">
                    <div class="loading">è¼‰å…¥å¾…å¯©æ ¸è¨˜éŒ„ä¸­...</div>
                </div>
            </div>
        </div>
        
        <!-- ç¹³è²»è¨˜éŒ„ -->
        <div id="payments" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2>ğŸ’° æ‰€æœ‰ç¹³è²»è¨˜éŒ„</h2>
                <div>
                    <select id="paymentStatusFilter" onchange="filterPayments()">
                        <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="å¾…å¯©æ ¸">å¾…å¯©æ ¸</option>
                        <option value="å·²ç¢ºèª">å·²ç¢ºèª</option>
                        <option value="å·²æ‹’çµ•">å·²æ‹’çµ•</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadAllPayments()">ğŸ”„ é‡æ–°æ•´ç†</button>
                </div>
            </div>
            <div class="table-container">
                <div id="allPaymentsTable">
                    <div class="loading">è¼‰å…¥ç¹³è²»è¨˜éŒ„ä¸­...</div>
                </div>
            </div>
        </div>
        
        <!-- è¨‚å–®ç®¡ç† -->
        <div id="orders" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2>ğŸ“‹ è¨‚å–®ç®¡ç†</h2>
                <div>
                    <input type="text" id="orderSearchInput" placeholder="æœå°‹LINEåç¨±æˆ–çœŸå¯¦å§“å" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                    <button class="btn btn-primary" onclick="searchOrders()">ğŸ” æœå°‹</button>
                    <button class="btn btn-primary" onclick="loadAllOrders()">ğŸ”„ é‡æ–°æ•´ç†</button>
                </div>
            </div>
            <div class="table-container">
                <div id="allOrdersTable">
                    <div class="loading">è¼‰å…¥è¨‚å–®è³‡æ–™ä¸­...</div>
                </div>
            </div>
        </div>
        
        <!-- ç”¨æˆ¶ç®¡ç† -->
        <div id="users" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</h2>
            <div class="table-container">
                <div id="usersTable">
                    <div class="loading">è¼‰å…¥ç”¨æˆ¶è³‡æ–™ä¸­...</div>
                </div>
            </div>
        </div>
        
        <!-- å ±è¡¨ -->
        <div id="reports" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ“ˆ ç³»çµ±å ±è¡¨</h2>
            
            <div class="form-group">
                <label for="reportDate">é¸æ“‡æ—¥æœŸç¯„åœ</label>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="date" id="reportStartDate" style="flex: 1; min-width: 150px;">
                    <span>è‡³</span>
                    <input type="date" id="reportEndDate" style="flex: 1; min-width: 150px;">
                    <button class="btn btn-primary" onclick="generateReport()">ğŸ“Š ç”Ÿæˆå ±è¡¨</button>
                </div>
            </div>
            
            <div id="reportContent">
                <div class="loading">è«‹é¸æ“‡æ—¥æœŸç¯„åœä¸¦ç”Ÿæˆå ±è¡¨</div>
            </div>
        </div>
        
        <!-- ç³»çµ±è¨­å®š -->
        <div id="settings" class="tab-content">
            <h2 style="margin-bottom: 20px;">âš™ï¸ ç³»çµ±è¨­å®š</h2>
            
            <div style="display: grid; gap: 20px;">
                <div class="table-container" style="padding: 20px;">
                    <h3>ğŸ“Š è³‡æ–™ç®¡ç†</h3>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-warning" onclick="exportAllData()">
                            ğŸ“Š åŒ¯å‡ºæ‰€æœ‰è³‡æ–™
                        </button>
                        <button class="btn btn-primary" onclick="exportPaymentRecords()">
                            ğŸ’° åŒ¯å‡ºç¹³è²»è¨˜éŒ„
                        </button>
                        <button class="btn btn-success" onclick="exportUserList()">
                            ğŸ‘¥ åŒ¯å‡ºç”¨æˆ¶æ¸…å–®
                        </button>
                        <button class="btn btn-danger" onclick="cleanupOldData()">
                            ğŸ—‘ï¸ æ¸…ç†èˆŠè³‡æ–™
                        </button>
                    </div>
                </div>
                
                <div class="table-container" style="padding: 20px;">
                    <h3>â„¹ï¸ ç³»çµ±è³‡è¨Š</h3>
                    <div id="systemInfo" style="margin-top: 15px;">
                        <div class="loading">è¼‰å…¥ç³»çµ±è³‡è¨Šä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¯©æ ¸æ¨¡æ…‹æ¡† -->
<div id="reviewModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>ğŸ” å¯©æ ¸ç¹³è²»è¨˜éŒ„</h2>
        <form id="reviewForm">
            <input type="hidden" id="reviewPaymentId">
            
            <div class="form-group">
                <label>ğŸ“‹ ç¹³è²»è³‡è¨Š</label>
                <div id="reviewPaymentInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                </div>
            </div>
            
            <div class="form-group">
                <label for="reviewStatus">å¯©æ ¸çµæœ *</label>
                <select id="reviewStatus" required>
                    <option value="">è«‹é¸æ“‡å¯©æ ¸çµæœ</option>
                    <option value="å·²ç¢ºèª">âœ… é€šé - ç¢ºèªç¹³è²»</option>
                    <option value="å·²æ‹’çµ•">âŒ æ‹’çµ• - ç¹³è²»æœ‰å•é¡Œ</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="reviewNote">å¯©æ ¸å‚™è¨»</label>
                <textarea id="reviewNote" placeholder="è«‹è¼¸å…¥å¯©æ ¸å‚™è¨»ï¼ˆå¯é¸ï¼‰..." rows="3"></textarea>
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeReviewModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ç¢ºèªå¯©æ ¸</button>
            </div>
        </form>
    </div>
</div>

<!-- è¨‚å–®è©³æƒ…æ¨¡æ…‹æ¡† -->
<div id="orderModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeOrderModal()">&times;</span>
        <h2>ğŸ“‹ è¨‚å–®è©³æƒ…</h2>
        <div id="orderModalContent">
            <div class="loading">è¼‰å…¥ä¸­...</div>
        </div>
    </div>
</div>

<script>
    // è¨­å®šå€åŸŸ - è«‹ä¿®æ”¹ç‚ºæ‚¨çš„å¯¦éš›å€¼
    const CONFIG = {
        LIFF_ID: '1657285806-2bmkYWkN', // è«‹æ›¿æ›ç‚ºå¯¦éš›çš„ LIFF ID
        API_BASE_URL: 'https://script.google.com/macros/s/AKfycbx4IpYvra7_GTFLSKj0PdmmK0-gbKt5S0yjEYPwP3PbiwFTPkNGPVCNNSVVJMkuXK-r3Q/exec', // è«‹æ›¿æ›ç‚º GAS éƒ¨ç½²ç¶²å€
        DEBUG_MODE: false,
        ADMIN_USER_IDS: [
            // è«‹åœ¨é€™è£¡æ·»åŠ ç®¡ç†è€…çš„ LINE User ID
            'U5b799eb608fbe4064fd0a85f7af2370f',
            'Ubdfa881413facf7f715365bbebb468ab'
        ]
    };

    // å…¨åŸŸè®Šæ•¸
    let adminUserId = null;
    let adminProfile = null;
    let pendingPayments = [];
    let allPayments = [];
    let selectedPayments = [];
    let allOrders = [];
    let allUsers = [];

    // é™¤éŒ¯å‡½æ•¸
    function debugLog(message, data = null) {
        if (CONFIG.DEBUG_MODE) {
            console.log(message, data);
        }
    }

    // åˆå§‹åŒ–
    window.onload = function() {
        debugLog('é–‹å§‹åˆå§‹åŒ–ç®¡ç†å¾Œå°');
        initializeLiff();
    };

    async function initializeLiff() {
        try {
            debugLog('LIFF åˆå§‹åŒ–ä¸­...', { liffId: CONFIG.LIFF_ID });
            
            await liff.init({ liffId: CONFIG.LIFF_ID });
            debugLog('LIFF åˆå§‹åŒ–æˆåŠŸ');
            
            if (liff.isLoggedIn()) {
                adminProfile = await liff.getProfile();
                adminUserId = adminProfile.userId;
                
                debugLog('å–å¾—ç®¡ç†è€…è³‡æ–™', {
                    userId: adminUserId,
                    displayName: adminProfile.displayName
                });
                
                // é©—è­‰ç®¡ç†è€…æ¬Šé™
                if (isAuthorizedAdmin()) {
                    displayAdminInfo();
                    loadDashboard();
                    debugLog('ç®¡ç†è€…é©—è­‰æˆåŠŸ');
                } else {
                    showError('âŒ æ¬Šé™ä¸è¶³ï¼šæ‚¨ä¸æ˜¯ç³»çµ±ç®¡ç†è€…');
                    debugLog('ç®¡ç†è€…é©—è­‰å¤±æ•—', { userId: adminUserId });
                }
            } else {
                debugLog('ç”¨æˆ¶æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
                liff.login();
            }
        } catch (error) {
            debugLog('åˆå§‹åŒ–å¤±æ•—', error);
            console.error('åˆå§‹åŒ–å¤±æ•—:', error);
            showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—: ' + error.message);
        }
    }

    // é©—è­‰ç®¡ç†è€…æ¬Šé™
    function isAuthorizedAdmin() {
        // å¦‚æœæ²’æœ‰è¨­å®šç®¡ç†è€…IDï¼Œå‰‡å…è¨±æ‰€æœ‰ç”¨æˆ¶ï¼ˆé–‹ç™¼æ¨¡å¼ï¼‰
        if (CONFIG.ADMIN_USER_IDS.length === 0) {
            debugLog('é–‹ç™¼æ¨¡å¼ï¼šå…è¨±æ‰€æœ‰ç”¨æˆ¶è¨ªå•ç®¡ç†å¾Œå°');
            return true;
        }
        
        return CONFIG.ADMIN_USER_IDS.includes(adminUserId);
    }

    // é¡¯ç¤ºç®¡ç†è€…è³‡è¨Š
    function displayAdminInfo() {
        const adminInfoDiv = document.getElementById('adminInfo');
        const adminDetailsDiv = document.getElementById('adminDetails');
        
        if (!adminInfoDiv || !adminDetailsDiv) return;

        let html = `
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div>
                    <strong>ç®¡ç†è€…ï¼š</strong>${adminProfile.displayName}<br>
                    <small style="color: #666;">ç™»å…¥æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}</small>
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="liff.logout(); location.reload();">
                        ğŸšª ç™»å‡º
                    </button>
                </div>
            </div>
        `;

        adminDetailsDiv.innerHTML = html;
        adminInfoDiv.style.display = 'block';
    }

    // API å‘¼å«å‡½æ•¸
    async function callAPI(action, data) {
        try {
            debugLog(`å‘¼å« API: ${action}`, data);
            
            const enhancedData = {
                ...data,
                adminUserId: adminUserId,
                timestamp: new Date().toISOString()
            };
            
            const result = await callApiWithJsonp(action, enhancedData);
            debugLog('API å›æ‡‰', result);
            
            return result;
            
        } catch (error) {
            debugLog('API å‘¼å«å¤±æ•—', error);
            console.error(`API å‘¼å«å¤±æ•— (${action}):`, error);
            throw error;
        }
    }

    // JSONP æ–¹å¼å‘¼å« API
    function callApiWithJsonp(action, data) {
        return new Promise((resolve, reject) => {
            const callbackName = 'adminCallback_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
            
            window[callbackName] = function(response) {
                delete window[callbackName];
                document.head.removeChild(script);
                resolve(response);
            };
            
            const script = document.createElement('script');
            const params = new URLSearchParams();
            params.append('action', action);
            params.append('callback', callbackName);
            
            if (data) {
                params.append('data', JSON.stringify(data));
            }
            
            script.src = CONFIG.API_BASE_URL + '?' + params.toString();
            
            script.onerror = function() {
                delete window[callbackName];
                document.head.removeChild(script);
                reject(new Error('JSONP è«‹æ±‚å¤±æ•—'));
            };
            
            setTimeout(() => {
                if (window[callbackName]) {
                    delete window[callbackName];
                    document.head.removeChild(script);
                    reject(new Error('API è«‹æ±‚è¶…æ™‚'));
                }
            }, 15000);
            
            document.head.appendChild(script);
        });
    }

    // æ¨™ç±¤é åˆ‡æ›
    function switchTab(tabName) {
        debugLog(`åˆ‡æ›æ¨™ç±¤é : ${tabName}`);
        
        // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => content.classList.remove('active'));
        
        // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
        const navTabs = document.querySelectorAll('.nav-tab');
        navTabs.forEach(tab => tab.classList.remove('active'));
        
        // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
        
        // è¼‰å…¥å°æ‡‰å…§å®¹
        loadTabContent(tabName);
    }

    async function loadTabContent(tabName) {
        switch (tabName) {
            case 'dashboard':
                loadDashboard();
                break;
            case 'pending':
                loadPendingPayments();
                break;
            case 'payments':
                loadAllPayments();
                break;
            case 'orders':
                loadAllOrders();
                break;
            case 'users':
                loadUsers();
                break;
            case 'reports':
                initReports();
                break;
            case 'settings':
                loadSystemInfo();
                break;
        }
    }

    // è¼‰å…¥å„€è¡¨æ¿
    async function loadDashboard() {
        try {
            debugLog('è¼‰å…¥å„€è¡¨æ¿');
            
            // åŒæ™‚è¼‰å…¥çµ±è¨ˆè³‡æ–™
            const [statsResult, paymentsResult, usersResult] = await Promise.all([
                callAPI('get-statistics', {}),
                callAPI('get-all-payments', {}),
                callAPI('get-all-users', {})
            ]);
            
            if (statsResult.success) {
                displayDashboardStats(statsResult.statistics);
            }
            
            // é¡¯ç¤ºç³»çµ±æ¦‚è¦½
            displaySystemOverview({
                totalPayments: paymentsResult.success ? paymentsResult.payments.length : 0,
                totalUsers: usersResult.success ? usersResult.users.length : 0,
                lastUpdate: new Date().toLocaleString('zh-TW')
            });
            
        } catch (error) {
            debugLog('è¼‰å…¥å„€è¡¨æ¿å¤±æ•—', error);
            console.error('è¼‰å…¥å„€è¡¨æ¿å¤±æ•—:', error);
            showError('è¼‰å…¥å„€è¡¨æ¿å¤±æ•—: ' + error.message);
        }
    }

function displayDashboardStats(statistics) {
    const statsHtml = `
        <div class="stat-card">
            <div class="stat-number">${statistics.totalUsers || 0}</div>
            <div class="stat-label">è¨»å†Šç”¨æˆ¶</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${statistics.totalOrders || 0}</div>
            <div class="stat-label">è¨‚å–®è¨˜éŒ„</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${statistics.pendingPayments || 0}</div>
            <div class="stat-label">å¾…å¯©æ ¸</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">NT$ ${(statistics.totalAmount || 0).toLocaleString()}</div>
            <div class="stat-label">ç¸½é‡‘é¡</div>
        </div>
    `;
    
    document.getElementById('dashboardStats').innerHTML = statsHtml;
}

function displaySystemOverview(data) {
    const overviewHtml = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
                <h4 style="color: #00B900; margin-bottom: 10px;">ğŸ“Š ç³»çµ±ç‹€æ…‹</h4>
                <p><strong>ç¸½ç¹³è²»è¨˜éŒ„ï¼š</strong> ${data.totalPayments}</p>
                <p><strong>ç¸½è¨»å†Šç”¨æˆ¶ï¼š</strong> ${data.totalUsers}</p>
                <p><strong>æœ€å¾Œæ›´æ–°ï¼š</strong> ${data.lastUpdate}</p>
            </div>
            <div>
                <h4 style="color: #00B900; margin-bottom: 10px;">ğŸ”§ å¿«é€Ÿæ“ä½œ</h4>
                <button class="btn btn-primary" onclick="switchTab('pending')" style="display: block; margin: 5px 0;">
                    æŸ¥çœ‹å¾…å¯©æ ¸
                </button>
                <button class="btn btn-success" onclick="exportPaymentRecords()" style="display: block; margin: 5px 0;">
                    åŒ¯å‡ºç¹³è²»è¨˜éŒ„
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('systemOverview').innerHTML = overviewHtml;
}

// è¼‰å…¥å¾…å¯©æ ¸ç¹³è²»è¨˜éŒ„
async function loadPendingPayments() {
    try {
        debugLog('è¼‰å…¥å¾…å¯©æ ¸ç¹³è²»è¨˜éŒ„');
        document.getElementById('pendingPaymentsTable').innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
        
        const result = await callAPI('get-all-payments', {});
        
        if (result.success) {
            // ç¯©é¸å‡ºå¾…å¯©æ ¸çš„è¨˜éŒ„
            pendingPayments = result.payments.filter(payment => payment.status === 'å¾…å¯©æ ¸');
            displayPendingPayments(pendingPayments);
        } else {
            throw new Error(result.message || 'è¼‰å…¥å¤±æ•—');
        }
    } catch (error) {
        debugLog('è¼‰å…¥å¾…å¯©æ ¸è¨˜éŒ„å¤±æ•—', error);
        console.error('è¼‰å…¥å¾…å¯©æ ¸è¨˜éŒ„å¤±æ•—:', error);
        document.getElementById('pendingPaymentsTable').innerHTML = 
            `<div class="error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
    }
}

function displayPendingPayments(payments) {
    if (payments.length === 0) {
        document.getElementById('pendingPaymentsTable').innerHTML = 
            '<div style="padding: 40px; text-align: center; color: #6c757d;">ğŸ‰ ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„ç¹³è²»è¨˜éŒ„</div>';
        return;
    }
    
    let html = `
        <table class="table">
            <thead>
                <tr>
                    <th><input type="checkbox" onchange="toggleAllPayments(this)"></th>
                    <th>è¨‚å–®è³‡è¨Š</th>
                    <th>ç”¨æˆ¶è³‡è¨Š</th>
                    <th>ç¹³è²»è³‡è¨Š</th>
                    <th>æäº¤æ™‚é–“</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    payments.forEach((payment, index) => {
        html += `
            <tr>
                <td><input type="checkbox" value="${index}" onchange="togglePaymentSelection(this, '${payment.orderId}')"></td>
                <td>
                    <div style="font-weight: 600;">${payment.orderId}</div>
                    <small style="color: #6c757d;">è¨‚å–®ç·¨è™Ÿ</small>
                </td>
                <td>
                    <div style="font-weight: 600;">${payment.realName}</div>
                    <small style="color: #6c757d;">${payment.lineName}</small>
                </td>
                <td>
                    <div style="font-weight: 600;">NT$ ${payment.paymentAmount.toLocaleString()}</div>
                    <small style="color: #6c757d;">${getPaymentMethodText(payment.paymentMethod)}</small>
                    ${payment.paymentNote ? `<br><small style="color: #666;">å‚™è¨»: ${payment.paymentNote}</small>` : ''}
                </td>
                <td>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</td>
                <td>
                    <button class="btn btn-primary" onclick="openReviewModal('${payment.orderId}')">
                        ğŸ” å¯©æ ¸
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    document.getElementById('pendingPaymentsTable').innerHTML = html;
}

// è¼‰å…¥æ‰€æœ‰ç¹³è²»è¨˜éŒ„
async function loadAllPayments() {
    try {
        debugLog('è¼‰å…¥æ‰€æœ‰ç¹³è²»è¨˜éŒ„');
        document.getElementById('allPaymentsTable').innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
        
        const result = await callAPI('get-all-payments', {});
        
        if (result.success) {
            allPayments = result.payments || [];
            displayAllPayments(allPayments);
        } else {
            throw new Error(result.message || 'è¼‰å…¥å¤±æ•—');
        }
    } catch (error) {
        debugLog('è¼‰å…¥ç¹³è²»è¨˜éŒ„å¤±æ•—', error);
        console.error('è¼‰å…¥ç¹³è²»è¨˜éŒ„å¤±æ•—:', error);
        document.getElementById('allPaymentsTable').innerHTML = 
            `<div class="error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
    }
}

function displayAllPayments(payments) {
    if (payments.length === 0) {
        document.getElementById('allPaymentsTable').innerHTML = 
            '<div style="padding: 40px; text-align: center; color: #6c757d;">ç›®å‰æ²’æœ‰ç¹³è²»è¨˜éŒ„</div>';
        return;
    }
    
    let html = `
        <table class="table">
            <thead>
                <tr>
                    <th>è¨‚å–®ç·¨è™Ÿ</th>
                    <th>ç”¨æˆ¶è³‡è¨Š</th>
                    <th>ç¹³è²»è³‡è¨Š</th>
                    <th>ç‹€æ…‹</th>
                    <th>æ™‚é–“</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    payments.forEach(payment => {
        const statusClass = getStatusClass(payment.status);
        const statusText = getStatusText(payment.status);
        
        html += `
            <tr>
                <td>
                    <div style="font-weight: 600;">${payment.orderId}</div>
                </td>
                <td>
                    <div style="font-weight: 600;">${payment.realName}</div>
                    <small style="color: #6c757d;">${payment.lineName}</small>
                </td>
                <td>
                    <div>NT$ ${payment.paymentAmount.toLocaleString()}</div>
                    <small style="color: #6c757d;">${getPaymentMethodText(payment.paymentMethod)}</small>
                    ${payment.paymentNote ? `<br><small style="color: #666;">å‚™è¨»: ${payment.paymentNote}</small>` : ''}
                </td>
                <td>
                    <span class="status-badge status-${statusClass}">${statusText}</span>
                </td>
                <td>
                    <div style="font-size: 12px;">
                        æäº¤: ${new Date(payment.submittedAt).toLocaleDateString('zh-TW')}
                    </div>
                </td>
                <td>
                    ${payment.status === 'å¾…å¯©æ ¸' ? 
                        `<button class="btn btn-primary" onclick="openReviewModal('${payment.orderId}')">ğŸ” å¯©æ ¸</button>` : 
                        `<button class="btn btn-secondary" onclick="viewPaymentDetails('${payment.orderId}')">ğŸ“„ è©³æƒ…</button>`
                    }
                </td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    document.getElementById('allPaymentsTable').innerHTML = html;
}

// è¼‰å…¥æ‰€æœ‰è¨‚å–®
async function loadAllOrders() {
    try {
        debugLog('è¼‰å…¥æ‰€æœ‰è¨‚å–®');
        document.getElementById('allOrdersTable').innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
        
        const result = await callAPI('get-all-users', {});
        
        if (result.success) {
            allUsers = result.users || [];
            // ç‚ºæ¯å€‹ç”¨æˆ¶è¼‰å…¥è¨‚å–®æ‘˜è¦
            const ordersPromises = allUsers.map(async user => {
                try {
                    const orderResult = await callAPI('orders', { lineName: user.lineDisplayName });
                    return {
                        user: user,
                        orderSummary: orderResult.success ? orderResult.orderSummary : null
                    };
                } catch (error) {
                    debugLog(`è¼‰å…¥ç”¨æˆ¶ ${user.lineDisplayName} è¨‚å–®å¤±æ•—`, error);
                    return {
                        user: user,
                        orderSummary: null
                    };
                }
            });
            
            const ordersData = await Promise.all(ordersPromises);
            allOrders = ordersData.filter(data => data.orderSummary !== null);
            displayAllOrders(allOrders);
        } else {
            throw new Error(result.message || 'è¼‰å…¥å¤±æ•—');
        }
    } catch (error) {
        debugLog('è¼‰å…¥è¨‚å–®å¤±æ•—', error);
        console.error('è¼‰å…¥è¨‚å–®å¤±æ•—:', error);
        document.getElementById('allOrdersTable').innerHTML = 
            `<div class="error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
    }
}

function displayAllOrders(orders) {
    if (orders.length === 0) {
        document.getElementById('allOrdersTable').innerHTML = 
            '<div style="padding: 40px; text-align: center; color: #6c757d;">ç›®å‰æ²’æœ‰è¨‚å–®è¨˜éŒ„</div>';
        return;
    }
    
    let html = `
        <table class="table">
            <thead>
                <tr>
                    <th>è¨‚å–®ç·¨è™Ÿ</th>
                    <th>ç”¨æˆ¶è³‡è¨Š</th>
                    <th>ç”¢å“æ•¸é‡</th>
                    <th>ç¸½é‡‘é¡</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    orders.forEach(orderData => {
        const order = orderData.orderSummary;
        const user = orderData.user;
        
        html += `
            <tr>
                <td>
                    <div style="font-weight: 600;">${order.orderId}</div>
                </td>
                <td>
                    <div style="font-weight: 600;">${order.realName}</div>
                    <small style="color: #6c757d;">${order.lineName}</small>
                </td>
                <td>
                    <div>${order.products.length} ç¨®ç”¢å“</div>
                    <small style="color: #6c757d;">å…± ${order.products.reduce((sum, p) => sum + p.quantity, 0)} ä»¶</small>
                </td>
                <td>
                    <div style="font-weight: 600; color: #00B900;">NT$ ${order.totalAmount.toLocaleString()}</div>
                </td>
                <td>
                    <button class="btn btn-primary" onclick="viewOrderDetails('${order.orderId}')">
                        ğŸ“‹ æŸ¥çœ‹è©³æƒ…
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    document.getElementById('allOrdersTable').innerHTML = html;
}

// è¼‰å…¥ç”¨æˆ¶è³‡æ–™
async function loadUsers() {
    try {
        debugLog('è¼‰å…¥ç”¨æˆ¶è³‡æ–™');
        document.getElementById('usersTable').innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
        
        const result = await callAPI('get-all-users', {});
        
        if (result.success) {
            allUsers = result.users || [];
            displayUsers(allUsers);
        } else {
            throw new Error(result.message || 'è¼‰å…¥å¤±æ•—');
        }
    } catch (error) {
        debugLog('è¼‰å…¥ç”¨æˆ¶è³‡æ–™å¤±æ•—', error);
        console.error('è¼‰å…¥ç”¨æˆ¶è³‡æ–™å¤±æ•—:', error);
        document.getElementById('usersTable').innerHTML = 
            `<div class="error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
    }
}

function displayUsers(users) {
    if (users.length === 0) {
        document.getElementById('usersTable').innerHTML = 
            '<div style="padding: 40px; text-align: center; color: #6c757d;">ç›®å‰æ²’æœ‰è¨»å†Šç”¨æˆ¶</div>';
        return;
    }
    
    let html = `
        <table class="table">
            <thead>
                <tr>
                    <th>ç”¨æˆ¶è³‡è¨Š</th>
                    <th>è¨»å†Šæ™‚é–“</th>
                    <th>ç‹€æ…‹</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    users.forEach(user => {
        html += `
            <tr>
                <td>
                    <div style="font-weight: 600;">${user.realName}</div>
                    <small style="color: #6c757d;">${user.lineDisplayName}</small>
                    <div style="font-size: 11px; color: #999; margin-top: 2px;">
                        ID: ${user.userId.substring(0, 20)}...
                    </div>
                </td>
                <td>${new Date(user.registeredAt).toLocaleString('zh-TW')}</td>
                <td>
                    <span class="status-badge status-approved">æ­£å¸¸</span>
                </td>
                <td>
                    <button class="btn btn-primary" onclick="viewUserOrders('${user.lineDisplayName}')">
                        ğŸ“‹ æŸ¥çœ‹è¨‚å–®
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    document.getElementById('usersTable').innerHTML = html;
}

// åˆå§‹åŒ–å ±è¡¨
function initReports() {
    debugLog('åˆå§‹åŒ–å ±è¡¨');
    const today = new Date().toISOString().split('T')[0];
    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    
    document.getElementById('reportStartDate').value = weekAgo;
    document.getElementById('reportEndDate').value = today;
}

// ç”Ÿæˆå ±è¡¨
async function generateReport() {
    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;
    
    if (!startDate || !endDate) {
        alert('è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸ');
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        alert('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ');
        return;
    }
    
    try {
        debugLog('ç”Ÿæˆå ±è¡¨', { startDate, endDate });
        document.getElementById('reportContent').innerHTML = '<div class="loading">ç”Ÿæˆå ±è¡¨ä¸­...</div>';
        
        // è¼‰å…¥æ‰€æœ‰è³‡æ–™ä¸¦é€²è¡Œåˆ†æ
        const [paymentsResult, usersResult] = await Promise.all([
            callAPI('get-all-payments', {}),
            callAPI('get-all-users', {})
        ]);
        
        if (paymentsResult.success && usersResult.success) {
            const report = generateReportData(paymentsResult.payments, usersResult.users, startDate, endDate);
            displayReport(report);
        } else {
            throw new Error('è¼‰å…¥å ±è¡¨è³‡æ–™å¤±æ•—');
        }
    } catch (error) {
        debugLog('ç”Ÿæˆå ±è¡¨å¤±æ•—', error);
        console.error('ç”Ÿæˆå ±è¡¨å¤±æ•—:', error);
        document.getElementById('reportContent').innerHTML = 
            `<div class="error">ç”Ÿæˆå ±è¡¨å¤±æ•—: ${error.message}</div>`;
    }
}

function generateReportData(payments, users, startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate + 'T23:59:59');
    
    // ç¯©é¸æ—¥æœŸç¯„åœå…§çš„è³‡æ–™
    const periodPayments = payments.filter(payment => {
        const paymentDate = new Date(payment.submittedAt);
        return paymentDate >= start && paymentDate <= end;
    });
    
    const periodUsers = users.filter(user => {
        const regDate = new Date(user.registeredAt);
        return regDate >= start && regDate <= end;
    });
    
    // çµ±è¨ˆè³‡æ–™
    const totalAmount = periodPayments.reduce((sum, payment) => sum + (payment.paymentAmount || 0), 0);
    const approvedPayments = periodPayments.filter(p => p.status === 'å·²ç¢ºèª').length;
    const pendingPayments = periodPayments.filter(p => p.status === 'å¾…å¯©æ ¸').length;
    const rejectedPayments = periodPayments.filter(p => p.status === 'å·²æ‹’çµ•').length;
    
    return {
        period: `${startDate} è‡³ ${endDate}`,
        summary: {
            newRegistrations: periodUsers.length,
            newPayments: periodPayments.length,
            approvedPayments: approvedPayments,
            pendingPayments: pendingPayments,
            rejectedPayments: rejectedPayments,
            totalAmount: totalAmount
        },
        details: {
            payments: periodPayments,
            users: periodUsers
        }
    };
}

function displayReport(report) {
    const html = `
        <div class="table-container">
            <h3>ğŸ“Š ${report.period} å ±è¡¨</h3>
            
            <div class="stats-grid" style="margin: 20px 0;">
                <div class="stat-card">
                    <div class="stat-number">${report.summary.newRegistrations}</div>
                    <div class="stat-label">æ–°è¨»å†Šç”¨æˆ¶</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${report.summary.newPayments}</div>
                    <div class="stat-label">æ–°ç¹³è²»è¨˜éŒ„</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${report.summary.approvedPayments}</div>
                    <div class="stat-label">å¯©æ ¸é€šé</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">NT$ ${report.summary.totalAmount.toLocaleString()}</div>
                    <div class="stat-label">ç¸½é‡‘é¡</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div>
                    <strong>âœ… å·²ç¢ºèª:</strong> ${report.summary.approvedPayments}
                </div>
                <div>
                    <strong>â³ å¾…å¯©æ ¸:</strong> ${report.summary.pendingPayments}
                </div>
                <div>
                    <strong>âŒ å·²æ‹’çµ•:</strong> ${report.summary.rejectedPayments}
                </div>
            </div>
            
            ${report.details.payments.length > 0 ? `
                <h4>ğŸ’° æœŸé–“å…§ç¹³è²»è¨˜éŒ„</h4>
                <table class="table" style="margin-bottom: 20px;">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>ç”¨æˆ¶</th>
                            <th>é‡‘é¡</th>
                            <th>æ–¹å¼</th>
                            <th>ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${report.details.payments.map(payment => `
                            <tr>
                                <td>${new Date(payment.submittedAt).toLocaleDateString('zh-TW')}</td>
                                <td>${payment.realName}</td>
                                <td>NT$ ${payment.paymentAmount.toLocaleString()}</td>
                                <td>${getPaymentMethodText(payment.paymentMethod)}</td>
                                <td>
                                    <span class="status-badge status-${getStatusClass(payment.status)}">
                                        ${getStatusText(payment.status)}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : ''}
            
            ${report.details.users.length > 0 ? `
                <h4>ğŸ‘¥ æœŸé–“å…§æ–°è¨»å†Šç”¨æˆ¶</h4>
                <table class="table">
                    <thead>
                        <tr>
                            <th>è¨»å†Šæ—¥æœŸ</th>
                            <th>çœŸå¯¦å§“å</th>
                            <th>LINE åç¨±</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${report.details.users.map(user => `
                            <tr>
                                <td>${new Date(user.registeredAt).toLocaleDateString('zh-TW')}</td>
                                <td>${user.realName}</td>
                                <td>${user.lineDisplayName}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : ''}
        </div>
    `;
    
    document.getElementById('reportContent').innerHTML = html;
}

// è¼‰å…¥ç³»çµ±è³‡è¨Š
async function loadSystemInfo() {
    try {
        debugLog('è¼‰å…¥ç³»çµ±è³‡è¨Š');
        
        const info = {
            version: '1.0.0',
            lastUpdate: new Date().toISOString(),
            environment: 'Production',
            database: 'Google Sheets',
            liffVersion: liff.getVersion(),
            adminUser: adminProfile.displayName,
            totalUsers: allUsers.length,
            totalPayments: allPayments.length
        };
        
        const html = `
            <div style="font-size: 14px; line-height: 1.8;">
                <p><strong>ğŸ”§ ç³»çµ±ç‰ˆæœ¬:</strong> ${info.version}</p>
                <p><strong>ğŸ“… æœ€å¾Œæ›´æ–°:</strong> ${new Date(info.lastUpdate).toLocaleString('zh-TW')}</p>
                <p><strong>ğŸŒ é‹è¡Œç’°å¢ƒ:</strong> ${info.environment}</p>
                <p><strong>ğŸ’¾ è³‡æ–™åº«:</strong> ${info.database}</p>
                <p><strong>ğŸ“± LIFF ç‰ˆæœ¬:</strong> ${info.liffVersion}</p>
                <p><strong>ğŸ‘¤ ç•¶å‰ç®¡ç†è€…:</strong> ${info.adminUser}</p>
                <p><strong>ğŸ“Š ç³»çµ±çµ±è¨ˆ:</strong> ${info.totalUsers} ç”¨æˆ¶, ${info.totalPayments} ç¹³è²»è¨˜éŒ„</p>
            </div>
        `;
        
        document.getElementById('systemInfo').innerHTML = html;
    } catch (error) {
        debugLog('è¼‰å…¥ç³»çµ±è³‡è¨Šå¤±æ•—', error);
        console.error('è¼‰å…¥ç³»çµ±è³‡è¨Šå¤±æ•—:', error);
        document.getElementById('systemInfo').innerHTML = 
            `<div class="error">è¼‰å…¥ç³»çµ±è³‡è¨Šå¤±æ•—: ${error.message}</div>`;
    }
}

// é–‹å•Ÿå¯©æ ¸æ¨¡æ…‹æ¡†
function openReviewModal(orderId) {
    debugLog('é–‹å•Ÿå¯©æ ¸æ¨¡æ…‹æ¡†', { orderId });
    
    const payment = pendingPayments.find(p => p.orderId === orderId) || 
                   allPayments.find(p => p.orderId === orderId);
    
    if (!payment) {
        alert('æ‰¾ä¸åˆ°è©²ç¹³è²»è¨˜éŒ„');
        return;
    }
    
    document.getElementById('reviewPaymentId').value = orderId;
    
    const paymentInfo = `
        <div style="display: grid; gap: 8px;">
            <div><strong>è¨‚å–®ç·¨è™Ÿ:</strong> ${payment.orderId}</div>
            <div><strong>ç”¨æˆ¶å§“å:</strong> ${payment.realName} (${payment.lineName})</div>
            <div><strong>ç¹³è²»é‡‘é¡:</strong> <span style="color: #00B900; font-weight: bold;">NT$ ${payment.paymentAmount.toLocaleString()}</span></div>
            <div><strong>ç¹³è²»æ–¹å¼:</strong> ${getPaymentMethodText(payment.paymentMethod)}</div>
            <div><strong>æäº¤æ™‚é–“:</strong> ${new Date(payment.submittedAt).toLocaleString('zh-TW')}</div>
            ${payment.paymentNote ? `<div><strong>ç”¨æˆ¶å‚™è¨»:</strong> ${payment.paymentNote}</div>` : ''}
        </div>
    `;
    
    document.getElementById('reviewPaymentInfo').innerHTML = paymentInfo;
    document.getElementById('reviewModal').style.display = 'block';
}

// é—œé–‰å¯©æ ¸æ¨¡æ…‹æ¡†
function closeReviewModal() {
    document.getElementById('reviewModal').style.display = 'none';
    document.getElementById('reviewForm').reset();
}

// æŸ¥çœ‹è¨‚å–®è©³æƒ…
async function viewOrderDetails(orderId) {
    try {
        debugLog('æŸ¥çœ‹è¨‚å–®è©³æƒ…', { orderId });
        
        // å¾å·²è¼‰å…¥çš„è¨‚å–®ä¸­æ‰¾åˆ°å°æ‡‰çš„è¨‚å–®
        const orderData = allOrders.find(order => order.orderSummary.orderId === orderId);
        
        if (!orderData) {
            alert('æ‰¾ä¸åˆ°è©²è¨‚å–®');
            return;
        }
        
        const order = orderData.orderSummary;
        
        let html = `
            <div class="order-details">
                <h3 style="color: #00B900; margin-bottom: 15px;">ğŸ“‹ è¨‚å–®è³‡è¨Š</h3>
                <div style="display: grid; gap: 10px; margin-bottom: 20px;">
                    <div><strong>è¨‚å–®ç·¨è™Ÿ:</strong> ${order.orderId}</div>
                    <div><strong>ç”¨æˆ¶å§“å:</strong> ${order.realName}</div>
                    <div><strong>LINEåç¨±:</strong> ${order.lineName}</div>
                </div>
                
                <h4 style="color: #00B900; margin: 20px 0 10px;">ğŸ“¦ ç”¢å“æ¸…å–®</h4>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
        `;
        
        order.products.forEach(product => {
            html += `
                <div class="product-item">
                    <div class="product-name">${product.productName}</div>
                    <div class="product-details">
                        ${product.quantity} Ã— NT$ ${product.unitPrice.toLocaleString()} = NT$ ${product.totalPrice.toLocaleString()}
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
                
                <div style="text-align: right; margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                    <div style="font-size: 18px; font-weight: bold; color: #00B900;">
                        ç¸½é‡‘é¡: NT$ ${order.totalAmount.toLocaleString()}
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('orderModalContent').innerHTML = html;
        document.getElementById('orderModal').style.display = 'block';
        
    } catch (error) {
        debugLog('æŸ¥çœ‹è¨‚å–®è©³æƒ…å¤±æ•—', error);
        console.error('æŸ¥çœ‹è¨‚å–®è©³æƒ…å¤±æ•—:', error);
        alert('è¼‰å…¥è¨‚å–®è©³æƒ…å¤±æ•—: ' + error.message);
    }
}

// é—œé–‰è¨‚å–®æ¨¡æ…‹æ¡†
function closeOrderModal() {
    document.getElementById('orderModal').style.display = 'none';
}

// æŸ¥çœ‹ç”¨æˆ¶è¨‚å–®
// æŸ¥çœ‹ç”¨æˆ¶è¨‚å–®
async function viewUserOrders(lineName) {
    try {
        debugLog('æŸ¥çœ‹ç”¨æˆ¶è¨‚å–®', { lineName });
        
        const result = await callAPI('orders', { lineName: lineName });
        
        if (result.success && result.orderSummary) {
            viewOrderDetails(result.orderSummary.orderId);
        } else {
            alert('è©²ç”¨æˆ¶å°šæœªæœ‰è¨‚å–®è¨˜éŒ„');
        }
    } catch (error) {
        debugLog('æŸ¥çœ‹ç”¨æˆ¶è¨‚å–®å¤±æ•—', error);
        console.error('æŸ¥çœ‹ç”¨æˆ¶è¨‚å–®å¤±æ•—:', error);
        alert('è¼‰å…¥ç”¨æˆ¶è¨‚å–®å¤±æ•—: ' + error.message);
    }
}

// æœå°‹è¨‚å–®
function searchOrders() {
    const searchTerm = document.getElementById('orderSearchInput').value.trim();
    
    if (!searchTerm) {
        displayAllOrders(allOrders);
        return;
    }
    
    const filteredOrders = allOrders.filter(orderData => {
        const order = orderData.orderSummary;
        return order.realName.includes(searchTerm) || 
               order.lineName.includes(searchTerm) ||
               order.orderId.includes(searchTerm);
    });
    
    displayAllOrders(filteredOrders);
}

// ç¯©é¸ç¹³è²»è¨˜éŒ„
function filterPayments() {
    const statusFilter = document.getElementById('paymentStatusFilter').value;
    
    if (!statusFilter) {
        displayAllPayments(allPayments);
        return;
    }
    
    const filteredPayments = allPayments.filter(payment => payment.status === statusFilter);
    displayAllPayments(filteredPayments);
}

// å¯©æ ¸è¡¨å–®æäº¤
document.addEventListener('DOMContentLoaded', function() {
    const reviewForm = document.getElementById('reviewForm');
    if (reviewForm) {
        reviewForm.addEventListener('submit', handleReviewSubmit);
    }
    
    // æ¨¡æ…‹æ¡†é—œé–‰äº‹ä»¶
    const closeBtn = document.querySelector('.close');
    if (closeBtn) {
        closeBtn.onclick = closeReviewModal;
    }
    
    window.onclick = function(event) {
        const reviewModal = document.getElementById('reviewModal');
        const orderModal = document.getElementById('orderModal');
        
        if (event.target === reviewModal) {
            closeReviewModal();
        }
        if (event.target === orderModal) {
            closeOrderModal();
        }
    }
});

async function handleReviewSubmit(e) {
    e.preventDefault();
    
    const orderId = document.getElementById('reviewPaymentId').value;
    const status = document.getElementById('reviewStatus').value;
    const reviewNote = document.getElementById('reviewNote').value;
    
    if (!status) {
        alert('è«‹é¸æ“‡å¯©æ ¸çµæœ');
        return;
    }
    
    try {
        debugLog('æäº¤å¯©æ ¸', { orderId, status, reviewNote });
        
        const result = await callAPI('review-payment', {
            orderId: orderId,
            status: status,
            reviewNote: reviewNote,
            reviewedAt: new Date().toISOString(),
            reviewedBy: adminProfile.displayName
        });
        
        if (result.success) {
            alert('âœ… å¯©æ ¸å®Œæˆï¼');
            closeReviewModal();
            
            // é‡æ–°è¼‰å…¥ç›¸é—œè³‡æ–™
            await Promise.all([
                loadPendingPayments(),
                loadAllPayments(),
                loadDashboard()
            ]);
        } else {
            throw new Error(result.message || 'å¯©æ ¸å¤±æ•—');
        }
    } catch (error) {
        debugLog('å¯©æ ¸å¤±æ•—', error);
        console.error('å¯©æ ¸å¤±æ•—:', error);
        alert('å¯©æ ¸å¤±æ•—: ' + error.message);
    }
}

// åˆ‡æ›å–®å€‹ç¹³è²»è¨˜éŒ„é¸æ“‡
function togglePaymentSelection(checkbox, orderId) {
    if (checkbox.checked) {
        if (!selectedPayments.includes(orderId)) {
            selectedPayments.push(orderId);
        }
    } else {
        const index = selectedPayments.indexOf(orderId);
        if (index > -1) {
            selectedPayments.splice(index, 1);
        }
    }
    
    debugLog('å·²é¸æ“‡ç¹³è²»è¨˜éŒ„', selectedPayments);
}

// åˆ‡æ›å…¨é¸
function toggleAllPayments(masterCheckbox) {
    const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
    selectedPayments = [];
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = masterCheckbox.checked;
        if (masterCheckbox.checked) {
            // å–å¾—å°æ‡‰çš„ orderId
            const row = checkbox.closest('tr');
            const orderIdElement = row.querySelector('td:nth-child(2) div');
            if (orderIdElement) {
                selectedPayments.push(orderIdElement.textContent);
            }
        }
    });
    
    debugLog('å…¨é¸ç‹€æ…‹', { checked: masterCheckbox.checked, selected: selectedPayments });
}

// æ‰¹é‡é€šé
async function batchApprove() {
    if (selectedPayments.length === 0) {
        alert('è«‹å…ˆé¸æ“‡è¦å¯©æ ¸çš„ç¹³è²»è¨˜éŒ„');
        return;
    }
    
    const confirmMsg = `ç¢ºå®šè¦æ‰¹é‡é€šé ${selectedPayments.length} ç­†ç¹³è²»è¨˜éŒ„å—ï¼Ÿ`;
    if (!confirm(confirmMsg)) return;
    
    try {
        debugLog('æ‰¹é‡é€šé', selectedPayments);
        
        const promises = selectedPayments.map(orderId => 
            callAPI('review-payment', {
                orderId: orderId,
                status: 'å·²ç¢ºèª',
                reviewNote: 'æ‰¹é‡å¯©æ ¸é€šé',
                reviewedAt: new Date().toISOString(),
                reviewedBy: adminProfile.displayName
            })
        );
        
        const results = await Promise.all(promises);
        const successCount = results.filter(r => r.success).length;
        
        alert(`âœ… æ‰¹é‡å¯©æ ¸å®Œæˆï¼æˆåŠŸè™•ç† ${successCount} ç­†è¨˜éŒ„`);
        
        selectedPayments = [];
        await Promise.all([
            loadPendingPayments(),
            loadAllPayments(),
            loadDashboard()
        ]);
        
    } catch (error) {
        debugLog('æ‰¹é‡å¯©æ ¸å¤±æ•—', error);
        console.error('æ‰¹é‡å¯©æ ¸å¤±æ•—:', error);
        alert('æ‰¹é‡å¯©æ ¸å¤±æ•—: ' + error.message);
    }
}

// æ‰¹é‡æ‹’çµ•
async function batchReject() {
    if (selectedPayments.length === 0) {
        alert('è«‹å…ˆé¸æ“‡è¦å¯©æ ¸çš„ç¹³è²»è¨˜éŒ„');
        return;
    }
    
    const reason = prompt(`å³å°‡æ‰¹é‡æ‹’çµ• ${selectedPayments.length} ç­†ç¹³è²»è¨˜éŒ„ï¼Œè«‹è¼¸å…¥æ‹’çµ•åŸå› ï¼š`);
    if (!reason) return;
    
    try {
        debugLog('æ‰¹é‡æ‹’çµ•', { payments: selectedPayments, reason });
        
        const promises = selectedPayments.map(orderId => 
            callAPI('review-payment', {
                orderId: orderId,
                status: 'å·²æ‹’çµ•',
                reviewNote: reason,
                reviewedAt: new Date().toISOString(),
                reviewedBy: adminProfile.displayName
            })
        );
        
        const results = await Promise.all(promises);
        const successCount = results.filter(r => r.success).length;
        
        alert(`âŒ æ‰¹é‡æ‹’çµ•å®Œæˆï¼æˆåŠŸè™•ç† ${successCount} ç­†è¨˜éŒ„`);
        
        selectedPayments = [];
        await Promise.all([
            loadPendingPayments(),
            loadAllPayments(),
            loadDashboard()
        ]);
        
    } catch (error) {
        debugLog('æ‰¹é‡æ‹’çµ•å¤±æ•—', error);
        console.error('æ‰¹é‡æ‹’çµ•å¤±æ•—:', error);
        alert('æ‰¹é‡æ‹’çµ•å¤±æ•—: ' + error.message);
    }
}

// åŒ¯å‡ºæ‰€æœ‰è³‡æ–™
async function exportAllData() {
    if (!confirm('ç¢ºå®šè¦åŒ¯å‡ºæ‰€æœ‰ç³»çµ±è³‡æ–™å—ï¼Ÿé€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ã€‚')) return;
    
    try {
        debugLog('åŒ¯å‡ºæ‰€æœ‰è³‡æ–™');
        
        const [paymentsResult, usersResult] = await Promise.all([
            callAPI('get-all-payments', {}),
            callAPI('get-all-users', {})
        ]);
        
        const exportData = {
            exportTime: new Date().toISOString(),
            exportBy: adminProfile.displayName,
            payments: paymentsResult.success ? paymentsResult.payments : [],
            users: usersResult.success ? usersResult.users : [],
            summary: {
                totalUsers: usersResult.success ? usersResult.users.length : 0,
                totalPayments: paymentsResult.success ? paymentsResult.payments.length : 0
            }
        };
        
        // å»ºç«‹ä¸‹è¼‰é€£çµ
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `å¤šç¦æ°£BOGOç³»çµ±è³‡æ–™_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        URL.revokeObjectURL(url);
        
        alert(`ğŸ“Š è³‡æ–™åŒ¯å‡ºå®Œæˆï¼\nç¸½ç”¨æˆ¶: ${exportData.summary.totalUsers}\nç¸½ç¹³è²»è¨˜éŒ„: ${exportData.summary.totalPayments}`);
        
    } catch (error) {
        debugLog('åŒ¯å‡ºè³‡æ–™å¤±æ•—', error);
        console.error('åŒ¯å‡ºè³‡æ–™å¤±æ•—:', error);
        alert('åŒ¯å‡ºè³‡æ–™å¤±æ•—: ' + error.message);
    }
}

// åŒ¯å‡ºç¹³è²»è¨˜éŒ„
async function exportPaymentRecords() {
    try {
        debugLog('åŒ¯å‡ºç¹³è²»è¨˜éŒ„');
        
        const result = await callAPI('get-all-payments', {});
        
        if (!result.success) {
            throw new Error(result.message || 'è¼‰å…¥ç¹³è²»è¨˜éŒ„å¤±æ•—');
        }
        
        // è½‰æ›ç‚º CSV æ ¼å¼
        const headers = ['è¨‚å–®ç·¨è™Ÿ', 'ç”¨æˆ¶å§“å', 'LINEåç¨±', 'ç¹³è²»é‡‘é¡', 'ç¹³è²»æ–¹å¼', 'ç‹€æ…‹', 'æäº¤æ™‚é–“', 'å¯©æ ¸æ™‚é–“', 'å‚™è¨»'];
        let csvContent = headers.join(',') + '\n';
        
        result.payments.forEach(payment => {
            const row = [
                payment.orderId,
                payment.realName,
                payment.lineName,
                payment.paymentAmount,
                getPaymentMethodText(payment.paymentMethod),
                payment.status,
                new Date(payment.submittedAt).toLocaleString('zh-TW'),
                payment.reviewedAt ? new Date(payment.reviewedAt).toLocaleString('zh-TW') : '',
                (payment.paymentNote || '') + (payment.reviewNote ? ' | ' + payment.reviewNote : '')
            ];
            csvContent += row.map(field => `"${field}"`).join(',') + '\n';
        });
        
        // å»ºç«‹ä¸‹è¼‰é€£çµ
        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `ç¹³è²»è¨˜éŒ„_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        URL.revokeObjectURL(url);
        
        alert(`ğŸ’° ç¹³è²»è¨˜éŒ„åŒ¯å‡ºå®Œæˆï¼å…± ${result.payments.length} ç­†è¨˜éŒ„`);
        
    } catch (error) {
        debugLog('åŒ¯å‡ºç¹³è²»è¨˜éŒ„å¤±æ•—', error);
        console.error('åŒ¯å‡ºç¹³è²»è¨˜éŒ„å¤±æ•—:', error);
        alert('åŒ¯å‡ºç¹³è²»è¨˜éŒ„å¤±æ•—: ' + error.message);
    }
}

// åŒ¯å‡ºç”¨æˆ¶æ¸…å–®
async function exportUserList() {
    try {
        debugLog('åŒ¯å‡ºç”¨æˆ¶æ¸…å–®');
        
        const result = await callAPI('get-all-users', {});
        
        if (!result.success) {
            throw new Error(result.message || 'è¼‰å…¥ç”¨æˆ¶è³‡æ–™å¤±æ•—');
        }
        
        // è½‰æ›ç‚º CSV æ ¼å¼
        const headers = ['çœŸå¯¦å§“å', 'LINEåç¨±', 'ç”¨æˆ¶ID', 'è¨»å†Šæ™‚é–“'];
        let csvContent = headers.join(',') + '\n';
        
        result.users.forEach(user => {
            const row = [
                user.realName,
                user.lineDisplayName,
                user.userId,
                new Date(user.registeredAt).toLocaleString('zh-TW')
            ];
            csvContent += row.map(field => `"${field}"`).join(',') + '\n';
        });
        
        // å»ºç«‹ä¸‹è¼‰é€£çµ
        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `ç”¨æˆ¶æ¸…å–®_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        URL.revokeObjectURL(url);
        
        alert(`ğŸ‘¥ ç”¨æˆ¶æ¸…å–®åŒ¯å‡ºå®Œæˆï¼å…± ${result.users.length} ä½ç”¨æˆ¶`);
        
    } catch (error) {
        debugLog('åŒ¯å‡ºç”¨æˆ¶æ¸…å–®å¤±æ•—', error);
        console.error('åŒ¯å‡ºç”¨æˆ¶æ¸…å–®å¤±æ•—:', error);
        alert('åŒ¯å‡ºç”¨æˆ¶æ¸…å–®å¤±æ•—: ' + error.message);
    }
}

// æ¸…ç†èˆŠè³‡æ–™
async function cleanupOldData() {
    const days = prompt('è«‹è¼¸å…¥è¦ä¿ç•™çš„å¤©æ•¸ï¼ˆä¾‹å¦‚ï¼š30 è¡¨ç¤ºåˆªé™¤30å¤©å‰çš„è³‡æ–™ï¼‰ï¼š');
    
    if (!days || isNaN(days) || days < 1) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„å¤©æ•¸');
        return;
    }
    
    const confirmMsg = `ç¢ºå®šè¦åˆªé™¤ ${days} å¤©å‰çš„èˆŠè³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`;
    if (!confirm(confirmMsg)) return;
    
    try {
        debugLog('æ¸…ç†èˆŠè³‡æ–™', { days });
        
        // é€™è£¡éœ€è¦å¾Œç«¯æ”¯æ´æ¸…ç†åŠŸèƒ½
        alert('âš ï¸ æ¸…ç†èˆŠè³‡æ–™åŠŸèƒ½éœ€è¦å¾Œç«¯æ”¯æ´ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡');
        
    } catch (error) {
        debugLog('æ¸…ç†èˆŠè³‡æ–™å¤±æ•—', error);
        console.error('æ¸…ç†èˆŠè³‡æ–™å¤±æ•—:', error);
        alert('æ¸…ç†èˆŠè³‡æ–™å¤±æ•—: ' + error.message);
    }
}

// æŸ¥çœ‹ç¹³è²»è©³æƒ…
function viewPaymentDetails(orderId) {
    const payment = allPayments.find(p => p.orderId === orderId);
    
    if (!payment) {
        alert('æ‰¾ä¸åˆ°è©²ç¹³è²»è¨˜éŒ„');
        return;
    }
    
    let detailsHtml = `
        <div style="line-height: 1.8;">
            <h3 style="color: #00B900; margin-bottom: 15px;">ğŸ’° ç¹³è²»è©³æƒ…</h3>
            <p><strong>è¨‚å–®ç·¨è™Ÿ:</strong> ${payment.orderId}</p>
            <p><strong>ç”¨æˆ¶å§“å:</strong> ${payment.realName}</p>
            <p><strong>LINEåç¨±:</strong> ${payment.lineName}</p>
            <p><strong>ç¹³è²»é‡‘é¡:</strong> <span style="color: #00B900; font-weight: bold;">NT$ ${payment.paymentAmount.toLocaleString()}</span></p>
            <p><strong>ç¹³è²»æ–¹å¼:</strong> ${getPaymentMethodText(payment.paymentMethod)}</p>
            <p><strong>ç‹€æ…‹:</strong> <span class="status-badge status-${getStatusClass(payment.status)}">${getStatusText(payment.status)}</span></p>
            <p><strong>æäº¤æ™‚é–“:</strong> ${new Date(payment.submittedAt).toLocaleString('zh-TW')}</p>
            ${payment.reviewedAt ? `<p><strong>å¯©æ ¸æ™‚é–“:</strong> ${new Date(payment.reviewedAt).toLocaleString('zh-TW')}</p>` : ''}
            ${payment.paymentNote ? `<p><strong>ç”¨æˆ¶å‚™è¨»:</strong> ${payment.paymentNote}</p>` : ''}
            ${payment.reviewNote ? `<p><strong>å¯©æ ¸å‚™è¨»:</strong> ${payment.reviewNote}</p>` : ''}
        </div>
    `;
    
    document.getElementById('orderModalContent').innerHTML = detailsHtml;
    document.getElementById('orderModal').style.display = 'block';
}

// å·¥å…·å‡½æ•¸
function getStatusClass(status) {
    switch (status) {
        case 'å¾…å¯©æ ¸': return 'pending';
        case 'å·²ç¢ºèª': return 'approved';
        case 'å·²æ‹’çµ•': return 'rejected';
        default: return 'pending';
    }
}

function getStatusText(status) {
    switch (status) {
        case 'å¾…å¯©æ ¸': return 'å¾…å¯©æ ¸';
        case 'å·²ç¢ºèª': return 'å·²ç¢ºèª';
        case 'å·²æ‹’çµ•': return 'å·²æ‹’çµ•';
        default: return status || 'æœªçŸ¥';
    }
}

function getPaymentMethodText(method) {
    switch (method) {
        case 'bank_transfer': return 'éŠ€è¡Œè½‰å¸³';
        case 'line_pay': return 'LINE Pay';
        case 'cash': return 'ç¾é‡‘';
        case 'other': return 'å…¶ä»–';
        default: return method || 'æœªæŒ‡å®š';
    }
}

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error';
    errorDiv.innerHTML = `
        <h3>âŒ éŒ¯èª¤</h3>
        <p>${message}</p>
    `;
    
    const content = document.querySelector('.content');
    if (content) {
        content.insertBefore(errorDiv, content.firstChild);
        
        // 5ç§’å¾Œè‡ªå‹•ç§»é™¤
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
            }
        }, 5000);
    }
}

function showSuccess(message) {
    const successDiv = document.createElement('div');
    successDiv.className = 'success';
    successDiv.innerHTML = `
        <h3>âœ… æˆåŠŸ</h3>
        <p>${message}</p>
    `;
    
    const content = document.querySelector('.content');
    if (content) {
        content.insertBefore(successDiv, content.firstChild);
        
        // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.parentNode.removeChild(successDiv);
            }
        }, 3000);
    }
}

// é–‹ç™¼ç”¨æ¸¬è©¦å‡½æ•¸
if (CONFIG.DEBUG_MODE) {
    window.adminDebug = {
        testFunctions: function() {
            console.log('=== ç®¡ç†è€…åŠŸèƒ½æ¸¬è©¦ ===');
            console.log('ç®¡ç†è€…ID:', adminUserId);
            console.log('ç®¡ç†è€…è³‡æ–™:', adminProfile);
            console.log('å·²é¸æ“‡ç¹³è²»è¨˜éŒ„:', selectedPayments);
            console.log('å¾…å¯©æ ¸è¨˜éŒ„:', pendingPayments);
            console.log('æ‰€æœ‰ç¹³è²»è¨˜éŒ„:', allPayments);
            console.log('æ‰€æœ‰è¨‚å–®:', allOrders);
            console.log('æ‰€æœ‰ç”¨æˆ¶:', allUsers);
        },
        
        simulatePayment: function() {
            console.log('æ¨¡æ“¬ç¹³è²»è¨˜éŒ„');
            // é€™è£¡å¯ä»¥åŠ å…¥æ¸¬è©¦ç”¨çš„æ¨¡æ“¬è³‡æ–™
        },
        
        clearCache: function() {
            pendingPayments = [];
            allPayments = [];
            selectedPayments = [];
            allOrders = [];
            allUsers = [];
            console.log('å·²æ¸…é™¤æ‰€æœ‰å¿«å–è³‡æ–™');
        }
    };
    
    console.log('ç®¡ç†å¾Œå°é™¤éŒ¯æ¨¡å¼å·²å•Ÿç”¨ï¼Œä½¿ç”¨ window.adminDebug é€²è¡Œæ¸¬è©¦');
}
</script>
</body>
</html>

