<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœƒå“¡è¨‚è³¼æ¸…å–®æŸ¥è©¢ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      
      body {
          font-family: 'Arial', sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
      }
      
      .container {
          background: white;
          border-radius: 20px;
          box-shadow: 0 20px 40px rgba(0,0,0,0.1);
          overflow: hidden;
          max-width: 400px;
          width: 100%;
      }
      
      .header {
          background: linear-gradient(135deg, #ff6b6b, #ee5a24);
          color: white;
          text-align: center;
          padding: 30px 20px;
      }
      
      .header h1 {
          font-size: 22px;
          margin-bottom: 10px;
      }
      
      .content {
          padding: 30px;
      }
      
      .tab-buttons {
          display: flex;
          margin-bottom: 30px;
          background: #f8f9fa;
          border-radius: 10px;
          padding: 5px;
          flex-wrap: wrap;
      }
      
      .tab-button {
          flex: 1;
          padding: 10px 8px;
          text-align: center;
          border: none;
          background: transparent;
          cursor: pointer;
          border-radius: 8px;
          transition: all 0.3s;
          font-weight: 500;
          font-size: 14px;
          min-width: 70px;
      }
      
      .tab-button.active {
          background: #667eea;
          color: white;
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }
      
      .tab-content {
          display: none;
      }
      
      .tab-content.active {
          display: block;
      }
      
      .form-group {
          margin-bottom: 20px;
      }
      
      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #333;
      }
      
      .form-group input, .form-group select {
          width: 100%;
          padding: 15px;
          border: 2px solid #e1e5e9;
          border-radius: 10px;
          font-size: 16px;
          transition: border-color 0.3s;
      }
      
      .form-group input:focus, .form-group select:focus {
          outline: none;
          border-color: #667eea;
      }
      
      .btn {
          width: 100%;
          padding: 15px;
          border: none;
          border-radius: 10px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          margin-bottom: 10px;
      }
      
      .btn-primary {
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
      }
      
      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }
      
      .btn-secondary {
          background: #6c757d;
          color: white;
      }
      
      .btn-success {
          background: #28a745;
          color: white;
      }
      
      .user-info {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 10px;
          margin-bottom: 20px;
      }
      
      .user-info h3 {
          color: #333;
          margin-bottom: 15px;
      }
      
      .info-item {
          display: flex;
          justify-content: space-between;
          margin-bottom: 10px;
          padding: 8px 0;
          border-bottom: 1px solid #dee2e6;
      }
      
      .info-item:last-child {
          border-bottom: none;
      }
      
      .info-label {
          font-weight: 600;
          color: #666;
      }
      
      .info-value {
          color: #333;
          text-align: right;
      }
      
      .order-list {
          max-height: 400px;
          overflow-y: auto;
      }
      
      .order-item {
          background: #f8f9fa;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 15px;
          border-left: 4px solid #667eea;
      }
      
      .order-item.paid {
          border-left-color: #28a745;
      }
      
      .order-item.unpaid {
          border-left-color: #dc3545;
      }
      
      .order-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
      }
      
      .order-number {
          font-weight: 600;
          color: #667eea;
      }
      
      .order-amount {
          font-weight: 600;
          color: #ee5a24;
      }
      
      .order-status {
          display: inline-block;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 600;
          margin-top: 5px;
      }
      
      .status-paid {
          background: #d4edda;
          color: #155724;
      }
      
      .status-unpaid {
          background: #f8d7da;
          color: #721c24;
      }
      
      .order-details {
          font-size: 14px;
          color: #666;
      }
      
      .stats-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
          margin-bottom: 20px;
      }
      
      .stat-card {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
      }
      
      .stat-number {
          font-size: 20px;
          font-weight: 600;
          color: #667eea;
          margin-bottom: 5px;
      }
      
      .stat-label {
          font-size: 12px;
          color: #666;
      }
      
      .payment-form {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 10px;
          margin-bottom: 20px;
      }
      
      .loading {
          text-align: center;
          padding: 40px;
          color: #666;
      }
      
      .error {
          background: #f8d7da;
          color: #721c24;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
      }
      
      .success {
          background: #d4edda;
          color: #155724;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
      }
      
      @media (max-width: 480px) {
          .container {
              margin: 10px;
          }
          
          .content {
              padding: 20px;
          }
          
          .stats-grid {
              grid-template-columns: 1fr;
          }
          
          .tab-button {
              font-size: 12px;
              padding: 8px 6px;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>ğŸ›’ æœƒå“¡è¨‚è³¼æ¸…å–®æŸ¥è©¢ç³»çµ±</h1>
          <p>å¯¦åç™»è¨˜ Â· è¨‚è³¼æŸ¥è©¢ Â· ç¹³è²»å›å ±</p>
      </div>
      
      <div class="content">
          <!-- åˆ†é æŒ‰éˆ• -->
          <div class="tab-buttons">
              <button class="tab-button active" onclick="switchTab('register')">å¯¦åç™»è¨˜</button>
              <button class="tab-button" onclick="switchTab('profile')">å€‹äººè³‡æ–™</button>
              <button class="tab-button" onclick="switchTab('orders')">è¨‚è³¼æ¸…å–®</button>
              <button class="tab-button" onclick="switchTab('payment')">ç¹³è²»å›å ±</button>
          </div>
          
          <!-- å¯¦åç™»è¨˜é é¢ -->
          <div id="register-tab" class="tab-content active">
              <form id="memberForm">
                  <div class="form-group">
                      <label for="realName">çœŸå¯¦å§“å *</label>
                      <input type="text" id="realName" name="realName" required placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å">
                  </div>
                  
                  <div class="form-group">
                      <label for="doterraId">å¤šç‰¹ç‘ID *</label>
                      <input type="text" id="doterraId" name="doterraId" required placeholder="è«‹è¼¸å…¥å¤šç‰¹ç‘ID">
                  </div>
                  
                  <div class="form-group">
                      <label for="referrerName">ä»‹ç´¹äººåå­— *</label>
                      <input type="text" id="referrerName" name="referrerName" required placeholder="è«‹è¼¸å…¥ä»‹ç´¹äººåå­—">
                  </div>
                  
                  <div class="form-group">
                      <label for="phone">è¯çµ¡é›»è©± *</label>
                      <input type="tel" id="phone" name="phone" required placeholder="è«‹è¼¸å…¥è¯çµ¡é›»è©±">
                  </div>
                  
                  <div class="form-group">
                      <label for="email">é›»å­éƒµä»¶</label>
                      <input type="email" id="email" name="email" placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶ï¼ˆé¸å¡«ï¼‰">
                  </div>
                  
                  <div class="form-group">
                      <label for="address">è¯çµ¡åœ°å€</label>
                      <input type="text" id="address" name="address" placeholder="è«‹è¼¸å…¥è¯çµ¡åœ°å€ï¼ˆé¸å¡«ï¼‰">
                  </div>
                  
                  <button type="submit" class="btn btn-primary">å®Œæˆå¯¦åç™»è¨˜</button>
              </form>
          </div>
          
          <!-- å€‹äººè³‡æ–™é é¢ -->
          <div id="profile-tab" class="tab-content">
              <div id="profileContent">
                  <div class="loading">è¼‰å…¥ä¸­...</div>
              </div>
          </div>
          
          <!-- è¨‚è³¼æ¸…å–®é é¢ -->
          <div id="orders-tab" class="tab-content">
              <div id="ordersContent">
                  <div class="loading">è¼‰å…¥ä¸­...</div>
              </div>
          </div>
          
          <!-- ç¹³è²»å›å ±é é¢ -->
          <div id="payment-tab" class="tab-content">
              <div id="paymentContent">
                  <div class="payment-form">
                      <h3>ğŸ’³ ç¹³è²»å›å ±</h3>
                      <form id="paymentForm">
                          <div class="form-group">
                              <label for="orderSelect">é¸æ“‡è¨‚å–®</label>
                              <select id="orderSelect" name="orderSelect" required>
                                  <option value="">è«‹é¸æ“‡è¦å›å ±çš„è¨‚å–®</option>
                              </select>
                          </div>
                          
                          <div class="form-group">
                              <label for="paymentAmount">ç¹³è²»é‡‘é¡</label>
                              <input type="number" id="paymentAmount" name="paymentAmount" required placeholder="è«‹è¼¸å…¥ç¹³è²»é‡‘é¡">
                          </div>
                          
                          <div class="form-group">
                              <label for="paymentMethod">ç¹³è²»æ–¹å¼</label>
                              <select id="paymentMethod" name="paymentMethod" required>
                                  <option value="è½‰å¸³">éŠ€è¡Œè½‰å¸³</option>
                                  <option value="ç¾é‡‘">ç¾é‡‘ç¹³è²»</option>
                                  <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                                  <option value="å…¶ä»–">å…¶ä»–</option>
                              </select>
                          </div>
                          
                          <div class="form-group">
                              <label for="paymentRemarks">å‚™è¨»</label>
                              <input type="text" id="paymentRemarks" name="paymentRemarks" placeholder="è½‰å¸³å¸³è™Ÿå¾Œ5ç¢¼æˆ–å…¶ä»–å‚™è¨»">
                          </div>
                          
                          <button type="submit" class="btn btn-success">æäº¤ç¹³è²»å›å ±</button>
                      </form>
                  </div>
              </div>
          </div>
      </div>
  </div>
  
  <script>
      // LIFF åˆå§‹åŒ–
      let liffId = '2006113324-od69VN74'; // è«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID
      let lineProfile = null;
      let memberData = null;
      let orderData = null;
      
      // Google Apps Script API URL
      const API_URL = 'https://script.google.com/macros/s/AKfycbwPx3nYNDVOpHdLn0zLZRp8W8dQTW5bdxNFgGVeKJgeaPc8xODFKZpl5rQvEt5RS-lx/exec'; // è«‹æ›¿æ›ç‚ºæ‚¨çš„ GAS URL
      
      // åˆå§‹åŒ– LIFF
      async function initializeLiff() {
          try {
              await liff.init({ liffId: liffId });
              
              if (!liff.isLoggedIn()) {
                  liff.login();
                  return;
              }
              
              // ç²å–ç”¨æˆ¶è³‡æ–™
              lineProfile = await liff.getProfile();
              console.log('LINE Profile:', lineProfile);
              
              // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ˜¯æœƒå“¡
              await checkMemberStatus();
              
          } catch (error) {
              console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
              showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
          }
      }
      
      // æª¢æŸ¥æœƒå“¡ç‹€æ…‹
      async function checkMemberStatus() {
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'checkMember',
                      lineUserId: lineProfile.userId
                  })
              });
              
              const result = await response.json();
              
              if (result.success && result.memberData) {
                  memberData = result.memberData;
                  updateUIForMember();
              } else {
                  updateUIForNewUser();
              }
              
          } catch (error) {
              console.error('æª¢æŸ¥æœƒå“¡ç‹€æ…‹å¤±æ•—:', error);
              showError('ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
      }
      
      // æ›´æ–°å·²è¨»å†Šæœƒå“¡çš„ UI
      function updateUIForMember() {
          // é å¡«å€‹äººè³‡æ–™
          document.getElementById('realName').value = memberData.realName || '';
          document.getElementById('doterraId').value = memberData.doterraId || '';
          document.getElementById('referrerName').value = memberData.referrerName || '';
          document.getElementById('phone').value = memberData.phone || '';
          document.getElementById('email').value = memberData.email || '';
          document.getElementById('address').value = memberData.address || '';
          
          // è¼‰å…¥å€‹äººè³‡æ–™é é¢
          loadProfilePage();
          
          // è¼‰å…¥è¨‚è³¼è¨˜éŒ„
          loadOrdersPage();
      }
      
      // æ›´æ–°æ–°ç”¨æˆ¶çš„ UI
      function updateUIForNewUser() {
          showSuccess('æ­¡è¿ä½¿ç”¨æœƒå“¡è¨‚è³¼æ¸…å–®æŸ¥è©¢ç³»çµ±ï¼è«‹å…ˆå®Œæˆå¯¦åç™»è¨˜ã€‚');
      }
      
      // è¼‰å…¥å€‹äººè³‡æ–™é é¢
      function loadProfilePage() {
          const profileContent = document.getElementById('profileContent');
          
          if (!memberData) {
              profileContent.innerHTML = `
                  <div class="error">
                      è«‹å…ˆå®Œæˆå¯¦åç™»è¨˜
                  </div>
              `;
              return;
          }
          
          profileContent.innerHTML = `
              <div class="user-info">
                  <h3>ğŸ‘¤ LINE è³‡æ–™</h3>
                  <div class="info-item">
                      <span class="info-label">é¡¯ç¤ºåç¨±</span>
                      <span class="info-value">${lineProfile.displayName}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">ç”¨æˆ¶ ID</span>
                      <span class="info-value">${lineProfile.userId.substring(0, 10)}...</span>
                  </div>
              </div>
              
              <div class="user-info">
                  <h3>ğŸ“‹ æœƒå“¡è³‡æ–™</h3>
                  <div class="info-item">
                      <span class="info-label">çœŸå¯¦å§“å</span>
                      <span class="info-value">${memberData.realName}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">å¤šç‰¹ç‘ID</span>
                      <span class="info-value">${memberData.doterraId}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">ä»‹ç´¹äºº</span>
                      <span class="info-value">${memberData.referrerName}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">è¯çµ¡é›»è©±</span>
                      <span class="info-value">${memberData.phone}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">é›»å­éƒµä»¶</span>
                      <span class="info-value">${memberData.email || 'æœªè¨­å®š'}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">è¯çµ¡åœ°å€</span>
                      <span class="info-value">${memberData.address || 'æœªè¨­å®š'}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">è¨»å†Šæ™‚é–“</span>
                      <span class="info-value">${new Date(memberData.registerTime).toLocaleString('zh-TW')}</span>
                  </div>
              </div>
              
              <button class="btn btn-secondary" onclick="editProfile()">ä¿®æ”¹è³‡æ–™</button>
          `;
      }
      
      // è¼‰å…¥è¨‚è³¼è¨˜éŒ„é é¢
      async function loadOrdersPage() {
          const ordersContent = document.getElementById('ordersContent');
          
          if (!memberData) {
              ordersContent.innerHTML = `
                  <div class="error">
                      è«‹å…ˆå®Œæˆå¯¦åç™»è¨˜
                  </div>
              `;
              return;
          }
          
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'getOrders',
                      lineUserId: lineProfile.userId,
                      realName: memberData.realName
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  orderData = result.orders;
                  displayOrders(result.orders, result.statistics);
                  updatePaymentForm(result.orders);
              } else {
                  ordersContent.innerHTML = `
                      <div class="error">
                          è¼‰å…¥è¨‚è³¼è¨˜éŒ„å¤±æ•—ï¼š${result.message}
                      </div>
                  `;
              }
              
          } catch (error) {
              console.error('è¼‰å…¥è¨‚è³¼è¨˜éŒ„å¤±æ•—:', error);
              ordersContent.innerHTML = `
                  <div class="error">
                      ç„¡æ³•è¼‰å…¥è¨‚è³¼è¨˜éŒ„ï¼Œè«‹ç¨å¾Œå†è©¦
                  </div>
              `;
          }
      }
      
      // é¡¯ç¤ºè¨‚è³¼è¨˜éŒ„
      function displayOrders(orders, statistics) {
          const ordersContent = document.getElementById('ordersContent');
          
          let html = `
              <div class="stats-grid">
                  <div class="stat-card">
                      <div class="stat-number">${statistics.totalOrders}</div>
                      <div class="stat-label">ç¸½è¨‚å–®æ•¸</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">NT$ ${statistics.totalAmount.toLocaleString()}</div>
                      <div class="stat-label">ç¸½é‡‘é¡</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">${statistics.paidOrders}</div>
                      <div class="stat-label">å·²ç¹³è²»</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">${statistics.unpaidOrders}</div>
                      <div class="stat-label">æœªç¹³è²»</div>
                  </div>
              </div>
          `;
          
          if (orders.length === 0) {
              html += `
                  <div class="user-info">
                      <h3>ğŸ“ è¨‚è³¼è¨˜éŒ„</h3>
                      <p style="text-align: center; color: #666; padding: 20px;">
                          ç›®å‰å°šç„¡è¨‚è³¼è¨˜éŒ„
                      </p>
                  </div>
              `;
          } else {
              html += `
                  <div class="user-info">
                      <h3>ğŸ“ è¨‚è³¼è¨˜éŒ„ (${orders.length} ç­†)</h3>
                  </div>
                  <div class="order-list">
              `;
              
              orders.forEach(order => {
                  const isPaid = order.paymentStatus === 'å·²ç¹³è²»';
                  const statusClass = isPaid ? 'paid' : 'unpaid';
                  const statusText = isPaid ? 'status-paid' : 'status-unpaid';
                  
                  html += `
                      <div class="order-item ${statusClass}">
                          <div class="order-header">
                              <span class="order-number">${order.orderNumber}</span>
                              <span class="order-amount">NT$ ${order.amount.toLocaleString()}</span>
                          </div>
                          <div class="order-details">
                              <div>ğŸ“¦ ${order.productInfo}</div>
                              <div>ğŸ“… è¨‚è³¼ï¼š${new Date(order.orderDate).toLocaleDateString('zh-TW')}</div>
                              <div>â° åˆ°æœŸï¼š${new Date(order.dueDate).toLocaleDateString('zh-TW')}</div>
                              ${order.paymentDate ? `<div>ğŸ’³ ç¹³è²»ï¼š${new Date(order.paymentDate).toLocaleDateString('zh-TW')}</div>` : ''}
                              ${order.remarks ? `<div>ğŸ“ ${order.remarks}</div>` : ''}
                          </div>
                          <span class="order-status ${statusText}">${order.paymentStatus}</span>
                      </div>
                  `;
              });
              
              html += '</div>';
          }
          
          ordersContent.innerHTML = html;
      }
      
      // æ›´æ–°ç¹³è²»è¡¨å–®çš„è¨‚å–®é¸é …
      function updatePaymentForm(orders) {
          const orderSelect = document.getElementById('orderSelect');
          orderSelect.innerHTML = '<option value="">è«‹é¸æ“‡è¦å›å ±çš„è¨‚å–®</option>';
          
          // åªé¡¯ç¤ºæœªç¹³è²»çš„è¨‚å–®
          const unpaidOrders = orders.filter(order => order.paymentStatus !== 'å·²ç¹³è²»');
          
          unpaidOrders.forEach(order => {
              const option = document.createElement('option');
              option.value = order.orderNumber;
              option.textContent = `${order.orderNumber} - NT$ ${order.amount.toLocaleString()} - ${order.productInfo}`;
              option.dataset.amount = order.amount;
              orderSelect.appendChild(option);
          });
          
          // ç•¶é¸æ“‡è¨‚å–®æ™‚è‡ªå‹•å¡«å…¥é‡‘é¡
          orderSelect.addEventListener('change', function() {
              const selectedOption = this.options[this.selectedIndex];
              if (selectedOption.dataset.amount) {
                  document.getElementById('paymentAmount').value = selectedOption.dataset.amount;
              }
          });
      }
      
      // åˆ‡æ›åˆ†é 
      function switchTab(tabName) {
          // éš±è—æ‰€æœ‰åˆ†é å…§å®¹
          document.querySelectorAll('.tab-content').forEach(tab => {
              tab.classList.remove('active');
          });
          
          // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
          document.querySelectorAll('.tab-button').forEach(btn => {
              btn.classList.remove('active');
          });
          
          // é¡¯ç¤ºé¸ä¸­çš„åˆ†é 
          document.getElementById(tabName + '-tab').classList.add('active');
          event.target.classList.add('active');
          
          // å¦‚æœæ˜¯è¨‚è³¼è¨˜éŒ„é é¢ï¼Œé‡æ–°è¼‰å…¥è³‡æ–™
          if (tabName === 'orders' && memberData) {
              loadOrdersPage();
          }
      }
      
      // å¯¦åç™»è¨˜è¡¨å–®æäº¤
      document.getElementById('memberForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          if (!lineProfile) {
              showError('LINE ç™»å…¥è³‡æ–™ä¸å®Œæ•´ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
              return;
          }
          
          const formData = new FormData(this);
          const memberInfo = {
              action: 'registerMember',
              lineUserId: lineProfile.userId,
              lineDisplayName: lineProfile.displayName,
              realName: formData.get('realName'),
              doterraId: formData.get('doterraId'),
              referrerName: formData.get('referrerName'),
              phone: formData.get('phone'),
              email: formData.get('email'),
              address: formData.get('address'),
              registerTime: new Date().toISOString()
          };
          
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(memberInfo)
              });
              
              const result = await response.json();
              
              if (result.success) {
                  memberData = memberInfo;
                  showSuccess('å¯¦åç™»è¨˜æˆåŠŸï¼');
                  updateUIForMember();
                  switchTab('profile');
              } else {
                  showError('ç™»è¨˜å¤±æ•—ï¼š' + result.message);
              }
              
          } catch (error) {
              console.error('å¯¦åç™»è¨˜å¤±æ•—:', error);
              showError('ç™»è¨˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
      });
      
      // ç¹³è²»å›å ±è¡¨å–®æäº¤
      document.getElementById('paymentForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          if (!lineProfile || !memberData) {
              showError('è«‹å…ˆå®Œæˆå¯¦åç™»è¨˜');
              return;
          }
          
          const formData = new FormData(this);
          const paymentInfo = {
              action: 'reportPayment',
              lineUserId: lineProfile.userId,
              lineDisplayName: lineProfile.displayName,
              orderNumber: formData.get('orderSelect'),
              amount: parseInt(formData.get('paymentAmount')),
              paymentMethod: formData.get('paymentMethod'),
              remarks: formData.get('paymentRemarks')
          };
          
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(paymentInfo)
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showSuccess('ç¹³è²»å›å ±æˆåŠŸï¼');
                  this.reset();
                  // é‡æ–°è¼‰å…¥è¨‚è³¼è¨˜éŒ„
                  loadOrdersPage();
              } else {
                  showError('ç¹³è²»å›å ±å¤±æ•—ï¼š' + result.message);
              }
              
          } catch (error) {
              console.error('ç¹³è²»å›å ±å¤±æ•—:', error);
              showError('ç¹³è²»å›å ±å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
      });
      
      // ä¿®æ”¹è³‡æ–™
      function editProfile() {
          switchTab('register');
          showSuccess('è«‹ä¿®æ”¹è³‡æ–™å¾Œé‡æ–°æäº¤');
      }
      
      // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
      function showError(message) {
          const existingError = document.querySelector('.error');
          if (existingError) {
              existingError.remove();
          }
          
          const errorDiv = document.createElement('div');
          errorDiv.className = 'error';
          errorDiv.textContent = message;
          
          document.querySelector('.content').insertBefore(errorDiv, document.querySelector('.tab-buttons'));
          
          setTimeout(() => {
              errorDiv.remove();
          }, 5000);
      }
      
      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
      function showSuccess(message) {
          const existingSuccess = document.querySelector('.success');
          if (existingSuccess) {
              existingSuccess.remove();
          }
          
          const successDiv = document.createElement('div');
          successDiv.className = 'success';
          successDiv.textContent = message;
          
          document.querySelector('.content').insertBefore(successDiv, document.querySelector('.tab-buttons'));
          
          setTimeout(() => {
              successDiv.remove();
          }, 5000);
      }
      
      // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ– LIFF
      window.addEventListener('load', initializeLiff);
  </script>
</body>
</html>
