<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¨‚è³¼ç³»çµ±ç®¡ç†å¾Œå°</title>
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .header {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: 30px;
        text-align: center;
    }
    
    .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
    }
    
    .nav-tabs {
        display: flex;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    
    .nav-tab {
        flex: 1;
        padding: 15px 20px;
        text-align: center;
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: #6c757d;
        transition: all 0.3s ease;
    }
    
    .nav-tab.active {
        background: white;
        color: #667eea;
        border-bottom: 3px solid #667eea;
    }
    
    .content {
        padding: 30px;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .stat-number {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 8px;
    }
    
    .stat-label {
        font-size: 14px;
        opacity: 0.9;
    }
    
    .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .table th {
        background: #f8f9fa;
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
    }
    
    .table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
        vertical-align: middle;
    }
    
    .table tr:hover {
        background: #f8f9fa;
    }
    
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
        margin: 2px;
    }
    
    .btn-primary {
        background: #667eea;
        color: white;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-warning {
        background: #ffc107;
        color: #212529;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .status-badge {
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-pending {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-approved {
        background: #d4edda;
        color: #155724;
    }
    
    .status-rejected {
        background: #f8d7da;
        color: #721c24;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #dc3545;
    }
    
    .success {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #28a745;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
    }
    
    .close:hover {
        color: #000;
    }
    
    @media (max-width: 768px) {
        .nav-tabs {
            flex-direction: column;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .table {
            min-width: 600px;
        }
    }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ›¡ï¸ è¨‚è³¼ç³»çµ±ç®¡ç†å¾Œå°</h1>
        <p>ç³»çµ±ç®¡ç† Â· ç¹³è²»å¯©æ ¸ Â· è³‡æ–™çµ±è¨ˆ</p>
    </div>
    
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('dashboard')">å„€è¡¨æ¿</button>
        <button class="nav-tab" onclick="switchTab('pending')">å¾…å¯©æ ¸</button>
        <button class="nav-tab" onclick="switchTab('payments')">ç¹³è²»è¨˜éŒ„</button>
        <button class="nav-tab" onclick="switchTab('users')">ç”¨æˆ¶ç®¡ç†</button>
        <button class="nav-tab" onclick="switchTab('reports')">å ±è¡¨</button>
        <button class="nav-tab" onclick="switchTab('settings')">ç³»çµ±è¨­å®š</button>
    </div>
    
    <div class="content">
        <!-- å„€è¡¨æ¿ -->
        <div id="dashboard" class="tab-content active">
            <div id="dashboardStats" class="stats-grid">
                <div class="loading">è¼‰å…¥çµ±è¨ˆè³‡æ–™ä¸­...</div>
            </div>
            
            <div class="table-container">
                <h3 style="padding: 20px 20px 0; margin: 0;">æœ€è¿‘æ´»å‹•</h3>
                <div id="recentActivity" style="padding: 20px;">
                    <div class="loading">è¼‰å…¥æœ€è¿‘æ´»å‹•ä¸­...</div>
                </div>
            </div>
        </div>
        
        <!-- å¾…å¯©æ ¸ -->
        <div id="pending" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>å¾…å¯©æ ¸ç¹³è²»è¨˜éŒ„</h2>
                <div>
                    <button class="btn btn-success" onclick="batchApprove()">æ‰¹é‡é€šé</button>
                    <button class="btn btn-danger" onclick="batchReject()">æ‰¹é‡æ‹’çµ•</button>
                    <button class="btn btn-primary" onclick="loadPendingPayments()">ğŸ”„ é‡æ–°æ•´ç†</button>
                </div>
            </div>
            
            <div class="table-container">
                <div id="pendingPaymentsTable">
                    <div class="loading">è¼‰å…¥å¾…å¯©æ ¸è¨˜éŒ„ä¸­...</div>
                </div>
            </div>
        </div>
        
        <!-- ç¹³è²»è¨˜éŒ„ -->
        <div id="payments" class="tab-content">
            <h2 style="margin-bottom: 20px;">æ‰€æœ‰ç¹³è²»è¨˜éŒ„</h2>
            <div class="table-container">
                <div id="allPaymentsTable">
                    <div class="loading">è¼‰å…¥ç¹³è²»è¨˜éŒ„ä¸­...</div>
                </div>
            </div>
        </div>
        
        <!-- ç”¨æˆ¶ç®¡ç† -->
        <div id="users" class="tab-content">
            <h2 style="margin-bottom: 20px;">ç”¨æˆ¶ç®¡ç†</h2>
            <div class="table-container">
                <div id="usersTable">
                    <div class="loading">è¼‰å…¥ç”¨æˆ¶è³‡æ–™ä¸­...</div>
                </div>
            </div>
        </div>
        
        <!-- å ±è¡¨ -->
        <div id="reports" class="tab-content">
            <h2 style="margin-bottom: 20px;">ç³»çµ±å ±è¡¨</h2>
            
            <div class="form-group">
                <label for="reportDate">é¸æ“‡æ—¥æœŸ</label>
                <input type="date" id="reportDate" value="">
                <button class="btn btn-primary" onclick="generateReport()" style="margin-top: 10px;">
                    ç”Ÿæˆå ±è¡¨
                </button>
            </div>
            
            <div id="reportContent">
                <div class="loading">è«‹é¸æ“‡æ—¥æœŸä¸¦ç”Ÿæˆå ±è¡¨</div>
            </div>
        </div>
        
        <!-- ç³»çµ±è¨­å®š -->
        <div id="settings" class="tab-content">
            <h2 style="margin-bottom: 20px;">ç³»çµ±è¨­å®š</h2>
            
            <div style="display: grid; gap: 20px;">
                <div class="table-container" style="padding: 20px;">
                    <h3>è³‡æ–™ç®¡ç†</h3>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-warning" onclick="exportData()">
                            ğŸ“Š åŒ¯å‡ºæ‰€æœ‰è³‡æ–™
                        </button>
                        <button class="btn btn-danger" onclick="cleanupTestData()">
                            ğŸ—‘ï¸ æ¸…ç†æ¸¬è©¦è³‡æ–™
                        </button>
                        <button class="btn btn-primary" onclick="backupData()">
                            ğŸ’¾ å‚™ä»½è³‡æ–™
                        </button>
                    </div>
                </div>
                
                <div class="table-container" style="padding: 20px;">
                    <h3>ç³»çµ±è³‡è¨Š</h3>
                    <div id="systemInfo" style="margin-top: 15px;">
                        <div class="loading">è¼‰å…¥ç³»çµ±è³‡è¨Šä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¯©æ ¸æ¨¡æ…‹æ¡† -->
<div id="reviewModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>å¯©æ ¸ç¹³è²»è¨˜éŒ„</h2>
        <form id="reviewForm">
            <input type="hidden" id="reviewPaymentId">
            
            <div class="form-group">
                <label>ç¹³è²»è³‡è¨Š</label>
                <div id="reviewPaymentInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                </div>
            </div>
            
            <div class="form-group">
                <label for="reviewStatus">å¯©æ ¸çµæœ *</label>
                <select id="reviewStatus" required>
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="å·²ç¢ºèª">é€šé</option>
                    <option value="å·²æ‹’çµ•">æ‹’çµ•</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="reviewNote">å¯©æ ¸å‚™è¨»</label>
                <textarea id="reviewNote" placeholder="è«‹è¼¸å…¥å¯©æ ¸å‚™è¨»..." rows="3"></textarea>
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeReviewModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ç¢ºèªå¯©æ ¸</button>
            </div>
        </form>
    </div>
</div>

<script>
    // è¨­å®šå€åŸŸ
    const CONFIG = {
        LIFF_ID: '1657285806-2bmkYWkN',
        API_BASE_URL: 'https://script.google.com/macros/s/AKfycbxpnDW3aFjltZqRMJkWUp1jorgYbHSDTnz8jJsRbPBm4f_JvuJNn-5jmbitVJnSO4Ng/exec',
        DEBUG_MODE: true
    };

    // å…¨åŸŸè®Šæ•¸
    let adminUserId = null;
    let adminProfile = null;
    let pendingPayments = [];
    let selectedPayments = [];

    // åˆå§‹åŒ–
    window.onload = function() {
        initializeLiff();
    };

    async function initializeLiff() {
        try {
            await liff.init({ liffId: CONFIG.LIFF_ID });
            
            if (liff.isLoggedIn()) {
                adminProfile = await liff.getProfile();
                adminUserId = adminProfile.userId;
                
                // é©—è­‰ç®¡ç†è€…æ¬Šé™
                const authResult = await callAdminAPI('admin-get-statistics', {});
                
                if (authResult.success) {
                    console.log('ç®¡ç†è€…é©—è­‰æˆåŠŸ');
                    loadDashboard();
                } else {
                    showError('æ¬Šé™ä¸è¶³ï¼šæ‚¨ä¸æ˜¯ç³»çµ±ç®¡ç†è€…');
                }
            } else {
                liff.login();
            }
        } catch (error) {
            console.error('åˆå§‹åŒ–å¤±æ•—:', error);
            showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—: ' + error.message);
        }
    }

    // ç®¡ç†è€… API å‘¼å«
    async function callAdminAPI(action, data) {
        return new Promise((resolve, reject) => {
            const requestData = {
                action: action,
                data: JSON.stringify({
                    ...data,
                    adminUserId: adminUserId
                }),
                callback: 'adminAPICallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
            };
            
            window[requestData.callback] = function(response) {
                delete window[requestData.callback];
                resolve(response);
            };
            
            const script = document.createElement('script');
            const params = new URLSearchParams(requestData);
            script.src = CONFIG.API_BASE_URL + '?' + params.toString();
            
            script.onload = function() {
                document.head.removeChild(script);
            };
            
            script.onerror = function() {
                delete window[requestData.callback];
                document.head.removeChild(script);
                reject(new Error('API è«‹æ±‚å¤±æ•—'));
            };
            
            document.head.appendChild(script);
        });
    }

    // æ¨™ç±¤é åˆ‡æ›
    function switchTab(tabName) {
        // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => content.classList.remove('active'));
        
        // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
        const navTabs = document.querySelectorAll('.nav-tab');
        navTabs.forEach(tab => tab.classList.remove('active'));
        
        // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
        
        // è¼‰å…¥å°æ‡‰å…§å®¹
        loadTabContent(tabName);
    }

    async function loadTabContent(tabName) {
        switch (tabName) {
            case 'dashboard':
                loadDashboard();
                break;
            case 'pending':
                loadPendingPayments();
                break;
            case 'payments':
                loadAllPayments();
                break;
            case 'users':
                loadUsers();
                break;
            case 'reports':
                initReports();
                break;
            case 'settings':
                loadSystemInfo();
                break;
        }
    }

    // è¼‰å…¥å„€è¡¨æ¿
    async function loadDashboard() {
        try {
            const stats = await callAdminAPI('admin-get-statistics', {});
            
            if (stats.success) {
                displayDashboardStats(stats.statistics);
            } else {
                throw new Error(stats.message);
            }
        } catch (error) {
            console.error('è¼‰å…¥å„€è¡¨æ¿å¤±æ•—:', error);
            showError('è¼‰å…¥å„€è¡¨æ¿å¤±æ•—: ' + error.message);
        }
    }

    function displayDashboardStats(statistics) {
        const statsHtml = `
            <div class="stat-card">
                <div class="stat-number">${statistics.totalUsers}</div>
                <div class="stat-label">è¨»å†Šç”¨æˆ¶</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${statistics.totalOrders}</div>
                <div class="stat-label">è¨‚å–®è¨˜éŒ„</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${statistics.pendingPayments}</div>
                <div class="stat-label">å¾…å¯©æ ¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">NT$ ${statistics.totalAmount.toLocaleString()}</div>
                <div class="stat-label">ç¸½é‡‘é¡</div>
            </div>
        `;
        
        document.getElementById('dashboardStats').innerHTML = statsHtml;
        
        // è¼‰å…¥æœ€è¿‘æ´»å‹•
        const activityHtml = `
            <div style="font-size: 14px; color: #6c757d;">
                <p>ğŸ“Š ç¸½ç”¨æˆ¶æ•¸: ${statistics.totalUsers}</p>
                <p>ğŸ’° ç¸½ç¹³è²»è¨˜éŒ„: ${statistics.totalPayments}</p>
                <p>âœ… å·²ç¢ºèª: ${statistics.approvedPayments}</p>
                <p>â³ å¾…å¯©æ ¸: ${statistics.pendingPayments}</p>
                <p>ğŸ•’ æœ€å¾Œæ›´æ–°: ${new Date(statistics.lastUpdated).toLocaleString('zh-TW')}</p>
            </div>
        `;
        
        document.getElementById('recentActivity').innerHTML = activityHtml;
    }

    // è¼‰å…¥å¾…å¯©æ ¸ç¹³è²»è¨˜éŒ„
    async function loadPendingPayments() {
        try {
            document.getElementById('pendingPaymentsTable').innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            
            const result = await callAdminAPI('admin-get-pending-payments', {});
            
            if (result.success) {
                pendingPayments = result.payments;
                displayPendingPayments(result.payments);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('è¼‰å…¥å¾…å¯©æ ¸è¨˜éŒ„å¤±æ•—:', error);
            document.getElementById('pendingPaymentsTable').innerHTML = 
                `<div class="error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
        }
    }

    function displayPendingPayments(payments) {
        if (payments.length === 0) {
            document.getElementById('pendingPaymentsTable').innerHTML = 
                '<div style="padding: 40px; text-align: center; color: #6c757d;">ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„ç¹³è²»è¨˜éŒ„</div>';
            return;
        }
        
        let html = `
            <table class="table">
                <thead>
                    <tr>
                        <th><input type="checkbox" onchange="toggleAllPayments(this)"></th>
                        <th>ç¹³è²»ç·¨è™Ÿ</th>
                        <th>è¨‚å–®ç·¨è™Ÿ</th>
                        <th>ç”¨æˆ¶å§“å</th>
                        <th>ç¹³è²»é‡‘é¡</th>
                        <th>ç¹³è²»æ–¹å¼</th>
                        <th>æäº¤æ™‚é–“</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        payments.forEach(payment => {
            html += `
                <tr>
                    <td><input type="checkbox" value="${payment.paymentId}" onchange="togglePaymentSelection(this)"></td>
                    <td>${payment.paymentId}</td>
                    <td>${payment.orderId}</td>
                    <td>
                        <div>${payment.realName}</div>
                        <small style="color: #6c757d;">${payment.lineName}</small>
                    </td>
                    <td>NT$ ${payment.paymentAmount.toLocaleString()}</td>
                    <td>${payment.paymentMethod}</td>
                    <td>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</td>
                    <td>
                        <button class="btn btn-primary" onclick="openReviewModal('${payment.paymentId}')">
                            å¯©æ ¸
                        </button>
                    </td>
                </tr>
            `;
            
            if (payment.paymentNote) {
                html += `
                    <tr>
                        <td colspan="8" style="background: #f8f9fa; font-size: 12px; color: #6c757d;">
                            å‚™è¨»: ${payment.paymentNote}
                        </td>
                    </tr>
                `;
            }
        });
        
        html += `
                </tbody>
            </table>
        `;
        
        document.getElementById('pendingPaymentsTable').innerHTML = html;
    }

    // é–‹å•Ÿå¯©æ ¸æ¨¡æ…‹æ¡†
    function openReviewModal(paymentId) {
        const payment = pendingPayments.find(p => p.paymentId === paymentId);
        if (!payment) return;
        
        document.getElementById('reviewPaymentId').value = paymentId;
        
        const paymentInfo = `
            <strong>ç¹³è²»ç·¨è™Ÿ:</strong> ${payment.paymentId}<br>
            <strong>è¨‚å–®ç·¨è™Ÿ:</strong> ${payment.orderId}<br>
            <strong>ç”¨æˆ¶å§“å:</strong> ${payment.realName} (${payment.lineName})<br>
            <strong>ç¹³è²»é‡‘é¡:</strong> NT$ ${payment.paymentAmount.toLocaleString()}<br>
            <strong>ç¹³è²»æ–¹å¼:</strong> ${payment.paymentMethod}<br>
            <strong>æäº¤æ™‚é–“:</strong> ${new Date(payment.submittedAt).toLocaleString('zh-TW')}<br>
            ${payment.paymentNote ? `<strong>å‚™è¨»:</strong> ${payment.paymentNote}` : ''}
        `;
        
        document.getElementById('reviewPaymentInfo').innerHTML = paymentInfo;
        document.getElementById('reviewModal').style.display = 'block';
    }

    // é—œé–‰å¯©æ ¸æ¨¡æ…‹æ¡†
    function closeReviewModal() {
        document.getElementById('reviewModal').style.display = 'none';
        document.getElementById('reviewForm').reset();
    }

    // å¯©æ ¸è¡¨å–®æäº¤
    document.addEventListener('DOMContentLoaded', function() {
        const reviewForm = document.getElementById('reviewForm');
        if (reviewForm) {
            reviewForm.addEventListener('submit', handleReviewSubmit);
        }
        
        // æ¨¡æ…‹æ¡†é—œé–‰äº‹ä»¶
        const closeBtn = document.querySelector('.close');
        if (closeBtn) {
            closeBtn.onclick = closeReviewModal;
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById('reviewModal');
            if (event.target === modal) {
                closeReviewModal();
            }
        }
        
        // è¨­å®šä»Šå¤©çš„æ—¥æœŸ
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('reportDate').value = today;
    });

    async function handleReviewSubmit(e) {
        e.preventDefault();
        
        const paymentId = document.getElementById('reviewPaymentId').value;
        const status = document.getElementById('reviewStatus').value;
        const reviewNote = document.getElementById('reviewNote').value;
        
        if (!status) {
            alert('è«‹é¸æ“‡å¯©æ ¸çµæœ');
            return;
        }
        
        try {
            const result = await callAdminAPI('admin-review-payment', {
                paymentId: paymentId,
                status: status,
                reviewNote: reviewNote
            });
            
            if (result.success) {
                alert('å¯©æ ¸å®Œæˆï¼');
                closeReviewModal();
                loadPendingPayments(); // é‡æ–°è¼‰å…¥å¾…å¯©æ ¸åˆ—è¡¨
                loadDashboard(); // æ›´æ–°å„€è¡¨æ¿çµ±è¨ˆ
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('å¯©æ ¸å¤±æ•—:', error);
            alert('å¯©æ ¸å¤±æ•—: ' + error.message);
        }
    }

    // åˆ‡æ›å–®å€‹ç¹³è²»è¨˜éŒ„é¸æ“‡
    function togglePaymentSelection(checkbox) {
        const paymentId = checkbox.value;
        
        if (checkbox.checked) {
            if (!selectedPayments.includes(paymentId)) {
                selectedPayments.push(paymentId);
            }
        } else {
            const index = selectedPayments.indexOf(paymentId);
            if (index > -1) {
                selectedPayments.splice(index, 1);
            }
        }
        
        console.log('å·²é¸æ“‡:', selectedPayments);
    }

    // åˆ‡æ›å…¨é¸
    function toggleAllPayments(masterCheckbox) {
        const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
        selectedPayments = [];
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = masterCheckbox.checked;
            if (masterCheckbox.checked) {
                selectedPayments.push(checkbox.value);
            }
        });
        
        console.log('å…¨é¸ç‹€æ…‹:', masterCheckbox.checked, 'å·²é¸æ“‡:', selectedPayments);
    }

    // æ‰¹é‡é€šé
    async function batchApprove() {
        if (selectedPayments.length === 0) {
            alert('è«‹å…ˆé¸æ“‡è¦å¯©æ ¸çš„ç¹³è²»è¨˜éŒ„');
            return;
        }
        
        const confirmMsg = `ç¢ºå®šè¦æ‰¹é‡é€šé ${selectedPayments.length} ç­†ç¹³è²»è¨˜éŒ„å—ï¼Ÿ`;
        if (!confirm(confirmMsg)) return;
        
        try {
            const result = await callAdminAPI('admin-batch-review', {
                paymentIds: selectedPayments,
                status: 'å·²ç¢ºèª',
                reviewNote: 'æ‰¹é‡å¯©æ ¸é€šé'
            });
            
            if (result.success) {
                alert(result.message);
                selectedPayments = [];
                loadPendingPayments();
                loadDashboard();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('æ‰¹é‡å¯©æ ¸å¤±æ•—:', error);
            alert('æ‰¹é‡å¯©æ ¸å¤±æ•—: ' + error.message);
        }
    }

    // æ‰¹é‡æ‹’çµ•
    async function batchReject() {
        if (selectedPayments.length === 0) {
            alert('è«‹å…ˆé¸æ“‡è¦å¯©æ ¸çš„ç¹³è²»è¨˜éŒ„');
            return;
        }
        
        const reason = prompt(`å³å°‡æ‰¹é‡æ‹’çµ• ${selectedPayments.length} ç­†ç¹³è²»è¨˜éŒ„ï¼Œè«‹è¼¸å…¥æ‹’çµ•åŸå› ï¼š`);
        if (!reason) return;
        
        try {
            const result = await callAdminAPI('admin-batch-review', {
                paymentIds: selectedPayments,
                status: 'å·²æ‹’çµ•',
                reviewNote: reason
            });
            
            if (result.success) {
                alert(result.message);
                selectedPayments = [];
                loadPendingPayments();
                loadDashboard();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('æ‰¹é‡å¯©æ ¸å¤±æ•—:', error);
            alert('æ‰¹é‡å¯©æ ¸å¤±æ•—: ' + error.message);
        }
    }

    // è¼‰å…¥æ‰€æœ‰ç¹³è²»è¨˜éŒ„
    async function loadAllPayments() {
        try {
            document.getElementById('allPaymentsTable').innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            
            const result = await callAdminAPI('admin-get-all-payments', {});
            
            if (result.success) {
                displayAllPayments(result.payments);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('è¼‰å…¥ç¹³è²»è¨˜éŒ„å¤±æ•—:', error);
            document.getElementById('allPaymentsTable').innerHTML = 
                `<div class="error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
        }
    }

    function displayAllPayments(payments) {
        if (payments.length === 0) {
            document.getElementById('allPaymentsTable').innerHTML = 
                '<div style="padding: 40px; text-align: center; color: #6c757d;">ç›®å‰æ²’æœ‰ç¹³è²»è¨˜éŒ„</div>';
            return;
        }
        
        let html = `
            <table class="table">
                <thead>
                    <tr>
                        <th>ç¹³è²»ç·¨è™Ÿ</th>
                        <th>ç”¨æˆ¶è³‡è¨Š</th>
                        <th>ç¹³è²»è³‡è¨Š</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ™‚é–“</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        payments.forEach(payment => {
            const statusClass = getStatusClass(payment.status);
            const statusText = getStatusText(payment.status);
            
            html += `
                <tr>
                    <td>
                        <div style="font-weight: 600;">${payment.paymentId}</div>
                        <small style="color: #6c757d;">${payment.orderId}</small>
                    </td>
                    <td>
                        <div style="font-weight: 600;">${payment.realName}</div>
                        <small style="color: #6c757d;">${payment.lineName}</small>
                    </td>
                    <td>
                        <div>NT$ ${payment.paymentAmount.toLocaleString()}</div>
                        <small style="color: #6c757d;">${payment.paymentMethod}</small>
                    </td>
                    <td>
                        <span class="status-badge status-${statusClass}">${statusText}</span>
                    </td>
                    <td>
                        <div style="font-size: 12px;">
                            æäº¤: ${new Date(payment.submittedAt).toLocaleDateString('zh-TW')}
                            ${payment.reviewedAt ? `<br>å¯©æ ¸: ${new Date(payment.reviewedAt).toLocaleDateString('zh-TW')}` : ''}
                        </div>
                    </td>
                    <td>
                        ${payment.status === 'å¾…å¯©æ ¸' ? 
                            `<button class="btn btn-primary" onclick="openReviewModal('${payment.paymentId}')">å¯©æ ¸</button>` : 
                            `<button class="btn btn-secondary" onclick="viewPaymentDetails('${payment.paymentId}')">è©³æƒ…</button>`
                        }
                    </td>
                </tr>
            `;
            
            if (payment.paymentNote || payment.reviewNote) {
                html += `
                    <tr>
                        <td colspan="6" style="background: #f8f9fa; font-size: 12px; color: #6c757d; padding: 8px 12px;">
                            ${payment.paymentNote ? `ç”¨æˆ¶å‚™è¨»: ${payment.paymentNote}<br>` : ''}
                            ${payment.reviewNote ? `å¯©æ ¸å‚™è¨»: ${payment.reviewNote}` : ''}
                        </td>
                    </tr>
                `;
            }
        });
        
        html += `
                </tbody>
            </table>
        `;
        
        document.getElementById('allPaymentsTable').innerHTML = html;
    }

    // è¼‰å…¥ç”¨æˆ¶è³‡æ–™
    async function loadUsers() {
        try {
            document.getElementById('usersTable').innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            
            const result = await callAdminAPI('admin-get-users', {});
            
            if (result.success) {
                displayUsers(result.users);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('è¼‰å…¥ç”¨æˆ¶è³‡æ–™å¤±æ•—:', error);
            document.getElementById('usersTable').innerHTML = 
                `<div class="error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
        }
    }

    function displayUsers(users) {
        if (users.length === 0) {
            document.getElementById('usersTable').innerHTML = 
                '<div style="padding: 40px; text-align: center; color: #6c757d;">ç›®å‰æ²’æœ‰è¨»å†Šç”¨æˆ¶</div>';
            return;
        }
        
        let html = `
            <table class="table">
                <thead>
                    <tr>
                        <th>ç”¨æˆ¶è³‡è¨Š</th>
                        <th>è¨»å†Šæ™‚é–“</th>
                        <th>æœ€å¾Œç™»å…¥</th>
                        <th>ç‹€æ…‹</th>
                        <th>çµ±è¨ˆ</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        users.forEach(user => {
            html += `
                <tr>
                    <td>
                        <div style="font-weight: 600;">${user.realName}</div>
                        <small style="color: #6c757d;">${user.lineDisplayName}</small>
                        <div style="font-size: 11px; color: #999; margin-top: 2px;">
                            ID: ${user.userId.substring(0, 20)}...
                        </div>
                    </td>
                    <td>${new Date(user.registeredAt).toLocaleString('zh-TW')}</td>
                    <td>${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleString('zh-TW') : 'æœªè¨˜éŒ„'}</td>
                    <td>
                        <span class="status-badge ${user.status === 'active' ? 'status-approved' : 'status-pending'}">
                            ${user.status === 'active' ? 'æ­£å¸¸' : user.status}
                        </span>
                    </td>
                    <td>
                        <div style="font-size: 12px;">
                            è¨‚å–®: ${user.orderCount || 0}<br>
                            ç¹³è²»: ${user.paymentCount || 0}
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
        `;
        
        document.getElementById('usersTable').innerHTML = html;
    }

    // åˆå§‹åŒ–å ±è¡¨
    function initReports() {
        // å ±è¡¨åŠŸèƒ½å·²ç¶“åœ¨ HTML ä¸­è¨­å®šå¥½äº†
        console.log('å ±è¡¨é é¢å·²åˆå§‹åŒ–');
    }

    // ç”Ÿæˆå ±è¡¨
    async function generateReport() {
        const targetDate = document.getElementById('reportDate').value;
        if (!targetDate) {
            alert('è«‹é¸æ“‡æ—¥æœŸ');
            return;
        }
        
        try {
            document.getElementById('reportContent').innerHTML = '<div class="loading">ç”Ÿæˆå ±è¡¨ä¸­...</div>';
            
            const result = await callAdminAPI('admin-get-daily-report', {
                targetDate: targetDate
            });
            
            if (result.success) {
                displayReport(result.report);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('ç”Ÿæˆå ±è¡¨å¤±æ•—:', error);
            document.getElementById('reportContent').innerHTML = 
                `<div class="error">ç”Ÿæˆå ±è¡¨å¤±æ•—: ${error.message}</div>`;
        }
    }

    function displayReport(report) {
        const html = `
            <div class="table-container">
                <h3>ğŸ“Š ${report.date} æ—¥å ±è¡¨</h3>
                
                <div class="stats-grid" style="margin: 20px 0;">
                    <div class="stat-card">
                        <div class="stat-number">${report.newRegistrations}</div>
                        <div class="stat-label">æ–°è¨»å†Šç”¨æˆ¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${report.newPayments}</div>
                        <div class="stat-label">æ–°ç¹³è²»è¨˜éŒ„</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${report.approvedPayments}</div>
                        <div class="stat-label">å¯©æ ¸é€šé</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">NT$ ${report.totalAmount.toLocaleString()}</div>
                        <div class="stat-label">ç•¶æ—¥é‡‘é¡</div>
                    </div>
                </div>
                
                ${report.details.registrations.length > 0 ? `
                    <h4>æ–°è¨»å†Šç”¨æˆ¶</h4>
                    <table class="table" style="margin-bottom: 20px;">
                        <thead>
                            <tr>
                                <th>çœŸå¯¦å§“å</th>
                                <th>LINE åç¨±</th>
                                <th>è¨»å†Šæ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${report.details.registrations.map(reg => `
                                <tr>
                                    <td>${reg.realName}</td>
                                    <td>${reg.lineDisplayName}</td>
                                    <td>${new Date(reg.registeredAt).toLocaleString('zh-TW')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : ''}
                
                ${report.details.payments.length > 0 ? `
                    <h4>ç•¶æ—¥ç¹³è²»è¨˜éŒ„</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ç¹³è²»ç·¨è™Ÿ</th>
                                <th>ç”¨æˆ¶å§“å</th>
                                <th>é‡‘é¡</th>
                                <th>æ–¹å¼</th>
                                <th>ç‹€æ…‹</th>
                                <th>æ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${report.details.payments.map(payment => `
                                <tr>
                                    <td>${payment.paymentId}</td>
                                    <td>${payment.realName}</td>
                                    <td>NT$ ${payment.paymentAmount.toLocaleString()}</td>
                                    <td>${payment.paymentMethod}</td>
                                    <td>
                                        <span class="status-badge status-${getStatusClass(payment.status)}">
                                            ${getStatusText(payment.status)}
                                        </span>
                                    </td>
                                    <td>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : ''}
            </div>
        `;
        
        document.getElementById('reportContent').innerHTML = html;
    }

    // è¼‰å…¥ç³»çµ±è³‡è¨Š
    async function loadSystemInfo() {
        try {
            const info = {
                version: '1.0.0',
                lastUpdate: new Date().toISOString(),
                environment: 'Production',
                database: 'Google Sheets',
                liffVersion: liff.getVersion(),
                adminUser: adminProfile.displayName
            };
            
            const html = `
                <div style="font-size: 14px; line-height: 1.6;">
                    <p><strong>ç³»çµ±ç‰ˆæœ¬:</strong> ${info.version}</p>
                    <p><strong>æœ€å¾Œæ›´æ–°:</strong> ${new Date(info.lastUpdate).toLocaleString('zh-TW')}</p>
                    <p><strong>é‹è¡Œç’°å¢ƒ:</strong> ${info.environment}</p>
                    <p><strong>è³‡æ–™åº«:</strong> ${info.database}</p>
                    <p><strong>LIFF ç‰ˆæœ¬:</strong> ${info.liffVersion}</p>
                    <p><strong>ç•¶å‰ç®¡ç†è€…:</strong> ${info.adminUser}</p>
                </div>
            `;
            
            document.getElementById('systemInfo').innerHTML = html;
        } catch (error) {
            console.error('è¼‰å…¥ç³»çµ±è³‡è¨Šå¤±æ•—:', error);
            document.getElementById('systemInfo').innerHTML = 
                `<div class="error">è¼‰å…¥ç³»çµ±è³‡è¨Šå¤±æ•—: ${error.message}</div>`;
        }
    }

    // åŒ¯å‡ºè³‡æ–™
    async function exportData() {
        if (!confirm('ç¢ºå®šè¦åŒ¯å‡ºæ‰€æœ‰ç³»çµ±è³‡æ–™å—ï¼Ÿé€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ã€‚')) return;
        
        try {
            const result = await callAdminAPI('admin-export-data', {});
            
            if (result.success) {
                // å»ºç«‹ä¸‹è¼‰é€£çµ
                const dataStr = JSON.stringify(result.data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `system_export_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                
                alert(`è³‡æ–™åŒ¯å‡ºå®Œæˆï¼\nç¸½ç”¨æˆ¶: ${result.summary.totalUsers}\nç¸½è¨‚å–®: ${result.summary.totalOrders}\nç¸½ç¹³è²»: ${result.summary.totalPayments}`);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('åŒ¯å‡ºè³‡æ–™å¤±æ•—:', error);
            alert('åŒ¯å‡ºè³‡æ–™å¤±æ•—: ' + error.message);
        }
    }

    // æ¸…ç†æ¸¬è©¦è³‡æ–™
    async function cleanupTestData() {
        const confirmMsg = 'ç¢ºå®šè¦æ¸…ç†æ‰€æœ‰æ¸¬è©¦è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼\n\nå°‡æœƒåˆªé™¤åŒ…å«ã€Œæ¸¬è©¦ã€ã€ã€Œtestã€ã€ã€ŒTestã€é—œéµå­—çš„è³‡æ–™ã€‚';
        if (!confirm(confirmMsg)) return;
        
        try {
            const result = await callAdminAPI('admin-cleanup-test-data', {});
            
            if (result.success) {
                alert(result.message);
                // é‡æ–°è¼‰å…¥ç•¶å‰é é¢è³‡æ–™
                loadDashboard();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('æ¸…ç†æ¸¬è©¦è³‡æ–™å¤±æ•—:', error);
            alert('æ¸…ç†æ¸¬è©¦è³‡æ–™å¤±æ•—: ' + error.message);
        }
    }

    // å‚™ä»½è³‡æ–™
    async function backupData() {
        const backupSpreadsheetId = prompt('è«‹è¼¸å…¥å‚™ä»½ç›®æ¨™è©¦ç®—è¡¨çš„ IDï¼š\nï¼ˆè«‹å…ˆå»ºç«‹ä¸€å€‹ç©ºçš„ Google Sheets ä¸¦è¤‡è£½å…¶ IDï¼‰');
        
        if (!backupSpreadsheetId) return;
        
        try {
            const result = await callAdminAPI('admin-backup-data', {
                backupSpreadsheetId: backupSpreadsheetId
            });
            
            if (result.success) {
                alert(`è³‡æ–™å‚™ä»½å®Œæˆï¼\nå‚™ä»½æ™‚é–“: ${new Date(result.backupTime).toLocaleString('zh-TW')}\nå‚™ä»½å…§å®¹: ${result.sheetsBackedUp.join(', ')}`);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('å‚™ä»½è³‡æ–™å¤±æ•—:', error);
            alert('å‚™ä»½è³‡æ–™å¤±æ•—: ' + error.message);
        }
    }

    // å·¥å…·å‡½æ•¸
    function getStatusClass(status) {
        switch (status) {
            case 'å¾…å¯©æ ¸': return 'pending';
            case 'å·²ç¢ºèª': return 'approved';
            case 'å·²æ‹’çµ•': return 'rejected';
            default: return 'pending';
        }
    }

    function getStatusText(status) {
        switch (status) {
            case 'å¾…å¯©æ ¸': return 'å¾…å¯©æ ¸';
            case 'å·²ç¢ºèª': return 'å·²ç¢ºèª';
            case 'å·²æ‹’çµ•': return 'å·²æ‹’çµ•';
            default: return status || 'æœªçŸ¥';
        }
    }

    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.innerHTML = `
            <h3>âŒ éŒ¯èª¤</h3>
            <p>${message}</p>
        `;
        
        const content = document.querySelector('.content');
        content.insertBefore(errorDiv, content.firstChild);
        
        // 5ç§’å¾Œè‡ªå‹•ç§»é™¤
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
            }
        }, 5000);
    }

    function viewPaymentDetails(paymentId) {
        // é€™è£¡å¯ä»¥å¯¦ä½œæŸ¥çœ‹ç¹³è²»è©³æƒ…çš„åŠŸèƒ½
        alert('æŸ¥çœ‹ç¹³è²»è©³æƒ…åŠŸèƒ½é–‹ç™¼ä¸­...\nç¹³è²»ç·¨è™Ÿ: ' + paymentId);
    }

    // é–‹ç™¼ç”¨æ¸¬è©¦å‡½æ•¸
    if (CONFIG.DEBUG_MODE) {
        window.testAdminFunctions = function() {
            console.log('=== ç®¡ç†è€…åŠŸèƒ½æ¸¬è©¦ ===');
            console.log('ç®¡ç†è€…ID:', adminUserId);
            console.log('ç®¡ç†è€…è³‡æ–™:', adminProfile);
            console.log('å·²é¸æ“‡ç¹³è²»è¨˜éŒ„:', selectedPayments);
            console.log('å¾…å¯©æ ¸è¨˜éŒ„:', pendingPayments);
        };
    }
</script>
</body>
</html>
