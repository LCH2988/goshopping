<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÊúÉÂì°Ë®ÇË≥ºÊ∏ÖÂñÆÊü•Ë©¢Á≥ªÁµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      
      body {
          font-family: 'Arial', sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
      }
      
      .container {
          background: white;
          border-radius: 20px;
          box-shadow: 0 20px 40px rgba(0,0,0,0.1);
          overflow: hidden;
          max-width: 400px;
          width: 100%;
      }
      
      .header {
          background: linear-gradient(135deg, #ff6b6b, #ee5a24);
          color: white;
          text-align: center;
          padding: 30px 20px;
      }
      
      .header h1 {
          font-size: 22px;
          margin-bottom: 10px;
      }
      
      .content {
          padding: 30px;
      }
      
      .tab-buttons {
          display: flex;
          margin-bottom: 30px;
          background: #f8f9fa;
          border-radius: 10px;
          padding: 5px;
          flex-wrap: wrap;
      }
      
      .tab-button {
          flex: 1;
          padding: 10px 8px;
          text-align: center;
          border: none;
          background: transparent;
          cursor: pointer;
          border-radius: 8px;
          transition: all 0.3s;
          font-weight: 500;
          font-size: 14px;
          min-width: 70px;
      }
      
      .tab-button.active {
          background: #667eea;
          color: white;
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }
      
      .tab-content {
          display: none;
      }
      
      .tab-content.active {
          display: block;
      }
      
      .form-group {
          margin-bottom: 20px;
      }
      
      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #333;
      }
      
      .form-group input, .form-group select {
          width: 100%;
          padding: 15px;
          border: 2px solid #e1e5e9;
          border-radius: 10px;
          font-size: 16px;
          transition: border-color 0.3s;
      }
      
      .form-group input:focus, .form-group select:focus {
          outline: none;
          border-color: #667eea;
      }
      
      .btn {
          width: 100%;
          padding: 15px;
          border: none;
          border-radius: 10px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          margin-bottom: 10px;
      }
      
      .btn-primary {
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
      }
      
      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }
      
      .btn-secondary {
          background: #6c757d;
          color: white;
      }
      
      .btn-success {
          background: #28a745;
          color: white;
      }
      
      .user-info {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 10px;
          margin-bottom: 20px;
      }
      
      .user-info h3 {
          color: #333;
          margin-bottom: 15px;
      }
      
      .info-item {
          display: flex;
          justify-content: space-between;
          margin-bottom: 10px;
          padding: 8px 0;
          border-bottom: 1px solid #dee2e6;
      }
      
      .info-item:last-child {
          border-bottom: none;
      }
      
      .info-label {
          font-weight: 600;
          color: #666;
      }
      
      .info-value {
          color: #333;
          text-align: right;
      }
      
      .order-list {
          max-height: 400px;
          overflow-y: auto;
      }
      
      .order-item {
          background: #f8f9fa;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 15px;
          border-left: 4px solid #667eea;
      }
      
      .order-item.paid {
          border-left-color: #28a745;
      }
      
      .order-item.unpaid {
          border-left-color: #dc3545;
      }
      
      .order-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
      }
      
      .order-number {
          font-weight: 600;
          color: #667eea;
      }
      
      .order-amount {
          font-weight: 600;
          color: #ee5a24;
      }
      
      .order-status {
          display: inline-block;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 600;
          margin-top: 5px;
      }
      
      .status-paid {
          background: #d4edda;
          color: #155724;
      }
      
      .status-unpaid {
          background: #f8d7da;
          color: #721c24;
      }
      
      .order-details {
          font-size: 14px;
          color: #666;
      }
      
      .stats-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
          margin-bottom: 20px;
      }
      
      .stat-card {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
      }
      
      .stat-number {
          font-size: 20px;
          font-weight: 600;
          color: #667eea;
          margin-bottom: 5px;
      }
      
      .stat-label {
          font-size: 12px;
          color: #666;
      }
      
      .payment-form {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 10px;
          margin-bottom: 20px;
      }
      
      .loading {
          text-align: center;
          padding: 40px;
          color: #666;
      }
      
      .error {
          background: #f8d7da;
          color: #721c24;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
      }
      
      .success {
          background: #d4edda;
          color: #155724;
          padding: 15px;
          border-radius: 10px;
          margin-bottom: 20px;
      }
      
      @media (max-width: 480px) {
          .container {
              margin: 10px;
          }
          
          .content {
              padding: 20px;
          }
          
          .stats-grid {
              grid-template-columns: 1fr;
          }
          
          .tab-button {
              font-size: 12px;
              padding: 8px 6px;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>üõí ÊúÉÂì°Ë®ÇË≥ºÊ∏ÖÂñÆÊü•Ë©¢Á≥ªÁµ±</h1>
          <p>ÂØ¶ÂêçÁôªË®ò ¬∑ Ë®ÇË≥ºÊü•Ë©¢ ¬∑ Áπ≥Ë≤ªÂõûÂ†±</p>
      </div>
      
      <div class="content">
          <!-- ÂàÜÈ†ÅÊåâÈàï -->
          <div class="tab-buttons">
              <button class="tab-button active" onclick="switchTab('register')">ÂØ¶ÂêçÁôªË®ò</button>
              <button class="tab-button" onclick="switchTab('profile')">ÂÄã‰∫∫Ë≥áÊñô</button>
              <button class="tab-button" onclick="switchTab('orders')">Ë®ÇË≥ºÊ∏ÖÂñÆ</button>
              <button class="tab-button" onclick="switchTab('payment')">Áπ≥Ë≤ªÂõûÂ†±</button>
          </div>
          
          <!-- ÂØ¶ÂêçÁôªË®òÈ†ÅÈù¢ -->
          <div id="register-tab" class="tab-content active">
              <form id="memberForm">
                  <div class="form-group">
                      <label for="realName">ÁúüÂØ¶ÂßìÂêç *</label>
                      <input type="text" id="realName" name="realName" required placeholder="Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÁúüÂØ¶ÂßìÂêç">
                  </div>
                  
                  <div class="form-group">
                      <label for="doterraId">Â§öÁâπÁëûID *</label>
                      <input type="text" id="doterraId" name="doterraId" required placeholder="Ë´ãËº∏ÂÖ•Â§öÁâπÁëûID">
                  </div>
                  
                  <div class="form-group">
                      <label for="referrerName">‰ªãÁ¥π‰∫∫ÂêçÂ≠ó *</label>
                      <input type="text" id="referrerName" name="referrerName" required placeholder="Ë´ãËº∏ÂÖ•‰ªãÁ¥π‰∫∫ÂêçÂ≠ó">
                  </div>
                  
                  <div class="form-group">
                      <label for="phone">ËÅØÁµ°ÈõªË©± *</label>
                      <input type="tel" id="phone" name="phone" required placeholder="Ë´ãËº∏ÂÖ•ËÅØÁµ°ÈõªË©±">
                  </div>
                  
                  <div class="form-group">
                      <label for="email">ÈõªÂ≠êÈÉµ‰ª∂</label>
                      <input type="email" id="email" name="email" placeholder="Ë´ãËº∏ÂÖ•ÈõªÂ≠êÈÉµ‰ª∂ÔºàÈÅ∏Â°´Ôºâ">
                  </div>
                  
                  <div class="form-group">
                      <label for="address">ËÅØÁµ°Âú∞ÂùÄ</label>
                      <input type="text" id="address" name="address" placeholder="Ë´ãËº∏ÂÖ•ËÅØÁµ°Âú∞ÂùÄÔºàÈÅ∏Â°´Ôºâ">
                  </div>
                  
                  <button type="submit" class="btn btn-primary">ÂÆåÊàêÂØ¶ÂêçÁôªË®ò</button>
              </form>
          </div>
          
          <!-- ÂÄã‰∫∫Ë≥áÊñôÈ†ÅÈù¢ -->
          <div id="profile-tab" class="tab-content">
              <div id="profileContent">
                  <div class="loading">ËºâÂÖ•‰∏≠...</div>
              </div>
          </div>
          
          <!-- Ë®ÇË≥ºÊ∏ÖÂñÆÈ†ÅÈù¢ -->
          <div id="orders-tab" class="tab-content">
              <div id="ordersContent">
                  <div class="loading">ËºâÂÖ•‰∏≠...</div>
              </div>
          </div>
          
          <!-- Áπ≥Ë≤ªÂõûÂ†±È†ÅÈù¢ -->
          <div id="payment-tab" class="tab-content">
              <div id="paymentContent">
                  <div class="payment-form">
                      <h3>üí≥ Áπ≥Ë≤ªÂõûÂ†±</h3>
                      <form id="paymentForm">
                          <div class="form-group">
                              <label for="orderSelect">ÈÅ∏ÊìáË®ÇÂñÆ</label>
                              <select id="orderSelect" name="orderSelect" required>
                                  <option value="">Ë´ãÈÅ∏ÊìáË¶ÅÂõûÂ†±ÁöÑË®ÇÂñÆ</option>
                              </select>
                          </div>
                          
                          <div class="form-group">
                              <label for="paymentAmount">Áπ≥Ë≤ªÈáëÈ°ç</label>
                              <input type="number" id="paymentAmount" name="paymentAmount" required placeholder="Ë´ãËº∏ÂÖ•Áπ≥Ë≤ªÈáëÈ°ç">
                          </div>
                          
                          <div class="form-group">
                              <label for="paymentMethod">Áπ≥Ë≤ªÊñπÂºè</label>
                              <select id="paymentMethod" name="paymentMethod" required>
                                  <option value="ËΩâÂ∏≥">ÈäÄË°åËΩâÂ∏≥</option>
                                  <option value="ÁèæÈáë">ÁèæÈáëÁπ≥Ë≤ª</option>
                                  <option value="‰ø°Áî®Âç°">‰ø°Áî®Âç°</option>
                                  <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                              </select>
                          </div>
                          
                          <div class="form-group">
                              <label for="paymentRemarks">ÂÇôË®ª</label>
                              <input type="text" id="paymentRemarks" name="paymentRemarks" placeholder="ËΩâÂ∏≥Â∏≥ËôüÂæå5Á¢ºÊàñÂÖ∂‰ªñÂÇôË®ª">
                          </div>
                          
                          <button type="submit" class="btn btn-success">Êèê‰∫§Áπ≥Ë≤ªÂõûÂ†±</button>
                      </form>
                  </div>
              </div>
          </div>
      </div>
  </div>
  
  <script>
      // LIFF ÂàùÂßãÂåñ
      let liffId = '2006113324-od69VN74'; // Ë´ãÊõøÊèõÁÇ∫ÊÇ®ÁöÑ LIFF ID
      let lineProfile = null;
      let memberData = null;
      let orderData = null;
      
      // Google Apps Script API URL
      const API_URL = 'https://script.google.com/macros/s/AKfycbwPx3nYNDVOpHdLn0zLZRp8W8dQTW5bdxNFgGVeKJgeaPc8xODFKZpl5rQvEt5RS-lx/exec'; // Ë´ãÊõøÊèõÁÇ∫ÊÇ®ÁöÑ GAS URL
      
      // ÂàùÂßãÂåñ LIFF
      async function initializeLiff() {
          try {
              await liff.init({ liffId: liffId });
              
              if (!liff.isLoggedIn()) {
                  liff.login();
                  return;
              }
              
              // Áç≤ÂèñÁî®Êà∂Ë≥áÊñô
              lineProfile = await liff.getProfile();
              console.log('LINE Profile:', lineProfile);
              
              // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÊòØÊúÉÂì°
              await checkMemberStatus();
              
          } catch (error) {
              console.error('LIFF ÂàùÂßãÂåñÂ§±Êïó:', error);
              showError('Á≥ªÁµ±ÂàùÂßãÂåñÂ§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢');
          }
      }
      
      // Ê™¢Êü•ÊúÉÂì°ÁãÄÊÖã
      async function checkMemberStatus() {
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'checkMember',
                      lineUserId: lineProfile.userId
                  })
              });
              
              const result = await response.json();
              
              if (result.success && result.memberData) {
                  memberData = result.memberData;
                  updateUIForMember();
              } else {
                  updateUIForNewUser();
              }
              
          } catch (error) {
              console.error('Ê™¢Êü•ÊúÉÂì°ÁãÄÊÖãÂ§±Êïó:', error);
              showError('ÁÑ°Ê≥ïÈÄ£Êé•Âà∞‰º∫ÊúçÂô®ÔºåË´ãÁ®çÂæåÂÜçË©¶');
          }
      }
      
      // Êõ¥Êñ∞Â∑≤Ë®ªÂÜäÊúÉÂì°ÁöÑ UI
      function updateUIForMember() {
          // È†êÂ°´ÂÄã‰∫∫Ë≥áÊñô
          document.getElementById('realName').value = memberData.realName || '';
          document.getElementById('doterraId').value = memberData.doterraId || '';
          document.getElementById('referrerName').value = memberData.referrerName || '';
          document.getElementById('phone').value = memberData.phone || '';
          document.getElementById('email').value = memberData.email || '';
          document.getElementById('address').value = memberData.address || '';
          
          // ËºâÂÖ•ÂÄã‰∫∫Ë≥áÊñôÈ†ÅÈù¢
          loadProfilePage();
          
          // ËºâÂÖ•Ë®ÇË≥ºË®òÈåÑ
          loadOrdersPage();
      }
      
      // Êõ¥Êñ∞Êñ∞Áî®Êà∂ÁöÑ UI
      function updateUIForNewUser() {
          showSuccess('Ê≠°Ëøé‰ΩøÁî®ÊúÉÂì°Ë®ÇË≥ºÊ∏ÖÂñÆÊü•Ë©¢Á≥ªÁµ±ÔºÅË´ãÂÖàÂÆåÊàêÂØ¶ÂêçÁôªË®ò„ÄÇ');
      }
      
      // ËºâÂÖ•ÂÄã‰∫∫Ë≥áÊñôÈ†ÅÈù¢
      function loadProfilePage() {
          const profileContent = document.getElementById('profileContent');
          
          if (!memberData) {
              profileContent.innerHTML = `
                  <div class="error">
                      Ë´ãÂÖàÂÆåÊàêÂØ¶ÂêçÁôªË®ò
                  </div>
              `;
              return;
          }
          
          profileContent.innerHTML = `
              <div class="user-info">
                  <h3>üë§ LINE Ë≥áÊñô</h3>
                  <div class="info-item">
                      <span class="info-label">È°ØÁ§∫ÂêçÁ®±</span>
                      <span class="info-value">${lineProfile.displayName}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">Áî®Êà∂ ID</span>
                      <span class="info-value">${lineProfile.userId.substring(0, 10)}...</span>
                  </div>
              </div>
              
              <div class="user-info">
                  <h3>üìã ÊúÉÂì°Ë≥áÊñô</h3>
                  <div class="info-item">
                      <span class="info-label">ÁúüÂØ¶ÂßìÂêç</span>
                      <span class="info-value">${memberData.realName}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">Â§öÁâπÁëûID</span>
                      <span class="info-value">${memberData.doterraId}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">‰ªãÁ¥π‰∫∫</span>
                      <span class="info-value">${memberData.referrerName}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">ËÅØÁµ°ÈõªË©±</span>
                      <span class="info-value">${memberData.phone}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">ÈõªÂ≠êÈÉµ‰ª∂</span>
                      <span class="info-value">${memberData.email || 'Êú™Ë®≠ÂÆö'}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">ËÅØÁµ°Âú∞ÂùÄ</span>
                      <span class="info-value">${memberData.address || 'Êú™Ë®≠ÂÆö'}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">Ë®ªÂÜäÊôÇÈñì</span>
                      <span class="info-value">${new Date(memberData.registerTime).toLocaleString('zh-TW')}</span>
                  </div>
              </div>
              
              <button class="btn btn-secondary" onclick="editProfile()">‰øÆÊîπË≥áÊñô</button>
          `;
      }
      
      // ËºâÂÖ•Ë®ÇË≥ºË®òÈåÑÈ†ÅÈù¢
      async function loadOrdersPage() {
          const ordersContent = document.getElementById('ordersContent');
          
          if (!memberData) {
              ordersContent.innerHTML = `
                  <div class="error">
                      Ë´ãÂÖàÂÆåÊàêÂØ¶ÂêçÁôªË®ò
                  </div>
              `;
              return;
          }
          
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: 'getOrders',
                      lineUserId: lineProfile.userId,
                      realName: memberData.realName
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  orderData = result.orders;
                  displayOrders(result.orders, result.statistics);
                  updatePaymentForm(result.orders);
              } else {
                  ordersContent.innerHTML = `
                      <div class="error">
                          ËºâÂÖ•Ë®ÇË≥ºË®òÈåÑÂ§±ÊïóÔºö${result.message}
                      </div>
                  `;
              }
              
          } catch (error) {
              console.error('ËºâÂÖ•Ë®ÇË≥ºË®òÈåÑÂ§±Êïó:', error);
              ordersContent.innerHTML = `
                  <div class="error">
                      ÁÑ°Ê≥ïËºâÂÖ•Ë®ÇË≥ºË®òÈåÑÔºåË´ãÁ®çÂæåÂÜçË©¶
                  </div>
              `;
          }
      }
      
      // È°ØÁ§∫Ë®ÇË≥ºË®òÈåÑ
      function displayOrders(orders, statistics) {
          const ordersContent = document.getElementById('ordersContent');
          
          let html = `
              <div class="stats-grid">
                  <div class="stat-card">
                      <div class="stat-number">${statistics.totalOrders}</div>
                      <div class="stat-label">Á∏ΩË®ÇÂñÆÊï∏</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">NT$ ${statistics.totalAmount.toLocaleString()}</div>
                      <div class="stat-label">Á∏ΩÈáëÈ°ç</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">${statistics.paidOrders}</div>
                      <div class="stat-label">Â∑≤Áπ≥Ë≤ª</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number">${statistics.unpaidOrders}</div>
                      <div class="stat-label">Êú™Áπ≥Ë≤ª</div>
                  </div>
              </div>
          `;
          
          if (orders.length === 0) {
              html += `
                  <div class="user-info">
                      <h3>üìù Ë®ÇË≥ºË®òÈåÑ</h3>
                      <p style="text-align: center; color: #666; padding: 20px;">
                          ÁõÆÂâçÂ∞öÁÑ°Ë®ÇË≥ºË®òÈåÑ
                      </p>
                  </div>
              `;
          } else {
              html += `
                  <div class="user-info">
                      <h3>üìù Ë®ÇË≥ºË®òÈåÑ (${orders.length} Á≠Ü)</h3>
                  </div>
                  <div class="order-list">
              `;
              
              orders.forEach(order => {
                  const isPaid = order.paymentStatus === 'Â∑≤Áπ≥Ë≤ª';
                  const statusClass = isPaid ? 'paid' : 'unpaid';
                  const statusText = isPaid ? 'status-paid' : 'status-unpaid';
                  
                  html += `
                      <div class="order-item ${statusClass}">
                          <div class="order-header">
                              <span class="order-number">${order.orderNumber}</span>
                              <span class="order-amount">NT$ ${order.amount.toLocaleString()}</span>
                          </div>
                          <div class="order-details">
                              <div>üì¶ ${order.productInfo}</div>
                              <div>üìÖ Ë®ÇË≥ºÔºö${new Date(order.orderDate).toLocaleDateString('zh-TW')}</div>
                              <div>‚è∞ Âà∞ÊúüÔºö${new Date(order.dueDate).toLocaleDateString('zh-TW')}</div>
                              ${order.paymentDate ? `<div>üí≥ Áπ≥Ë≤ªÔºö${new Date(order.paymentDate).toLocaleDateString('zh-TW')}</div>` : ''}
                              ${order.remarks ? `<div>üìù ${order.remarks}</div>` : ''}
                          </div>
                          <span class="order-status ${statusText}">${order.paymentStatus}</span>
                      </div>
                  `;
              });
              
              html += '</div>';
          }
          
          ordersContent.innerHTML = html;
      }
      
      // Êõ¥Êñ∞Áπ≥Ë≤ªË°®ÂñÆÁöÑË®ÇÂñÆÈÅ∏È†Ö
      function updatePaymentForm(orders) {
          const orderSelect = document.getElementById('orderSelect');
          orderSelect.innerHTML = '<option value="">Ë´ãÈÅ∏ÊìáË¶ÅÂõûÂ†±ÁöÑË®ÇÂñÆ</option>';
          
          // Âè™È°ØÁ§∫Êú™Áπ≥Ë≤ªÁöÑË®ÇÂñÆ
          const unpaidOrders = orders.filter(order => order.paymentStatus !== 'Â∑≤Áπ≥Ë≤ª');
          
          unpaidOrders.forEach(order => {
              const option = document.createElement('option');
              option.value = order.orderNumber;
              option.textContent = `${order.orderNumber} - NT$ ${order.amount.toLocaleString()} - ${order.productInfo}`;
              option.dataset.amount = order.amount;
              orderSelect.appendChild(option);
          });
          
          // Áï∂ÈÅ∏ÊìáË®ÇÂñÆÊôÇËá™ÂãïÂ°´ÂÖ•ÈáëÈ°ç
          orderSelect.addEventListener('change', function() {
              const selectedOption = this.options[this.selectedIndex];
              if (selectedOption.dataset.amount) {
                  document.getElementById('paymentAmount').value = selectedOption.dataset.amount;
              }
          });
      }
      
      // ÂàáÊèõÂàÜÈ†Å
      function switchTab(tabName) {
          // Èö±ËóèÊâÄÊúâÂàÜÈ†ÅÂÖßÂÆπ
          document.querySelectorAll('.tab-content').forEach(tab => {
              tab.classList.remove('active');
          });
          
          // ÁßªÈô§ÊâÄÊúâÊåâÈàïÁöÑ active ÁãÄÊÖã
          document.querySelectorAll('.tab-button').forEach(btn => {
              btn.classList.remove('active');
          });
          
          // È°ØÁ§∫ÈÅ∏‰∏≠ÁöÑÂàÜÈ†Å
          document.getElementById(tabName + '-tab').classList.add('active');
          event.target.classList.add('active');
          
          // Â¶ÇÊûúÊòØË®ÇË≥ºË®òÈåÑÈ†ÅÈù¢ÔºåÈáçÊñ∞ËºâÂÖ•Ë≥áÊñô
          if (tabName === 'orders' && memberData) {
              loadOrdersPage();
          }
      }
      
      // ÂØ¶ÂêçÁôªË®òË°®ÂñÆÊèê‰∫§
      document.getElementById('memberForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          if (!lineProfile) {
              showError('LINE ÁôªÂÖ•Ë≥áÊñô‰∏çÂÆåÊï¥ÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢');
              return;
          }
          
          const formData = new FormData(this);
          const memberInfo = {
              action: 'registerMember',
              lineUserId: lineProfile.userId,
              lineDisplayName: lineProfile.displayName,
              realName: formData.get('realName'),
              doterraId: formData.get('doterraId'),
              referrerName: formData.get('referrerName'),
              phone: formData.get('phone'),
              email: formData.get('email'),
              address: formData.get('address'),
              registerTime: new Date().toISOString()
          };
          
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(memberInfo)
              });
              
              const result = await response.json();
              
              if (result.success) {
                  memberData = memberInfo;
                  showSuccess('ÂØ¶ÂêçÁôªË®òÊàêÂäüÔºÅ');
                  updateUIForMember();
                  switchTab('profile');
              } else {
                  showError('ÁôªË®òÂ§±ÊïóÔºö' + result.message);
              }
              
          } catch (error) {
              console.error('ÂØ¶ÂêçÁôªË®òÂ§±Êïó:', error);
              showError('ÁôªË®òÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
          }
      });
      
      // Áπ≥Ë≤ªÂõûÂ†±Ë°®ÂñÆÊèê‰∫§
      document.getElementById('paymentForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          if (!lineProfile || !memberData) {
              showError('Ë´ãÂÖàÂÆåÊàêÂØ¶ÂêçÁôªË®ò');
              return;
          }
          
          const formData = new FormData(this);
          const paymentInfo = {
              action: 'reportPayment',
              lineUserId: lineProfile.userId,
              lineDisplayName: lineProfile.displayName,
              orderNumber: formData.get('orderSelect'),
              amount: parseInt(formData.get('paymentAmount')),
              paymentMethod: formData.get('paymentMethod'),
              remarks: formData.get('paymentRemarks')
          };
          
          try {
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(paymentInfo)
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showSuccess('Áπ≥Ë≤ªÂõûÂ†±ÊàêÂäüÔºÅ');
                  this.reset();
                  // ÈáçÊñ∞ËºâÂÖ•Ë®ÇË≥ºË®òÈåÑ
                  loadOrdersPage();
              } else {
                  showError('Áπ≥Ë≤ªÂõûÂ†±Â§±ÊïóÔºö' + result.message);
              }
              
          } catch (error) {
              console.error('Áπ≥Ë≤ªÂõûÂ†±Â§±Êïó:', error);
              showError('Áπ≥Ë≤ªÂõûÂ†±Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
          }
      });
      
      // ‰øÆÊîπË≥áÊñô
      function editProfile() {
          switchTab('register');
          showSuccess('Ë´ã‰øÆÊîπË≥áÊñôÂæåÈáçÊñ∞Êèê‰∫§');
      }
      
      // È°ØÁ§∫ÈåØË™§Ë®äÊÅØ
      function showError(message) {
          const existingError = document.querySelector('.error');
          if (existingError) {
              existingError.remove();
          }
          
          const errorDiv = document.createElement('div');
          errorDiv.className = 'error';
          errorDiv.textContent = message;
          
          document.querySelector('.content').insertBefore(errorDiv, document.querySelector('.tab-buttons'));
          
          setTimeout(() => {
              errorDiv.remove();
          }, 5000);
      }
      
      // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
      function showSuccess(message) {
          const existingSuccess = document.querySelector('.success');
          if (existingSuccess) {
              existingSuccess.remove();
          }
          
          const successDiv = document.createElement('div');
          successDiv.className = 'success';
          successDiv.textContent = message;
          
          document.querySelector('.content').insertBefore(successDiv, document.querySelector('.tab-buttons'));
          
          setTimeout(() => {
              successDiv.remove();
          }, 5000);
      }
      
      // È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂæåÂàùÂßãÂåñ LIFF
      window.addEventListener('load', initializeLiff);
  </script>
</body>
</html>
