<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã€å¤šç¦æ°£ã€‘BOGOç®¡ç†è€…ä»‹é¢</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: #f5f5f5;
          color: #333;
      }

      .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 1rem;
          text-align: center;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      .nav-tabs {
          display: flex;
          background: white;
          border-bottom: 1px solid #ddd;
          overflow-x: auto;
      }

      .nav-tab {
          flex: 1;
          min-width: 120px;
          padding: 1rem;
          text-align: center;
          background: white;
          border: none;
          cursor: pointer;
          transition: all 0.3s;
          font-size: 14px;
      }

      .nav-tab.active {
          background: #667eea;
          color: white;
      }

      .nav-tab:hover {
          background: #f0f0f0;
      }

      .nav-tab.active:hover {
          background: #5a6fd8;
      }

      .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 1rem;
      }

      .tab-content {
          display: none;
          background: white;
          border-radius: 8px;
          padding: 1.5rem;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          margin-top: 1rem;
      }

      .tab-content.active {
          display: block;
      }

      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1rem;
          margin-bottom: 2rem;
      }

      .stat-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 1.5rem;
          border-radius: 8px;
          text-align: center;
      }

      .stat-number {
          font-size: 2rem;
          font-weight: bold;
          margin-bottom: 0.5rem;
      }

      .stat-label {
          font-size: 0.9rem;
          opacity: 0.9;
      }

      .search-section {
          background: #f8f9fa;
          padding: 1.5rem;
          border-radius: 8px;
          margin-bottom: 2rem;
      }

      .search-input {
          width: 100%;
          padding: 0.75rem;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 16px;
          margin-bottom: 1rem;
      }

      .search-results {
          display: grid;
          gap: 0.5rem;
      }

      .member-item {
          background: white;
          padding: 1rem;
          border-radius: 4px;
          border: 1px solid #eee;
          cursor: pointer;
          transition: all 0.3s;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .member-item:hover {
          background: #f0f8ff;
          border-color: #667eea;
      }

      .member-info {
          flex: 1;
      }

      .member-name {
          font-weight: bold;
          margin-bottom: 0.25rem;
      }

      .member-details {
          font-size: 0.9rem;
          color: #666;
      }

      .order-badge {
          background: #667eea;
          color: white;
          padding: 0.25rem 0.5rem;
          border-radius: 12px;
          font-size: 0.8rem;
      }

      .table-container {
          overflow-x: auto;
          margin-top: 1rem;
      }

      table {
          width: 100%;
          border-collapse: collapse;
          background: white;
      }

      th, td {
          padding: 0.75rem;
          text-align: left;
          border-bottom: 1px solid #eee;
      }

      th {
          background: #f8f9fa;
          font-weight: bold;
          position: sticky;
          top: 0;
      }

      tr:hover {
          background: #f8f9fa;
      }

      .btn {
          padding: 0.5rem 1rem;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 14px;
          transition: all 0.3s;
          margin: 0.25rem;
      }

      .btn-primary {
          background: #667eea;
          color: white;
      }

      .btn-primary:hover {
          background: #5a6fd8;
      }

      .btn-success {
          background: #28a745;
          color: white;
      }

      .btn-success:hover {
          background: #218838;
      }

      .btn-danger {
          background: #dc3545;
          color: white;
      }

      .btn-danger:hover {
          background: #c82333;
      }

      .btn-warning {
          background: #ffc107;
          color: #212529;
      }

      .btn-warning:hover {
          background: #e0a800;
      }

      .btn-secondary {
          background: #6c757d;
          color: white;
      }

      .btn-secondary:hover {
          background: #5a6268;
      }

      .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
      }

      .modal-content {
          background: white;
          margin: 5% auto;
          padding: 2rem;
          border-radius: 8px;
          width: 90%;
          max-width: 600px;
          max-height: 80vh;
          overflow-y: auto;
      }

      .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
          padding-bottom: 1rem;
          border-bottom: 1px solid #eee;
      }

      .close {
          background: none;
          border: none;
          font-size: 1.5rem;
          cursor: pointer;
          color: #999;
      }

      .close:hover {
          color: #333;
      }

      .form-group {
          margin-bottom: 1rem;
      }

      .form-label {
          display: block;
          margin-bottom: 0.5rem;
          font-weight: bold;
      }

      .form-control {
          width: 100%;
          padding: 0.5rem;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 14px;
      }

      .form-control:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
      }

      .alert {
          padding: 1rem;
          border-radius: 4px;
          margin-bottom: 1rem;
      }

      .alert-success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }

      .alert-danger {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }

      .alert-warning {
          background: #fff3cd;
          color: #856404;
          border: 1px solid #ffeaa7;
      }

      .loading {
          text-align: center;
          padding: 2rem;
          color: #666;
      }

      .spinner {
          border: 3px solid #f3f3f3;
          border-top: 3px solid #667eea;
          border-radius: 50%;
          width: 30px;
          height: 30px;
          animation: spin 1s linear infinite;
          margin: 0 auto 1rem;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .checkbox-group {
          display: flex;
          flex-wrap: wrap;
          gap: 1rem;
          margin: 1rem 0;
      }

      .checkbox-item {
          display: flex;
          align-items: center;
          gap: 0.5rem;
      }

      .status-badge {
          padding: 0.25rem 0.5rem;
          border-radius: 12px;
          font-size: 0.8rem;
          font-weight: bold;
      }

      .status-pending {
          background: #fff3cd;
          color: #856404;
      }

      .status-approved {
          background: #d4edda;
          color: #155724;
      }

      .status-rejected {
          background: #f8d7da;
          color: #721c24;
      }

      .order-summary {
          background: #f8f9fa;
          padding: 1rem;
          border-radius: 4px;
          margin: 1rem 0;
      }

      .summary-row {
          display: flex;
          justify-content: space-between;
          margin-bottom: 0.5rem;
      }

      .summary-total {
          font-weight: bold;
          font-size: 1.1rem;
          border-top: 1px solid #ddd;
          padding-top: 0.5rem;
          margin-top: 0.5rem;
      }

      @media (max-width: 768px) {
          .container {
              padding: 0.5rem;
          }

          .stats-grid {
              grid-template-columns: repeat(2, 1fr);
          }

          .stat-card {
              padding: 1rem;
          }

          .stat-number {
              font-size: 1.5rem;
          }

          .modal-content {
              margin: 2% auto;
              width: 95%;
              padding: 1rem;
          }

          .nav-tab {
              font-size: 12px;
              padding: 0.75rem 0.5rem;
          }
      }
  </style>
</head>
<body>
  <div class="header">
      <h1>ğŸ“Š è¨‚è³¼ç³»çµ±ç®¡ç†ä¸­å¿ƒ</h1>
      <p id="adminInfo">è¼‰å…¥ä¸­...</p>
  </div>

  <div class="nav-tabs">
      <button class="nav-tab active" onclick="showTab('dashboard')">å„€è¡¨æ¿</button>
      <button class="nav-tab" onclick="showTab('payments')">ç¹³è²»å¯©æ ¸</button>
      <button class="nav-tab" onclick="showTab('members')">æœƒå“¡ç®¡ç†</button>
      <button class="nav-tab" onclick="showTab('orders')">è¨‚å–®æŸ¥è©¢</button>
      <button class="nav-tab" onclick="showTab('reports')">å ±è¡¨</button>
      <button class="nav-tab" onclick="showTab('settings')">ç³»çµ±è¨­å®š</button>
  </div>

  <div class="container">
      <!-- å„€è¡¨æ¿ -->
      <div id="dashboard" class="tab-content active">
          <h2>ğŸ“ˆ ç³»çµ±æ¦‚è¦½</h2>
          <div class="stats-grid" id="statsGrid">
              <!-- çµ±è¨ˆå¡ç‰‡å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
          </div>
          
          <div class="alert alert-warning" id="pendingAlert" style="display: none;">
              <strong>âš ï¸ æ³¨æ„ï¼š</strong> <span id="pendingCount">0</span> ç­†ç¹³è²»è¨˜éŒ„å¾…å¯©æ ¸
          </div>
      </div>

      <!-- ç¹³è²»å¯©æ ¸ -->
      <div id="payments" class="tab-content">
          <h2>ğŸ’³ ç¹³è²»å¯©æ ¸</h2>
          
          <div style="margin-bottom: 1rem;">
              <button class="btn btn-primary" onclick="loadPendingPayments()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
              <button class="btn btn-success" onclick="showBatchReview('å·²ç¢ºèª')">âœ… æ‰¹é‡é€šé</button>
              <button class="btn btn-danger" onclick="showBatchReview('å·²æ‹’çµ•')">âŒ æ‰¹é‡æ‹’çµ•</button>
          </div>

          <div class="table-container">
              <table id="paymentsTable">
                  <thead>
                      <tr>
                          <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                          <th>ç¹³è²»ç·¨è™Ÿ</th>
                          <th>æœƒå“¡å§“å</th>
                          <th>ç¹³è²»é‡‘é¡</th>
                          <th>ç¹³è²»æ–¹å¼</th>
                          <th>æäº¤æ™‚é–“</th>
                          <th>ç‹€æ…‹</th>
                          <th>æ“ä½œ</th>
                      </tr>
                  </thead>
                  <tbody id="paymentsTableBody">
                      <!-- è³‡æ–™å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
                  </tbody>
              </table>
          </div>
      </div>

      <!-- æœƒå“¡ç®¡ç† -->
      <div id="members" class="tab-content">
          <h2>ğŸ‘¥ æœƒå“¡ç®¡ç†</h2>
          
          <div class="table-container">
              <table id="membersTable">
                  <thead>
                      <tr>
                          <th>LINEåç¨±</th>
                          <th>çœŸå¯¦å§“å</th>
                          <th>è¨»å†Šæ™‚é–“</th>
                          <th>è¨‚å–®æ•¸é‡</th>
                          <th>ç¹³è²»æ¬¡æ•¸</th>
                          <th>ç‹€æ…‹</th>
                      </tr>
                  </thead>
                  <tbody id="membersTableBody">
                      <!-- è³‡æ–™å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
                  </tbody>
              </table>
          </div>
      </div>

      <!-- è¨‚å–®æŸ¥è©¢ -->
      <div id="orders" class="tab-content">
          <h2>ğŸ›’ è¨‚å–®æŸ¥è©¢èˆ‡ç®¡ç†</h2>
          
          <div class="search-section">
              <h3>ğŸ” æœå°‹æœƒå“¡</h3>
              <input type="text" id="memberSearch" class="search-input" 
                     placeholder="è¼¸å…¥ LINE åç¨±æˆ–çœŸå¯¦å§“åé€²è¡Œæœå°‹..." 
                     onkeyup="searchMembers(event)">
              
              <div id="searchResults" class="search-results">
                  <!-- æœå°‹çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
              </div>
          </div>

          <div id="memberOrdersSection" style="display: none;">
              <div class="modal-header">
                  <h3 id="selectedMemberName">æœƒå“¡è¨‚å–®</h3>
                  <button class="btn btn-primary" onclick="addNewOrder()">â• æ–°å¢è¨‚å–®</button>
              </div>

              <div id="memberInfo" class="order-summary">
                  <!-- æœƒå“¡è³‡è¨Šå°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
              </div>

              <div class="table-container">
                  <table id="memberOrdersTable">
                      <thead>
                          <tr>
                              <th>ç”¢å“ä»£è™Ÿ</th>
                              <th>ç”¢å“åç¨±</th>
                              <th>æ•¸é‡</th>
                              <th>å–®åƒ¹</th>
                              <th>åˆè¨ˆ</th>
                              <th>æ“ä½œ</th>
                          </tr>
                      </thead>
                      <tbody id="memberOrdersTableBody">
                          <!-- è¨‚å–®è³‡æ–™å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                      </tbody>
                  </table>
              </div>

              <div id="orderSummary" class="order-summary">
                  <!-- è¨‚å–®æ‘˜è¦å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
              </div>

              <div id="paymentHistory" style="margin-top: 2rem;">
                  <h4>ğŸ’° ç¹³è²»è¨˜éŒ„</h4>
                  <div class="table-container">
                      <table id="paymentHistoryTable">
                          <thead>
                              <tr>
                                  <th>ç¹³è²»ç·¨è™Ÿ</th>
                                  <th>ç¹³è²»é‡‘é¡</th>
                                  <th>ç¹³è²»æ–¹å¼</th>
                                  <th>æäº¤æ™‚é–“</th>
                                  <th>ç‹€æ…‹</th>
                              </tr>
                          </thead>
                          <tbody id="paymentHistoryTableBody">
                              <!-- ç¹³è²»è¨˜éŒ„å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      </div>

      <!-- å ±è¡¨ -->
      <div id="reports" class="tab-content">
          <h2>ğŸ“Š å ±è¡¨ä¸­å¿ƒ</h2>
          
          <div style="margin-bottom: 2rem;">
              <div class="form-group">
                  <label class="form-label">é¸æ“‡æ—¥æœŸï¼š</label>
                  <input type="date" id="reportDate" class="form-control" style="width: auto; display: inline-block;">
                  <button class="btn btn-primary" onclick="generateDailyReport()">ğŸ“ˆ ç”Ÿæˆæ—¥å ±è¡¨</button>
              </div>
          </div>

          <div id="reportContent">
              <!-- å ±è¡¨å…§å®¹å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
          </div>

          <div style="margin-top: 2rem;">
              <button class="btn btn-secondary" onclick="exportAllData()">ğŸ“¤ åŒ¯å‡ºæ‰€æœ‰è³‡æ–™</button>
              <button class="btn btn-warning" onclick="cleanupTestData()">ğŸ§¹ æ¸…ç†æ¸¬è©¦è³‡æ–™</button>
          </div>
      </div>

      <!-- ç³»çµ±è¨­å®š -->
      <div id="settings" class="tab-content">
          <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>
          
          <div style="margin-bottom: 2rem;">
              <h3>ğŸ”§ ç³»çµ±ç¶­è­·</h3>
              <button class="btn btn-primary" onclick="initializeSystem()">ğŸš€ åˆå§‹åŒ–ç³»çµ±</button>
              <button class="btn btn-secondary" onclick="setupTriggers()">â° è¨­å®šè§¸ç™¼å™¨</button>
              <button class="btn btn-warning" onclick="cleanupOldLogs()">ğŸ—‘ï¸ æ¸…ç†èˆŠæ—¥èªŒ</button>
              <button class="btn btn-success" onclick="checkSystemHealth()">ğŸ¥ ç³»çµ±å¥åº·æª¢æŸ¥</button>
          </div>

          <div>
              <h3>ğŸ’¾ è³‡æ–™å‚™ä»½</h3>
              <div class="form-group">
                  <label class="form-label">å‚™ä»½è©¦ç®—è¡¨ IDï¼š</label>
                  <input type="text" id="backupSpreadsheetId" class="form-control" 
                         placeholder="è«‹è¼¸å…¥ç›®æ¨™è©¦ç®—è¡¨çš„ ID">
                  <button class="btn btn-primary" onclick="backupData()" style="margin-top: 0.5rem;">
                      ğŸ’¾ é–‹å§‹å‚™ä»½
                  </button>
              </div>
          </div>

          <div id="systemStatus" style="margin-top: 2rem;">
              <!-- ç³»çµ±ç‹€æ…‹å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
          </div>
      </div>
  </div>

  <!-- å¯©æ ¸æ¨¡æ…‹æ¡† -->
  <div id="reviewModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>å¯©æ ¸ç¹³è²»è¨˜éŒ„</h3>
              <button class="close" onclick="closeModal('reviewModal')">&times;</button>
          </div>
          
          <div id="reviewPaymentInfo">
              <!-- ç¹³è²»è³‡è¨Šå°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
          </div>
          
          <div class="form-group">
              <label class="form-label">å¯©æ ¸çµæœï¼š</label>
              <select id="reviewStatus" class="form-control">
                  <option value="å·²ç¢ºèª">âœ… é€šé</option>
                  <option value="å·²æ‹’çµ•">âŒ æ‹’çµ•</option>
              </select>
          </div>
          
          <div class="form-group">
              <label class="form-label">å¯©æ ¸å‚™è¨»ï¼š</label>
              <textarea id="reviewNote" class="form-control" rows="3" 
                        placeholder="è«‹è¼¸å…¥å¯©æ ¸å‚™è¨»..."></textarea>
          </div>
          
          <div style="text-align: right;">
              <button class="btn btn-secondary" onclick="closeModal('reviewModal')">å–æ¶ˆ</button>
              <button class="btn btn-primary" onclick="submitReview()">ç¢ºèªå¯©æ ¸</button>
          </div>
      </div>
  </div>

  <!-- æ‰¹é‡å¯©æ ¸æ¨¡æ…‹æ¡† -->
  <div id="batchReviewModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>æ‰¹é‡å¯©æ ¸</h3>
              <button class="close" onclick="closeModal('batchReviewModal')">&times;</button>
          </div>
          
          <div id="batchReviewInfo">
              <!-- æ‰¹é‡å¯©æ ¸è³‡è¨Šå°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
          </div>
          
          <div class="form-group">
              <label class="form-label">å¯©æ ¸å‚™è¨»ï¼š</label>
              <textarea id="batchReviewNote" class="form-control" rows="3" 
                        placeholder="è«‹è¼¸å…¥å¯©æ ¸å‚™è¨»..."></textarea>
          </div>
          
          <div style="text-align: right;">
              <button class="btn btn-secondary" onclick="closeModal('batchReviewModal')">å–æ¶ˆ</button>
              <button class="btn btn-primary" onclick="submitBatchReview()">ç¢ºèªæ‰¹é‡å¯©æ ¸</button>
          </div>
      </div>
  </div>

  <!-- ç·¨è¼¯è¨‚å–®æ¨¡æ…‹æ¡† -->
  <div id="editOrderModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="editOrderTitle">ç·¨è¼¯è¨‚å–®</h3>
              <button class="close" onclick="closeModal('editOrderModal')">&times;</button>
          </div>
          
          <div class="form-group">
              <label class="form-label">LINEåç¨±ï¼š</label>
              <input type="text" id="editLineName" class="form-control">
          </div>
          
          <div class="form-group">
              <label class="form-label">ç”¢å“ä»£è™Ÿï¼š</label>
              <input type="text" id="editProductCode" class="form-control">
          </div>
          
          <div class="form-group">
              <label class="form-label">ç”¢å“åç¨±ï¼š</label>
              <input type="text" id="editProductName" class="form-control">
          </div>
          
          <div class="form-group">
              <label class="form-label">æ•¸é‡ï¼š</label>
              <input type="number" id="editQuantity" class="form-control" min="1" onchange="calculateTotal()">
          </div>
          
          <div class="form-group">
              <label class="form-label">å–®åƒ¹ï¼š</label>
              <input type="number" id="editUnitPrice" class="form-control" min="0" step="0.01" onchange="calculateTotal()">
          </div>
          
          <div class="form-group">
              <label class="form-label">åˆè¨ˆï¼š</label>
              <input type="number" id="editTotalPrice" class="form-control" readonly>
          </div>
          
          <div style="text-align: right;">
              <button class="btn btn-secondary" onclick="closeModal('editOrderModal')">å–æ¶ˆ</button>
              <button class="btn btn-primary" onclick="saveOrder()">å„²å­˜</button>
          </div>
      </div>
  </div>

  <script>
      // è¨­å®šå€åŸŸ
      const CONFIG = {
          LIFF_ID: '1657285806-2bmkYWkN', // è«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID
          API_BASE_URL: 'https://script.google.com/macros/s/AKfycbz9D6796MX0xyZ6owz03Fz_Mz44zkKuK6Z8CCTukkWMsl53DlBIy-5yICLifgYPX0Mi/exec' // è«‹æ›¿æ›ç‚ºæ‚¨çš„ GAS Web App URL
      };

      // å…¨åŸŸè®Šæ•¸
      let currentUser = null;
      let currentPaymentId = null;
      let currentRowIndex = null;
      let selectedPaymentIds = [];
      let batchReviewStatus = '';
      let currentMemberName = '';

      // LIFF åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', function() {
          liff.init({
              liffId: CONFIG.LIFF_ID
          }).then(() => {
              if (liff.isLoggedIn()) {
                  liff.getProfile().then(profile => {
                      currentUser = {
                          userId: profile.userId,
                          displayName: profile.displayName
                      };
                      
                      document.getElementById('adminInfo').textContent = 
                          `ç®¡ç†è€…ï¼š${profile.displayName}`;
                      
                      // è¼‰å…¥åˆå§‹è³‡æ–™
                      loadDashboard();
                      loadPendingPayments();
                      loadAllMembers();
                  });
              } else {
                  liff.login();
              }
          }).catch(err => {
              console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', err);
              alert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢');
          });
      });

      // API å‘¼å«å‡½æ•¸
      function callAPI(action, data = {}) {
          return new Promise((resolve, reject) => {
              data.adminUserId = currentUser ? currentUser.userId : '';
              
              const url = `${CONFIG.API_BASE_URL}?action=${action}&data=${encodeURIComponent(JSON.stringify(data))}`;
              
              fetch(url)
                  .then(response => response.json())
                  .then(result => {
                      if (result.success) {
                          resolve(result);
                      } else {
                          reject(new Error(result.message || 'æ“ä½œå¤±æ•—'));
                      }
                  })
                  .catch(error => {
                      reject(error);
                  });
          });
      }

      // æ¨™ç±¤åˆ‡æ›
      function showTab(tabName) {
          // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
          document.querySelectorAll('.tab-content').forEach(tab => {
              tab.classList.remove('active');
          });
          
          // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„ active ç‹€æ…‹
          document.querySelectorAll('.nav-tab').forEach(tab => {
              tab.classList.remove('active');
          });
          
          // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
          document.getElementById(tabName).classList.add('active');
          
          // è¨­å®šé¸ä¸­çš„æ¨™ç±¤ç‚º active
          event.target.classList.add('active');
          
          // è¼‰å…¥å°æ‡‰çš„è³‡æ–™
          switch(tabName) {
              case 'dashboard':
                  loadDashboard();
                  break;
              case 'payments':
                  loadPendingPayments();
                  break;
              case 'members':
                  loadAllMembers();
                  break;
              case 'reports':
                  // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
                  document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
                  break;
          }
      }

      // è¼‰å…¥å„€è¡¨æ¿
      function loadDashboard() {
          callAPI('admin-get-statistics')
              .then(result => {
                  const stats = result.statistics;
                  const statsGrid = document.getElementById('statsGrid');
                  
                  statsGrid.innerHTML = `
                      <div class="stat-card">
                          <div class="stat-number">${stats.totalUsers}</div>
                          <div class="stat-label">è¨»å†Šæœƒå“¡</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${stats.totalOrders}</div>
                          <div class="stat-label">ç¸½è¨‚å–®æ•¸</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${stats.totalPayments}</div>
                          <div class="stat-label">ç¹³è²»è¨˜éŒ„</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${stats.pendingPayments}</div>
                          <div class="stat-label">å¾…å¯©æ ¸</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${stats.approvedPayments}</div>
                          <div class="stat-label">å·²ç¢ºèª</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">NT$ ${stats.totalAmount.toLocaleString()}</div>
                          <div class="stat-label">ç¸½é‡‘é¡</div>
                      </div>
                  `;
                  
                  // é¡¯ç¤ºå¾…å¯©æ ¸æé†’
                  const pendingAlert = document.getElementById('pendingAlert');
                  const pendingCount = document.getElementById('pendingCount');
                  
                  if (stats.pendingPayments > 0) {
                      pendingCount.textContent = stats.pendingPayments;
                      pendingAlert.style.display = 'block';
                  } else {
                      pendingAlert.style.display = 'none';
                  }
              })
              .catch(error => {
                  console.error('è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—:', error);
                  showAlert('è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // è¼‰å…¥å¾…å¯©æ ¸ç¹³è²»
      function loadPendingPayments() {
          const tbody = document.getElementById('paymentsTableBody');
          tbody.innerHTML = '<tr><td colspan="8" class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­...</td></tr>';
          
          callAPI('admin-get-pending-payments')
              .then(result => {
                  const payments = result.payments;
                  
                  if (payments.length === 0) {
                      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">æš«ç„¡å¾…å¯©æ ¸è¨˜éŒ„</td></tr>';
                      return;
                  }
                  
                  tbody.innerHTML = payments.map(payment => `
                      <tr>
                          <td><input type="checkbox" class="payment-checkbox" value="${payment.paymentId}"></td>
                          <td>${payment.paymentId}</td>
                          <td>${payment.realName}</td>
                          <td>NT$ ${payment.paymentAmount.toLocaleString()}</td>
                          <td>${payment.paymentMethod}</td>
                          <td>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</td>
                          <td><span class="status-badge status-pending">${payment.status}</span></td>
                          <td>
                              <button class="btn btn-primary" onclick="showReviewModal('${payment.paymentId}')">å¯©æ ¸</button>
                          </td>
                      </tr>
                  `).join('');
              })
              .catch(error => {
                  console.error('è¼‰å…¥å¾…å¯©æ ¸ç¹³è²»å¤±æ•—:', error);
                  tbody.innerHTML = `<tr><td colspan="8" class="alert alert-danger">è¼‰å…¥å¤±æ•—: ${error.message}</td></tr>`;
              });
      }

      // è¼‰å…¥æ‰€æœ‰æœƒå“¡
      function loadAllMembers() {
          const tbody = document.getElementById('membersTableBody');
          tbody.innerHTML = '<tr><td colspan="6" class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­...</td></tr>';
          
          callAPI('admin-get-users')
              .then(result => {
                  const users = result.users;
                  
                  if (users.length === 0) {
                      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">æš«ç„¡æœƒå“¡è³‡æ–™</td></tr>';
                      return;
                  }
                  
                  tbody.innerHTML = users.map(user => `
                      <tr>
                          <td>${user.lineDisplayName}</td>
                          <td>${user.realName}</td>
                          <td>${new Date(user.registeredAt).toLocaleDateString('zh-TW')}</td>
                          <td>${user.orderCount}</td>
                          <td>${user.paymentCount}</td>
                          <td><span class="status-badge status-approved">${user.status}</span></td>
                      </tr>
                  `).join('');
              })
              .catch(error => {
                  console.error('è¼‰å…¥æœƒå“¡è³‡æ–™å¤±æ•—:', error);
                  tbody.innerHTML = `<tr><td colspan="6" class="alert alert-danger">è¼‰å…¥å¤±æ•—: ${error.message}</td></tr>`;
              });
      }

      // æœå°‹æœƒå“¡
      function searchMembers(event) {
          const keyword = event.target.value.trim();
          const resultsDiv = document.getElementById('searchResults');
          
          if (keyword.length < 2) {
              resultsDiv.innerHTML = '';
              return;
          }
          
          if (event.key === 'Enter' || event.type === 'input') {
              callAPI('admin-search-members', { keyword: keyword })
                  .then(result => {
                      const members = result.members;
                      
                      if (members.length === 0) {
                          resultsDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">æ‰¾ä¸åˆ°ç›¸é—œæœƒå“¡</div>';
                          return;
                      }
                      
                      resultsDiv.innerHTML = members.map(member => `
                          <div class="member-item" onclick="selectMember('${member.lineName}')">
                              <div class="member-info">
                                  <div class="member-name">${member.lineName}</div>
                                  <div class="member-details">
                                      çœŸå¯¦å§“å: ${member.realName} | 
                                      ${member.registeredAt ? 'å·²è¨»å†Š (' + new Date(member.registeredAt).toLocaleDateString('zh-TW') + ')' : 'æœªè¨»å†Š'}
                                  </div>
                              </div>
                              <div class="order-badge">${member.orderCount} ç­†è¨‚å–®</div>
                          </div>
                      `).join('');
                  })
                  .catch(error => {
                      console.error('æœå°‹æœƒå“¡å¤±æ•—:', error);
                      resultsDiv.innerHTML = `<div class="alert alert-danger">æœå°‹å¤±æ•—: ${error.message}</div>`;
                  });
          }
      }

      // é¸æ“‡æœƒå“¡
      function selectMember(lineName) {
          currentMemberName = lineName;
          document.getElementById('selectedMemberName').textContent = `${lineName} çš„è¨‚å–®`;
          
          loadMemberOrders(lineName);
          
          // éš±è—æœå°‹çµæœï¼Œé¡¯ç¤ºè¨‚å–®å€åŸŸ
          document.getElementById('searchResults').innerHTML = '';
          document.getElementById('memberOrdersSection').style.display = 'block';
      }

      // // è¼‰å…¥æœƒå“¡è¨‚å–®
      // function loadMemberOrders(lineName) {
      //     callAPI('admin-get-member-orders', { lineName: lineName })
      //         .then(result => {
      //             const { memberInfo, orders, payments, summary } = result;
                  
      //             // é¡¯ç¤ºæœƒå“¡è³‡è¨Š
      //             const memberInfoDiv = document.getElementById('memberInfo');
      //             memberInfoDiv.innerHTML = `
      //                 <div class="summary-row">
      //                     <span>æœƒå“¡å§“å:</span>
      //                     <span>${memberInfo ? memberInfo.realName : 'æœªè¨»å†Š'}</span>
      //                 </div>
      //                 <div class="summary-row">
      //                     <span>LINEåç¨±:</span>
      //                     <span>${lineName}</span>
      //                 </div>
      //                 ${memberInfo ? `
      //                 <div class="summary-row">
      //                     <span>è¨»å†Šæ™‚é–“:</span>
      //                     <span>${new Date(memberInfo.registeredAt).toLocaleString('zh-TW')}</span>
      //                 </div>
      //                 ` : ''}
      //             `;
                  
      //             // é¡¯ç¤ºè¨‚å–®åˆ—è¡¨
      //             const tbody = document.getElementById('memberOrdersTableBody');
      //             if (orders.length === 0) {
      //                 tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">æš«ç„¡è¨‚å–®è¨˜éŒ„</td></tr>';
      //             } else {
      //                 tbody.innerHTML = orders.map(order => `
      //                     <tr>
      //                         <td>${order.productCode}</td>
      //                         <td>${order.productName}</td>
      //                         <td>${order.quantity}</td>
      //                         <td>NT$ ${parseFloat(order.unitPrice).toLocaleString()}</td>
      //                         <td>NT$ ${parseFloat(order.totalPrice).toLocaleString()}</td>
      //                         <td>
      //                             <button class="btn btn-warning" onclick="editOrder(${order.rowIndex})">ç·¨è¼¯</button>
      //                             <button class="btn btn-danger" onclick="deleteOrder(${order.rowIndex})">åˆªé™¤</button>
      //                         </td>
      //                     </tr>
      //                 `).join('');
      //             }
                  
      //             // é¡¯ç¤ºè¨‚å–®æ‘˜è¦
      //             const summaryDiv = document.getElementById('orderSummary');
      //             summaryDiv.innerHTML = `
      //                 <div class="summary-row">
      //                     <span>è¨‚å–®é …ç›®:</span>
      //                     <span>${summary.orderCount} é …</span>
      //                 </div>
      //                 <div class="summary-row summary-total">
      //                     <span>ç¸½é‡‘é¡:</span>
      //                     <span>NT$ ${summary.totalAmount.toLocaleString()}</span>
      //                 </div>
      //             `;
                  
      //             // é¡¯ç¤ºç¹³è²»è¨˜éŒ„
      //             const paymentTbody = document.getElementById('paymentHistoryTableBody');
      //             if (payments.length === 0) {
      //                 paymentTbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">æš«ç„¡ç¹³è²»è¨˜éŒ„</td></tr>';
      //             } else {
      //                 paymentTbody.innerHTML = payments.map(payment => `
      //                     <tr>
      //                         <td>${payment.paymentId}</td>
      //                         <td>NT$ ${parseFloat(payment.paymentAmount).toLocaleString()}</td>
      //                         <td>${payment.paymentMethod}</td>
      //                         <td>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</td>
      //                         <td><span class="status-badge status-${payment.status === 'å·²ç¢ºèª' ? 'approved' : payment.status === 'å·²æ‹’çµ•' ? 'rejected' : 'pending'}">${payment.status}</span></td>
      //                     </tr>
      //                 `).join('');
      //             }
      //         })
      //         .catch(error => {
      //             console.error('è¼‰å…¥æœƒå“¡è¨‚å–®å¤±æ•—:', error);
      //             showAlert('è¼‰å…¥æœƒå“¡è¨‚å–®å¤±æ•—: ' + error.message, 'danger');
      //         });
      // }

      // ç·¨è¼¯è¨‚å–®
      function editOrder(rowIndex) {
          currentRowIndex = rowIndex;
          
          // å–å¾—ç•¶å‰è¨‚å–®è³‡æ–™
          const row = document.querySelector(`#memberOrdersTableBody tr:nth-child(${rowIndex - 1})`);
          if (!row) return;
          
          const cells = row.cells;
          document.getElementById('editLineName').value = currentMemberName;
          document.getElementById('editProductCode').value = cells[0].textContent;
          document.getElementById('editProductName').value = cells[1].textContent;
          document.getElementById('editQuantity').value = cells[2].textContent;
          document.getElementById('editUnitPrice').value = cells[3].textContent.replace('NT$ ', '').replace(/,/g, '');
          document.getElementById('editTotalPrice').value = cells[4].textContent.replace('NT$ ', '').replace(/,/g, '');
          
          document.getElementById('editOrderTitle').textContent = 'ç·¨è¼¯è¨‚å–®';
          document.getElementById('editOrderModal').style.display = 'block';
      }

      // æ–°å¢è¨‚å–®
      function addNewOrder() {
          currentRowIndex = null;
          
          document.getElementById('editLineName').value = currentMemberName;
          document.getElementById('editProductCode').value = '';
          document.getElementById('editProductName').value = '';
          document.getElementById('editQuantity').value = '1';
          document.getElementById('editUnitPrice').value = '0';
          document.getElementById('editTotalPrice').value = '0';
          
          document.getElementById('editOrderTitle').textContent = 'æ–°å¢è¨‚å–®';
          document.getElementById('editOrderModal').style.display = 'block';
      }

      // è¨ˆç®—ç¸½åƒ¹
      function calculateTotal() {
          const quantity = parseFloat(document.getElementById('editQuantity').value) || 0;
          const unitPrice = parseFloat(document.getElementById('editUnitPrice').value) || 0;
          const total = quantity * unitPrice;
          document.getElementById('editTotalPrice').value = total.toFixed(2);
      }

      // å„²å­˜è¨‚å–®
      function saveOrder() {
          const orderData = {
              lineName: document.getElementById('editLineName').value,
              productCode: document.getElementById('editProductCode').value,
              productName: document.getElementById('editProductName').value,
              quantity: parseFloat(document.getElementById('editQuantity').value),
              unitPrice: parseFloat(document.getElementById('editUnitPrice').value)
          };
          
          if (!orderData.lineName || !orderData.productCode || !orderData.productName || 
              !orderData.quantity || !orderData.unitPrice) {
              showAlert('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½', 'warning');
              return;
          }
          
          const action = currentRowIndex ? 'admin-update-member-order' : 'admin-add-member-order';
          const data = currentRowIndex ? 
              { rowIndex: currentRowIndex, orderData: orderData } : 
              { orderData: orderData };
          
          callAPI(action, data)
              .then(result => {
                  showAlert(result.message, 'success');
                  closeModal('editOrderModal');
                  loadMemberOrders(currentMemberName);
              })
              .catch(error => {
                  console.error('å„²å­˜è¨‚å–®å¤±æ•—:', error);
                  showAlert('å„²å­˜è¨‚å–®å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // åˆªé™¤è¨‚å–®
      function deleteOrder(rowIndex) {
          if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ')) return;
          
          callAPI('admin-delete-member-order', { rowIndex: rowIndex })
              .then(result => {
                  showAlert(result.message, 'success');
                  loadMemberOrders(currentMemberName);
              })
              .catch(error => {
                  console.error('åˆªé™¤è¨‚å–®å¤±æ•—:', error);
                  showAlert('åˆªé™¤è¨‚å–®å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // é¡¯ç¤ºå¯©æ ¸æ¨¡æ…‹æ¡†
      function showReviewModal(paymentId) {
          currentPaymentId = paymentId;
          
          // å–å¾—ç¹³è²»è©³ç´°è³‡è¨Š
          callAPI('admin-get-all-payments')
              .then(result => {
                  const payment = result.payments.find(p => p.paymentId === paymentId);
                  if (!payment) {
                      showAlert('æ‰¾ä¸åˆ°ç¹³è²»è¨˜éŒ„', 'danger');
                      return;
                  }
                  
                  document.getElementById('reviewPaymentInfo').innerHTML = `
                      <div class="order-summary">
                          <div class="summary-row">
                              <span>ç¹³è²»ç·¨è™Ÿ:</span>
                              <span>${payment.paymentId}</span>
                          </div>
                          <div class="summary-row">
                              <span>æœƒå“¡å§“å:</span>
                              <span>${payment.realName}</span>
                          </div>
                          <div class="summary-row">
                              <span>ç¹³è²»é‡‘é¡:</span>
                              <span>NT$ ${parseFloat(payment.paymentAmount).toLocaleString()}</span>
                          </div>
                          <div class="summary-row">
                              <span>ç¹³è²»æ–¹å¼:</span>
                              <span>${payment.paymentMethod}</span>
                          </div>
                          <div class="summary-row">
                              <span>æäº¤æ™‚é–“:</span>
                              <span>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</span>
                          </div>
                          ${payment.paymentNote ? `
                          <div class="summary-row">
                              <span>ç”¨æˆ¶å‚™è¨»:</span>
                              <span>${payment.paymentNote}</span>
                          </div>
                          ` : ''}
                      </div>
                  `;
                  
                  document.getElementById('reviewStatus').value = 'å·²ç¢ºèª';
                  document.getElementById('reviewNote').value = '';
                  document.getElementById('reviewModal').style.display = 'block';
              })
              .catch(error => {
                  console.error('è¼‰å…¥ç¹³è²»è©³æƒ…å¤±æ•—:', error);
                  showAlert('è¼‰å…¥ç¹³è²»è©³æƒ…å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // æäº¤å¯©æ ¸
      function submitReview() {
          const status = document.getElementById('reviewStatus').value;
          const reviewNote = document.getElementById('reviewNote').value;
          
          callAPI('admin-review-payment', {
              paymentId: currentPaymentId,
              status: status,
              reviewNote: reviewNote
          })
              .then(result => {
                  showAlert(result.message, 'success');
                  closeModal('reviewModal');
                  loadPendingPayments();
                  loadDashboard();
              })
              .catch(error => {
                  console.error('å¯©æ ¸å¤±æ•—:', error);
                  showAlert('å¯©æ ¸å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // å…¨é¸/å–æ¶ˆå…¨é¸
      function toggleSelectAll() {
          const selectAll = document.getElementById('selectAll');
          const checkboxes = document.querySelectorAll('.payment-checkbox');
          
          checkboxes.forEach(checkbox => {
              checkbox.checked = selectAll.checked;
          });
          
          updateSelectedPayments();
      }

      // æ›´æ–°é¸ä¸­çš„ç¹³è²»è¨˜éŒ„
      function updateSelectedPayments() {
          selectedPaymentIds = Array.from(document.querySelectorAll('.payment-checkbox:checked'))
              .map(checkbox => checkbox.value);
      }

      // é¡¯ç¤ºæ‰¹é‡å¯©æ ¸
      function showBatchReview(status) {
          updateSelectedPayments();
          
          if (selectedPaymentIds.length === 0) {
              showAlert('è«‹å…ˆé¸æ“‡è¦å¯©æ ¸çš„è¨˜éŒ„', 'warning');
              return;
          }
          
          batchReviewStatus = status;
          
          document.getElementById('batchReviewInfo').innerHTML = `
              <div class="alert alert-warning">
                  <strong>æ‰¹é‡å¯©æ ¸ç¢ºèª</strong><br>
                  æ‚¨å³å°‡å°‡ <strong>${selectedPaymentIds.length}</strong> ç­†ç¹³è²»è¨˜éŒ„æ¨™è¨˜ç‚º <strong>${status}</strong>
              </div>
          `;
          
          document.getElementById('batchReviewNote').value = '';
          document.getElementById('batchReviewModal').style.display = 'block';
      }

      // æäº¤æ‰¹é‡å¯©æ ¸
      function submitBatchReview() {
          const reviewNote = document.getElementById('batchReviewNote').value;
          
          callAPI('admin-batch-review', {
              paymentIds: selectedPaymentIds,
              status: batchReviewStatus,
              reviewNote: reviewNote
          })
              .then(result => {
                  showAlert(result.message, 'success');
                  closeModal('batchReviewModal');
                  loadPendingPayments();
                  loadDashboard();
                  
                  // æ¸…é™¤é¸æ“‡
                  document.getElementById('selectAll').checked = false;
                  selectedPaymentIds = [];
              })
              .catch(error => {
                  console.error('æ‰¹é‡å¯©æ ¸å¤±æ•—:', error);
                  showAlert('æ‰¹é‡å¯©æ ¸å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // ç”Ÿæˆæ—¥å ±è¡¨
      function generateDailyReport() {
          const targetDate = document.getElementById('reportDate').value;
          if (!targetDate) {
              showAlert('è«‹é¸æ“‡æ—¥æœŸ', 'warning');
              return;
          }
          
          const reportContent = document.getElementById('reportContent');
          reportContent.innerHTML = '<div class="loading"><div class="spinner"></div>ç”Ÿæˆå ±è¡¨ä¸­...</div>';
          
          callAPI('admin-get-daily-report', { targetDate: targetDate })
              .then(result => {
                  const report = result.report;
                  
                  reportContent.innerHTML = `
                      <div class="order-summary">
                          <h3>ğŸ“… ${report.date} æ—¥å ±è¡¨</h3>
                          
                          <div class="stats-grid" style="margin: 1rem 0;">
                              <div class="stat-card">
                                  <div class="stat-number">${report.newRegistrations}</div>
                                  <div class="stat-label">æ–°è¨»å†Šæœƒå“¡</div>
                              </div>
                              <div class="stat-card">
                                  <div class="stat-number">${report.newPayments}</div>
                                  <div class="stat-label">æ–°ç¹³è²»è¨˜éŒ„</div>
                              </div>
                              <div class="stat-card">
                                  <div class="stat-number">${report.approvedPayments}</div>
                                  <div class="stat-label">å¯©æ ¸é€šé</div>
                              </div>
                              <div class="stat-card">
                                  <div class="stat-number">NT$ ${report.totalAmount.toLocaleString()}</div>
                                  <div class="stat-label">ç¢ºèªé‡‘é¡</div>
                              </div>
                          </div>
                          
                          ${report.details.registrations.length > 0 ? `
                          <h4>ğŸ†• æ–°è¨»å†Šæœƒå“¡</h4>
                          <div class="table-container">
                              <table>
                                  <thead>
                                      <tr><th>çœŸå¯¦å§“å</th><th>LINEåç¨±</th><th>è¨»å†Šæ™‚é–“</th></tr>
                                  </thead>
                                  <tbody>
                                      ${report.details.registrations.map(reg => `
                                          <tr>
                                              <td>${reg.realName}</td>
                                              <td>${reg.lineDisplayName}</td>
                                              <td>${new Date(reg.registeredAt).toLocaleString('zh-TW')}</td>
                                          </tr>
                                      `).join('')}
                                  </tbody>
                              </table>
                          </div>
                          ` : ''}
                          
                          ${report.details.approvedPayments.length > 0 ? `
                          <h4>âœ… å¯©æ ¸é€šéç¹³è²»</h4>
                          <div class="table-container">
                              <table>
                                  <thead>
                                      <tr><th>ç¹³è²»ç·¨è™Ÿ</th><th>æœƒå“¡å§“å</th><th>é‡‘é¡</th></tr>
                                  </thead>
                                  <tbody>
                                      ${report.details.approvedPayments.map(payment => `
                                          <tr>
                                              <td>${payment.paymentId}</td>
                                              <td>${payment.realName}</td>
                                              <td>NT$ ${parseFloat(payment.paymentAmount).toLocaleString()}</td>
                                          </tr>
                                      `).join('')}
                                  </tbody>
                              </table>
                          </div>
                          ` : ''}
                      </div>
                  `;
              })
              .catch(error => {
                  console.error('ç”Ÿæˆæ—¥å ±è¡¨å¤±æ•—:', error);
                  reportContent.innerHTML = `<div class="alert alert-danger">ç”Ÿæˆå ±è¡¨å¤±æ•—: ${error.message}</div>`;
              });
      }

      // åŒ¯å‡ºæ‰€æœ‰è³‡æ–™
      function exportAllData() {
          callAPI('admin-export-data')
              .then(result => {
                  const dataStr = JSON.stringify(result.data, null, 2);
                  const dataBlob = new Blob([dataStr], {type: 'application/json'});
                  const url = URL.createObjectURL(dataBlob);
                  const link = document.createElement('a');
                  link.href = url;
                  link.download = `system_export_${new Date().toISOString().split('T')[0]}.json`;
                  link.click();
                  URL.revokeObjectURL(url);
                  
                  showAlert('è³‡æ–™åŒ¯å‡ºæˆåŠŸ', 'success');
              })
              .catch(error => {
                  console.error('åŒ¯å‡ºè³‡æ–™å¤±æ•—:', error);
                  showAlert('åŒ¯å‡ºè³‡æ–™å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // æ¸…ç†æ¸¬è©¦è³‡æ–™
      function cleanupTestData() {
          if (!confirm('ç¢ºå®šè¦æ¸…ç†æ‰€æœ‰æ¸¬è©¦è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
          
          callAPI('admin-cleanup-test-data')
              .then(result => {
                  showAlert(result.message, 'success');
                  loadDashboard();
              })
              .catch(error => {
                  console.error('æ¸…ç†æ¸¬è©¦è³‡æ–™å¤±æ•—:', error);
                  showAlert('æ¸…ç†æ¸¬è©¦è³‡æ–™å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // ç³»çµ±ç¶­è­·åŠŸèƒ½
      function initializeSystem() {
          callAPI('admin-initialize-system')
              .then(result => {
                  showAlert(result.message, 'success');
                  updateSystemStatus(result.details);
              })
              .catch(error => {
                  console.error('ç³»çµ±åˆå§‹åŒ–å¤±æ•—:', error);
                  showAlert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'danger');
              });
      }

      function setupTriggers() {
          callAPI('admin-setup-triggers')
              .then(result => {
                  showAlert(result.message, 'success');
              })
              .catch(error => {
                  console.error('è¨­å®šè§¸ç™¼å™¨å¤±æ•—:', error);
                  showAlert('è¨­å®šè§¸ç™¼å™¨å¤±æ•—: ' + error.message, 'danger');
              });
      }

      function cleanupOldLogs() {
          callAPI('admin-cleanup-old-logs')
              .then(result => {
                  showAlert(result.message, 'success');
              })
              .catch(error => {
                  console.error('æ¸…ç†æ—¥èªŒå¤±æ•—:', error);
                  showAlert('æ¸…ç†æ—¥èªŒå¤±æ•—: ' + error.message, 'danger');
              });
      }

      function checkSystemHealth() {
          callAPI('admin-check-system-health')
              .then(result => {
                  updateSystemStatus([`ç³»çµ±ç‹€æ…‹: ${result.health.status}`]);
                  showAlert('ç³»çµ±å¥åº·æª¢æŸ¥å®Œæˆ', 'success');
              })
              .catch(error => {
                  console.error('ç³»çµ±å¥åº·æª¢æŸ¥å¤±æ•—:', error);
                  showAlert('ç³»çµ±å¥åº·æª¢æŸ¥å¤±æ•—: ' + error.message, 'danger');
              });
      }

      function backupData() {
          const backupSpreadsheetId = document.getElementById('backupSpreadsheetId').value.trim();
          if (!backupSpreadsheetId) {
              showAlert('è«‹è¼¸å…¥å‚™ä»½è©¦ç®—è¡¨ ID', 'warning');
              return;
          }
          
          callAPI('admin-backup-data', { backupSpreadsheetId: backupSpreadsheetId })
              .then(result => {
                  showAlert(result.message, 'success');
              })
              .catch(error => {
                  console.error('å‚™ä»½è³‡æ–™å¤±æ•—:', error);
                  showAlert('å‚™ä»½è³‡æ–™å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // æ›´æ–°ç³»çµ±ç‹€æ…‹é¡¯ç¤º
      function updateSystemStatus(details) {
          const statusDiv = document.getElementById('systemStatus');
          statusDiv.innerHTML = `
              <div class="alert alert-success">
                  <h4>ç³»çµ±ç‹€æ…‹</h4>
                  <ul>
                      ${details.map(detail => `<li>${detail}</li>`).join('')}
                  </ul>
              </div>
          `;
      }

      // å·¥å…·å‡½æ•¸
      function closeModal(modalId) {
          document.getElementById(modalId).style.display = 'none';
      }

      function showAlert(message, type = 'info') {
          const alertDiv = document.createElement('div');
          alertDiv.className = `alert alert-${type}`;
          alertDiv.textContent = message;
          alertDiv.style.position = 'fixed';
          alertDiv.style.top = '20px';
          alertDiv.style.right = '20px';
          alertDiv.style.zIndex = '9999';
          alertDiv.style.minWidth = '300px';
          
          document.body.appendChild(alertDiv);
          
          setTimeout(() => {
              alertDiv.remove();
          }, 5000);
      }

      // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
      window.onclick = function(event) {
          const modals = document.querySelectorAll('.modal');
          modals.forEach(modal => {
              if (event.target === modal) {
                  modal.style.display = 'none';
              }
          });
      }

      // ç›£è½è¤‡é¸æ¡†è®ŠåŒ–
      document.addEventListener('change', function(event) {
          if (event.target.classList.contains('payment-checkbox')) {
              updateSelectedPayments();
          }
      });

            // è¼‰å…¥æœƒå“¡è¨‚å–®ï¼ˆä¿®æ”¹ç‰ˆï¼‰
      function loadMemberOrders(lineName) {
          callAPI('admin-get-member-orders', { lineName: lineName })
              .then(result => {
                  const { memberInfo, consolidatedOrders, rawOrders, payments, summary } = result;
                  
                  // é¡¯ç¤ºæœƒå“¡è³‡è¨Š
                  const memberInfoDiv = document.getElementById('memberInfo');
                  memberInfoDiv.innerHTML = `
                      <div class="summary-row">
                          <span>æœƒå“¡å§“å:</span>
                          <span>${memberInfo ? memberInfo.realName : 'æœªè¨»å†Š'}</span>
                      </div>
                      <div class="summary-row">
                          <span>LINEåç¨±:</span>
                          <span>${lineName}</span>
                      </div>
                      ${memberInfo ? `
                      <div class="summary-row">
                          <span>è¨»å†Šæ™‚é–“:</span>
                          <span>${new Date(memberInfo.registeredAt).toLocaleString('zh-TW')}</span>
                      </div>
                      ` : ''}
                  `;
                  
                  // é¡¯ç¤ºåˆä½µå¾Œçš„è¨‚å–®åˆ—è¡¨
                  const tbody = document.getElementById('memberOrdersTableBody');
                  if (consolidatedOrders.length === 0) {
                      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">æš«ç„¡è¨‚å–®è¨˜éŒ„</td></tr>';
                  } else {
                      tbody.innerHTML = consolidatedOrders.map(order => `
                          <tr ${order.priceVariation ? 'style="background-color: #fff3cd;"' : ''}>
                              <td>
                                  ${order.productCode}
                                  ${order.priceVariation ? '<br><small style="color: #856404;">âš ï¸ åƒ¹æ ¼è®Šå‹•</small>' : ''}
                              </td>
                              <td>${order.productName}</td>
                              <td>
                                  ${order.quantity}
                                  ${order.rowIndexes.length > 1 ? `<br><small style="color: #666;">(${order.rowIndexes.length} ç­†åˆä½µ)</small>` : ''}
                              </td>
                              <td>
                                  NT$ ${parseFloat(order.unitPrice).toLocaleString()}
                                  ${order.priceVariation ? '<br><small style="color: #856404;">å¹³å‡å–®åƒ¹</small>' : ''}
                              </td>
                              <td>NT$ ${parseFloat(order.totalPrice).toLocaleString()}</td>
                              <td>
                                  <button class="btn btn-primary" onclick="showOrderDetails('${order.productCode}')">ğŸ“‹ è©³ç´°</button>
                                  <button class="btn btn-warning" onclick="editConsolidatedOrder('${order.productCode}')">âœï¸ ç·¨è¼¯</button>
                              </td>
                          </tr>
                      `).join('');
                  }
                  
                  // é¡¯ç¤ºè¨‚å–®æ‘˜è¦
                  const summaryDiv = document.getElementById('orderSummary');
                  summaryDiv.innerHTML = `
                      <div class="summary-row">
                          <span>åŸå§‹è¨‚å–®é …ç›®:</span>
                          <span>${summary.rawOrderCount} é …</span>
                      </div>
                      <div class="summary-row">
                          <span>åˆä½µå¾Œé …ç›®:</span>
                          <span>${summary.consolidatedOrderCount} é …</span>
                      </div>
                      <div class="summary-row summary-total">
                          <span>ç¸½é‡‘é¡:</span>
                          <span>NT$ ${summary.totalAmount.toLocaleString()}</span>
                      </div>
                  `;
                  
                  // é¡¯ç¤ºç¹³è²»è¨˜éŒ„
                  const paymentTbody = document.getElementById('paymentHistoryTableBody');
                  if (payments.length === 0) {
                      paymentTbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">æš«ç„¡ç¹³è²»è¨˜éŒ„</td></tr>';
                  } else {
                      paymentTbody.innerHTML = payments.map(payment => `
                          <tr>
                              <td>${payment.paymentId}</td>
                              <td>NT$ ${parseFloat(payment.paymentAmount).toLocaleString()}</td>
                              <td>${payment.paymentMethod}</td>
                              <td>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</td>
                              <td><span class="status-badge status-${payment.status === 'å·²ç¢ºèª' ? 'approved' : payment.status === 'å·²æ‹’çµ•' ? 'rejected' : 'pending'}">${payment.status}</span></td>
                          </tr>
                      `).join('');
                  }
                  
                  // å„²å­˜åŸå§‹è¨‚å–®è³‡æ–™ä¾›ç·¨è¼¯ä½¿ç”¨
                  window.currentRawOrders = rawOrders;
                  window.currentConsolidatedOrders = consolidatedOrders;
              })
              .catch(error => {
                  console.error('è¼‰å…¥æœƒå“¡è¨‚å–®å¤±æ•—:', error);
                  showAlert('è¼‰å…¥æœƒå“¡è¨‚å–®å¤±æ•—: ' + error.message, 'danger');
              });
      }

      // é¡¯ç¤ºè¨‚å–®è©³ç´°è³‡è¨Š
      function showOrderDetails(productCode) {
          const consolidatedOrder = window.currentConsolidatedOrders.find(order => order.productCode === productCode);
          const relatedRawOrders = window.currentRawOrders.filter(order => order.productCode === productCode);
          
          if (!consolidatedOrder || !relatedRawOrders) {
              showAlert('æ‰¾ä¸åˆ°è¨‚å–®è©³ç´°è³‡è¨Š', 'danger');
              return;
          }
          
          let detailsHtml = `
              <div class="modal" id="orderDetailsModal" style="display: block;">
                  <div class="modal-content">
                      <div class="modal-header">
                          <h3>ğŸ“‹ ${consolidatedOrder.productName} - è¨‚å–®è©³ç´°</h3>
                          <button class="close" onclick="closeModal('orderDetailsModal')">&times;</button>
                      </div>
                      
                      <div class="order-summary">
                          <div class="summary-row">
                              <span>ç”¢å“ä»£è™Ÿ:</span>
                              <span>${consolidatedOrder.productCode}</span>
                          </div>
                          <div class="summary-row">
                              <span>ç”¢å“åç¨±:</span>
                              <span>${consolidatedOrder.productName}</span>
                          </div>
                          <div class="summary-row">
                              <span>åˆä½µå¾Œæ•¸é‡:</span>
                              <span>${consolidatedOrder.quantity}</span>
                          </div>
                          <div class="summary-row">
                              <span>å¹³å‡å–®åƒ¹:</span>
                              <span>NT$ ${parseFloat(consolidatedOrder.unitPrice).toLocaleString()}</span>
                          </div>
                          <div class="summary-row summary-total">
                              <span>åˆè¨ˆé‡‘é¡:</span>
                              <span>NT$ ${parseFloat(consolidatedOrder.totalPrice).toLocaleString()}</span>
                          </div>
                      </div>
                      
                      <h4>ğŸ“ åŸå§‹è¨‚å–®æ˜ç´°</h4>
                      <div class="table-container">
                          <table>
                              <thead>
                                  <tr>
                                      <th>æ•¸é‡</th>
                                      <th>å–®åƒ¹</th>
                                      <th>å°è¨ˆ</th>
                                      <th>æ“ä½œ</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${relatedRawOrders.map(order => `
                                      <tr>
                                          <td>${order.quantity}</td>
                                          <td>NT$ ${parseFloat(order.unitPrice).toLocaleString()}</td>
                                          <td>NT$ ${parseFloat(order.totalPrice).toLocaleString()}</td>
                                          <td>
                                              <button class="btn btn-warning" onclick="editOrder(${order.rowIndex}); closeModal('orderDetailsModal')">ç·¨è¼¯</button>
                                              <button class="btn btn-danger" onclick="deleteOrder(${order.rowIndex}); closeModal('orderDetailsModal')">åˆªé™¤</button>
                                          </td>
                                      </tr>
                                  `).join('')}
                              </tbody>
                          </table>
                      </div>
                      
                      <div style="text-align: right; margin-top: 1rem;">
                          <button class="btn btn-secondary" onclick="closeModal('orderDetailsModal')">é—œé–‰</button>
                      </div>
                  </div>
              </div>
          `;
          
          // ç§»é™¤ç¾æœ‰çš„è©³ç´°æ¨¡æ…‹æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          const existingModal = document.getElementById('orderDetailsModal');
          if (existingModal) {
              existingModal.remove();
          }
          
          // æ·»åŠ æ–°çš„è©³ç´°æ¨¡æ…‹æ¡†
          document.body.insertAdjacentHTML('beforeend', detailsHtml);
      }

      // ç·¨è¼¯åˆä½µè¨‚å–®ï¼ˆé¡¯ç¤ºè©²ç”¢å“çš„æ‰€æœ‰åŸå§‹è¨‚å–®ï¼‰
      function editConsolidatedOrder(productCode) {
          const relatedRawOrders = window.currentRawOrders.filter(order => order.productCode === productCode);
          
          if (!relatedRawOrders || relatedRawOrders.length === 0) {
              showAlert('æ‰¾ä¸åˆ°ç›¸é—œè¨‚å–®', 'danger');
              return;
          }
          
          // å¦‚æœåªæœ‰ä¸€ç­†è¨‚å–®ï¼Œç›´æ¥ç·¨è¼¯
          if (relatedRawOrders.length === 1) {
              editOrder(relatedRawOrders[0].rowIndex);
              return;
          }
          
          // å¦‚æœæœ‰å¤šç­†è¨‚å–®ï¼Œé¡¯ç¤ºé¸æ“‡ä»‹é¢
          let editOptionsHtml = `
              <div class="modal" id="editOptionsModal" style="display: block;">
                  <div class="modal-content">
                      <div class="modal-header">
                          <h3>âœï¸ é¸æ“‡è¦ç·¨è¼¯çš„è¨‚å–®</h3>
                          <button class="close" onclick="closeModal('editOptionsModal')">&times;</button>
                      </div>
                      
                      <p>æ­¤ç”¢å“æœ‰ ${relatedRawOrders.length} ç­†è¨‚å–®ï¼Œè«‹é¸æ“‡è¦ç·¨è¼¯çš„é …ç›®ï¼š</p>
                      
                      <div class="table-container">
                          <table>
                              <thead>
                                  <tr>
                                      <th>æ•¸é‡</th>
                                      <th>å–®åƒ¹</th>
                                      <th>å°è¨ˆ</th>
                                      <th>æ“ä½œ</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${relatedRawOrders.map((order, index) => `
                                      <tr>
                                          <td>${order.quantity}</td>
                                          <td>NT$ ${parseFloat(order.unitPrice).toLocaleString()}</td>
                                          <td>NT$ ${parseFloat(order.totalPrice).toLocaleString()}</td>
                                          <td>
                                              <button class="btn btn-warning" onclick="editOrder(${order.rowIndex}); closeModal('editOptionsModal')">ç·¨è¼¯æ­¤é …</button>
                                          </td>
                                      </tr>
                                  `).join('')}
                              </tbody>
                          </table>
                      </div>
                      
                      <div style="text-align: right; margin-top: 1rem;">
                          <button class="btn btn-primary" onclick="addNewOrder(); closeModal('editOptionsModal')">â• æ–°å¢åŒç”¢å“è¨‚å–®</button>
                          <button class="btn btn-secondary" onclick="closeModal('editOptionsModal')">å–æ¶ˆ</button>
                      </div>
                  </div>
              </div>
          `;
          
          // ç§»é™¤ç¾æœ‰çš„é¸é …æ¨¡æ…‹æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          const existingModal = document.getElementById('editOptionsModal');
          if (existingModal) {
              existingModal.remove();
          }
          
          // æ·»åŠ æ–°çš„é¸é …æ¨¡æ…‹æ¡†
          document.body.insertAdjacentHTML('beforeend', editOptionsHtml);
      }

      // ä¿®æ”¹è¨‚å–®è¡¨æ ¼æ¨™é¡Œ
      function updateOrderTableHeader() {
          const tableHeader = document.querySelector('#memberOrdersTable thead tr');
          if (tableHeader) {
              tableHeader.innerHTML = `
                  <th>ç”¢å“ä»£è™Ÿ</th>
                  <th>ç”¢å“åç¨±</th>
                  <th>åˆä½µæ•¸é‡</th>
                  <th>å¹³å‡å–®åƒ¹</th>
                  <th>åˆè¨ˆé‡‘é¡</th>
                  <th>æ“ä½œ</th>
              `;
          }
      }

      // åœ¨é é¢è¼‰å…¥æ™‚æ›´æ–°è¡¨æ ¼æ¨™é¡Œ
      document.addEventListener('DOMContentLoaded', function() {
          // å»¶é²åŸ·è¡Œä»¥ç¢ºä¿ DOM å·²å®Œå…¨è¼‰å…¥
          setTimeout(updateOrderTableHeader, 100);
      });
  </script>
</body>
</html>
