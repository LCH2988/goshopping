<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>„ÄêÂ§öÁ¶èÊ∞£„ÄëBOGOÁÆ°ÁêÜËÄÖ‰ªãÈù¢</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: #f5f5f5;
          color: #333;
      }

      .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 1rem;
          text-align: center;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      .nav-tabs {
          display: flex;
          background: white;
          border-bottom: 1px solid #ddd;
          overflow-x: auto;
      }

      .nav-tab {
          flex: 1;
          min-width: 120px;
          padding: 1rem;
          text-align: center;
          background: white;
          border: none;
          cursor: pointer;
          transition: all 0.3s;
          font-size: 14px;
      }

      .nav-tab.active {
          background: #667eea;
          color: white;
      }

      .nav-tab:hover {
          background: #f0f0f0;
      }

      .nav-tab.active:hover {
          background: #5a6fd8;
      }

      .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 1rem;
      }

      .tab-content {
          display: none;
          background: white;
          border-radius: 8px;
          padding: 1.5rem;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          margin-top: 1rem;
      }

      .tab-content.active {
          display: block;
      }

      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1rem;
          margin-bottom: 2rem;
      }

      .stat-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 1.5rem;
          border-radius: 8px;
          text-align: center;
      }

      .stat-number {
          font-size: 2rem;
          font-weight: bold;
          margin-bottom: 0.5rem;
      }

      .stat-label {
          font-size: 0.9rem;
          opacity: 0.9;
      }

      .search-section {
          background: #f8f9fa;
          padding: 1.5rem;
          border-radius: 8px;
          margin-bottom: 2rem;
      }

      .search-input {
          width: 100%;
          padding: 0.75rem;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 16px;
          margin-bottom: 1rem;
      }

      .search-results {
          display: grid;
          gap: 0.5rem;
      }

      .member-item {
          background: white;
          padding: 1rem;
          border-radius: 4px;
          border: 1px solid #eee;
          cursor: pointer;
          transition: all 0.3s;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .member-item:hover {
          background: #f0f8ff;
          border-color: #667eea;
      }

      .member-info {
          flex: 1;
      }

      .member-name {
          font-weight: bold;
          margin-bottom: 0.25rem;
      }

      .member-details {
          font-size: 0.9rem;
          color: #666;
      }

      .order-badge {
          background: #667eea;
          color: white;
          padding: 0.25rem 0.5rem;
          border-radius: 12px;
          font-size: 0.8rem;
      }

      .table-container {
          overflow-x: auto;
          margin-top: 1rem;
      }

      table {
          width: 100%;
          border-collapse: collapse;
          background: white;
      }

      th, td {
          padding: 0.75rem;
          text-align: left;
          border-bottom: 1px solid #eee;
      }

      th {
          background: #f8f9fa;
          font-weight: bold;
          position: sticky;
          top: 0;
      }

      tr:hover {
          background: #f8f9fa;
      }

      .btn {
          padding: 0.5rem 1rem;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 14px;
          transition: all 0.3s;
          margin: 0.25rem;
      }

      .btn-primary {
          background: #667eea;
          color: white;
      }

      .btn-primary:hover {
          background: #5a6fd8;
      }

      .btn-success {
          background: #28a745;
          color: white;
      }

      .btn-success:hover {
          background: #218838;
      }

      .btn-danger {
          background: #dc3545;
          color: white;
      }

      .btn-danger:hover {
          background: #c82333;
      }

      .btn-warning {
          background: #ffc107;
          color: #212529;
      }

      .btn-warning:hover {
          background: #e0a800;
      }

      .btn-secondary {
          background: #6c757d;
          color: white;
      }

      .btn-secondary:hover {
          background: #5a6268;
      }

      .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
      }

      .modal-content {
          background: white;
          margin: 5% auto;
          padding: 2rem;
          border-radius: 8px;
          width: 90%;
          max-width: 600px;
          max-height: 80vh;
          overflow-y: auto;
      }

      .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
          padding-bottom: 1rem;
          border-bottom: 1px solid #eee;
      }

      .close {
          background: none;
          border: none;
          font-size: 1.5rem;
          cursor: pointer;
          color: #999;
      }

      .close:hover {
          color: #333;
      }

      .form-group {
          margin-bottom: 1rem;
      }

      .form-label {
          display: block;
          margin-bottom: 0.5rem;
          font-weight: bold;
      }

      .form-control {
          width: 100%;
          padding: 0.5rem;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 14px;
      }

      .form-control:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
      }

      .alert {
          padding: 1rem;
          border-radius: 4px;
          margin-bottom: 1rem;
      }

      .alert-success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }

      .alert-danger {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }

      .alert-warning {
          background: #fff3cd;
          color: #856404;
          border: 1px solid #ffeaa7;
      }

      .loading {
          text-align: center;
          padding: 2rem;
          color: #666;
      }

      .spinner {
          border: 3px solid #f3f3f3;
          border-top: 3px solid #667eea;
          border-radius: 50%;
          width: 30px;
          height: 30px;
          animation: spin 1s linear infinite;
          margin: 0 auto 1rem;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .checkbox-group {
          display: flex;
          flex-wrap: wrap;
          gap: 1rem;
          margin: 1rem 0;
      }

      .checkbox-item {
          display: flex;
          align-items: center;
          gap: 0.5rem;
      }

      .status-badge {
          padding: 0.25rem 0.5rem;
          border-radius: 12px;
          font-size: 0.8rem;
          font-weight: bold;
      }

      .status-pending {
          background: #fff3cd;
          color: #856404;
      }

      .status-approved {
          background: #d4edda;
          color: #155724;
      }

      .status-rejected {
          background: #f8d7da;
          color: #721c24;
      }

      .order-summary {
          background: #f8f9fa;
          padding: 1rem;
          border-radius: 4px;
          margin: 1rem 0;
      }

      .summary-row {
          display: flex;
          justify-content: space-between;
          margin-bottom: 0.5rem;
      }

      .summary-total {
          font-weight: bold;
          font-size: 1.1rem;
          border-top: 1px solid #ddd;
          padding-top: 0.5rem;
          margin-top: 0.5rem;
      }

      @media (max-width: 768px) {
          .container {
              padding: 0.5rem;
          }

          .stats-grid {
              grid-template-columns: repeat(2, 1fr);
          }

          .stat-card {
              padding: 1rem;
          }

          .stat-number {
              font-size: 1.5rem;
          }

          .modal-content {
              margin: 2% auto;
              width: 95%;
              padding: 1rem;
          }

          .nav-tab {
              font-size: 12px;
              padding: 0.75rem 0.5rem;
          }
      }
  </style>
</head>
<body>
  <div class="header">
      <h1>üìä Ë®ÇË≥ºÁ≥ªÁµ±ÁÆ°ÁêÜ‰∏≠ÂøÉ</h1>
      <p id="adminInfo">ËºâÂÖ•‰∏≠...</p>
  </div>

  <div class="nav-tabs">
      <button class="nav-tab active" onclick="showTab('dashboard')">ÂÑÄË°®Êùø</button>
      <button class="nav-tab" onclick="showTab('payments')">Áπ≥Ë≤ªÂØ©Ê†∏</button>
      <button class="nav-tab" onclick="showTab('members')">ÊúÉÂì°ÁÆ°ÁêÜ</button>
      <button class="nav-tab" onclick="showTab('orders')">Ë®ÇÂñÆÊü•Ë©¢</button>
      <button class="nav-tab" onclick="showTab('reports')">Â†±Ë°®</button>
      <button class="nav-tab" onclick="showTab('settings')">Á≥ªÁµ±Ë®≠ÂÆö</button>
  </div>

  <div class="container">
      <!-- ÂÑÄË°®Êùø -->
      <div id="dashboard" class="tab-content active">
          <h2>üìà Á≥ªÁµ±Ê¶ÇË¶Ω</h2>
          <div class="stats-grid" id="statsGrid">
              <!-- Áµ±Ë®àÂç°ÁâáÂ∞áÁî± JavaScript ÂãïÊÖãÁîüÊàê -->
          </div>
          
          <div class="alert alert-warning" id="pendingAlert" style="display: none;">
              <strong>‚ö†Ô∏è Ê≥®ÊÑèÔºö</strong> <span id="pendingCount">0</span> Á≠ÜÁπ≥Ë≤ªË®òÈåÑÂæÖÂØ©Ê†∏
          </div>
      </div>

      <!-- Áπ≥Ë≤ªÂØ©Ê†∏ -->
      <div id="payments" class="tab-content">
          <h2>üí≥ Áπ≥Ë≤ªÂØ©Ê†∏</h2>
          
          <div style="margin-bottom: 1rem;">
              <button class="btn btn-primary" onclick="loadPendingPayments()">üîÑ ÈáçÊñ∞ËºâÂÖ•</button>
              <button class="btn btn-success" onclick="showBatchReview('Â∑≤Á¢∫Ë™ç')">‚úÖ ÊâπÈáèÈÄöÈÅé</button>
              <button class="btn btn-danger" onclick="showBatchReview('Â∑≤ÊãíÁµï')">‚ùå ÊâπÈáèÊãíÁµï</button>
          </div>

          <div class="table-container">
              <table id="paymentsTable">
                  <thead>
                      <tr>
                          <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                          <th>Áπ≥Ë≤ªÁ∑®Ëôü</th>
                          <th>ÊúÉÂì°ÂßìÂêç</th>
                          <th>Áπ≥Ë≤ªÈáëÈ°ç</th>
                          <th>Áπ≥Ë≤ªÊñπÂºè</th>
                          <th>Êèê‰∫§ÊôÇÈñì</th>
                          <th>ÁãÄÊÖã</th>
                          <th>Êìç‰Ωú</th>
                      </tr>
                  </thead>
                  <tbody id="paymentsTableBody">
                      <!-- Ë≥áÊñôÂ∞áÁî± JavaScript ÂãïÊÖãËºâÂÖ• -->
                  </tbody>
              </table>
          </div>
      </div>

      <!-- ÊúÉÂì°ÁÆ°ÁêÜ -->
      <div id="members" class="tab-content">
          <h2>üë• ÊúÉÂì°ÁÆ°ÁêÜ</h2>
          
          <div class="table-container">
              <table id="membersTable">
                  <thead>
                      <tr>
                          <th>LINEÂêçÁ®±</th>
                          <th>ÁúüÂØ¶ÂßìÂêç</th>
                          <th>Ë®ªÂÜäÊôÇÈñì</th>
                          <th>Ë®ÇÂñÆÊï∏Èáè</th>
                          <th>Áπ≥Ë≤ªÊ¨°Êï∏</th>
                          <th>ÁãÄÊÖã</th>
                      </tr>
                  </thead>
                  <tbody id="membersTableBody">
                      <!-- Ë≥áÊñôÂ∞áÁî± JavaScript ÂãïÊÖãËºâÂÖ• -->
                  </tbody>
              </table>
          </div>
      </div>

      <!-- Ë®ÇÂñÆÊü•Ë©¢ -->
      <div id="orders" class="tab-content">
          <h2>üõí Ë®ÇÂñÆÊü•Ë©¢ËàáÁÆ°ÁêÜ</h2>
          
          <div class="search-section">
              <h3>üîç ÊêúÂ∞ãÊúÉÂì°</h3>
              <input type="text" id="memberSearch" class="search-input" 
                     placeholder="Ëº∏ÂÖ• LINE ÂêçÁ®±ÊàñÁúüÂØ¶ÂßìÂêçÈÄ≤Ë°åÊêúÂ∞ã..." 
                     onkeyup="searchMembers(event)">
              
              <div id="searchResults" class="search-results">
                  <!-- ÊêúÂ∞ãÁµêÊûúÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£° -->
              </div>
          </div>

          <div id="memberOrdersSection" style="display: none;">
              <div class="modal-header">
                  <h3 id="selectedMemberName">ÊúÉÂì°Ë®ÇÂñÆ</h3>
                  <button class="btn btn-primary" onclick="addNewOrder()">‚ûï Êñ∞Â¢ûË®ÇÂñÆ</button>
              </div>

              <div id="memberInfo" class="order-summary">
                  <!-- ÊúÉÂì°Ë≥áË®äÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£° -->
              </div>

              <div class="table-container">
                  <table id="memberOrdersTable">
                      <thead>
                          <tr>
                              <th>Áî¢ÂìÅ‰ª£Ëôü</th>
                              <th>Áî¢ÂìÅÂêçÁ®±</th>
                              <th>Êï∏Èáè</th>
                              <th>ÂñÆÂÉπ</th>
                              <th>ÂêàË®à</th>
                              <th>Êìç‰Ωú</th>
                          </tr>
                      </thead>
                      <tbody id="memberOrdersTableBody">
                          <!-- Ë®ÇÂñÆË≥áÊñôÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£° -->
                      </tbody>
                  </table>
              </div>

              <div id="orderSummary" class="order-summary">
                  <!-- Ë®ÇÂñÆÊëòË¶ÅÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£° -->
              </div>

              <div id="paymentHistory" style="margin-top: 2rem;">
                  <h4>üí∞ Áπ≥Ë≤ªË®òÈåÑ</h4>
                  <div class="table-container">
                      <table id="paymentHistoryTable">
                          <thead>
                              <tr>
                                  <th>Áπ≥Ë≤ªÁ∑®Ëôü</th>
                                  <th>Áπ≥Ë≤ªÈáëÈ°ç</th>
                                  <th>Áπ≥Ë≤ªÊñπÂºè</th>
                                  <th>Êèê‰∫§ÊôÇÈñì</th>
                                  <th>ÁãÄÊÖã</th>
                              </tr>
                          </thead>
                          <tbody id="paymentHistoryTableBody">
                              <!-- Áπ≥Ë≤ªË®òÈåÑÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£° -->
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      </div>

      <!-- Â†±Ë°® -->
      <div id="reports" class="tab-content">
          <h2>üìä Â†±Ë°®‰∏≠ÂøÉ</h2>
          
          <div style="margin-bottom: 2rem;">
              <div class="form-group">
                  <label class="form-label">ÈÅ∏ÊìáÊó•ÊúüÔºö</label>
                  <input type="date" id="reportDate" class="form-control" style="width: auto; display: inline-block;">
                  <button class="btn btn-primary" onclick="generateDailyReport()">üìà ÁîüÊàêÊó•Â†±Ë°®</button>
              </div>
          </div>

          <div id="reportContent">
              <!-- Â†±Ë°®ÂÖßÂÆπÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£° -->
          </div>

          <div style="margin-top: 2rem;">
              <button class="btn btn-secondary" onclick="exportAllData()">üì§ ÂåØÂá∫ÊâÄÊúâË≥áÊñô</button>
              <button class="btn btn-warning" onclick="cleanupTestData()">üßπ Ê∏ÖÁêÜÊ∏¨Ë©¶Ë≥áÊñô</button>
          </div>
      </div>

      <!-- Á≥ªÁµ±Ë®≠ÂÆö -->
      <div id="settings" class="tab-content">
          <h2>‚öôÔ∏è Á≥ªÁµ±Ë®≠ÂÆö</h2>
          
          <div style="margin-bottom: 2rem;">
              <h3>üîß Á≥ªÁµ±Á∂≠Ë≠∑</h3>
              <button class="btn btn-primary" onclick="initializeSystem()">üöÄ ÂàùÂßãÂåñÁ≥ªÁµ±</button>
              <button class="btn btn-secondary" onclick="setupTriggers()">‚è∞ Ë®≠ÂÆöËß∏ÁôºÂô®</button>
              <button class="btn btn-warning" onclick="cleanupOldLogs()">üóëÔ∏è Ê∏ÖÁêÜËàäÊó•Ë™å</button>
              <button class="btn btn-success" onclick="checkSystemHealth()">üè• Á≥ªÁµ±ÂÅ•Â∫∑Ê™¢Êü•</button>
          </div>

          <div>
              <h3>üíæ Ë≥áÊñôÂÇô‰ªΩ</h3>
              <div class="form-group">
                  <label class="form-label">ÂÇô‰ªΩË©¶ÁÆóË°® IDÔºö</label>
                  <input type="text" id="backupSpreadsheetId" class="form-control" 
                         placeholder="Ë´ãËº∏ÂÖ•ÁõÆÊ®ôË©¶ÁÆóË°®ÁöÑ ID">
                  <button class="btn btn-primary" onclick="backupData()" style="margin-top: 0.5rem;">
                      üíæ ÈñãÂßãÂÇô‰ªΩ
                  </button>
              </div>
          </div>

          <div id="systemStatus" style="margin-top: 2rem;">
              <!-- Á≥ªÁµ±ÁãÄÊÖãÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£° -->
          </div>
      </div>
  </div>

  <!-- ÂØ©Ê†∏Ê®°ÊÖãÊ°Ü -->
  <div id="reviewModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>ÂØ©Ê†∏Áπ≥Ë≤ªË®òÈåÑ</h3>
              <button class="close" onclick="closeModal('reviewModal')">&times;</button>
          </div>
          
          <div id="reviewPaymentInfo">
              <!-- Áπ≥Ë≤ªË≥áË®äÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£° -->
          </div>
          
          <div class="form-group">
              <label class="form-label">ÂØ©Ê†∏ÁµêÊûúÔºö</label>
              <select id="reviewStatus" class="form-control">
                  <option value="Â∑≤Á¢∫Ë™ç">‚úÖ ÈÄöÈÅé</option>
                  <option value="Â∑≤ÊãíÁµï">‚ùå ÊãíÁµï</option>
              </select>
          </div>
          
          <div class="form-group">
              <label class="form-label">ÂØ©Ê†∏ÂÇôË®ªÔºö</label>
              <textarea id="reviewNote" class="form-control" rows="3" 
                        placeholder="Ë´ãËº∏ÂÖ•ÂØ©Ê†∏ÂÇôË®ª..."></textarea>
          </div>
          
          <div style="text-align: right;">
              <button class="btn btn-secondary" onclick="closeModal('reviewModal')">ÂèñÊ∂à</button>
              <button class="btn btn-primary" onclick="submitReview()">Á¢∫Ë™çÂØ©Ê†∏</button>
          </div>
      </div>
  </div>

  <!-- ÊâπÈáèÂØ©Ê†∏Ê®°ÊÖãÊ°Ü -->
  <div id="batchReviewModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>ÊâπÈáèÂØ©Ê†∏</h3>
              <button class="close" onclick="closeModal('batchReviewModal')">&times;</button>
          </div>
          
          <div id="batchReviewInfo">
              <!-- ÊâπÈáèÂØ©Ê†∏Ë≥áË®äÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£° -->
          </div>
          
          <div class="form-group">
              <label class="form-label">ÂØ©Ê†∏ÂÇôË®ªÔºö</label>
              <textarea id="batchReviewNote" class="form-control" rows="3" 
                        placeholder="Ë´ãËº∏ÂÖ•ÂØ©Ê†∏ÂÇôË®ª..."></textarea>
          </div>
          
          <div style="text-align: right;">
              <button class="btn btn-secondary" onclick="closeModal('batchReviewModal')">ÂèñÊ∂à</button>
              <button class="btn btn-primary" onclick="submitBatchReview()">Á¢∫Ë™çÊâπÈáèÂØ©Ê†∏</button>
          </div>
      </div>
  </div>

  <!-- Á∑®ËºØË®ÇÂñÆÊ®°ÊÖãÊ°Ü -->
  <div id="editOrderModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="editOrderTitle">Á∑®ËºØË®ÇÂñÆ</h3>
              <button class="close" onclick="closeModal('editOrderModal')">&times;</button>
          </div>
          
          <div class="form-group">
              <label class="form-label">LINEÂêçÁ®±Ôºö</label>
              <input type="text" id="editLineName" class="form-control">
          </div>
          
          <div class="form-group">
              <label class="form-label">Áî¢ÂìÅ‰ª£ËôüÔºö</label>
              <input type="text" id="editProductCode" class="form-control">
          </div>
          
          <div class="form-group">
              <label class="form-label">Áî¢ÂìÅÂêçÁ®±Ôºö</label>
              <input type="text" id="editProductName" class="form-control">
          </div>
          
          <div class="form-group">
              <label class="form-label">Êï∏ÈáèÔºö</label>
              <input type="number" id="editQuantity" class="form-control" min="1" onchange="calculateTotal()">
          </div>
          
          <div class="form-group">
              <label class="form-label">ÂñÆÂÉπÔºö</label>
              <input type="number" id="editUnitPrice" class="form-control" min="0" step="0.01" onchange="calculateTotal()">
          </div>
          
          <div class="form-group">
              <label class="form-label">ÂêàË®àÔºö</label>
              <input type="number" id="editTotalPrice" class="form-control" readonly>
          </div>
          
          <div style="text-align: right;">
              <button class="btn btn-secondary" onclick="closeModal('editOrderModal')">ÂèñÊ∂à</button>
              <button class="btn btn-primary" onclick="saveOrder()">ÂÑ≤Â≠ò</button>
          </div>
      </div>
  </div>

  <script>
      // Ë®≠ÂÆöÂçÄÂüü
      const CONFIG = {
          LIFF_ID: '1657285806-2bmkYWkN', // Ë´ãÊõøÊèõÁÇ∫ÊÇ®ÁöÑ LIFF ID
          API_BASE_URL: 'https://script.google.com/macros/s/AKfycbz9D6796MX0xyZ6owz03Fz_Mz44zkKuK6Z8CCTukkWMsl53DlBIy-5yICLifgYPX0Mi/exec' // Ë´ãÊõøÊèõÁÇ∫ÊÇ®ÁöÑ GAS Web App URL
      };

      // ÂÖ®ÂüüËÆäÊï∏
      let currentUser = null;
      let currentPaymentId = null;
      let currentRowIndex = null;
      let selectedPaymentIds = [];
      let batchReviewStatus = '';
      let currentMemberName = '';

      // LIFF ÂàùÂßãÂåñ
      document.addEventListener('DOMContentLoaded', function() {
          liff.init({
              liffId: CONFIG.LIFF_ID
          }).then(() => {
              if (liff.isLoggedIn()) {
                  liff.getProfile().then(profile => {
                      currentUser = {
                          userId: profile.userId,
                          displayName: profile.displayName
                      };
                      
                      document.getElementById('adminInfo').textContent = 
                          `ÁÆ°ÁêÜËÄÖÔºö${profile.displayName}`;
                      
                      // ËºâÂÖ•ÂàùÂßãË≥áÊñô
                      loadDashboard();
                      loadPendingPayments();
                      loadAllMembers();
                  });
              } else {
                  liff.login();
              }
          }).catch(err => {
              console.error('LIFF ÂàùÂßãÂåñÂ§±Êïó:', err);
              alert('Á≥ªÁµ±ÂàùÂßãÂåñÂ§±ÊïóÔºåË´ãÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢');
          });
      });

      // API ÂëºÂè´ÂáΩÊï∏
      function callAPI(action, data = {}) {
          return new Promise((resolve, reject) => {
              data.adminUserId = currentUser ? currentUser.userId : '';
              
              const url = `${CONFIG.API_BASE_URL}?action=${action}&data=${encodeURIComponent(JSON.stringify(data))}`;
              
              fetch(url)
                  .then(response => response.json())
                  .then(result => {
                      if (result.success) {
                          resolve(result);
                      } else {
                          reject(new Error(result.message || 'Êìç‰ΩúÂ§±Êïó'));
                      }
                  })
                  .catch(error => {
                      reject(error);
                  });
          });
      }

      // Ê®ôÁ±§ÂàáÊèõ
      function showTab(tabName) {
          // Èö±ËóèÊâÄÊúâÊ®ôÁ±§ÂÖßÂÆπ
          document.querySelectorAll('.tab-content').forEach(tab => {
              tab.classList.remove('active');
          });
          
          // ÁßªÈô§ÊâÄÊúâÊ®ôÁ±§ÁöÑ active ÁãÄÊÖã
          document.querySelectorAll('.nav-tab').forEach(tab => {
              tab.classList.remove('active');
          });
          
          // È°ØÁ§∫ÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§ÂÖßÂÆπ
          document.getElementById(tabName).classList.add('active');
          
          // Ë®≠ÂÆöÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§ÁÇ∫ active
          event.target.classList.add('active');
          
          // ËºâÂÖ•Â∞çÊáâÁöÑË≥áÊñô
          switch(tabName) {
              case 'dashboard':
                  loadDashboard();
                  break;
              case 'payments':
                  loadPendingPayments();
                  break;
              case 'members':
                  loadAllMembers();
                  break;
              case 'reports':
                  // Ë®≠ÂÆöÈ†êË®≠Êó•ÊúüÁÇ∫‰ªäÂ§©
                  document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
                  break;
          }
      }

      // ËºâÂÖ•ÂÑÄË°®Êùø
      function loadDashboard() {
          callAPI('admin-get-statistics')
              .then(result => {
                  const stats = result.statistics;
                  const statsGrid = document.getElementById('statsGrid');
                  
                  statsGrid.innerHTML = `
                      <div class="stat-card">
                          <div class="stat-number">${stats.totalUsers}</div>
                          <div class="stat-label">Ë®ªÂÜäÊúÉÂì°</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${stats.totalOrders}</div>
                          <div class="stat-label">Á∏ΩË®ÇÂñÆÊï∏</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${stats.totalPayments}</div>
                          <div class="stat-label">Áπ≥Ë≤ªË®òÈåÑ</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${stats.pendingPayments}</div>
                          <div class="stat-label">ÂæÖÂØ©Ê†∏</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">${stats.approvedPayments}</div>
                          <div class="stat-label">Â∑≤Á¢∫Ë™ç</div>
                      </div>
                      <div class="stat-card">
                          <div class="stat-number">NT$ ${stats.totalAmount.toLocaleString()}</div>
                          <div class="stat-label">Á∏ΩÈáëÈ°ç</div>
                      </div>
                  `;
                  
                  // È°ØÁ§∫ÂæÖÂØ©Ê†∏ÊèêÈÜí
                  const pendingAlert = document.getElementById('pendingAlert');
                  const pendingCount = document.getElementById('pendingCount');
                  
                  if (stats.pendingPayments > 0) {
                      pendingCount.textContent = stats.pendingPayments;
                      pendingAlert.style.display = 'block';
                  } else {
                      pendingAlert.style.display = 'none';
                  }
              })
              .catch(error => {
                  console.error('ËºâÂÖ•Áµ±Ë®àË≥áÊñôÂ§±Êïó:', error);
                  showAlert('ËºâÂÖ•Áµ±Ë®àË≥áÊñôÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      // ËºâÂÖ•ÂæÖÂØ©Ê†∏Áπ≥Ë≤ª
      function loadPendingPayments() {
          const tbody = document.getElementById('paymentsTableBody');
          tbody.innerHTML = '<tr><td colspan="8" class="loading"><div class="spinner"></div>ËºâÂÖ•‰∏≠...</td></tr>';
          
          callAPI('admin-get-pending-payments')
              .then(result => {
                  const payments = result.payments;
                  
                  if (payments.length === 0) {
                      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">Êö´ÁÑ°ÂæÖÂØ©Ê†∏Ë®òÈåÑ</td></tr>';
                      return;
                  }
                  
                  tbody.innerHTML = payments.map(payment => `
                      <tr>
                          <td><input type="checkbox" class="payment-checkbox" value="${payment.paymentId}"></td>
                          <td>${payment.paymentId}</td>
                          <td>${payment.realName}</td>
                          <td>NT$ ${payment.paymentAmount.toLocaleString()}</td>
                          <td>${payment.paymentMethod}</td>
                          <td>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</td>
                          <td><span class="status-badge status-pending">${payment.status}</span></td>
                          <td>
                              <button class="btn btn-primary" onclick="showReviewModal('${payment.paymentId}')">ÂØ©Ê†∏</button>
                          </td>
                      </tr>
                  `).join('');
              })
              .catch(error => {
                  console.error('ËºâÂÖ•ÂæÖÂØ©Ê†∏Áπ≥Ë≤ªÂ§±Êïó:', error);
                  tbody.innerHTML = `<tr><td colspan="8" class="alert alert-danger">ËºâÂÖ•Â§±Êïó: ${error.message}</td></tr>`;
              });
      }

      // ËºâÂÖ•ÊâÄÊúâÊúÉÂì°
      function loadAllMembers() {
          const tbody = document.getElementById('membersTableBody');
          tbody.innerHTML = '<tr><td colspan="6" class="loading"><div class="spinner"></div>ËºâÂÖ•‰∏≠...</td></tr>';
          
          callAPI('admin-get-users')
              .then(result => {
                  const users = result.users;
                  
                  if (users.length === 0) {
                      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">Êö´ÁÑ°ÊúÉÂì°Ë≥áÊñô</td></tr>';
                      return;
                  }
                  
                  tbody.innerHTML = users.map(user => `
                      <tr>
                          <td>${user.lineDisplayName}</td>
                          <td>${user.realName}</td>
                          <td>${new Date(user.registeredAt).toLocaleDateString('zh-TW')}</td>
                          <td>${user.orderCount}</td>
                          <td>${user.paymentCount}</td>
                          <td><span class="status-badge status-approved">${user.status}</span></td>
                      </tr>
                  `).join('');
              })
              .catch(error => {
                  console.error('ËºâÂÖ•ÊúÉÂì°Ë≥áÊñôÂ§±Êïó:', error);
                  tbody.innerHTML = `<tr><td colspan="6" class="alert alert-danger">ËºâÂÖ•Â§±Êïó: ${error.message}</td></tr>`;
              });
      }

      // ÊêúÂ∞ãÊúÉÂì°
      function searchMembers(event) {
          const keyword = event.target.value.trim();
          const resultsDiv = document.getElementById('searchResults');
          
          if (keyword.length < 2) {
              resultsDiv.innerHTML = '';
              return;
          }
          
          if (event.key === 'Enter' || event.type === 'input') {
              callAPI('admin-search-members', { keyword: keyword })
                  .then(result => {
                      const members = result.members;
                      
                      if (members.length === 0) {
                          resultsDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">Êâæ‰∏çÂà∞Áõ∏ÈóúÊúÉÂì°</div>';
                          return;
                      }
                      
                      resultsDiv.innerHTML = members.map(member => `
                          <div class="member-item" onclick="selectMember('${member.lineName}')">
                              <div class="member-info">
                                  <div class="member-name">${member.lineName}</div>
                                  <div class="member-details">
                                      ÁúüÂØ¶ÂßìÂêç: ${member.realName} | 
                                      ${member.registeredAt ? 'Â∑≤Ë®ªÂÜä (' + new Date(member.registeredAt).toLocaleDateString('zh-TW') + ')' : 'Êú™Ë®ªÂÜä'}
                                  </div>
                              </div>
                              <div class="order-badge">${member.orderCount} Á≠ÜË®ÇÂñÆ</div>
                          </div>
                      `).join('');
                  })
                  .catch(error => {
                      console.error('ÊêúÂ∞ãÊúÉÂì°Â§±Êïó:', error);
                      resultsDiv.innerHTML = `<div class="alert alert-danger">ÊêúÂ∞ãÂ§±Êïó: ${error.message}</div>`;
                  });
          }
      }

      // ÈÅ∏ÊìáÊúÉÂì°
      function selectMember(lineName) {
          currentMemberName = lineName;
          document.getElementById('selectedMemberName').textContent = `${lineName} ÁöÑË®ÇÂñÆ`;
          
          loadMemberOrders(lineName);
          
          // Èö±ËóèÊêúÂ∞ãÁµêÊûúÔºåÈ°ØÁ§∫Ë®ÇÂñÆÂçÄÂüü
          document.getElementById('searchResults').innerHTML = '';
          document.getElementById('memberOrdersSection').style.display = 'block';
      }

      // // ËºâÂÖ•ÊúÉÂì°Ë®ÇÂñÆ
      // function loadMemberOrders(lineName) {
      //     callAPI('admin-get-member-orders', { lineName: lineName })
      //         .then(result => {
      //             const { memberInfo, orders, payments, summary } = result;
                  
      //             // È°ØÁ§∫ÊúÉÂì°Ë≥áË®ä
      //             const memberInfoDiv = document.getElementById('memberInfo');
      //             memberInfoDiv.innerHTML = `
      //                 <div class="summary-row">
      //                     <span>ÊúÉÂì°ÂßìÂêç:</span>
      //                     <span>${memberInfo ? memberInfo.realName : 'Êú™Ë®ªÂÜä'}</span>
      //                 </div>
      //                 <div class="summary-row">
      //                     <span>LINEÂêçÁ®±:</span>
      //                     <span>${lineName}</span>
      //                 </div>
      //                 ${memberInfo ? `
      //                 <div class="summary-row">
      //                     <span>Ë®ªÂÜäÊôÇÈñì:</span>
      //                     <span>${new Date(memberInfo.registeredAt).toLocaleString('zh-TW')}</span>
      //                 </div>
      //                 ` : ''}
      //             `;
                  
      //             // È°ØÁ§∫Ë®ÇÂñÆÂàóË°®
      //             const tbody = document.getElementById('memberOrdersTableBody');
      //             if (orders.length === 0) {
      //                 tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">Êö´ÁÑ°Ë®ÇÂñÆË®òÈåÑ</td></tr>';
      //             } else {
      //                 tbody.innerHTML = orders.map(order => `
      //                     <tr>
      //                         <td>${order.productCode}</td>
      //                         <td>${order.productName}</td>
      //                         <td>${order.quantity}</td>
      //                         <td>NT$ ${parseFloat(order.unitPrice).toLocaleString()}</td>
      //                         <td>NT$ ${parseFloat(order.totalPrice).toLocaleString()}</td>
      //                         <td>
      //                             <button class="btn btn-warning" onclick="editOrder(${order.rowIndex})">Á∑®ËºØ</button>
      //                             <button class="btn btn-danger" onclick="deleteOrder(${order.rowIndex})">Âà™Èô§</button>
      //                         </td>
      //                     </tr>
      //                 `).join('');
      //             }
                  
      //             // È°ØÁ§∫Ë®ÇÂñÆÊëòË¶Å
      //             const summaryDiv = document.getElementById('orderSummary');
      //             summaryDiv.innerHTML = `
      //                 <div class="summary-row">
      //                     <span>Ë®ÇÂñÆÈ†ÖÁõÆ:</span>
      //                     <span>${summary.orderCount} È†Ö</span>
      //                 </div>
      //                 <div class="summary-row summary-total">
      //                     <span>Á∏ΩÈáëÈ°ç:</span>
      //                     <span>NT$ ${summary.totalAmount.toLocaleString()}</span>
      //                 </div>
      //             `;
                  
      //             // È°ØÁ§∫Áπ≥Ë≤ªË®òÈåÑ
      //             const paymentTbody = document.getElementById('paymentHistoryTableBody');
      //             if (payments.length === 0) {
      //                 paymentTbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">Êö´ÁÑ°Áπ≥Ë≤ªË®òÈåÑ</td></tr>';
      //             } else {
      //                 paymentTbody.innerHTML = payments.map(payment => `
      //                     <tr>
      //                         <td>${payment.paymentId}</td>
      //                         <td>NT$ ${parseFloat(payment.paymentAmount).toLocaleString()}</td>
      //                         <td>${payment.paymentMethod}</td>
      //                         <td>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</td>
      //                         <td><span class="status-badge status-${payment.status === 'Â∑≤Á¢∫Ë™ç' ? 'approved' : payment.status === 'Â∑≤ÊãíÁµï' ? 'rejected' : 'pending'}">${payment.status}</span></td>
      //                     </tr>
      //                 `).join('');
      //             }
      //         })
      //         .catch(error => {
      //             console.error('ËºâÂÖ•ÊúÉÂì°Ë®ÇÂñÆÂ§±Êïó:', error);
      //             showAlert('ËºâÂÖ•ÊúÉÂì°Ë®ÇÂñÆÂ§±Êïó: ' + error.message, 'danger');
      //         });
      // }

      // Á∑®ËºØË®ÇÂñÆ
      function editOrder(rowIndex) {
          currentRowIndex = rowIndex;
          
          // ÂèñÂæóÁï∂ÂâçË®ÇÂñÆË≥áÊñô
          const row = document.querySelector(`#memberOrdersTableBody tr:nth-child(${rowIndex - 1})`);
          if (!row) return;
          
          const cells = row.cells;
          document.getElementById('editLineName').value = currentMemberName;
          document.getElementById('editProductCode').value = cells[0].textContent;
          document.getElementById('editProductName').value = cells[1].textContent;
          document.getElementById('editQuantity').value = cells[2].textContent;
          document.getElementById('editUnitPrice').value = cells[3].textContent.replace('NT$ ', '').replace(/,/g, '');
          document.getElementById('editTotalPrice').value = cells[4].textContent.replace('NT$ ', '').replace(/,/g, '');
          
          document.getElementById('editOrderTitle').textContent = 'Á∑®ËºØË®ÇÂñÆ';
          document.getElementById('editOrderModal').style.display = 'block';
      }

      // Êñ∞Â¢ûË®ÇÂñÆ
      function addNewOrder() {
          currentRowIndex = null;
          
          document.getElementById('editLineName').value = currentMemberName;
          document.getElementById('editProductCode').value = '';
          document.getElementById('editProductName').value = '';
          document.getElementById('editQuantity').value = '1';
          document.getElementById('editUnitPrice').value = '0';
          document.getElementById('editTotalPrice').value = '0';
          
          document.getElementById('editOrderTitle').textContent = 'Êñ∞Â¢ûË®ÇÂñÆ';
          document.getElementById('editOrderModal').style.display = 'block';
      }

      // Ë®àÁÆóÁ∏ΩÂÉπ
      function calculateTotal() {
          const quantity = parseFloat(document.getElementById('editQuantity').value) || 0;
          const unitPrice = parseFloat(document.getElementById('editUnitPrice').value) || 0;
          const total = quantity * unitPrice;
          document.getElementById('editTotalPrice').value = total.toFixed(2);
      }

      // ÂÑ≤Â≠òË®ÇÂñÆ
      function saveOrder() {
          const orderData = {
              lineName: document.getElementById('editLineName').value,
              productCode: document.getElementById('editProductCode').value,
              productName: document.getElementById('editProductName').value,
              quantity: parseFloat(document.getElementById('editQuantity').value),
              unitPrice: parseFloat(document.getElementById('editUnitPrice').value)
          };
          
          if (!orderData.lineName || !orderData.productCode || !orderData.productName || 
              !orderData.quantity || !orderData.unitPrice) {
              showAlert('Ë´ãÂ°´ÂØ´ÊâÄÊúâÂøÖË¶ÅÊ¨Ñ‰Ωç', 'warning');
              return;
          }
          
          const action = currentRowIndex ? 'admin-update-member-order' : 'admin-add-member-order';
          const data = currentRowIndex ? 
              { rowIndex: currentRowIndex, orderData: orderData } : 
              { orderData: orderData };
          
          callAPI(action, data)
              .then(result => {
                  showAlert(result.message, 'success');
                  closeModal('editOrderModal');
                  loadMemberOrders(currentMemberName);
              })
              .catch(error => {
                  console.error('ÂÑ≤Â≠òË®ÇÂñÆÂ§±Êïó:', error);
                  showAlert('ÂÑ≤Â≠òË®ÇÂñÆÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      // Âà™Èô§Ë®ÇÂñÆ
      function deleteOrder(rowIndex) {
          if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜË®ÇÂñÆÂóéÔºü')) return;
          
          callAPI('admin-delete-member-order', { rowIndex: rowIndex })
              .then(result => {
                  showAlert(result.message, 'success');
                  loadMemberOrders(currentMemberName);
              })
              .catch(error => {
                  console.error('Âà™Èô§Ë®ÇÂñÆÂ§±Êïó:', error);
                  showAlert('Âà™Èô§Ë®ÇÂñÆÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      // È°ØÁ§∫ÂØ©Ê†∏Ê®°ÊÖãÊ°Ü
      function showReviewModal(paymentId) {
          currentPaymentId = paymentId;
          
          // ÂèñÂæóÁπ≥Ë≤ªË©≥Á¥∞Ë≥áË®ä
          callAPI('admin-get-all-payments')
              .then(result => {
                  const payment = result.payments.find(p => p.paymentId === paymentId);
                  if (!payment) {
                      showAlert('Êâæ‰∏çÂà∞Áπ≥Ë≤ªË®òÈåÑ', 'danger');
                      return;
                  }
                  
                  document.getElementById('reviewPaymentInfo').innerHTML = `
                      <div class="order-summary">
                          <div class="summary-row">
                              <span>Áπ≥Ë≤ªÁ∑®Ëôü:</span>
                              <span>${payment.paymentId}</span>
                          </div>
                          <div class="summary-row">
                              <span>ÊúÉÂì°ÂßìÂêç:</span>
                              <span>${payment.realName}</span>
                          </div>
                          <div class="summary-row">
                              <span>Áπ≥Ë≤ªÈáëÈ°ç:</span>
                              <span>NT$ ${parseFloat(payment.paymentAmount).toLocaleString()}</span>
                          </div>
                          <div class="summary-row">
                              <span>Áπ≥Ë≤ªÊñπÂºè:</span>
                              <span>${payment.paymentMethod}</span>
                          </div>
                          <div class="summary-row">
                              <span>Êèê‰∫§ÊôÇÈñì:</span>
                              <span>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</span>
                          </div>
                          ${payment.paymentNote ? `
                          <div class="summary-row">
                              <span>Áî®Êà∂ÂÇôË®ª:</span>
                              <span>${payment.paymentNote}</span>
                          </div>
                          ` : ''}
                      </div>
                  `;
                  
                  document.getElementById('reviewStatus').value = 'Â∑≤Á¢∫Ë™ç';
                  document.getElementById('reviewNote').value = '';
                  document.getElementById('reviewModal').style.display = 'block';
              })
              .catch(error => {
                  console.error('ËºâÂÖ•Áπ≥Ë≤ªË©≥ÊÉÖÂ§±Êïó:', error);
                  showAlert('ËºâÂÖ•Áπ≥Ë≤ªË©≥ÊÉÖÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      // Êèê‰∫§ÂØ©Ê†∏
      function submitReview() {
          const status = document.getElementById('reviewStatus').value;
          const reviewNote = document.getElementById('reviewNote').value;
          
          callAPI('admin-review-payment', {
              paymentId: currentPaymentId,
              status: status,
              reviewNote: reviewNote
          })
              .then(result => {
                  showAlert(result.message, 'success');
                  closeModal('reviewModal');
                  loadPendingPayments();
                  loadDashboard();
              })
              .catch(error => {
                  console.error('ÂØ©Ê†∏Â§±Êïó:', error);
                  showAlert('ÂØ©Ê†∏Â§±Êïó: ' + error.message, 'danger');
              });
      }

      // ÂÖ®ÈÅ∏/ÂèñÊ∂àÂÖ®ÈÅ∏
      function toggleSelectAll() {
          const selectAll = document.getElementById('selectAll');
          const checkboxes = document.querySelectorAll('.payment-checkbox');
          
          checkboxes.forEach(checkbox => {
              checkbox.checked = selectAll.checked;
          });
          
          updateSelectedPayments();
      }

      // Êõ¥Êñ∞ÈÅ∏‰∏≠ÁöÑÁπ≥Ë≤ªË®òÈåÑ
      function updateSelectedPayments() {
          selectedPaymentIds = Array.from(document.querySelectorAll('.payment-checkbox:checked'))
              .map(checkbox => checkbox.value);
      }

      // È°ØÁ§∫ÊâπÈáèÂØ©Ê†∏
      function showBatchReview(status) {
          updateSelectedPayments();
          
          if (selectedPaymentIds.length === 0) {
              showAlert('Ë´ãÂÖàÈÅ∏ÊìáË¶ÅÂØ©Ê†∏ÁöÑË®òÈåÑ', 'warning');
              return;
          }
          
          batchReviewStatus = status;
          
          document.getElementById('batchReviewInfo').innerHTML = `
              <div class="alert alert-warning">
                  <strong>ÊâπÈáèÂØ©Ê†∏Á¢∫Ë™ç</strong><br>
                  ÊÇ®Âç≥Â∞áÂ∞á <strong>${selectedPaymentIds.length}</strong> Á≠ÜÁπ≥Ë≤ªË®òÈåÑÊ®ôË®òÁÇ∫ <strong>${status}</strong>
              </div>
          `;
          
          document.getElementById('batchReviewNote').value = '';
          document.getElementById('batchReviewModal').style.display = 'block';
      }

      // Êèê‰∫§ÊâπÈáèÂØ©Ê†∏
      function submitBatchReview() {
          const reviewNote = document.getElementById('batchReviewNote').value;
          
          callAPI('admin-batch-review', {
              paymentIds: selectedPaymentIds,
              status: batchReviewStatus,
              reviewNote: reviewNote
          })
              .then(result => {
                  showAlert(result.message, 'success');
                  closeModal('batchReviewModal');
                  loadPendingPayments();
                  loadDashboard();
                  
                  // Ê∏ÖÈô§ÈÅ∏Êìá
                  document.getElementById('selectAll').checked = false;
                  selectedPaymentIds = [];
              })
              .catch(error => {
                  console.error('ÊâπÈáèÂØ©Ê†∏Â§±Êïó:', error);
                  showAlert('ÊâπÈáèÂØ©Ê†∏Â§±Êïó: ' + error.message, 'danger');
              });
      }

      // ÁîüÊàêÊó•Â†±Ë°®
      function generateDailyReport() {
          const targetDate = document.getElementById('reportDate').value;
          if (!targetDate) {
              showAlert('Ë´ãÈÅ∏ÊìáÊó•Êúü', 'warning');
              return;
          }
          
          const reportContent = document.getElementById('reportContent');
          reportContent.innerHTML = '<div class="loading"><div class="spinner"></div>ÁîüÊàêÂ†±Ë°®‰∏≠...</div>';
          
          callAPI('admin-get-daily-report', { targetDate: targetDate })
              .then(result => {
                  const report = result.report;
                  
                  reportContent.innerHTML = `
                      <div class="order-summary">
                          <h3>üìÖ ${report.date} Êó•Â†±Ë°®</h3>
                          
                          <div class="stats-grid" style="margin: 1rem 0;">
                              <div class="stat-card">
                                  <div class="stat-number">${report.newRegistrations}</div>
                                  <div class="stat-label">Êñ∞Ë®ªÂÜäÊúÉÂì°</div>
                              </div>
                              <div class="stat-card">
                                  <div class="stat-number">${report.newPayments}</div>
                                  <div class="stat-label">Êñ∞Áπ≥Ë≤ªË®òÈåÑ</div>
                              </div>
                              <div class="stat-card">
                                  <div class="stat-number">${report.approvedPayments}</div>
                                  <div class="stat-label">ÂØ©Ê†∏ÈÄöÈÅé</div>
                              </div>
                              <div class="stat-card">
                                  <div class="stat-number">NT$ ${report.totalAmount.toLocaleString()}</div>
                                  <div class="stat-label">Á¢∫Ë™çÈáëÈ°ç</div>
                              </div>
                          </div>
                          
                          ${report.details.registrations.length > 0 ? `
                          <h4>üÜï Êñ∞Ë®ªÂÜäÊúÉÂì°</h4>
                          <div class="table-container">
                              <table>
                                  <thead>
                                      <tr><th>ÁúüÂØ¶ÂßìÂêç</th><th>LINEÂêçÁ®±</th><th>Ë®ªÂÜäÊôÇÈñì</th></tr>
                                  </thead>
                                  <tbody>
                                      ${report.details.registrations.map(reg => `
                                          <tr>
                                              <td>${reg.realName}</td>
                                              <td>${reg.lineDisplayName}</td>
                                              <td>${new Date(reg.registeredAt).toLocaleString('zh-TW')}</td>
                                          </tr>
                                      `).join('')}
                                  </tbody>
                              </table>
                          </div>
                          ` : ''}
                          
                          ${report.details.approvedPayments.length > 0 ? `
                          <h4>‚úÖ ÂØ©Ê†∏ÈÄöÈÅéÁπ≥Ë≤ª</h4>
                          <div class="table-container">
                              <table>
                                  <thead>
                                      <tr><th>Áπ≥Ë≤ªÁ∑®Ëôü</th><th>ÊúÉÂì°ÂßìÂêç</th><th>ÈáëÈ°ç</th></tr>
                                  </thead>
                                  <tbody>
                                      ${report.details.approvedPayments.map(payment => `
                                          <tr>
                                              <td>${payment.paymentId}</td>
                                              <td>${payment.realName}</td>
                                              <td>NT$ ${parseFloat(payment.paymentAmount).toLocaleString()}</td>
                                          </tr>
                                      `).join('')}
                                  </tbody>
                              </table>
                          </div>
                          ` : ''}
                      </div>
                  `;
              })
              .catch(error => {
                  console.error('ÁîüÊàêÊó•Â†±Ë°®Â§±Êïó:', error);
                  reportContent.innerHTML = `<div class="alert alert-danger">ÁîüÊàêÂ†±Ë°®Â§±Êïó: ${error.message}</div>`;
              });
      }

      // ÂåØÂá∫ÊâÄÊúâË≥áÊñô
      function exportAllData() {
          callAPI('admin-export-data')
              .then(result => {
                  const dataStr = JSON.stringify(result.data, null, 2);
                  const dataBlob = new Blob([dataStr], {type: 'application/json'});
                  const url = URL.createObjectURL(dataBlob);
                  const link = document.createElement('a');
                  link.href = url;
                  link.download = `system_export_${new Date().toISOString().split('T')[0]}.json`;
                  link.click();
                  URL.revokeObjectURL(url);
                  
                  showAlert('Ë≥áÊñôÂåØÂá∫ÊàêÂäü', 'success');
              })
              .catch(error => {
                  console.error('ÂåØÂá∫Ë≥áÊñôÂ§±Êïó:', error);
                  showAlert('ÂåØÂá∫Ë≥áÊñôÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      // Ê∏ÖÁêÜÊ∏¨Ë©¶Ë≥áÊñô
      function cleanupTestData() {
          if (!confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁêÜÊâÄÊúâÊ∏¨Ë©¶Ë≥áÊñôÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ')) return;
          
          callAPI('admin-cleanup-test-data')
              .then(result => {
                  showAlert(result.message, 'success');
                  loadDashboard();
              })
              .catch(error => {
                  console.error('Ê∏ÖÁêÜÊ∏¨Ë©¶Ë≥áÊñôÂ§±Êïó:', error);
                  showAlert('Ê∏ÖÁêÜÊ∏¨Ë©¶Ë≥áÊñôÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      // Á≥ªÁµ±Á∂≠Ë≠∑ÂäüËÉΩ
      function initializeSystem() {
          callAPI('admin-initialize-system')
              .then(result => {
                  showAlert(result.message, 'success');
                  updateSystemStatus(result.details);
              })
              .catch(error => {
                  console.error('Á≥ªÁµ±ÂàùÂßãÂåñÂ§±Êïó:', error);
                  showAlert('Á≥ªÁµ±ÂàùÂßãÂåñÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      function setupTriggers() {
          callAPI('admin-setup-triggers')
              .then(result => {
                  showAlert(result.message, 'success');
              })
              .catch(error => {
                  console.error('Ë®≠ÂÆöËß∏ÁôºÂô®Â§±Êïó:', error);
                  showAlert('Ë®≠ÂÆöËß∏ÁôºÂô®Â§±Êïó: ' + error.message, 'danger');
              });
      }

      function cleanupOldLogs() {
          callAPI('admin-cleanup-old-logs')
              .then(result => {
                  showAlert(result.message, 'success');
              })
              .catch(error => {
                  console.error('Ê∏ÖÁêÜÊó•Ë™åÂ§±Êïó:', error);
                  showAlert('Ê∏ÖÁêÜÊó•Ë™åÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      function checkSystemHealth() {
          callAPI('admin-check-system-health')
              .then(result => {
                  updateSystemStatus([`Á≥ªÁµ±ÁãÄÊÖã: ${result.health.status}`]);
                  showAlert('Á≥ªÁµ±ÂÅ•Â∫∑Ê™¢Êü•ÂÆåÊàê', 'success');
              })
              .catch(error => {
                  console.error('Á≥ªÁµ±ÂÅ•Â∫∑Ê™¢Êü•Â§±Êïó:', error);
                  showAlert('Á≥ªÁµ±ÂÅ•Â∫∑Ê™¢Êü•Â§±Êïó: ' + error.message, 'danger');
              });
      }

      function backupData() {
          const backupSpreadsheetId = document.getElementById('backupSpreadsheetId').value.trim();
          if (!backupSpreadsheetId) {
              showAlert('Ë´ãËº∏ÂÖ•ÂÇô‰ªΩË©¶ÁÆóË°® ID', 'warning');
              return;
          }
          
          callAPI('admin-backup-data', { backupSpreadsheetId: backupSpreadsheetId })
              .then(result => {
                  showAlert(result.message, 'success');
              })
              .catch(error => {
                  console.error('ÂÇô‰ªΩË≥áÊñôÂ§±Êïó:', error);
                  showAlert('ÂÇô‰ªΩË≥áÊñôÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      // Êõ¥Êñ∞Á≥ªÁµ±ÁãÄÊÖãÈ°ØÁ§∫
      function updateSystemStatus(details) {
          const statusDiv = document.getElementById('systemStatus');
          statusDiv.innerHTML = `
              <div class="alert alert-success">
                  <h4>Á≥ªÁµ±ÁãÄÊÖã</h4>
                  <ul>
                      ${details.map(detail => `<li>${detail}</li>`).join('')}
                  </ul>
              </div>
          `;
      }

      // Â∑•ÂÖ∑ÂáΩÊï∏
      function closeModal(modalId) {
          document.getElementById(modalId).style.display = 'none';
      }

      function showAlert(message, type = 'info') {
          const alertDiv = document.createElement('div');
          alertDiv.className = `alert alert-${type}`;
          alertDiv.textContent = message;
          alertDiv.style.position = 'fixed';
          alertDiv.style.top = '20px';
          alertDiv.style.right = '20px';
          alertDiv.style.zIndex = '9999';
          alertDiv.style.minWidth = '300px';
          
          document.body.appendChild(alertDiv);
          
          setTimeout(() => {
              alertDiv.remove();
          }, 5000);
      }

      // ÈªûÊìäÊ®°ÊÖãÊ°ÜÂ§ñÈÉ®ÈóúÈñâ
      window.onclick = function(event) {
          const modals = document.querySelectorAll('.modal');
          modals.forEach(modal => {
              if (event.target === modal) {
                  modal.style.display = 'none';
              }
          });
      }

      // Áõ£ËÅΩË§áÈÅ∏Ê°ÜËÆäÂåñ
      document.addEventListener('change', function(event) {
          if (event.target.classList.contains('payment-checkbox')) {
              updateSelectedPayments();
          }
      });

            // ËºâÂÖ•ÊúÉÂì°Ë®ÇÂñÆÔºà‰øÆÊîπÁâàÔºâ
      function loadMemberOrders(lineName) {
          callAPI('admin-get-member-orders', { lineName: lineName })
              .then(result => {
                  const { memberInfo, consolidatedOrders, rawOrders, payments, summary } = result;
                  
                  // È°ØÁ§∫ÊúÉÂì°Ë≥áË®ä
                  const memberInfoDiv = document.getElementById('memberInfo');
                  memberInfoDiv.innerHTML = `
                      <div class="summary-row">
                          <span>ÊúÉÂì°ÂßìÂêç:</span>
                          <span>${memberInfo ? memberInfo.realName : 'Êú™Ë®ªÂÜä'}</span>
                      </div>
                      <div class="summary-row">
                          <span>LINEÂêçÁ®±:</span>
                          <span>${lineName}</span>
                      </div>
                      ${memberInfo ? `
                      <div class="summary-row">
                          <span>Ë®ªÂÜäÊôÇÈñì:</span>
                          <span>${new Date(memberInfo.registeredAt).toLocaleString('zh-TW')}</span>
                      </div>
                      ` : ''}
                  `;
                  
                  // È°ØÁ§∫Âêà‰ΩµÂæåÁöÑË®ÇÂñÆÂàóË°®
                  const tbody = document.getElementById('memberOrdersTableBody');
                  if (consolidatedOrders.length === 0) {
                      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">Êö´ÁÑ°Ë®ÇÂñÆË®òÈåÑ</td></tr>';
                  } else {
                      tbody.innerHTML = consolidatedOrders.map(order => `
                          <tr ${order.priceVariation ? 'style="background-color: #fff3cd;"' : ''}>
                              <td>
                                  ${order.productCode}
                                  ${order.priceVariation ? '<br><small style="color: #856404;">‚ö†Ô∏è ÂÉπÊ†ºËÆäÂãï</small>' : ''}
                              </td>
                              <td>${order.productName}</td>
                              <td>
                                  ${order.quantity}
                                  ${order.rowIndexes.length > 1 ? `<br><small style="color: #666;">(${order.rowIndexes.length} Á≠ÜÂêà‰Ωµ)</small>` : ''}
                              </td>
                              <td>
                                  NT$ ${parseFloat(order.unitPrice).toLocaleString()}
                                  ${order.priceVariation ? '<br><small style="color: #856404;">Âπ≥ÂùáÂñÆÂÉπ</small>' : ''}
                              </td>
                              <td>NT$ ${parseFloat(order.totalPrice).toLocaleString()}</td>
                              <td>
                                  <button class="btn btn-primary" onclick="showOrderDetails('${order.productCode}')">üìã Ë©≥Á¥∞</button>
                                  <button class="btn btn-warning" onclick="editConsolidatedOrder('${order.productCode}')">‚úèÔ∏è Á∑®ËºØ</button>
                              </td>
                          </tr>
                      `).join('');
                  }
                  
                  // È°ØÁ§∫Ë®ÇÂñÆÊëòË¶Å
                  const summaryDiv = document.getElementById('orderSummary');
                  summaryDiv.innerHTML = `
                      <div class="summary-row">
                          <span>ÂéüÂßãË®ÇÂñÆÈ†ÖÁõÆ:</span>
                          <span>${summary.rawOrderCount} È†Ö</span>
                      </div>
                      <div class="summary-row">
                          <span>Âêà‰ΩµÂæåÈ†ÖÁõÆ:</span>
                          <span>${summary.consolidatedOrderCount} È†Ö</span>
                      </div>
                      <div class="summary-row summary-total">
                          <span>Á∏ΩÈáëÈ°ç:</span>
                          <span>NT$ ${summary.totalAmount.toLocaleString()}</span>
                      </div>
                  `;
                  
                  // È°ØÁ§∫Áπ≥Ë≤ªË®òÈåÑ
                  const paymentTbody = document.getElementById('paymentHistoryTableBody');
                  if (payments.length === 0) {
                      paymentTbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">Êö´ÁÑ°Áπ≥Ë≤ªË®òÈåÑ</td></tr>';
                  } else {
                      paymentTbody.innerHTML = payments.map(payment => `
                          <tr>
                              <td>${payment.paymentId}</td>
                              <td>NT$ ${parseFloat(payment.paymentAmount).toLocaleString()}</td>
                              <td>${payment.paymentMethod}</td>
                              <td>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</td>
                              <td><span class="status-badge status-${payment.status === 'Â∑≤Á¢∫Ë™ç' ? 'approved' : payment.status === 'Â∑≤ÊãíÁµï' ? 'rejected' : 'pending'}">${payment.status}</span></td>
                          </tr>
                      `).join('');
                  }
                  
                  // ÂÑ≤Â≠òÂéüÂßãË®ÇÂñÆË≥áÊñô‰æõÁ∑®ËºØ‰ΩøÁî®
                  window.currentRawOrders = rawOrders;
                  window.currentConsolidatedOrders = consolidatedOrders;
              })
              .catch(error => {
                  console.error('ËºâÂÖ•ÊúÉÂì°Ë®ÇÂñÆÂ§±Êïó:', error);
                  showAlert('ËºâÂÖ•ÊúÉÂì°Ë®ÇÂñÆÂ§±Êïó: ' + error.message, 'danger');
              });
      }

      // È°ØÁ§∫Ë®ÇÂñÆË©≥Á¥∞Ë≥áË®ä
      function showOrderDetails(productCode) {
          const consolidatedOrder = window.currentConsolidatedOrders.find(order => order.productCode === productCode);
          const relatedRawOrders = window.currentRawOrders.filter(order => order.productCode === productCode);
          
          if (!consolidatedOrder || !relatedRawOrders) {
              showAlert('Êâæ‰∏çÂà∞Ë®ÇÂñÆË©≥Á¥∞Ë≥áË®ä', 'danger');
              return;
          }
          
          let detailsHtml = `
              <div class="modal" id="orderDetailsModal" style="display: block;">
                  <div class="modal-content">
                      <div class="modal-header">
                          <h3>üìã ${consolidatedOrder.productName} - Ë®ÇÂñÆË©≥Á¥∞</h3>
                          <button class="close" onclick="closeModal('orderDetailsModal')">&times;</button>
                      </div>
                      
                      <div class="order-summary">
                          <div class="summary-row">
                              <span>Áî¢ÂìÅ‰ª£Ëôü:</span>
                              <span>${consolidatedOrder.productCode}</span>
                          </div>
                          <div class="summary-row">
                              <span>Áî¢ÂìÅÂêçÁ®±:</span>
                              <span>${consolidatedOrder.productName}</span>
                          </div>
                          <div class="summary-row">
                              <span>Âêà‰ΩµÂæåÊï∏Èáè:</span>
                              <span>${consolidatedOrder.quantity}</span>
                          </div>
                          <div class="summary-row">
                              <span>Âπ≥ÂùáÂñÆÂÉπ:</span>
                              <span>NT$ ${parseFloat(consolidatedOrder.unitPrice).toLocaleString()}</span>
                          </div>
                          <div class="summary-row summary-total">
                              <span>ÂêàË®àÈáëÈ°ç:</span>
                              <span>NT$ ${parseFloat(consolidatedOrder.totalPrice).toLocaleString()}</span>
                          </div>
                      </div>
                      
                      <h4>üìù ÂéüÂßãË®ÇÂñÆÊòéÁ¥∞</h4>
                      <div class="table-container">
                          <table>
                              <thead>
                                  <tr>
                                      <th>Êï∏Èáè</th>
                                      <th>ÂñÆÂÉπ</th>
                                      <th>Â∞èË®à</th>
                                      <th>Êìç‰Ωú</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${relatedRawOrders.map(order => `
                                      <tr>
                                          <td>${order.quantity}</td>
                                          <td>NT$ ${parseFloat(order.unitPrice).toLocaleString()}</td>
                                          <td>NT$ ${parseFloat(order.totalPrice).toLocaleString()}</td>
                                          <td>
                                              <button class="btn btn-warning" onclick="editOrder(${order.rowIndex}); closeModal('orderDetailsModal')">Á∑®ËºØ</button>
                                              <button class="btn btn-danger" onclick="deleteOrder(${order.rowIndex}); closeModal('orderDetailsModal')">Âà™Èô§</button>
                                          </td>
                                      </tr>
                                  `).join('')}
                              </tbody>
                          </table>
                      </div>
                      
                      <div style="text-align: right; margin-top: 1rem;">
                          <button class="btn btn-secondary" onclick="closeModal('orderDetailsModal')">ÈóúÈñâ</button>
                      </div>
                  </div>
              </div>
          `;
          
          // ÁßªÈô§ÁèæÊúâÁöÑË©≥Á¥∞Ê®°ÊÖãÊ°ÜÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
          const existingModal = document.getElementById('orderDetailsModal');
          if (existingModal) {
              existingModal.remove();
          }
          
          // Ê∑ªÂä†Êñ∞ÁöÑË©≥Á¥∞Ê®°ÊÖãÊ°Ü
          document.body.insertAdjacentHTML('beforeend', detailsHtml);
      }

      // Á∑®ËºØÂêà‰ΩµË®ÇÂñÆÔºàÈ°ØÁ§∫Ë©≤Áî¢ÂìÅÁöÑÊâÄÊúâÂéüÂßãË®ÇÂñÆÔºâ
      function editConsolidatedOrder(productCode) {
          const relatedRawOrders = window.currentRawOrders.filter(order => order.productCode === productCode);
          
          if (!relatedRawOrders || relatedRawOrders.length === 0) {
              showAlert('Êâæ‰∏çÂà∞Áõ∏ÈóúË®ÇÂñÆ', 'danger');
              return;
          }
          
          // Â¶ÇÊûúÂè™Êúâ‰∏ÄÁ≠ÜË®ÇÂñÆÔºåÁõ¥Êé•Á∑®ËºØ
          if (relatedRawOrders.length === 1) {
              editOrder(relatedRawOrders[0].rowIndex);
              return;
          }
          
          // Â¶ÇÊûúÊúâÂ§öÁ≠ÜË®ÇÂñÆÔºåÈ°ØÁ§∫ÈÅ∏Êìá‰ªãÈù¢
          let editOptionsHtml = `
              <div class="modal" id="editOptionsModal" style="display: block;">
                  <div class="modal-content">
                      <div class="modal-header">
                          <h3>‚úèÔ∏è ÈÅ∏ÊìáË¶ÅÁ∑®ËºØÁöÑË®ÇÂñÆ</h3>
                          <button class="close" onclick="closeModal('editOptionsModal')">&times;</button>
                      </div>
                      
                      <p>Ê≠§Áî¢ÂìÅÊúâ ${relatedRawOrders.length} Á≠ÜË®ÇÂñÆÔºåË´ãÈÅ∏ÊìáË¶ÅÁ∑®ËºØÁöÑÈ†ÖÁõÆÔºö</p>
                      
                      <div class="table-container">
                          <table>
                              <thead>
                                  <tr>
                                      <th>Êï∏Èáè</th>
                                      <th>ÂñÆÂÉπ</th>
                                      <th>Â∞èË®à</th>
                                      <th>Êìç‰Ωú</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${relatedRawOrders.map((order, index) => `
                                      <tr>
                                          <td>${order.quantity}</td>
                                          <td>NT$ ${parseFloat(order.unitPrice).toLocaleString()}</td>
                                          <td>NT$ ${parseFloat(order.totalPrice).toLocaleString()}</td>
                                          <td>
                                              <button class="btn btn-warning" onclick="editOrder(${order.rowIndex}); closeModal('editOptionsModal')">Á∑®ËºØÊ≠§È†Ö</button>
                                          </td>
                                      </tr>
                                  `).join('')}
                              </tbody>
                          </table>
                      </div>
                      
                      <div style="text-align: right; margin-top: 1rem;">
                          <button class="btn btn-primary" onclick="addNewOrder(); closeModal('editOptionsModal')">‚ûï Êñ∞Â¢ûÂêåÁî¢ÂìÅË®ÇÂñÆ</button>
                          <button class="btn btn-secondary" onclick="closeModal('editOptionsModal')">ÂèñÊ∂à</button>
                      </div>
                  </div>
              </div>
          `;
          
          // ÁßªÈô§ÁèæÊúâÁöÑÈÅ∏È†ÖÊ®°ÊÖãÊ°ÜÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
          const existingModal = document.getElementById('editOptionsModal');
          if (existingModal) {
              existingModal.remove();
          }
          
          // Ê∑ªÂä†Êñ∞ÁöÑÈÅ∏È†ÖÊ®°ÊÖãÊ°Ü
          document.body.insertAdjacentHTML('beforeend', editOptionsHtml);
      }

      // ‰øÆÊîπË®ÇÂñÆË°®Ê†ºÊ®ôÈ°å
      function updateOrderTableHeader() {
          const tableHeader = document.querySelector('#memberOrdersTable thead tr');
          if (tableHeader) {
              tableHeader.innerHTML = `
                  <th>Áî¢ÂìÅ‰ª£Ëôü</th>
                  <th>Áî¢ÂìÅÂêçÁ®±</th>
                  <th>Âêà‰ΩµÊï∏Èáè</th>
                  <th>Âπ≥ÂùáÂñÆÂÉπ</th>
                  <th>ÂêàË®àÈáëÈ°ç</th>
                  <th>Êìç‰Ωú</th>
              `;
          }
      }

      // Âú®È†ÅÈù¢ËºâÂÖ•ÊôÇÊõ¥Êñ∞Ë°®Ê†ºÊ®ôÈ°å
      document.addEventListener('DOMContentLoaded', function() {
          // Âª∂ÈÅ≤Âü∑Ë°å‰ª•Á¢∫‰øù DOM Â∑≤ÂÆåÂÖ®ËºâÂÖ•
          setTimeout(updateOrderTableHeader, 100);
      });
  </script>
</body>
</html>
