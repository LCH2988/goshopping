<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>訂購系統管理後台</title>
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .header {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: 30px;
        text-align: center;
    }
    
    .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
    }
    
    .nav-tabs {
        display: flex;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    
    .nav-tab {
        flex: 1;
        padding: 15px 20px;
        text-align: center;
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: #6c757d;
        transition: all 0.3s ease;
    }
    
    .nav-tab.active {
        background: white;
        color: #667eea;
        border-bottom: 3px solid #667eea;
    }
    
    .content {
        padding: 30px;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .stat-number {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 8px;
    }
    
    .stat-label {
        font-size: 14px;
        opacity: 0.9;
    }
    
    .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .table th {
        background: #f8f9fa;
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
    }
    
    .table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
        vertical-align: middle;
    }
    
    .table tr:hover {
        background: #f8f9fa;
    }
    
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
        margin: 2px;
    }
    
    .btn-primary {
        background: #667eea;
        color: white;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-warning {
        background: #ffc107;
        color: #212529;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .status-badge {
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-pending {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-approved {
        background: #d4edda;
        color: #155724;
    }
    
    .status-rejected {
        background: #f8d7da;
        color: #721c24;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #dc3545;
    }
    
    .success {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #28a745;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
    }
    
    .close:hover {
        color: #000;
    }
    
    @media (max-width: 768px) {
        .nav-tabs {
            flex-direction: column;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .table {
            min-width: 600px;
        }
    }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>🛡️ 訂購系統管理後台</h1>
        <p>系統管理 · 繳費審核 · 資料統計</p>
    </div>
    
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('dashboard')">儀表板</button>
        <button class="nav-tab" onclick="switchTab('pending')">待審核</button>
        <button class="nav-tab" onclick="switchTab('payments')">繳費記錄</button>
        <button class="nav-tab" onclick="switchTab('users')">用戶管理</button>
        <button class="nav-tab" onclick="switchTab('reports')">報表</button>
        <button class="nav-tab" onclick="switchTab('settings')">系統設定</button>
    </div>
    
    <div class="content">
        <!-- 儀表板 -->
        <div id="dashboard" class="tab-content active">
            <div id="dashboardStats" class="stats-grid">
                <div class="loading">載入統計資料中...</div>
            </div>
            
            <div class="table-container">
                <h3 style="padding: 20px 20px 0; margin: 0;">最近活動</h3>
                <div id="recentActivity" style="padding: 20px;">
                    <div class="loading">載入最近活動中...</div>
                </div>
            </div>
        </div>
        
        <!-- 待審核 -->
        <div id="pending" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>待審核繳費記錄</h2>
                <div>
                    <button class="btn btn-success" onclick="batchApprove()">批量通過</button>
                    <button class="btn btn-danger" onclick="batchReject()">批量拒絕</button>
                    <button class="btn btn-primary" onclick="loadPendingPayments()">🔄 重新整理</button>
                </div>
            </div>
            
            <div class="table-container">
                <div id="pendingPaymentsTable">
                    <div class="loading">載入待審核記錄中...</div>
                </div>
            </div>
        </div>
        
        <!-- 繳費記錄 -->
        <div id="payments" class="tab-content">
            <h2 style="margin-bottom: 20px;">所有繳費記錄</h2>
            <div class="table-container">
                <div id="allPaymentsTable">
                    <div class="loading">載入繳費記錄中...</div>
                </div>
            </div>
        </div>
        
        <!-- 用戶管理 -->
        <div id="users" class="tab-content">
            <h2 style="margin-bottom: 20px;">用戶管理</h2>
            <div class="table-container">
                <div id="usersTable">
                    <div class="loading">載入用戶資料中...</div>
                </div>
            </div>
        </div>
        
        <!-- 報表 -->
        <div id="reports" class="tab-content">
            <h2 style="margin-bottom: 20px;">系統報表</h2>
            
            <div class="form-group">
                <label for="reportDate">選擇日期</label>
                <input type="date" id="reportDate" value="">
                <button class="btn btn-primary" onclick="generateReport()" style="margin-top: 10px;">
                    生成報表
                </button>
            </div>
            
            <div id="reportContent">
                <div class="loading">請選擇日期並生成報表</div>
            </div>
        </div>
        
        <!-- 系統設定 -->
        <div id="settings" class="tab-content">
            <h2 style="margin-bottom: 20px;">系統設定</h2>
            
            <div style="display: grid; gap: 20px;">
                <div class="table-container" style="padding: 20px;">
                    <h3>資料管理</h3>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-warning" onclick="exportData()">
                            📊 匯出所有資料
                        </button>
                        <button class="btn btn-danger" onclick="cleanupTestData()">
                            🗑️ 清理測試資料
                        </button>
                        <button class="btn btn-primary" onclick="backupData()">
                            💾 備份資料
                        </button>
                    </div>
                </div>
                
                <div class="table-container" style="padding: 20px;">
                    <h3>系統資訊</h3>
                    <div id="systemInfo" style="margin-top: 15px;">
                        <div class="loading">載入系統資訊中...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 審核模態框 -->
<div id="reviewModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>審核繳費記錄</h2>
        <form id="reviewForm">
            <input type="hidden" id="reviewPaymentId">
            
            <div class="form-group">
                <label>繳費資訊</label>
                <div id="reviewPaymentInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                </div>
            </div>
            
            <div class="form-group">
                <label for="reviewStatus">審核結果 *</label>
                <select id="reviewStatus" required>
                    <option value="">請選擇</option>
                    <option value="已確認">通過</option>
                    <option value="已拒絕">拒絕</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="reviewNote">審核備註</label>
                <textarea id="reviewNote" placeholder="請輸入審核備註..." rows="3"></textarea>
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeReviewModal()">取消</button>
                <button type="submit" class="btn btn-primary">確認審核</button>
            </div>
        </form>
    </div>
</div>

<script>
    // 設定區域
    const CONFIG = {
        LIFF_ID: '1657285806-2bmkYWkN',
        API_BASE_URL: 'https://script.google.com/macros/s/AKfycbxpnDW3aFjltZqRMJkWUp1jorgYbHSDTnz8jJsRbPBm4f_JvuJNn-5jmbitVJnSO4Ng/exec',
        DEBUG_MODE: true
    };

    // 全域變數
    let adminUserId = null;
    let adminProfile = null;
    let pendingPayments = [];
    let selectedPayments = [];

    // 初始化
    window.onload = function() {
        initializeLiff();
    };

    async function initializeLiff() {
        try {
            await liff.init({ liffId: CONFIG.LIFF_ID });
            
            if (liff.isLoggedIn()) {
                adminProfile = await liff.getProfile();
                adminUserId = adminProfile.userId;
                
                // 驗證管理者權限
                const authResult = await callAdminAPI('admin-get-statistics', {});
                
                if (authResult.success) {
                    console.log('管理者驗證成功');
                    loadDashboard();
                } else {
                    showError('權限不足：您不是系統管理者');
                }
            } else {
                liff.login();
            }
        } catch (error) {
            console.error('初始化失敗:', error);
            showError('系統初始化失敗: ' + error.message);
        }
    }

    // 管理者 API 呼叫
    async function callAdminAPI(action, data) {
        return new Promise((resolve, reject) => {
            const requestData = {
                action: action,
                data: JSON.stringify({
                    ...data,
                    adminUserId: adminUserId
                }),
                callback: 'adminAPICallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
            };
            
            window[requestData.callback] = function(response) {
                delete window[requestData.callback];
                resolve(response);
            };
            
            const script = document.createElement('script');
            const params = new URLSearchParams(requestData);
            script.src = CONFIG.API_BASE_URL + '?' + params.toString();
            
            script.onload = function() {
                document.head.removeChild(script);
            };
            
            script.onerror = function() {
                delete window[requestData.callback];
                document.head.removeChild(script);
                reject(new Error('API 請求失敗'));
            };
            
            document.head.appendChild(script);
        });
    }

    // 標籤頁切換
    function switchTab(tabName) {
        // 隱藏所有標籤內容
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => content.classList.remove('active'));
        
        // 移除所有按鈕的 active 狀態
        const navTabs = document.querySelectorAll('.nav-tab');
        navTabs.forEach(tab => tab.classList.remove('active'));
        
        // 顯示選中的標籤內容
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
        
        // 載入對應內容
        loadTabContent(tabName);
    }

    async function loadTabContent(tabName) {
        switch (tabName) {
            case 'dashboard':
                loadDashboard();
                break;
            case 'pending':
                loadPendingPayments();
                break;
            case 'payments':
                loadAllPayments();
                break;
            case 'users':
                loadUsers();
                break;
            case 'reports':
                initReports();
                break;
            case 'settings':
                loadSystemInfo();
                break;
        }
    }

    // 載入儀表板
    async function loadDashboard() {
        try {
            const stats = await callAdminAPI('admin-get-statistics', {});
            
            if (stats.success) {
                displayDashboardStats(stats.statistics);
            } else {
                throw new Error(stats.message);
            }
        } catch (error) {
            console.error('載入儀表板失敗:', error);
            showError('載入儀表板失敗: ' + error.message);
        }
    }

    function displayDashboardStats(statistics) {
        const statsHtml = `
            <div class="stat-card">
                <div class="stat-number">${statistics.totalUsers}</div>
                <div class="stat-label">註冊用戶</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${statistics.totalOrders}</div>
                <div class="stat-label">訂單記錄</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${statistics.pendingPayments}</div>
                <div class="stat-label">待審核</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">NT$ ${statistics.totalAmount.toLocaleString()}</div>
                <div class="stat-label">總金額</div>
            </div>
        `;
        
        document.getElementById('dashboardStats').innerHTML = statsHtml;
        
        // 載入最近活動
        const activityHtml = `
            <div style="font-size: 14px; color: #6c757d;">
                <p>📊 總用戶數: ${statistics.totalUsers}</p>
                <p>💰 總繳費記錄: ${statistics.totalPayments}</p>
                <p>✅ 已確認: ${statistics.approvedPayments}</p>
                <p>⏳ 待審核: ${statistics.pendingPayments}</p>
                <p>🕒 最後更新: ${new Date(statistics.lastUpdated).toLocaleString('zh-TW')}</p>
            </div>
        `;
        
        document.getElementById('recentActivity').innerHTML = activityHtml;
    }

    // 載入待審核繳費記錄
    async function loadPendingPayments() {
        try {
            document.getElementById('pendingPaymentsTable').innerHTML = '<div class="loading">載入中...</div>';
            
            const result = await callAdminAPI('admin-get-pending-payments', {});
            
            if (result.success) {
                pendingPayments = result.payments;
                displayPendingPayments(result.payments);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('載入待審核記錄失敗:', error);
            document.getElementById('pendingPaymentsTable').innerHTML = 
                `<div class="error">載入失敗: ${error.message}</div>`;
        }
    }

    function displayPendingPayments(payments) {
        if (payments.length === 0) {
            document.getElementById('pendingPaymentsTable').innerHTML = 
                '<div style="padding: 40px; text-align: center; color: #6c757d;">目前沒有待審核的繳費記錄</div>';
            return;
        }
        
        let html = `
            <table class="table">
                <thead>
                    <tr>
                        <th><input type="checkbox" onchange="toggleAllPayments(this)"></th>
                        <th>繳費編號</th>
                        <th>訂單編號</th>
                        <th>用戶姓名</th>
                        <th>繳費金額</th>
                        <th>繳費方式</th>
                        <th>提交時間</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        payments.forEach(payment => {
            html += `
                <tr>
                    <td><input type="checkbox" value="${payment.paymentId}" onchange="togglePaymentSelection(this)"></td>
                    <td>${payment.paymentId}</td>
                    <td>${payment.orderId}</td>
                    <td>
                        <div>${payment.realName}</div>
                        <small style="color: #6c757d;">${payment.lineName}</small>
                    </td>
                    <td>NT$ ${payment.paymentAmount.toLocaleString()}</td>
                    <td>${payment.paymentMethod}</td>
                    <td>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</td>
                    <td>
                        <button class="btn btn-primary" onclick="openReviewModal('${payment.paymentId}')">
                            審核
                        </button>
                    </td>
                </tr>
            `;
            
            if (payment.paymentNote) {
                html += `
                    <tr>
                        <td colspan="8" style="background: #f8f9fa; font-size: 12px; color: #6c757d;">
                            備註: ${payment.paymentNote}
                        </td>
                    </tr>
                `;
            }
        });
        
        html += `
                </tbody>
            </table>
        `;
        
        document.getElementById('pendingPaymentsTable').innerHTML = html;
    }

    // 開啟審核模態框
    function openReviewModal(paymentId) {
        const payment = pendingPayments.find(p => p.paymentId === paymentId);
        if (!payment) return;
        
        document.getElementById('reviewPaymentId').value = paymentId;
        
        const paymentInfo = `
            <strong>繳費編號:</strong> ${payment.paymentId}<br>
            <strong>訂單編號:</strong> ${payment.orderId}<br>
            <strong>用戶姓名:</strong> ${payment.realName} (${payment.lineName})<br>
            <strong>繳費金額:</strong> NT$ ${payment.paymentAmount.toLocaleString()}<br>
            <strong>繳費方式:</strong> ${payment.paymentMethod}<br>
            <strong>提交時間:</strong> ${new Date(payment.submittedAt).toLocaleString('zh-TW')}<br>
            ${payment.paymentNote ? `<strong>備註:</strong> ${payment.paymentNote}` : ''}
        `;
        
        document.getElementById('reviewPaymentInfo').innerHTML = paymentInfo;
        document.getElementById('reviewModal').style.display = 'block';
    }

    // 關閉審核模態框
    function closeReviewModal() {
        document.getElementById('reviewModal').style.display = 'none';
        document.getElementById('reviewForm').reset();
    }

    // 審核表單提交
    document.addEventListener('DOMContentLoaded', function() {
        const reviewForm = document.getElementById('reviewForm');
        if (reviewForm) {
            reviewForm.addEventListener('submit', handleReviewSubmit);
        }
        
        // 模態框關閉事件
        const closeBtn = document.querySelector('.close');
        if (closeBtn) {
            closeBtn.onclick = closeReviewModal;
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById('reviewModal');
            if (event.target === modal) {
                closeReviewModal();
            }
        }
        
        // 設定今天的日期
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('reportDate').value = today;
    });

    async function handleReviewSubmit(e) {
        e.preventDefault();
        
        const paymentId = document.getElementById('reviewPaymentId').value;
        const status = document.getElementById('reviewStatus').value;
        const reviewNote = document.getElementById('reviewNote').value;
        
        if (!status) {
            alert('請選擇審核結果');
            return;
        }
        
        try {
            const result = await callAdminAPI('admin-review-payment', {
                paymentId: paymentId,
                status: status,
                reviewNote: reviewNote
            });
            
            if (result.success) {
                alert('審核完成！');
                closeReviewModal();
                loadPendingPayments(); // 重新載入待審核列表
                loadDashboard(); // 更新儀表板統計
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('審核失敗:', error);
            alert('審核失敗: ' + error.message);
        }
    }

    // 切換單個繳費記錄選擇
    function togglePaymentSelection(checkbox) {
        const paymentId = checkbox.value;
        
        if (checkbox.checked) {
            if (!selectedPayments.includes(paymentId)) {
                selectedPayments.push(paymentId);
            }
        } else {
            const index = selectedPayments.indexOf(paymentId);
            if (index > -1) {
                selectedPayments.splice(index, 1);
            }
        }
        
        console.log('已選擇:', selectedPayments);
    }

    // 切換全選
    function toggleAllPayments(masterCheckbox) {
        const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
        selectedPayments = [];
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = masterCheckbox.checked;
            if (masterCheckbox.checked) {
                selectedPayments.push(checkbox.value);
            }
        });
        
        console.log('全選狀態:', masterCheckbox.checked, '已選擇:', selectedPayments);
    }

    // 批量通過
    async function batchApprove() {
        if (selectedPayments.length === 0) {
            alert('請先選擇要審核的繳費記錄');
            return;
        }
        
        const confirmMsg = `確定要批量通過 ${selectedPayments.length} 筆繳費記錄嗎？`;
        if (!confirm(confirmMsg)) return;
        
        try {
            const result = await callAdminAPI('admin-batch-review', {
                paymentIds: selectedPayments,
                status: '已確認',
                reviewNote: '批量審核通過'
            });
            
            if (result.success) {
                alert(result.message);
                selectedPayments = [];
                loadPendingPayments();
                loadDashboard();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('批量審核失敗:', error);
            alert('批量審核失敗: ' + error.message);
        }
    }

    // 批量拒絕
    async function batchReject() {
        if (selectedPayments.length === 0) {
            alert('請先選擇要審核的繳費記錄');
            return;
        }
        
        const reason = prompt(`即將批量拒絕 ${selectedPayments.length} 筆繳費記錄，請輸入拒絕原因：`);
        if (!reason) return;
        
        try {
            const result = await callAdminAPI('admin-batch-review', {
                paymentIds: selectedPayments,
                status: '已拒絕',
                reviewNote: reason
            });
            
            if (result.success) {
                alert(result.message);
                selectedPayments = [];
                loadPendingPayments();
                loadDashboard();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('批量審核失敗:', error);
            alert('批量審核失敗: ' + error.message);
        }
    }

    // 載入所有繳費記錄
    async function loadAllPayments() {
        try {
            document.getElementById('allPaymentsTable').innerHTML = '<div class="loading">載入中...</div>';
            
            const result = await callAdminAPI('admin-get-all-payments', {});
            
            if (result.success) {
                displayAllPayments(result.payments);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('載入繳費記錄失敗:', error);
            document.getElementById('allPaymentsTable').innerHTML = 
                `<div class="error">載入失敗: ${error.message}</div>`;
        }
    }

    function displayAllPayments(payments) {
        if (payments.length === 0) {
            document.getElementById('allPaymentsTable').innerHTML = 
                '<div style="padding: 40px; text-align: center; color: #6c757d;">目前沒有繳費記錄</div>';
            return;
        }
        
        let html = `
            <table class="table">
                <thead>
                    <tr>
                        <th>繳費編號</th>
                        <th>用戶資訊</th>
                        <th>繳費資訊</th>
                        <th>狀態</th>
                        <th>時間</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        payments.forEach(payment => {
            const statusClass = getStatusClass(payment.status);
            const statusText = getStatusText(payment.status);
            
            html += `
                <tr>
                    <td>
                        <div style="font-weight: 600;">${payment.paymentId}</div>
                        <small style="color: #6c757d;">${payment.orderId}</small>
                    </td>
                    <td>
                        <div style="font-weight: 600;">${payment.realName}</div>
                        <small style="color: #6c757d;">${payment.lineName}</small>
                    </td>
                    <td>
                        <div>NT$ ${payment.paymentAmount.toLocaleString()}</div>
                        <small style="color: #6c757d;">${payment.paymentMethod}</small>
                    </td>
                    <td>
                        <span class="status-badge status-${statusClass}">${statusText}</span>
                    </td>
                    <td>
                        <div style="font-size: 12px;">
                            提交: ${new Date(payment.submittedAt).toLocaleDateString('zh-TW')}
                            ${payment.reviewedAt ? `<br>審核: ${new Date(payment.reviewedAt).toLocaleDateString('zh-TW')}` : ''}
                        </div>
                    </td>
                    <td>
                        ${payment.status === '待審核' ? 
                            `<button class="btn btn-primary" onclick="openReviewModal('${payment.paymentId}')">審核</button>` : 
                            `<button class="btn btn-secondary" onclick="viewPaymentDetails('${payment.paymentId}')">詳情</button>`
                        }
                    </td>
                </tr>
            `;
            
            if (payment.paymentNote || payment.reviewNote) {
                html += `
                    <tr>
                        <td colspan="6" style="background: #f8f9fa; font-size: 12px; color: #6c757d; padding: 8px 12px;">
                            ${payment.paymentNote ? `用戶備註: ${payment.paymentNote}<br>` : ''}
                            ${payment.reviewNote ? `審核備註: ${payment.reviewNote}` : ''}
                        </td>
                    </tr>
                `;
            }
        });
        
        html += `
                </tbody>
            </table>
        `;
        
        document.getElementById('allPaymentsTable').innerHTML = html;
    }

    // 載入用戶資料
    async function loadUsers() {
        try {
            document.getElementById('usersTable').innerHTML = '<div class="loading">載入中...</div>';
            
            const result = await callAdminAPI('admin-get-users', {});
            
            if (result.success) {
                displayUsers(result.users);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('載入用戶資料失敗:', error);
            document.getElementById('usersTable').innerHTML = 
                `<div class="error">載入失敗: ${error.message}</div>`;
        }
    }

    function displayUsers(users) {
        if (users.length === 0) {
            document.getElementById('usersTable').innerHTML = 
                '<div style="padding: 40px; text-align: center; color: #6c757d;">目前沒有註冊用戶</div>';
            return;
        }
        
        let html = `
            <table class="table">
                <thead>
                    <tr>
                        <th>用戶資訊</th>
                        <th>註冊時間</th>
                        <th>最後登入</th>
                        <th>狀態</th>
                        <th>統計</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        users.forEach(user => {
            html += `
                <tr>
                    <td>
                        <div style="font-weight: 600;">${user.realName}</div>
                        <small style="color: #6c757d;">${user.lineDisplayName}</small>
                        <div style="font-size: 11px; color: #999; margin-top: 2px;">
                            ID: ${user.userId.substring(0, 20)}...
                        </div>
                    </td>
                    <td>${new Date(user.registeredAt).toLocaleString('zh-TW')}</td>
                    <td>${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleString('zh-TW') : '未記錄'}</td>
                    <td>
                        <span class="status-badge ${user.status === 'active' ? 'status-approved' : 'status-pending'}">
                            ${user.status === 'active' ? '正常' : user.status}
                        </span>
                    </td>
                    <td>
                        <div style="font-size: 12px;">
                            訂單: ${user.orderCount || 0}<br>
                            繳費: ${user.paymentCount || 0}
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
        `;
        
        document.getElementById('usersTable').innerHTML = html;
    }

    // 初始化報表
    function initReports() {
        // 報表功能已經在 HTML 中設定好了
        console.log('報表頁面已初始化');
    }

    // 生成報表
    async function generateReport() {
        const targetDate = document.getElementById('reportDate').value;
        if (!targetDate) {
            alert('請選擇日期');
            return;
        }
        
        try {
            document.getElementById('reportContent').innerHTML = '<div class="loading">生成報表中...</div>';
            
            const result = await callAdminAPI('admin-get-daily-report', {
                targetDate: targetDate
            });
            
            if (result.success) {
                displayReport(result.report);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('生成報表失敗:', error);
            document.getElementById('reportContent').innerHTML = 
                `<div class="error">生成報表失敗: ${error.message}</div>`;
        }
    }

    function displayReport(report) {
        const html = `
            <div class="table-container">
                <h3>📊 ${report.date} 日報表</h3>
                
                <div class="stats-grid" style="margin: 20px 0;">
                    <div class="stat-card">
                        <div class="stat-number">${report.newRegistrations}</div>
                        <div class="stat-label">新註冊用戶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${report.newPayments}</div>
                        <div class="stat-label">新繳費記錄</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${report.approvedPayments}</div>
                        <div class="stat-label">審核通過</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">NT$ ${report.totalAmount.toLocaleString()}</div>
                        <div class="stat-label">當日金額</div>
                    </div>
                </div>
                
                ${report.details.registrations.length > 0 ? `
                    <h4>新註冊用戶</h4>
                    <table class="table" style="margin-bottom: 20px;">
                        <thead>
                            <tr>
                                <th>真實姓名</th>
                                <th>LINE 名稱</th>
                                <th>註冊時間</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${report.details.registrations.map(reg => `
                                <tr>
                                    <td>${reg.realName}</td>
                                    <td>${reg.lineDisplayName}</td>
                                    <td>${new Date(reg.registeredAt).toLocaleString('zh-TW')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : ''}
                
                ${report.details.payments.length > 0 ? `
                    <h4>當日繳費記錄</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>繳費編號</th>
                                <th>用戶姓名</th>
                                <th>金額</th>
                                <th>方式</th>
                                <th>狀態</th>
                                <th>時間</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${report.details.payments.map(payment => `
                                <tr>
                                    <td>${payment.paymentId}</td>
                                    <td>${payment.realName}</td>
                                    <td>NT$ ${payment.paymentAmount.toLocaleString()}</td>
                                    <td>${payment.paymentMethod}</td>
                                    <td>
                                        <span class="status-badge status-${getStatusClass(payment.status)}">
                                            ${getStatusText(payment.status)}
                                        </span>
                                    </td>
                                    <td>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : ''}
            </div>
        `;
        
        document.getElementById('reportContent').innerHTML = html;
    }

    // 載入系統資訊
    async function loadSystemInfo() {
        try {
            const info = {
                version: '1.0.0',
                lastUpdate: new Date().toISOString(),
                environment: 'Production',
                database: 'Google Sheets',
                liffVersion: liff.getVersion(),
                adminUser: adminProfile.displayName
            };
            
            const html = `
                <div style="font-size: 14px; line-height: 1.6;">
                    <p><strong>系統版本:</strong> ${info.version}</p>
                    <p><strong>最後更新:</strong> ${new Date(info.lastUpdate).toLocaleString('zh-TW')}</p>
                    <p><strong>運行環境:</strong> ${info.environment}</p>
                    <p><strong>資料庫:</strong> ${info.database}</p>
                    <p><strong>LIFF 版本:</strong> ${info.liffVersion}</p>
                    <p><strong>當前管理者:</strong> ${info.adminUser}</p>
                </div>
            `;
            
            document.getElementById('systemInfo').innerHTML = html;
        } catch (error) {
            console.error('載入系統資訊失敗:', error);
            document.getElementById('systemInfo').innerHTML = 
                `<div class="error">載入系統資訊失敗: ${error.message}</div>`;
        }
    }

    // 匯出資料
    async function exportData() {
        if (!confirm('確定要匯出所有系統資料嗎？這可能需要一些時間。')) return;
        
        try {
            const result = await callAdminAPI('admin-export-data', {});
            
            if (result.success) {
                // 建立下載連結
                const dataStr = JSON.stringify(result.data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `system_export_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                
                alert(`資料匯出完成！\n總用戶: ${result.summary.totalUsers}\n總訂單: ${result.summary.totalOrders}\n總繳費: ${result.summary.totalPayments}`);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('匯出資料失敗:', error);
            alert('匯出資料失敗: ' + error.message);
        }
    }

    // 清理測試資料
    async function cleanupTestData() {
        const confirmMsg = '確定要清理所有測試資料嗎？此操作無法復原！\n\n將會刪除包含「測試」、「test」、「Test」關鍵字的資料。';
        if (!confirm(confirmMsg)) return;
        
        try {
            const result = await callAdminAPI('admin-cleanup-test-data', {});
            
            if (result.success) {
                alert(result.message);
                // 重新載入當前頁面資料
                loadDashboard();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('清理測試資料失敗:', error);
            alert('清理測試資料失敗: ' + error.message);
        }
    }

    // 備份資料
    async function backupData() {
        const backupSpreadsheetId = prompt('請輸入備份目標試算表的 ID：\n（請先建立一個空的 Google Sheets 並複製其 ID）');
        
        if (!backupSpreadsheetId) return;
        
        try {
            const result = await callAdminAPI('admin-backup-data', {
                backupSpreadsheetId: backupSpreadsheetId
            });
            
            if (result.success) {
                alert(`資料備份完成！\n備份時間: ${new Date(result.backupTime).toLocaleString('zh-TW')}\n備份內容: ${result.sheetsBackedUp.join(', ')}`);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('備份資料失敗:', error);
            alert('備份資料失敗: ' + error.message);
        }
    }

    // 工具函數
    function getStatusClass(status) {
        switch (status) {
            case '待審核': return 'pending';
            case '已確認': return 'approved';
            case '已拒絕': return 'rejected';
            default: return 'pending';
        }
    }

    function getStatusText(status) {
        switch (status) {
            case '待審核': return '待審核';
            case '已確認': return '已確認';
            case '已拒絕': return '已拒絕';
            default: return status || '未知';
        }
    }

    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.innerHTML = `
            <h3>❌ 錯誤</h3>
            <p>${message}</p>
        `;
        
        const content = document.querySelector('.content');
        content.insertBefore(errorDiv, content.firstChild);
        
        // 5秒後自動移除
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
            }
        }, 5000);
    }

    function viewPaymentDetails(paymentId) {
        // 這裡可以實作查看繳費詳情的功能
        alert('查看繳費詳情功能開發中...\n繳費編號: ' + paymentId);
    }

    // 開發用測試函數
    if (CONFIG.DEBUG_MODE) {
        window.testAdminFunctions = function() {
            console.log('=== 管理者功能測試 ===');
            console.log('管理者ID:', adminUserId);
            console.log('管理者資料:', adminProfile);
            console.log('已選擇繳費記錄:', selectedPayments);
            console.log('待審核記錄:', pendingPayments);
        };
    }
</script>
</body>
</html>
