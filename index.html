<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LIFF è¨‚è³¼å–®æŸ¥è©¢ç³»çµ±</title>
<script src="https://static.line-scdn.net/liff/edge/2.1/liff.js"></script>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .container {
        max-width: 450px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .header {
        background: linear-gradient(45deg, #00c851, #00a843);
        color: white;
        padding: 30px 20px;
        text-align: center;
    }
    
    .header h1 {
        font-size: 24px;
        margin-bottom: 10px;
    }
    
    .user-info {
        background: rgba(255,255,255,0.1);
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
    }
    
    .content {
        padding: 30px 20px;
    }
    
    .config-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        border: 2px dashed #dee2e6;
    }
    
    .config-section h3 {
        color: #495057;
        margin-bottom: 10px;
        font-size: 14px;
    }
    
    .config-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 5px;
        font-size: 12px;
        margin-bottom: 8px;
    }
    
    .config-button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        font-size: 12px;
        cursor: pointer;
        margin-right: 5px;
    }
    
    .config-button:hover {
        background: #0056b3;
    }
    
    .tab-buttons {
        display: flex;
        margin-bottom: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        padding: 5px;
    }
    
    .tab-button {
        flex: 1;
        padding: 12px;
        border: none;
        background: transparent;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
        font-size: 14px;
    }
    
    .tab-button.active {
        background: #00c851;
        color: white;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
    }
    
    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s;
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
        outline: none;
        border-color: #00c851;
    }
    
    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }
    
    .btn {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 10px;
    }
    
    .btn-primary {
        background: linear-gradient(45deg, #00c851, #00a843);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0,200,81,0.3);
    }
    
    .btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .order-summary {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #00c851;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #dee2e6;
    }
    
    .summary-item:last-child {
        border-bottom: none;
        font-weight: bold;
        font-size: 18px;
        color: #00c851;
    }
    
    .order-item {
        background: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .order-item h4 {
        color: #333;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .order-item p {
        color: #666;
        margin: 5px 0;
        font-size: 14px;
    }
    
    .payment-status {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .status-unpaid {
        background: #f8d7da;
        color: #721c24;
    }
    
    .status-reported {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-confirmed {
        background: #d4edda;
        color: #155724;
    }
    
    .payment-form {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-top: 10px;
        border: 1px solid #dee2e6;
    }
    
    .payment-methods {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .payment-method {
        flex: 1;
        padding: 8px 12px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        text-align: center;
        font-size: 12px;
        transition: all 0.3s;
    }
    
    .payment-method.selected {
        border-color: #00c851;
        background: #d4edda;
        color: #155724;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #00c851;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .alert {
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 14px;
    }
    
    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .alert-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    
    .alert-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }
    
    .stat-number {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 12px;
        opacity: 0.9;
    }
    
    .connection-status {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        font-size: 12px;
        text-align: center;
    }
    
    .status-connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .status-testing {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .search-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .search-input {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .search-input input {
        flex: 1;
        padding: 10px 15px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }
    
    .search-input button {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }
    
    .member-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .member-item {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .member-item:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .member-item h5 {
        margin-bottom: 8px;
        color: #333;
    }
    
    .member-item p {
        margin: 3px 0;
        font-size: 13px;
        color: #666;
    }
    
    .admin-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }
    
    .admin-btn {
        flex: 1;
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .admin-btn-confirm {
        background: #28a745;
        color: white;
    }
    
    .admin-btn-reject {
        background: #dc3545;
        color: white;
    }
    
    .hidden {
        display: none !important;
    }
    
    .role-indicator {
        background: #007bff;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        margin-left: 10px;
    }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ” è¨‚è³¼å–®æŸ¥è©¢ç³»çµ±</h1>
        <div class="user-info" id="userInfo" style="display: none;">
            <div id="userName">è¼‰å…¥ä¸­...</div>
            <div id="userId" style="font-size: 12px; opacity: 0.8;"></div>
            <div id="userRole" style="font-size: 12px; opacity: 0.8;"></div>
        </div>
    </div>
    
    <div class="content">
        <!-- è¨­å®šå€å¡Š -->
        <div class="config-section">
            <h3>âš™ï¸ ç³»çµ±è¨­å®š</h3>
            <input type="text" id="gasWebAppUrl" class="config-input" 
                   placeholder="è«‹è¼¸å…¥ Google Apps Script Web App URL">
            <input type="text" id="liffId" class="config-input" 
                   placeholder="è«‹è¼¸å…¥ LIFF ID">
            <button class="config-button" onclick="saveConfig()">ğŸ’¾ å„²å­˜è¨­å®š</button>
            <button class="config-button" onclick="testConnection()">ğŸ”— æ¸¬è©¦é€£ç·š</button>
            <div id="connectionStatus"></div>
        </div>
        
        <!-- æœƒå“¡è³‡æ–™è¨­å®š -->
        <div id="memberSetupSection" class="config-section" style="display: none;">
            <h3>ğŸ‘¤ å€‹äººè³‡æ–™è¨­å®š</h3>
            <div class="form-group">
                <label for="realName">çœŸå¯¦å§“å *</label>
                <input type="text" id="realName" required placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å">
            </div>
            <button class="config-button" onclick="saveMemberInfo()">ğŸ’¾ å„²å­˜å€‹äººè³‡æ–™</button>
        </div>
        
        <div class="tab-buttons" id="tabButtons">
            <button class="tab-button active" onclick="switchTab('orders')" id="ordersTabBtn">æˆ‘çš„è¨‚å–®</button>
            <button class="tab-button hidden" onclick="switchTab('admin')" id="adminTabBtn">ç®¡ç†ä»‹é¢</button>
        </div>
        
        <!-- æœƒå“¡è¨‚å–®æŸ¥è©¢é é¢ -->
        <div id="ordersTab" class="tab-content active">
            <div id="orderSummary" style="display: none;"></div>
            <div id="ordersList">
                <div class="loading">
                    <div class="spinner"></div>
                    è¼‰å…¥è¨‚å–®è³‡æ–™ä¸­...
                </div>
            </div>
        </div>
        
        <!-- ç®¡ç†è€…ä»‹é¢ -->
        <div id="adminTab" class="tab-content">
            <div class="search-section">
                <h3>ğŸ” æœƒå“¡æœå°‹</h3>
                <div class="search-input">
                    <input type="text" id="searchInput" placeholder="è¼¸å…¥æœƒå“¡å§“åæœå°‹...">
                    <button onclick="searchMembers()">æœå°‹</button>
                </div>
            </div>
            
            <div class="stats" id="adminStats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalMembers">0</div>
                    <div class="stat-label">ç¸½æœƒå“¡æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingPayments">0</div>
                    <div class="stat-label">å¾…ç¢ºèªç¹³è²»</div>
                </div>
            </div>
            
            <div id="membersList">
                <div class="loading">
                    <div class="spinner"></div>
                    è¼‰å…¥æœƒå“¡è³‡æ–™ä¸­...
                </div>
            </div>
        </div>
        
        <div id="messageContainer"></div>
    </div>
</div>

<script>
    // å…¨åŸŸè®Šæ•¸
    const FIXED_GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxPi3R9W2jB4W3s5tDxZ7dU0d3ka4Ba2Jg80H8ov9yVYIO7Iil0-fvQvkLyIFFpAw6-/exec';
    const FIXED_LIFF_ID = '1657285806-2bmkYWkN';
    let gasWebAppUrl = FIXED_GAS_WEB_APP_URL;
    let liffId = FIXED_LIFF_ID;
    let liffInitialized = false;
    let currentUser = null;
    // let gasWebAppUrl = '';
    // let liffId = '';
    let userRole = 'member'; // member æˆ– admin
    let groupInfo = null;
    
    // ç®¡ç†è€…åå–® (å¯å¾å¾Œç«¯è¨­å®šæª”è¼‰å…¥)
    const adminUsers = ['å°åŠ‰ï¼ˆå½¤å½¤çˆ¸ï¼‰', 'U47d2577a751e274ed113028beab304b7']; // è«‹æ ¹æ“šå¯¦éš›éœ€è¦èª¿æ•´
    
    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        loadConfig();
        initializeLiff();
    });
    
    // è¼‰å…¥è¨­å®š
    function loadConfig() {
        try {
            gasWebAppUrl = localStorage.getItem('gasWebAppUrl') || '';
            liffId = localStorage.getItem('liffId') || '';
            
            document.getElementById('gasWebAppUrl').value = gasWebAppUrl;
            document.getElementById('liffId').value = liffId;
            
            updateConnectionStatus();
        } catch (error) {
            console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', error);
        }
    }
    
    // å„²å­˜è¨­å®š
    function saveConfig() {
        try {
            gasWebAppUrl = document.getElementById('gasWebAppUrl').value.trim();
            liffId = document.getElementById('liffId').value.trim();
            
            if (!gasWebAppUrl) {
                showMessage('è«‹è¼¸å…¥ Google Apps Script Web App URL', 'error');
                return;
            }
            
            if (!liffId) {
                showMessage('è«‹è¼¸å…¥ LIFF ID', 'error');
                return;
            }
            
            localStorage.setItem('gasWebAppUrl', gasWebAppUrl);
            localStorage.setItem('liffId', liffId);
            
            updateConnectionStatus();
            showMessage('âœ… è¨­å®šå·²å„²å­˜ï¼', 'success');
            
            // é‡æ–°åˆå§‹åŒ– LIFF
            setTimeout(() => {
                location.reload();
            }, 1000);
            
        } catch (error) {
            console.error('å„²å­˜è¨­å®šå¤±æ•—:', error);
            showMessage('âŒ å„²å­˜è¨­å®šå¤±æ•—: ' + error.message, 'error');
        }
    }
    
    // æ¸¬è©¦é€£ç·š
    async function testConnection() {
        if (!gasWebAppUrl) {
            showMessage('è«‹å…ˆè¼¸å…¥ä¸¦å„²å­˜ Google Apps Script Web App URL', 'error');
            return;
        }
        
        try {
            showConnectionStatus('ğŸ”„ æ¸¬è©¦é€£ç·šä¸­...', 'testing');
            
            const response = await fetch(gasWebAppUrl + '?action=test&timestamp=' + Date.now(), {
                method: 'GET',
                mode: 'cors'
            });
            
            if (response.ok) {
                const result = await response.json();
                showConnectionStatus('âœ… é€£ç·šæˆåŠŸï¼', 'connected');
                showMessage('ğŸ‰ èˆ‡å¾Œç«¯é€£ç·šæˆåŠŸï¼', 'success');
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
        } catch (error) {
            console.error('é€£ç·šæ¸¬è©¦å¤±æ•—:', error);
            showConnectionStatus('âŒ é€£ç·šå¤±æ•—', 'disconnected');
            showMessage('âŒ é€£ç·šæ¸¬è©¦å¤±æ•—: ' + error.message, 'error');
        }
    }
    
    // æ›´æ–°é€£ç·šç‹€æ…‹é¡¯ç¤º
    function updateConnectionStatus() {
        if (gasWebAppUrl && liffId) {
            showConnectionStatus('âš¡ å·²è¨­å®šå®Œæˆ', 'connected');
        } else {
            showConnectionStatus('âš ï¸ è«‹å®Œæˆè¨­å®š', 'disconnected');
        }
    }
    
    // é¡¯ç¤ºé€£ç·šç‹€æ…‹
    function showConnectionStatus(message, status) {
        const statusElement = document.getElementById('connectionStatus');
        const statusClass = `status-${status}`;
        
        statusElement.className = `connection-status ${statusClass}`;
        statusElement.textContent = message;
    }
    
    // LIFF åˆå§‹åŒ–
    async function initializeLiff() {
        try {
            if (!liffId) {
                showMessage('âš ï¸ è«‹å…ˆè¨­å®š LIFF ID', 'warning');
                return;
            }
            
            await liff.init({ liffId: liffId });
            
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }
            
            const profile = await liff.getProfile();
            currentUser = {
                displayName: profile.displayName,
                userId: profile.userId
            };
            
            // ç²å–ç¾¤çµ„è³‡è¨Š
            try {
                const context = liff.getContext();
                if (context && context.type === 'group') {
                    groupInfo = {
                        groupName: 'ç¾¤çµ„',
                        groupId: context.groupId
                    };
                } else {
                    groupInfo = {
                        groupName: 'å€‹äººèŠå¤©',
                        groupId: 'personal'
                    };
                }
            } catch (contextError) {
                console.warn('ç„¡æ³•ç²å–ç¾¤çµ„è³‡è¨Š:', contextError);
                groupInfo = {
                    groupName: 'æœªçŸ¥ç¾¤çµ„',
                    groupId: 'unknown'
                };
            }
            
            checkUserRole();
            updateUserInfo();
            showMemberSetup();
            liffInitialized = true;
            
        } catch (error) {
            console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
            showMessage('âŒ LIFF åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'error');
        }
    }
    
    // æª¢æŸ¥ç”¨æˆ¶è§’è‰²
    function checkUserRole() {
        if (currentUser && adminUsers.includes(currentUser.displayName)) {
            userRole = 'admin';
            document.getElementById('adminTabBtn').classList.remove('hidden');
        } else {
            userRole = 'member';
            document.getElementById('adminTabBtn').classList.add('hidden');
        }
    }
    
    // æ›´æ–°ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º
    function updateUserInfo() {
        if (currentUser) {
            document.getElementById('userName').innerHTML = 
                `ğŸ‘‹ ${currentUser.displayName} <span class="role-indicator">${userRole === 'admin' ? 'ç®¡ç†å“¡' : 'æœƒå“¡'}</span>`;
            document.getElementById('userId').textContent = `LINE ID: ${currentUser.userId}`;
            document.getElementById('userRole').textContent = 
                `ç¾¤çµ„: ${groupInfo ? groupInfo.groupName : 'æœªçŸ¥'}`;
            document.getElementById('userInfo').style.display = 'block';
        }
    }
    
    // é¡¯ç¤ºæœƒå“¡è³‡æ–™è¨­å®š
    function showMemberSetup() {
        const savedRealName = localStorage.getItem(`realName_${currentUser.userId}`);
        if (!savedRealName) {
            document.getElementById('memberSetupSection').style.display = 'block';
        } else {
            document.getElementById('realName').value = savedRealName;
            loadUserOrders();
        }
    }
    
    // å„²å­˜æœƒå“¡è³‡æ–™
    function saveMemberInfo() {
        const realName = document.getElementById('realName').value.trim();
        
        if (!realName) {
            showMessage('è«‹è¼¸å…¥çœŸå¯¦å§“å', 'error');
            return;
        }
        
        localStorage.setItem(`realName_${currentUser.userId}`, realName);
        document.getElementById('memberSetupSection').style.display = 'none';
        
        showMessage('âœ… å€‹äººè³‡æ–™å·²å„²å­˜ï¼', 'success');
        loadUserOrders();
    }
    
    // åˆ‡æ›åˆ†é 
    function switchTab(tabName) {
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(tabName + 'TabBtn').classList.add('active');
        
        // æ›´æ–°å…§å®¹é¡¯ç¤º
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabName + 'Tab').classList.add('active');
        
        // è¼‰å…¥å°æ‡‰è³‡æ–™
        if (tabName === 'orders') {
            loadUserOrders();
        } else if (tabName === 'admin') {
            loadAdminData();
        }
    }
    
    // è¼‰å…¥ç”¨æˆ¶è¨‚å–®
    async function loadUserOrders() {
        if (!gasWebAppUrl || !liffInitialized || !currentUser) {
            document.getElementById('ordersList').innerHTML = 
                '<div class="alert alert-error">âŒ ç³»çµ±å°šæœªåˆå§‹åŒ–å®Œæˆï¼Œè«‹ç¢ºèªè¨­å®š</div>';
            return;
        }
        
        const realName = localStorage.getItem(`realName_${currentUser.userId}`);
        if (!realName) {
            document.getElementById('ordersList').innerHTML = 
                '<div class="alert alert-warning">âš ï¸ è«‹å…ˆè¨­å®šå€‹äººè³‡æ–™</div>';
            return;
        }
        
        try {
            document.getElementById('ordersList').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    è¼‰å…¥è¨‚å–®è³‡æ–™ä¸­...
                </div>
            `;
            
            const url = `${gasWebAppUrl}?action=getUserOrdersByLineId&lineUserId=${encodeURIComponent(currentUser.userId)}&timestamp=${Date.now()}`;
            
            const response = await fetch(url, {
                method: 'GET',
                mode: 'cors'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                displayUserOrders(result.data || []);
            } else {
                throw new Error(result.message || 'è¼‰å…¥å¤±æ•—');
            }
            
        } catch (error) {
            console.error('è¼‰å…¥è¨‚å–®å¤±æ•—:', error);
            document.getElementById('ordersList').innerHTML = 
                `<div class="alert alert-error">âŒ è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
        }
    }
    
// å‰ç«¯ JavaScript å‰©é¤˜éƒ¨åˆ†

// é¡¯ç¤ºç”¨æˆ¶è¨‚å–® (çºŒ)
function displayUserOrders(orders) {
    const summaryContainer = document.getElementById('orderSummary');
    const listContainer = document.getElementById('ordersList');
    
    if (!orders || orders.length === 0) {
        listContainer.innerHTML = 
            '<div class="alert alert-info">ğŸ“ æš«ç„¡è¨‚å–®è¨˜éŒ„</div>';
        summaryContainer.style.display = 'none';
        return;
    }
    
    // æŒ‰ç”¢å“åˆä½µæ•¸é‡
    const productSummary = {};
    let totalAmount = 0;
    
    orders.forEach(order => {
        const productId = order.productId || 'æœªçŸ¥ç”¢å“';
        const quantity = parseInt(order.quantity) || 0;
        const unitPrice = parseFloat(order.unitPrice) || 0;
        const itemTotal = quantity * unitPrice;
        
        if (!productSummary[productId]) {
            productSummary[productId] = {
                quantity: 0,
                unitPrice: unitPrice,
                total: 0
            };
        }
        
        productSummary[productId].quantity += quantity;
        productSummary[productId].total += itemTotal;
        totalAmount += itemTotal;
    });
    
    // é¡¯ç¤ºè¨‚å–®æ‘˜è¦
    let summaryHtml = '<div class="order-summary"><h3>ğŸ“Š è¨‚å–®æ‘˜è¦</h3>';
    Object.keys(productSummary).forEach(productId => {
        const product = productSummary[productId];
        summaryHtml += `
            <div class="summary-item">
                <span>${productId}</span>
                <span>${product.quantity} å€‹ Ã— $${product.unitPrice} = $${product.total}</span>
            </div>
        `;
    });
    summaryHtml += `
        <div class="summary-item">
            <span>ç¸½é‡‘é¡</span>
            <span>$${totalAmount}</span>
        </div>
    </div>`;
    
    summaryContainer.innerHTML = summaryHtml;
    summaryContainer.style.display = 'block';
    
    // é¡¯ç¤ºè¨‚å–®åˆ—è¡¨
    const orderHtml = orders.map((order, index) => {
        const paymentStatus = order.paymentStatus || 'unpaid';
        const statusText = paymentStatus === 'confirmed' ? 'å·²ç¢ºèª' : 
                         paymentStatus === 'reported' ? 'å·²å›å ±' : 'æœªç¹³è²»';
        const statusClass = `status-${paymentStatus}`;
        
        return `
            <div class="order-item">
                <h4>
                    ğŸ“¦ ${order.productId || 'æœªçŸ¥ç”¢å“'}
                    <span class="payment-status ${statusClass}">${statusText}</span>
                </h4>
                <p>ğŸ”¢ æ•¸é‡: ${order.quantity || 1}</p>
                <p>ğŸ’° å–®åƒ¹: $${order.unitPrice || 0}</p>
                <p>ğŸ’³ å°è¨ˆ: $${(order.quantity || 1) * (order.unitPrice || 0)}</p>
                <p>ğŸ“… æ—¥æœŸ: ${formatDate(order.orderDate)}</p>
                ${order.paymentMethod ? `<p>ğŸ’³ ç¹³è²»æ–¹å¼: ${order.paymentMethod}</p>` : ''}
                ${order.paymentNote ? `<p>ğŸ“ å‚™è¨»: ${order.paymentNote}</p>` : ''}
                
                ${paymentStatus === 'unpaid' ? `
                    <div class="payment-form" id="paymentForm_${index}">
                        <h5>ğŸ’³ å›å ±ç¹³è²»</h5>
                        <div class="payment-methods">
                            <div class="payment-method" onclick="selectPaymentMethod(${index}, 'cash')">ğŸ’µ ç¾é‡‘</div>
                            <div class="payment-method" onclick="selectPaymentMethod(${index}, 'transfer')">ğŸ¦ è½‰å¸³</div>
                            <div class="payment-method" onclick="selectPaymentMethod(${index}, 'linepay')">ğŸ“± LinePay</div>
                        </div>
                        <div class="form-group">
                            <textarea id="paymentNote_${index}" placeholder="å‚™è¨» (è½‰å¸³è«‹æä¾›å¾Œ5ç¢¼)" rows="2"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="reportPayment('${order.orderId}', ${index})">
                            âœ… å›å ±ç¹³è²»
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
    
    listContainer.innerHTML = orderHtml;
}

// é¸æ“‡ç¹³è²»æ–¹å¼
function selectPaymentMethod(orderIndex, method) {
    const form = document.getElementById(`paymentForm_${orderIndex}`);
    const methods = form.querySelectorAll('.payment-method');
    
    methods.forEach(m => m.classList.remove('selected'));
    event.target.classList.add('selected');
    
    // å„²å­˜é¸æ“‡çš„æ–¹å¼
    form.setAttribute('data-payment-method', method);
    
    // å¦‚æœæ˜¯è½‰å¸³ï¼Œè‡ªå‹•èšç„¦åˆ°å‚™è¨»æ¬„
    if (method === 'transfer') {
        document.getElementById(`paymentNote_${orderIndex}`).focus();
    }
}

// å›å ±ç¹³è²»
async function reportPayment(orderId, orderIndex) {
    const form = document.getElementById(`paymentForm_${orderIndex}`);
    const paymentMethod = form.getAttribute('data-payment-method');
    const paymentNote = document.getElementById(`paymentNote_${orderIndex}`).value.trim();
    
    if (!paymentMethod) {
        showMessage('è«‹é¸æ“‡ç¹³è²»æ–¹å¼', 'error');
        return;
    }
    
    if (paymentMethod === 'transfer' && !paymentNote) {
        showMessage('è½‰å¸³è«‹æä¾›å¾Œ5ç¢¼æˆ–ç›¸é—œè³‡è¨Š', 'error');
        return;
    }
    
    try {
        const response = await fetch(gasWebAppUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'reportPayment',
                data: {
                    orderId: orderId,
                    paymentMethod: paymentMethod,
                    paymentNote: paymentNote,
                    reportedBy: currentUser.displayName,
                    reportedAt: new Date().toISOString()
                }
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('âœ… ç¹³è²»å›å ±æˆåŠŸï¼ç­‰å¾…ç®¡ç†å“¡ç¢ºèª', 'success');
            setTimeout(() => loadUserOrders(), 1000);
        } else {
            throw new Error(result.message || 'å›å ±å¤±æ•—');
        }
        
    } catch (error) {
        console.error('å›å ±ç¹³è²»å¤±æ•—:', error);
        showMessage('âŒ å›å ±å¤±æ•—: ' + error.message, 'error');
    }
}

// è¼‰å…¥ç®¡ç†è€…è³‡æ–™
async function loadAdminData() {
    if (userRole !== 'admin') {
        document.getElementById('membersList').innerHTML = 
            '<div class="alert alert-error">âŒ æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™</div>';
        return;
    }
    
    try {
        document.getElementById('membersList').innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                è¼‰å…¥æœƒå“¡è³‡æ–™ä¸­...
            </div>
        `;
        
        const url = `${gasWebAppUrl}?action=getAllMembersWithOrders&timestamp=${Date.now()}`;
        
        const response = await fetch(url, {
            method: 'GET',
            mode: 'cors'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            displayMembersList(result.data || []);
        } else {
            throw new Error(result.message || 'è¼‰å…¥å¤±æ•—');
        }
        
    } catch (error) {
        console.error('è¼‰å…¥æœƒå“¡è³‡æ–™å¤±æ•—:', error);
        document.getElementById('membersList').innerHTML = 
            `<div class="alert alert-error">âŒ è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
    }
}

// é¡¯ç¤ºæœƒå“¡åˆ—è¡¨
function displayMembersList(members) {
    const statsContainer = document.getElementById('adminStats');
    const listContainer = document.getElementById('membersList');
    
    if (!members || members.length === 0) {
        listContainer.innerHTML = 
            '<div class="alert alert-info">ğŸ“ æš«ç„¡æœƒå“¡è³‡æ–™</div>';
        statsContainer.style.display = 'none';
        return;
    }
    
    // è¨ˆç®—çµ±è¨ˆè³‡æ–™
    const totalMembers = members.length;
    const pendingPayments = members.reduce((count, member) => {
        return count + (member.orders || []).filter(order => order.paymentStatus === 'reported').length;
    }, 0);
    
    document.getElementById('totalMembers').textContent = totalMembers;
    document.getElementById('pendingPayments').textContent = pendingPayments;
    statsContainer.style.display = 'grid';
    
    // é¡¯ç¤ºæœƒå“¡åˆ—è¡¨
    const memberHtml = members.map(member => {
        const orders = member.orders || [];
        const totalAmount = orders.reduce((sum, order) => sum + ((order.quantity || 1) * (order.unitPrice || 0)), 0);
        const reportedOrders = orders.filter(order => order.paymentStatus === 'reported');
        
        return `
            <div class="member-item" onclick="toggleMemberDetails('${member.lineUserId}')">
                <h5>${member.realName || member.displayName} 
                    ${reportedOrders.length > 0 ? `<span class="payment-status status-reported">${reportedOrders.length} ç­†å¾…ç¢ºèª</span>` : ''}
                </h5>
                <p>ğŸ“± LINE: ${member.displayName}</p>
                <p>ğŸ“¦ è¨‚å–®æ•¸: ${orders.length} ç­†</p>
                <p>ğŸ’° ç¸½é‡‘é¡: $${totalAmount}</p>
                
                <div id="memberDetails_${member.lineUserId}" class="hidden" style="margin-top: 15px;">
                    ${orders.map(order => `
                        <div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 3px solid ${order.paymentStatus === 'reported' ? '#ffc107' : order.paymentStatus === 'confirmed' ? '#28a745' : '#dc3545'};">
                            <strong>${order.productId}</strong> - æ•¸é‡: ${order.quantity} - $${(order.quantity || 1) * (order.unitPrice || 0)}
                            <br>ç‹€æ…‹: ${order.paymentStatus === 'confirmed' ? 'å·²ç¢ºèª' : order.paymentStatus === 'reported' ? 'å·²å›å ±' : 'æœªç¹³è²»'}
                            ${order.paymentMethod ? `<br>ç¹³è²»æ–¹å¼: ${order.paymentMethod}` : ''}
                            ${order.paymentNote ? `<br>å‚™è¨»: ${order.paymentNote}` : ''}
                            
                            ${order.paymentStatus === 'reported' ? `
                                <div class="admin-actions">
                                    <button class="admin-btn admin-btn-confirm" onclick="confirmPayment('${order.orderId}', event)">
                                        âœ… ç¢ºèªç¹³è²»
                                    </button>
                                    <button class="admin-btn admin-btn-reject" onclick="rejectPayment('${order.orderId}', event)">
                                        âŒ é§å›
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }).join('');
    
    listContainer.innerHTML = memberHtml;
}

// åˆ‡æ›æœƒå“¡è©³ç´°è³‡æ–™é¡¯ç¤º
function toggleMemberDetails(lineUserId) {
    const details = document.getElementById(`memberDetails_${lineUserId}`);
    if (details) {
        details.classList.toggle('hidden');
    }
}

// æœå°‹æœƒå“¡
function searchMembers() {
    const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
    
    if (!searchTerm) {
        loadAdminData();
        return;
    }
    
    const memberItems = document.querySelectorAll('.member-item');
    memberItems.forEach(item => {
        const memberName = item.querySelector('h5').textContent.toLowerCase();
        if (memberName.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// ç¢ºèªç¹³è²»
async function confirmPayment(orderId, event) {
    event.stopPropagation();
    
    if (!confirm('ç¢ºå®šè¦ç¢ºèªæ­¤ç­†ç¹³è²»å—ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch(gasWebAppUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'confirmPayment',
                data: {
                    orderId: orderId,
                    confirmedBy: currentUser.displayName,
                    confirmedAt: new Date().toISOString()
                }
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('âœ… ç¹³è²»å·²ç¢ºèªï¼', 'success');
            setTimeout(() => loadAdminData(), 1000);
        } else {
            throw new Error(result.message || 'ç¢ºèªå¤±æ•—');
        }
        
    } catch (error) {
        console.error('ç¢ºèªç¹³è²»å¤±æ•—:', error);
        showMessage('âŒ ç¢ºèªå¤±æ•—: ' + error.message, 'error');
    }
}

// é§å›ç¹³è²»
async function rejectPayment(orderId, event) {
    event.stopPropagation();
    
    const reason = prompt('è«‹è¼¸å…¥é§å›åŸå› ï¼š');
    if (!reason) {
        return;
    }
    
    try {
        const response = await fetch(gasWebAppUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'rejectPayment',
                data: {
                    orderId: orderId,
                    rejectedBy: currentUser.displayName,
                    rejectedAt: new Date().toISOString(),
                    rejectionReason: reason
                }
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('âœ… ç¹³è²»å·²é§å›ï¼', 'success');
            setTimeout(() => loadAdminData(), 1000);
        } else {
            throw new Error(result.message || 'é§å›å¤±æ•—');
        }
        
    } catch (error) {
        console.error('é§å›ç¹³è²»å¤±æ•—:', error);
        showMessage('âŒ é§å›å¤±æ•—: ' + error.message, 'error');
    }
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateString) {
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW') + ' ' + 
               date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
    } catch (error) {
        return 'æœªçŸ¥æ—¥æœŸ';
    }
}

// é¡¯ç¤ºè¨Šæ¯
function showMessage(message, type = 'info') {
    const messageContainer = document.getElementById('messageContainer');
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-error' : 
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    
    messageContainer.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
    
    // 5ç§’å¾Œè‡ªå‹•æ¸…é™¤è¨Šæ¯
    setTimeout(() => {
        messageContainer.innerHTML = '';
    }, 5000);
}

    </script>
</body>
</html>
