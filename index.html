<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¯¦ååˆ¶ç™»è¨˜èˆ‡ç¹³è²»ç³»çµ±</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 10px;
      }

      .container {
          max-width: 500px;
          margin: 0 auto;
          background: white;
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.2);
          overflow: hidden;
      }

      .header {
          background: linear-gradient(135deg, #4CAF50, #45a049);
          color: white;
          padding: 20px;
          text-align: center;
          position: relative;
      }

      .header h1 {
          font-size: 24px;
          margin-bottom: 5px;
      }

      .header p {
          opacity: 0.9;
          font-size: 14px;
      }

      .admin-btn {
          position: absolute;
          top: 10px;
          right: 10px;
          background: rgba(255,255,255,0.2);
          border: 1px solid rgba(255,255,255,0.3);
          color: white;
          padding: 5px 10px;
          border-radius: 15px;
          font-size: 12px;
          cursor: pointer;
          transition: all 0.3s;
      }

      .admin-btn:hover {
          background: rgba(255,255,255,0.3);
      }

      .content {
          padding: 20px;
      }

      .status-bar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #f8f9fa;
          padding: 10px 15px;
          border-radius: 8px;
          margin-bottom: 20px;
          font-size: 12px;
      }

      .status-item {
          display: flex;
          align-items: center;
          gap: 5px;
      }

      .status-indicator {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background: #dc3545;
          animation: pulse 2s infinite;
      }

      .status-indicator.success {
          background: #28a745;
          animation: none;
      }

      @keyframes pulse {
          0% { opacity: 1; }
          50% { opacity: 0.5; }
          100% { opacity: 1; }
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #333;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
          width: 100%;
          padding: 12px;
          border: 2px solid #e9ecef;
          border-radius: 8px;
          font-size: 16px;
          transition: all 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
          outline: none;
          border-color: #4CAF50;
          box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
      }

      .btn {
          width: 100%;
          padding: 15px;
          background: linear-gradient(135deg, #4CAF50, #45a049);
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          margin-bottom: 10px;
      }

      .btn:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
      }

      .btn:disabled {
          background: #ccc;
          cursor: not-allowed;
          transform: none;
          box-shadow: none;
      }

      .btn-secondary {
          background: linear-gradient(135deg, #6c757d, #5a6268);
      }

      .btn-danger {
          background: linear-gradient(135deg, #dc3545, #c82333);
      }

      .upload-area {
          border: 2px dashed #ddd;
          border-radius: 8px;
          padding: 40px 20px;
          text-align: center;
          cursor: pointer;
          transition: all 0.3s;
          background: #fafafa;
      }

      .upload-area:hover {
          border-color: #4CAF50;
          background: #f0f8f0;
      }

      .upload-area.dragover {
          border-color: #4CAF50;
          background: #e8f5e8;
          transform: scale(1.02);
      }

      .upload-icon {
          font-size: 48px;
          margin-bottom: 10px;
      }

      .upload-area p {
          margin: 10px 0 5px 0;
          font-weight: 600;
          color: #333;
      }

      .upload-area small {
          color: #666;
          font-size: 12px;
      }

      .section {
          display: none;
          animation: fadeIn 0.5s ease-in;
      }

      .section.active {
          display: block;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .order-card {
          background: #f8f9fa;
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 15px;
          border-left: 4px solid #4CAF50;
          transition: all 0.3s;
      }

      .order-card:hover {
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          transform: translateY(-1px);
      }

      .order-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
      }

      .order-id {
          font-weight: 600;
          color: #333;
      }

      .order-status {
          background: #4CAF50;
          color: white;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 12px;
      }

      .order-status.pending {
          background: #ffc107;
          color: #212529;
      }

      .order-status.completed {
          background: #28a745;
      }

      .order-status.cancelled {
          background: #dc3545;
      }

      .order-details {
          font-size: 14px;
          color: #666;
          line-height: 1.5;
      }

      .total-amount {
          background: linear-gradient(135deg, #e3f2fd, #bbdefb);
          padding: 20px;
          border-radius: 12px;
          text-align: center;
          margin: 20px 0;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      .total-amount h3 {
          color: #1976d2;
          margin-bottom: 10px;
          font-size: 18px;
      }

      .total-amount .amount {
          font-size: 28px;
          font-weight: bold;
          color: #d32f2f;
          text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      }

      .alert {
          padding: 15px 20px;
          border-radius: 8px;
          margin-bottom: 20px;
          font-size: 14px;
          border-left: 4px solid;
          position: relative;
      }

      .alert-success {
          background: #d4edda;
          color: #155724;
          border-left-color: #28a745;
      }

      .alert-error {
          background: #f8d7da;
          color: #721c24;
          border-left-color: #dc3545;
      }

      .alert-info {
          background: #d1ecf1;
          color: #0c5460;
          border-left-color: #17a2b8;
      }

      .alert-warning {
          background: #fff3cd;
          color: #856404;
          border-left-color: #ffc107;
      }

      .loading {
          text-align: center;
          padding: 40px;
      }

      .loading::after {
          content: '';
          display: inline-block;
          width: 24px;
          height: 24px;
          border: 3px solid #f3f3f3;
          border-top: 3px solid #4CAF50;
          border-radius: 50%;
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .progress-bar {
          width: 100%;
          height: 4px;
          background: #e9ecef;
          border-radius: 2px;
          overflow: hidden;
          margin-bottom: 20px;
      }

      .progress-fill {
          height: 100%;
          background: linear-gradient(90deg, #4CAF50, #45a049);
          border-radius: 2px;
          transition: width 0.3s ease;
      }

      .toast {
          position: fixed;
          top: 20px;
          right: 20px;
          background: white;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          padding: 15px 20px;
          z-index: 1000;
          transform: translateX(400px);
          transition: transform 0.3s ease;
      }

      .toast.show {
          transform: translateX(0);
      }

      .toast.success {
          border-left: 4px solid #28a745;
      }

      .toast.error {
          border-left: 4px solid #dc3545;
      }

      .toast.info {
          border-left: 4px solid #17a2b8;
      }

      .hidden {
          display: none !important;
      }

      .step-indicator {
          display: flex;
          justify-content: center;
          margin-bottom: 20px;
      }

      .step {
          width: 30px;
          height: 30px;
          border-radius: 50%;
          background: #e9ecef;
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 0 5px;
          font-size: 12px;
          font-weight: bold;
      }

      .step.active {
          background: #4CAF50;
          color: white;
      }

      .step.completed {
          background: #28a745;
          color: white;
      }

      /* ç®¡ç†å“¡é¢æ¿æ¨£å¼ */
      .admin-panel {
          background: #f8f9fa;
          border-radius: 8px;
          padding: 20px;
          margin-bottom: 20px;
      }

      .admin-tabs {
          display: flex;
          margin-bottom: 20px;
          border-bottom: 1px solid #dee2e6;
          overflow-x: auto;
      }

      .admin-tab {
          padding: 10px 20px;
          background: none;
          border: none;
          cursor: pointer;
          border-bottom: 2px solid transparent;
          transition: all 0.3s;
          white-space: nowrap;
      }

      .admin-tab.active {
          border-bottom-color: #4CAF50;
          color: #4CAF50;
          font-weight: 600;
      }

      .admin-tab:hover {
          background: rgba(76, 175, 80, 0.1);
      }

      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 15px;
          margin-bottom: 20px;
      }

      .stat-card {
          background: white;
          padding: 20px;
          border-radius: 8px;
          text-align: center;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          transition: transform 0.3s;
      }

      .stat-card:hover {
          transform: translateY(-2px);
      }

      .stat-number {
          font-size: 24px;
          font-weight: bold;
          color: #4CAF50;
      }

      .stat-label {
          font-size: 12px;
          color: #666;
          margin-top: 5px;
      }

      /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media (max-width: 480px) {
          .container {
              margin: 0;
              border-radius: 0;
              min-height: 100vh;
          }
          
          .content {
              padding: 15px;
          }
          
          .form-group input,
          .form-group select,
          .form-group textarea {
              font-size: 16px;
          }

          .admin-btn {
              position: static;
              margin-top: 10px;
              display: inline-block;
          }

          .total-amount .amount {
              font-size: 24px;
          }

          .upload-area {
              padding: 30px 15px;
          }

          .upload-icon {
              font-size: 36px;
          }

          .admin-tabs {
              flex-wrap: wrap;
          }

          .admin-tab {
              min-width: 80px;
              padding: 8px 12px;
              font-size: 14px;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <button class="admin-btn" onclick="checkAndShowAdminPanel()" id="adminToggle" style="display: none;">
              ğŸ› ï¸ ç®¡ç†
          </button>
          <h1>ğŸ« å¯¦ååˆ¶ç™»è¨˜ç³»çµ±</h1>
          <p>è«‹å®Œæˆå¯¦ååˆ¶ç™»è¨˜å¾ŒæŸ¥çœ‹è¨‚å–®</p>
      </div>

      <div class="content">
          <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
          <div class="step-indicator" id="stepIndicator">
              <div class="step active" id="step1">1</div>
              <div class="step" id="step2">2</div>
              <div class="step" id="step3">3</div>
          </div>

          <!-- ç‹€æ…‹åˆ— -->
          <div class="status-bar">
              <div class="status-item">
                  <div class="status-indicator" id="apiIndicator"></div>
                  <span id="apiStatus">é€£ç·šæª¢æŸ¥ä¸­...</span>
              </div>
              <div class="status-item">
                  <div class="status-indicator" id="liffIndicator"></div>
                  <span id="liffStatus">LIFF åˆå§‹åŒ–ä¸­...</span>
              </div>
          </div>

          <!-- é€²åº¦æ¢ -->
          <div class="progress-bar" id="progressBar" style="display: none;">
              <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
          </div>

          <!-- è¼‰å…¥ä¸­ -->
          <div id="loadingSection" class="section active">
              <div class="loading">
                  <p>ç³»çµ±åˆå§‹åŒ–ä¸­ï¼Œè«‹ç¨å€™...</p>
              </div>
          </div>

          <!-- å¯¦ååˆ¶ç™»è¨˜è¡¨å–® -->
          <div id="registrationSection" class="section">
              <div class="alert alert-info">
                  <strong>ğŸ“ æ­¥é©Ÿ 1: å¯¦ååˆ¶ç™»è¨˜</strong><br>
                  è«‹å¡«å¯«çœŸå¯¦è³‡æ–™ä»¥å®Œæˆç™»è¨˜ï¼Œç™»è¨˜å¾Œå³å¯æŸ¥çœ‹æ‚¨çš„è¨‚å–®è³‡è¨Šã€‚
              </div>

              <form id="registrationForm">
                  <div class="form-group">
                      <label for="lineName">LINE é¡¯ç¤ºåç¨±</label>
                      <input type="text" id="lineName" readonly>
                  </div>

                  <div class="form-group">
                      <label for="realName">çœŸå¯¦å§“å *</label>
                      <input type="text" id="realName" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" required>
                  </div>

                  <div class="form-group">
                      <label for="idNumber">èº«åˆ†è­‰å­—è™Ÿ *</label>
                      <input type="text" id="idNumber" placeholder="ä¾‹ï¼šA123456789" required maxlength="10" style="text-transform: uppercase;">
                  </div>

                  <div class="form-group">
                      <label for="phoneNumber">æ‰‹æ©Ÿè™Ÿç¢¼ *</label>
                      <input type="tel" id="phoneNumber" placeholder="ä¾‹ï¼š0912345678" required maxlength="10">
                  </div>

                  <button type="submit" class="btn" id="registerBtn">
                      å®Œæˆå¯¦ååˆ¶ç™»è¨˜
                  </button>
              </form>
          </div>

          <!-- è¨‚å–®åˆ—è¡¨ -->
          <div id="ordersSection" class="section">
              <div class="alert alert-success">
                  <strong>âœ… æ­¥é©Ÿ 2: æŸ¥çœ‹è¨‚å–®</strong><br>
                  <span id="userInfo"></span>
              </div>

              <div id="ordersContainer">
                  <!-- è¨‚å–®å°‡å‹•æ…‹è¼‰å…¥åˆ°é€™è£¡ -->
              </div>

              <div class="total-amount">
                  <h3>ç¸½æ‡‰ç¹³é‡‘é¡</h3>
                  <div class="amount" id="totalAmount">NT$ 0</div>
              </div>

              <button class="btn" id="proceedToPaymentBtn">
                  å‰å¾€ç¹³è²»
              </button>

              <button class="btn btn-secondary" id="refreshOrdersBtn">
                  ğŸ”„ é‡æ–°æ•´ç†è¨‚å–®
              </button>
          </div>

          <!-- ç¹³è²»è­‰æ˜ä¸Šå‚³ -->
          <div id="paymentSection" class="section">
              <div class="alert alert-info">
                  <strong>ğŸ’³ æ­¥é©Ÿ 3: ä¸Šå‚³ç¹³è²»è­‰æ˜</strong><br>
                  è«‹é¸æ“‡ç¹³è²»æ–¹å¼ä¸¦ä¸Šå‚³ç›¸é—œè­‰æ˜æ–‡ä»¶ã€‚
              </div>

              <form id="paymentForm">
                  <div class="form-group">
                      <label for="paymentMethod">ç¹³è²»æ–¹å¼ *</label>
                      <select id="paymentMethod" required>
                          <option value="">è«‹é¸æ“‡ç¹³è²»æ–¹å¼</option>
                          <option value="bank_transfer">éŠ€è¡Œè½‰å¸³</option>
                          <option value="atm">ATM è½‰å¸³</option>
                          <option value="cash">ç¾é‡‘ç¹³è²»</option>
                      </select>
                  </div>

                  <div class="form-group">
                      <label>ä¸Šå‚³ç¹³è²»è­‰æ˜</label>
                      <div class="upload-area" onclick="document.getElementById('paymentProof').click()">
                          <div class="upload-icon">ğŸ“·</div>
                          <p>é»æ“Šä¸Šå‚³ç¹³è²»è­‰æ˜ç…§ç‰‡</p>
                          <small>æ”¯æ´ JPGã€PNGã€PDF æ ¼å¼ï¼Œæª”æ¡ˆå¤§å°é™åˆ¶ 5MB</small>
                      </div>
                      <input type="file" id="paymentProof" accept="image/*,.pdf" style="display: none;" onchange="handleFileUpload(this)">
                  </div>

                  <div class="form-group" id="noteFieldGroup">
                      <label for="paymentNote">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                      <textarea id="paymentNote" rows="3" placeholder="å¦‚æœ‰ç‰¹æ®Šèªªæ˜è«‹åœ¨æ­¤å¡«å¯«..."></textarea>
                  </div>

                  <button type="button" class="btn" id="submitPaymentBtn" onclick="submitPayment()">
                      æäº¤ç¹³è²»è­‰æ˜
                  </button>

                  <button type="button" class="btn btn-secondary" id="backToOrdersBtn">
                      â† è¿”å›è¨‚å–®åˆ—è¡¨
                  </button>
              </form>
          </div>

          <!-- ç®¡ç†å“¡é¢æ¿ -->
          <div id="adminSection" class="section">
              <div class="admin-panel">
                  <div class="alert alert-success">
                      <strong>ğŸ› ï¸ ç®¡ç†å“¡é¢æ¿</strong><br>
                      <span id="adminWelcome"></span>
                  </div>

                  <div class="admin-tabs">
                      <button class="admin-tab active" onclick="showAdminTab('dashboard')">å„€è¡¨æ¿</button>
                      <button class="admin-tab" onclick="showAdminTab('users')">ç”¨æˆ¶ç®¡ç†</button>
                      <button class="admin-tab" onclick="showAdminTab('payments')">ç¹³è²»ç®¡ç†</button>
                      <button class="admin-tab" onclick="showAdminTab('admins')">ç®¡ç†å“¡</button>
                  </div>

                  <div id="adminContent">
                      <!-- ç®¡ç†å“¡å…§å®¹å°‡è¼‰å…¥åˆ°é€™è£¡ -->
                  </div>

                  <button class="btn btn-secondary" onclick="backToMainSystem()">
                      â† è¿”å›ä¸»ç³»çµ±
                  </button>
              </div>
          </div>
      </div>
  </div>

  <script>
      // ==================== å…¨åŸŸè¨­å®š ====================
      const CONFIG = {
          LIFF_ID: '1657285806-2bmkYWkN',
          API_BASE_URL: 'https://script.google.com/macros/s/AKfycbz1lAflrwjF4xlRyvlL5huXlMlqzx9qI_u7yUFdqImlzdOagtBwKuJJFVAQKkY8BDmz/exec',
          DEBUG_MODE: true,
          DEMO_MODE: false, // è¨­ç‚º true ä»¥ä½¿ç”¨ç¤ºç¯„è³‡æ–™ 
          RETRY_ATTEMPTS: 3,
          RETRY_DELAY: 1000,
          API_TIMEOUT: 30000
      };

      // ==================== å…¨åŸŸè®Šæ•¸ ====================
      let liffProfile = null;
      let systemConfig = null;
      let currentOrderSummary = null;
      let debugLogs = [];
      let isAdminUser = false;
      let currentAdminTab = 'dashboard';

      // ==================== å·¥å…·å‡½æ•¸ ====================
      function showToast(message, type = 'info', duration = 3000) {
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          toast.innerHTML = `<div class="toast-content">${message}</div>`;
          
          document.body.appendChild(toast);
          setTimeout(() => toast.classList.add('show'), 100);
          
          setTimeout(() => {
              toast.classList.remove('show');
              setTimeout(() => document.body.removeChild(toast), 300);
          }, duration);
      }

      function showProgress(percentage) {
          const progressBar = document.getElementById('progressBar');
          const progressFill = document.getElementById('progressFill');
          
          if (percentage > 0) {
              progressBar.style.display = 'block';
              progressFill.style.width = percentage + '%';
          } else {
              progressBar.style.display = 'none';
          }
      }

      function updateStepIndicator(currentStep) {
          for (let i = 1; i <= 3; i++) {
              const step = document.getElementById(`step${i}`);
              if (i < currentStep) {
                  step.className = 'step completed';
              } else if (i === currentStep) {
                  step.className = 'step active';
              } else {
                  step.className = 'step';
              }
          }
      }

      function debugLog(message, data = null) {
          const timestamp = new Date().toLocaleTimeString();
          console.log(`[${timestamp}] ${message}`, data || '');
          debugLogs.push({ timestamp, message, data });
      }

      function showSection(sectionId) {
          document.querySelectorAll('.section').forEach(section => {
              section.classList.remove('active');
          });
          
          const targetSection = document.getElementById(sectionId);
          if (targetSection) {
              targetSection.classList.add('active');
              debugLog(`é¡¯ç¤ºå€åŸŸ: ${sectionId}`);
              
              // æ›´æ–°æ­¥é©ŸæŒ‡ç¤ºå™¨
              switch (sectionId) {
                  case 'registrationSection':
                      updateStepIndicator(1);
                      break;
                  case 'ordersSection':
                      updateStepIndicator(2);
                      break;
                  case 'paymentSection':
                      updateStepIndicator(3);
                      break;
              }
          }
      }

      function showSuccess(message) {
          showToast(message, 'success', 4000);
      }

      function showError(message) {
          showToast(message, 'error', 6000);
      }

      function showInfo(message) {
          showToast(message, 'info', 3000);
      }

      // ==================== API ç›¸é—œå‡½æ•¸ ====================
      async function callAPI(action, data = {}) {
          try {
              debugLog('API å‘¼å«', { action, data });
              
              if (CONFIG.DEMO_MODE) {
                  return handleDemoResponse(action, data);
              }
              
              // ç”Ÿæˆå”¯ä¸€çš„å›èª¿å‡½æ•¸åç¨±
              const callbackName = 'apiCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
              
              return new Promise((resolve, reject) => {
                  // è¨­å®šè¶…æ™‚
                  const timeout = setTimeout(() => {
                      cleanup();
                      reject(new Error('API è«‹æ±‚è¶…æ™‚'));
                  }, CONFIG.API_TIMEOUT);
                  
                  // å®šç¾©å›èª¿å‡½æ•¸
                  window[callbackName] = function(response) {
                      clearTimeout(timeout);
                      cleanup();
                      debugLog('API å›æ‡‰', { action, response });
                      resolve(response);
                  };
                  
                  // æ¸…ç†å‡½æ•¸
                  function cleanup() {
                      if (window[callbackName]) {
                          delete window[callbackName];
                      }
                      if (script && script.parentNode) {
                          script.parentNode.removeChild(script);
                      }
                  }
                  
                  // å»ºç«‹ JSONP è«‹æ±‚
                  const script = document.createElement('script');
                  const params = new URLSearchParams({
                      action: action,
                      data: JSON.stringify(data),
                      callback: callbackName,
                      _: Date.now() // é˜²æ­¢å¿«å–
                  });
                  
                  script.src = `${CONFIG.API_BASE_URL}?${params.toString()}`;
                  script.onerror = function() {
                      clearTimeout(timeout);
                      cleanup();
                      reject(new Error('API è«‹æ±‚å¤±æ•—'));
                  };
                  
                  document.head.appendChild(script);
              });
              
          } catch (error) {
              debugLog('API å‘¼å«éŒ¯èª¤', error);
              throw error;
          }
      }

      function handleDemoResponse(action, data) {
          debugLog(`ä½¿ç”¨ç¤ºç¯„è³‡æ–™: ${action}`, data);
          
          switch (action) {
              case 'test':
                  return { success: true, message: 'API é€£ç·šæ¸¬è©¦æˆåŠŸï¼ˆç¤ºç¯„æ¨¡å¼ï¼‰' };
                  
              case 'get-config':
                  return {
                      success: true,
                      config: {
                          basic: {
                              'APIé€£ç·šç‹€æ…‹é¡¯ç¤º': true,
                              'é™¤éŒ¯è³‡è¨Šé¡¯ç¤º': true,
                              'LIFFç’°å¢ƒè³‡è¨Šé¡¯ç¤º': false,
                              'ç¹³è²»è­‰æ˜ä¸Šå‚³': 'å¿…é ˆ',
                              'å‚™è¨»æ¬„ä½é¡¯ç¤º': true,
                              'ç³»çµ±ç¶­è­·æ¨¡å¼': false,
                              'æœ€å¤§æª”æ¡ˆå¤§å°MB': 5,
                              'å…è¨±æª”æ¡ˆæ ¼å¼': ['jpg', 'png', 'pdf']
                          },
                          paymentMethods: [
                              { code: 'bank_transfer', name: 'éŠ€è¡Œè½‰å¸³', enabled: true },
                              { code: 'cash', name: 'ç¾é‡‘ç¹³è²»', enabled: true },
                              { code: 'atm', name: 'ATMè½‰å¸³', enabled: true }
                          ],
                          messages: {
                                welcome_message: 'æ­¡è¿ä½¿ç”¨æœ¬ç³»çµ±ï¼',
                                upload_success: 'ç¹³è²»è­‰æ˜ä¸Šå‚³æˆåŠŸï¼',
                                upload_error: 'ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼',
                                registration_success: 'å¯¦ååˆ¶ç™»è¨˜å®Œæˆï¼'
                            }
                        }
                    };
                    
                case 'check-registration':
                    return { success: true, registered: false };
                    
                case 'register':
                    return {
                        success: true,
                        message: 'å¯¦ååˆ¶ç™»è¨˜å®Œæˆï¼ˆç¤ºç¯„æ¨¡å¼ï¼‰',
                        userData: {
                            lineName: data.lineName,
                            realName: data.realName,
                            idNumber: data.idNumber,
                            phoneNumber: data.phoneNumber,
                            registrationTime: new Date(),
                            status: 'å·²ç™»è¨˜'
                        }
                    };
                    
                case 'orders':
                    return {
                        success: true,
                        orders: [
                            {
                                orderId: 'ORDER001',
                                lineName: data.lineName,
                                realName: 'ç¤ºç¯„ç”¨æˆ¶',
                                productName: 'ç¤ºç¯„å•†å“A',
                                quantity: 2,
                                unitPrice: 500,
                                totalPrice: 1000,
                                status: 'å¾…ä»˜æ¬¾',
                                createdAt: new Date(),
                                note: 'ç¤ºç¯„è¨‚å–®'
                            },
                            {
                                orderId: 'ORDER002',
                                lineName: data.lineName,
                                realName: 'ç¤ºç¯„ç”¨æˆ¶',
                                productName: 'ç¤ºç¯„å•†å“B',
                                quantity: 1,
                                unitPrice: 800,
                                totalPrice: 800,
                                status: 'å¾…ä»˜æ¬¾',
                                createdAt: new Date(),
                                note: 'å¦ä¸€å€‹ç¤ºç¯„è¨‚å–®'
                            }
                        ],
                        totalAmount: 1800,
                        userData: {
                            lineName: data.lineName,
                            realName: 'ç¤ºç¯„ç”¨æˆ¶',
                            status: 'å·²ç™»è¨˜'
                        }
                    };
                    
                case 'submit-payment':
                    return { success: true, message: 'ç¹³è²»è­‰æ˜æäº¤æˆåŠŸï¼ˆç¤ºç¯„æ¨¡å¼ï¼‰' };
                    
                case 'check-admin':
                    return {
                        success: true,
                        isAdmin: true,
                        role: 'admin',
                        adminData: { name: 'ç¤ºç¯„ç®¡ç†å“¡', lineId: data.userId }
                    };
                    
                default:
                    return { success: false, message: 'æœªçŸ¥çš„ç¤ºç¯„æ“ä½œ' };
            }
        }

        // ==================== åˆå§‹åŒ–å‡½æ•¸ ====================
        async function initializeLiff() {
            try {
                debugLog('é–‹å§‹åˆå§‹åŒ– LIFF');
                showProgress(10);
                
                await loadSystemConfig();
                showProgress(30);
                
                updateLiffStatus('åˆå§‹åŒ–ä¸­...', false);
                
                if (CONFIG.DEMO_MODE) {
                    // ç¤ºç¯„æ¨¡å¼
                    liffProfile = { displayName: 'ç¤ºç¯„ç”¨æˆ¶', userId: 'demo123' };
                    debugLog('ä½¿ç”¨ç¤ºç¯„æ¨¡å¼');
                    showProgress(80);
                    
                    const lineNameInput = document.getElementById('lineName');
                    if (lineNameInput) {
                        lineNameInput.value = liffProfile.displayName;
                    }
                    
                    await checkAdminPermission();
                    await checkRegistrationStatus();
                    showProgress(100);
                    updateLiffStatus('å·²é€£ç·šï¼ˆç¤ºç¯„ï¼‰', true);
                } else {
                    // æ­£å¸¸ LIFF æ¨¡å¼
                    if (typeof liff === 'undefined') {
                        throw new Error('LIFF SDK æœªè¼‰å…¥');
                    }
                    
                    await liff.init({ liffId: CONFIG.LIFF_ID });
                    debugLog('LIFF åˆå§‹åŒ–æˆåŠŸ');
                    showProgress(60);
                    
                    if (liff.isLoggedIn()) {
                        liffProfile = await liff.getProfile();
                        debugLog('å–å¾—ç”¨æˆ¶è³‡æ–™', liffProfile);
                        showProgress(80);
                        
                        const lineNameInput = document.getElementById('lineName');
                        if (lineNameInput) {
                            lineNameInput.value = liffProfile.displayName;
                        }
                        
                        await checkAdminPermission();
                        await checkRegistrationStatus();
                        showProgress(100);
                        updateLiffStatus('å·²é€£ç·š', true);
                    } else {
                        debugLog('ç”¨æˆ¶æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
                        liff.login();
                    }
                }
                
                setTimeout(() => showProgress(0), 500);
                
            } catch (error) {
                debugLog('LIFF åˆå§‹åŒ–å¤±æ•—', error);
                updateLiffStatus('é€£ç·šå¤±æ•—', false);
                showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                showProgress(0);
            }
        }

        async function loadSystemConfig() {
            try {
                debugLog('è¼‰å…¥ç³»çµ±è¨­å®š');
                const result = await callAPI('get-config', {});
                
                if (result.success) {
                    systemConfig = result.config;
                    debugLog('ç³»çµ±è¨­å®šè¼‰å…¥æˆåŠŸ', systemConfig);
                    return true;
                } else {
                    debugLog('è¼‰å…¥ç³»çµ±è¨­å®šå¤±æ•—', result);
                    return false;
                }
            } catch (error) {
                debugLog('è¼‰å…¥ç³»çµ±è¨­å®šå¤±æ•—', error);
                return false;
            }
        }

        async function checkAdminPermission() {
            try {
                if (!liffProfile) return;
                
                const result = await callAPI('check-admin', {
                    userId: liffProfile.userId,
                    requiredRole: 'viewer'
                });
                
                if (result.success && result.isAdmin) {
                    isAdminUser = true;
                    const adminToggle = document.getElementById('adminToggle');
                    if (adminToggle) {
                        adminToggle.style.display = 'block';
                    }
                    debugLog('ç”¨æˆ¶å…·æœ‰ç®¡ç†å“¡æ¬Šé™', result);
                }
            } catch (error) {
                debugLog('æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™æ™‚ç™¼ç”ŸéŒ¯èª¤', error);
            }
        }

        async function checkRegistrationStatus() {
            try {
                debugLog('æª¢æŸ¥ç”¨æˆ¶ç™»è¨˜ç‹€æ…‹');
                
                if (!liffProfile) {
                    showError('ç„¡æ³•å–å¾—ç”¨æˆ¶è³‡æ–™');
                    return;
                }
                
                const result = await callAPI('check-registration', {
                    lineName: liffProfile.displayName
                });
                
                if (result.success) {
                    if (result.registered) {
                        debugLog('ç”¨æˆ¶å·²å®Œæˆç™»è¨˜', result.userData);
                        await loadUserOrders();
                    } else {
                        debugLog('ç”¨æˆ¶å°šæœªç™»è¨˜');
                        showSection('registrationSection');
                    }
                } else {
                    debugLog('æª¢æŸ¥ç™»è¨˜ç‹€æ…‹å¤±æ•—', result);
                    showError(result.message || 'æª¢æŸ¥ç™»è¨˜ç‹€æ…‹å¤±æ•—');
                }
            } catch (error) {
                debugLog('æª¢æŸ¥ç™»è¨˜ç‹€æ…‹å¤±æ•—', error);
                showError('æª¢æŸ¥ç™»è¨˜ç‹€æ…‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        // ==================== äº‹ä»¶è™•ç†å‡½æ•¸ ====================
        async function handleRegistration(event) {
            event.preventDefault();
            
            try {
                debugLog('è™•ç†ç”¨æˆ¶ç™»è¨˜');
                
                const formData = {
                    lineName: document.getElementById('lineName').value,
                    realName: document.getElementById('realName').value,
                    idNumber: document.getElementById('idNumber').value.toUpperCase(),
                    phoneNumber: document.getElementById('phoneNumber').value
                };
                
                // å‰ç«¯é©—è­‰
                if (!formData.realName || !formData.idNumber || !formData.phoneNumber) {
                    showError('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');
                    return;
                }
                
                const idPattern = /^[A-Z][12]\d{8}$/;
                if (!idPattern.test(formData.idNumber)) {
                    showError('èº«åˆ†è­‰å­—è™Ÿæ ¼å¼ä¸æ­£ç¢º');
                    return;
                }
                
                const phonePattern = /^09\d{8}$/;
                if (!phonePattern.test(formData.phoneNumber)) {
                    showError('é›»è©±è™Ÿç¢¼æ ¼å¼ä¸æ­£ç¢ºï¼ˆè«‹è¼¸å…¥09é–‹é ­çš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼‰');
                    return;
                }
                
                const submitBtn = document.getElementById('registerBtn');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'ç™»è¨˜ä¸­...';
                submitBtn.disabled = true;
                
                const result = await callAPI('register', formData);
                
                if (result.success) {
                    debugLog('ç”¨æˆ¶ç™»è¨˜æˆåŠŸ', result);
                    showSuccess('å¯¦ååˆ¶ç™»è¨˜å®Œæˆï¼');
                    
                    setTimeout(async () => {
                        await loadUserOrders();
                    }, 1500);
                } else {
                    debugLog('ç”¨æˆ¶ç™»è¨˜å¤±æ•—', result);
                    showError(result.message || 'ç™»è¨˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                debugLog('ç”¨æˆ¶ç™»è¨˜å¤±æ•—', error);
                showError('ç™»è¨˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                
                const submitBtn = document.getElementById('registerBtn');
                if (submitBtn) {
                    submitBtn.textContent = 'å®Œæˆå¯¦ååˆ¶ç™»è¨˜';
                    submitBtn.disabled = false;
                }
            }
        }

        async function loadUserOrders() {
            try {
                debugLog('è¼‰å…¥ç”¨æˆ¶è¨‚å–®');
                
                if (!liffProfile) {
                    showError('ç„¡æ³•å–å¾—ç”¨æˆ¶è³‡æ–™');
                    return;
                }
                
                const result = await callAPI('orders', {
                    lineName: liffProfile.displayName
                });
                
                if (result.success) {
                    debugLog('è¨‚å–®è¼‰å…¥æˆåŠŸ', result);
                    
                    const userInfo = document.getElementById('userInfo');
                    if (userInfo && result.userData) {
                        userInfo.textContent = `å§“åï¼š${result.userData.realName} | ç™»è¨˜æ™‚é–“ï¼š${new Date(result.userData.registrationTime).toLocaleString()}`;
                    }
                    
                    displayOrders(result.orders, result.totalAmount);
                    
                    currentOrderSummary = {
                        orders: result.orders,
                        totalAmount: result.totalAmount,
                        userData: result.userData,
                        lineName: liffProfile.displayName,
                        realName: result.userData.realName,
                        orderId: result.orders.map(o => o.orderId).join(',')
                    };
                    
                    showSection('ordersSection');
                } else {
                    debugLog('è¼‰å…¥è¨‚å–®å¤±æ•—', result);
                    if (result.needRegistration) {
                        showSection('registrationSection');
                    } else {
                        showError(result.message || 'è¼‰å…¥è¨‚å–®å¤±æ•—');
                    }
                }
            } catch (error) {
                debugLog('è¼‰å…¥è¨‚å–®å¤±æ•—', error);
                showError('è¼‰å…¥è¨‚å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        function displayOrders(orders, totalAmount) {
            const container = document.getElementById('ordersContainer');
            const totalAmountElement = document.getElementById('totalAmount');
            
            if (!container || !totalAmountElement) return;
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <strong>ğŸ“‹ æš«ç„¡è¨‚å–®</strong><br>
                        ç›®å‰æ²’æœ‰æ‰¾åˆ°æ‚¨çš„è¨‚å–®è³‡æ–™ã€‚
                    </div>
                `;
                totalAmountElement.textContent = 'NT$ 0';
                return;
            }
            
            container.innerHTML = orders.map(order => {
                const statusClass = order.status === 'å¾…ä»˜æ¬¾' ? 'pending' : 
                                  order.status === 'å·²å®Œæˆ' ? 'completed' : 
                                  order.status === 'å·²å–æ¶ˆ' ? 'cancelled' : '';
                
                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-id">è¨‚å–® ${order.orderId}</div>
                            <div class="order-status ${statusClass}">${order.status}</div>
                        </div>
                        <div class="order-details">
                            <div><strong>${order.productName}</strong></div>
                            <div>æ•¸é‡ï¼š${order.quantity} | å–®åƒ¹ï¼šNT$ ${order.unitPrice?.toLocaleString()}</div>
                            <div>å°è¨ˆï¼šNT$ ${order.totalPrice?.toLocaleString()}</div>
                            ${order.note ? `<div>å‚™è¨»ï¼š${order.note}</div>` : ''}
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                å»ºç«‹æ™‚é–“ï¼š${new Date(order.createdAt).toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            totalAmountElement.textContent = `NT$ ${totalAmount.toLocaleString()}`;
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            const maxSizeMB = 5;
            const maxSizeBytes = maxSizeMB * 1024 * 1024;
            const allowedFormats = ['jpg', 'jpeg', 'png', 'pdf'];
            
            if (file.size > maxSizeBytes) {
                showError(`æª”æ¡ˆå¤§å°è¶…éé™åˆ¶ï¼ˆæœ€å¤§ ${maxSizeMB}MBï¼‰`);
                input.value = '';
                return;
            }
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!allowedFormats.includes(fileExtension)) {
                showError(`ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼Œè«‹ä½¿ç”¨ï¼š${allowedFormats.join(', ').toUpperCase()}`);
                input.value = '';
                return;
            }
            
            debugLog('æª”æ¡ˆé©—è­‰é€šé', { 
                name: file.name, 
                size: file.size, 
                type: file.type,
                extension: fileExtension
            });
            
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.innerHTML = `
                <div class="upload-icon">âœ…</div>
                <p>å·²é¸æ“‡: ${file.name}</p>
                <small>æª”æ¡ˆå¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB</small>
            `;
            uploadArea.style.background = '#d4edda';
            uploadArea.style.borderColor = '#28a745';
            
            showSuccess('æª”æ¡ˆé¸æ“‡æˆåŠŸ');
        }

        async function submitPayment() {
            debugLog('æäº¤ç¹³è²»è­‰æ˜');
            
            if (!currentOrderSummary) {
                showError('ç„¡æ³•å–å¾—è¨‚å–®è³‡è¨Šï¼Œè«‹é‡æ–°è¼‰å…¥');
                return;
            }
            
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paymentNote = document.getElementById('paymentNote').value;
            const paymentProof = document.getElementById('paymentProof').files[0];
            
            if (!paymentMethod) {
                showError('è«‹é¸æ“‡ç¹³è²»æ–¹å¼');
                return;
            }
            
            if (!paymentProof) {
                showError('è«‹ä¸Šå‚³ç¹³è²»è­‰æ˜');
                return;
            }
            
            const paymentData = {
                orderId: currentOrderSummary.orderId,
                lineName: currentOrderSummary.lineName,
                realName: currentOrderSummary.realName,
                paymentAmount: currentOrderSummary.totalAmount,
                paymentMethod: paymentMethod,
                paymentNote: paymentNote,
                hasProof: !!paymentProof,
                submittedAt: new Date().toISOString()
            };
            
            try {
                const submitBtn = document.getElementById('submitPaymentBtn');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'æäº¤ä¸­...';
                submitBtn.disabled = true;
                
                const result = await callAPI('submit-payment', paymentData);
                
                if (result.success) {
                    debugLog('ç¹³è²»è­‰æ˜æäº¤æˆåŠŸ');
                    showSuccess('ç¹³è²»è­‰æ˜æäº¤æˆåŠŸï¼');
                    
                    // æ¸…ç©ºè¡¨å–®
                    document.getElementById('paymentNote').value = '';
                    document.getElementById('paymentProof').value = '';
                    document.getElementById('paymentMethod').selectedIndex = 0;
                    
                    // é‡ç½®ä¸Šå‚³å€åŸŸ
                    const uploadArea = document.querySelector('.upload-area');
                    uploadArea.innerHTML = `
                        <div class="upload-icon">ğŸ“·</div>
                        <p>é»æ“Šä¸Šå‚³ç¹³è²»è­‰æ˜ç…§ç‰‡</p>
                        <small>æ”¯æ´ JPGã€PNGã€PDF æ ¼å¼ï¼Œæª”æ¡ˆå¤§å°é™åˆ¶ 5MB</small>
                    `;
                    uploadArea.style.background = '';
                    uploadArea.style.borderColor = '';
                    
                    submitBtn.textContent = 'âœ… å·²æäº¤';
                    submitBtn.disabled = true;
                    submitBtn.classList.add('btn-secondary');
                    
                    // 3ç§’å¾Œè¿”å›è¨‚å–®åˆ—è¡¨
                    setTimeout(() => {
                        showSection('ordersSection');
                    }, 3000);
                } else {
                    debugLog('ç¹³è²»è­‰æ˜æäº¤å¤±æ•—', result);
                    showError(result.message || 'æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                debugLog('ç¹³è²»è­‰æ˜æäº¤å¤±æ•—', error);
                showError('æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦: ' + error.message);
                
                const submitBtn = document.getElementById('submitPaymentBtn');
                if (submitBtn) {
                    submitBtn.textContent = 'æäº¤ç¹³è²»è­‰æ˜';
                    submitBtn.disabled = false;
                }
            }
        }

        // ==================== ç®¡ç†å“¡åŠŸèƒ½ ====================
        async function checkAndShowAdminPanel() {
            try {
                if (!liffProfile) {
                    showError('è«‹å…ˆç™»å…¥ LINE');
                    return;
                }
                
                const result = await callAPI('check-admin', {
                    userId: liffProfile.userId,
                    requiredRole: 'viewer'
                });
                
                if (result.success && result.isAdmin) {
                    isAdminUser = true;
                    showAdminPanel(result);
                } else {
                    showError('æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™');
                }
            } catch (error) {
                debugLog('æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™å¤±æ•—', error);
                showError('æ¬Šé™æª¢æŸ¥å¤±æ•—');
            }
        }

        function showAdminPanel(adminInfo) {
            const adminWelcome = document.getElementById('adminWelcome');
            if (adminWelcome) {
                adminWelcome.textContent = `æ­¡è¿ï¼Œ${adminInfo.adminData.name}ï¼ˆ${adminInfo.role}ï¼‰`;
            }
            
            showSection('adminSection');
            showAdminTab('dashboard');
        }

        async function showAdminTab(tabName) {
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`[onclick="showAdminTab('${tabName}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            currentAdminTab = tabName;
            const adminContent = document.getElementById('adminContent');
            
            try {
                switch (tabName) {
                    case 'dashboard':
                        await loadAdminDashboard();
                        break;
                    case 'users':
                        await loadUserManagement();
                        break;
                    case 'payments':
                        await loadPaymentManagement();
                        break;
                    case 'admins':
                        await loadAdminManagement();
                        break;
                }
            } catch (error) {
                debugLog(`è¼‰å…¥ç®¡ç†å“¡æ¨™ç±¤é å¤±æ•—: ${tabName}`, error);
                adminContent.innerHTML = `<div class="alert alert-error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
            }
        }

        async function loadAdminDashboard() {
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">128</div>
                        <div class="stat-label">ç¸½ç”¨æˆ¶æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalOrders">256</div>
                        <div class="stat-label">ç¸½è¨‚å–®æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingPayments">12</div>
                        <div class="stat-label">å¾…å¯©æ ¸ç¹³è²»</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalAmount">NT$ 128,000</div>
                        <div class="stat-label">ç¸½é‡‘é¡</div>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <strong>ğŸ“Š ç³»çµ±çµ±è¨ˆ</strong><br>
                    ç³»çµ±é‹è¡Œæ­£å¸¸ï¼Œæ‰€æœ‰åŠŸèƒ½å¯æ­£å¸¸ä½¿ç”¨ã€‚
                </div>
            `;
        }

        async function loadUserManagement() {
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="alert alert-info">
                    <strong>ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</strong><br>
                    ç®¡ç†æ‰€æœ‰è¨»å†Šç”¨æˆ¶
                </div>
                
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-id">ç¤ºç¯„ç”¨æˆ¶1</div>
                        <div class="order-status">å·²ç™»è¨˜</div>
                    </div>
                    <div class="order-details">
                        <div>LINE: ç¤ºç¯„ç”¨æˆ¶1</div>
                        <div>è¨»å†Šæ™‚é–“: 2024-01-15 10:30</div>
                        <div>è¨‚å–®æ•¸: 3</div>
                    </div>
                </div>
            `;
        }

        async function loadPaymentManagement() {
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="alert alert-warning">
                    <strong>ğŸ’³ ç¹³è²»ç®¡ç†</strong><br>
                    å¯©æ ¸ç”¨æˆ¶æäº¤çš„ç¹³è²»è­‰æ˜
                </div>
                
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-id">PAY001</div>
                        <div class="order-status pending">å¾…å¯©æ ¸</div>
                    </div>
                    <div class="order-details">
                        <div>ç”¨æˆ¶: ç¤ºç¯„ç”¨æˆ¶</div>
                        <div>é‡‘é¡: NT$ 1,000</div>
                        <div>æ–¹å¼: éŠ€è¡Œè½‰å¸³</div>
                        <div>æäº¤æ™‚é–“: 2024-01-15 14:20</div>
                        <div style="margin-top: 10px;">
                            <button class="btn" style="padding: 5px 15px; margin-right: 10px;" onclick="reviewPayment('PAY001', 'approved')">ç¢ºèª</button>
                            <button class="btn btn-danger" style="padding: 5px 15px;" onclick="reviewPayment('PAY001', 'rejected')">æ‹’çµ•</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadAdminManagement() {
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = `
                <div class="alert alert-success">
                    <strong>ğŸ› ï¸ ç®¡ç†å“¡ç®¡ç†</strong><br>
                    ç®¡ç†ç³»çµ±ç®¡ç†å“¡
                </div>
                
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-id">ç³»çµ±ç®¡ç†å“¡</div>
                        <div class="order-status">admin</div>
                    </div>
                    <div class="order-details">
                        <div>LINE ID: ${liffProfile?.userId || 'demo123'}</div>
                        <div>æ¬Šé™: ç³»çµ±ç®¡ç†å“¡</div>
                    </div>
                </div>
            `;
        }

        function reviewPayment(paymentId, status) {
            if (confirm(`ç¢ºå®šè¦${status === 'approved' ? 'ç¢ºèª' : 'æ‹’çµ•'}æ­¤ç¹³è²»è¨˜éŒ„å—ï¼Ÿ`)) {
                debugLog('å¯©æ ¸ç¹³è²»', { paymentId, status });
                showSuccess(`ç¹³è²»è¨˜éŒ„å·²${status === 'approved' ? 'ç¢ºèª' : 'æ‹’çµ•'}`);
                loadPaymentManagement();
            }
        }

        function backToMainSystem() {
            if (currentOrderSummary) {
                showSection('ordersSection');
            } else {
                showSection('registrationSection');
            }
        }

        // ==================== ç‹€æ…‹æ›´æ–°å‡½æ•¸ ====================
        function updateLiffStatus(message, success) {
            const liffIndicator = document.getElementById('liffIndicator');
            const liffStatus = document.getElementById('liffStatus');
            
            if (liffIndicator && liffStatus) {
                liffIndicator.className = `status-indicator ${success ? 'success' : ''}`;
                liffStatus.textContent = message;
            }
        }

        async function checkAPIStatus() {
            try {
                debugLog('æª¢æŸ¥ API é€£ç·šç‹€æ…‹');
                updateAPIStatus('æª¢æŸ¥ä¸­...', false);
                
                const result = await callAPI('test');
                
                if (result.success) {
                    debugLog('API é€£ç·šæ­£å¸¸', result);
                    updateAPIStatus('é€£ç·šæ­£å¸¸', true);
                    return true;
                } else {
                    debugLog('API é€£ç·šç•°å¸¸', result);
                    updateAPIStatus('é€£ç·šç•°å¸¸', false);
                    return false;
                }
            } catch (error) {
                debugLog('API é€£ç·šæª¢æŸ¥å¤±æ•—', error);
                updateAPIStatus('é€£ç·šå¤±æ•—', false);
                return false;
            }
        }

        function updateAPIStatus(message, success) {
            const apiIndicator = document.getElementById('apiIndicator');
            const apiStatus = document.getElementById('apiStatus');
            
            if (apiIndicator && apiStatus) {
                apiIndicator.className = `status-indicator ${success ? 'success' : ''}`;
                apiStatus.textContent = message;
            }
        }

        // ==================== äº‹ä»¶ç¶å®š ====================
        function setupEventHandlers() {
            const registrationForm = document.getElementById('registrationForm');
            if (registrationForm) {
                registrationForm.addEventListener('submit', handleRegistration);
            }
            
            const idNumberInput = document.getElementById('idNumber');
            if (idNumberInput) {
                idNumberInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.toUpperCase();
                });
            }
            
            const phoneNumberInput = document.getElementById('phoneNumber');
            if (phoneNumberInput) {
                phoneNumberInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 10) {
                        value = value.slice(0, 10);
                    }
                    e.target.value = value;
                });
            }
            
            const proceedToPaymentBtn = document.getElementById('proceedToPaymentBtn');
            if (proceedToPaymentBtn) {
                proceedToPaymentBtn.addEventListener('click', () => {
                    showSection('paymentSection');
                });
            }
            
            const refreshOrdersBtn = document.getElementById('refreshOrdersBtn');
            if (refreshOrdersBtn) {
                refreshOrdersBtn.addEventListener('click', async () => {
                    refreshOrdersBtn.disabled = true;
                    refreshOrdersBtn.textContent = 'ğŸ”„ é‡æ–°æ•´ç†ä¸­...';
                    
                    try {
                        await loadUserOrders();
                        showSuccess('è¨‚å–®å·²æ›´æ–°');
                    } catch (error) {
                        showError('æ›´æ–°å¤±æ•—');
                    } finally {
                        refreshOrdersBtn.disabled = false;
                        refreshOrdersBtn.textContent = 'ğŸ”„ é‡æ–°æ•´ç†è¨‚å–®';
                    }
                });
            }
            
            const backToOrdersBtn = document.getElementById('backToOrdersBtn');
            if (backToOrdersBtn) {
                backToOrdersBtn.addEventListener('click', () => {
                    showSection('ordersSection');
                });
            }
            
            debugLog('äº‹ä»¶è™•ç†å™¨è¨­å®šå®Œæˆ');
        }

        // ==================== é é¢åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–');
            
            // æª¢æŸ¥ API é€£ç·šç‹€æ…‹
            await checkAPIStatus();
            
            // åˆå§‹åŒ– LIFF
            await initializeLiff();
            
            // ç¶å®šäº‹ä»¶è™•ç†å™¨
            setupEventHandlers();
        });

        // ==================== éŒ¯èª¤è™•ç†æ”¹é€² ====================
        window.addEventListener('error', function(event) {
            debugLog('å…¨åŸŸéŒ¯èª¤', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            });
            
            console.error('å…¨åŸŸéŒ¯èª¤:', event.error);
            
            // å¦‚æœæ˜¯ API ç›¸é—œéŒ¯èª¤ï¼Œé¡¯ç¤ºæ›´å‹å–„çš„è¨Šæ¯
            if (event.message && event.message.includes('handleAPIResponse')) {
                showError('API é€£ç·šç™¼ç”Ÿå•é¡Œï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è¯ç¹«ç³»çµ±ç®¡ç†å“¡');
            } else {
                showError('ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            }
        });

        window.addEventListener('unhandledrejection', function(event) {
            debugLog('æœªè™•ç†çš„ Promise æ‹’çµ•', event.reason);
            console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', event.reason);
            
            // é˜²æ­¢éŒ¯èª¤åœ¨æ§åˆ¶å°é¡¯ç¤º
            event.preventDefault();
            
            showError('ç³»çµ±è™•ç†è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
        });

        // ==================== é™¤éŒ¯å·¥å…·æ”¹é€² ====================
        function testAPIConnection() {
            if (CONFIG.DEBUG_MODE) {
                console.log('ğŸ” æ¸¬è©¦ API é€£ç·š...');
                
                callAPI('test')
                    .then(response => {
                        console.log('âœ… API æ¸¬è©¦æˆåŠŸ:', response);
                        showSuccess('API é€£ç·šæ¸¬è©¦æˆåŠŸ');
                    })
                    .catch(error => {
                        console.error('âŒ API æ¸¬è©¦å¤±æ•—:', error);
                        showError('API é€£ç·šæ¸¬è©¦å¤±æ•—: ' + error.message);
                    });
            }
        }

        function testAllAPIs() {
            if (CONFIG.DEBUG_MODE) {
                console.log('ğŸ” æ¸¬è©¦æ‰€æœ‰ API...');
                
                const testCases = [
                    { action: 'test', data: {} },
                    { action: 'get-config', data: {} },
                    { action: 'check-registration', data: { lineName: 'æ¸¬è©¦ç”¨æˆ¶' } }
                ];
                
                testCases.forEach(async (testCase, index) => {
                    try {
                        console.log(`ğŸ§ª æ¸¬è©¦ ${index + 1}: ${testCase.action}`);
                        const response = await callAPI(testCase.action, testCase.data);
                        console.log(`âœ… æ¸¬è©¦ ${index + 1} æˆåŠŸ:`, response);
                    } catch (error) {
                        console.error(`âŒ æ¸¬è©¦ ${index + 1} å¤±æ•—:`, error);
                    }
                });
            }
        }

        // ==================== å¯¦ç”¨å·¥å…·å‡½æ•¸ ====================
        function formatCurrency(amount) {
            return new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'TWD'
            }).format(amount);
        }

        function formatDate(date) {
            return new Intl.DateTimeFormat('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).format(new Date(date));
        }

        function validateIdNumber(idNumber) {
            const pattern = /^[A-Z][12]\d{8}$/;
            if (!pattern.test(idNumber)) return false;
            
            // èº«åˆ†è­‰å­—è™Ÿæª¢æŸ¥ç¢¼é©—è­‰
            const letters = 'ABCDEFGHJKLMNPQRSTUVXYWZIO';
            const weights = [1, 9, 8, 7, 6, 5, 4, 3, 2, 1, 1];
            
            let sum = letters.indexOf(idNumber[0]) + 10;
            sum = Math.floor(sum / 10) + (sum % 10) * 9;
            
            for (let i = 1; i < 10; i++) {
                sum += parseInt(idNumber[i]) * weights[i];
            }
            
            return (sum % 10) === 0;
        }

        function validatePhoneNumber(phoneNumber) {
            const pattern = /^09\d{8}$/;
            return pattern.test(phoneNumber);
        }

        // ==================== å°å‡ºå‡½æ•¸ä¾›å¤–éƒ¨ä½¿ç”¨ ====================
        window.systemFunctions = {
            showToast,
            showSuccess,
            showError,
            showInfo,
            debugLog,
            formatCurrency,
            formatDate,
            validateIdNumber,
            validatePhoneNumber
        };

        // åœ¨é™¤éŒ¯æ¨¡å¼ä¸‹å°å‡ºæ›´å¤šå‡½æ•¸
        if (CONFIG.DEBUG_MODE) {
            window.debugFunctions = {
                callAPI,
                loadSystemConfig,
                checkRegistrationStatus,
                loadUserOrders,
                submitPayment,
                testAPIConnection,
                testAllAPIs,
                handleDemoResponse
            };
        }

        // ==================== é–‹ç™¼ç”¨æ¸¬è©¦å‡½æ•¸ ====================
        function testRegistration() {
            if (CONFIG.DEBUG_MODE) {
                document.getElementById('realName').value = 'æ¸¬è©¦ç”¨æˆ¶';
                document.getElementById('idNumber').value = 'A123456789';
                document.getElementById('phoneNumber').value = '0912345678';
                showInfo('å·²å¡«å…¥æ¸¬è©¦è³‡æ–™');
            }
        }

        function testPayment() {
            if (CONFIG.DEBUG_MODE) {
                document.getElementById('paymentMethod').value = 'bank_transfer';
                document.getElementById('paymentNote').value = 'æ¸¬è©¦ç¹³è²»å‚™è¨»';
                showInfo('å·²å¡«å…¥æ¸¬è©¦ç¹³è²»è³‡æ–™');
            }
        }

        // åœ¨æ§åˆ¶å°æä¾›å¿«é€Ÿæ¸¬è©¦å‘½ä»¤
        if (CONFIG.DEBUG_MODE) {
            console.log('ğŸš€ é™¤éŒ¯æ¨¡å¼å·²å•Ÿç”¨');
            console.log('å¯ç”¨å‘½ä»¤:');
            console.log('- testRegistration(): å¡«å…¥æ¸¬è©¦ç™»è¨˜è³‡æ–™');
            console.log('- testPayment(): å¡«å…¥æ¸¬è©¦ç¹³è²»è³‡æ–™');
            console.log('- testAPIConnection(): æ¸¬è©¦ API é€£ç·š');
            console.log('- testAllAPIs(): æ¸¬è©¦æ‰€æœ‰ API');
            console.log('- systemFunctions: ç³»çµ±å·¥å…·å‡½æ•¸');
            console.log('- debugFunctions: é™¤éŒ¯å‡½æ•¸');
            
            window.testRegistration = testRegistration;
            window.testPayment = testPayment;
        }

    </script>

  </body>
  </html>

