<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>【多福氣】BOGO訂購系統管理後台</title>
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #00B900, #00D300);
        min-height: 100vh;
        padding: 20px;
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .header {
        background: linear-gradient(45deg, #00B900, #00D300);
        color: white;
        padding: 30px;
        text-align: center;
    }
    
    .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
    }
    
    .nav-tabs {
        display: flex;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        overflow-x: auto;
    }
    
    .nav-tab {
        flex: 1;
        min-width: 120px;
        padding: 15px 20px;
        text-align: center;
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: #6c757d;
        transition: all 0.3s ease;
        white-space: nowrap;
    }
    
    .nav-tab.active {
        background: white;
        color: #00B900;
        border-bottom: 3px solid #00B900;
    }
    
    .content {
        padding: 30px;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #00B900, #00D300);
        color: white;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 185, 0, 0.3);
    }
    
    .stat-number {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 8px;
    }
    
    .stat-label {
        font-size: 14px;
        opacity: 0.9;
    }
    
    .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .table th {
        background: #f8f9fa;
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
    }
    
    .table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
        vertical-align: middle;
    }
    
    .table tr:hover {
        background: #f8f9fa;
    }
    
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
        margin: 2px;
    }
    
    .btn-primary {
        background: #00B900;
        color: white;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-warning {
        background: #ffc107;
        color: #212529;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .status-badge {
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-pending {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-approved {
        background: #d4edda;
        color: #155724;
    }
    
    .status-rejected {
        background: #f8d7da;
        color: #721c24;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #00B900;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #dc3545;
    }
    
    .success {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #28a745;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
    }
    
    .close:hover {
        color: #000;
    }
    
    .admin-info {
        background: #e8f5e8;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        border-left: 4px solid #00B900;
    }
    
    .admin-info h3 {
        color: #00B900;
        margin-bottom: 10px;
    }
    
    .order-details {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
    }
    
    .product-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        font-size: 14px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .product-item:last-child {
        border-bottom: none;
    }
    
    .product-name {
        font-weight: 600;
        color: #333;
    }
    
    .product-details {
        text-align: right;
        color: #666;
    }
    
    @media (max-width: 768px) {
        .nav-tabs {
            flex-direction: column;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .table {
            min-width: 600px;
        }
        
        .content {
            padding: 15px;
        }
    }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>🛡️ 【多福氣】BOGO管理後台</h1>
        <p>訂購管理 · 繳費審核 · 用戶統計</p>
    </div>
    
    <!-- 管理者資訊 -->
    <div id="adminInfo" class="admin-info" style="display: none; margin: 20px 30px 0;">
        <h3>👤 管理者資訊</h3>
        <div id="adminDetails"></div>
    </div>
    
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('dashboard')">📊 儀表板</button>
        <button class="nav-tab" onclick="switchTab('pending')">⏳ 待審核</button>
        <button class="nav-tab" onclick="switchTab('payments')">💰 繳費記錄</button>
        <button class="nav-tab" onclick="switchTab('orders')">📋 訂單管理</button>
        <button class="nav-tab" onclick="switchTab('users')">👥 用戶管理</button>
        <button class="nav-tab" onclick="switchTab('reports')">📈 報表</button>
        <button class="nav-tab" onclick="switchTab('settings')">⚙️ 系統設定</button>
    </div>
    
    <div class="content">
        <!-- 儀表板 -->
        <div id="dashboard" class="tab-content active">
            <div id="dashboardStats" class="stats-grid">
                <div class="loading">載入統計資料中...</div>
            </div>
            
            <div class="table-container">
                <h3 style="padding: 20px 20px 0; margin: 0;">📈 系統概覽</h3>
                <div id="systemOverview" style="padding: 20px;">
                    <div class="loading">載入系統概覽中...</div>
                </div>
            </div>
        </div>
        
        <!-- 待審核 -->
        <div id="pending" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2>⏳ 待審核繳費記錄</h2>
                <div>
                    <button class="btn btn-success" onclick="batchApprove()">✅ 批量通過</button>
                    <button class="btn btn-danger" onclick="batchReject()">❌ 批量拒絕</button>
                    <button class="btn btn-primary" onclick="loadPendingPayments()">🔄 重新整理</button>
                </div>
            </div>
            
            <div class="table-container">
                <div id="pendingPaymentsTable">
                    <div class="loading">載入待審核記錄中...</div>
                </div>
            </div>
        </div>
        
        <!-- 繳費記錄 -->
        <div id="payments" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2>💰 所有繳費記錄</h2>
                <div>
                    <select id="paymentStatusFilter" onchange="filterPayments()">
                        <option value="">全部狀態</option>
                        <option value="待審核">待審核</option>
                        <option value="已確認">已確認</option>
                        <option value="已拒絕">已拒絕</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadAllPayments()">🔄 重新整理</button>
                </div>
            </div>
            <div class="table-container">
                <div id="allPaymentsTable">
                    <div class="loading">載入繳費記錄中...</div>
                </div>
            </div>
        </div>
        
        <!-- 訂單管理 -->
        <div id="orders" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2>📋 訂單管理</h2>
                <div>
                    <input type="text" id="orderSearchInput" placeholder="搜尋LINE名稱或真實姓名" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                    <button class="btn btn-primary" onclick="searchOrders()">🔍 搜尋</button>
                    <button class="btn btn-primary" onclick="loadAllOrders()">🔄 重新整理</button>
                </div>
            </div>
            <div class="table-container">
                <div id="allOrdersTable">
                    <div class="loading">載入訂單資料中...</div>
                </div>
            </div>
        </div>
        
        <!-- 用戶管理 -->
        <div id="users" class="tab-content">
            <h2 style="margin-bottom: 20px;">👥 用戶管理</h2>
            <div class="table-container">
                <div id="usersTable">
                    <div class="loading">載入用戶資料中...</div>
                </div>
            </div>
        </div>
        
        <!-- 報表 -->
        <div id="reports" class="tab-content">
            <h2 style="margin-bottom: 20px;">📈 系統報表</h2>
            
            <div class="form-group">
                <label for="reportDate">選擇日期範圍</label>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="date" id="reportStartDate" style="flex: 1; min-width: 150px;">
                    <span>至</span>
                    <input type="date" id="reportEndDate" style="flex: 1; min-width: 150px;">
                    <button class="btn btn-primary" onclick="generateReport()">📊 生成報表</button>
                </div>
            </div>
            
            <div id="reportContent">
                <div class="loading">請選擇日期範圍並生成報表</div>
            </div>
        </div>
        
        <!-- 系統設定 -->
        <div id="settings" class="tab-content">
            <h2 style="margin-bottom: 20px;">⚙️ 系統設定</h2>
            
            <div style="display: grid; gap: 20px;">
                <div class="table-container" style="padding: 20px;">
                    <h3>📊 資料管理</h3>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-warning" onclick="exportAllData()">
                            📊 匯出所有資料
                        </button>
                        <button class="btn btn-primary" onclick="exportPaymentRecords()">
                            💰 匯出繳費記錄
                        </button>
                        <button class="btn btn-success" onclick="exportUserList()">
                            👥 匯出用戶清單
                        </button>
                        <button class="btn btn-danger" onclick="cleanupOldData()">
                            🗑️ 清理舊資料
                        </button>
                    </div>
                </div>
                
                <div class="table-container" style="padding: 20px;">
                    <h3>ℹ️ 系統資訊</h3>
                    <div id="systemInfo" style="margin-top: 15px;">
                        <div class="loading">載入系統資訊中...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 審核模態框 -->
<div id="reviewModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>🔍 審核繳費記錄</h2>
        <form id="reviewForm">
            <input type="hidden" id="reviewPaymentId">
            
            <div class="form-group">
                <label>📋 繳費資訊</label>
                <div id="reviewPaymentInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                </div>
            </div>
            
            <div class="form-group">
                <label for="reviewStatus">審核結果 *</label>
                <select id="reviewStatus" required>
                    <option value="">請選擇審核結果</option>
                    <option value="已確認">✅ 通過 - 確認繳費</option>
                    <option value="已拒絕">❌ 拒絕 - 繳費有問題</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="reviewNote">審核備註</label>
                <textarea id="reviewNote" placeholder="請輸入審核備註（可選）..." rows="3"></textarea>
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeReviewModal()">取消</button>
                <button type="submit" class="btn btn-primary">確認審核</button>
            </div>
        </form>
    </div>
</div>

<!-- 訂單詳情模態框 -->
<div id="orderModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeOrderModal()">&times;</span>
        <h2>📋 訂單詳情</h2>
        <div id="orderModalContent">
            <div class="loading">載入中...</div>
        </div>
    </div>
</div>

<script>
    // 設定區域 - 請修改為您的實際值
    const CONFIG = {
        LIFF_ID: '1657285806-2bmkYWkN', // 請替換為實際的 LIFF ID
        API_BASE_URL: 'https://script.google.com/macros/s/AKfycbx4IpYvra7_GTFLSKj0PdmmK0-gbKt5S0yjEYPwP3PbiwFTPkNGPVCNNSVVJMkuXK-r3Q/exec', // 請替換為 GAS 部署網址
        DEBUG_MODE: false,
        ADMIN_USER_IDS: [
            // 請在這裡添加管理者的 LINE User ID
            'U5b799eb608fbe4064fd0a85f7af2370f',
            'Ubdfa881413facf7f715365bbebb468ab'
        ]
    };

    // 全域變數
    let adminUserId = null;
    let adminProfile = null;
    let pendingPayments = [];
    let allPayments = [];
    let selectedPayments = [];
    let allOrders = [];
    let allUsers = [];

    // 除錯函數
    function debugLog(message, data = null) {
        if (CONFIG.DEBUG_MODE) {
            console.log(message, data);
        }
    }

    // 初始化
    window.onload = function() {
        debugLog('開始初始化管理後台');
        initializeLiff();
    };

    async function initializeLiff() {
        try {
            debugLog('LIFF 初始化中...', { liffId: CONFIG.LIFF_ID });
            
            await liff.init({ liffId: CONFIG.LIFF_ID });
            debugLog('LIFF 初始化成功');
            
            if (liff.isLoggedIn()) {
                adminProfile = await liff.getProfile();
                adminUserId = adminProfile.userId;
                
                debugLog('取得管理者資料', {
                    userId: adminUserId,
                    displayName: adminProfile.displayName
                });
                
                // 驗證管理者權限
                if (isAuthorizedAdmin()) {
                    displayAdminInfo();
                    loadDashboard();
                    debugLog('管理者驗證成功');
                } else {
                    showError('❌ 權限不足：您不是系統管理者');
                    debugLog('管理者驗證失敗', { userId: adminUserId });
                }
            } else {
                debugLog('用戶未登入，導向登入頁面');
                liff.login();
            }
        } catch (error) {
            debugLog('初始化失敗', error);
            console.error('初始化失敗:', error);
            showError('系統初始化失敗: ' + error.message);
        }
    }

    // 驗證管理者權限
    function isAuthorizedAdmin() {
        // 如果沒有設定管理者ID，則允許所有用戶（開發模式）
        if (CONFIG.ADMIN_USER_IDS.length === 0) {
            debugLog('開發模式：允許所有用戶訪問管理後台');
            return true;
        }
        
        return CONFIG.ADMIN_USER_IDS.includes(adminUserId);
    }

    // 顯示管理者資訊
    function displayAdminInfo() {
        const adminInfoDiv = document.getElementById('adminInfo');
        const adminDetailsDiv = document.getElementById('adminDetails');
        
        if (!adminInfoDiv || !adminDetailsDiv) return;

        let html = `
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div>
                    <strong>管理者：</strong>${adminProfile.displayName}<br>
                    <small style="color: #666;">登入時間：${new Date().toLocaleString('zh-TW')}</small>
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="liff.logout(); location.reload();">
                        🚪 登出
                    </button>
                </div>
            </div>
        `;

        adminDetailsDiv.innerHTML = html;
        adminInfoDiv.style.display = 'block';
    }

    // API 呼叫函數
    async function callAPI(action, data) {
        try {
            debugLog(`呼叫 API: ${action}`, data);
            
            const enhancedData = {
                ...data,
                adminUserId: adminUserId,
                timestamp: new Date().toISOString()
            };
            
            const result = await callApiWithJsonp(action, enhancedData);
            debugLog('API 回應', result);
            
            return result;
            
        } catch (error) {
            debugLog('API 呼叫失敗', error);
            console.error(`API 呼叫失敗 (${action}):`, error);
            throw error;
        }
    }

    // JSONP 方式呼叫 API
    function callApiWithJsonp(action, data) {
        return new Promise((resolve, reject) => {
            const callbackName = 'adminCallback_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
            
            window[callbackName] = function(response) {
                delete window[callbackName];
                document.head.removeChild(script);
                resolve(response);
            };
            
            const script = document.createElement('script');
            const params = new URLSearchParams();
            params.append('action', action);
            params.append('callback', callbackName);
            
            if (data) {
                params.append('data', JSON.stringify(data));
            }
            
            script.src = CONFIG.API_BASE_URL + '?' + params.toString();
            
            script.onerror = function() {
                delete window[callbackName];
                document.head.removeChild(script);
                reject(new Error('JSONP 請求失敗'));
            };
            
            setTimeout(() => {
                if (window[callbackName]) {
                    delete window[callbackName];
                    document.head.removeChild(script);
                    reject(new Error('API 請求超時'));
                }
            }, 15000);
            
            document.head.appendChild(script);
        });
    }

    // 標籤頁切換
    function switchTab(tabName) {
        debugLog(`切換標籤頁: ${tabName}`);
        
        // 隱藏所有標籤內容
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => content.classList.remove('active'));
        
        // 移除所有按鈕的 active 狀態
        const navTabs = document.querySelectorAll('.nav-tab');
        navTabs.forEach(tab => tab.classList.remove('active'));
        
        // 顯示選中的標籤內容
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
        
        // 載入對應內容
        loadTabContent(tabName);
    }

    async function loadTabContent(tabName) {
        switch (tabName) {
            case 'dashboard':
                loadDashboard();
                break;
            case 'pending':
                loadPendingPayments();
                break;
            case 'payments':
                loadAllPayments();
                break;
            case 'orders':
                loadAllOrders();
                break;
            case 'users':
                loadUsers();
                break;
            case 'reports':
                initReports();
                break;
            case 'settings':
                loadSystemInfo();
                break;
        }
    }

    // 載入儀表板
    async function loadDashboard() {
        try {
            debugLog('載入儀表板');
            
            // 同時載入統計資料
            const [statsResult, paymentsResult, usersResult] = await Promise.all([
                callAPI('get-statistics', {}),
                callAPI('get-all-payments', {}),
                callAPI('get-all-users', {})
            ]);
            
            if (statsResult.success) {
                displayDashboardStats(statsResult.statistics);
            }
            
            // 顯示系統概覽
            displaySystemOverview({
                totalPayments: paymentsResult.success ? paymentsResult.payments.length : 0,
                totalUsers: usersResult.success ? usersResult.users.length : 0,
                lastUpdate: new Date().toLocaleString('zh-TW')
            });
            
        } catch (error) {
            debugLog('載入儀表板失敗', error);
            console.error('載入儀表板失敗:', error);
            showError('載入儀表板失敗: ' + error.message);
        }
    }

function displayDashboardStats(statistics) {
    const statsHtml = `
        <div class="stat-card">
            <div class="stat-number">${statistics.totalUsers || 0}</div>
            <div class="stat-label">註冊用戶</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${statistics.totalOrders || 0}</div>
            <div class="stat-label">訂單記錄</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${statistics.pendingPayments || 0}</div>
            <div class="stat-label">待審核</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">NT$ ${(statistics.totalAmount || 0).toLocaleString()}</div>
            <div class="stat-label">總金額</div>
        </div>
    `;
    
    document.getElementById('dashboardStats').innerHTML = statsHtml;
}

function displaySystemOverview(data) {
    const overviewHtml = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
                <h4 style="color: #00B900; margin-bottom: 10px;">📊 系統狀態</h4>
                <p><strong>總繳費記錄：</strong> ${data.totalPayments}</p>
                <p><strong>總註冊用戶：</strong> ${data.totalUsers}</p>
                <p><strong>最後更新：</strong> ${data.lastUpdate}</p>
            </div>
            <div>
                <h4 style="color: #00B900; margin-bottom: 10px;">🔧 快速操作</h4>
                <button class="btn btn-primary" onclick="switchTab('pending')" style="display: block; margin: 5px 0;">
                    查看待審核
                </button>
                <button class="btn btn-success" onclick="exportPaymentRecords()" style="display: block; margin: 5px 0;">
                    匯出繳費記錄
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('systemOverview').innerHTML = overviewHtml;
}

// 載入待審核繳費記錄
async function loadPendingPayments() {
    try {
        debugLog('載入待審核繳費記錄');
        document.getElementById('pendingPaymentsTable').innerHTML = '<div class="loading">載入中...</div>';
        
        const result = await callAPI('get-all-payments', {});
        
        if (result.success) {
            // 篩選出待審核的記錄
            pendingPayments = result.payments.filter(payment => payment.status === '待審核');
            displayPendingPayments(pendingPayments);
        } else {
            throw new Error(result.message || '載入失敗');
        }
    } catch (error) {
        debugLog('載入待審核記錄失敗', error);
        console.error('載入待審核記錄失敗:', error);
        document.getElementById('pendingPaymentsTable').innerHTML = 
            `<div class="error">載入失敗: ${error.message}</div>`;
    }
}

function displayPendingPayments(payments) {
    if (payments.length === 0) {
        document.getElementById('pendingPaymentsTable').innerHTML = 
            '<div style="padding: 40px; text-align: center; color: #6c757d;">🎉 目前沒有待審核的繳費記錄</div>';
        return;
    }
    
    let html = `
        <table class="table">
            <thead>
                <tr>
                    <th><input type="checkbox" onchange="toggleAllPayments(this)"></th>
                    <th>訂單資訊</th>
                    <th>用戶資訊</th>
                    <th>繳費資訊</th>
                    <th>提交時間</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    payments.forEach((payment, index) => {
        html += `
            <tr>
                <td><input type="checkbox" value="${index}" onchange="togglePaymentSelection(this, '${payment.orderId}')"></td>
                <td>
                    <div style="font-weight: 600;">${payment.orderId}</div>
                    <small style="color: #6c757d;">訂單編號</small>
                </td>
                <td>
                    <div style="font-weight: 600;">${payment.realName}</div>
                    <small style="color: #6c757d;">${payment.lineName}</small>
                </td>
                <td>
                    <div style="font-weight: 600;">NT$ ${payment.paymentAmount.toLocaleString()}</div>
                    <small style="color: #6c757d;">${getPaymentMethodText(payment.paymentMethod)}</small>
                    ${payment.paymentNote ? `<br><small style="color: #666;">備註: ${payment.paymentNote}</small>` : ''}
                </td>
                <td>${new Date(payment.submittedAt).toLocaleString('zh-TW')}</td>
                <td>
                    <button class="btn btn-primary" onclick="openReviewModal('${payment.orderId}')">
                        🔍 審核
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    document.getElementById('pendingPaymentsTable').innerHTML = html;
}

// 載入所有繳費記錄
async function loadAllPayments() {
    try {
        debugLog('載入所有繳費記錄');
        document.getElementById('allPaymentsTable').innerHTML = '<div class="loading">載入中...</div>';
        
        const result = await callAPI('get-all-payments', {});
        
        if (result.success) {
            allPayments = result.payments || [];
            displayAllPayments(allPayments);
        } else {
            throw new Error(result.message || '載入失敗');
        }
    } catch (error) {
        debugLog('載入繳費記錄失敗', error);
        console.error('載入繳費記錄失敗:', error);
        document.getElementById('allPaymentsTable').innerHTML = 
            `<div class="error">載入失敗: ${error.message}</div>`;
    }
}

function displayAllPayments(payments) {
    if (payments.length === 0) {
        document.getElementById('allPaymentsTable').innerHTML = 
            '<div style="padding: 40px; text-align: center; color: #6c757d;">目前沒有繳費記錄</div>';
        return;
    }
    
    let html = `
        <table class="table">
            <thead>
                <tr>
                    <th>訂單編號</th>
                    <th>用戶資訊</th>
                    <th>繳費資訊</th>
                    <th>狀態</th>
                    <th>時間</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    payments.forEach(payment => {
        const statusClass = getStatusClass(payment.status);
        const statusText = getStatusText(payment.status);
        
        html += `
            <tr>
                <td>
                    <div style="font-weight: 600;">${payment.orderId}</div>
                </td>
                <td>
                    <div style="font-weight: 600;">${payment.realName}</div>
                    <small style="color: #6c757d;">${payment.lineName}</small>
                </td>
                <td>
                    <div>NT$ ${payment.paymentAmount.toLocaleString()}</div>
                    <small style="color: #6c757d;">${getPaymentMethodText(payment.paymentMethod)}</small>
                    ${payment.paymentNote ? `<br><small style="color: #666;">備註: ${payment.paymentNote}</small>` : ''}
                </td>
                <td>
                    <span class="status-badge status-${statusClass}">${statusText}</span>
                </td>
                <td>
                    <div style="font-size: 12px;">
                        提交: ${new Date(payment.submittedAt).toLocaleDateString('zh-TW')}
                    </div>
                </td>
                <td>
                    ${payment.status === '待審核' ? 
                        `<button class="btn btn-primary" onclick="openReviewModal('${payment.orderId}')">🔍 審核</button>` : 
                        `<button class="btn btn-secondary" onclick="viewPaymentDetails('${payment.orderId}')">📄 詳情</button>`
                    }
                </td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    document.getElementById('allPaymentsTable').innerHTML = html;
}

// 載入所有訂單
async function loadAllOrders() {
    try {
        debugLog('載入所有訂單');
        document.getElementById('allOrdersTable').innerHTML = '<div class="loading">載入中...</div>';
        
        const result = await callAPI('get-all-users', {});
        
        if (result.success) {
            allUsers = result.users || [];
            // 為每個用戶載入訂單摘要
            const ordersPromises = allUsers.map(async user => {
                try {
                    const orderResult = await callAPI('orders', { lineName: user.lineDisplayName });
                    return {
                        user: user,
                        orderSummary: orderResult.success ? orderResult.orderSummary : null
                    };
                } catch (error) {
                    debugLog(`載入用戶 ${user.lineDisplayName} 訂單失敗`, error);
                    return {
                        user: user,
                        orderSummary: null
                    };
                }
            });
            
            const ordersData = await Promise.all(ordersPromises);
            allOrders = ordersData.filter(data => data.orderSummary !== null);
            displayAllOrders(allOrders);
        } else {
            throw new Error(result.message || '載入失敗');
        }
    } catch (error) {
        debugLog('載入訂單失敗', error);
        console.error('載入訂單失敗:', error);
        document.getElementById('allOrdersTable').innerHTML = 
            `<div class="error">載入失敗: ${error.message}</div>`;
    }
}

function displayAllOrders(orders) {
    if (orders.length === 0) {
        document.getElementById('allOrdersTable').innerHTML = 
            '<div style="padding: 40px; text-align: center; color: #6c757d;">目前沒有訂單記錄</div>';
        return;
    }
    
    let html = `
        <table class="table">
            <thead>
                <tr>
                    <th>訂單編號</th>
                    <th>用戶資訊</th>
                    <th>產品數量</th>
                    <th>總金額</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    orders.forEach(orderData => {
        const order = orderData.orderSummary;
        const user = orderData.user;
        
        html += `
            <tr>
                <td>
                    <div style="font-weight: 600;">${order.orderId}</div>
                </td>
                <td>
                    <div style="font-weight: 600;">${order.realName}</div>
                    <small style="color: #6c757d;">${order.lineName}</small>
                </td>
                <td>
                    <div>${order.products.length} 種產品</div>
                    <small style="color: #6c757d;">共 ${order.products.reduce((sum, p) => sum + p.quantity, 0)} 件</small>
                </td>
                <td>
                    <div style="font-weight: 600; color: #00B900;">NT$ ${order.totalAmount.toLocaleString()}</div>
                </td>
                <td>
                    <button class="btn btn-primary" onclick="viewOrderDetails('${order.orderId}')">
                        📋 查看詳情
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    document.getElementById('allOrdersTable').innerHTML = html;
}

// 載入用戶資料
async function loadUsers() {
    try {
        debugLog('載入用戶資料');
        document.getElementById('usersTable').innerHTML = '<div class="loading">載入中...</div>';
        
        const result = await callAPI('get-all-users', {});
        
        if (result.success) {
            allUsers = result.users || [];
            displayUsers(allUsers);
        } else {
            throw new Error(result.message || '載入失敗');
        }
    } catch (error) {
        debugLog('載入用戶資料失敗', error);
        console.error('載入用戶資料失敗:', error);
        document.getElementById('usersTable').innerHTML = 
            `<div class="error">載入失敗: ${error.message}</div>`;
    }
}

function displayUsers(users) {
    if (users.length === 0) {
        document.getElementById('usersTable').innerHTML = 
            '<div style="padding: 40px; text-align: center; color: #6c757d;">目前沒有註冊用戶</div>';
        return;
    }
    
    let html = `
        <table class="table">
            <thead>
                <tr>
                    <th>用戶資訊</th>
                    <th>註冊時間</th>
                    <th>狀態</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    users.forEach(user => {
        html += `
            <tr>
                <td>
                    <div style="font-weight: 600;">${user.realName}</div>
                    <small style="color: #6c757d;">${user.lineDisplayName}</small>
                    <div style="font-size: 11px; color: #999; margin-top: 2px;">
                        ID: ${user.userId.substring(0, 20)}...
                    </div>
                </td>
                <td>${new Date(user.registeredAt).toLocaleString('zh-TW')}</td>
                <td>
                    <span class="status-badge status-approved">正常</span>
                </td>
                <td>
                    <button class="btn btn-primary" onclick="viewUserOrders('${user.lineDisplayName}')">
                        📋 查看訂單
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    document.getElementById('usersTable').innerHTML = html;
}

// 初始化報表
function initReports() {
    debugLog('初始化報表');
    const today = new Date().toISOString().split('T')[0];
    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    
    document.getElementById('reportStartDate').value = weekAgo;
    document.getElementById('reportEndDate').value = today;
}

// 生成報表
async function generateReport() {
    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;
    
    if (!startDate || !endDate) {
        alert('請選擇開始和結束日期');
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        alert('開始日期不能晚於結束日期');
        return;
    }
    
    try {
        debugLog('生成報表', { startDate, endDate });
        document.getElementById('reportContent').innerHTML = '<div class="loading">生成報表中...</div>';
        
        // 載入所有資料並進行分析
        const [paymentsResult, usersResult] = await Promise.all([
            callAPI('get-all-payments', {}),
            callAPI('get-all-users', {})
        ]);
        
        if (paymentsResult.success && usersResult.success) {
            const report = generateReportData(paymentsResult.payments, usersResult.users, startDate, endDate);
            displayReport(report);
        } else {
            throw new Error('載入報表資料失敗');
        }
    } catch (error) {
        debugLog('生成報表失敗', error);
        console.error('生成報表失敗:', error);
        document.getElementById('reportContent').innerHTML = 
            `<div class="error">生成報表失敗: ${error.message}</div>`;
    }
}

function generateReportData(payments, users, startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate + 'T23:59:59');
    
    // 篩選日期範圍內的資料
    const periodPayments = payments.filter(payment => {
        const paymentDate = new Date(payment.submittedAt);
        return paymentDate >= start && paymentDate <= end;
    });
    
    const periodUsers = users.filter(user => {
        const regDate = new Date(user.registeredAt);
        return regDate >= start && regDate <= end;
    });
    
    // 統計資料
    const totalAmount = periodPayments.reduce((sum, payment) => sum + (payment.paymentAmount || 0), 0);
    const approvedPayments = periodPayments.filter(p => p.status === '已確認').length;
    const pendingPayments = periodPayments.filter(p => p.status === '待審核').length;
    const rejectedPayments = periodPayments.filter(p => p.status === '已拒絕').length;
    
    return {
        period: `${startDate} 至 ${endDate}`,
        summary: {
            newRegistrations: periodUsers.length,
            newPayments: periodPayments.length,
            approvedPayments: approvedPayments,
            pendingPayments: pendingPayments,
            rejectedPayments: rejectedPayments,
            totalAmount: totalAmount
        },
        details: {
            payments: periodPayments,
            users: periodUsers
        }
    };
}

function displayReport(report) {
    const html = `
        <div class="table-container">
            <h3>📊 ${report.period} 報表</h3>
            
            <div class="stats-grid" style="margin: 20px 0;">
                <div class="stat-card">
                    <div class="stat-number">${report.summary.newRegistrations}</div>
                    <div class="stat-label">新註冊用戶</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${report.summary.newPayments}</div>
                    <div class="stat-label">新繳費記錄</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${report.summary.approvedPayments}</div>
                    <div class="stat-label">審核通過</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">NT$ ${report.summary.totalAmount.toLocaleString()}</div>
                    <div class="stat-label">總金額</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div>
                    <strong>✅ 已確認:</strong> ${report.summary.approvedPayments}
                </div>
                <div>
                    <strong>⏳ 待審核:</strong> ${report.summary.pendingPayments}
                </div>
                <div>
                    <strong>❌ 已拒絕:</strong> ${report.summary.rejectedPayments}
                </div>
            </div>
            
            ${report.details.payments.length > 0 ? `
                <h4>💰 期間內繳費記錄</h4>
                <table class="table" style="margin-bottom: 20px;">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>用戶</th>
                            <th>金額</th>
                            <th>方式</th>
                            <th>狀態</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${report.details.payments.map(payment => `
                            <tr>
                                <td>${new Date(payment.submittedAt).toLocaleDateString('zh-TW')}</td>
                                <td>${payment.realName}</td>
                                <td>NT$ ${payment.paymentAmount.toLocaleString()}</td>
                                <td>${getPaymentMethodText(payment.paymentMethod)}</td>
                                <td>
                                    <span class="status-badge status-${getStatusClass(payment.status)}">
                                        ${getStatusText(payment.status)}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : ''}
            
            ${report.details.users.length > 0 ? `
                <h4>👥 期間內新註冊用戶</h4>
                <table class="table">
                    <thead>
                        <tr>
                            <th>註冊日期</th>
                            <th>真實姓名</th>
                            <th>LINE 名稱</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${report.details.users.map(user => `
                            <tr>
                                <td>${new Date(user.registeredAt).toLocaleDateString('zh-TW')}</td>
                                <td>${user.realName}</td>
                                <td>${user.lineDisplayName}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : ''}
        </div>
    `;
    
    document.getElementById('reportContent').innerHTML = html;
}

// 載入系統資訊
async function loadSystemInfo() {
    try {
        debugLog('載入系統資訊');
        
        const info = {
            version: '1.0.0',
            lastUpdate: new Date().toISOString(),
            environment: 'Production',
            database: 'Google Sheets',
            liffVersion: liff.getVersion(),
            adminUser: adminProfile.displayName,
            totalUsers: allUsers.length,
            totalPayments: allPayments.length
        };
        
        const html = `
            <div style="font-size: 14px; line-height: 1.8;">
                <p><strong>🔧 系統版本:</strong> ${info.version}</p>
                <p><strong>📅 最後更新:</strong> ${new Date(info.lastUpdate).toLocaleString('zh-TW')}</p>
                <p><strong>🌐 運行環境:</strong> ${info.environment}</p>
                <p><strong>💾 資料庫:</strong> ${info.database}</p>
                <p><strong>📱 LIFF 版本:</strong> ${info.liffVersion}</p>
                <p><strong>👤 當前管理者:</strong> ${info.adminUser}</p>
                <p><strong>📊 系統統計:</strong> ${info.totalUsers} 用戶, ${info.totalPayments} 繳費記錄</p>
            </div>
        `;
        
        document.getElementById('systemInfo').innerHTML = html;
    } catch (error) {
        debugLog('載入系統資訊失敗', error);
        console.error('載入系統資訊失敗:', error);
        document.getElementById('systemInfo').innerHTML = 
            `<div class="error">載入系統資訊失敗: ${error.message}</div>`;
    }
}

// 開啟審核模態框
function openReviewModal(orderId) {
    debugLog('開啟審核模態框', { orderId });
    
    const payment = pendingPayments.find(p => p.orderId === orderId) || 
                   allPayments.find(p => p.orderId === orderId);
    
    if (!payment) {
        alert('找不到該繳費記錄');
        return;
    }
    
    document.getElementById('reviewPaymentId').value = orderId;
    
    const paymentInfo = `
        <div style="display: grid; gap: 8px;">
            <div><strong>訂單編號:</strong> ${payment.orderId}</div>
            <div><strong>用戶姓名:</strong> ${payment.realName} (${payment.lineName})</div>
            <div><strong>繳費金額:</strong> <span style="color: #00B900; font-weight: bold;">NT$ ${payment.paymentAmount.toLocaleString()}</span></div>
            <div><strong>繳費方式:</strong> ${getPaymentMethodText(payment.paymentMethod)}</div>
            <div><strong>提交時間:</strong> ${new Date(payment.submittedAt).toLocaleString('zh-TW')}</div>
            ${payment.paymentNote ? `<div><strong>用戶備註:</strong> ${payment.paymentNote}</div>` : ''}
        </div>
    `;
    
    document.getElementById('reviewPaymentInfo').innerHTML = paymentInfo;
    document.getElementById('reviewModal').style.display = 'block';
}

// 關閉審核模態框
function closeReviewModal() {
    document.getElementById('reviewModal').style.display = 'none';
    document.getElementById('reviewForm').reset();
}

// 查看訂單詳情
async function viewOrderDetails(orderId) {
    try {
        debugLog('查看訂單詳情', { orderId });
        
        // 從已載入的訂單中找到對應的訂單
        const orderData = allOrders.find(order => order.orderSummary.orderId === orderId);
        
        if (!orderData) {
            alert('找不到該訂單');
            return;
        }
        
        const order = orderData.orderSummary;
        
        let html = `
            <div class="order-details">
                <h3 style="color: #00B900; margin-bottom: 15px;">📋 訂單資訊</h3>
                <div style="display: grid; gap: 10px; margin-bottom: 20px;">
                    <div><strong>訂單編號:</strong> ${order.orderId}</div>
                    <div><strong>用戶姓名:</strong> ${order.realName}</div>
                    <div><strong>LINE名稱:</strong> ${order.lineName}</div>
                </div>
                
                <h4 style="color: #00B900; margin: 20px 0 10px;">📦 產品清單</h4>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
        `;
        
        order.products.forEach(product => {
            html += `
                <div class="product-item">
                    <div class="product-name">${product.productName}</div>
                    <div class="product-details">
                        ${product.quantity} × NT$ ${product.unitPrice.toLocaleString()} = NT$ ${product.totalPrice.toLocaleString()}
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
                
                <div style="text-align: right; margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                    <div style="font-size: 18px; font-weight: bold; color: #00B900;">
                        總金額: NT$ ${order.totalAmount.toLocaleString()}
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('orderModalContent').innerHTML = html;
        document.getElementById('orderModal').style.display = 'block';
        
    } catch (error) {
        debugLog('查看訂單詳情失敗', error);
        console.error('查看訂單詳情失敗:', error);
        alert('載入訂單詳情失敗: ' + error.message);
    }
}

// 關閉訂單模態框
function closeOrderModal() {
    document.getElementById('orderModal').style.display = 'none';
}

// 查看用戶訂單
// 查看用戶訂單
async function viewUserOrders(lineName) {
    try {
        debugLog('查看用戶訂單', { lineName });
        
        const result = await callAPI('orders', { lineName: lineName });
        
        if (result.success && result.orderSummary) {
            viewOrderDetails(result.orderSummary.orderId);
        } else {
            alert('該用戶尚未有訂單記錄');
        }
    } catch (error) {
        debugLog('查看用戶訂單失敗', error);
        console.error('查看用戶訂單失敗:', error);
        alert('載入用戶訂單失敗: ' + error.message);
    }
}

// 搜尋訂單
function searchOrders() {
    const searchTerm = document.getElementById('orderSearchInput').value.trim();
    
    if (!searchTerm) {
        displayAllOrders(allOrders);
        return;
    }
    
    const filteredOrders = allOrders.filter(orderData => {
        const order = orderData.orderSummary;
        return order.realName.includes(searchTerm) || 
               order.lineName.includes(searchTerm) ||
               order.orderId.includes(searchTerm);
    });
    
    displayAllOrders(filteredOrders);
}

// 篩選繳費記錄
function filterPayments() {
    const statusFilter = document.getElementById('paymentStatusFilter').value;
    
    if (!statusFilter) {
        displayAllPayments(allPayments);
        return;
    }
    
    const filteredPayments = allPayments.filter(payment => payment.status === statusFilter);
    displayAllPayments(filteredPayments);
}

// 審核表單提交
document.addEventListener('DOMContentLoaded', function() {
    const reviewForm = document.getElementById('reviewForm');
    if (reviewForm) {
        reviewForm.addEventListener('submit', handleReviewSubmit);
    }
    
    // 模態框關閉事件
    const closeBtn = document.querySelector('.close');
    if (closeBtn) {
        closeBtn.onclick = closeReviewModal;
    }
    
    window.onclick = function(event) {
        const reviewModal = document.getElementById('reviewModal');
        const orderModal = document.getElementById('orderModal');
        
        if (event.target === reviewModal) {
            closeReviewModal();
        }
        if (event.target === orderModal) {
            closeOrderModal();
        }
    }
});

async function handleReviewSubmit(e) {
    e.preventDefault();
    
    const orderId = document.getElementById('reviewPaymentId').value;
    const status = document.getElementById('reviewStatus').value;
    const reviewNote = document.getElementById('reviewNote').value;
    
    if (!status) {
        alert('請選擇審核結果');
        return;
    }
    
    try {
        debugLog('提交審核', { orderId, status, reviewNote });
        
        const result = await callAPI('review-payment', {
            orderId: orderId,
            status: status,
            reviewNote: reviewNote,
            reviewedAt: new Date().toISOString(),
            reviewedBy: adminProfile.displayName
        });
        
        if (result.success) {
            alert('✅ 審核完成！');
            closeReviewModal();
            
            // 重新載入相關資料
            await Promise.all([
                loadPendingPayments(),
                loadAllPayments(),
                loadDashboard()
            ]);
        } else {
            throw new Error(result.message || '審核失敗');
        }
    } catch (error) {
        debugLog('審核失敗', error);
        console.error('審核失敗:', error);
        alert('審核失敗: ' + error.message);
    }
}

// 切換單個繳費記錄選擇
function togglePaymentSelection(checkbox, orderId) {
    if (checkbox.checked) {
        if (!selectedPayments.includes(orderId)) {
            selectedPayments.push(orderId);
        }
    } else {
        const index = selectedPayments.indexOf(orderId);
        if (index > -1) {
            selectedPayments.splice(index, 1);
        }
    }
    
    debugLog('已選擇繳費記錄', selectedPayments);
}

// 切換全選
function toggleAllPayments(masterCheckbox) {
    const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
    selectedPayments = [];
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = masterCheckbox.checked;
        if (masterCheckbox.checked) {
            // 取得對應的 orderId
            const row = checkbox.closest('tr');
            const orderIdElement = row.querySelector('td:nth-child(2) div');
            if (orderIdElement) {
                selectedPayments.push(orderIdElement.textContent);
            }
        }
    });
    
    debugLog('全選狀態', { checked: masterCheckbox.checked, selected: selectedPayments });
}

// 批量通過
async function batchApprove() {
    if (selectedPayments.length === 0) {
        alert('請先選擇要審核的繳費記錄');
        return;
    }
    
    const confirmMsg = `確定要批量通過 ${selectedPayments.length} 筆繳費記錄嗎？`;
    if (!confirm(confirmMsg)) return;
    
    try {
        debugLog('批量通過', selectedPayments);
        
        const promises = selectedPayments.map(orderId => 
            callAPI('review-payment', {
                orderId: orderId,
                status: '已確認',
                reviewNote: '批量審核通過',
                reviewedAt: new Date().toISOString(),
                reviewedBy: adminProfile.displayName
            })
        );
        
        const results = await Promise.all(promises);
        const successCount = results.filter(r => r.success).length;
        
        alert(`✅ 批量審核完成！成功處理 ${successCount} 筆記錄`);
        
        selectedPayments = [];
        await Promise.all([
            loadPendingPayments(),
            loadAllPayments(),
            loadDashboard()
        ]);
        
    } catch (error) {
        debugLog('批量審核失敗', error);
        console.error('批量審核失敗:', error);
        alert('批量審核失敗: ' + error.message);
    }
}

// 批量拒絕
async function batchReject() {
    if (selectedPayments.length === 0) {
        alert('請先選擇要審核的繳費記錄');
        return;
    }
    
    const reason = prompt(`即將批量拒絕 ${selectedPayments.length} 筆繳費記錄，請輸入拒絕原因：`);
    if (!reason) return;
    
    try {
        debugLog('批量拒絕', { payments: selectedPayments, reason });
        
        const promises = selectedPayments.map(orderId => 
            callAPI('review-payment', {
                orderId: orderId,
                status: '已拒絕',
                reviewNote: reason,
                reviewedAt: new Date().toISOString(),
                reviewedBy: adminProfile.displayName
            })
        );
        
        const results = await Promise.all(promises);
        const successCount = results.filter(r => r.success).length;
        
        alert(`❌ 批量拒絕完成！成功處理 ${successCount} 筆記錄`);
        
        selectedPayments = [];
        await Promise.all([
            loadPendingPayments(),
            loadAllPayments(),
            loadDashboard()
        ]);
        
    } catch (error) {
        debugLog('批量拒絕失敗', error);
        console.error('批量拒絕失敗:', error);
        alert('批量拒絕失敗: ' + error.message);
    }
}

// 匯出所有資料
async function exportAllData() {
    if (!confirm('確定要匯出所有系統資料嗎？這可能需要一些時間。')) return;
    
    try {
        debugLog('匯出所有資料');
        
        const [paymentsResult, usersResult] = await Promise.all([
            callAPI('get-all-payments', {}),
            callAPI('get-all-users', {})
        ]);
        
        const exportData = {
            exportTime: new Date().toISOString(),
            exportBy: adminProfile.displayName,
            payments: paymentsResult.success ? paymentsResult.payments : [],
            users: usersResult.success ? usersResult.users : [],
            summary: {
                totalUsers: usersResult.success ? usersResult.users.length : 0,
                totalPayments: paymentsResult.success ? paymentsResult.payments.length : 0
            }
        };
        
        // 建立下載連結
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `多福氣BOGO系統資料_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        URL.revokeObjectURL(url);
        
        alert(`📊 資料匯出完成！\n總用戶: ${exportData.summary.totalUsers}\n總繳費記錄: ${exportData.summary.totalPayments}`);
        
    } catch (error) {
        debugLog('匯出資料失敗', error);
        console.error('匯出資料失敗:', error);
        alert('匯出資料失敗: ' + error.message);
    }
}

// 匯出繳費記錄
async function exportPaymentRecords() {
    try {
        debugLog('匯出繳費記錄');
        
        const result = await callAPI('get-all-payments', {});
        
        if (!result.success) {
            throw new Error(result.message || '載入繳費記錄失敗');
        }
        
        // 轉換為 CSV 格式
        const headers = ['訂單編號', '用戶姓名', 'LINE名稱', '繳費金額', '繳費方式', '狀態', '提交時間', '審核時間', '備註'];
        let csvContent = headers.join(',') + '\n';
        
        result.payments.forEach(payment => {
            const row = [
                payment.orderId,
                payment.realName,
                payment.lineName,
                payment.paymentAmount,
                getPaymentMethodText(payment.paymentMethod),
                payment.status,
                new Date(payment.submittedAt).toLocaleString('zh-TW'),
                payment.reviewedAt ? new Date(payment.reviewedAt).toLocaleString('zh-TW') : '',
                (payment.paymentNote || '') + (payment.reviewNote ? ' | ' + payment.reviewNote : '')
            ];
            csvContent += row.map(field => `"${field}"`).join(',') + '\n';
        });
        
        // 建立下載連結
        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `繳費記錄_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        URL.revokeObjectURL(url);
        
        alert(`💰 繳費記錄匯出完成！共 ${result.payments.length} 筆記錄`);
        
    } catch (error) {
        debugLog('匯出繳費記錄失敗', error);
        console.error('匯出繳費記錄失敗:', error);
        alert('匯出繳費記錄失敗: ' + error.message);
    }
}

// 匯出用戶清單
async function exportUserList() {
    try {
        debugLog('匯出用戶清單');
        
        const result = await callAPI('get-all-users', {});
        
        if (!result.success) {
            throw new Error(result.message || '載入用戶資料失敗');
        }
        
        // 轉換為 CSV 格式
        const headers = ['真實姓名', 'LINE名稱', '用戶ID', '註冊時間'];
        let csvContent = headers.join(',') + '\n';
        
        result.users.forEach(user => {
            const row = [
                user.realName,
                user.lineDisplayName,
                user.userId,
                new Date(user.registeredAt).toLocaleString('zh-TW')
            ];
            csvContent += row.map(field => `"${field}"`).join(',') + '\n';
        });
        
        // 建立下載連結
        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `用戶清單_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        URL.revokeObjectURL(url);
        
        alert(`👥 用戶清單匯出完成！共 ${result.users.length} 位用戶`);
        
    } catch (error) {
        debugLog('匯出用戶清單失敗', error);
        console.error('匯出用戶清單失敗:', error);
        alert('匯出用戶清單失敗: ' + error.message);
    }
}

// 清理舊資料
async function cleanupOldData() {
    const days = prompt('請輸入要保留的天數（例如：30 表示刪除30天前的資料）：');
    
    if (!days || isNaN(days) || days < 1) {
        alert('請輸入有效的天數');
        return;
    }
    
    const confirmMsg = `確定要刪除 ${days} 天前的舊資料嗎？此操作無法復原！`;
    if (!confirm(confirmMsg)) return;
    
    try {
        debugLog('清理舊資料', { days });
        
        // 這裡需要後端支援清理功能
        alert('⚠️ 清理舊資料功能需要後端支援，請聯繫系統管理員');
        
    } catch (error) {
        debugLog('清理舊資料失敗', error);
        console.error('清理舊資料失敗:', error);
        alert('清理舊資料失敗: ' + error.message);
    }
}

// 查看繳費詳情
function viewPaymentDetails(orderId) {
    const payment = allPayments.find(p => p.orderId === orderId);
    
    if (!payment) {
        alert('找不到該繳費記錄');
        return;
    }
    
    let detailsHtml = `
        <div style="line-height: 1.8;">
            <h3 style="color: #00B900; margin-bottom: 15px;">💰 繳費詳情</h3>
            <p><strong>訂單編號:</strong> ${payment.orderId}</p>
            <p><strong>用戶姓名:</strong> ${payment.realName}</p>
            <p><strong>LINE名稱:</strong> ${payment.lineName}</p>
            <p><strong>繳費金額:</strong> <span style="color: #00B900; font-weight: bold;">NT$ ${payment.paymentAmount.toLocaleString()}</span></p>
            <p><strong>繳費方式:</strong> ${getPaymentMethodText(payment.paymentMethod)}</p>
            <p><strong>狀態:</strong> <span class="status-badge status-${getStatusClass(payment.status)}">${getStatusText(payment.status)}</span></p>
            <p><strong>提交時間:</strong> ${new Date(payment.submittedAt).toLocaleString('zh-TW')}</p>
            ${payment.reviewedAt ? `<p><strong>審核時間:</strong> ${new Date(payment.reviewedAt).toLocaleString('zh-TW')}</p>` : ''}
            ${payment.paymentNote ? `<p><strong>用戶備註:</strong> ${payment.paymentNote}</p>` : ''}
            ${payment.reviewNote ? `<p><strong>審核備註:</strong> ${payment.reviewNote}</p>` : ''}
        </div>
    `;
    
    document.getElementById('orderModalContent').innerHTML = detailsHtml;
    document.getElementById('orderModal').style.display = 'block';
}

// 工具函數
function getStatusClass(status) {
    switch (status) {
        case '待審核': return 'pending';
        case '已確認': return 'approved';
        case '已拒絕': return 'rejected';
        default: return 'pending';
    }
}

function getStatusText(status) {
    switch (status) {
        case '待審核': return '待審核';
        case '已確認': return '已確認';
        case '已拒絕': return '已拒絕';
        default: return status || '未知';
    }
}

function getPaymentMethodText(method) {
    switch (method) {
        case 'bank_transfer': return '銀行轉帳';
        case 'line_pay': return 'LINE Pay';
        case 'cash': return '現金';
        case 'other': return '其他';
        default: return method || '未指定';
    }
}

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error';
    errorDiv.innerHTML = `
        <h3>❌ 錯誤</h3>
        <p>${message}</p>
    `;
    
    const content = document.querySelector('.content');
    if (content) {
        content.insertBefore(errorDiv, content.firstChild);
        
        // 5秒後自動移除
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
            }
        }, 5000);
    }
}

function showSuccess(message) {
    const successDiv = document.createElement('div');
    successDiv.className = 'success';
    successDiv.innerHTML = `
        <h3>✅ 成功</h3>
        <p>${message}</p>
    `;
    
    const content = document.querySelector('.content');
    if (content) {
        content.insertBefore(successDiv, content.firstChild);
        
        // 3秒後自動移除
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.parentNode.removeChild(successDiv);
            }
        }, 3000);
    }
}

// 開發用測試函數
if (CONFIG.DEBUG_MODE) {
    window.adminDebug = {
        testFunctions: function() {
            console.log('=== 管理者功能測試 ===');
            console.log('管理者ID:', adminUserId);
            console.log('管理者資料:', adminProfile);
            console.log('已選擇繳費記錄:', selectedPayments);
            console.log('待審核記錄:', pendingPayments);
            console.log('所有繳費記錄:', allPayments);
            console.log('所有訂單:', allOrders);
            console.log('所有用戶:', allUsers);
        },
        
        simulatePayment: function() {
            console.log('模擬繳費記錄');
            // 這裡可以加入測試用的模擬資料
        },
        
        clearCache: function() {
            pendingPayments = [];
            allPayments = [];
            selectedPayments = [];
            allOrders = [];
            allUsers = [];
            console.log('已清除所有快取資料');
        }
    };
    
    console.log('管理後台除錯模式已啟用，使用 window.adminDebug 進行測試');
}
</script>
</body>
</html>

